{% extends 'adminSupport/customer_relations_base.html' %}

{% load static %}

{% block title %}Staff Directory{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #2563eb;
        --primary-hover: #1d4ed8;
        --secondary-color: #64748b;
        --success-color: #22c55e;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
        --info-color: #3b82f6;
        --light-bg: #f8fafc;
        --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        --card-shadow-hover: 0 10px 25px rgba(0, 0, 0, 0.1);
        --border-radius: 12px;
        --transition: all 0.3s ease;
    }

    body {
        background-color: var(--light-bg);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        color: #1e293b;
        padding-top: 60px;
    }

    .main-wrapper {
        display: flex;
        min-height: 100vh;
    }

    .content-area {
        flex: 1;
        padding: 2rem;
        margin-left: 280px;
    }

    .page-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
        border-radius: var(--border-radius);
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
    }

    .page-header h1 {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .page-header p {
        margin: 0.5rem 0 0 0;
        opacity: 0.9;
        font-size: 0.95rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
        transition: var(--transition);
        border-left: 4px solid;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--card-shadow-hover);
    }

    .stat-card.primary {
        border-left-color: var(--primary-color);
    }

    .stat-card.success {
        border-left-color: var(--success-color);
    }

    .stat-card.warning {
        border-left-color: var(--warning-color);
    }

    .stat-card.info {
        border-left-color: var(--info-color);
    }

    .stat-card .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }

    .stat-card.primary .stat-icon {
        background: rgba(37, 99, 235, 0.1);
        color: var(--primary-color);
    }

    .stat-card.success .stat-icon {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
    }

    .stat-card.warning .stat-icon {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
    }

    .stat-card.info .stat-icon {
        background: rgba(59, 130, 246, 0.1);
        color: var(--info-color);
    }

    .stat-card h3 {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        color: #1e293b;
    }

    .stat-card p {
        margin: 0.5rem 0 0 0;
        color: var(--secondary-color);
        font-size: 0.875rem;
        font-weight: 500;
    }

    .content-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
    }

    .card-header-custom {
        padding: 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .card-header-custom h2 {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        color: #1e293b;
    }

    .card-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .btn-custom {
        padding: 0.625rem 1.25rem;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.875rem;
        border: none;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary-custom {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary-custom:hover {
        background: var(--primary-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .btn-success-custom {
        background: var(--success-color);
        color: white;
    }

    .btn-success-custom:hover {
        background: #16a34a;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }

    .btn-danger-custom {
        background: var(--danger-color);
        color: white;
    }

    .btn-danger-custom:hover {
        background: #dc2626;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .btn-outline-custom {
        background: white;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
    }

    .btn-outline-custom:hover {
        background: var(--primary-color);
        color: white;
    }

    .btn-custom:hover {
        transform: translateY(-2px);
    }

    .search-filter-bar {
        padding: 1.5rem;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
    }

    .search-box {
        flex: 1;
        min-width: 250px;
        position: relative;
    }

    .search-box input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.875rem;
        transition: var(--transition);
    }

    .search-box input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .search-box i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--secondary-color);
    }

    .filter-select {
        padding: 0.75rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: var(--transition);
        background: white;
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .table-container {
        padding: 1.5rem;
        overflow-x: auto;
    }

    .modern-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 0.5rem;
    }

    .modern-table thead th {
        background: #f8fafc;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border: none;
    }

    .modern-table tbody tr {
        background: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: var(--transition);
    }

    .modern-table tbody tr:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .modern-table tbody td {
        padding: 1rem;
        border: none;
        vertical-align: middle;
    }

    .modern-table tbody tr td:first-child {
        border-top-left-radius: 8px;
        border-bottom-left-radius: 8px;
    }

    .modern-table tbody tr td:last-child {
        border-top-right-radius: 8px;
        border-bottom-right-radius: 8px;
    }

    .staff-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #e2e8f0;
    }

    .staff-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .staff-details h4 {
        margin: 0;
        font-size: 0.9375rem;
        font-weight: 600;
        color: #1e293b;
    }

    .staff-details p {
        margin: 0;
        font-size: 0.8125rem;
        color: var(--secondary-color);
    }

    .badge-custom {
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
    }

    .badge-active {
        background: rgba(34, 197, 94, 0.1);
        color: #16a34a;
    }

    .badge-inactive {
        background: rgba(100, 116, 139, 0.1);
        color: #475569;
    }

    .badge-role {
        background: rgba(37, 99, 235, 0.1);
        color: var(--primary-color);
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .action-btn {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    .action-btn.edit {
        background: rgba(37, 99, 235, 0.1);
        color: var(--primary-color);
    }

    .action-btn.edit:hover {
        background: var(--primary-color);
        color: white;
    }

    .action-btn.delete {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger-color);
    }

    .action-btn.delete:hover {
        background: var(--danger-color);
        color: white;
    }

    .action-btn.message {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
    }

    .action-btn.message:hover {
        background: var(--warning-color);
        color: white;
    }

    .action-btn.reactivate {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
    }

    .action-btn.reactivate:hover {
        background: var(--success-color);
        color: white;
    }

    .pagination-container {
        padding: 1.5rem;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .pagination-info {
        color: var(--secondary-color);
        font-size: 0.875rem;
    }

    .pagination-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .pagination-btn {
        width: 36px;
        height: 36px;
        border-radius: 6px;
        border: 2px solid #e2e8f0;
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        font-weight: 500;
        color: #64748b;
    }

    .pagination-btn:hover:not(:disabled) {
        border-color: var(--primary-color);
        color: var(--primary-color);
        background: rgba(37, 99, 235, 0.05);
    }

    .pagination-btn.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .per-page-select {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--secondary-color);
    }

    .per-page-select select {
        padding: 0.5rem;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        cursor: pointer;
        background: white;
    }

    /* Modal Styles */
    .modal-content {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
        border-bottom: 1px solid #e2e8f0;
        padding: 1.5rem;
        background: #f8fafc;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .modal-title {
        font-weight: 600;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        border-top: 1px solid #e2e8f0;
        padding: 1.5rem;
        background: #f8fafc;
        border-radius: 0 0 var(--border-radius) var(--border-radius);
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #334155;
        font-size: 0.875rem;
    }

    .form-control-custom {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.875rem;
        transition: var(--transition);
    }

    .form-control-custom:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--secondary-color);
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }

    .empty-state h3 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #64748b;
    }

    .empty-state p {
        font-size: 0.875rem;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .alert-custom {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .alert-success {
        background: rgba(34, 197, 94, 0.1);
        color: #16a34a;
        border-left: 4px solid var(--success-color);
    }

    .alert-error {
        background: rgba(239, 68, 68, 0.1);
        color: #dc2626;
        border-left: 4px solid var(--danger-color);
    }

    /* Staff Selection Dropdown Styles */
    .staff-select-item {
        padding: 10px 12px;
        margin-bottom: 6px;
        border-radius: 6px;
        transition: all 0.2s ease;
        cursor: pointer;
        border: 1px solid #e5e7eb;
        background: white;
    }

    .staff-select-item:hover {
        background: #f3f4f6;
        border-color: #3b82f6;
        transform: translateX(2px);
    }

    .staff-select-item input[type="checkbox"] {
        cursor: pointer;
        width: 18px;
        height: 18px;
        margin-right: 10px;
    }

    .staff-select-item label {
        cursor: pointer;
        margin-bottom: 0;
        user-select: none;
        display: flex;
        align-items: center;
        width: 100%;
    }

    .staff-select-item.selected {
        background: #eff6ff;
        border-color: #3b82f6;
    }

    .staff-member-info {
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    .staff-member-name {
        font-weight: 600;
        color: #1f2937;
        font-size: 14px;
    }

    .staff-member-role {
        font-size: 12px;
        color: #6b7280;
        margin-top: 2px;
    }

    #staffSelectionContainer {
        background: #f9fafb;
        border: 2px solid #e5e7eb !important;
    }

    #staffSearchBox {
        border: 2px solid #3b82f6 !important;
        font-size: 14px;
    }

    #staffSearchBox:focus {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        border-color: #2563eb !important;
    }

    .selected-staff-badge {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        margin: 4px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
    }

    .selected-staff-badge .remove-staff {
        margin-left: 8px;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
    }

    .selected-staff-badge .remove-staff:hover {
        opacity: 1;
    }

    .staff-search-hint {
        color: #6b7280;
        font-size: 12px;
        margin-top: 4px;
        font-style: italic;
    }

    @media (max-width: 768px) {
        .content-area {
            margin-left: 0;
            padding: 1rem;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .card-header-custom {
            flex-direction: column;
            align-items: flex-start;
        }

        .pagination-container {
            flex-direction: column;
            align-items: flex-start;
        }

        .table-container {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        <i class="fas fa-users"></i>
        Staff Directory
    </h1>
    <p>Manage and organize your staff members efficiently</p>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card primary">
        <div class="stat-icon">
            <i class="fas fa-users"></i>
        </div>
        <h3 id="totalStaffCount">0</h3>
        <p>Total Staff</p>
    </div>

    <div class="stat-card success">
        <div class="stat-icon">
            <i class="fas fa-user-check"></i>
        </div>
        <h3 id="activeStaffCount">0</h3>
        <p>Active Staff</p>
    </div>

    <div class="stat-card warning">
        <div class="stat-icon">
            <i class="fas fa-user-clock"></i>
        </div>
        <h3 id="formerStaffCount">0</h3>
        <p>Former Staff</p>
    </div>

    <div class="stat-card info">
        <div class="stat-icon">
            <i class="fas fa-building"></i>
        </div>
        <h3 id="departmentsCount">0</h3>
        <p>Departments</p>
    </div>
</div>

<!-- Active Staff Table -->
<div class="content-card">
    <div class="card-header-custom">
        <h2><i class="fas fa-users me-2"></i> Active Staff Members</h2>
        <div class="card-actions">
            <button class="btn-custom btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addStaffModal">
                <i class="fas fa-plus"></i>
                Add Staff
            </button>
            <button class="btn-custom btn-success-custom" data-bs-toggle="modal" data-bs-target="#importStaffModal">
                <i class="fas fa-file-import"></i>
                Import Staff
            </button>
            <button class="btn-custom btn-custom" style="background: var(--warning-color); color: white;"
                data-bs-toggle="modal" data-bs-target="#composeStaffMessageModal">
                <i class="fas fa-envelope"></i>
                Message Staff
            </button>
        </div>
    </div>

    <div class="search-filter-bar">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search staff by name, email, or department...">
        </div>
        <select class="filter-select" id="roleFilter">
            <option value="">All Roles</option>
            <option value="Manager">Manager</option>
            <option value="Agent">Agent</option>
            <option value="Marketer">Marketer</option>
            <option value="Support">Support</option>
            <option value="Admin">Admin</option>
        </select>
        <select class="filter-select" id="departmentFilter">
            <option value="">All Departments</option>
            <option value="Sales">Sales</option>
            <option value="Marketing">Marketing</option>
            <option value="Operations">Operations</option>
            <option value="Finance">Finance</option>
            <option value="HR">HR</option>
        </select>
    </div>

    <div class="table-container">
        <table class="modern-table" id="activeStaffTable">
            <thead>
                <tr>
                    <th>Staff Member</th>
                    <th>Role</th>
                    <th>Department</th>
                    <th>Phone</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="activeStaffTableBody">
                <tr>
                    <td colspan="6">
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <h3>Loading...</h3>
                            <p>Fetching staff data</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="pagination-container">
        <div class="pagination-info">
            Showing <span id="showingFrom">0</span> to <span id="showingTo">0</span> of <span id="totalRecords">0</span>
            entries
        </div>
        <div class="pagination-controls" id="paginationControls">
            <!-- Pagination buttons will be inserted here -->
        </div>
        <div class="per-page-select">
            <label for="perPageSelect">Show:</label>
            <select id="perPageSelect">
                <option value="10">10</option>
                <option value="25" selected>25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
        </div>
    </div>
</div>

<!-- Former Staff Table -->
<div class="content-card">
    <div class="card-header-custom">
        <h2><i class="fas fa-user-clock me-2"></i> Former Staff Members</h2>
    </div>

    <div class="table-container">
        <table class="modern-table" id="formerStaffTable">
            <thead>
                <tr>
                    <th>Staff Member</th>
                    <th>Role</th>
                    <th>Department</th>
                    <th>Removed Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="formerStaffTableBody">
                <tr>
                    <td colspan="5">
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <h3>Loading...</h3>
                            <p>Fetching former staff data</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="pagination-container">
        <div class="pagination-info">
            Showing <span id="formerShowingFrom">0</span> to <span id="formerShowingTo">0</span> of <span
                id="formerTotalRecords">0</span> entries
        </div>
        <div class="pagination-controls" id="formerPaginationControls">
            <!-- Pagination buttons will be inserted here -->
        </div>
        <div class="per-page-select">
            <label for="formerPerPageSelect">Show:</label>
            <select id="formerPerPageSelect">
                <option value="10" selected>10</option>
                <option value="25">25</option>
                <option value="50">50</option>
            </select>
        </div>
    </div>
</div>
</div>
</div>

<!-- Add Staff Modal -->
<div class="modal fade" id="addStaffModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 1rem 1rem 0 0;">
                <h5 class="modal-title d-flex align-items-center">
                    <i id="addStaffModalIcon" class="fas fa-user-plus me-3" style="font-size: 1.5rem;"></i>
                    <span id="addStaffModalTitleText">Add New Staff Member</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="addStaffForm">
                {% csrf_token %}
                <input type="hidden" name="staff_id" id="staffIdField">
                <div class="modal-body p-4">
                    <div id="addStaffAlert"></div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Full Name *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                                    <input type="text" class="form-control" id="staffName" name="full_name" required
                                        placeholder="Enter full name">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Role/Position *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
                                    <select class="form-select" id="staffRole" name="role" required>
                                        <option value="">Select Role/Position</option>
                                        <optgroup label="Executive & Management">
                                            <option>Managing Director (MD)</option>
                                            <option>Chief Executive Officer (CEO)</option>
                                            <option>General Manager</option>
                                            <option>Head of Operations</option>
                                            <option>Head of Sales</option>
                                            <option>Head of Marketing</option>
                                            <option>Head of Legal</option>
                                            <option>HR Manager</option>
                                            <option>Finance Manager</option>
                                            <option>Branch Manager</option>
                                        </optgroup>
                                        <optgroup label="Sales & Agency">
                                            <option>Senior Real Estate Agent</option>
                                            <option>Real Estate Agent</option>
                                            <option>Sales Executive</option>
                                            <option>Business Development Executive</option>
                                            <option>Leasing Officer</option>
                                            <option>Client Relationship Officer</option>
                                        </optgroup>
                                        <optgroup label="Marketing & Communications">
                                            <option>Marketing Executive</option>
                                            <option>Digital Marketing Specialist</option>
                                            <option>Content Creator</option>
                                            <option>Brand/PR Officer</option>
                                        </optgroup>
                                        <optgroup label="Operations & Admin">
                                            <option>Operations Officer</option>
                                            <option>Administrative Officer</option>
                                            <option>Front Desk/Receptionist</option>
                                            <option>Customer Support Officer</option>
                                        </optgroup>
                                        <optgroup label="Legal & Compliance">
                                            <option>Legal Officer</option>
                                            <option>Compliance Officer</option>
                                            <option>Documentation Officer</option>
                                        </optgroup>
                                        <optgroup label="Finance & Accounts">
                                            <option>Accountant</option>
                                            <option>Finance Officer</option>
                                            <option>Cashier</option>
                                        </optgroup>
                                        <optgroup label="Technical & Site">
                                            <option>Estate Surveyor/Valuer</option>
                                            <option>Site Supervisor</option>
                                            <option>Facility Manager</option>
                                            <option>Project Coordinator</option>
                                            <option>Architect</option>
                                            <option>Engineer</option>
                                        </optgroup>
                                        <optgroup label="IT & Support">
                                            <option>IT Support</option>
                                            <option>System Administrator</option>
                                        </optgroup>
                                        <optgroup label="Security & Field">
                                            <option>Security</option>
                                            <option>Field Officer</option>
                                            <option>Driver</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Employment Date *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                    <input type="date" class="form-control" name="employment_date" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Address *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                    <textarea class="form-control" name="address" rows="3"
                                        placeholder="Enter full address" required></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Phone Number *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                    <input type="tel" class="form-control" id="staffPhone" name="phone_number"
                                        placeholder="+234-XXX-XXX-XXXX" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Email Address *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                    <input type="email" class="form-control" id="staffEmail" name="email"
                                        placeholder="staff@company.com" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">WhatsApp Number</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fab fa-whatsapp"></i></span>
                                    <input type="tel" class="form-control" name="whatsapp"
                                        placeholder="+234-XXX-XXX-XXXX">
                                </div>
                                <div class="form-text">Optional - Leave blank if same as phone number</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Date of Birth *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-birthday-cake"></i></span>
                                    <input type="date" class="form-control" name="date_of_birth" required>
                                </div>
                                <div class="form-text">Used for birthday reminders and staff analytics</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" id="submitAddStaff">
                        <i class="fas fa-user-plus me-2"></i>Add Staff Member
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import Staff Modal -->
<div class="modal fade" id="importStaffModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-import"></i>
                    Import Staff from CSV
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="importStaffAlert"></div>
                <form id="importStaffForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label class="form-label">Upload CSV File *</label>
                        <input type="file" class="form-control-custom" id="staffFile" name="file" accept=".csv"
                            required>
                        <small class="text-muted">File should include: Name, Email, Phone, Role, Department</small>
                    </div>
                    <div class="alert-custom alert-success">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>CSV Format:</strong> Ensure your CSV has columns: name, email, phone, role,
                            department
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-custom btn-outline-custom" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-custom btn-success-custom" id="submitImportStaff">
                    <i class="fas fa-upload"></i>
                    Import
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Remove Staff Modal -->
<div class="modal fade" id="removeStaffModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-times"></i>
                    Remove Staff Member
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="removeStaffAlert"></div>
                <p>Are you sure you want to remove <strong id="removeStaffName"></strong> from the active staff list?
                </p>
                <p class="text-muted small">This action can be reversed by reactivating the staff member.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-custom btn-outline-custom" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-custom btn-danger-custom" id="confirmRemoveStaff">
                    <i class="fas fa-trash"></i>
                    Remove
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Staff Modal -->
<div class="modal fade" id="editStaffModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-edit"></i>
                    Edit Staff Member
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="editStaffAlert"></div>
                <form id="editStaffForm">
                    {% csrf_token %}
                    <input type="hidden" id="editStaffId">
                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <input type="text" class="form-control-custom" id="editStaffName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Address *</label>
                        <input type="email" class="form-control-custom" id="editStaffEmail" name="email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-control-custom" id="editStaffPhone" name="phone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role *</label>
                        <select class="form-control-custom" id="editStaffRole" name="role" required>
                            <option value="Manager">Manager</option>
                            <option value="Agent">Agent</option>
                            <option value="Marketer">Marketer</option>
                            <option value="Support">Support</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department *</label>
                        <select class="form-control-custom" id="editStaffDepartment" name="department" required>
                            <option value="Sales">Sales</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Operations">Operations</option>
                            <option value="Finance">Finance</option>
                            <option value="HR">HR</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-custom btn-outline-custom" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-custom btn-primary-custom" id="submitEditStaff">
                    <i class="fas fa-save"></i>
                    Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Message Individual Staff Modal -->
<div class="modal fade" id="messageStaffModal">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-envelope"></i>
                    Send Message to Staff Member
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="messageStaffAlert"></div>
                <div class="alert-custom alert-success mb-3">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Recipient:</strong> <span id="messageRecipientName"></span> (<span
                            id="messageRecipientEmail"></span>)
                    </div>
                </div>
                <form id="messageStaffForm">
                    {% csrf_token %}
                    <input type="hidden" id="messageStaffId">
                    <div class="form-group">
                        <label class="form-label">Subject *</label>
                        <input type="text" class="form-control-custom" id="messageSubject" name="subject"
                            placeholder="Enter message subject" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Message *</label>
                        <textarea class="form-control-custom" id="messageContent" name="message" rows="6"
                            placeholder="Type your message here..." required style="resize: vertical;"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-control-custom" id="messagePriority" name="priority">
                            <option value="normal">Normal</option>
                            <option value="high">High Priority</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-custom btn-outline-custom" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-custom btn-primary-custom" id="submitMessageStaff">
                    <i class="fas fa-paper-plane"></i>
                    Send Message
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Auto Message Template Modal -->
<!-- <div class="modal fade" id="messageBulkStaffModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
                <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; border-radius: 1rem 1rem 0 0;">
                    <h5 class="modal-title d-flex align-items-center">
                        <i class="fas fa-envelope me-3" style="font-size: 1.5rem;"></i>
                        Create Auto Message Template
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="messageBulkStaffAlert"></div>
                    <form id="messageBulkStaffForm">
                        {% csrf_token %}
                        <div class="form-group">
                            <label class="form-label">Recipients *</label>
                            <select class="form-control-custom" id="bulkRecipients" name="recipients" multiple size="5" required>
                                <option value="all">All Active Staff</option>
                                <option value="managers">All Managers</option>
                                <option value="agents">All Agents</option>
                                <option value="marketers">All Marketers</option>
                                <option value="support">All Support Staff</option>
                            </select>
                            <small class="text-muted">Hold Ctrl (Cmd on Mac) to select multiple groups</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subject *</label>
                            <input type="text" class="form-control-custom" id="bulkMessageSubject" name="subject" placeholder="Enter message subject" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Message *</label>
                            <textarea class="form-control-custom" id="bulkMessageContent" name="message" rows="6" placeholder="Type your message here..." required style="resize: vertical;"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Priority</label>
                            <select class="form-control-custom" id="bulkMessagePriority" name="priority">
                                <option value="normal">Normal</option>
                                <option value="high">High Priority</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-custom btn-outline-custom" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn-custom btn-primary-custom" id="submitBulkMessageStaff">
                        <i class="fas fa-paper-plane"></i>
                        Send to All Selected
                    </button>
                </div>
            </div>
        </div>
    </div> -->

<!-- Auto Message Template Modal -->
<div class="modal fade" id="composeStaffMessageModal">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; border-radius: 1rem 1rem 0 0;">
                <h5 class="modal-title d-flex align-items-center">
                    <i class="fas fa-envelope me-3" style="font-size: 1.5rem;"></i>
                    Create Auto Message Template
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="composeStaffMessageForm">
                <div class="modal-body p-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Template Name *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-tag"></i></span>
                                    <input type="text" class="form-control" name="templateName"
                                        placeholder="e.g., Monthly Update" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Audience Selection *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-users"></i></span>
                                    <select class="form-select" name="audienceType" id="audienceType" required>
                                        <option value="">Select Audience</option>
                                        <option value="all_staff">All Staff</option>
                                        <option value="individuals">Specific Individuals</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3" id="individualStaffSelection" style="display: none;">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-user-check me-2"></i>Search & Select Individual Staff
                                </label>
                                <div class="input-group mb-2">
                                    <span class="input-group-text bg-primary text-white"><i
                                            class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="staffSearchBox"
                                        placeholder="Type to search by name, role, or department..." autocomplete="off">
                                </div>
                                <div class="alert alert-info py-2 px-3 mb-2" style="font-size: 13px;">
                                    <i class="fas fa-lightbulb me-2"></i><strong>Tip:</strong> Start typing to search,
                                    then click on staff members to select them for this message
                                </div>
                                <div class="border rounded p-3 mt-2"
                                    style="max-height: 250px; overflow-y: auto; overflow-x: hidden;"
                                    id="staffSelectionContainer">
                                    <div class="text-muted text-center py-3">
                                        <i class="fas fa-users fa-2x mb-2" style="opacity: 0.3;"></i>
                                        <p class="mb-0">Start typing to search for staff members</p>
                                        <small>Staff members will appear here as you type</small>
                                    </div>
                                </div>
                                <div class="mt-3 p-3 bg-light rounded">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <small class="text-muted fw-semibold">
                                            <i class="fas fa-check-circle me-1 text-success"></i>Selected Staff: <span
                                                id="selectedStaffCount" class="badge bg-success">0</span>
                                        </small>
                                        <button type="button" class="btn btn-sm btn-outline-danger" id="clearAllStaff"
                                            style="display: none;">
                                            <i class="fas fa-times me-1"></i>Clear All
                                        </button>
                                    </div>
                                    <div id="selectedStaffList" class="mt-2"></div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Target Channels *</label>
                                <div class="row">
                                    <div class="col-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="channels"
                                                value="email" id="channelEmail">
                                            <label class="form-check-label" for="channelEmail">
                                                <i class="fas fa-envelope me-1 text-primary"></i>Email
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="channels" value="sms"
                                                id="channelSMS">
                                            <label class="form-check-label" for="channelSMS">
                                                <i class="fas fa-sms me-1 text-success"></i>SMS
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="channels"
                                                value="whatsapp" id="channelWhatsApp">
                                            <label class="form-check-label" for="channelWhatsApp">
                                                <i class="fab fa-whatsapp me-1 text-success"></i>WhatsApp
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-check form-switch mb-3" id="immediateSendToggleWrapper">
                                <input class="form-check-input" type="checkbox" role="switch"
                                    id="sendImmediatelyToggle">
                                <label class="form-check-label fw-semibold" for="sendImmediatelyToggle">
                                    Send Immediately (hide schedule fields)
                                </label>
                                <div class="form-text">
                                    Turn off to configure a trigger date, time, and repeat schedule.
                                </div>
                            </div>

                            <div class="mb-3" id="staffTriggerSchedule">
                                <label class="form-label fw-semibold">Trigger Schedule *</label>
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label small">Date</label>
                                        <input type="date" class="form-control" name="triggerDate">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Time</label>
                                        <input type="time" class="form-control" name="triggerTime">
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3" id="staffRepeatSchedule">
                                <label class="form-label">Repeat Schedule</label>
                                <select class="form-select" name="repeatSchedule">
                                    <option value="">Do not repeat</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Message Subject</label>
                                <input type="text" class="form-control" name="messageSubject"
                                    placeholder="Message subject line">
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Message Content *</label>
                                <textarea class="form-control" name="messageContent" rows="8" required placeholder="Your message content here...

    Available variables:
    {name} - Staff member's name
    {role} - Staff member's role
    {email} - Staff member's email
    {phone} - Staff member's phone"></textarea>
                                <div class="form-text">
                                    Use variables like {name}, {role} for personalization
                                </div>
                            </div>

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" name="saveAsTemplate"
                                    id="saveAsTemplate" checked>
                                <label class="form-check-label" for="saveAsTemplate">
                                    Save as reusable template
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="border rounded p-3 bg-light">
                                <h6><i class="fas fa-eye me-2"></i>Message Preview</h6>
                                <div id="staffMessagePreview" class="bg-white p-3 border rounded"
                                    style="min-height: 100px;">
                                    <p class="text-muted">Message preview will appear here...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-primary" onclick="previewStaffMessage()">
                        <i class="fas fa-eye me-2"></i>Preview
                    </button>
                    <button type="button" class="btn btn-success" onclick="sendImmediateStaffMessage()">
                        <i class="fas fa-paper-plane me-2"></i>Send Now
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-clock me-2"></i>Schedule Message
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Global variables
    let currentPage = 1;
    let perPage = 25;
    let totalPages = 1;
    let allStaff = [];
    let filteredStaff = [];
    let staffToRemove = null;

    let formerCurrentPage = 1;
    let formerPerPage = 10;
    let formerTotalPages = 1;
    let allFormerStaff = [];

    // Initialize on page load
    $(document).ready(function () {
        loadStaffStats();
        loadStaffDirectory();
        loadFormerStaff();
        setupEventListeners();
    });

    // Load staff statistics
    function loadStaffStats() {
        $.ajax({
            url: '{% url "adminSupport:api_staff_stats" %}',
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    $('#totalStaffCount').text(response.data.total || 0);
                    $('#activeStaffCount').text(response.data.active || 0);
                    $('#formerStaffCount').text(response.data.former || 0);
                    $('#departmentsCount').text(response.data.departments || 0);
                }
            },
            error: function () {
                console.error('Failed to load staff statistics');
            }
        });
    }

    // Load staff directory
    function loadStaffDirectory() {
        $.ajax({
            url: '{% url "adminSupport:api_staff_list" %}',
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    allStaff = response.data || [];
                    filteredStaff = [...allStaff];
                    renderStaffTable();
                } else {
                    showEmptyState('activeStaffTableBody', 'No staff members found');
                }
            },
            error: function () {
                showEmptyState('activeStaffTableBody', 'Failed to load staff data');
            }
        });
    }

    // Load former staff
    function loadFormerStaff() {
        $.ajax({
            url: '{% url "adminSupport:api_staff_former" %}',
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    allFormerStaff = response.data || [];
                    renderFormerStaffTable();
                } else {
                    showEmptyState('formerStaffTableBody', 'No former staff members');
                }
            },
            error: function () {
                showEmptyState('formerStaffTableBody', 'Failed to load former staff data');
            }
        });
    }

    // Render staff table
    function renderStaffTable() {
        const tbody = $('#activeStaffTableBody');

        if (filteredStaff.length === 0) {
            showEmptyState('activeStaffTableBody', 'No staff members match your search');
            return;
        }

        const start = (currentPage - 1) * perPage;
        const end = Math.min(start + perPage, filteredStaff.length);
        const pageData = filteredStaff.slice(start, end);

        let html = '';
        pageData.forEach(staff => {
            const avatar = staff.avatar || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(staff.name || 'User') + '&background=2563eb&color=fff';
            html += `
                    <tr>
                        <td>
                            <div class="staff-info">
                                <img src="${avatar}" alt="${staff.name}" class="staff-avatar">
                                <div class="staff-details">
                                    <h4>${staff.name || 'N/A'}</h4>
                                    <p>${staff.email || 'N/A'}</p>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge-custom badge-role">${staff.role || 'N/A'}</span>
                        </td>
                        <td>${staff.department || 'N/A'}</td>
                        <td>${staff.phone || 'N/A'}</td>
                        <td>
                            <span class="badge-custom badge-active">
                                <i class="fas fa-circle"></i> Active
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn edit" onclick="editStaff(${staff.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn message" onclick="messageStaff(${staff.id}, '${staff.name}', '${staff.email}')" title="Send Message">
                                    <i class="fas fa-envelope"></i>
                                </button>
                                <button class="action-btn delete" onclick="removeStaff(${staff.id}, '${staff.name}')" title="Remove">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
        });

        tbody.html(html);
        updatePaginationInfo(start + 1, end, filteredStaff.length);
        renderPagination();
    }

    // Render former staff table
    function renderFormerStaffTable() {
        const tbody = $('#formerStaffTableBody');

        if (allFormerStaff.length === 0) {
            showEmptyState('formerStaffTableBody', 'No former staff members');
            return;
        }

        const start = (formerCurrentPage - 1) * formerPerPage;
        const end = Math.min(start + formerPerPage, allFormerStaff.length);
        const pageData = allFormerStaff.slice(start, end);

        let html = '';
        pageData.forEach(staff => {
            const avatar = staff.avatar || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(staff.name || 'User') + '&background=64748b&color=fff';
            html += `
                    <tr>
                        <td>
                            <div class="staff-info">
                                <img src="${avatar}" alt="${staff.name}" class="staff-avatar">
                                <div class="staff-details">
                                    <h4>${staff.name || 'N/A'}</h4>
                                    <p>${staff.email || 'N/A'}</p>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge-custom badge-role">${staff.role || 'N/A'}</span>
                        </td>
                        <td>${staff.department || 'N/A'}</td>
                        <td>${staff.removed_date || 'N/A'}</td>
                        <td>
                            <button class="action-btn reactivate" onclick="reactivateStaff(${staff.id})" title="Reactivate">
                                <i class="fas fa-undo"></i>
                            </button>
                        </td>
                    </tr>
                `;
        });

        tbody.html(html);
        updateFormerPaginationInfo(start + 1, end, allFormerStaff.length);
        renderFormerPagination();
    }

    // Render pagination controls
    function renderPagination() {
        totalPages = Math.ceil(filteredStaff.length / perPage);
        const controls = $('#paginationControls');
        let html = '';

        // Previous button
        html += `<button class="pagination-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-left"></i>
            </button>`;

        // Page numbers
        const maxButtons = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);

        if (endPage - startPage < maxButtons - 1) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
        }

        // Next button
        html += `<button class="pagination-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                <i class="fas fa-chevron-right"></i>
            </button>`;

        controls.html(html);
    }

    // Render former staff pagination
    function renderFormerPagination() {
        formerTotalPages = Math.ceil(allFormerStaff.length / formerPerPage);
        const controls = $('#formerPaginationControls');
        let html = '';

        html += `<button class="pagination-btn" onclick="changeFormerPage(${formerCurrentPage - 1})" ${formerCurrentPage === 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-left"></i>
            </button>`;

        const maxButtons = 5;
        let startPage = Math.max(1, formerCurrentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(formerTotalPages, startPage + maxButtons - 1);

        if (endPage - startPage < maxButtons - 1) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            html += `<button class="pagination-btn ${i === formerCurrentPage ? 'active' : ''}" onclick="changeFormerPage(${i})">${i}</button>`;
        }

        html += `<button class="pagination-btn" onclick="changeFormerPage(${formerCurrentPage + 1})" ${formerCurrentPage === formerTotalPages ? 'disabled' : ''}>
                <i class="fas fa-chevron-right"></i>
            </button>`;

        controls.html(html);
    }

    // Change page
    function changePage(page) {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        renderStaffTable();
    }

    // Change former staff page
    function changeFormerPage(page) {
        if (page < 1 || page > formerTotalPages) return;
        formerCurrentPage = page;
        renderFormerStaffTable();
    }

    // Update pagination info
    function updatePaginationInfo(from, to, total) {
        $('#showingFrom').text(from);
        $('#showingTo').text(to);
        $('#totalRecords').text(total);
    }

    // Update former pagination info
    function updateFormerPaginationInfo(from, to, total) {
        $('#formerShowingFrom').text(from);
        $('#formerShowingTo').text(to);
        $('#formerTotalRecords').text(total);
    }

    // Show empty state
    function showEmptyState(tbodyId, message) {
        const tbody = $('#' + tbodyId);
        tbody.html(`
                <tr>
                    <td colspan="6">
                        <div class="empty-state">

            // Message staff form submission
            $('#submitMessageStaff').on('click', function() {
                handleMessageStaff();
            });
                            <i class="fas fa-users"></i>
                            <h3>${message}</h3>
                            <p>No records to display</p>
                        </div>
                    </td>
                </tr>
            `);
    }

    // Setup event listeners
    function setupEventListeners() {
        // Search functionality
        $('#searchInput').on('input', function () {
            applyFilters();
        });

        // Role filter
        $('#roleFilter').on('change', function () {
            applyFilters();
        });

        // Department filter
        $('#departmentFilter').on('change', function () {
            applyFilters();
        });

        // Per page change
        $('#perPageSelect').on('change', function () {
            perPage = parseInt($(this).val());
            currentPage = 1;
            renderStaffTable();
        });

        // Former staff per page change
        $('#formerPerPageSelect').on('change', function () {
            formerPerPage = parseInt($(this).val());
            formerCurrentPage = 1;
            renderFormerStaffTable();
        });

        // Add staff form submission
        $('#submitAddStaff').on('click', function () {
            handleAddStaff();
        });

        // Import staff form submission
        $('#submitImportStaff').on('click', function () {
            handleImportStaff();
        });

        // Confirm remove staff
        $('#confirmRemoveStaff').on('click', function () {
            if (staffToRemove) {
                confirmRemoveStaff(staffToRemove);
            }
        });

        // Edit staff form submission
        $('#submitEditStaff').on('click', function () {
            handleEditStaff();
        });

        // Message staff form submission
        $('#submitMessageStaff').on('click', function () {
            handleMessageStaff();
        });

        // Bulk message staff form submission
        $('#submitBulkMessageStaff').on('click', function () {
            handleBulkMessageStaff();
        });
    }

    // Apply filters
    function applyFilters() {
        const searchTerm = $('#searchInput').val().toLowerCase();
        const roleFilter = $('#roleFilter').val();
        const departmentFilter = $('#departmentFilter').val();

        filteredStaff = allStaff.filter(staff => {
            const matchesSearch = !searchTerm ||
                (staff.name && staff.name.toLowerCase().includes(searchTerm)) ||
                (staff.email && staff.email.toLowerCase().includes(searchTerm)) ||
                (staff.department && staff.department.toLowerCase().includes(searchTerm));

            const matchesRole = !roleFilter || staff.role === roleFilter;
            const matchesDepartment = !departmentFilter || staff.department === departmentFilter;

            return matchesSearch && matchesRole && matchesDepartment;
        });

        currentPage = 1;
        renderStaffTable();
    }

    // Handle add staff
    function handleAddStaff() {
        const formData = {
            name: $('#staffName').val(),
            email: $('#staffEmail').val(),
            phone: $('#staffPhone').val(),
            role: $('#staffRole').val(),
            department: $('#staffDepartment').val()
        };

        if (!formData.name || !formData.email || !formData.role || !formData.department) {
            showAlert('addStaffAlert', 'error', 'Please fill in all required fields');
            return;
        }

        const btn = $('#submitAddStaff');
        btn.html('<span class="loading-spinner"></span> Adding...').prop('disabled', true);

        $.ajax({
            url: '{% url "adminSupport:api_staff_create" %}',
            method: 'POST',
            data: formData,
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function (response) {
                if (response.success) {
                    showAlert('addStaffAlert', 'success', 'Staff member added successfully!');
                    $('#addStaffForm')[0].reset();
                    setTimeout(() => {
                        $('#addStaffModal').modal('hide');
                        loadStaffStats();
                        loadStaffDirectory();
                    }, 1500);
                } else {
                    showAlert('addStaffAlert', 'error', response.message || 'Failed to add staff member');
                }
            },
            error: function () {
                showAlert('addStaffAlert', 'error', 'An error occurred. Please try again.');
            },
            complete: function () {
                btn.html('<i class="fas fa-check"></i> Add Staff').prop('disabled', false);
            }
        });
    }

    // Handle import staff
    function handleImportStaff() {
        const fileInput = $('#staffFile')[0];
        if (!fileInput.files.length) {
            showAlert('importStaffAlert', 'error', 'Please select a CSV file');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        const btn = $('#submitImportStaff');
        btn.html('<span class="loading-spinner"></span> Importing...').prop('disabled', true);

        $.ajax({
            url: '{% url "adminSupport:api_staff_import" %}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function (response) {
                if (response.success) {
                    showAlert('importStaffAlert', 'success', `Successfully imported ${response.imported || 0} staff members!`);
                    $('#importStaffForm')[0].reset();
                    setTimeout(() => {
                        $('#importStaffModal').modal('hide');
                        loadStaffStats();
                        loadStaffDirectory();
                    }, 2000);
                } else {
                    showAlert('importStaffAlert', 'error', response.message || 'Failed to import staff');
                }
            },
            error: function () {
                showAlert('importStaffAlert', 'error', 'An error occurred during import');
            },
            complete: function () {
                btn.html('<i class="fas fa-upload"></i> Import').prop('disabled', false);
            }
        });
    }

    // Edit staff
    function editStaff(staffId) {
        const staff = allStaff.find(s => s.id === staffId);
        if (!staff) return;

        $('#editStaffId').val(staff.id);
        $('#editStaffName').val(staff.name);
        $('#editStaffEmail').val(staff.email);
        $('#editStaffPhone').val(staff.phone);
        $('#editStaffRole').val(staff.role);
        $('#editStaffDepartment').val(staff.department);

        $('#editStaffModal').modal('show');
    }

    // Handle edit staff
    function handleEditStaff() {
        const staffId = $('#editStaffId').val();
        const formData = {
            name: $('#editStaffName').val(),
            email: $('#editStaffEmail').val(),
            phone: $('#editStaffPhone').val(),
            role: $('#editStaffRole').val(),
            department: $('#editStaffDepartment').val()
        };

        const btn = $('#submitEditStaff');
        btn.html('<span class="loading-spinner"></span> Saving...').prop('disabled', true);

        $.ajax({
            url: `/api/staff/${staffId}/update/`,
            method: 'POST',
            data: formData,
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function (response) {
                if (response.success) {
                    showAlert('editStaffAlert', 'success', 'Staff member updated successfully!');
                    setTimeout(() => {
                        $('#editStaffModal').modal('hide');
                        loadStaffDirectory();
                    }, 1500);
                } else {
                    showAlert('editStaffAlert', 'error', response.message || 'Failed to update staff member');
                }
            },
            error: function () {
                showAlert('editStaffAlert', 'error', 'An error occurred. Please try again.');
            },
            complete: function () {
                btn.html('<i class="fas fa-save"></i> Save Changes').prop('disabled', false);
            }


        // Message staff
        function messageStaff(staffId, staffName, staffEmail) {
            $('#messageStaffId').val(staffId);
            $('#messageRecipientName').text(staffName);
            $('#messageRecipientEmail').text(staffEmail);
            $('#messageStaffForm')[0].reset();
            $('#messageStaffAlert').html('');
            $('#messageStaffModal').modal('show');
        }

        // Handle message staff
        function handleMessageStaff() {
                const staffId = $('#messageStaffId').val();
                const formData = {
                    staff_id: staffId,
                    subject: $('#messageSubject').val(),
                    message: $('#messageContent').val(),
                    priority: $('#messagePriority').val()
                };

                if (!formData.subject || !formData.message) {
                    showAlert('messageStaffAlert', 'error', 'Please fill in all required fields');
                    return;
                }

                const btn = $('#submitMessageStaff');
                btn.html('<span class="loading-spinner"></span> Sending...').prop('disabled', true);

                $.ajax({
                    url: '{% url "adminSupport:api_messages_save" %}',
                    method: 'POST',
                    data: {
                        recipient_type: 'staff',
                        recipient_id: formData.staff_id,
                        subject: formData.subject,
                        message: formData.message,
                        priority: formData.priority,
                        status: 'sent'
                    },
                    headers: {
                        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                    },
                    success: function (response) {
                        if (response.success) {
                            showAlert('messageStaffAlert', 'success', 'Message sent successfully!');
                            $('#messageStaffForm')[0].reset();
                            setTimeout(() => {
                                $('#messageStaffModal').modal('hide');
                            }, 1500);
                        } else {
                            showAlert('messageStaffAlert', 'error', response.message || 'Failed to send message');
                        }
                    },
                    error: function () {
                        showAlert('messageStaffAlert', 'error', 'An error occurred. Please try again.');
                    },
                    complete: function () {
                        btn.html('<i class="fas fa-paper-plane"></i> Send Message').prop('disabled', false);
                    }
                });
            }

        // Handle bulk message staff (Auto Message Template)
        let selectedStaffMembers = [];
        let staffListLoaded = false;

        // Setup compose staff message modal functionality
        function setupComposeStaffMessageModal() {
            // Remove any existing handlers to prevent duplicates
            $('#composeStaffMessageModal').off('shown.bs.modal');
            $('#audienceType').off('change');
            $('#sendImmediatelyToggle').off('change');
            $('#staffSearchBox').off('input');
            $('#clearAllStaff').off('click');
            $('#composeStaffMessageForm').off('submit');

            // Reset modal when opened
            $('#composeStaffMessageModal').on('shown.bs.modal', function () {
                // Reset form and selections
                $('#composeStaffMessageForm')[0].reset();
                selectedStaffMembers = [];
                staffListLoaded = false;
                updateSelectedStaffDisplay();
                $('#individualStaffSelection').hide();
                $('#staffSelectionContainer').html(`
                    <div class="text-muted text-center py-3">
                        <i class="fas fa-users fa-2x mb-2" style="opacity: 0.3;"></i>
                        <p class="mb-0">Start typing to search for staff members</p>
                        <small>Staff members will appear here as you type</small>
                    </div>
                `);
            });

            // Audience type selection toggle
            $('#audienceType').on('change', function () {
                const audienceType = $(this).val();
                if (audienceType === 'individuals') {
                    $('#individualStaffSelection').slideDown(300);
                    // Auto-focus on search box after animation
                    setTimeout(() => {
                        $('#staffSearchBox').focus();
                    }, 350);
                } else {
                    $('#individualStaffSelection').slideUp(300);
                    selectedStaffMembers = [];
                    staffListLoaded = false;
                    updateSelectedStaffDisplay();
                }
            });

            // Send immediately toggle
            $('#sendImmediatelyToggle').on('change', function () {
                if ($(this).is(':checked')) {
                    $('#staffTriggerSchedule').slideUp();
                    $('#staffRepeatSchedule').slideUp();
                } else {
                    $('#staffTriggerSchedule').slideDown();
                    $('#staffRepeatSchedule').slideDown();
                }
            });

            // Staff search functionality with real-time filtering
            $('#staffSearchBox').on('input', function () {
                const searchTerm = $(this).val().toLowerCase().trim();

                // Load staff list on first keystroke
                if (!staffListLoaded && searchTerm.length > 0) {
                    loadStaffForSelection();
                    staffListLoaded = true;
                }

                // Filter based on search term
                if (staffListLoaded) {
                    if (searchTerm.length > 0) {
                        filterStaffForSelection(searchTerm);
                    } else {
                        // Show all staff when search is cleared
                        $('.staff-select-item').show();
                        $('.no-results-msg').remove();
                    }
                }
            });

            // Clear all selected staff
            $('#clearAllStaff').on('click', function (e) {
                e.preventDefault();
                if (confirm('Clear all selected staff members?')) {
                    selectedStaffMembers = [];
                    updateSelectedStaffDisplay();
                    // Uncheck all checkboxes and remove selected class
                    $('#staffSelectionContainer input[type="checkbox"]').prop('checked', false);
                    $('.staff-select-item').removeClass('selected');
                }
            });

            // Form submission
            $('#composeStaffMessageForm').on('submit', function (e) {
                e.preventDefault();
                scheduleStaffMessage();
            });
        }

        // Load staff for selection
        function loadStaffForSelection() {
            const container = $('#staffSelectionContainer');

            if (allStaff.length === 0) {
                container.html('<div class="text-muted text-center py-3"><i class="fas fa-exclamation-triangle me-2 text-warning"></i><p class="mb-0">No staff members available</p><small>Please add staff members first</small></div>');
                return;
            }

            let html = '';
            allStaff.forEach(staff => {
                const isSelected = selectedStaffMembers.includes(staff.id);
                const escapedName = (staff.name || '').replace(/'/g, "\\'");
                const selectedClass = isSelected ? 'selected' : '';
                html += `
                    <div class="form-check staff-select-item ${selectedClass}" data-staff-id="${staff.id}" data-staff-name="${staff.name || ''}" data-staff-role="${staff.role || ''}" data-staff-dept="${staff.department || ''}">
                        <input class="form-check-input" type="checkbox" value="${staff.id}" id="staffCheck${staff.id}" ${isSelected ? 'checked' : ''} onchange="toggleStaffSelection(${staff.id}, '${escapedName}')">
                        <label class="form-check-label" for="staffCheck${staff.id}">
                            <div class="staff-member-info">
                                <span class="staff-member-name">${staff.name || 'N/A'}</span>
                                <span class="staff-member-role">${staff.role || 'N/A'}  ${staff.department || 'N/A'}</span>
                            </div>
                        </label>
                    </div>
                `;
            });
            container.html(html);

            // Use event delegation for dynamically created elements
            container.off('click', '.staff-select-item').on('click', '.staff-select-item', function (e) {
                if (e.target.type !== 'checkbox' && !$(e.target).is('input')) {
                    const checkbox = $(this).find('input[type="checkbox"]');
                    checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
                }
            });
        }

        // Filter staff for selection
        function filterStaffForSelection(searchTerm) {
            let visibleCount = 0;
            $('.staff-select-item').each(function () {
                const staffName = ($(this).data('staff-name') || '').toLowerCase();
                const staffRole = ($(this).data('staff-role') || '').toLowerCase();
                const staffDept = ($(this).data('staff-dept') || '').toLowerCase();

                if (staffName.includes(searchTerm) || staffRole.includes(searchTerm) || staffDept.includes(searchTerm)) {
                    $(this).show();
                    visibleCount++;
                } else {
                    $(this).hide();
                }
            });

            // Show "no results" message if no matches
            if (visibleCount === 0) {
                $('#staffSelectionContainer').append(`
                    <div class="text-center py-3 text-muted no-results-msg">
                        <i class="fas fa-search fa-2x mb-2" style="opacity: 0.3;"></i>
                        <p class="mb-0">No staff members found</p>
                        <small>Try a different search term</small>
                    </div>
                `);
            } else {
                $('.no-results-msg').remove();
            }
        }

        // Toggle staff selection
        function toggleStaffSelection(staffId, staffName) {
            const index = selectedStaffMembers.indexOf(staffId);
            const staffItem = $(`.staff-select-item[data-staff-id="${staffId}"]`);

            if (index > -1) {
                selectedStaffMembers.splice(index, 1);
                staffItem.removeClass('selected');
                $(`#staffCheck${staffId}`).prop('checked', false);
            } else {
                selectedStaffMembers.push(staffId);
                staffItem.addClass('selected');
                $(`#staffCheck${staffId}`).prop('checked', true);
            }
            updateSelectedStaffDisplay();
        }

        // Update selected staff display
        function updateSelectedStaffDisplay() {
            const count = selectedStaffMembers.length;
            $('#selectedStaffCount').text(count);
            const listContainer = $('#selectedStaffList');

            // Show/hide clear all button
            if (count > 0) {
                $('#clearAllStaff').show();
            } else {
                $('#clearAllStaff').hide();
            }

            if (count === 0) {
                listContainer.html('<p class="text-muted text-center mb-0 small"><i class="fas fa-info-circle me-1"></i>No staff selected yet</p>');
                return;
            }

            let html = '';
            selectedStaffMembers.forEach(staffId => {
                const staff = allStaff.find(s => s.id === staffId);
                if (staff) {
                    const escapedName = (staff.name || '').replace(/'/g, "\\'");
                    html += `
                        <span class="selected-staff-badge">
                            <i class="fas fa-user-check me-2"></i>${staff.name}
                            <span class="remove-staff" onclick="event.stopPropagation(); toggleStaffSelection(${staffId}, '${escapedName}');">
                                <i class="fas fa-times"></i>
                            </span>
                        </span>
                    `;
                }
            });
            listContainer.html(html);
        }

        // Preview staff message
        function previewStaffMessage() {
            const templateName = $('input[name="templateName"]').val();
            const messageContent = $('textarea[name="messageContent"]').val();
            const messageSubject = $('input[name="messageSubject"]').val();
            const audienceType = $('#audienceType').val();

            if (!messageContent) {
                alert('Please enter message content to preview');
                return;
            }

            let audienceText = 'All Staff';
            if (audienceType === 'individuals') {
                audienceText = `${selectedStaffMembers.length} selected staff member(s)`;
            }

            // Replace variables with sample data
            let previewContent = messageContent
                .replace(/{name}/g, '<strong>[Staff Name]</strong>')
                .replace(/{role}/g, '<strong>[Staff Role]</strong>')
                .replace(/{email}/g, '<strong>[Staff Email]</strong>')
                .replace(/{phone}/g, '<strong>[Staff Phone]</strong>');

            const previewHtml = `
                <div class="mb-2"><strong>Template:</strong> ${templateName || 'Untitled'}</div>
                ${messageSubject ? `<div class="mb-2"><strong>Subject:</strong> ${messageSubject}</div>` : ''}
                <div class="mb-2"><strong>Audience:</strong> ${audienceText}</div>
                <hr>
                <div style="white-space: pre-wrap;">${previewContent}</div>
            `;

            $('#staffMessagePreview').html(previewHtml);
        }

        // Send immediate staff message
        function sendImmediateStaffMessage() {
            const formData = getStaffMessageFormData();

            if (!validateStaffMessageForm(formData)) {
                return;
            }

            if (!confirm('Send this message immediately to the selected audience?')) {
                return;
            }

            // Prepare data for API
            const apiData = {
                recipient_type: formData.audienceType === 'all_staff' ? 'staff_all' : 'staff_selected',
                subject: formData.messageSubject,
                message: formData.messageContent,
                priority: 'normal',
                status: 'sent',
                channels: formData.channels
            };

            if (formData.audienceType === 'individuals') {
                apiData.recipient_ids = JSON.stringify(selectedStaffMembers);
            }

            $.ajax({
                url: '{% url "adminSupport:api_messages_save" %}',
                method: 'POST',
                data: apiData,
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response.success) {
                        alert('Message sent successfully!');
                        $('#composeStaffMessageModal').modal('hide');
                        $('#composeStaffMessageForm')[0].reset();
                        selectedStaffMembers = [];
                        updateSelectedStaffDisplay();
                    } else {
                        alert('Failed to send message: ' + (response.message || 'Unknown error'));
                    }
                },
                error: function () {
                    alert('An error occurred while sending the message. Please try again.');
                }
            });
        }

        // Schedule staff message
        function scheduleStaffMessage() {
            const formData = getStaffMessageFormData();

            if (!validateStaffMessageForm(formData)) {
                return;
            }

            // Check if schedule is required
            if (!$('#sendImmediatelyToggle').is(':checked')) {
                if (!formData.triggerDate || !formData.triggerTime) {
                    alert('Please set trigger date and time for scheduled messages');
                    return;
                }
            }

            const apiData = {
                recipient_type: formData.audienceType === 'all_staff' ? 'staff_all' : 'staff_selected',
                subject: formData.messageSubject,
                message: formData.messageContent,
                priority: 'normal',
                status: 'scheduled',
                channels: formData.channels,
                template_name: formData.templateName,
                trigger_date: formData.triggerDate,
                trigger_time: formData.triggerTime,
                repeat_schedule: formData.repeatSchedule,
                save_as_template: formData.saveAsTemplate
            };

            if (formData.audienceType === 'individuals') {
                apiData.recipient_ids = JSON.stringify(selectedStaffMembers);
            }

            $.ajax({
                url: '{% url "adminSupport:api_messages_save" %}',
                method: 'POST',
                data: apiData,
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response.success) {
                        alert('Message scheduled successfully!');
                        $('#composeStaffMessageModal').modal('hide');
                        $('#composeStaffMessageForm')[0].reset();
                        selectedStaffMembers = [];
                        updateSelectedStaffDisplay();
                    } else {
                        alert('Failed to schedule message: ' + (response.message || 'Unknown error'));
                    }
                },
                error: function () {
                    alert('An error occurred while scheduling the message. Please try again.');
                }
            });
        }

        // Get staff message form data
        function getStaffMessageFormData() {
            const channels = [];
            $('input[name="channels"]:checked').each(function () {
                channels.push($(this).val());
            });

            return {
                templateName: $('input[name="templateName"]').val(),
                audienceType: $('#audienceType').val(),
                messageSubject: $('input[name="messageSubject"]').val(),
                messageContent: $('textarea[name="messageContent"]').val(),
                channels: channels.join(','),
                triggerDate: $('input[name="triggerDate"]').val(),
                triggerTime: $('input[name="triggerTime"]').val(),
                repeatSchedule: $('select[name="repeatSchedule"]').val(),
                saveAsTemplate: $('#saveAsTemplate').is(':checked')
            };
        }

        // Validate staff message form
        function validateStaffMessageForm(formData) {
            if (!formData.templateName) {
                alert('Please enter a template name');
                return false;
            }

            if (!formData.audienceType) {
                alert('Please select an audience');
                return false;
            }

            if (formData.audienceType === 'individuals' && selectedStaffMembers.length === 0) {
                alert('Please select at least one staff member from the search list');
                $('#staffSearchBox').focus();
                return false;
            }

            if (!formData.messageContent) {
                alert('Please enter message content');
                return false;
            }

            if (formData.channels.length === 0) {
                alert('Please select at least one communication channel');
                return false;
            }

            return true;
        }

        // Remove staff
        function removeStaff(staffId, staffName) {
            staffToRemove = staffId;
            $('#removeStaffName').text(staffName);
            $('#removeStaffModal').modal('show');
        }

        // Confirm remove staff
        function confirmRemoveStaff(staffId) {
            const btn = $('#confirmRemoveStaff');
            btn.html('<span class="loading-spinner"></span> Removing...').prop('disabled', true);

            $.ajax({
                url: '{% url "adminSupport:api_staff_remove" %}',
                method: 'POST',
                data: { staff_id: staffId },
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response.success) {
                        $('#removeStaffModal').modal('hide');
                        loadStaffStats();
                        loadStaffDirectory();
                        loadFormerStaff();
                    } else {
                        showAlert('removeStaffAlert', 'error', response.message || 'Failed to remove staff member');
                    }
                },
                error: function () {
                    showAlert('removeStaffAlert', 'error', 'An error occurred. Please try again.');
                },
                complete: function () {
                    btn.html('<i class="fas fa-trash"></i> Remove').prop('disabled', false);
                    staffToRemove = null;
                }
            });
        }

        // Reactivate staff
        function reactivateStaff(staffId) {
            if (!confirm('Are you sure you want to reactivate this staff member?')) return;

            $.ajax({
                url: '{% url "adminSupport:api_staff_reactivate" %}',
                method: 'POST',
                data: { staff_id: staffId },
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response.success) {
                        loadStaffStats();
                        loadStaffDirectory();
                        loadFormerStaff();
                    } else {
                        alert(response.message || 'Failed to reactivate staff member');
                    }
                },
                error: function () {
                    alert('An error occurred. Please try again.');
                }
            });
        }

        // Show alert
        function showAlert(containerId, type, message) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            const html = `
                <div class="alert-custom ${alertClass}">
                    <i class="fas ${icon}"></i>
                    <div>${message}</div>
                </div>
            `;
            $('#' + containerId).html(html);

            setTimeout(() => {
                $('#' + containerId).html('');
            }, 5000);
        }

        // === DEBUG HELPER FUNCTION ===
        // Call from console: testMessageModal()
        window.testMessageModal = function () {
            console.log('=== Testing Message Modal ===');
            console.log('All staff count:', allStaff.length);
            console.log('Selected staff:', selectedStaffMembers);
            console.log('Staff list loaded:', staffListLoaded);
            console.log('Opening modal...');
            $('#composeStaffMessageModal').modal('show');
        };

        // Initialize compose staff message modal after all functions are defined
        $(document).ready(function () {
            setupComposeStaffMessageModal();
        });
</script>
{% endblock %}