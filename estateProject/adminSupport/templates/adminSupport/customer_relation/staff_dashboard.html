{% extends 'adminSupport/customer_relations_base.html' %}

{% load static %}

{% block title %}Staff Directory{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #2563eb;
        --primary-hover: #1d4ed8;
        --secondary-color: #64748b;
        --success-color: #22c55e;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
        --info-color: #3b82f6;
        --light-bg: #f8fafc;
        --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        --card-shadow-hover: 0 10px 25px rgba(0, 0, 0, 0.1);
        --border-radius: 12px;
        --transition: all 0.3s ease;
    }

    body {
        background-color: var(--light-bg);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        color: #1e293b;
        padding-top: 60px;
    }
    
    /* Custom modal z-index to appear above other modals */
    #customAlertModal,
    #customConfirmModal,
    #customPromptModal {
        z-index: 10000 !important;
    }
    
    /* Custom backdrops for alert, confirm, and prompt modals */
    #customAlertBackdrop,
    #customConfirmBackdrop,
    #customPromptBackdrop {
        z-index: 9999 !important;
        opacity: 0.5;
    }
    
    /* Default modal backdrop (for department modal) */
    .modal-backdrop:not(#customAlertBackdrop):not(#customConfirmBackdrop):not(#customPromptBackdrop) {
        z-index: 1040 !important;
    }
    
    .modal-backdrop.show {
        opacity: 0.5;
    }

    .main-wrapper {
        display: flex;
        min-height: 100vh;
    }

    .content-area {
        flex: 1;
        padding: 2rem;
        margin-left: 280px;
    }

    .page-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, #1e40af 100%);
        border-radius: var(--border-radius);
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
        box-shadow: var(--card-shadow);
    }

    .page-header h1 {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .page-header p {
        margin: 0.5rem 0 0 0;
        opacity: 0.9;
        font-size: 0.95rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
        transition: var(--transition);
        border-left: 4px solid;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--card-shadow-hover);
    }

    .stat-card.primary {
        border-left-color: var(--primary-color);
    }

    .stat-card.success {
        border-left-color: var(--success-color);
    }

    .stat-card.warning {
        border-left-color: var(--warning-color);
    }

    .stat-card.info {
        border-left-color: var(--info-color);
    }

    .stat-card .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }

    .stat-card.primary .stat-icon {
        background: rgba(37, 99, 235, 0.1);
        color: var(--primary-color);
    }

    .stat-card.success .stat-icon {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
    }

    .stat-card.warning .stat-icon {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
    }

    .stat-card.info .stat-icon {
        background: rgba(59, 130, 246, 0.1);
        color: var(--info-color);
    }

    .stat-card h3 {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        color: #1e293b;
    }

    .stat-card p {
        margin: 0.5rem 0 0 0;
        color: var(--secondary-color);
        font-size: 0.875rem;
        font-weight: 500;
    }

    .content-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
    }

    .card-header-custom {
        padding: 1.5rem;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .card-header-custom h2 {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
        color: #1e293b;
    }

    .card-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .btn-custom {
        padding: 0.625rem 1.25rem;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.875rem;
        border: none;
        cursor: pointer;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary-custom {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary-custom:hover {
        background: var(--primary-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .btn-success-custom {
        background: var(--success-color);
        color: white;
    }

    .btn-success-custom:hover {
        background: #16a34a;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }

    .btn-danger-custom {
        background: var(--danger-color);
        color: white;
    }

    .btn-danger-custom:hover {
        background: #dc2626;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .btn-outline-custom {
        background: white;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
    }

    .btn-outline-custom:hover {
        background: var(--primary-color);
        color: white;
    }

    .btn-custom:hover {
        transform: translateY(-2px);
    }

    .search-filter-bar {
        padding: 1.5rem;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
    }

    .search-box {
        flex: 1;
        min-width: 250px;
        position: relative;
    }

    .search-box input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.875rem;
        transition: var(--transition);
    }

    .search-box input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .search-box i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--secondary-color);
    }

    .filter-select {
        padding: 0.75rem 1rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: var(--transition);
        background: white;
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .table-container {
        padding: 1.5rem;
        overflow-x: auto;
    }

    .modern-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 0.5rem;
    }

    .modern-table thead th {
        background: #f8fafc;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.875rem;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border: none;
    }

    .modern-table tbody tr {
        background: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: var(--transition);
    }

    .modern-table tbody tr:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .modern-table tbody td {
        padding: 1rem;
        border: none;
        vertical-align: middle;
    }

    .modern-table tbody tr td:first-child {
        border-top-left-radius: 8px;
        border-bottom-left-radius: 8px;
    }

    .modern-table tbody tr td:last-child {
        border-top-right-radius: 8px;
        border-bottom-right-radius: 8px;
    }

    .staff-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #e2e8f0;
    }

    .staff-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .staff-details h4 {
        margin: 0;
        font-size: 0.9375rem;
        font-weight: 600;
        color: #1e293b;
    }

    .staff-details p {
        margin: 0;
        font-size: 0.8125rem;
        color: var(--secondary-color);
    }

    .badge-custom {
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
    }

    .badge-active {
        background: rgba(34, 197, 94, 0.1);
        color: #16a34a;
    }

    .badge-inactive {
        background: rgba(100, 116, 139, 0.1);
        color: #475569;
    }

    .badge-role {
        background: rgba(37, 99, 235, 0.1);
        color: var(--primary-color);
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .action-btn {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
    }

    .action-btn.edit {
        background: rgba(37, 99, 235, 0.1);
        color: var(--primary-color);
    }

    .action-btn.edit:hover {
        background: var(--primary-color);
        color: white;
    }

    .action-btn.delete {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger-color);
    }

    .action-btn.delete:hover {
        background: var(--danger-color);
        color: white;
    }

    .action-btn.message {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
    }

    .action-btn.message:hover {
        background: var(--warning-color);
        color: white;
    }

    .action-btn.reactivate {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
    }

    .action-btn.reactivate:hover {
        background: var(--success-color);
        color: white;
    }

    .pagination-container {
        padding: 1.5rem;
        border-top: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .pagination-info {
        color: var(--secondary-color);
        font-size: 0.875rem;
    }

    .pagination-controls {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .pagination-btn {
        width: 36px;
        height: 36px;
        border-radius: 6px;
        border: 2px solid #e2e8f0;
        background: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var(--transition);
        font-weight: 500;
        color: #64748b;
    }

    .pagination-btn:hover:not(:disabled) {
        border-color: var(--primary-color);
        color: var(--primary-color);
        background: rgba(37, 99, 235, 0.05);
    }

    .pagination-btn.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .per-page-select {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--secondary-color);
    }

    .per-page-select select {
        padding: 0.5rem;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        cursor: pointer;
        background: white;
    }

    /* Modal Styles */
    .modal-content {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
        border-bottom: 1px solid #e2e8f0;
        padding: 1.5rem;
        background: #f8fafc;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .modal-title {
        font-weight: 600;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        border-top: 1px solid #e2e8f0;
        padding: 1.5rem;
        background: #f8fafc;
        border-radius: 0 0 var(--border-radius) var(--border-radius);
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #334155;
        font-size: 0.875rem;
    }

    .form-control-custom {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 0.875rem;
        transition: var(--transition);
    }

    .form-control-custom:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--secondary-color);
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }

    .empty-state h3 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #64748b;
    }

    .empty-state p {
        font-size: 0.875rem;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .alert-custom {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .alert-success {
        background: rgba(34, 197, 94, 0.1);
        color: #16a34a;
        border-left: 4px solid var(--success-color);
    }

    .alert-error {
        background: rgba(239, 68, 68, 0.1);
        color: #dc2626;
        border-left: 4px solid var(--danger-color);
    }

    /* Staff Selection Dropdown Styles */
    .staff-select-item {
        padding: 10px 12px;
        margin-bottom: 6px;
        border-radius: 6px;
        transition: all 0.2s ease;
        cursor: pointer;
        border: 1px solid #e5e7eb;
        background: white;
    }

    .staff-select-item:hover {
        background: #f3f4f6;
        border-color: #3b82f6;
        transform: translateX(2px);
    }

    .staff-select-item input[type="checkbox"] {
        cursor: pointer;
        width: 18px;
        height: 18px;
        margin-right: 10px;
    }

    .staff-select-item label {
        cursor: pointer;
        margin-bottom: 0;
        user-select: none;
        display: flex;
        align-items: center;
        width: 100%;
    }

    .staff-select-item.selected {
        background: #eff6ff;
        border-color: #3b82f6;
    }

    .staff-member-info {
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    .staff-member-name {
        font-weight: 600;
        color: #1f2937;
        font-size: 14px;
    }

    .staff-member-role {
        font-size: 12px;
        color: #6b7280;
        margin-top: 2px;
    }

    #staffSelectionContainer {
        background: #f9fafb;
        border: 2px solid #e5e7eb !important;
    }

    #staffSearchBox {
        border: 2px solid #3b82f6 !important;
        font-size: 14px;
    }

    #staffSearchBox:focus {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        border-color: #2563eb !important;
    }

    .selected-staff-badge {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        margin: 4px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
    }

    .selected-staff-badge .remove-staff {
        margin-left: 8px;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
    }

    .selected-staff-badge .remove-staff:hover {
        opacity: 1;
    }

    .staff-search-hint {
        color: #6b7280;
        font-size: 12px;
        margin-top: 4px;
        font-style: italic;
    }

    /* Staff Selection Styles */
    .staff-select-item {
        transition: all 0.2s ease;
    }

    .staff-select-item:hover {
        background-color: #f1f5f9 !important;
        border-color: #94a3b8 !important;
        transform: translateX(4px);
    }

    .staff-select-item.selected {
        background-color: #e8f5e9 !important;
        border-color: #4caf50 !important;
    }

    .staff-select-item.selected:hover {
        background-color: #d4edda !important;
        border-color: #28a745 !important;
    }

    .staff-select-item label {
        cursor: pointer;
        margin-bottom: 0;
    }

    .staff-select-item .form-check-input {
        cursor: pointer;
        width: 20px;
        height: 20px;
        margin-top: 0;
    }

    .staff-select-item .form-check-input:checked {
        background-color: #4caf50;
        border-color: #4caf50;
    }

    .selected-staff-badge {
        display: inline-flex;
        align-items: center;
        background-color: #e8f5e9;
        border: 1px solid #4caf50;
        border-radius: 20px;
        padding: 6px 12px;
        margin: 4px;
        font-size: 14px;
        color: #2e7d32;
    }

    .selected-staff-badge .remove-staff {
        margin-left: 8px;
        cursor: pointer;
        color: #d32f2f;
        transition: color 0.2s;
    }

    .selected-staff-badge .remove-staff:hover {
        color: #b71c1c;
    }

    #staffSelectionContainer::-webkit-scrollbar {
        width: 8px;
    }

    #staffSelectionContainer::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    #staffSelectionContainer::-webkit-scrollbar-thumb {
        background: #94a3b8;
        border-radius: 4px;
    }

    #staffSelectionContainer::-webkit-scrollbar-thumb:hover {
        background: #64748b;
    }

    @media (max-width: 768px) {
        .content-area {
            margin-left: 0;
            padding: 1rem;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .card-header-custom {
            flex-direction: column;
            align-items: flex-start;
        }

        .pagination-container {
            flex-direction: column;
            align-items: flex-start;
        }

        .table-container {
            padding: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        <i class="fas fa-users"></i>
        Staff Directory
    </h1>
    <p>Manage and organize your staff members efficiently</p>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card primary">
        <div class="stat-icon">
            <i class="fas fa-users"></i>
        </div>
        <h3 id="totalStaffCount">0</h3>
        <p>Total Staff</p>
    </div>

    <div class="stat-card success">
        <div class="stat-icon">
            <i class="fas fa-user-check"></i>
        </div>
        <h3 id="activeStaffCount">0</h3>
        <p>Active Staff</p>
    </div>

    <div class="stat-card warning">
        <div class="stat-icon">
            <i class="fas fa-user-clock"></i>
        </div>
        <h3 id="formerStaffCount">0</h3>
        <p>Former Staff</p>
    </div>

    <div class="stat-card info">
        <div class="stat-icon">
            <i class="fas fa-building"></i>
        </div>
        <h3 id="departmentsCount">0</h3>
        <p>Departments</p>
    </div>
</div>

<!-- Active Staff Table -->
<div class="content-card">
    <div class="card-header-custom">
        <h2><i class="fas fa-users me-2"></i> Active Staff Members</h2>
        <div class="card-actions">
            <button class="btn-custom btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addStaffModal">
                <i class="fas fa-plus"></i>
                Add Staff
            </button>
            <button class="btn-custom btn-success-custom" data-bs-toggle="modal" data-bs-target="#importStaffModal">
                <i class="fas fa-file-import"></i>
                Import Staff
            </button>
            <button class="btn-custom btn-custom" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none;"
                data-bs-toggle="modal" data-bs-target="#departmentRoleModal">
                <i class="fas fa-sitemap me-2"></i>
                Manage Departments & Roles
            </button>
            <button class="btn-custom btn-custom" style="background: var(--warning-color); color: white;"
                data-bs-toggle="modal" data-bs-target="#composeStaffMessageModal">
                <i class="fas fa-envelope"></i>
                Message Staff
            </button>
        </div>
    </div>

    <div class="search-filter-bar">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Search staff by name, email, or department...">
        </div>
        <select class="filter-select" id="roleFilter">
            <option value="">All Roles</option>
            <option value="Manager">Manager</option>
            <option value="Agent">Agent</option>
            <option value="Marketer">Marketer</option>
            <option value="Support">Support</option>
            <option value="Admin">Admin</option>
        </select>
        <select class="filter-select" id="departmentFilter">
            <option value="">All Departments</option>
            <option value="Sales">Sales</option>
            <option value="Marketing">Marketing</option>
            <option value="Operations">Operations</option>
            <option value="Finance">Finance</option>
            <option value="HR">HR</option>
        </select>
    </div>

    <div class="table-container">
        <table class="modern-table" id="activeStaffTable">
            <thead>
                <tr>
                    <th>Staff Member</th>
                    <th>Role</th>
                    <th>Department</th>
                    <th>Phone</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="activeStaffTableBody">
                <tr>
                    <td colspan="6">
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <h3>Loading...</h3>
                            <p>Fetching staff data</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="pagination-container">
        <div class="pagination-info">
            Showing <span id="showingFrom">0</span> to <span id="showingTo">0</span> of <span id="totalRecords">0</span>
            entries
        </div>
        <div class="pagination-controls" id="paginationControls">
            <!-- Pagination buttons will be inserted here -->
        </div>
        <div class="per-page-select">
            <label for="perPageSelect">Show:</label>
            <select id="perPageSelect">
                <option value="10">10</option>
                <option value="25" selected>25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
        </div>
    </div>
</div>

<!-- Former Staff Table -->
<div class="content-card">
    <div class="card-header-custom">
        <h2><i class="fas fa-user-clock me-2"></i> Former Staff Members</h2>
    </div>

    <div class="table-container">
        <table class="modern-table" id="formerStaffTable">
            <thead>
                <tr>
                    <th>Staff Member</th>
                    <th>Role</th>
                    <th>Department</th>
                    <th>Removed Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="formerStaffTableBody">
                <tr>
                    <td colspan="5">
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <h3>Loading...</h3>
                            <p>Fetching former staff data</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="pagination-container">
        <div class="pagination-info">
            Showing <span id="formerShowingFrom">0</span> to <span id="formerShowingTo">0</span> of <span
                id="formerTotalRecords">0</span> entries
        </div>
        <div class="pagination-controls" id="formerPaginationControls">
            <!-- Pagination buttons will be inserted here -->
        </div>
        <div class="per-page-select">
            <label for="formerPerPageSelect">Show:</label>
            <select id="formerPerPageSelect">
                <option value="10" selected>10</option>
                <option value="25">25</option>
                <option value="50">50</option>
            </select>
        </div>
    </div>
</div>
</div>
</div>

<!-- Add Staff Modal -->
<div class="modal fade" id="addStaffModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 1rem 1rem 0 0;">
                <h5 class="modal-title d-flex align-items-center">
                    <i id="addStaffModalIcon" class="fas fa-user-plus me-3" style="font-size: 1.5rem;"></i>
                    <span id="addStaffModalTitleText">Add New Staff Member</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="addStaffForm">
                {% csrf_token %}
                <input type="hidden" name="staff_id" id="staffIdField">
                <div class="modal-body p-4">
                    <div id="addStaffAlert"></div>
                    
                    <!-- Warning Badge if no departments/roles -->
                    <div id="noDeptRoleWarning" class="alert alert-warning alert-dismissible fade show mb-4" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle me-3" style="font-size: 1.5rem;"></i>
                            <div>
                                <strong>‚ö†Ô∏è No Departments or Roles Found</strong>
                                <p class="mb-0 small mt-1">Before adding staff, please create departments and roles. Click the <strong>"Manage Departments & Roles"</strong> button in the staff list header.</p>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <!-- Profile Picture Upload -->
                            <div class="mb-4">
                                <label class="form-label fw-semibold">Profile Picture</label>
                                <div class="profile-upload-container" style="text-align: center;">
                                    <div class="profile-preview" id="addStaffProfilePreview" style="width: 120px; height: 120px; margin: 0 auto 15px; border: 3px dashed #dee2e6; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #f8f9fa; cursor: pointer;" onclick="$('#staffProfilePicture').click()">
                                        <i class="fas fa-camera" style="font-size: 32px; color: #adb5bd;"></i>
                                    </div>
                                    <input type="file" id="staffProfilePicture" name="profile_picture" accept="image/*" style="display: none;">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="$('#staffProfilePicture').click()">
                                        <i class="fas fa-upload me-1"></i>Choose Photo
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger ms-2" id="removeAddStaffPhoto" style="display: none;" onclick="removeAddStaffProfilePicture()">
                                        <i class="fas fa-times me-1"></i>Remove
                                    </button>
                                    <div class="form-text mt-2">Optional passport photo (JPG, PNG, max 5MB)</div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Full Name *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                                    <input type="text" class="form-control" id="staffName" name="full_name" required
                                        placeholder="Enter full name">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Department *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-building"></i></span>
                                    <select class="form-select" id="staffDepartment" name="department_id" required>
                                        <option value="">Select Department</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Role/Position *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
                                    <select class="form-select" id="staffRole" name="role_id" required>
                                        <option value="">Select a Department First</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Employment Date *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                    <input type="date" class="form-control" id="staffEmploymentDate" name="employment_date" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Address *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                    <textarea class="form-control" id="staffAddress" name="address" rows="3"
                                        placeholder="Enter full address" required></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Phone Number *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                    <input type="tel" class="form-control" id="staffPhone" name="phone_number"
                                        placeholder="+234-XXX-XXX-XXXX" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Email Address *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                    <input type="email" class="form-control" id="staffEmail" name="email"
                                        placeholder="staff@company.com" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">WhatsApp Number</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fab fa-whatsapp"></i></span>
                                    <input type="tel" class="form-control" id="staffWhatsapp" name="whatsapp"
                                        placeholder="+234-XXX-XXX-XXXX">
                                </div>
                                <div class="form-text">Optional - Leave blank if same as phone number</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Date of Birth *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-birthday-cake"></i></span>
                                    <input type="date" class="form-control" id="staffDOB" name="date_of_birth" required>
                                </div>
                                <div class="form-text">Used for birthday reminders and staff analytics</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="submitAddStaff">
                        <i class="fas fa-user-plus me-2"></i>Add Staff Member
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Staff Modal -->
<div class="modal fade" id="editStaffModal">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-edit"></i>
                    Edit Staff Member
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="editStaffAlert"></div>
                <form id="editStaffForm">
                    <div class="row">
                        <div class="col-md-6">
                            <!-- Profile Picture Upload -->
                            <div class="mb-4">
                                <label class="form-label fw-semibold">Profile Picture</label>
                                <div class="profile-upload-container" style="text-align: center;">
                                    <div class="profile-preview" id="editStaffProfilePreview" style="width: 120px; height: 120px; margin: 0 auto 15px; border: 3px dashed #dee2e6; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #f8f9fa; cursor: pointer;" onclick="$('#editStaffProfilePicture').click()">
                                        <i class="fas fa-camera" style="font-size: 32px; color: #adb5bd;"></i>
                                    </div>
                                    <input type="file" id="editStaffProfilePicture" name="profile_picture" accept="image/*" style="display: none;">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="$('#editStaffProfilePicture').click()">
                                        <i class="fas fa-upload me-1"></i>Change Photo
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger ms-2" id="removeEditStaffPhoto" style="display: none;" onclick="removeEditStaffProfilePicture()">
                                        <i class="fas fa-times me-1"></i>Remove
                                    </button>
                                    <div class="form-text mt-2">Update passport photo (JPG, PNG, max 5MB)</div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Full Name *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                                    <input type="text" class="form-control" id="editStaffName" name="full_name" required
                                        placeholder="Enter full name">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Department *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-building"></i></span>
                                    <select class="form-select" id="editStaffDepartment" name="department_id" required>
                                        <option value="">Select Department</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Role/Position *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
                                    <select class="form-select" id="editStaffRole" name="role_id" required>
                                        <option value="">Select a Department First</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Employment Date *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                                    <input type="date" class="form-control" id="editStaffEmploymentDate" name="employment_date" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Address *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                    <textarea class="form-control" id="editStaffAddress" name="address" rows="3"
                                        placeholder="Enter full address" required></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Phone Number *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                    <input type="tel" class="form-control" id="editStaffPhone" name="phone_number"
                                        placeholder="+234-XXX-XXX-XXXX" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Email Address *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                    <input type="email" class="form-control" id="editStaffEmail" name="email"
                                        placeholder="staff@company.com" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">WhatsApp Number</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fab fa-whatsapp"></i></span>
                                    <input type="tel" class="form-control" id="editStaffWhatsapp" name="whatsapp"
                                        placeholder="+234-XXX-XXX-XXXX">
                                </div>
                                <div class="form-text">Optional - Leave blank if same as phone number</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Date of Birth *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-birthday-cake"></i></span>
                                    <input type="date" class="form-control" id="editStaffDOB" name="date_of_birth" required>
                                </div>
                                <div class="form-text">Used for birthday reminders and staff analytics</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitEditStaff">
                    <i class="fas fa-save me-2"></i>Update Staff Member
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Import Staff Modal -->
<div class="modal fade" id="importStaffModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-import"></i>
                    Import Staff
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="importStaffAlert"></div>
                
                <!-- Warning Badge if no departments/roles -->
                <div id="noDeptRoleWarningImport" class="alert alert-warning alert-dismissible fade show mb-4" style="display: none;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle me-3" style="font-size: 1.5rem;"></i>
                        <div>
                            <strong>‚ö†Ô∏è No Departments or Roles Found</strong>
                            <p class="mb-0 small mt-1">Before importing staff, please create departments and roles. Click the <strong>"Manage Departments & Roles"</strong> button in the staff list header.</p>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                
                <!-- Download Template Section -->
                <div class="alert alert-info mb-4" style="background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); border: 2px dashed #0ea5e9; border-radius: 12px;">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-excel me-3" style="font-size: 2.5rem; color: #0ea5e9;"></i>
                            <div>
                                <h6 class="mb-1 fw-bold" style="color: #0369a1;">üì• Download Excel Template</h6>
                                <p class="mb-0 small" style="color: #0c4a6e;">Get the correct format with sample data and instructions</p>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary btn-sm" id="downloadTemplateBtn" style="min-width: 140px; font-weight: 600; box-shadow: 0 4px 6px rgba(3, 105, 161, 0.3);">
                            <i class="fas fa-download me-2"></i>Download Template
                        </button>
                    </div>
                </div>
                
                <form id="importStaffForm">
                    {% csrf_token %}
                    
                    <!-- Drag and Drop Zone -->
                    <div class="form-group">
                        <label class="form-label fw-semibold">Upload Staff File *</label>
                        <div id="dropZone" class="border-2 border-dashed rounded p-4 text-center" style="border-color: #cbd5e1; background: #f8fafc; cursor: pointer; transition: all 0.3s ease;">
                            <div id="dropZoneContent">
                                <i class="fas fa-cloud-upload-alt mb-3" style="font-size: 3rem; color: #94a3b8;"></i>
                                <h6 class="mb-2" style="color: #475569;">Drag & Drop your file here</h6>
                                <p class="text-muted small mb-2">or click to browse</p>
                                <p class="text-muted small mb-0">
                                    <i class="fas fa-file-excel text-success me-1"></i> Excel (.xlsx, .xls) or 
                                    <i class="fas fa-file-csv text-primary me-1"></i> CSV (.csv)
                                </p>
                            </div>
                            <input type="file" class="d-none" id="staffFile" name="file" accept=".csv,.xlsx,.xls">
                        </div>
                        <div id="fileInfo" class="mt-3 p-3 rounded" style="background: #f1f5f9; display: none;">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file-alt me-2" style="color: #64748b;"></i>
                                    <span id="fileName" class="fw-semibold" style="color: #334155;"></span>
                                    <span id="fileSize" class="ms-2 text-muted small"></span>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" id="removeFileBtn">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert-custom alert-success mt-3">
                        <i class="fas fa-lightbulb"></i>
                        <div>
                            <strong>üìã Required Columns:</strong>
                            <ul class="mb-0 mt-2 small">
                                <li><strong>full_name</strong> - Employee's full name</li>
                                <li><strong>email</strong> - Valid email address</li>
                                <li><strong>phone</strong> - Contact phone number</li>
                                <li><strong>department_name</strong> - Must match existing department</li>
                                <li><strong>role_name</strong> - Must match existing role in that department</li>
                                <li><strong>address</strong> - Physical address (optional)</li>
                                <li><strong>employment_date</strong> - Format: YYYY-MM-DD (optional)</li>
                                <li><strong>date_of_birth</strong> - Format: YYYY-MM-DD (optional)</li>
                                <li><strong>whatsapp</strong> - WhatsApp number (optional)</li>
                            </ul>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-custom btn-outline-custom" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-custom btn-success-custom" id="submitImportStaff">
                    <i class="fas fa-upload"></i>
                    Import Staff
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Remove Staff Modal -->
<div class="modal fade" id="removeStaffModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 1rem 1rem 0 0;">
                <h5 class="modal-title d-flex align-items-center">
                    <i class="fas fa-user-times me-3" style="font-size: 1.5rem;"></i>
                    Remove Staff Member
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="removeStaffForm">
                {% csrf_token %}
                <input type="hidden" name="staffId" id="removeStaffId">
                <div class="modal-body p-4">
                    <div id="removeStaffAlert"></div>
                    <div class="alert alert-warning d-flex align-items-center mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <div>
                            <strong>Are you sure you want to remove staff member:</strong>
                            <div class="mt-1" id="removeStaffName">Staff Name</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Select Reason(s) for Removal *</label>
                        <div class="form-text mb-2">
                            <i class="fas fa-info-circle me-1"></i>
                            You can select multiple reasons if applicable
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="removalReason" value="retired" id="reasonRetired">
                                    <label class="form-check-label" for="reasonRetired">
                                        <i class="fas fa-user-clock me-1 text-info"></i>Retired
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="removalReason" value="resigned" id="reasonResigned">
                                    <label class="form-check-label" for="reasonResigned">
                                        <i class="fas fa-handshake me-1 text-success"></i>Resigned
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="removalReason" value="absconded" id="reasonAbsconded">
                                    <label class="form-check-label" for="reasonAbsconded">
                                        <i class="fas fa-user-slash me-1 text-warning"></i>Absconded
                                    </label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="removalReason" value="sacked" id="reasonSacked">
                                    <label class="form-check-label" for="reasonSacked">
                                        <i class="fas fa-user-minus me-1 text-danger"></i>Sacked
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="removalReason" value="fired" id="reasonFired">
                                    <label class="form-check-label" for="reasonFired">
                                        <i class="fas fa-fire me-1 text-danger"></i>Fired
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="removalReason" value="terminated" id="reasonTerminated">
                                    <label class="form-check-label" for="reasonTerminated">
                                        <i class="fas fa-ban me-1 text-dark"></i>Terminated
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="removalReason" value="dismissed" id="reasonDismissed">
                                    <label class="form-check-label" for="reasonDismissed">
                                        <i class="fas fa-times-circle me-1 text-danger"></i>Dismissed
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="removalReason" value="contract_ended" id="reasonContractEnded">
                                    <label class="form-check-label" for="reasonContractEnded">
                                        <i class="fas fa-calendar-times me-1 text-secondary"></i>Contract Ended
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Additional Notes (Optional)</label>
                        <textarea class="form-control" name="removalNotes" id="removalNotes" rows="3" placeholder="Any additional notes about the removal..."></textarea>
                    </div>
                    
                    <p class="text-muted small mb-0">
                        <i class="fas fa-info-circle me-1"></i>
                        This action can be reversed by reactivating the staff member from the Former Staff table.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning" id="confirmRemoveStaff">
                        <i class="fas fa-user-times me-2"></i>Remove Staff
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Message Individual Staff Modal -->
<div class="modal fade" id="messageStaffModal">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-envelope"></i>
                    Send Message to Staff Member
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="messageStaffAlert"></div>
                <div class="alert-custom alert-success mb-3">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Recipient:</strong> <span id="messageRecipientName"></span> (<span
                            id="messageRecipientEmail"></span>)
                    </div>
                </div>
                <form id="messageStaffForm">
                    {% csrf_token %}
                    <input type="hidden" id="messageStaffId">
                    <div class="form-group">
                        <label class="form-label">Subject *</label>
                        <input type="text" class="form-control-custom" id="messageSubject" name="subject"
                            placeholder="Enter message subject" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Message *</label>
                        <textarea class="form-control-custom" id="messageContent" name="message" rows="6"
                            placeholder="Type your message here..." required style="resize: vertical;"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-control-custom" id="messagePriority" name="priority">
                            <option value="normal">Normal</option>
                            <option value="high">High Priority</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-custom btn-outline-custom" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-custom btn-primary-custom" id="submitMessageStaff">
                    <i class="fas fa-paper-plane"></i>
                    Send Message
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Auto Message Template Modal -->
<div class="modal fade" id="composeStaffMessageModal">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white; border-radius: 1rem 1rem 0 0;">
                <h5 class="modal-title d-flex align-items-center">
                    <i class="fas fa-envelope me-3" style="font-size: 1.5rem;"></i>
                    Create Auto Message Template
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="composeStaffMessageForm">
                <div class="modal-body p-4">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Template Name *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-tag"></i></span>
                                    <input type="text" class="form-control" name="templateName"
                                        placeholder="e.g., Monthly Update" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Audience Selection *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-users"></i></span>
                                    <select class="form-select" name="audienceType" id="audienceType" required>
                                        <option value="">Select Audience</option>
                                        <option value="all_staff">All Staff</option>
                                        <option value="individuals">Specific Individuals</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3" id="individualStaffSelection" style="display: none;">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-user-check me-2"></i>Search & Select Individual Staff
                                </label>
                                <div class="input-group mb-2">
                                    <span class="input-group-text bg-primary text-white"><i
                                            class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="staffSearchBox"
                                        placeholder="Type to search by name, role, or department..." autocomplete="off">
                                </div>
                                <div class="alert alert-info py-2 px-3 mb-2" style="font-size: 13px;">
                                    <i class="fas fa-lightbulb me-2"></i><strong>Tip:</strong> Start typing to search,
                                    then click on staff members to select them for this message
                                </div>
                                <div class="border rounded p-3 mt-2"
                                    style="max-height: 250px; overflow-y: auto; overflow-x: hidden;"
                                    id="staffSelectionContainer">
                                    <div class="text-muted text-center py-3">
                                        <i class="fas fa-users fa-2x mb-2" style="opacity: 0.3;"></i>
                                        <p class="mb-0">Start typing to search for staff members</p>
                                        <small>Staff members will appear here as you type</small>
                                    </div>
                                </div>
                                <div class="mt-3 p-3 bg-light rounded">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <small class="text-muted fw-semibold">
                                            <i class="fas fa-check-circle me-1 text-success"></i>Selected Staff: <span
                                                id="selectedStaffCount" class="badge bg-success">0</span>
                                        </small>
                                        <button type="button" class="btn btn-sm btn-outline-danger" id="clearAllStaff"
                                            style="display: none;">
                                            <i class="fas fa-times me-1"></i>Clear All
                                        </button>
                                    </div>
                                    <div id="selectedStaffList" class="mt-2"></div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Target Channels *</label>
                                <div class="row">
                                    <div class="col-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="channels"
                                                value="email" id="channelEmail">
                                            <label class="form-check-label" for="channelEmail">
                                                <i class="fas fa-envelope me-1 text-primary"></i>Email
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="channels" value="sms"
                                                id="channelSMS">
                                            <label class="form-check-label" for="channelSMS">
                                                <i class="fas fa-sms me-1 text-success"></i>SMS
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="channels"
                                                value="whatsapp" id="channelWhatsApp">
                                            <label class="form-check-label" for="channelWhatsApp">
                                                <i class="fab fa-whatsapp me-1 text-success"></i>WhatsApp
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-check form-switch mb-3" id="immediateSendToggleWrapper">
                                <input class="form-check-input" type="checkbox" role="switch"
                                    id="sendImmediatelyToggle">
                                <label class="form-check-label fw-semibold" for="sendImmediatelyToggle">
                                    Send Immediately (hide schedule fields)
                                </label>
                                <div class="form-text">
                                    Turn off to configure a trigger date, time, and repeat schedule.
                                </div>
                            </div>

                            <div class="mb-3" id="staffTriggerSchedule">
                                <label class="form-label fw-semibold">Trigger Schedule *</label>
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label small">Date</label>
                                        <input type="date" class="form-control" name="triggerDate">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Time</label>
                                        <input type="time" class="form-control" name="triggerTime">
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3" id="staffRepeatSchedule">
                                <label class="form-label">Repeat Schedule</label>
                                <select class="form-select" name="repeatSchedule">
                                    <option value="">Do not repeat</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="yearly">Yearly</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Message Subject</label>
                                <input type="text" class="form-control" name="messageSubject"
                                    placeholder="Message subject line">
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Message Content *</label>
                                <textarea class="form-control" name="messageContent" rows="8" required placeholder="Your message content here...

    Available variables:
    {name} - Staff member's name
    {role} - Staff member's role
    {email} - Staff member's email
    {phone} - Staff member's phone"></textarea>
                                <div class="form-text">
                                    Use variables like {name}, {role} for personalization
                                </div>
                            </div>

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" name="saveAsTemplate"
                                    id="saveAsTemplate" checked>
                                <label class="form-check-label" for="saveAsTemplate">
                                    Save as reusable template
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Preview Section -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="border rounded p-3 bg-light">
                                <h6><i class="fas fa-eye me-2"></i>Message Preview</h6>
                                <div id="staffMessagePreview" class="bg-white p-3 border rounded"
                                    style="min-height: 100px;">
                                    <p class="text-muted">Message preview will appear here...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-primary" onclick="previewStaffMessage()">
                        <i class="fas fa-eye me-2"></i>Preview
                    </button>
                    <button type="button" class="btn btn-success" onclick="sendImmediateStaffMessage()">
                        <i class="fas fa-paper-plane me-2"></i>Send Now
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-clock me-2"></i>Schedule Message
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Custom Alert Modal -->
<div class="modal fade" id="customAlertModal" tabindex="-1" style="z-index: 10000;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem; overflow: hidden;">
            <div class="modal-body p-0">
                <div id="customAlertHeader" class="text-center py-4 px-4" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                    <div id="customAlertIcon" class="mb-3">
                        <i class="fas fa-info-circle" style="font-size: 3rem; color: white;"></i>
                    </div>
                </div>
                <div class="p-4 text-center">
                    <h5 id="customAlertTitle" class="mb-3 fw-bold">Notification</h5>
                    <p id="customAlertMessage" class="text-muted mb-4" style="line-height: 1.6;"></p>
                    <button type="button" class="btn btn-primary px-4" id="customAlertOkBtn" data-bs-dismiss="modal">
                        <i class="fas fa-check me-2"></i>OK
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Confirm Modal -->
<div class="modal fade" id="customConfirmModal" tabindex="-1" style="z-index: 10000;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem; overflow: hidden;">
            <div class="modal-body p-0">
                <div id="customConfirmHeader" class="text-center py-4 px-4" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <div id="customConfirmIcon" class="mb-3">
                        <i class="fas fa-question-circle" style="font-size: 3rem; color: white;"></i>
                    </div>
                </div>
                <div class="p-4 text-center">
                    <h5 id="customConfirmTitle" class="mb-3 fw-bold">Confirm Action</h5>
                    <p id="customConfirmMessage" class="text-muted mb-4" style="line-height: 1.6;"></p>
                    <div class="d-flex gap-2 justify-content-center">
                        <button type="button" class="btn btn-secondary px-4" id="customConfirmCancelBtn" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <button type="button" class="btn btn-warning px-4" id="customConfirmOkBtn">
                            <i class="fas fa-check me-2"></i>Confirm
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Prompt Modal -->
<div class="modal fade" id="customPromptModal" tabindex="-1" data-bs-backdrop="static" style="z-index: 9999;">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem; overflow: hidden;">
            <div class="modal-body p-0">
                <div id="customPromptHeader" class="text-center py-4 px-4" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                    <div class="mb-3">
                        <i class="fas fa-edit" style="font-size: 3rem; color: white;"></i>
                    </div>
                </div>
                <div class="p-4">
                    <h5 id="customPromptTitle" class="mb-3 fw-bold text-center">Input Required</h5>
                    <p id="customPromptMessage" class="text-muted mb-3 text-center" style="line-height: 1.6;"></p>
                    <input type="text" class="form-control mb-4" id="customPromptInput" placeholder="Enter value...">
                    <div class="d-flex gap-2 justify-content-center">
                        <button type="button" class="btn btn-secondary px-4" id="customPromptCancelBtn" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <button type="button" class="btn btn-primary px-4" id="customPromptOkBtn">
                            <i class="fas fa-check me-2"></i>OK
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Department & Role Management Modal -->
<div class="modal fade" id="departmentRoleModal">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 1rem;">
            <div class="modal-header"
                style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border-radius: 1rem 1rem 0 0;">
                <h5 class="modal-title d-flex align-items-center">
                    <i class="fas fa-sitemap me-3" style="font-size: 1.5rem;"></i>
                    Manage Departments & Roles
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div id="departmentRoleAlert"></div>

                <ul class="nav nav-tabs mb-4" id="deptRoleTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="departments-tab" data-bs-toggle="tab"
                            data-bs-target="#departments-content" type="button" role="tab" aria-selected="true">
                            <i class="fas fa-building me-2"></i>Departments
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="roles-tab" data-bs-toggle="tab" data-bs-target="#roles-content"
                            type="button" role="tab" aria-selected="false">
                            <i class="fas fa-user-tag me-2"></i>Roles & Positions
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="deptRoleTabContent">
                    <!-- Departments Tab -->
                    <div class="tab-pane fade show active" id="departments-content" role="tabpanel">
                        <div class="row">
                            <div class="col-md-5">
                                <h6 class="fw-semibold mb-3">
                                    <i class="fas fa-plus-circle me-2 text-success"></i>Add New Department
                                </h6>
                                <form id="addDepartmentForm">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Department Name *</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-building"></i></span>
                                            <input type="text" class="form-control" id="departmentName"
                                                placeholder="e.g., Sales, Marketing, Operations" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Description</label>
                                        <textarea class="form-control" id="departmentDesc" rows="3"
                                            placeholder="Optional: Describe this department's responsibilities"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-success w-100" id="addDepartmentBtn">
                                        <span class="btn-text">
                                            <i class="fas fa-plus me-2"></i>Add Department
                                        </span>
                                        <span class="btn-spinner d-none">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Adding...
                                        </span>
                                    </button>
                                </form>
                            </div>

                            <div class="col-md-7">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="fw-semibold mb-0">
                                        <i class="fas fa-list me-2" style="color: #8b5cf6;"></i>Existing Departments
                                    </h6>
                                    <span class="badge bg-secondary" id="modalDepartmentsCount">0</span>
                                </div>
                                <div class="mb-3">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" id="departmentSearchBox" 
                                            placeholder="Search departments..." autocomplete="off">
                                        <button class="btn btn-outline-secondary" type="button" id="clearDeptSearch" style="display: none;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="departmentsList" style="min-height: 350px;">
                                    <div class="text-center py-5 text-muted">
                                        <div class="spinner-border spinner-border-sm mb-2" role="status"></div>
                                        <p class="mb-0">Loading departments...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Roles Tab -->
                    <div class="tab-pane fade" id="roles-content" role="tabpanel">
                        <div class="row">
                            <div class="col-md-5">
                                <h6 class="fw-semibold mb-3">
                                    <i class="fas fa-plus-circle me-2 text-success"></i>Add New Role
                                </h6>
                                <form id="addRoleForm">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Role/Position Name *</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
                                            <input type="text" class="form-control" id="roleName"
                                                placeholder="e.g., Senior Manager, Junior Agent" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Assign to Department *</label>
                                        <select class="form-select" id="roleDepGroup" required>
                                            <option value="">Select Department</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Description</label>
                                        <textarea class="form-control" id="roleDesc" rows="3"
                                            placeholder="Optional: Job description and responsibilities"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-success w-100" id="addRoleBtn">
                                        <span class="btn-text">
                                            <i class="fas fa-plus me-2"></i>Add Role
                                        </span>
                                        <span class="btn-spinner d-none">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Adding...
                                        </span>
                                    </button>
                                </form>
                            </div>

                            <div class="col-md-7">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="fw-semibold mb-0">
                                        <i class="fas fa-list me-2" style="color: #3b82f6;"></i>Existing Roles & Positions
                                    </h6>
                                    <span class="badge bg-secondary" id="modalRolesCount">0</span>
                                </div>
                                <div class="mb-3">
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" id="roleSearchBox" 
                                            placeholder="Search roles/positions..." autocomplete="off">
                                        <button class="btn btn-outline-secondary" type="button" id="clearRoleSearch" style="display: none;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="rolesList" style="min-height: 350px;">
                                    <div class="text-center py-5 text-muted">
                                        <div class="spinner-border spinner-border-sm mb-2" role="status"></div>
                                        <p class="mb-0">Loading roles...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Global variables
    let currentPage = 1;
    let perPage = 25;
    let totalPages = 1;
    let allStaff = [];
    let filteredStaff = [];
    let staffToRemove = null;

    let formerCurrentPage = 1;
    let formerPerPage = 10;
    let formerTotalPages = 1;
    let allFormerStaff = [];

    // Department and Role management
    let allDepartmentsForStaff = [];
    let allRolesForStaff = [];
    let rolesGroupedByDept = {};

    // Utility function to escape HTML special characters
    function escapeHtml(text) {
        if (text == null) return '';
        return String(text)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // Utility function to escape string for use in JavaScript onclick attributes
    function escapeJsString(text) {
        if (text == null) return '';
        return String(text)
            .replace(/\\/g, '\\\\')
            .replace(/'/g, "\\'")
            .replace(/"/g, '\\"')
            .replace(/\n/g, '\\n')
            .replace(/\r/g, '\\r');
    }

    // Initialize on page load
    $(document).ready(function () {
        loadStaffStats();
        loadStaffDirectory();
        loadFormerStaff();
        loadDepartmentsAndRolesForStaff();
        setupEventListeners();
        
        // Initialize department & role modal handler
        $('#departmentRoleModal').on('shown.bs.modal', function () {
            loadDepartments();
            loadRoles();
            populateDepartmentSelect();
        });
        
        // Initialize modal handlers after page loads
        setTimeout(() => {
            setupComposeStaffMessageModal();
            setupAddStaffModal();
        }, 100);
    });

    // ============================================================================
    // CUSTOM ALERT & CONFIRM FUNCTIONS
    // ============================================================================
    
    // Custom alert function
    function showCustomAlert(message, type = 'info', title = '') {
        const modal = new bootstrap.Modal(document.getElementById('customAlertModal'), {
            backdrop: false,
            keyboard: false
        });
        const header = document.getElementById('customAlertHeader');
        const icon = document.getElementById('customAlertIcon').querySelector('i');
        const titleEl = document.getElementById('customAlertTitle');
        const messageEl = document.getElementById('customAlertMessage');
        const okBtn = document.getElementById('customAlertOkBtn');
        
        // Set default title based on type if not provided
        if (!title) {
            title = type === 'success' ? 'Success' : 
                    type === 'error' ? 'Error' : 
                    type === 'warning' ? 'Warning' : 'Notification';
        }
        
        // Configure based on type
        const configs = {
            success: {
                gradient: 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)',
                icon: 'fa-check-circle',
                btnClass: 'btn-success'
            },
            error: {
                gradient: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
                icon: 'fa-exclamation-circle',
                btnClass: 'btn-danger'
            },
            warning: {
                gradient: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
                icon: 'fa-exclamation-triangle',
                btnClass: 'btn-warning'
            },
            info: {
                gradient: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
                icon: 'fa-info-circle',
                btnClass: 'btn-primary'
            }
        };
        
        const config = configs[type] || configs.info;
        
        // Apply styles
        header.style.background = config.gradient;
        icon.className = `fas ${config.icon}`;
        okBtn.className = `btn ${config.btnClass} px-4`;
        
        // Set content
        titleEl.textContent = title;
        messageEl.textContent = message;
        
        // Create custom backdrop manually
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade';
        backdrop.id = 'customAlertBackdrop';
        document.body.appendChild(backdrop);
        // Trigger fade-in animation
        setTimeout(() => backdrop.classList.add('show'), 10);
        
        // Show modal
        modal.show();
        
        // Remove backdrop when modal is hidden
        const modalEl = document.getElementById('customAlertModal');
        modalEl.addEventListener('hidden.bs.modal', function removeBackdrop() {
            const bd = document.getElementById('customAlertBackdrop');
            if (bd) bd.remove();
            modalEl.removeEventListener('hidden.bs.modal', removeBackdrop);
        }, { once: true });
    }
    
    // Custom confirm function
    function showCustomConfirm(message, onConfirm, options = {}) {
        const modal = new bootstrap.Modal(document.getElementById('customConfirmModal'), {
            backdrop: false,
            keyboard: false
        });
        const header = document.getElementById('customConfirmHeader');
        const icon = document.getElementById('customConfirmIcon').querySelector('i');
        const titleEl = document.getElementById('customConfirmTitle');
        const messageEl = document.getElementById('customConfirmMessage');
        const okBtn = document.getElementById('customConfirmOkBtn');
        const cancelBtn = document.getElementById('customConfirmCancelBtn');
        
        // Set title
        titleEl.textContent = options.title || 'Confirm Action';
        messageEl.textContent = message;
        
        // Configure based on type
        const type = options.type || 'warning';
        const configs = {
            warning: {
                gradient: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
                icon: 'fa-question-circle',
                btnClass: 'btn-warning'
            },
            danger: {
                gradient: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
                icon: 'fa-exclamation-triangle',
                btnClass: 'btn-danger'
            },
            info: {
                gradient: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
                icon: 'fa-info-circle',
                btnClass: 'btn-primary'
            }
        };
        
        const config = configs[type] || configs.warning;
        
        // Apply styles
        header.style.background = config.gradient;
        icon.className = `fas ${config.icon}`;
        okBtn.className = `btn ${config.btnClass} px-4`;
        
        // Set button text
        okBtn.innerHTML = `<i class="fas fa-check me-2"></i>${options.confirmText || 'Confirm'}`;
        cancelBtn.innerHTML = `<i class="fas fa-times me-2"></i>${options.cancelText || 'Cancel'}`;
        
        // Remove old event listeners
        const newOkBtn = okBtn.cloneNode(true);
        const newCancelBtn = cancelBtn.cloneNode(true);
        okBtn.parentNode.replaceChild(newOkBtn, okBtn);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        // Add new event listeners
        newOkBtn.addEventListener('click', () => {
            modal.hide();
            if (onConfirm) onConfirm(true);
        });
        
        newCancelBtn.addEventListener('click', () => {
            modal.hide();
            if (onConfirm) onConfirm(false);
        });
        
        // Create custom backdrop manually
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade';
        backdrop.id = 'customConfirmBackdrop';
        document.body.appendChild(backdrop);
        // Trigger fade-in animation
        setTimeout(() => backdrop.classList.add('show'), 10);
        
        // Show modal
        modal.show();
        
        // Remove backdrop when modal is hidden
        const modalEl = document.getElementById('customConfirmModal');
        modalEl.addEventListener('hidden.bs.modal', function removeBackdrop() {
            const bd = document.getElementById('customConfirmBackdrop');
            if (bd) bd.remove();
            modalEl.removeEventListener('hidden.bs.modal', removeBackdrop);
        }, { once: true });
    }
    
    // Custom prompt function
    function showCustomPrompt(message, defaultValue = '', onSubmit, options = {}) {
        const modal = new bootstrap.Modal(document.getElementById('customPromptModal'), {
            backdrop: false,
            keyboard: false
        });
        const titleEl = document.getElementById('customPromptTitle');
        const messageEl = document.getElementById('customPromptMessage');
        const inputEl = document.getElementById('customPromptInput');
        const okBtn = document.getElementById('customPromptOkBtn');
        const cancelBtn = document.getElementById('customPromptCancelBtn');
        
        // Set content
        titleEl.textContent = options.title || 'Input Required';
        messageEl.textContent = message;
        inputEl.value = defaultValue;
        inputEl.placeholder = options.placeholder || 'Enter value...';
        
        // Focus input after modal shows
        document.getElementById('customPromptModal').addEventListener('shown.bs.modal', function () {
            inputEl.focus();
            inputEl.select();
        }, { once: true });
        
        // Remove old event listeners
        const newOkBtn = okBtn.cloneNode(true);
        const newCancelBtn = cancelBtn.cloneNode(true);
        okBtn.parentNode.replaceChild(newOkBtn, okBtn);
        cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
        
        // Add new event listeners
        newOkBtn.addEventListener('click', () => {
            const value = inputEl.value;
            modal.hide();
            // Wait for modal to hide before calling callback
            setTimeout(() => {
                if (onSubmit) onSubmit(value);
            }, 150);
        });
        
        newCancelBtn.addEventListener('click', () => {
            modal.hide();
            // Wait for modal to hide before calling callback
            setTimeout(() => {
                if (onSubmit) onSubmit(null);
            }, 150);
        });
        
        // Handle Enter key
        const enterKeyHandler = function(e) {
            if (e.key === 'Enter') {
                const value = inputEl.value;
                modal.hide();
                // Wait for modal to hide before calling callback
                setTimeout(() => {
                    if (onSubmit) onSubmit(value);
                }, 150);
                // Remove this specific listener
                inputEl.removeEventListener('keypress', enterKeyHandler);
            }
        };
        inputEl.addEventListener('keypress', enterKeyHandler);
        
        // Create custom backdrop manually with unique ID
        const backdropId = 'customPromptBackdrop_' + Date.now();
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade';
        backdrop.id = backdropId;
        document.body.appendChild(backdrop);
        // Trigger fade-in animation
        setTimeout(() => backdrop.classList.add('show'), 10);
        
        // Show modal
        modal.show();
        
        // Remove backdrop when modal is hidden
        const modalEl = document.getElementById('customPromptModal');
        const removeBackdrop = function() {
            const bd = document.getElementById(backdropId);
            if (bd) bd.remove();
            modalEl.removeEventListener('hidden.bs.modal', removeBackdrop);
        };
        modalEl.addEventListener('hidden.bs.modal', removeBackdrop, { once: true });
        
        // Auto-focus input after modal is shown
        modalEl.addEventListener('shown.bs.modal', function focusInput() {
            inputEl.focus();
            inputEl.select();
        }, { once: true });
    }

    // Load staff statistics
    function loadStaffStats() {
        $.ajax({
            url: '{% url "adminSupport:api_staff_stats" %}',
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    $('#totalStaffCount').text(response.data.total || 0);
                    $('#activeStaffCount').text(response.data.active || 0);
                    $('#formerStaffCount').text(response.data.former || 0);
                    $('#departmentsCount').text(response.data.departments || 0);
                }
            },
            error: function () {
                console.error('Failed to load staff statistics');
            }
        });
    }

    // Load staff directory
    function loadStaffDirectory() {
        $.ajax({
            url: '{% url "adminSupport:api_staff_list" %}',
            method: 'GET',
            success: function (response) {
                allStaff = response.results || [];
                filteredStaff = [...allStaff];
                populateFilterDropdowns();
                renderStaffTable();
            },
            error: function () {
                showEmptyState('activeStaffTableBody', 'Failed to load staff data');
            }
        });
    }

    // Load former staff
    function loadFormerStaff() {
        $.ajax({
            url: '{% url "adminSupport:api_staff_former" %}',
            method: 'GET',
            success: function (response) {
                allFormerStaff = response.results || [];
                renderFormerStaffTable();
            },
            error: function () {
                showEmptyState('formerStaffTableBody', 'Failed to load former staff data');
            }
        });
    }

    // Render staff table
    function renderStaffTable() {
        const tbody = $('#activeStaffTableBody');

        if (filteredStaff.length === 0) {
            showEmptyState('activeStaffTableBody', 'No staff members match your search');
            return;
        }

        const start = (currentPage - 1) * perPage;
        const end = Math.min(start + perPage, filteredStaff.length);
        const pageData = filteredStaff.slice(start, end);

        let html = '';
        pageData.forEach(staff => {
            const staffName = escapeHtml(staff.name || 'N/A');
            const staffNameJs = escapeJsString(staff.name || '');
            const staffEmail = escapeHtml(staff.email || 'N/A');
            const staffEmailJs = escapeJsString(staff.email || '');
            const avatar = staff.profile_picture || staff.avatar || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(staff.name || 'User') + '&background=2563eb&color=fff';
            html += `
                    <tr>
                        <td>
                            <div class="staff-info">
                                <img src="${avatar}" alt="${staffName}" class="staff-avatar">
                                <div class="staff-details">
                                    <h4>${staffName}</h4>
                                    <p>${staffEmail}</p>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge-custom badge-role">${escapeHtml(staff.role_name || staff.role || 'N/A')}</span>
                        </td>
                        <td>${escapeHtml(staff.department_name || staff.department || 'N/A')}</td>
                        <td>${escapeHtml(staff.phone || 'N/A')}</td>
                        <td>
                            <span class="badge-custom badge-active">
                                <i class="fas fa-circle"></i> Active
                            </span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn edit" onclick="editStaff(${staff.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn message" onclick="messageStaff(${staff.id}, '${staffNameJs}', '${staffEmailJs}')" title="Send Message">
                                    <i class="fas fa-envelope"></i>
                                </button>
                                <button class="action-btn delete" onclick="removeStaff(${staff.id}, '${staffNameJs}')" title="Remove">
                                    <i class="fas fa-user-times"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
        });

        tbody.html(html);
        updatePaginationInfo(start + 1, end, filteredStaff.length);
        renderPagination();
    }

    // Render former staff table
    function renderFormerStaffTable() {
        const tbody = $('#formerStaffTableBody');

        if (allFormerStaff.length === 0) {
            showEmptyState('formerStaffTableBody', 'No former staff members');
            return;
        }

        const start = (formerCurrentPage - 1) * formerPerPage;
        const end = Math.min(start + formerPerPage, allFormerStaff.length);
        const pageData = allFormerStaff.slice(start, end);

        let html = '';
        pageData.forEach(staff => {
            const avatar = staff.profile_picture || staff.avatar || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(staff.name || 'User') + '&background=64748b&color=fff';
            html += `
                    <tr>
                        <td>
                            <div class="staff-info">
                                <img src="${avatar}" alt="${staff.name}" class="staff-avatar">
                                <div class="staff-details">
                                    <h4>${staff.name || 'N/A'}</h4>
                                    <p>${staff.email || 'N/A'}</p>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge-custom badge-role">${staff.role_name || staff.role || 'N/A'}</span>
                        </td>
                        <td>${staff.department_name || staff.department || 'N/A'}</td>
                        <td>${staff.removed_date || 'N/A'}</td>
                        <td>
                            <button class="action-btn reactivate" onclick="reactivateStaff(${staff.id})" title="Reactivate">
                                <i class="fas fa-undo"></i>
                            </button>
                        </td>
                    </tr>
                `;
        });

        tbody.html(html);
        updateFormerPaginationInfo(start + 1, end, allFormerStaff.length);
        renderFormerPagination();
    }

    // Render pagination controls
    function renderPagination() {
        totalPages = Math.ceil(filteredStaff.length / perPage);
        const controls = $('#paginationControls');
        let html = '';

        // Previous button
        html += `<button class="pagination-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-left"></i>
            </button>`;

        // Page numbers
        const maxButtons = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxButtons - 1);

        if (endPage - startPage < maxButtons - 1) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
        }

        // Next button
        html += `<button class="pagination-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                <i class="fas fa-chevron-right"></i>
            </button>`;

        controls.html(html);
    }

    // Render former staff pagination
    function renderFormerPagination() {
        formerTotalPages = Math.ceil(allFormerStaff.length / formerPerPage);
        const controls = $('#formerPaginationControls');
        let html = '';

        html += `<button class="pagination-btn" onclick="changeFormerPage(${formerCurrentPage - 1})" ${formerCurrentPage === 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-left"></i>
            </button>`;

        const maxButtons = 5;
        let startPage = Math.max(1, formerCurrentPage - Math.floor(maxButtons / 2));
        let endPage = Math.min(formerTotalPages, startPage + maxButtons - 1);

        if (endPage - startPage < maxButtons - 1) {
            startPage = Math.max(1, endPage - maxButtons + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            html += `<button class="pagination-btn ${i === formerCurrentPage ? 'active' : ''}" onclick="changeFormerPage(${i})">${i}</button>`;
        }

        html += `<button class="pagination-btn" onclick="changeFormerPage(${formerCurrentPage + 1})" ${formerCurrentPage === formerTotalPages ? 'disabled' : ''}>
                <i class="fas fa-chevron-right"></i>
            </button>`;

        controls.html(html);
    }

    // Change page
    function changePage(page) {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        renderStaffTable();
    }

    // Change former staff page
    function changeFormerPage(page) {
        if (page < 1 || page > formerTotalPages) return;
        formerCurrentPage = page;
        renderFormerStaffTable();
    }

    // Update pagination info
    function updatePaginationInfo(from, to, total) {
        $('#showingFrom').text(from);
        $('#showingTo').text(to);
        $('#totalRecords').text(total);
    }

    // Update former pagination info
    function updateFormerPaginationInfo(from, to, total) {
        $('#formerShowingFrom').text(from);
        $('#formerShowingTo').text(to);
        $('#formerTotalRecords').text(total);
    }

    // Show empty state
    function showEmptyState(tbodyId, message) {
        const tbody = $('#' + tbodyId);
        tbody.html(`
                <tr>
                    <td colspan="6">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>${message}</h3>
                            <p>No records to display</p>
                        </div>
                    </td>
                </tr>
            `);
    }

    // Setup event listeners
    function setupEventListeners() {
        // Search functionality
        $('#searchInput').on('input', function () {
            applyFilters();
        });

        // Role filter
        $('#roleFilter').on('change', function () {
            applyFilters();
        });

        // Department filter
        $('#departmentFilter').on('change', function () {
            applyFilters();
        });

        // Per page change
        $('#perPageSelect').on('change', function () {
            perPage = parseInt($(this).val());
            currentPage = 1;
            renderStaffTable();
        });

        // Former staff per page change
        $('#formerPerPageSelect').on('change', function () {
            formerPerPage = parseInt($(this).val());
            formerCurrentPage = 1;
            renderFormerStaffTable();
        });

        // Add staff form submission
        $('#addStaffForm').on('submit', function (e) {
            e.preventDefault();
            handleAddStaff();
        });
        
        $('#submitAddStaff').on('click', function (e) {
            e.preventDefault();
            handleAddStaff();
        });

        // Import staff form submission
        $('#submitImportStaff').on('click', function () {
            handleImportStaff();
        });
        
        // Download template button
        $('#downloadTemplateBtn').on('click', function () {
            downloadTemplate();
        });
        
        // Setup drag and drop
        setupDragAndDrop();

        // Note: Remove staff form submission is now handled by the form's submit event
        // in the REMOVE STAFF FUNCTIONALITY section

        // Edit staff form submission
        $('#submitEditStaff').on('click', function () {
            handleEditStaff();
        });

        // Message staff form submission
        $('#submitMessageStaff').on('click', function () {
            handleMessageStaff();
        });

        // Bulk message staff form submission
        $('#submitBulkMessageStaff').on('click', function () {
            handleBulkMessageStaff();
        });
    }

    // ============================================================================
    // DEPARTMENT & ROLE LOADING FOR ADD STAFF MODAL
    // ============================================================================

    // Load departments and roles for staff modal
    function loadDepartmentsAndRolesForStaff() {
        $.ajax({
            url: '{% url "adminSupport:api_departments_list" %}',
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    allDepartmentsForStaff = response.departments || [];
                    populateDepartmentDropdown();
                }
            }
        });

        $.ajax({
            url: '{% url "adminSupport:api_roles_list" %}',
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    allRolesForStaff = response.roles || [];
                    groupRolesByDepartment();
                }
            }
        });
    }

    // Populate department dropdown in Add Staff Modal
    function populateDepartmentDropdown() {
        const deptSelect = $('#staffDepartment');
        deptSelect.html('<option value="">Select Department</option>');

        if (allDepartmentsForStaff.length === 0) {
            $('#noDeptRoleWarning').show();
            // Disable all form fields in Add Staff Modal
            $('#staffName, #staffEmail, #staffPhone, #staffWhatsapp, #staffAddress, #staffEmploymentDate, #staffDOB, #staffDepartment, #staffRole').prop('disabled', true);
            // Disable submit button
            $('#submitAddStaff').prop('disabled', true);
        } else {
            $('#noDeptRoleWarning').hide();
            // Enable all form fields
            $('#staffName, #staffEmail, #staffPhone, #staffWhatsapp, #staffAddress, #staffEmploymentDate, #staffDOB, #staffDepartment').prop('disabled', false);
            // Enable submit button
            $('#submitAddStaff').prop('disabled', false);
            allDepartmentsForStaff.forEach(dept => {
                deptSelect.append(`<option value="${dept.id}">${dept.name}</option>`);
            });
        }
    }

    // Group roles by department
    function groupRolesByDepartment() {
        rolesGroupedByDept = {};
        allRolesForStaff.forEach(role => {
            if (!rolesGroupedByDept[role.department_id]) {
                rolesGroupedByDept[role.department_id] = [];
            }
            rolesGroupedByDept[role.department_id].push(role);
        });
    }

    // Update role dropdown when department is selected
    function updateRolesDropdown() {
        const deptId = $('#staffDepartment').val();
        const roleSelect = $('#staffRole');

        roleSelect.html('<option value="">Select Role/Position</option>');

        if (!deptId) {
            roleSelect.html('<option value="">Select a Department First</option>');
            roleSelect.prop('disabled', true);
            return;
        }

        const roles = rolesGroupedByDept[deptId] || [];

        if (roles.length === 0) {
            roleSelect.html('<option value="">No roles available for this department</option>');
            roleSelect.prop('disabled', true);
        } else {
            roleSelect.prop('disabled', false);
            roles.forEach(role => {
                roleSelect.append(`<option value="${role.id}">${role.name}</option>`);
            });
        }
    }

    // Setup Add Staff Modal handlers
    function setupAddStaffModal() {
        // Department change event
        $('#staffDepartment').on('change', function () {
            updateRolesDropdown();
        });

        // Modal show event - Add Staff
        $('#addStaffModal').on('shown.bs.modal', function () {
            populateDepartmentDropdown();
            updateRolesDropdown();
        });
        
        // Modal show event - Import Staff
        $('#importStaffModal').on('shown.bs.modal', function () {
            checkDepartmentsForImport();
        });
    }
    
    // Check if departments exist when opening Import modal
    function checkDepartmentsForImport() {
        if (allDepartmentsForStaff.length === 0) {
            $('#noDeptRoleWarningImport').show();
            $('#staffFile').prop('disabled', true);
            $('#submitImportStaff').prop('disabled', true);
        } else {
            $('#noDeptRoleWarningImport').hide();
            $('#staffFile').prop('disabled', false);
            $('#submitImportStaff').prop('disabled', false);
        }
    }

    // Populate filter dropdowns dynamically from API
    function populateFilterDropdowns() {
        // Fetch departments from API
        $.ajax({
            url: '{% url "adminSupport:api_departments_list" %}',
            method: 'GET',
            success: function(response) {
                const departments = response.departments || response.results || response.data || [];
                const deptFilter = $('#departmentFilter');
                const currentDeptValue = deptFilter.val();
                
                let deptHtml = '<option value="">All Departments</option>';
                if (departments.length > 0) {
                    departments.sort((a, b) => a.name.localeCompare(b.name)).forEach(dept => {
                        deptHtml += `<option value="${dept.id}">${dept.name}</option>`;
                    });
                }
                deptFilter.html(deptHtml);
                if (currentDeptValue) {
                    deptFilter.val(currentDeptValue);
                }
            }
        });
        
        // Fetch all roles from API
        $.ajax({
            url: '{% url "adminSupport:api_roles_list" %}',
            method: 'GET',
            success: function(response) {
                const roles = response.roles || response.results || response.data || [];
                const roleFilter = $('#roleFilter');
                const currentRoleValue = roleFilter.val();
                
                let roleHtml = '<option value="">All Roles</option>';
                if (roles.length > 0) {
                    roles.sort((a, b) => a.name.localeCompare(b.name)).forEach(role => {
                        roleHtml += `<option value="${role.id}">${role.name}</option>`;
                    });
                }
                roleFilter.html(roleHtml);
                if (currentRoleValue) {
                    roleFilter.val(currentRoleValue);
                }
            }
        });
    }

    // Apply filters
    function applyFilters() {
        const searchTerm = $('#searchInput').val().toLowerCase();
        const roleFilter = $('#roleFilter').val();
        const departmentFilter = $('#departmentFilter').val();

        filteredStaff = allStaff.filter(staff => {
            const matchesSearch = !searchTerm ||
                (staff.name && staff.name.toLowerCase().includes(searchTerm)) ||
                (staff.email && staff.email.toLowerCase().includes(searchTerm)) ||
                (staff.department_name && staff.department_name.toLowerCase().includes(searchTerm)) ||
                (staff.role_name && staff.role_name.toLowerCase().includes(searchTerm));

            const matchesRole = !roleFilter || staff.role_id === roleFilter;
            const matchesDepartment = !departmentFilter || staff.department_id === departmentFilter;

            return matchesSearch && matchesRole && matchesDepartment;
        });

        currentPage = 1;
        renderStaffTable();
    }

    // ============================================================================
    // PROFILE PICTURE HANDLING
    // ============================================================================

    // Handle add staff profile picture preview
    $('#staffProfilePicture').on('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showAlert('addStaffAlert', 'error', 'Image size must be less than 5MB');
                $(this).val('');
                return;
            }

            // Validate file type
            if (!file.type.match('image.*')) {
                showAlert('addStaffAlert', 'error', 'Please select a valid image file');
                $(this).val('');
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                $('#addStaffProfilePreview').html(`<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`);
                $('#removeAddStaffPhoto').show();
            };
            reader.readAsDataURL(file);
        }
    });

    // Remove add staff profile picture
    function removeAddStaffProfilePicture() {
        $('#staffProfilePicture').val('');
        $('#addStaffProfilePreview').html('<i class="fas fa-camera" style="font-size: 32px; color: #adb5bd;"></i>');
        $('#removeAddStaffPhoto').hide();
    }

    // Handle edit staff profile picture preview
    $('#editStaffProfilePicture').on('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showAlert('editStaffAlert', 'error', 'Image size must be less than 5MB');
                $(this).val('');
                return;
            }

            // Validate file type
            if (!file.type.match('image.*')) {
                showAlert('editStaffAlert', 'error', 'Please select a valid image file');
                $(this).val('');
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                $('#editStaffProfilePreview').html(`<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`);
                $('#removeEditStaffPhoto').show();
            };
            reader.readAsDataURL(file);
        }
    });

    // Remove edit staff profile picture
    function removeEditStaffProfilePicture() {
        $('#editStaffProfilePicture').val('');
        const currentStaffId = $('#editStaffModal').data('staff-id');
        // Restore original or default avatar
        const staff = allStaff.find(s => s.id === currentStaffId);
        const avatar = staff && staff.profile_picture ? staff.profile_picture : 'https://ui-avatars.com/api/?name=' + encodeURIComponent(staff ? staff.name : 'User') + '&background=2563eb&color=fff';
        $('#editStaffProfilePreview').html(`<img src="${avatar}" style="width: 100%; height: 100%; object-fit: cover;">`);
        $('#removeEditStaffPhoto').hide();
    }

    // ============================================================================
    // ADD STAFF FUNCTIONALITY
    // ============================================================================

    // Handle add staff
    function handleAddStaff() {
        const fullName = $('#staffName').val() || '';
        const email = $('#staffEmail').val() || '';
        const phone = $('#staffPhone').val() || '';
        const address = $('#staffAddress').val() || '';
        const employmentDate = $('#staffEmploymentDate').val() || '';
        const dateOfBirth = $('#staffDOB').val() || '';
        const departmentId = $('#staffDepartment').val() || '';
        const roleId = $('#staffRole').val() || '';

        // Validate all required fields
        if (!fullName || !email || !phone || !address || !employmentDate || !dateOfBirth || !departmentId || !roleId) {
            showAlert('addStaffAlert', 'error', 'Please fill in all required fields');
            return;
        }

        // Create FormData for file upload support
        const formData = new FormData();
        formData.append('full_name', fullName);
        formData.append('email', email);
        formData.append('phone', phone);
        formData.append('whatsapp', $('#staffWhatsapp').val() || '');
        formData.append('address', address);
        formData.append('employment_date', employmentDate);
        formData.append('date_of_birth', dateOfBirth);
        formData.append('department_id', departmentId);
        formData.append('role_id', roleId);

        // Add profile picture if selected
        const profilePicture = $('#staffProfilePicture')[0].files[0];
        if (profilePicture) {
            formData.append('profile_picture', profilePicture);
        }

        const btn = $('#submitAddStaff');
        btn.html('<span class="loading-spinner"></span> Adding...').prop('disabled', true);

        $.ajax({
            url: '{% url "adminSupport:api_staff_create" %}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function (response) {
                if (response.ok) {
                    showAlert('addStaffAlert', 'success', 'Staff member added successfully!');
                    $('#addStaffForm')[0].reset();
                    removeAddStaffProfilePicture(); // Reset profile picture preview
                    setTimeout(() => {
                        $('#addStaffModal').modal('hide');
                        // Remove any lingering backdrops
                        $('.modal-backdrop').remove();
                        $('body').removeClass('modal-open');
                        $('body').css('overflow', '');
                        $('body').css('padding-right', '');
                        loadStaffStats();
                        loadStaffDirectory();
                    }, 1500);
                } else {
                    showAlert('addStaffAlert', 'error', response.error || 'Failed to add staff member');
                }
            },
            error: function (xhr) {
                const errorMsg = xhr.responseJSON?.error || 'An error occurred. Please try again.';
                showAlert('addStaffAlert', 'error', errorMsg);
            },
            complete: function () {
                btn.html('<i class="fas fa-check"></i> Add Staff').prop('disabled', false);
            }
        });
    }

    // Setup drag and drop for file upload
    function setupDragAndDrop() {
        const dropZone = $('#dropZone');
        const fileInput = $('#staffFile');
        const fileInfo = $('#fileInfo');
        const fileName = $('#fileName');
        const fileSize = $('#fileSize');
        
        // Click to browse
        dropZone.on('click', function(e) {
            if (!$(e.target).closest('#removeFileBtn').length) {
                fileInput.click();
            }
        });
        
        // File input change
        fileInput.on('change', function() {
            const file = this.files[0];
            if (file) {
                displayFileInfo(file);
            }
        });
        
        // Remove file button
        $('#removeFileBtn').on('click', function(e) {
            e.stopPropagation();
            fileInput.val('');
            fileInfo.hide();
            $('#dropZoneContent').show();
        });
        
        // Drag events
        dropZone.on('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).css({
                'border-color': '#3b82f6',
                'background': '#eff6ff'
            });
        });
        
        dropZone.on('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).css({
                'border-color': '#cbd5e1',
                'background': '#f8fafc'
            });
        });
        
        dropZone.on('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            $(this).css({
                'border-color': '#cbd5e1',
                'background': '#f8fafc'
            });
            
            const files = e.originalEvent.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                // Validate file type
                const validTypes = ['.csv', '.xlsx', '.xls'];
                const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
                
                if (validTypes.includes(fileExtension)) {
                    fileInput[0].files = files;
                    displayFileInfo(file);
                } else {
                    showAlert('importStaffAlert', 'error', 'Please upload a valid CSV or Excel file');
                }
            }
        });
        
        function displayFileInfo(file) {
            const fileSizeKB = (file.size / 1024).toFixed(2);
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            const sizeDisplay = file.size > 1024 * 1024 ? `${fileSizeMB} MB` : `${fileSizeKB} KB`;
            
            fileName.text(file.name);
            fileSize.text(`(${sizeDisplay})`);
            $('#dropZoneContent').hide();
            fileInfo.show();
        }
    }
    
    // Download Excel template
    function downloadTemplate() {
        const btn = $('#downloadTemplateBtn');
        btn.html('<span class="spinner-border spinner-border-sm me-2"></span>Downloading...').prop('disabled', true);
        
        window.location.href = '{% url "adminSupport:api_staff_template_download" %}';
        
        setTimeout(() => {
            btn.html('<i class="fas fa-download me-2"></i>Download Template').prop('disabled', false);
        }, 2000);
    }

    // Handle import staff
    function handleImportStaff() {
        const fileInput = $('#staffFile')[0];
        if (!fileInput.files.length) {
            showAlert('importStaffAlert', 'error', 'Please select a file to upload');
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        const btn = $('#submitImportStaff');
        btn.html('<span class="loading-spinner"></span> Importing...').prop('disabled', true);

        $.ajax({
            url: '{% url "adminSupport:api_staff_import" %}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function (response) {
                if (response.success) {
                    showAlert('importStaffAlert', 'success', `Successfully imported ${response.imported || 0} staff members!`);
                    $('#importStaffForm')[0].reset();
                    setTimeout(() => {
                        $('#importStaffModal').modal('hide');
                        loadStaffStats();
                        loadStaffDirectory();
                    }, 2000);
                } else {
                    showAlert('importStaffAlert', 'error', response.message || 'Failed to import staff');
                }
            },
            error: function () {
                showAlert('importStaffAlert', 'error', 'An error occurred during import');
            },
            complete: function () {
                btn.html('<i class="fas fa-upload"></i> Import Staff').prop('disabled', false);
                // Reset file info display
                $('#fileInfo').hide();
                $('#dropZoneContent').show();
            }
        });
    }

    // Edit staff
    async function editStaff(staffId) {
        const staff = allStaff.find(s => s.id === staffId);
        if (!staff) {
            showAlert('mainAlert', 'error', 'Staff member not found');
            return;
        }

        // Store staff ID in modal for later use
        $('#editStaffModal').data('staff-id', staffId);

        // Populate ALL form fields
        $('#editStaffId').val(staff.id);
        $('#editStaffName').val(staff.full_name || staff.name || '');
        $('#editStaffEmail').val(staff.email || '');
        $('#editStaffPhone').val(staff.phone || '');
        $('#editStaffWhatsapp').val(staff.whatsapp || '');
        $('#editStaffAddress').val(staff.address || '');
        $('#editStaffEmploymentDate').val(staff.employment_date || '');
        $('#editStaffDOB').val(staff.date_of_birth || '');

        // Set profile picture preview
        const avatar = staff.profile_picture || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(staff.full_name || staff.name || 'User') + '&background=2563eb&color=fff';
        $('#editStaffProfilePreview').html(`<img src="${avatar}" style="width: 100%; height: 100%; object-fit: cover;">`);
        if (staff.profile_picture) {
            $('#removeEditStaffPhoto').show();
        } else {
            $('#removeEditStaffPhoto').hide();
        }

        // Load departments and roles for edit modal with selected values
        await loadDepartmentsForEdit(staff.department_id, staff.role_id);

        $('#editStaffModal').modal('show');
    }
    
    // Load departments for edit modal
    async function loadDepartmentsForEdit(selectedDeptId, selectedRoleId) {
        try {
            const response = await $.ajax({
                url: '{% url "adminSupport:api_departments_list" %}',
                method: 'GET'
            });
            
            const select = $('#editStaffDepartment');
            select.empty().append('<option value="">Select Department</option>');
            
            // Get departments from response (handle different response formats)
            const departments = response.departments || response.results || response.data || [];
            
            if (departments.length > 0) {
                departments.forEach(dept => {
                    select.append(`<option value="${dept.id}">${dept.name}</option>`);
                });
                
                // Explicitly set the selected value after all options are added
                if (selectedDeptId) {
                    select.val(String(selectedDeptId));
                }
            }
            
            // If department is selected, load its roles
            if (selectedDeptId) {
                await loadRolesForEdit(selectedDeptId, selectedRoleId);
            } else {
                $('#editStaffRole').empty().append('<option value="">Select a Department First</option>');
            }
        } catch (error) {
            // Silent fail - user will see empty dropdowns
        }
    }
    
    // Load roles for edit modal based on department
    async function loadRolesForEdit(departmentId, selectedRoleId) {
        if (!departmentId) {
            $('#editStaffRole').empty().append('<option value="">Select a Department First</option>');
            return;
        }
        
        try {
            const response = await $.ajax({
                url: '{% url "adminSupport:api_roles_list" %}',
                method: 'GET',
                data: { department_id: departmentId }
            });
            
            const select = $('#editStaffRole');
            select.empty().append('<option value="">Select Role</option>');
            
            // Get roles from response (handle different response formats)
            const roles = response.roles || response.results || response.data || [];
            
            if (roles.length > 0) {
                roles.forEach(role => {
                    select.append(`<option value="${role.id}">${role.name}</option>`);
                });
                
                // Explicitly set the selected value after all options are added
                if (selectedRoleId) {
                    select.val(String(selectedRoleId));
                }
            }
        } catch (error) {
            // Silent fail - user will see empty dropdown
        }
    }
    
    // Handle department change in edit modal
    $('#editStaffDepartment').on('change', async function() {
        const departmentId = $(this).val();
        if (departmentId) {
            await loadRolesForEdit(departmentId, null);
        } else {
            $('#editStaffRole').empty().append('<option value="">Select a Department First</option>');
        }
    });

    // Handle edit staff
    function handleEditStaff() {
        const staffId = $('#editStaffId').val();
        const formData = {
            full_name: $('#editStaffName').val(),
            email: $('#editStaffEmail').val(),
            phone: $('#editStaffPhone').val(),
            department_id: $('#editStaffDepartment').val(),
            role_id: $('#editStaffRole').val()
        };

        // Validate required fields
        if (!formData.full_name || !formData.email) {
            showAlert('editStaffAlert', 'error', 'Please fill in all required fields');
            return;
        }

        const btn = $('#submitEditStaff');
        btn.html('<span class="loading-spinner"></span> Saving...').prop('disabled', true);

        $.ajax({
            url: `/api/staff/${staffId}/update/`,
            method: 'POST',
            data: JSON.stringify(formData),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function (response) {
                if (response.success) {
                    showAlert('editStaffAlert', 'success', 'Staff member updated successfully!');
                    setTimeout(() => {
                        $('#editStaffModal').modal('hide');
                        loadStaffDirectory();
                    }, 1500);
                } else {
                    showAlert('editStaffAlert', 'error', response.message || 'Failed to update staff member');
                }
            },
            error: function (xhr) {
                const errorMsg = xhr.responseJSON?.message || 'An error occurred. Please try again.';
                showAlert('editStaffAlert', 'error', errorMsg);
            },
            complete: function () {
                btn.html('<i class="fas fa-save"></i> Save Changes').prop('disabled', false);
            }
        });
    }

    // Message staff
    function messageStaff(staffId, staffName, staffEmail) {
            $('#messageStaffId').val(staffId);
            $('#messageRecipientName').text(staffName);
            $('#messageRecipientEmail').text(staffEmail);
            $('#messageStaffForm')[0].reset();
            $('#messageStaffAlert').html('');
            $('#messageStaffModal').modal('show');
        }

        // Handle message staff
        function handleMessageStaff() {
                const staffId = $('#messageStaffId').val();
                const formData = {
                    staff_id: staffId,
                    subject: $('#messageSubject').val(),
                    message: $('#messageContent').val(),
                    priority: $('#messagePriority').val()
                };

                if (!formData.subject || !formData.message) {
                    showAlert('messageStaffAlert', 'error', 'Please fill in all required fields');
                    return;
                }

                const btn = $('#submitMessageStaff');
                btn.html('<span class="loading-spinner"></span> Sending...').prop('disabled', true);

                $.ajax({
                    url: '{% url "adminSupport:api_messages_save" %}',
                    method: 'POST',
                    data: {
                        recipient_type: 'staff',
                        recipient_id: formData.staff_id,
                        subject: formData.subject,
                        message: formData.message,
                        priority: formData.priority,
                        status: 'sent'
                    },
                    headers: {
                        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                    },
                    success: function (response) {
                        if (response.success) {
                            showAlert('messageStaffAlert', 'success', 'Message sent successfully!');
                            $('#messageStaffForm')[0].reset();
                            setTimeout(() => {
                                $('#messageStaffModal').modal('hide');
                            }, 1500);
                        } else {
                            showAlert('messageStaffAlert', 'error', response.message || 'Failed to send message');
                        }
                    },
                    error: function () {
                        showAlert('messageStaffAlert', 'error', 'An error occurred. Please try again.');
                    },
                    complete: function () {
                        btn.html('<i class="fas fa-paper-plane"></i> Send Message').prop('disabled', false);
                    }
                });
            }

        // Handle bulk message staff (Auto Message Template)
        let selectedStaffMembers = [];
        let staffListLoaded = false;

        // Setup compose staff message modal functionality
        function setupComposeStaffMessageModal() {
            // Remove any existing handlers to prevent duplicates
            $('#composeStaffMessageModal').off('shown.bs.modal');
            $('#audienceType').off('change');
            $('#sendImmediatelyToggle').off('change');
            $('#staffSearchBox').off('input');
            $('#clearAllStaff').off('click');
            $('#composeStaffMessageForm').off('submit');

            // Reset modal when opened
            $('#composeStaffMessageModal').on('shown.bs.modal', function () {
                // Reset form and selections
                $('#composeStaffMessageForm')[0].reset();
                selectedStaffMembers = [];
                staffListLoaded = false;
                updateSelectedStaffDisplay();
                $('#individualStaffSelection').hide();
                $('#staffSelectionContainer').html(`
                    <div class="text-muted text-center py-3">
                        <i class="fas fa-users fa-2x mb-2" style="opacity: 0.3;"></i>
                        <p class="mb-0">Start typing to search for staff members</p>
                        <small>Staff members will appear here as you type</small>
                    </div>
                `);
            });

            // Audience type selection toggle
            $('#audienceType').on('change', function () {
                const audienceType = $(this).val();
                if (audienceType === 'individuals') {
                    $('#individualStaffSelection').slideDown(300);
                    
                    // Load staff list immediately if not already loaded
                    if (!staffListLoaded) {
                        loadStaffForSelection();
                        staffListLoaded = true;
                    }
                    
                    // Auto-focus on search box after animation
                    setTimeout(() => {
                        $('#staffSearchBox').focus();
                    }, 350);
                } else {
                    $('#individualStaffSelection').slideUp(300);
                    selectedStaffMembers = [];
                    staffListLoaded = false;
                    updateSelectedStaffDisplay();
                }
            });

            // Send immediately toggle
            $('#sendImmediatelyToggle').on('change', function () {
                if ($(this).is(':checked')) {
                    $('#staffTriggerSchedule').slideUp();
                    $('#staffRepeatSchedule').slideUp();
                } else {
                    $('#staffTriggerSchedule').slideDown();
                    $('#staffRepeatSchedule').slideDown();
                }
            });

            // Staff search functionality with real-time filtering
            $('#staffSearchBox').on('input', function () {
                const searchTerm = $(this).val().toLowerCase().trim();

                // Ensure staff list is loaded
                if (!staffListLoaded) {
                    loadStaffForSelection();
                    staffListLoaded = true;
                }

                // Filter based on search term
                if (searchTerm.length > 0) {
                    filterStaffForSelection(searchTerm);
                } else {
                    // Show all staff when search is cleared
                    $('.staff-select-item').show();
                    $('.no-results-msg').remove();
                }
            });

            // Clear all selected staff
            $('#clearAllStaff').on('click', function (e) {
                e.preventDefault();
                showCustomConfirm('Clear all selected staff members?', (confirmed) => {
                    if (confirmed) {
                        selectedStaffMembers = [];
                        updateSelectedStaffDisplay();
                        // Uncheck all checkboxes and remove selected class
                        $('#staffSelectionContainer input[type="checkbox"]').prop('checked', false);
                        $('.staff-select-item').removeClass('selected');
                    }
                }, { title: 'Clear Selection', confirmText: 'Clear', type: 'warning' });
            });

            // Form submission
            $('#composeStaffMessageForm').on('submit', function (e) {
                e.preventDefault();
                scheduleStaffMessage();
            });
        }

        // Load staff for selection
        function loadStaffForSelection() {
            const container = $('#staffSelectionContainer');

            if (allStaff.length === 0) {
                container.html('<div class="text-muted text-center py-3"><i class="fas fa-exclamation-triangle me-2 text-warning"></i><p class="mb-0">No staff members available</p><small>Please add staff members first</small></div>');
                return;
            }

            let html = '';
            allStaff.forEach(staff => {
                const isSelected = selectedStaffMembers.includes(staff.id);
                const escapedName = (staff.name || '').replace(/'/g, "\\'");
                const selectedClass = isSelected ? 'selected' : '';
                html += `
                    <div class="form-check staff-select-item ${selectedClass} p-2 mb-2 rounded" 
                         style="border: 1px solid #dee2e6; transition: all 0.2s; cursor: pointer;" 
                         data-staff-id="${staff.id}" 
                         data-staff-name="${staff.name || ''}" 
                         data-staff-role="${staff.role || ''}" 
                         data-staff-dept="${staff.department || ''}">
                        <input class="form-check-input" type="checkbox" value="${staff.id}" 
                               id="staffCheck${staff.id}" ${isSelected ? 'checked' : ''} 
                               onchange="toggleStaffSelection(${staff.id}, '${escapedName}')">
                        <label class="form-check-label w-100 cursor-pointer" for="staffCheck${staff.id}" 
                               style="cursor: pointer;">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <div class="fw-semibold text-dark">${staff.name || 'N/A'}</div>
                                    <small class="text-muted">
                                        <i class="fas fa-briefcase me-1"></i>${staff.role || 'N/A'} ‚Ä¢ 
                                        <i class="fas fa-building ms-2 me-1"></i>${staff.department || 'N/A'}
                                    </small>
                                </div>
                                <div class="ms-2">
                                    <i class="fas fa-check-circle text-success" style="display: ${isSelected ? 'block' : 'none'}"></i>
                                </div>
                            </div>
                        </label>
                    </div>
                `;
            });
            container.html(html);

            // Use event delegation for dynamically created elements
            container.off('click', '.staff-select-item').on('click', '.staff-select-item', function (e) {
                if (e.target.type !== 'checkbox' && !$(e.target).is('input')) {
                    const checkbox = $(this).find('input[type="checkbox"]');
                    checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
                }
            });
        }

        // Filter staff for selection
        function filterStaffForSelection(searchTerm) {
            let visibleCount = 0;
            $('.staff-select-item').each(function () {
                const staffName = ($(this).data('staff-name') || '').toLowerCase();
                const staffRole = ($(this).data('staff-role') || '').toLowerCase();
                const staffDept = ($(this).data('staff-dept') || '').toLowerCase();

                if (staffName.includes(searchTerm) || staffRole.includes(searchTerm) || staffDept.includes(searchTerm)) {
                    $(this).show();
                    visibleCount++;
                } else {
                    $(this).hide();
                }
            });

            // Show "no results" message if no matches
            if (visibleCount === 0) {
                $('#staffSelectionContainer').append(`
                    <div class="text-center py-3 text-muted no-results-msg">
                        <i class="fas fa-search fa-2x mb-2" style="opacity: 0.3;"></i>
                        <p class="mb-0">No staff members found</p>
                        <small>Try a different search term</small>
                    </div>
                `);
            } else {
                $('.no-results-msg').remove();
            }
        }

        // Toggle staff selection
        function toggleStaffSelection(staffId, staffName) {
            const index = selectedStaffMembers.indexOf(staffId);
            const staffItem = $(`.staff-select-item[data-staff-id="${staffId}"]`);
            const checkIcon = staffItem.find('.fa-check-circle');

            if (index > -1) {
                // Deselect
                selectedStaffMembers.splice(index, 1);
                staffItem.removeClass('selected');
                staffItem.css({'background-color': '', 'border-color': '#dee2e6'});
                $(`#staffCheck${staffId}`).prop('checked', false);
                checkIcon.hide();
            } else {
                // Select
                selectedStaffMembers.push(staffId);
                staffItem.addClass('selected');
                staffItem.css({'background-color': '#e8f5e9', 'border-color': '#4caf50'});
                $(`#staffCheck${staffId}`).prop('checked', true);
                checkIcon.show();
            }
            updateSelectedStaffDisplay();
        }

        // Update selected staff display
        function updateSelectedStaffDisplay() {
            const count = selectedStaffMembers.length;
            $('#selectedStaffCount').text(count);
            const listContainer = $('#selectedStaffList');

            // Show/hide clear all button
            if (count > 0) {
                $('#clearAllStaff').show();
            } else {
                $('#clearAllStaff').hide();
            }

            if (count === 0) {
                listContainer.html('<p class="text-muted text-center mb-0 small"><i class="fas fa-info-circle me-1"></i>No staff selected yet</p>');
                return;
            }

            let html = '';
            selectedStaffMembers.forEach(staffId => {
                const staff = allStaff.find(s => s.id === staffId);
                if (staff) {
                    const escapedName = (staff.name || '').replace(/'/g, "\\'");
                    html += `
                        <span class="selected-staff-badge">
                            <i class="fas fa-user-check me-2"></i>${staff.name}
                            <span class="remove-staff" onclick="event.stopPropagation(); toggleStaffSelection(${staffId}, '${escapedName}');">
                                <i class="fas fa-times"></i>
                            </span>
                        </span>
                    `;
                }
            });
            listContainer.html(html);
        }

        // Preview staff message
        function previewStaffMessage() {
            const templateName = $('input[name="templateName"]').val();
            const messageContent = $('textarea[name="messageContent"]').val();
            const messageSubject = $('input[name="messageSubject"]').val();
            const audienceType = $('#audienceType').val();

            if (!messageContent) {
                showCustomAlert('Please enter message content to preview', 'warning');
                return;
            }

            let audienceText = 'All Staff';
            if (audienceType === 'individuals') {
                audienceText = `${selectedStaffMembers.length} selected staff member(s)`;
            }

            // Replace variables with sample data
            let previewContent = messageContent
                .replace(/{name}/g, '<strong>[Staff Name]</strong>')
                .replace(/{role}/g, '<strong>[Staff Role]</strong>')
                .replace(/{email}/g, '<strong>[Staff Email]</strong>')
                .replace(/{phone}/g, '<strong>[Staff Phone]</strong>');

            const previewHtml = `
                <div class="mb-2"><strong>Template:</strong> ${templateName || 'Untitled'}</div>
                ${messageSubject ? `<div class="mb-2"><strong>Subject:</strong> ${messageSubject}</div>` : ''}
                <div class="mb-2"><strong>Audience:</strong> ${audienceText}</div>
                <hr>
                <div style="white-space: pre-wrap;">${previewContent}</div>
            `;

            $('#staffMessagePreview').html(previewHtml);
        }

        // Send immediate staff message
        function sendImmediateStaffMessage() {
            const formData = getStaffMessageFormData();

            if (!validateStaffMessageForm(formData)) {
                return;
            }

            showCustomConfirm('Send this message immediately to the selected audience?', (confirmed) => {
                if (!confirmed) return;
                
                sendMessageNow();
            }, { title: 'Send Message', confirmText: 'Send Now', type: 'info' });
        }

        function sendMessageNow() {

            // Prepare data for API
            const apiData = {
                recipient_type: formData.audienceType === 'all_staff' ? 'staff_all' : 'staff_selected',
                subject: formData.messageSubject,
                message: formData.messageContent,
                priority: 'normal',
                status: 'sent',
                channels: formData.channels
            };

            if (formData.audienceType === 'individuals') {
                apiData.recipient_ids = JSON.stringify(selectedStaffMembers);
            }

            $.ajax({
                url: '{% url "adminSupport:api_messages_save" %}',
                method: 'POST',
                data: apiData,
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showCustomAlert('Message sent successfully!', 'success');
                        $('#composeStaffMessageModal').modal('hide');
                        $('#composeStaffMessageForm')[0].reset();
                        selectedStaffMembers = [];
                        updateSelectedStaffDisplay();
                    } else {
                        showCustomAlert('Failed to send message: ' + (response.message || 'Unknown error'), 'error');
                    }
                },
                error: function () {
                    showCustomAlert('An error occurred while sending the message. Please try again.', 'error');
                }
            });
        }

        // Schedule staff message
        function scheduleStaffMessage() {
            const formData = getStaffMessageFormData();

            if (!validateStaffMessageForm(formData)) {
                return;
            }

            // Check if schedule is required
            if (!$('#sendImmediatelyToggle').is(':checked')) {
                if (!formData.triggerDate || !formData.triggerTime) {
                    showCustomAlert('Please set trigger date and time for scheduled messages', 'warning');
                    return;
                }
            }

            const apiData = {
                recipient_type: formData.audienceType === 'all_staff' ? 'staff_all' : 'staff_selected',
                subject: formData.messageSubject,
                message: formData.messageContent,
                priority: 'normal',
                status: 'scheduled',
                channels: formData.channels,
                template_name: formData.templateName,
                trigger_date: formData.triggerDate,
                trigger_time: formData.triggerTime,
                repeat_schedule: formData.repeatSchedule,
                save_as_template: formData.saveAsTemplate
            };

            if (formData.audienceType === 'individuals') {
                apiData.recipient_ids = JSON.stringify(selectedStaffMembers);
            }

            $.ajax({
                url: '{% url "adminSupport:api_messages_save" %}',
                method: 'POST',
                data: apiData,
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showCustomAlert('Message scheduled successfully!', 'success');
                        $('#composeStaffMessageModal').modal('hide');
                        $('#composeStaffMessageForm')[0].reset();
                        selectedStaffMembers = [];
                        updateSelectedStaffDisplay();
                    } else {
                        showCustomAlert('Failed to schedule message: ' + (response.message || 'Unknown error'), 'error');
                    }
                },
                error: function () {
                    showCustomAlert('An error occurred while scheduling the message. Please try again.', 'error');
                }
            });
        }

        // Get staff message form data
        function getStaffMessageFormData() {
            const channels = [];
            $('input[name="channels"]:checked').each(function () {
                channels.push($(this).val());
            });

            return {
                templateName: $('input[name="templateName"]').val(),
                audienceType: $('#audienceType').val(),
                messageSubject: $('input[name="messageSubject"]').val(),
                messageContent: $('textarea[name="messageContent"]').val(),
                channels: channels.join(','),
                triggerDate: $('input[name="triggerDate"]').val(),
                triggerTime: $('input[name="triggerTime"]').val(),
                repeatSchedule: $('select[name="repeatSchedule"]').val(),
                saveAsTemplate: $('#saveAsTemplate').is(':checked')
            };
        }

        // Validate staff message form
        function validateStaffMessageForm(formData) {
            if (!formData.templateName) {
                showCustomAlert('Please enter a template name', 'warning');
                return false;
            }

            if (!formData.audienceType) {
                showCustomAlert('Please select an audience', 'warning');
                return false;
            }

            if (formData.audienceType === 'individuals' && selectedStaffMembers.length === 0) {
                showCustomAlert('Please select at least one staff member from the search list', 'warning');
                $('#staffSearchBox').focus();
                return false;
            }

            if (!formData.messageContent) {
                showCustomAlert('Please enter message content', 'warning');
                return false;
            }

            if (formData.channels.length === 0) {
                showCustomAlert('Please select at least one communication channel', 'warning');
                return false;
            }

            return true;
        }

        // ============================================================================
        // EDIT STAFF FUNCTIONALITY - Event Handlers
        // ============================================================================

        // Handle edit staff submission
        $('#submitEditStaff').on('click', function () {
            handleEditStaff();
        });

        function handleEditStaff() {
            const staffId = $('#editStaffModal').data('staff-id');
            if (!staffId) {
                showAlert('editStaffAlert', 'error', 'No staff member selected');
                return;
            }

            const fullName = $('#editStaffName').val() || '';
            const email = $('#editStaffEmail').val() || '';
            const phone = $('#editStaffPhone').val() || '';
            const address = $('#editStaffAddress').val() || '';
            const employmentDate = $('#editStaffEmploymentDate').val() || '';
            const dateOfBirth = $('#editStaffDOB').val() || '';
            const departmentId = $('#editStaffDepartment').val() || '';
            const roleId = $('#editStaffRole').val() || '';

            // Validate all required fields
            if (!fullName || !email || !phone || !address || !employmentDate || !dateOfBirth || !departmentId || !roleId) {
                showAlert('editStaffAlert', 'error', 'Please fill in all required fields');
                return;
            }

            // Create FormData for file upload support
            const formData = new FormData();
            formData.append('full_name', fullName);
            formData.append('email', email);
            formData.append('phone', phone);
            formData.append('whatsapp', $('#editStaffWhatsapp').val() || '');
            formData.append('address', address);
            formData.append('employment_date', employmentDate);
            formData.append('date_of_birth', dateOfBirth);
            formData.append('department_id', departmentId);
            formData.append('role_id', roleId);

            // Add profile picture if selected
            const profilePicture = $('#editStaffProfilePicture')[0].files[0];
            if (profilePicture) {
                formData.append('profile_picture', profilePicture);
            }

            const btn = $('#submitEditStaff');
            btn.html('<span class="loading-spinner"></span> Updating...').prop('disabled', true);

            $.ajax({
                url: '{% url "adminSupport:api_staff_update" staff_id=0 %}'.replace('0', staffId),
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response.ok) {
                        showAlert('editStaffAlert', 'success', 'Staff member updated successfully!');
                        setTimeout(() => {
                            $('#editStaffModal').modal('hide');
                            $('.modal-backdrop').remove();
                            $('body').removeClass('modal-open');
                            $('body').css('overflow', '');
                            $('body').css('padding-right', '');
                            loadStaffStats();
                            loadStaffDirectory();
                        }, 1500);
                    } else {
                        showAlert('editStaffAlert', 'error', response.error || 'Failed to update staff member');
                    }
                },
                error: function (xhr) {
                    const errorMsg = xhr.responseJSON?.error || 'An error occurred while updating staff member';
                    showAlert('editStaffAlert', 'error', errorMsg);
                },
                complete: function () {
                    btn.html('<i class="fas fa-save me-2"></i>Update Staff Member').prop('disabled', false);
                }
            });
        }

        // ============================================================================
        // REMOVE STAFF FUNCTIONALITY
        // ============================================================================

        // Remove staff - opens modal with reasons
        function removeStaff(staffId, staffName) {
            staffToRemove = staffId;
            $('#removeStaffId').val(staffId);
            $('#removeStaffName').text(staffName);
            
            // Reset form
            $('input[name="removalReason"]').prop('checked', false);
            $('textarea[name="removalNotes"]').val('');
            $('#removeStaffAlert').html('');
            
            // Show modal
            $('#removeStaffModal').modal('show');
        }

        // Handle remove staff form submission
        $('#removeStaffForm').on('submit', function(e) {
            e.preventDefault();
            
            const staffId = $('#removeStaffId').val();
            const staffName = $('#removeStaffName').text();
            const checkedReasons = $('input[name="removalReason"]:checked').map(function() {
                return $(this).val();
            }).get();
            const notes = $('textarea[name="removalNotes"]').val();
            
            if (checkedReasons.length === 0) {
                showAlert('removeStaffAlert', 'error', 'Please select at least one reason for removal.');
                return;
            }
            
            // Show loading state
            const btn = $('#confirmRemoveStaff');
            const originalText = btn.html();
            btn.html('<span class="loading-spinner"></span> Removing...').prop('disabled', true);
            
            $.ajax({
                url: '{% url "adminSupport:api_staff_remove" %}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ 
                    user_id: staffId, 
                    reasons: checkedReasons, 
                    notes: notes 
                }),
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.success || response.ok) {
                        $('#removeStaffModal').modal('hide');
                        showCustomAlert(`${staffName} has been removed from active staff and moved to former staff.`, 'success');
                        loadStaffStats();
                        loadStaffDirectory();
                        loadFormerStaff();
                    } else {
                        showAlert('removeStaffAlert', 'error', response.message || response.error || 'Failed to remove staff member');
                    }
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON?.error || xhr.responseJSON?.message || 'An error occurred. Please try again.';
                    showAlert('removeStaffAlert', 'error', errorMsg);
                },
                complete: function() {
                    btn.html(originalText).prop('disabled', false);
                    staffToRemove = null;
                }
            });
        });

        // Legacy confirm remove staff function (kept for backwards compatibility)
        function confirmRemoveStaff(staffId) {
            // Trigger form submission instead
            $('#removeStaffForm').submit();
        }

        // Reactivate staff
        function reactivateStaff(staffId) {
            showCustomConfirm('Are you sure you want to reactivate this staff member?', (confirmed) => {
                if (!confirmed) return;
                
                reactivateStaffConfirmed(staffId);
            }, { title: 'Reactivate Staff', confirmText: 'Reactivate', type: 'info' });
        }

        function reactivateStaffConfirmed(staffId) {

            $.ajax({
                url: '{% url "adminSupport:api_staff_reactivate" %}',
                method: 'POST',
                data: { staff_id: staffId },
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response.success) {
                        loadStaffStats();
                        loadStaffDirectory();
                        loadFormerStaff();
                    } else {
                        showCustomAlert(response.message || 'Failed to reactivate staff member', 'error');
                    }
                },
                error: function () {
                    showCustomAlert('An error occurred. Please try again.', 'error');
                }
            });
        }

        // Show alert
        function showAlert(containerId, type, message) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            const html = `
                <div class="alert-custom ${alertClass}">
                    <i class="fas ${icon}"></i>
                    <div>${message}</div>
                </div>
            `;
            $('#' + containerId).html(html);

            setTimeout(() => {
                $('#' + containerId).html('');
            }, 5000);
        }

        // ============================================================================
        // DEPARTMENT & ROLE MANAGEMENT FUNCTIONS
        // ============================================================================

        let allDepartments = [];
        let allRoles = [];
        let departmentsPage = 1;
        let rolesPage = 1;
        const itemsPerPage = 5;

        // ============================================================================
        // DEPARTMENT FUNCTIONS
        // ============================================================================

        // Load all departments
        function loadDepartments() {
            $.ajax({
                url: '{% url "adminSupport:api_departments_list" %}',
                method: 'GET',
                success: function (response) {
                    if (response.success) {
                        allDepartments = response.departments || [];
                        departmentsPage = 1;
                        renderDepartmentsList();
                        populateDepartmentSelect(); // Update dropdown in real-time
                    } else {
                        $('#departmentsList').html('<div class="alert alert-warning">Failed to load departments</div>');
                    }
                },
                error: function (xhr, status, error) {
                    $('#departmentsList').html('<div class="alert alert-danger">Error loading departments</div>');
                }
            });
        }

        // Render departments list with pagination
        function renderDepartmentsList() {
            const container = $('#departmentsList');
            
            // Filter departments based on search term
            let filteredDepartments = allDepartments;
            if (departmentSearchTerm) {
                filteredDepartments = allDepartments.filter(dept => 
                    dept.name.toLowerCase().includes(departmentSearchTerm) ||
                    (dept.description && dept.description.toLowerCase().includes(departmentSearchTerm))
                );
            }
            
            // Update count badge
            $('#modalDepartmentsCount').text(filteredDepartments.length);

            if (filteredDepartments.length === 0) {
                container.html(`
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-building fa-2x mb-2" style="opacity: 0.3;"></i>
                        <p class="mb-0">${departmentSearchTerm ? 'No matching departments found' : 'No departments created yet'}</p>
                        <small>${departmentSearchTerm ? 'Try a different search term' : 'Add your first department using the form on the left'}</small>
                    </div>
                `);
                return;
            }

            const totalPages = Math.ceil(filteredDepartments.length / itemsPerPage);
            const startIndex = (departmentsPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedDepts = filteredDepartments.slice(startIndex, endIndex);

            let html = '';
            paginatedDepts.forEach((dept, index) => {
                const rowNumber = startIndex + index + 1;
                html += `
                    <div class="card mb-2" style="border-left: 4px solid #8b5cf6; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 fw-semibold d-flex align-items-center">
                                        <span class="badge bg-secondary me-2" style="font-size: 0.75rem; min-width: 24px;">${rowNumber}</span>
                                        <i class="fas fa-building me-2" style="color: #8b5cf6;"></i>${dept.name}
                                        <span class="badge bg-info ms-2" style="font-size: 0.7rem;">${dept.roles_count || 0} roles</span>
                                    </h6>
                                    ${dept.description ? `<small class="text-muted d-block mt-1">${dept.description}</small>` : ''}
                                    ${dept.staff_count ? `<small class="text-muted d-block"><i class="fas fa-users me-1"></i>${dept.staff_count} staff</small>` : ''}
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editDepartment('${dept.id}'); return false;" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteDepartment('${dept.id}'); return false;" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            // Add pagination if needed
            if (totalPages > 1) {
                html += `
                    <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top">
                        <small class="text-muted">Showing ${startIndex + 1}-${Math.min(endIndex, filteredDepartments.length)} of ${filteredDepartments.length}</small>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="changeDepartmentsPage(${departmentsPage - 1})" ${departmentsPage === 1 ? 'disabled' : ''}>
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="btn btn-outline-secondary disabled">${departmentsPage} / ${totalPages}</button>
                            <button class="btn btn-outline-secondary" onclick="changeDepartmentsPage(${departmentsPage + 1})" ${departmentsPage === totalPages ? 'disabled' : ''}>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            container.html(html);
        }

        function changeDepartmentsPage(page) {
            departmentsPage = page;
            renderDepartmentsList();
        }

        // Search departments
        let departmentSearchTerm = '';
        $('#departmentSearchBox').on('input', function() {
            departmentSearchTerm = $(this).val().toLowerCase();
            const clearBtn = $('#clearDeptSearch');
            
            if (departmentSearchTerm) {
                clearBtn.show();
            } else {
                clearBtn.hide();
            }
            
            departmentsPage = 1; // Reset to first page on search
            renderDepartmentsList();
        });

        $('#clearDeptSearch').on('click', function() {
            $('#departmentSearchBox').val('');
            departmentSearchTerm = '';
            $(this).hide();
            departmentsPage = 1;
            renderDepartmentsList();
        });

        // Add department
        $('#addDepartmentForm').on('submit', function (e) {
            e.preventDefault();

            const deptName = $('#departmentName').val().trim();
            const deptDesc = $('#departmentDesc').val().trim();

            if (!deptName) {
                showAlert('departmentRoleAlert', 'error', 'Please enter a department name');
                return;
            }

            // Show spinner
            const btn = $('#addDepartmentBtn');
            btn.prop('disabled', true);
            btn.find('.btn-text').addClass('d-none');
            btn.find('.btn-spinner').removeClass('d-none');

            $.ajax({
                url: '{% url "adminSupport:api_department_create" %}',
                method: 'POST',
                data: {
                    name: deptName,
                    description: deptDesc
                },
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showAlert('departmentRoleAlert', 'success', 'Department created successfully!');
                        $('#addDepartmentForm')[0].reset();
                        loadDepartments(); // This now also updates the dropdown
                        loadDepartmentsAndRolesForStaff(); // Update Add Staff modal dropdowns
                    } else {
                        showAlert('departmentRoleAlert', 'error', response.message || 'Failed to create department');
                    }
                },
                error: function () {
                    showAlert('departmentRoleAlert', 'error', 'An error occurred. Please try again.');
                },
                complete: function () {
                    // Hide spinner
                    const btn = $('#addDepartmentBtn');
                    btn.prop('disabled', false);
                    btn.find('.btn-text').removeClass('d-none');
                    btn.find('.btn-spinner').addClass('d-none');
                }
            });
        });

        // Edit department
        function editDepartment(deptId) {
            const dept = allDepartments.find(d => d.id === deptId);
            if (!dept) return;

            showCustomPrompt('Enter the new department name:', dept.name, (newName) => {
                if (newName === null) return;
                
                if (!newName.trim()) {
                    showCustomAlert('Department name cannot be empty', 'warning');
                    return;
                }
                
                // Add delay to allow first modal to fully close before opening second
                setTimeout(() => {
                    showCustomPrompt('Edit department description (leave blank to keep current):', dept.description || '', (newDesc) => {
                        if (newDesc === null) return; // User cancelled
                        updateDepartmentData(deptId, newName.trim(), newDesc);
                    }, { title: 'Edit Description', placeholder: 'Optional description...' });
                }, 350);
            }, { title: 'Edit Department Name', placeholder: 'Department name...' });
        }
        
        function updateDepartmentData(deptId, newName, newDesc) {
            $.ajax({
                url: `{% url "adminSupport:api_department_update" %}?id=${deptId}`,
                method: 'POST',
                data: {
                    name: newName,
                    description: newDesc
                },
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showCustomAlert('Department updated successfully!', 'success');
                        loadDepartments(); // This now also updates the dropdown
                        loadDepartmentsAndRolesForStaff(); // Update Add Staff modal dropdowns
                        loadStaffDirectory(); // Reload staff to show updated department name
                    } else {
                        showCustomAlert(response.message || 'Failed to update department', 'error');
                    }
                },
                error: function () {
                    showCustomAlert('An error occurred. Please try again.', 'error');
                }
            });
        }

        // Delete department
        function deleteDepartment(deptId) {
            const dept = allDepartments.find(d => d.id === deptId);
            if (!dept) return;

            const message = `Are you sure you want to delete "${dept.name}" department?${dept.staff_count ? ' This department has ' + dept.staff_count + ' staff members.' : ''}`;
            showCustomConfirm(message, (confirmed) => {
                if (!confirmed) return;
                
                deleteDepartmentConfirmed(deptId);
            }, { title: 'Delete Department', confirmText: 'Delete', type: 'danger' });
        }

        function deleteDepartmentConfirmed(deptId) {

            $.ajax({
                url: `{% url "adminSupport:api_department_delete" %}?id=${deptId}`,
                method: 'POST',
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showCustomAlert('Department deleted successfully!', 'success');
                        loadDepartments(); // This now also updates the dropdown
                        loadRoles(); // Reload roles since they depend on departments
                        loadDepartmentsAndRolesForStaff(); // Update Add Staff modal dropdowns
                        loadStaffDirectory(); // Reload staff to update filters
                    } else {
                        showCustomAlert(response.message || 'Failed to delete department', 'error');
                    }
                },
                error: function () {
                    showAlert('departmentRoleAlert', 'error', 'An error occurred. Please try again.');
                }
            });
        }

        // ============================================================================
        // ROLE FUNCTIONS
        // ============================================================================

        // Load all roles
        function loadRoles() {
            $.ajax({
                url: '{% url "adminSupport:api_roles_list" %}',
                method: 'GET',
                success: function (response) {
                    if (response.success) {
                        allRoles = response.roles || [];
                        rolesPage = 1;
                        renderRolesList();
                    } else {
                        $('#rolesList').html('<div class="alert alert-warning">Failed to load roles</div>');
                    }
                },
                error: function () {
                    $('#rolesList').html('<div class="alert alert-danger">Error loading roles</div>');
                }
            });
        }

        // Render roles list with pagination
        function renderRolesList() {
            const container = $('#rolesList');
            
            // Filter roles based on search term
            let filteredRoles = allRoles;
            if (roleSearchTerm) {
                filteredRoles = allRoles.filter(role => {
                    const dept = allDepartments.find(d => d.id === role.department_id);
                    return role.name.toLowerCase().includes(roleSearchTerm) ||
                           (role.description && role.description.toLowerCase().includes(roleSearchTerm)) ||
                           (dept && dept.name.toLowerCase().includes(roleSearchTerm));
                });
            }
            
            // Update count badge
            $('#modalRolesCount').text(filteredRoles.length);

            if (filteredRoles.length === 0) {
                container.html(`
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-user-tag fa-2x mb-2" style="opacity: 0.3;"></i>
                        <p class="mb-0">${roleSearchTerm ? 'No matching roles found' : 'No roles created yet'}</p>
                        <small>${roleSearchTerm ? 'Try a different search term' : 'Add your first role using the form on the left'}</small>
                    </div>
                `);
                return;
            }

            const totalPages = Math.ceil(filteredRoles.length / itemsPerPage);
            const startIndex = (rolesPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedRoles = filteredRoles.slice(startIndex, endIndex);

            let html = '';
            paginatedRoles.forEach((role, index) => {
                const rowNumber = startIndex + index + 1;
                const dept = allDepartments.find(d => d.id === role.department_id);
                html += `
                    <div class="card mb-2" style="border-left: 4px solid #3b82f6; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 fw-semibold d-flex align-items-center">
                                        <span class="badge bg-secondary me-2" style="font-size: 0.75rem; min-width: 24px;">${rowNumber}</span>
                                        <i class="fas fa-user-tag me-2" style="color: #3b82f6;"></i>${role.name}
                                    </h6>
                                    <small class="text-muted d-block mt-1">
                                        <i class="fas fa-building me-1"></i>${dept ? dept.name : 'Unknown Department'}
                                    </small>
                                    ${role.description ? `<small class="text-muted d-block">${role.description}</small>` : ''}
                                    ${role.staff_count ? `<small class="text-muted d-block"><i class="fas fa-users me-1"></i>${role.staff_count} staff</small>` : ''}
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editRole('${role.id}'); return false;" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteRole('${role.id}'); return false;" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            // Add pagination if needed
            if (totalPages > 1) {
                html += `
                    <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top">
                        <small class="text-muted">Showing ${startIndex + 1}-${Math.min(endIndex, filteredRoles.length)} of ${filteredRoles.length}</small>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="changeRolesPage(${rolesPage - 1})" ${rolesPage === 1 ? 'disabled' : ''}>
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="btn btn-outline-secondary disabled">${rolesPage} / ${totalPages}</button>
                            <button class="btn btn-outline-secondary" onclick="changeRolesPage(${rolesPage + 1})" ${rolesPage === totalPages ? 'disabled' : ''}>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            container.html(html);
        }

        function changeRolesPage(page) {
            rolesPage = page;
            renderRolesList();
        }

        // Search roles
        let roleSearchTerm = '';
        $('#roleSearchBox').on('input', function() {
            roleSearchTerm = $(this).val().toLowerCase();
            const clearBtn = $('#clearRoleSearch');
            
            if (roleSearchTerm) {
                clearBtn.show();
            } else {
                clearBtn.hide();
            }
            
            rolesPage = 1; // Reset to first page on search
            renderRolesList();
        });

        $('#clearRoleSearch').on('click', function() {
            $('#roleSearchBox').val('');
            roleSearchTerm = '';
            $(this).hide();
            rolesPage = 1;
            renderRolesList();
        });

        // Populate department select for role creation
        function populateDepartmentSelect() {
            const select = $('#roleDepGroup');
            select.html('<option value="">Select Department</option>');
            allDepartments.forEach(dept => {
                select.append(`<option value="${dept.id}">${dept.name}</option>`);
            });
        }

        // Add role
        $('#addRoleForm').on('submit', function (e) {
            e.preventDefault();

            const roleName = $('#roleName').val().trim();
            const deptId = $('#roleDepGroup').val();
            const roleDesc = $('#roleDesc').val().trim();

            if (!roleName) {
                showAlert('departmentRoleAlert', 'error', 'Please enter a role name');
                return;
            }

            if (!deptId) {
                showAlert('departmentRoleAlert', 'error', 'Please select a department');
                return;
            }

            // Show spinner
            const btn = $('#addRoleBtn');
            btn.prop('disabled', true);
            btn.find('.btn-text').addClass('d-none');
            btn.find('.btn-spinner').removeClass('d-none');

            $.ajax({
                url: '{% url "adminSupport:api_role_create" %}',
                method: 'POST',
                data: {
                    name: roleName,
                    department_id: deptId,
                    description: roleDesc
                },
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showAlert('departmentRoleAlert', 'success', 'Role created successfully!');
                        $('#addRoleForm')[0].reset();
                        loadRoles();
                        loadDepartmentsAndRolesForStaff(); // Update Add Staff modal dropdowns
                    } else {
                        showAlert('departmentRoleAlert', 'error', response.message || 'Failed to create role');
                    }
                },
                error: function () {
                    showAlert('departmentRoleAlert', 'error', 'An error occurred. Please try again.');
                },
                complete: function () {
                    // Hide spinner
                    const btn = $('#addRoleBtn');
                    btn.prop('disabled', false);
                    btn.find('.btn-text').removeClass('d-none');
                    btn.find('.btn-spinner').addClass('d-none');
                }
            });
        });

        // Edit role
        function editRole(roleId) {
            const role = allRoles.find(r => r.id === roleId);
            if (!role) return;

            showCustomPrompt('Enter the new role name:', role.name, (newName) => {
                if (newName === null) return;
                
                if (!newName.trim()) {
                    showCustomAlert('Role name cannot be empty', 'warning');
                    return;
                }
                
                // Add delay to allow first modal to fully close before opening second
                setTimeout(() => {
                    showCustomPrompt('Edit role description (leave blank to keep current):', role.description || '', (newDesc) => {
                        if (newDesc === null) return; // User cancelled
                        updateRoleData(roleId, newName.trim(), newDesc);
                    }, { title: 'Edit Description', placeholder: 'Optional description...' });
                }, 350);
            }, { title: 'Edit Role Name', placeholder: 'Role name...' });
        }
        
        function updateRoleData(roleId, newName, newDesc) {
            $.ajax({
                url: `{% url "adminSupport:api_role_update" %}?id=${roleId}`,
                method: 'POST',
                data: {
                    name: newName,
                    description: newDesc
                },
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showCustomAlert('Role updated successfully!', 'success');
                        loadRoles();
                        loadDepartmentsAndRolesForStaff(); // Update Add Staff modal dropdowns
                        loadStaffDirectory(); // Reload staff to show updated role name
                    } else {
                        showCustomAlert(response.message || 'Failed to update role', 'error');
                    }
                },
                error: function () {
                    showCustomAlert('An error occurred. Please try again.', 'error');
                }
            });
        }

        // Delete role
        function deleteRole(roleId) {
            const role = allRoles.find(r => r.id === roleId);
            if (!role) return;

            const message = `Are you sure you want to delete "${role.name}" role?${role.staff_count ? ' This role has ' + role.staff_count + ' staff members.' : ''}`;
            showCustomConfirm(message, (confirmed) => {
                if (!confirmed) return;
                
                deleteRoleConfirmed(roleId);
            }, { title: 'Delete Role', confirmText: 'Delete', type: 'danger' });
        }

        function deleteRoleConfirmed(roleId) {

            $.ajax({
                url: `{% url "adminSupport:api_role_delete" %}?id=${roleId}`,
                method: 'POST',
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showCustomAlert('Role deleted successfully!', 'success');
                        loadRoles();
                        loadDepartmentsAndRolesForStaff(); // Update Add Staff modal dropdowns
                        loadStaffDirectory(); // Reload staff to update filters
                    } else {
                        showCustomAlert(response.message || 'Failed to delete role', 'error');
                    }
                },
                error: function () {
                    showAlert('departmentRoleAlert', 'error', 'An error occurred. Please try again.');
                }
            });
        }

        // === DEBUG HELPER FUNCTION ===
        // Call from console: testMessageModal()
        window.testMessageModal = function () {
            console.log('=== Testing Message Modal ===');
            console.log('All staff count:', allStaff.length);
            console.log('Selected staff:', selectedStaffMembers);
            console.log('Staff list loaded:', staffListLoaded);
            console.log('Opening modal...');
            $('#composeStaffMessageModal').modal('show');
        };
</script>
{% endblock %}
