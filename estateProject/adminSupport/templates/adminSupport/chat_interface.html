{% extends 'adminSupport/base.html' %}
{% load static %}
{% load custom_filters %}
{% block content %}

<style>
    /* Simplified Chat Interface Styles */
    :root {
        --primary-color: #667eea;
        --text-color: #333;
        --bg-color: #f8f9fa;
        --border-color: #e9ecef;
    }

    /* Chat Layout */
    .chat-layout {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 20px;
        max-width: 1200px;
        margin: 0 auto;
        align-items: start;
    }

    /* Explorer Sidebar */
    .chat-explorer {
        background: white;
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        border: 1px solid var(--border-color);
        height: 70vh;
        overflow: auto;
    }

    .explorer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .explorer-header h4 {
        margin: 0;
        font-size: 16px;
        font-weight: 700;
        color: var(--text-color);
    }

    .explorer-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .explorer-item {
        padding: 12px;
        border-radius: 8px;
        background: white;
        border: 1px solid var(--border-color);
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .explorer-item:hover {
        background: #f0f4ff;
        border-color: #667eea;
        transform: translateX(2px);
    }

    .explorer-item.selected {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3), 0 2px 8px rgba(0, 0, 0, 0.15);
        transform: translateX(4px);
    }

    .explorer-item.selected:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        transform: translateX(6px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4), 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .explorer-empty {
        padding: 20px;
        color: #6c757d;
        text-align: center;
        font-size: 14px;
    }

    /* Chat Container - WhatsApp style */
    .chat-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        border: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        height: 70vh;
    }

    /* WhatsApp-style chat header */
    .wa-header {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px 18px;
        background: #075e54;
        border-radius: 12px 12px 0 0;
    }

    .wa-header-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 700;
        font-size: 1.3rem;
        text-transform: uppercase;
    }

    .wa-header-info h5 {
        margin: 0;
        font-size: 17px;
        font-weight: 700;
        color: #fff;
    }

    .wa-header-info span {
        font-size: 13px;
        color: #b2dfdb;
    }

    /* WhatsApp-style messages area */
    .wa-messages {
        flex: 1;
        overflow-y: auto;
        background: #e5ddd5;
        padding: 16px 10px;
    }

    .wa-messages::-webkit-scrollbar {
        width: 6px;
    }

    .wa-messages::-webkit-scrollbar-thumb {
        background: #b2b2b2;
        border-radius: 3px;
    }

    /* WhatsApp bubble rows */
    .wa-message-row {
        display: flex;
        margin-bottom: 6px;
        position: relative;
    }

    .wa-message-row.outgoing {
        justify-content: flex-end;
    }

    .wa-message-row.incoming {
        justify-content: flex-start;
    }

    .wa-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 700;
        font-size: 14px;
        margin-right: 8px;
        flex-shrink: 0;
    }

    .wa-message-row.outgoing .wa-avatar {
        margin-right: 0;
        margin-left: 8px;
        order: 2;
    }

    .wa-bubble {
        max-width: 70%;
        padding: 8px 14px;
        border-radius: 12px;
        font-size: 15px;
        position: relative;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .wa-bubble.outgoing {
        background: #dcf8c6;
        border-radius: 12px 12px 0 12px;
    }

    .wa-bubble.incoming {
        background: #fff;
        border-radius: 12px 12px 12px 0;
    }

    .wa-sender {
        font-size: 12px;
        font-weight: 700;
        color: #00a884;
        margin-bottom: 2px;
    }

    .wa-text {
        color: #222;
        word-break: break-word;
        white-space: pre-wrap;
        margin: 0;
    }

    .wa-meta {
        display: flex;
        align-items: center;
        gap: 6px;
        justify-content: flex-end;
        margin-top: 4px;
    }

    .wa-time {
        font-size: 11px;
        color: #888;
    }

    .wa-status {
        font-size: 14px;
        color: #53bdeb;
    }

    /* Document attachment style */
    .wa-doc {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f5f5f5;
        border-radius: 8px;
        padding: 10px 14px;
        margin-top: 6px;
        text-decoration: none;
        color: inherit;
        transition: background 0.2s;
    }

    .wa-doc:hover {
        background: #e8e8e8;
    }

    .wa-doc-icon {
        font-size: 28px;
        color: #667eea;
    }

    .wa-doc-info span {
        display: block;
        font-size: 14px;
        color: #333;
        font-weight: 500;
    }

    .wa-doc-info small {
        color: #888;
        font-size: 12px;
    }

    /* Image attachment */
    .wa-image {
        max-width: 260px;
        max-height: 220px;
        border-radius: 8px;
        margin-top: 6px;
        cursor: pointer;
        object-fit: cover;
    }

    /* Delete button */
    .wa-delete-btn {
        position: absolute;
        top: 4px;
        right: 8px;
        background: none;
        border: none;
        color: #aaa;
        font-size: 16px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.15s;
    }

    .wa-bubble:hover .wa-delete-btn {
        opacity: 1;
    }

    .wa-delete-btn:hover {
        color: #e74c3c;
    }

    /* WhatsApp-style input bar */
    .wa-inputbar {
        display: flex;
        align-items: flex-end;
        gap: 10px;
        padding: 12px 14px;
        background: #f0f0f0;
        border-radius: 0 0 12px 12px;
    }

    .wa-inputbar textarea {
        flex: 1;
        border: none;
        border-radius: 20px;
        padding: 12px 18px;
        font-size: 15px;
        resize: none;
        background: #fff;
        min-height: 44px;
        max-height: 120px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }

    .wa-inputbar textarea:focus {
        outline: none;
        box-shadow: 0 0 0 2px #00a88433;
    }

    .wa-inputbar .wa-btn {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        border: none;
        background: #00a884;
        color: #fff;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s;
    }

    .wa-inputbar .wa-btn:hover {
        background: #009975;
    }

    .wa-inputbar .wa-attach-btn {
        background: transparent;
        color: #888;
        font-size: 22px;
    }

    .wa-inputbar .wa-attach-btn:hover {
        color: #667eea;
        background: #e0e0e0;
    }

    /* File preview */
    .file-preview-bar {
        display: none;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        background: #fff8e1;
        border-top: 1px solid #ffe082;
    }

    .file-preview-bar.active {
        display: flex;
    }

    .file-preview-bar img {
        max-width: 60px;
        max-height: 60px;
        border-radius: 6px;
        object-fit: cover;
    }

    .file-preview-bar .file-info {
        flex: 1;
    }

    .file-preview-bar .file-info span {
        display: block;
        font-size: 14px;
        color: #333;
        font-weight: 500;
    }

    .file-preview-bar .file-info small {
        color: #888;
        font-size: 12px;
    }

    .file-preview-bar .remove-file {
        background: #e74c3c;
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        cursor: pointer;
        font-size: 14px;
    }

    /* Empty state */
    .chat-empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #e5ddd5;
        border-radius: 0 0 12px 12px;
    }

    .chat-empty-icon {
        width: 100px;
        height: 100px;
        background: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        color: #00a884;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .chat-empty-state h4 {
        color: #333;
        margin-bottom: 8px;
        font-weight: 600;
    }

    .chat-empty-state p {
        color: #666;
        margin: 0;
    }

    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background: #fff;
        border-radius: 16px;
        padding: 28px 32px;
        min-width: 320px;
        max-width: 90vw;
        box-shadow: 0 8px 32px rgba(0,0,0,0.18);
        text-align: center;
        animation: modalIn 0.2s;
    }

    @keyframes modalIn {
        from { transform: scale(0.92); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    .modal-icon {
        font-size: 48px;
        margin-bottom: 12px;
    }

    .modal-icon.error { color: #e74c3c; }
    .modal-icon.warning { color: #f39c12; }
    .modal-icon.success { color: #00a884; }

    .modal-title {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 8px;
    }

    .modal-message {
        color: #555;
        font-size: 15px;
        margin-bottom: 18px;
    }

    .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
    }

    .modal-btn {
        padding: 10px 28px;
        border-radius: 8px;
        border: none;
        font-size: 15px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s;
    }

    .modal-btn.primary {
        background: #00a884;
        color: #fff;
    }

    .modal-btn.primary:hover {
        background: #009975;
    }

    .modal-btn.danger {
        background: #e74c3c;
        color: #fff;
    }

    .modal-btn.danger:hover {
        background: #c0392b;
    }

    .modal-btn.secondary {
        background: #eee;
        color: #333;
    }

    .modal-btn.secondary:hover {
        background: #ddd;
    }

    /* Image Modal */
    .image-modal-content {
        background: transparent;
        box-shadow: none;
        padding: 0;
    }

    .image-modal-content img {
        max-width: 90vw;
        max-height: 85vh;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .chat-layout {
            grid-template-columns: 1fr;
        }
        .chat-explorer {
            display: none;
        }
        .chat-container {
            height: 85vh;
        }
        .wa-bubble {
            max-width: 85%;
        }
    }
</style>

<div class="chat-layout">
    <!-- Chat Explorer Sidebar -->
    <div class="chat-explorer">
        <div class="explorer-header">
            <h4><i class="bi bi-chat-dots me-2"></i>Chats</h4>
        </div>
        <div class="explorer-list">
            {% if chat_list %}
                {% for chat in chat_list %}
                <div class="explorer-item {% if chat.id == participant.id and chat.role == role %}selected{% endif %}" 
                     onclick="window.location.href='{% url 'adminSupport:chat_conversation' chat.role chat.id %}'">
                    <span class="explorer-avatar" style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;">
                        {{ chat.name|slice:":1"|upper }}
                    </span>
                    <span>{{ chat.name }}</span>
                </div>
                {% endfor %}
            {% else %}
                <div class="explorer-empty">
                    <i class="bi bi-chat-text fs-4 mb-2 d-block"></i>
                    No chats yet
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container">
        {% if participant %}
        <!-- WhatsApp-style Header -->
        <div class="wa-header">
            <div class="wa-header-avatar">
                {% if participant.first_name %}{{ participant.first_name|slice:":1"|upper }}{% else %}{{ participant.username|slice:":1"|upper }}{% endif %}
            </div>
            <div class="wa-header-info">
                <h5>{% if participant.first_name %}{{ participant.first_name }} {{ participant.last_name }}{% else %}{{ participant.username }}{% endif %}</h5>
                <span>{{ role|title }}</span>
            </div>
        </div>

        <!-- Messages Area -->
        <div class="wa-messages" id="messagesContainer">
            {% for msg in messages %}
                {% include 'adminSupport/chat_message.html' with msg=msg %}
            {% empty %}
                <div style="text-align:center;color:#888;padding:40px;">
                    <i class="bi bi-chat-text" style="font-size:48px;opacity:0.3;"></i>
                    <p style="margin-top:12px;">No messages yet. Start the conversation!</p>
                </div>
            {% endfor %}
        </div>

        <!-- File Preview Bar -->
        <div class="file-preview-bar" id="filePreviewBar">
            <img id="filePreviewImg" src="" alt="Preview" style="display:none;">
            <div class="file-info" id="filePreviewInfo">
                <span id="filePreviewName"></span>
                <small id="filePreviewSize"></small>
            </div>
            <button type="button" class="remove-file" id="removeFileBtn" title="Remove file">
                <i class="bi bi-x"></i>
            </button>
        </div>

        <!-- Input Bar -->
        <form id="chatForm" class="wa-inputbar" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="file" id="fileInput" name="file" style="display:none;">
            <button type="button" class="wa-btn wa-attach-btn" id="attachBtn" title="Attach file">
                <i class="bi bi-paperclip"></i>
            </button>
            <textarea id="messageInput" name="message" placeholder="Type a message..." rows="1"></textarea>
            <button type="submit" class="wa-btn" title="Send">
                <i class="bi bi-send-fill"></i>
            </button>
        </form>

        {% else %}
        <!-- Empty State -->
        <div class="wa-header" style="background:#075e54;">
            <div class="wa-header-avatar">
                <i class="bi bi-chat-dots"></i>
            </div>
            <div class="wa-header-info">
                <h5>Messages</h5>
                <span>Select a chat to start messaging</span>
            </div>
        </div>
        <div class="chat-empty-state">
            <div class="chat-empty-icon">
                <i class="bi bi-chat-square-text"></i>
            </div>
            <h4>Welcome to Support Chat</h4>
            <p>Select a user from the sidebar to start chatting</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Error Modal -->
<div class="modal" id="errorModal">
    <div class="modal-content">
        <div class="modal-icon error"><i class="bi bi-exclamation-circle-fill"></i></div>
        <div class="modal-title" id="errorModalTitle">Error</div>
        <div class="modal-message" id="errorModalMessage">Something went wrong.</div>
        <div class="modal-actions">
            <button class="modal-btn primary" onclick="hideErrorModal()">OK</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteModal">
    <div class="modal-content">
        <div class="modal-icon warning"><i class="bi bi-trash-fill"></i></div>
        <div class="modal-title">Delete Message</div>
        <div class="modal-message">Are you sure you want to delete this message? This cannot be undone.</div>
        <div class="modal-actions">
            <button class="modal-btn secondary" onclick="hideDeleteModal()">Cancel</button>
            <button class="modal-btn danger" id="confirmDeleteBtn">Delete</button>
        </div>
    </div>
</div>

<!-- Image Viewer Modal -->
<div class="modal" id="imageModal">
    <div class="modal-content image-modal-content">
        <img id="imageModalImg" src="" alt="Full Image">
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const messagesContainer = document.getElementById('messagesContainer');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const fileInput = document.getElementById('fileInput');
    const attachBtn = document.getElementById('attachBtn');
    const filePreviewBar = document.getElementById('filePreviewBar');
    const filePreviewImg = document.getElementById('filePreviewImg');
    const filePreviewName = document.getElementById('filePreviewName');
    const filePreviewSize = document.getElementById('filePreviewSize');
    const removeFileBtn = document.getElementById('removeFileBtn');
    const errorModal = document.getElementById('errorModal');
    const deleteModal = document.getElementById('deleteModal');
    const imageModal = document.getElementById('imageModal');
    const imageModalImg = document.getElementById('imageModalImg');

    let deleteMessageId = null;

    // File size/type constraints
    const MAX_FILE_SIZE = 16 * 1024 * 1024; // 16MB
    const ALLOWED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
    const ALLOWED_DOC_TYPES = [
        'application/pdf',
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/vnd.ms-excel',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.ms-powerpoint',
        'application/vnd.openxmlformats-officedocument.presentationml.presentation',
        'text/plain',
        'text/csv',
        'application/zip',
        'application/x-rar-compressed'
    ];

    function scrollToBottom() {
        if (messagesContainer) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }
    scrollToBottom();

    // Error Modal
    window.showErrorModal = function(message, title = 'Error') {
        document.getElementById('errorModalTitle').textContent = title;
        document.getElementById('errorModalMessage').textContent = message;
        errorModal.classList.add('show');
    };

    window.hideErrorModal = function() {
        errorModal.classList.remove('show');
    };

    // Delete Modal
    window.showDeleteModal = function(messageId) {
        deleteMessageId = messageId;
        deleteModal.classList.add('show');
    };

    window.hideDeleteModal = function() {
        deleteModal.classList.remove('show');
        deleteMessageId = null;
    };

    // Image Modal
    window.showImageModal = function(src) {
        imageModalImg.src = src;
        imageModal.classList.add('show');
    };

    window.hideImageModal = function() {
        imageModal.classList.remove('show');
        imageModalImg.src = '';
    };

    // Close modals on background click
    [errorModal, deleteModal, imageModal].forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.classList.remove('show');
            }
        });
    });

    // Delete confirmation
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (deleteMessageId) {
            deleteMessage(deleteMessageId);
        }
        hideDeleteModal();
    });

    function deleteMessage(messageId) {
        fetch('{% url "adminSupport:chat_delete_message" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'message_id=' + messageId
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const msgRow = document.querySelector(`.wa-message-row[data-id="${messageId}"]`);
                if (msgRow) {
                    msgRow.remove();
                }
            } else {
                showErrorModal(data.error || 'Failed to delete message');
            }
        })
        .catch(() => {
            showErrorModal('Network error. Please try again.');
        });
    }

    // Attach button
    if (attachBtn && fileInput) {
        attachBtn.addEventListener('click', function() {
            fileInput.click();
        });
    }

    // File selection and preview
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            const file = fileInput.files[0];
            if (!file) {
                filePreviewBar.classList.remove('active');
                return;
            }

            // Validate file type
            const isImage = ALLOWED_IMAGE_TYPES.includes(file.type);
            const isDoc = ALLOWED_DOC_TYPES.includes(file.type);

            if (!isImage && !isDoc) {
                showErrorModal('Invalid file type. Please upload an image (JPEG, PNG, GIF, WebP) or document (PDF, Word, Excel, PowerPoint, TXT, CSV, ZIP, RAR).', 'Invalid File');
                fileInput.value = '';
                filePreviewBar.classList.remove('active');
                return;
            }

            // Validate file size
            if (file.size > MAX_FILE_SIZE) {
                showErrorModal('File is too large. Maximum size is 16MB.', 'File Too Large');
                fileInput.value = '';
                filePreviewBar.classList.remove('active');
                return;
            }

            // Show preview
            filePreviewName.textContent = file.name;
            filePreviewSize.textContent = formatFileSize(file.size);
            
            if (isImage) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    filePreviewImg.src = e.target.result;
                    filePreviewImg.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                filePreviewImg.style.display = 'none';
            }
            
            filePreviewBar.classList.add('active');
        });
    }

    // Remove file
    if (removeFileBtn) {
        removeFileBtn.addEventListener('click', function() {
            fileInput.value = '';
            filePreviewBar.classList.remove('active');
            filePreviewImg.style.display = 'none';
        });
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Auto-resize textarea
    if (messageInput) {
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    }

    // Form submission
    if (chatForm) {
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            const file = fileInput.files[0];

            if (!message && !file) {
                // Silently ignore empty submissions - no error modal
                return;
            }

            const formData = new FormData();
            formData.append('message', message);
            if (file) {
                formData.append('file', file);
            }

            // Disable form while sending
            const submitBtn = chatForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            fetch('{% url "adminSupport:chat_send_message" role participant.id %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                submitBtn.disabled = false;
                if (data.success) {
                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    fileInput.value = '';
                    filePreviewBar.classList.remove('active');
                    filePreviewImg.style.display = 'none';
                    
                    // Add the new message to the container
                    if (data.html) {
                        messagesContainer.insertAdjacentHTML('beforeend', data.html);
                        scrollToBottom();
                    } else {
                        // Fallback: poll for new messages
                        pollMessages();
                    }
                } else {
                    if (data.error && !data.error.includes('provide either a message or attach a file')) {
                        showErrorModal(data.error || 'Failed to send message');
                    }
                }
            })
            .catch(() => {
                submitBtn.disabled = false;
                showErrorModal('Network error. Please try again.');
            });
        });
    }

    // Polling for new messages
    let lastMessageId = 0;
    const messageRows = document.querySelectorAll('.wa-message-row[data-id]');
    if (messageRows.length > 0) {
        const ids = Array.from(messageRows).map(row => parseInt(row.dataset.id)).filter(id => !isNaN(id));
        if (ids.length > 0) {
            lastMessageId = Math.max(...ids);
        }
    }

    function pollMessages() {
        {% if participant %}
        fetch(`{% url "adminSupport:chat_poll" role participant.id %}?last_id=${lastMessageId}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    if (msg.id > lastMessageId) {
                        lastMessageId = msg.id;
                        messagesContainer.insertAdjacentHTML('beforeend', msg.html);
                    }
                });
                scrollToBottom();
            }
        })
        .catch(() => {
            // Silent fail for polling
        });
        {% endif %}
    }

    // Poll every 3 seconds
    {% if participant %}
    setInterval(pollMessages, 3000);
    {% endif %}

    // Image click to expand
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('wa-image')) {
            showImageModal(e.target.src);
        }
    });

    // Keyboard shortcuts
    if (messageInput) {
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });
    }
});
</script>

{% endblock %}
