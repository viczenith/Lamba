{% extends 'marketer_base.html' %}
{% load static %}
{% load custom_filters %}
{% block content %}

<style>
    /* Simplified Chat Interface Styles */
    :root {
        --primary-color: #667eea;
        --text-color: #333;
        --bg-color: #f8f9fa;
        --border-color: #e9ecef;
    }

    /* Chat Layout */
    .chat-layout {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 20px;
        max-width: 1200px;
        margin: 0 auto;
        align-items: start;
    }

    /* Explorer Sidebar */
    .chat-explorer {
        background: white;
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        border: 1px solid var(--border-color);
        height: 70vh;
        overflow: auto;
    }

    .explorer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .explorer-header h4 {
        margin: 0;
        font-size: 16px;
        font-weight: 700;
        color: var(--text-color);
    }

    .explorer-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .explorer-item {
        padding: 12px;
        border-radius: 8px;
        background: white;
        border: 1px solid var(--border-color);
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .explorer-item:hover {
        background: #f0f4ff;
        border-color: #667eea;
        transform: translateX(2px);
    }

    .explorer-item.selected {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3), 0 2px 8px rgba(0, 0, 0, 0.15);
        transform: translateX(4px);
    }

    .explorer-item.selected:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        transform: translateX(6px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4), 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .explorer-empty {
        padding: 20px;
        color: #6c757d;
        text-align: center;
        font-size: 14px;
    }

    /* Chat Container - WhatsApp style */
    .chat-container {
        background: white;
        border-radius: 0;
        box-shadow: 0 1px 1px rgba(0,0,0,0.06);
        border: none;
        height: 75vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* Chat Header - WhatsApp style */
    .chat-header {
        padding: 10px 16px;
        background: #f0f2f5;
        border-bottom: none;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .chat-header-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #dfe5e7;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 600;
        color: #54656f;
        overflow: hidden;
    }

    .chat-header-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }

    .chat-header-info h3 {
        margin: 0;
        font-size: 16px;
        font-weight: 500;
        color: #111b21;
    }

    .chat-header-info p {
        margin: 2px 0 0 0;
        font-size: 13px;
        color: #667781;
    }

    /* Chat Window - WhatsApp style */
    .chat-window {
        flex: 1;
        overflow-y: auto;
        padding: 8px 0;
        background: #e5ddd5;
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4ccc4' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        position: relative;
    }

    .chat-window::-webkit-scrollbar {
        width: 6px;
    }

    .chat-window::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-window::-webkit-scrollbar-thumb {
        background: rgba(0,0,0,0.2);
        border-radius: 10px;
    }

    .chat-window::-webkit-scrollbar-thumb:hover {
        background: rgba(0,0,0,0.3);
    }

    /* Empty State */
    .chat-empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }

    .chat-empty-state i {
        font-size: 40px;
        margin-bottom: 10px;
        color: #667eea;
    }

    /* Welcome State - No Company Selected */
    .chat-welcome-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        min-height: 300px;
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }

    .chat-welcome-state .welcome-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .chat-welcome-state .welcome-icon i {
        font-size: 36px;
        color: white;
    }

    .chat-welcome-state h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
    }

    .chat-welcome-state p {
        font-size: 0.9rem;
        color: #6c757d;
        max-width: 300px;
        line-height: 1.5;
        margin-bottom: 20px;
    }

    .chat-welcome-state .welcome-hint {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #f0f4ff;
        padding: 10px 20px;
        border-radius: 25px;
        color: #667eea;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .chat-welcome-state .welcome-hint i {
        font-size: 16px;
        animation: bounceLeft 1s ease-in-out infinite;
    }

    @keyframes bounceLeft {
        0%, 100% { transform: translateX(0); }
        50% { transform: translateX(-5px); }
    }

    /* Day Separator - WhatsApp style */
    .chat-day-divider {
        display:flex;
        align-items:center;
        justify-content:center;
        margin: 12px 0;
    }
    .chat-day-divider span {
        background:rgba(225,245,254,0.92);
        color:#54656f;
        font-size:12.5px;
        font-weight:500;
        padding:5px 12px;
        border-radius:7.5px;
        box-shadow:0 1px 0.5px rgba(0,0,0,0.13);
        text-transform:uppercase;
        letter-spacing:0.3px;
    }

    /* Typing Indicator */
    .typing-indicator {
        position:absolute;
        left:12px;
        bottom:8px;
        display:none;
        align-items:center;
        gap:8px;
        background:#fff;
        border:1px solid var(--border-color);
        border-radius:18px;
        padding:6px 10px;
        box-shadow:0 2px 8px rgba(0,0,0,.06);
    }
    .typing-dots { display:flex; gap:4px; }
    .typing-dots span {
        width:6px; height:6px; border-radius:50%;
        background:#667eea; opacity:.6;
        animation: typing-bounce 1.2s infinite ease-in-out;
    }
    .typing-dots span:nth-child(2){ animation-delay:.2s }
    .typing-dots span:nth-child(3){ animation-delay:.4s }
    @keyframes typing-bounce { 0%, 80%, 100% { transform:scale(0.8) } 40% { transform:scale(1) } }

    /* Scroll to bottom button - WhatsApp style */
    .scroll-bottom-btn {
        position:absolute;
        right:16px;
        bottom:16px;
        background:#fff;
        color:#54656f;
        border:none;
        width:42px; height:42px;
        border-radius:50%;
        display:none;
        align-items:center; justify-content:center;
        box-shadow:0 1px 3px rgba(0,0,0,0.2);
        cursor:pointer;
        z-index:10;
    }
    .scroll-bottom-btn:hover {
        background:#f0f2f5;
    }

    /* Chat Input Area - WhatsApp style */
    .chat-input-area {
        padding: 10px;
        background: #f0f2f5;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* Form wrapper for file preview positioning */
    #chat-form {
        position: relative;
        width: 100%;
        padding: 10px;
        background: #f0f2f5;
    }

    .chat-input-form {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
    }

    .chat-input-form input[type="file"] {
        display: none;
    }

    .input-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        background: #fff;
        border: none;
        border-radius: 8px;
        padding: 9px 12px;
    }

    .input-wrapper:focus-within {
        box-shadow: none;
    }

    .attachment-btn {
        cursor: pointer;
        font-size: 24px;
        color: #54656f;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: transparent;
        transition: color 0.15s ease;
    }

    .attachment-btn:hover {
        color: #00a884;
        background: transparent;
    }

    .chat-input-form textarea {
        flex: 1;
        resize: none;
        border: none;
        padding: 0;
        font-size: 15px;
        line-height: 20px;
        height: 20px;
        min-height: 20px;
        max-height: 100px;
        font-family: inherit;
        color: #111b21;
        background: transparent;
        overflow-y: auto;
    }

    .chat-input-form textarea:focus {
        outline: none;
    }

    .chat-input-form textarea::placeholder {
        color: #667781;
    }

    .send-btn {
        background: #00a884;
        border: none;
        color: #fff;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
    }

    .send-btn:hover {
        background: #008f72;
    }

    .send-btn:active {
        transform: scale(0.95);
    }

    /* File Preview Container - WhatsApp style floating preview */
    .file-preview-container {
        display: none;
        position: absolute;
        bottom: 100%;
        left: 10px;
        right: 10px;
        background: #fff;
        border-radius: 12px;
        padding: 12px 14px;
        margin-bottom: 8px;
        align-items: center;
        gap: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.15);
        z-index: 10;
        border: 1px solid rgba(0,0,0,0.08);
    }
    .file-preview-container.active {
        display: flex;
    }
    .file-thumbnail-wrapper {
        width: 56px;
        height: 56px;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
        background: #f0f2f5;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .file-thumbnail-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .file-icon-thumbnail {
        width: 56px;
        height: 56px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 26px;
        color: #fff;
    }
    .file-icon-thumbnail.pdf { background: #e74c3c; }
    .file-icon-thumbnail.doc { background: #2980b9; }
    .file-icon-thumbnail.xls { background: #27ae60; }
    .file-icon-thumbnail.zip { background: #f39c12; }
    .file-icon-thumbnail.default { background: #95a5a6; }
    .file-details {
        flex: 1;
        min-width: 0;
    }
    .file-details-name {
        font-size: 14px;
        font-weight: 600;
        color: #111b21;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 2px;
    }
    .file-details-size {
        font-size: 12px;
        color: #667781;
    }
    .remove-file-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #f0f2f5;
        border: none;
        color: #54656f;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
        flex-shrink: 0;
    }
    .remove-file-btn:hover {
        background: rgba(255,59,48,0.15);
        color: #ff3b30;
    }
        cursor: pointer;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
    }

    .send-btn:hover {
        background: #008f72;
    }

    .send-btn:active {
        transform: scale(0.95);
    }

    /* Remove old message styles - now in chat_message.html */
    .chat-skeleton { display:none; gap:8px; padding:8px 0; }
    .skeleton-bubble { width:65%; height:44px; border-radius:7.5px; background:linear-gradient(90deg,#e5ddd5 25%,#d4ccc4 37%,#e5ddd5 63%); background-size:400% 100%; animation:skeleton-shimmer 1.4s ease infinite; }
    @keyframes skeleton-shimmer { 0%{background-position:100% 0} 100%{background-position:-100% 0} }

    /* ========== WhatsApp Message Styles ========== */
    
    /* Message Row */
    .wa-message-row {
        display: flex;
        align-items: flex-end;
        margin-bottom: 2px;
        padding: 0 12px;
    }
    .wa-message-row.outgoing {
        justify-content: flex-end;
    }
    .wa-message-row.incoming {
        justify-content: flex-start;
    }
    
    /* Avatar - Small circle outside bubble */
    .wa-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 4px;
    }
    .wa-message-row.outgoing .wa-avatar {
        margin-left: 6px;
        order: 2;
        background: #075e54;
        color: #fff;
    }
    .wa-message-row.incoming .wa-avatar {
        margin-right: 6px;
        background: #e5e5ea;
        color: #333;
    }
    .wa-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    /* Message Bubble */
    .wa-bubble {
        max-width: 65%;
        padding: 6px 7px 8px 9px;
        border-radius: 7.5px;
        position: relative;
        word-wrap: break-word;
        box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
    }
    
    /* Outgoing (sender/client) - WhatsApp green */
    .wa-bubble.outgoing {
        background: #dcf8c6;
        border-top-right-radius: 0;
        margin-right: 8px;
    }
    .wa-bubble.outgoing::after {
        content: '';
        position: absolute;
        top: 0;
        right: -8px;
        width: 0;
        height: 0;
        border-left: 8px solid #dcf8c6;
        border-top: 8px solid transparent;
    }
    
    /* Incoming (receiver/admin) - White */
    .wa-bubble.incoming {
        background: #fff;
        border-top-left-radius: 0;
        margin-left: 8px;
    }
    .wa-bubble.incoming::before {
        content: '';
        position: absolute;
        top: 0;
        left: -8px;
        width: 0;
        height: 0;
        border-right: 8px solid #fff;
        border-top: 8px solid transparent;
    }
    
    /* Sender name (only for incoming) */
    .wa-sender-name {
        font-size: 12.5px;
        font-weight: 600;
        color: #075e54;
        margin-bottom: 1px;
    }
    
    /* Message text */
    .wa-text {
        font-size: 14.2px;
        line-height: 19px;
        color: #303030;
        white-space: pre-wrap;
    }
    .wa-text p { margin: 0; }
    
    /* Meta row: time + status */
    .wa-meta {
        display: inline-flex;
        justify-content: flex-end;
        align-items: center;
        gap: 3px;
        margin-top: 1px;
        float: right;
        margin-left: 10px;
    }
    .wa-time {
        font-size: 11px;
        color: rgba(0,0,0,0.45);
    }
    .wa-status {
        font-size: 16px;
        color: rgba(0,0,0,0.35);
    }
    .wa-status.read {
        color: #53bdeb;
    }
    
    /* Attachment - Image */
    .wa-attachment-img {
        max-width: 330px;
        max-height: 330px;
        border-radius: 6px;
        margin-bottom: 3px;
        cursor: pointer;
        display: block;
    }
    
    /* Attachment - Document - WhatsApp style compact */
    .wa-doc {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(0,0,0,0.05);
        border-radius: 8px;
        padding: 8px 10px;
        margin-bottom: 2px;
        cursor: pointer;
        min-width: 180px;
        max-width: 300px;
    }
    .wa-doc-icon {
        width: 34px;
        height: 34px;
        border-radius: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
    }
    .wa-doc-icon.pdf { background: #e74c3c; color: #fff; }
    .wa-doc-icon.doc { background: #2980b9; color: #fff; }
    .wa-doc-icon.xls { background: #27ae60; color: #fff; }
    .wa-doc-icon.zip { background: #f39c12; color: #fff; }
    .wa-doc-icon.default { background: #95a5a6; color: #fff; }
    .wa-doc-info {
        flex: 1;
        min-width: 0;
    }
    .wa-doc-name {
        font-size: 12.5px;
        font-weight: 500;
        color: #303030;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.3;
    }
    .wa-doc-size {
        font-size: 10.5px;
        color: rgba(0,0,0,0.5);
        line-height: 1.2;
    }
    
    /* Delete button */
    .wa-delete-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: rgba(0,0,0,0.05);
        border: none;
        color: #999;
        font-size: 10px;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
    }
    .wa-bubble:hover .wa-delete-btn {
        display: flex;
    }
    .wa-delete-btn:hover {
        background: rgba(255,59,48,0.15);
        color: #ff3b30;
    }
    
    /* Deleted message */
    .wa-deleted {
        font-style: italic;
        color: rgba(0,0,0,0.45);
    }
    
    /* Modal Styles - WhatsApp style */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        align-items: center;
        justify-content: center;
    }
    .modal.show {
        display: flex;
    }
    .modal-content {
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        animation: modalSlideIn 0.2s ease;
        position: relative;
    }
    @keyframes modalSlideIn {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }
    .modal-content h3 {
        margin: 0 0 12px 0;
        font-size: 18px;
        font-weight: 600;
        color: #111b21;
    }
    .modal-content p {
        margin: 0 0 20px 0;
        font-size: 14px;
        color: #667781;
        line-height: 1.5;
    }
    .modal-close {
        position: absolute;
        top: 12px;
        right: 16px;
        font-size: 24px;
        color: #54656f;
        cursor: pointer;
        line-height: 1;
    }
    .modal-close:hover {
        color: #111b21;
    }
    .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }
    .modal-buttons .btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.15s ease;
    }
    .modal-buttons .btn-secondary {
        background: #f0f2f5;
        color: #54656f;
    }
    .modal-buttons .btn-secondary:hover {
        background: #e5e7ea;
    }
    .modal-buttons .btn-danger {
        background: #ea4335;
        color: #fff;
    }
    .modal-buttons .btn-danger:hover {
        background: #d33426;
    }
    .modal-buttons .btn-primary {
        background: #00a884;
        color: #fff;
    }
    .modal-buttons .btn-primary:hover {
        background: #008c6f;
    }
    
    /* Mobile responsiveness for messages */
    @media (max-width: 600px) {
        .wa-bubble { max-width: 85%; }
        .wa-avatar { width: 24px; height: 24px; font-size: 10px; }
    }

    /* Responsive Design */
    @media (max-width: 992px) {
        .chat-layout {
            grid-template-columns: 1fr;
        }
        .chat-explorer {
            height: auto;
            order: 2;
        }
        .chat-main {
            order: 1;
        }
    }

    @media (max-width: 768px) {
        .chat-container {
            height: 60vh;
        }
        
        .chat-explorer {
            height: auto;
        }
        
        .chat-header {
            padding: 12px 15px;
        }
        
        .chat-header-avatar {
            width: 36px;
            height: 36px;
            font-size: 16px;
        }
        
        .chat-header-info h3 {
            font-size: 14px;
        }
        
        .chat-window {
            padding: 15px;
        }
        
        .chat-input-area {
            padding: 10px 12px;
        }
        
        .send-btn {
            width: 36px;
            height: 36px;
            font-size: 14px;
        }
    }
</style>

<main id="main" class="main">
    <div class="pagetitle">
        <h1><i class="bi bi-chat-dots"></i>
            {% if selected_company %}
                Chat — {{ selected_company.company_name }}
            {% else %}
                Chat with Admin Support
            {% endif %}
        </h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'marketer-dashboard' %}">Home</a></li>
                <li class="breadcrumb-item active">Chat</li>
            </ol>
        </nav>
    </div>
  
    <div class="chat-layout">
        <aside class="chat-explorer">
            <div class="explorer-header">
                <h4>My Companies</h4>
            </div>
            <div class="explorer-list">
                {% if companies %}
                    {% for item in companies %}
                        <div class="explorer-item{% if selected_company and selected_company.id == item.company.id %} selected{% endif %}" data-company-id="{{ item.company.id }}" data-company-name="{{ item.company.company_name }}" data-company-logo="{% if item.company.logo %}{{ item.company.logo.url }}{% else %}{% endif %}">
                            {% if item.company.logo %}
                                <img src="{{ item.company.logo.url }}" alt="{{ item.company.company_name }}" loading="lazy" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; border: 2px solid #667eea; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            {% else %}
                                <div style="width: 24px; height: 24px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: inline-flex; align-items: center; justify-content: center; margin-right: 8px; font-size: 12px; font-weight: 800; color: white; border: 2px solid white;">
                                    {{ item.company.company_name|first|upper }}
                                </div>
                            {% endif %}
                            {{ item.company.company_name }}
                            <span style="margin-left:auto; font-size:11px; color:#667781;">({{ item.transactions }} txns)</span>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="explorer-empty">You have no company affiliations yet.</div>
                {% endif %}
            </div>
        </aside>

        <section class="chat-main">
            <div class="chat-container">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="chat-header-avatar" id="chat-header-avatar">
                    {% if selected_company and selected_company.logo %}
                        <img src="{{ selected_company.logo.url }}" alt="{{ selected_company.company_name }}" loading="lazy">
                    {% elif selected_company %}
                        {{ selected_company.company_name|first|upper }}
                    {% else %}
                        <i class="bi bi-headset"></i>
                    {% endif %}
                </div>
                <div class="chat-header-info" id="chat-header-info">
                    {% if selected_company %}
                        <h3 id="chat-header-title">{{ selected_company.company_name }}</h3>
                        <p id="chat-header-subtitle">Admin Support</p>
                    {% else %}
                        <h3 id="chat-header-title">Admin Support</h3>
                        <p id="chat-header-subtitle">Select a company to start chatting</p>
                    {% endif %}
                </div>
            </div>

        <!-- Chat Window -->
        <div id="chat-window" class="chat-window">
            <!-- Chat skeleton and typing indicator (always present but hidden) -->
            <div id="chat-skeleton" class="chat-skeleton" style="display: none;">
                <div class="chat-avatar admin"></div>
                <div class="skeleton-bubble"></div>
            </div>
            <div id="typing-indicator" class="typing-indicator" style="display: none;">
                <div class="chat-avatar admin">A</div>
                <div class="typing-dots"><span></span><span></span><span></span></div>
                <span style="font-size:12px;color:#495057;">Typing…</span>
            </div>
            
            <!-- Messages container (rendered by JS) -->
            <div id="messages-container">
            {% if selected_company %}
            {% load tz %}
            {% for msg in messages %}
                {% ifchanged msg.date_sent|date:"Y-m-d" %}
                    <div class="chat-day-divider">
                        <span>{{ msg.date_sent|date:"D, j M Y" }}</span>
                    </div>
                {% endifchanged %}
                {% include 'marketer_side/chat_message.html' with msg=msg %}
            {% empty %}
                <div class="chat-empty-state" id="chat-empty-state">
                    <i class="bi bi-chat-heart"></i>
                    <p>No messages yet. Start the conversation!</p>
                </div>
            {% endfor %}
            {% endif %}
            </div>
            
            <!-- Welcome screen when no company is selected -->
            <div id="chat-welcome-state" class="chat-welcome-state" style="{% if selected_company %}display: none;{% endif %}">
                <div class="welcome-icon">
                    <i class="bi bi-chat-square-dots"></i>
                </div>
                <h3>Chat with Admin Support</h3>
                <p>Select a company from the list to view your conversation history and send messages to admin support.</p>
                <div class="welcome-hint">
                    <i class="bi bi-arrow-left"></i>
                    <span>Choose a company to get started</span>
                </div>
            </div>
            <button id="scroll-bottom-btn" class="scroll-bottom-btn" title="Scroll to bottom">
                <i class="bi bi-arrow-down"></i>
            </button>
            </div>

            <!-- Chat Input Area -->
            {% if companies %}
            <!-- Chat Form (always present, shown/hidden via JS) -->
            <form id="chat-form" method="post" enctype="multipart/form-data" action="{% url 'marketer-chat' %}" style="{% if not selected_company %}display: none;{% endif %}">
                {% csrf_token %}
                <input type="hidden" name="company_id" id="company-id-input" value="{% if selected_company %}{{ selected_company.id }}{% endif %}">
                
                <!-- File Preview (WhatsApp style) -->
                <div id="file-preview-container" class="file-preview-container">
                    <div id="file-thumbnail-wrapper" class="file-thumbnail-wrapper"></div>
                    <div class="file-details">
                        <div id="file-details-name" class="file-details-name"></div>
                        <div id="file-details-size" class="file-details-size"></div>
                    </div>
                    <button type="button" id="remove-file" class="remove-file-btn" title="Remove file">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                
                <div class="chat-input-form">
                    <input type="file" id="file-input" name="file" accept="image/jpeg,image/png,image/gif,image/webp,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.zip,.rar">
                    
                    <div class="input-wrapper">
                        <label for="file-input" class="attachment-btn">
                            <i class="bi bi-plus-circle"></i>
                        </label>
                        <textarea name="message_content" id="message-content" placeholder="Type a message" rows="1"></textarea>
                    </div>
                    
                    <button type="submit" class="send-btn">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </form>
            
            <!-- No company selected - show prompt (shown/hidden via JS) -->
            <div id="no-company-prompt" class="chat-input-form no-company-selected" style="align-items:center; {% if selected_company %}display: none;{% endif %}">
                <div style="flex:1; padding:12px; color:rgba(0,0,0,0.6); display:flex; align-items:center; gap:8px;">
                    <i class="bi bi-arrow-left-circle" style="font-size:18px; color:#667eea;"></i>
                    <span>Select a company from the left to start chatting</span>
                </div>
                <button class="send-btn" disabled title="Select a company first"><i class="bi bi-send-fill"></i></button>
            </div>
            {% else %}
            <div class="chat-input-form" style="align-items:center;">
                <div style="flex:1; padding:12px; color:rgba(0,0,0,0.6);">Chat disabled — you have no companies associated with your account.</div>
                <button class="send-btn" disabled title="No companies"><i class="bi bi-send-fill"></i></button>
            </div>
            {% endif %}
            </div>
        </section>
    </div>
  
    <!-- Attachment Modal -->
    <div id="attachment-modal" class="modal">
        <div class="modal-content">
            <span id="modal-close" class="modal-close">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>
  
    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <span id="delete-modal-close" class="modal-close">&times;</span>
            <h3 style="margin-top: 0;">Delete Message</h3>
            <p>Are you sure you want to delete this message? This action cannot be undone.</p>
            <div class="modal-buttons">
                <button id="delete-cancel-btn" class="btn btn-secondary">Cancel</button>
                <button id="delete-confirm-btn" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <!-- Error/Info Modal -->
    <div id="error-modal" class="modal">
        <div class="modal-content">
            <span id="error-modal-close" class="modal-close">&times;</span>
            <h3 id="error-modal-title" style="margin-top: 0;">Notice</h3>
            <p id="error-modal-message"></p>
            <div class="modal-buttons">
                <button id="error-modal-ok" class="btn btn-primary">OK</button>
            </div>
        </div>
    </div>
</main>
  
<script>
document.addEventListener("DOMContentLoaded", function() {
    var chatWindow = document.getElementById('chat-window');
    chatWindow.scrollTop = chatWindow.scrollHeight;
    var typingIndicator = document.getElementById('typing-indicator');
    var scrollBottomBtn = document.getElementById('scroll-bottom-btn');
  
    // Only wire chat form behaviors if the chat form is present (chat may be disabled when no companies)
    var chatForm = document.getElementById('chat-form');
    if (chatForm) {
        // File preview elements
        var fileInput = document.getElementById('file-input');
        var filePreviewContainer = document.getElementById('file-preview-container');
        var fileThumbnailWrapper = document.getElementById('file-thumbnail-wrapper');
        var fileDetailsName = document.getElementById('file-details-name');
        var fileDetailsSize = document.getElementById('file-details-size');
        var removeFileBtn = document.getElementById('remove-file');
        
        // Allowed file types (images and documents only - NO videos)
        var allowedImageTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        var allowedDocExtensions = ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'csv', 'zip', 'rar'];
        var maxFileSize = 16 * 1024 * 1024; // 16MB like WhatsApp for documents
        var maxImageSize = 16 * 1024 * 1024; // 16MB for images
        
        function isAllowedFile(file) {
            var fileName = file.name;
            var fileExt = fileName.split('.').pop().toLowerCase();
            
            // Block videos explicitly
            if (file.type.startsWith('video/')) {
                return { allowed: false, reason: 'Videos are not allowed. Please share images or documents only.' };
            }
            
            // Allow images
            if (allowedImageTypes.includes(file.type)) {
                if (file.size > maxImageSize) {
                    return { allowed: false, reason: 'Image size exceeds 16MB limit.' };
                }
                return { allowed: true };
            }
            
            // Allow documents
            if (allowedDocExtensions.includes(fileExt)) {
                if (file.size > maxFileSize) {
                    return { allowed: false, reason: 'File size exceeds 16MB limit.' };
                }
                return { allowed: true };
            }
            
            return { allowed: false, reason: 'File type not supported. Please use images (JPG, PNG, GIF, WebP) or documents (PDF, Word, Excel, PowerPoint, TXT, CSV, ZIP).' };
        }
      
        // Enhanced file preview with WhatsApp-style previews
        if (fileInput) {
            fileInput.addEventListener('change', function(){
                var file = this.files[0];
                if(file) {
                    // Validate file type and size
                    var validation = isAllowedFile(file);
                    if (!validation.allowed) {
                        showErrorModal(validation.reason, 'Invalid File');
                        this.value = ''; // Clear the file input
                        return;
                    }
                    
                    // Get file extension
                    var fileName = file.name;
                    var fileExt = fileName.split('.').pop().toLowerCase();
                    var fileSize = formatFileSize(file.size);
                    
                    // Clear previous thumbnail
                    if (fileThumbnailWrapper) fileThumbnailWrapper.innerHTML = '';
                    
                    if(file.type.startsWith("image/")) {
                        // Image preview
                        var reader = new FileReader();
                        reader.onload = function(e) {
                            var img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'file-thumbnail';
                            img.alt = 'Image preview';
                            if (fileThumbnailWrapper) fileThumbnailWrapper.appendChild(img);
                        }
                        reader.readAsDataURL(file);
                    } else {
                        // Document icon preview
                        var iconDiv = document.createElement('div');
                        iconDiv.className = 'file-icon-thumbnail';
                        
                        // Set icon class based on file type
                        if(fileExt === 'pdf') {
                            iconDiv.classList.add('pdf');
                            iconDiv.innerHTML = '<i class="bi bi-file-earmark-pdf-fill"></i>';
                        } else if(fileExt === 'doc' || fileExt === 'docx') {
                            iconDiv.classList.add('doc');
                            iconDiv.innerHTML = '<i class="bi bi-file-earmark-word-fill"></i>';
                        } else if(fileExt === 'xls' || fileExt === 'xlsx') {
                            iconDiv.classList.add('xls');
                            iconDiv.innerHTML = '<i class="bi bi-file-earmark-excel-fill"></i>';
                        } else if(fileExt === 'zip' || fileExt === 'rar' || fileExt === '7z') {
                            iconDiv.classList.add('zip');
                            iconDiv.innerHTML = '<i class="bi bi-file-earmark-zip-fill"></i>';
                        } else {
                            iconDiv.classList.add('default');
                            iconDiv.innerHTML = '<i class="bi bi-file-earmark-fill"></i>';
                        }
                        
                        fileThumbnailWrapper.appendChild(iconDiv);
                    }
                    
                    // Update file details
                    if (fileDetailsName) {
                        fileDetailsName.textContent = fileName.length > 35 ? fileName.substring(0, 32) + '...' : fileName;
                        fileDetailsName.title = fileName;
                    }
                    if (fileDetailsSize) fileDetailsSize.textContent = fileSize;
                    if (filePreviewContainer) filePreviewContainer.classList.add('active');
                }
            });
        }
        
        // Format file size helper function
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
      
        if (removeFileBtn) {
            removeFileBtn.addEventListener('click', function(){
                if (fileInput) fileInput.value = "";
                if (filePreviewContainer) filePreviewContainer.classList.remove('active');
                if (fileThumbnailWrapper) fileThumbnailWrapper.innerHTML = '';
                if (fileDetailsName) fileDetailsName.textContent = '';
                if (fileDetailsSize) fileDetailsSize.textContent = '';
            });
        }
      
        // WhatsApp-style auto-expanding textarea
        var messageInput = document.getElementById('message-content');
        
        function autoExpand() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        }
        
        if (messageInput) {
            messageInput.addEventListener('input', autoExpand);
            // show typing indicator while user types
            messageInput.addEventListener('input', function(){ if (typingIndicator) typingIndicator.style.display='flex'; throttleHideTyping(); });
            
            // Allow sending message on Enter (without Shift)
            messageInput.addEventListener('keydown', function(e) {
                if(e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('chat-form').dispatchEvent(new Event('submit', {cancelable:true}));
                }
            });
        }
      
        // Handle chat form submission via AJAX
        // Get CSRF token from the hidden form field (CSRF_COOKIE_HTTPONLY is True)
        function getCSRFToken() {
            var tokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            return tokenInput ? tokenInput.value : '';
        }
        
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            var form = this;
            var formData = new FormData(form);
            fetch(form.action, {
                method: "POST",
                headers: { 
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCSRFToken()
                },
                body: formData,
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Server error:', response.status, text);
                        throw new Error('Server error: ' + response.status);
                    });
                }
                return response.json();
            })
            .then(data => {
                if(data.success) {
                    // Create a temporary div to parse the message HTML
                    var tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data.message_html;
                    // Get the wa-message-row container (first element in response)
                    var newMessageRow = tempDiv.querySelector('.wa-message-row');
                    
                    if (newMessageRow) {
                        // Extract message ID from the bubble inside
                        var bubble = newMessageRow.querySelector('[data-msg-id]');
                        var newMsgId = bubble ? bubble.getAttribute('data-msg-id') : null;

                        // Check if message already exists (prevent duplicates)
                        if (newMsgId && !document.querySelector('[data-msg-id="' + newMsgId + '"]')) {
                            chatWindow.appendChild(newMessageRow);
                            // Update lastMessageId to prevent polling from fetching it again
                            lastMessageId = parseInt(newMsgId);
                        }
                    }
                    
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                    if (typingIndicator) typingIndicator.style.display='none';
                    form.reset();
                    // Clear file preview
                    if (filePreviewContainer) filePreviewContainer.classList.remove('active');
                    if (fileThumbnailWrapper) fileThumbnailWrapper.innerHTML = '';
                    if (fileDetailsName) fileDetailsName.textContent = '';
                    if (fileDetailsSize) fileDetailsSize.textContent = '';
                    // Reset textarea height
                    if (messageInput) messageInput.style.height = 'auto';
                } else {
                    // Don't show error for empty message - just ignore
                    if (data.error && !data.error.includes('provide either a message')) {
                        showErrorModal(data.error, 'Error');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showErrorModal('Something went wrong. Please try again.', 'Error');
            });
        });
    }
  
    // Poll for new messages every 1.5 seconds (faster for real-time feel)
    // Initialize lastMessageId using the last message in the conversation or 0.
    let lastMessageId = {{ messages.last.id|default:0 }};
    let selectedCompanyId = document.getElementById('company-id-input') ? document.getElementById('company-id-input').value : null;
    let audioContext = null;
    let notificationEnabled = true;
    
    // ========== Notification Sound System ==========
    function initAudioContext() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        return audioContext;
    }

    function playMessageNotificationSound() {
        try {
            var ctx = initAudioContext();
            if (ctx.state === 'suspended') {
                ctx.resume();
            }
            
            // WhatsApp-like notification tone (two quick beeps)
            var oscillator = ctx.createOscillator();
            var gainNode = ctx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            oscillator.frequency.setValueAtTime(880, ctx.currentTime); // A5 note
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
            
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.15);
            
            // Second beep
            setTimeout(function() {
                var osc2 = ctx.createOscillator();
                var gain2 = ctx.createGain();
                
                osc2.connect(gain2);
                gain2.connect(ctx.destination);
                
                osc2.frequency.setValueAtTime(1046.5, ctx.currentTime); // C6 note
                osc2.type = 'sine';
                
                gain2.gain.setValueAtTime(0.3, ctx.currentTime);
                gain2.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
                
                osc2.start(ctx.currentTime);
                osc2.stop(ctx.currentTime + 0.15);
            }, 120);
            
        } catch (e) {
            console.warn('Could not play notification sound:', e);
        }
    }

    // Initialize audio on first click (browser requirement)
    document.body.addEventListener('click', function initAudio() {
        initAudioContext();
        document.body.removeEventListener('click', initAudio);
    }, { once: true });
    
    function renderMessagesHtml(messagesHtml) {
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = messagesHtml;
        
        // Get all child elements (message rows AND day dividers)
        var allElements = tempDiv.children;
        
        for (var i = 0; i < allElements.length; i++) {
            var element = allElements[i].cloneNode(true);
            
            // Check if it's a day divider
            if (element.classList.contains('chat-day-divider')) {
                chatWindow.appendChild(element);
                continue;
            }
            
            // Check if it's a message row
            if (element.classList.contains('wa-message-row')) {
                var bubble = element.querySelector('[data-msg-id]');
                var msgId = bubble ? bubble.getAttribute('data-msg-id') : null;
                
                if (msgId && !document.querySelector('[data-msg-id="' + msgId + '"]')) {
                    chatWindow.appendChild(element);
                    lastMessageId = Math.max(lastMessageId, parseInt(msgId));
                }
            }
        }
        
        chatWindow.scrollTop = chatWindow.scrollHeight;
        updateScrollButton();
    }

    // Function to switch from welcome state to chat state
    function activateChatInterface() {
        const welcomeState = document.getElementById('chat-welcome-state');
        const chatForm = document.getElementById('chat-form');
        const noCompanyPrompt = document.getElementById('no-company-prompt');
        const messagesContainer = document.getElementById('messages-container');
        
        // Hide welcome state
        if (welcomeState) welcomeState.style.display = 'none';
        
        // Show chat form
        if (chatForm) chatForm.style.display = '';
        
        // Hide no company prompt
        if (noCompanyPrompt) noCompanyPrompt.style.display = 'none';
        
        // Show messages container
        if (messagesContainer) messagesContainer.style.display = '';
    }

    function loadConversation(companyId) {
        // First, activate the chat interface (switch from welcome to chat)
        activateChatInterface();
        
        // Get messages container (or chat window if container doesn't exist)
        const messagesContainer = document.getElementById('messages-container') || chatWindow;
        messagesContainer.innerHTML = '';
        
        // show skeleton while loading
        const skeleton = document.getElementById('chat-skeleton');
        if (skeleton) { 
            chatWindow.insertBefore(skeleton, chatWindow.firstChild);
            skeleton.style.display = 'flex'; 
        }
        lastMessageId = 0;
        let url = `{% url 'marketer-chat' %}?history=1`;
        if (companyId) url += `&company_id=${companyId}`;
        fetch(url, {credentials: 'same-origin'})
            .then(resp => resp.json())
            .then(data => {
                if (data.messages_html) {
                    renderMessagesHtml(data.messages_html);
                } else {
                    // No messages - show empty state
                    const emptyState = document.createElement('div');
                    emptyState.className = 'chat-empty-state';
                    emptyState.innerHTML = '<i class="bi bi-chat-heart"></i><p>No messages yet. Start the conversation!</p>';
                    messagesContainer.appendChild(emptyState);
                }
            })
            .catch(err => console.error('Error loading conversation:', err))
            .finally(() => { 
                const skeleton2 = document.getElementById('chat-skeleton'); 
                if (skeleton2) skeleton2.style.display = 'none'; 
                chatWindow.scrollTop = chatWindow.scrollHeight;
            });
    }

    function pollNewMessages() {
        let url = `{% url 'marketer-chat' %}?last_msg=${lastMessageId}`;
        if (selectedCompanyId) url += `&company_id=${selectedCompanyId}`;
        fetch(url, {credentials: 'same-origin'})
            .then(response => response.json())
            .then(data => {
                let newIncomingMessages = false;
                const currentUserEmail = '{{ request.user.email }}';
                
                if(data.messages && data.messages.length > 0 && data.messages_html) {
                    // Check for incoming messages (not from current user)
                    data.messages.forEach(function(msg) {
                        if (msg.sender__email !== currentUserEmail) {
                            newIncomingMessages = true;
                        }
                    });
                    
                    renderMessagesHtml(data.messages_html);
                    
                    // Play notification sound for new incoming messages
                    if (newIncomingMessages && notificationEnabled) {
                        playMessageNotificationSound();
                    }
                }
                if(data.updated_statuses && data.updated_statuses.length > 0) {
                    data.updated_statuses.forEach(function(statusUpdate) {
                        var statusIcon = document.querySelector('[data-msg-id="' + statusUpdate.id + '"] .message-status');
                        if(statusIcon) {
                            statusIcon.className = 'message-status status-' + statusUpdate.status;
                            if(statusUpdate.status === 'sent') {
                                statusIcon.innerHTML = '<i class="bi bi-check"></i>';
                            } else if(statusUpdate.status === 'delivered') {
                                statusIcon.innerHTML = '<i class="bi bi-check-all"></i>';
                            } else if(statusUpdate.status === 'read') {
                                statusIcon.innerHTML = '<i class="bi bi-check-all"></i>';
                            }
                        }
                    });
                }
            })
            .catch(error => console.error('Error fetching new messages:', error));
        setTimeout(pollNewMessages, 1500);
    }

    function updateScrollButton(){
        if (!scrollBottomBtn) return;
        var nearBottom = chatWindow.scrollHeight - chatWindow.scrollTop - chatWindow.clientHeight < 80;
        scrollBottomBtn.style.display = nearBottom ? 'none' : 'flex';
    }
    chatWindow.addEventListener('scroll', updateScrollButton);
    scrollBottomBtn?.addEventListener('click', function(){ chatWindow.scrollTop = chatWindow.scrollHeight; updateScrollButton(); });

    // typing indicator throttling
    let typingHideTimeout = null;
    function throttleHideTyping(){
        if (typingHideTimeout) clearTimeout(typingHideTimeout);
        typingHideTimeout = setTimeout(function(){ if (typingIndicator) typingIndicator.style.display='none'; }, 900);
    }

    if (selectedCompanyId) {
        loadConversation(selectedCompanyId);
    }
    pollNewMessages();
    
    // Company Selection State Management
    let currentSelectedCompanyId = selectedCompanyId;
    
    // Function to update chat header with company info
    function updateChatHeader(companyId, companyName, companyLogo) {
        const headerAvatar = document.getElementById('chat-header-avatar');
        const headerTitle = document.getElementById('chat-header-title');
        const headerSubtitle = document.getElementById('chat-header-subtitle');
        
        if (companyId && companyName) {
            // Update selected company variables
            selectedCompanyId = companyId;
            currentSelectedCompanyId = companyId;
            
            // Update header title
            headerTitle.textContent = companyName;
            headerSubtitle.textContent = 'Company conversation';
            
            // Update avatar
            headerAvatar.innerHTML = '';
            if (companyLogo) {
                const img = document.createElement('img');
                img.src = companyLogo;
                img.alt = companyName;
                img.loading = 'lazy';
                headerAvatar.appendChild(img);
            } else {
                headerAvatar.textContent = companyName.charAt(0).toUpperCase();
            }
            
            // Update form hidden field
            const companyInput = document.getElementById('company-id-input');
            if (companyInput) {
                companyInput.value = companyId;
            }
        } else {
            // Reset to default (no company selected)
            headerTitle.textContent = 'Admin Support';
            headerSubtitle.textContent = 'Select a company to start chatting';
            
            headerAvatar.innerHTML = '<i class="bi bi-headset"></i>';
            
            if (document.getElementById('company-id-input')) {
                document.getElementById('company-id-input').value = '';
            }
            
            currentSelectedCompanyId = null;
        }
    }
    
    // Function to highlight selected company in explorer
    function highlightSelectedCompany(companyId) {
        document.querySelectorAll('.explorer-item').forEach(item => {
            if (item.dataset.companyId === companyId) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });
    }
    
    // Explorer: clicking an item selects company for chat
    document.querySelectorAll('.explorer-item').forEach(function(item){
        item.addEventListener('click', function(e){
            const companyId = this.dataset.companyId;
            const companyName = this.dataset.companyName;
            const companyLogo = this.dataset.companyLogo;
            
            if (!companyId) return;
            
            // Update selected company variables
            selectedCompanyId = companyId;
            currentSelectedCompanyId = companyId;
            
            // Update form hidden field for message sending
            const companyInput = document.getElementById('company-id-input');
            if (companyInput) {
                companyInput.value = companyId;
            }
            
            // Update chat header with company info
            updateChatHeader(companyId, companyName, companyLogo);
            
            // Highlight selected company
            highlightSelectedCompany(companyId);
            
            // Load conversation history for selected company
            loadConversation(companyId);
        });
    });
    
    // Initialize: highlight the currently selected company
    if (currentSelectedCompanyId) {
        highlightSelectedCompany(currentSelectedCompanyId);
    }
    
    // Delete Modal Elements
    var deleteModal = document.getElementById('delete-modal');
    var deleteModalClose = document.getElementById('delete-modal-close');
    var deleteCancelBtn = document.getElementById('delete-cancel-btn');
    var deleteConfirmBtn = document.getElementById('delete-confirm-btn');
    var pendingDeleteMsgId = null;
    var pendingDeleteBtn = null;
    
    function showDeleteModal(msgId, btn) {
        pendingDeleteMsgId = msgId;
        pendingDeleteBtn = btn;
        deleteModal.classList.add('show');
    }
    
    function hideDeleteModal() {
        deleteModal.classList.remove('show');
        pendingDeleteMsgId = null;
        pendingDeleteBtn = null;
    }
    
    // Close modal handlers
    if (deleteModalClose) {
        deleteModalClose.addEventListener('click', hideDeleteModal);
    }
    if (deleteCancelBtn) {
        deleteCancelBtn.addEventListener('click', hideDeleteModal);
    }
    
    // Click outside modal to close
    if (deleteModal) {
        deleteModal.addEventListener('click', function(e) {
            if (e.target === deleteModal) {
                hideDeleteModal();
            }
        });
    }
    
    // Confirm delete handler
    if (deleteConfirmBtn) {
        deleteConfirmBtn.addEventListener('click', function() {
            if (pendingDeleteMsgId) {
                fetch("{% url 'delete_message' 0 %}".replace("0", pendingDeleteMsgId), {
                    method: "POST",
                    headers: { 'X-CSRFToken': getCSRFToken() },
                    credentials: 'same-origin'
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        var row = pendingDeleteBtn ? pendingDeleteBtn.closest('.wa-message-row') : null;
                        if (row) row.remove();
                    } else {
                        showErrorModal(data.error, 'Error');
                    }
                    hideDeleteModal();
                })
                .catch(err => {
                    console.error('Delete error:', err);
                    hideDeleteModal();
                });
            }
        });
    }
    
    // Delete message handler (delegated event for dynamically loaded messages)
    document.addEventListener('click', function(e) {
        var btn = e.target.closest('.wa-delete-btn');
        if (btn) {
            var msgId = btn.getAttribute('data-msg-id');
            showDeleteModal(msgId, btn);
        }
    });

    // Error/Info Modal handlers
    var errorModal = document.getElementById('error-modal');
    var errorModalClose = document.getElementById('error-modal-close');
    var errorModalTitle = document.getElementById('error-modal-title');
    var errorModalMessage = document.getElementById('error-modal-message');
    var errorModalOk = document.getElementById('error-modal-ok');

    function showErrorModal(message, title) {
        if (errorModalTitle) errorModalTitle.textContent = title || 'Notice';
        if (errorModalMessage) errorModalMessage.textContent = message;
        if (errorModal) errorModal.classList.add('show');
    }

    function hideErrorModal() {
        if (errorModal) errorModal.classList.remove('show');
    }

    if (errorModalClose) errorModalClose.addEventListener('click', hideErrorModal);
    if (errorModalOk) errorModalOk.addEventListener('click', hideErrorModal);
    if (errorModal) {
        errorModal.addEventListener('click', function(e) {
            if (e.target === errorModal) hideErrorModal();
        });
    }
});
</script>

{% endblock %}
