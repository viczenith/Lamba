{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="light" style="color-scheme: light;">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>{% block title %}{% if request.user.is_authenticated and request.user.company_profile and request.user.company_profile.company_name %}{{ request.user.company_profile.company_name }} - Lamba {% else %}Lamba{% endif %}{% endblock %}</title>
  <meta name="description" content="">
  <meta name="keywords" content="">

  <!-- Favicons -->
  <link href="{% static 'assets/img/favicon.png' %}" rel="icon">
  <link href="{% static 'assets/img/apple-touch-icon.png' %}" rel="apple-touch-icon">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- Local vendor CSS (used as a CSP-friendly fallback) -->
  <link href="{% static 'vendor/css/font-awesome-all.min.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/css/bootstrap-icons.css' %}" rel="stylesheet">

  <!-- Fonts (Inter for Apple-like typography) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- CSS Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.bubble.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/style.css" rel="stylesheet">
  <link href="{% static 'assets/css/style.css' %}" rel="stylesheet">

  <!-- Global Theme Variables -->
  <style>
    :root {
      --bg-color: #f5f5f7;
      --text-color: #1a1a1a;
      --sidebar-bg: #ffffff;
      --sidebar-text: #1a1a1a;
      --nav-bg: transparent;
      --nav-text: #1a1a1a;
      --nav-hover-bg: rgba(0, 0, 0, 0.05);
      --nav-hover-text: #1a1a1a;
      --nav-active-bg: rgba(0, 122, 255, 0.1);
      --nav-active-text: #007aff;
      --card-bg: #ffffff;
      --card-text: #1a1a1a;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      --badge-bg: #34c759;
      --theme-toggle-bg: #ffffff;
      --theme-toggle-border: #e0e0e0;
      --theme-toggle-active: #007aff;
      --transition: all 0.3s ease;
    }

    [data-theme="dark"] {
      --bg-color: #121212;
      --text-color: #ffffff;
      --sidebar-bg: #1e1e1e;
      --sidebar-text: #ffffff;
      --nav-bg: #252525;
      --nav-text: #ffffff;
      --nav-hover-bg: rgba(255, 255, 255, 0.1);
      --nav-hover-text: #ffffff;
      --nav-active-bg: rgba(10, 132, 255, 0.2);
      --nav-active-text: #0a84ff;
      --card-bg: #252525;
      --card-text: #ffffff;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      --badge-bg: #30d158;
      --theme-toggle-bg: #252525;
      --theme-toggle-border: #444;
      --theme-toggle-active: #0a84ff;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Inter', sans-serif;
      transition: var(--transition);
    }

    /* Global Navigation Styles */
    .sidebar {
      background-color: var(--sidebar-bg);
      color: var(--sidebar-text);
      transition: var(--transition);
    }

    .sidebar-nav .nav-link {
      background-color: var(--nav-bg);
      color: var(--nav-text);
      transition: var(--transition);
    }

    .sidebar-nav .nav-link:hover {
      background-color: var(--nav-hover-bg);
      color: var(--nav-hover-text);
    }

    .sidebar-nav .nav-link.active {
      background-color: var(--nav-active-bg);
      color: var(--nav-active-text);
    }

    /* Cards and Containers */
    .card {
      background-color: var(--card-bg);
      color: var(--card-text);
      box-shadow: var(--card-shadow);
      transition: var(--transition);
    }

    /* Badges */
    .badge {
      background-color: var(--badge-bg);
      transition: var(--transition);
    }

    /* Theme Toggle Base Styles */
    .theme-toggle {
      background-color: var(--theme-toggle-bg);
      border-color: var(--theme-toggle-border);
      transition: var(--transition);
    }

    .theme-btn {
      color: var(--text-color);
      transition: var(--transition);
    }

    .theme-btn.active {
      background-color: var(--theme-toggle-active);
      color: white;
    }

    /* Animations */
    .badge.pulse {
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        top: 0;
        left: -250px;
        width: 250px;
        height: 100%;
        transition: left 0.3s ease;
      }
      .sidebar.active {
        left: 0;
      }
    }
  </style>

  {% block extra_css %}
  {% endblock %}
</head>

<body>
  <!-- Sidebar -->
  {% include 'header.html' %}
  {% include 'admin_component/admin_sidebar.html' %}

  {% if subscription_has_alerts %}
    {% include "alerts/alert_center.html" %}
  {% endif %}

  <!-- Main -->
  {% block content %}
  <main id="main" class="main">
  </main>
  {% endblock %}

  <!-- Footer muted for now -->
  <!-- {% include 'footer.html' %} -->

  <!-- Back-to-top -->
  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- JS Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.40.0/dist/apexcharts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.3/dist/chart.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/tinymce@6.7.0/tinymce.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/twbs/form-validation/dist/js/validate.min.js"></script>
  <script src="{% static 'assets/js/main.js' %}"></script>

  <script src="{% static 'js/alerts.js' %}"></script>

  {# Floating subscription button + modal (does NOT affect layout/scroll). #}
  {% if plan_usage %}
    {% if plan_usage.any_exhausted or plan_usage.any_near_limit or plan_usage.subscription.is_read_only_mode or plan_usage.subscription.is_trial %}
      <style>
        #subscription-fab {
          position: fixed;
          top: 90px;
          right: 22px;
          z-index: 2147483000;
          cursor: grab;
          user-select: none;
        }

        #subscription-fab.dragging {
          cursor: grabbing;
        }

        #subscription-fab .fab-btn {
          border-radius: 999px;
          box-shadow: var(--card-shadow);
          border: 1px solid rgba(0, 0, 0, 0.06);
          padding: 10px 14px;
          font-weight: 700;
          display: inline-flex;
          align-items: center;
          gap: 10px;
          white-space: nowrap;
        }

        #subscription-fab .fab-dot {
          width: 10px;
          height: 10px;
          border-radius: 50%;
          display: inline-block;
          background: var(--badge-bg);
        }

        #subscription-fab .fab-sub {
          font-size: 12px;
          opacity: 0.9;
          font-weight: 600;
        }

        @media (max-width: 576px) {
          #subscription-fab {
            top: 80px;
            right: 14px;
          }
        }
      </style>

      <div
        id="subscription-fab"
        data-company-id="{% if request.user.is_authenticated and request.user.company_profile %}{{ request.user.company_profile.id }}{% endif %}"
      >
        {% comment %}
          Severity mapping:
          - danger: exhausted OR read-only OR trial <= 1
          - warning: near limit OR trial <= 3
          - primary: trial <= 7 (info-ish)
        {% endcomment %}
        {% with d=plan_usage.subscription.trial_days_remaining %}
          {% if plan_usage.any_exhausted or plan_usage.subscription.is_read_only_mode or d != None and d <= 1 %}
            {% with btn_class="btn-danger" dot_class="bg-light" label="Action required" %}
              <button type="button" class="btn fab-btn {{ btn_class }}" id="subscriptionFabButton" aria-label="Subscription status" data-bs-toggle="modal" data-bs-target="#subscriptionUsageModal">
                <span class="fab-dot {{ dot_class }}"></span>
                <span>Subscription</span>
                <span class="fab-sub">{{ label }}</span>
              </button>
            {% endwith %}
          {% elif plan_usage.any_near_limit or d != None and d <= 3 %}
            {% with btn_class="btn-warning" dot_class="bg-dark" label="Near limit" %}
              <button type="button" class="btn fab-btn {{ btn_class }}" id="subscriptionFabButton" aria-label="Subscription status" data-bs-toggle="modal" data-bs-target="#subscriptionUsageModal">
                <span class="fab-dot {{ dot_class }}"></span>
                <span>Subscription</span>
                <span class="fab-sub">{{ label }}</span>
              </button>
            {% endwith %}
          {% elif d != None and d <= 7 %}
            {% with btn_class="btn-primary" dot_class="bg-light" label="Trial" %}
              <button type="button" class="btn fab-btn {{ btn_class }}" id="subscriptionFabButton" aria-label="Subscription status" data-bs-toggle="modal" data-bs-target="#subscriptionUsageModal">
                <span class="fab-dot {{ dot_class }}"></span>
                <span>Subscription</span>
                <span class="fab-sub">{{ label }}</span>
              </button>
            {% endwith %}
          {% else %}
            {% with btn_class="btn-primary" dot_class="bg-light" label="Details" %}
              <button type="button" class="btn fab-btn {{ btn_class }}" id="subscriptionFabButton" aria-label="Subscription status" data-bs-toggle="modal" data-bs-target="#subscriptionUsageModal">
                <span class="fab-dot {{ dot_class }}"></span>
                <span>Subscription</span>
                <span class="fab-sub">{{ label }}</span>
              </button>
            {% endwith %}
          {% endif %}
        {% endwith %}
      </div>

      <div class="modal fade" id="subscriptionUsageModal" tabindex="-1" aria-labelledby="subscriptionUsageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content" style="border-radius: 16px; overflow: hidden;">
            <div class="modal-header">
              <div>
                <h5 class="modal-title" id="subscriptionUsageModalLabel">Subscription &amp; Plan Usage</h5>
                <div class="text-muted" style="font-size: 13px;">
                  {% if plan_usage.plan.name %}{{ plan_usage.plan.name }}{% else %}{{ plan_usage.plan.tier|default:"" }}{% endif %}
                  {% if plan_usage.subscription.status %} • {{ plan_usage.subscription.status|title }}{% endif %}
                  {% if plan_usage.subscription.is_trial and plan_usage.subscription.trial_days_remaining != None %} • {{ plan_usage.subscription.trial_days_remaining }} day(s) left{% endif %}
                </div>
              </div>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              {% if plan_usage.subscription.is_read_only_mode %}
                <div class="alert alert-danger" role="alert">
                  <strong>Read-only mode is active.</strong> Creation actions are blocked until your subscription is renewed/upgraded.
                </div>
              {% endif %}

              {% if plan_usage.any_exhausted %}
                <div class="alert alert-danger" role="alert">
                  <strong>Plan limit reached:</strong> one or more features are exhausted.
                </div>
              {% elif plan_usage.any_near_limit %}
                <div class="alert alert-warning" role="alert">
                  <strong>Approaching limits:</strong> you’re close to exhausting one or more plan features.
                </div>
              {% endif %}

              <div class="row g-3">
                {% for _k, v in plan_usage.limits.items %}
                  <div class="col-md-6">
                    <div class="p-3" style="border-radius: 12px; border: 1px solid rgba(0,0,0,0.08); background: var(--card-bg);">
                      <div class="d-flex align-items-center justify-content-between">
                        <div class="fw-semibold">{{ v.label }}</div>
                        {% if v.is_unlimited %}
                          <span class="badge bg-primary">Unlimited</span>
                        {% elif v.is_exhausted %}
                          <span class="badge bg-danger">Exhausted</span>
                        {% elif v.is_near_limit %}
                          <span class="badge bg-warning text-dark">Near limit</span>
                        {% else %}
                          <span class="badge bg-success">OK</span>
                        {% endif %}
                      </div>

                      <div class="mt-2 text-muted">
                        {% if v.is_unlimited %}
                          Used {{ v.used }}
                        {% else %}
                          Used {{ v.used }} / {{ v.limit }}
                        {% endif %}
                      </div>

                      {% if not v.is_unlimited %}
                        <div class="progress mt-2" style="height: 10px; border-radius: 999px;">
                          <div
                            class="progress-bar {% if v.is_exhausted %}bg-danger{% elif v.is_near_limit %}bg-warning{% else %}bg-success{% endif %}"
                            role="progressbar"
                            style="width: {{ v.usage_percent|default:0 }}%;">
                          </div>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
            <div class="modal-footer">
              <a class="btn btn-primary" href="{% url 'company-profile' %}?tab=billing">Upgrade / Manage Subscription</a>
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const fab = document.getElementById('subscription-fab');
          if (!fab) return;

          const fabButton = document.getElementById('subscriptionFabButton');
          const modalEl = document.getElementById('subscriptionUsageModal');
          const openModal = () => {
            if (!modalEl) return;
            // Bootstrap 5 preferred path
            if (window.bootstrap && typeof window.bootstrap.Modal === 'function') {
              window.bootstrap.Modal.getOrCreateInstance(modalEl).show();
              return;
            }
            // Very defensive fallback (shouldn't be needed if bootstrap.bundle is loaded)
            modalEl.classList.add('show');
            modalEl.style.display = 'block';
            document.body.classList.add('modal-open');
          };

          const companyId = fab.getAttribute('data-company-id') || 'global';
          const storageKey = `subscriptionFabPos:${companyId}`;

          // Restore position
          try {
            const raw = localStorage.getItem(storageKey);
            if (raw) {
              const pos = JSON.parse(raw);
              if (typeof pos?.left === 'number' && typeof pos?.top === 'number') {
                fab.style.left = `${pos.left}px`;
                fab.style.top = `${pos.top}px`;
                fab.style.right = 'auto';
              }
            }
          } catch (e) {
            // ignore
          }

          let dragCandidate = false;
          let dragging = false;
          let didDrag = false;
          let startX = 0;
          let startY = 0;
          let startLeft = 0;
          let startTop = 0;
          const DRAG_THRESHOLD_PX = 6;

          const clamp = (value, min, max) => Math.max(min, Math.min(max, value));

          const onPointerDown = (e) => {
            // Mark as a potential drag; only start actual dragging after threshold.
            // This avoids swallowing a normal click (which should open the modal).
            dragCandidate = true;
            didDrag = false;

            const rect = fab.getBoundingClientRect();
            startX = e.clientX;
            startY = e.clientY;
            startLeft = rect.left;
            startTop = rect.top;
          };

          const onPointerMove = (e) => {
            if (!dragCandidate && !dragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;

            if (!dragging) {
              if (Math.abs(dx) + Math.abs(dy) < DRAG_THRESHOLD_PX) return;
              dragging = true;
              didDrag = true;
              fab.classList.add('dragging');
              fab.setPointerCapture?.(e.pointerId);

              // Switch to left/top positioning for dragging
              fab.style.left = `${startLeft}px`;
              fab.style.top = `${startTop}px`;
              fab.style.right = 'auto';
            }

            const maxLeft = window.innerWidth - fab.offsetWidth - 8;
            const maxTop = window.innerHeight - fab.offsetHeight - 8;

            const nextLeft = clamp(startLeft + dx, 8, maxLeft);
            const nextTop = clamp(startTop + dy, 8, maxTop);

            fab.style.left = `${nextLeft}px`;
            fab.style.top = `${nextTop}px`;
          };

          const onPointerUp = () => {
            dragCandidate = false;
            if (!dragging) return;
            dragging = false;
            fab.classList.remove('dragging');

            try {
              const rect = fab.getBoundingClientRect();
              localStorage.setItem(storageKey, JSON.stringify({ left: rect.left, top: rect.top }));
            } catch (e) {
              // ignore
            }
          };

          fab.addEventListener('pointerdown', onPointerDown);
          window.addEventListener('pointermove', onPointerMove);
          window.addEventListener('pointerup', onPointerUp);

          // Ensure click always opens modal (even if Bootstrap data attributes fail)
          if (fabButton) {
            fabButton.addEventListener('click', (e) => {
              if (didDrag) {
                e.preventDefault();
                e.stopPropagation();
                return;
              }
              openModal();
            });
          } else {
            // Fallback: clicking anywhere on the wrapper should open when not dragging
            fab.addEventListener('click', (e) => {
              if (didDrag) {
                e.preventDefault();
                e.stopPropagation();
                return;
              }
              openModal();
            });
          }

          // Keep FAB from visually sitting on top of the modal
          if (modalEl) {
            modalEl.addEventListener('show.bs.modal', () => {
              fab.style.zIndex = '1040';
            });
            modalEl.addEventListener('hidden.bs.modal', () => {
              fab.style.zIndex = '';
            });
          }
        });
      </script>
    {% endif %}
  {% endif %}

  <!-- Theme Switching Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Force light theme and remove theme toggle functionality
      const theme = 'light';
      const html = document.documentElement;
      
      // Always set light theme
      html.setAttribute('data-theme', 'light');
      document.body.style.backgroundColor = '#f5f5f7';
      document.body.style.color = '#1a1a1a';
      
      // Remove theme toggle button if it exists
      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) {
        themeToggle.style.display = 'none';
      }
    });
  </script>

  {% block extra_js %}
  {% endblock %}
</body>
</html>