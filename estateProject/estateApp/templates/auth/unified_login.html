{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lamba - Secure Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        *{box-sizing:border-box}
        html,body{height:100%;margin:0;padding:0}
        body{font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;position:relative;overflow:hidden}
        .bg-shapes{position:fixed;inset:0;z-index:0;overflow:hidden}
        .shape{position:absolute;border-radius:50%;background:rgba(255,255,255,0.08);animation:float 20s infinite ease-in-out}
        .shape:nth-child(1){width:80px;height:80px;top:8%;left:8%}
        .shape:nth-child(2){width:120px;height:120px;top:72%;left:82%}
        .shape:nth-child(3){width:60px;height:60px;top:42%;left:86%}
        @keyframes float{0%,100%{transform:translateY(0) rotate(0);opacity:.3}50%{transform:translateY(-30px) rotate(180deg);opacity:.6}}
        .main-container{position:relative;z-index:1;width:100%;max-width:420px;margin:auto}
        .card-container{background:rgba(255,255,255,0.98);border-radius:20px;padding:2.5rem;backdrop-filter:blur(8px);box-shadow:0 20px 60px rgba(0,0,0,0.15)}
        .logo-box{width:74px;height:74px;margin:0 auto 1rem;border-radius:18px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);box-shadow:0 10px 30px rgba(102,126,234,0.25)}
        .logo-box i{color:#fff;font-size:1.6rem}
        h1{font-size:1.5rem;text-align:center;margin-bottom:.25rem;color:#0f172a;font-weight:800}
        p.lead{color:#64748b;text-align:center;margin-bottom:1.5rem;font-size:.95rem}
        .form-label{font-weight:600;color:#334155;margin-bottom:.5rem;font-size:.9rem}
        .input-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#94a3b8;z-index:10}
        .form-control,.form-select{padding:.75rem 1rem .75rem 3rem !important;border-radius:12px;height:48px;border:1px solid #e6edf6;font-size:.95rem;transition:all .3s ease;background:#f8fafc}
        .form-control:focus,.form-select:focus{box-shadow:0 0 0 4px rgba(102,126,234,0.08);border-color:#667eea;background:#fff;outline:none}
        .form-control::placeholder{color:#94a3b8}
        .btn-login,.btn-register{width:100%;height:48px;border-radius:12px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:0;color:#fff;font-weight:700;font-size:1rem;cursor:pointer;transition:all .3s ease;box-shadow:0 10px 25px rgba(102,126,234,0.3);letter-spacing:.5px}
        .btn-login:hover,.btn-register:hover{transform:translateY(-2px);box-shadow:0 15px 35px rgba(102,126,234,0.4); color: white;}
        .btn-login:active,.btn-register:active{transform:translateY(0)}
        .btn-login.loading,.btn-register.loading{opacity:.7;pointer-events:none}
        .btn-secondary-action{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%);border:none;color:#fff;padding:.65rem 1.25rem;border-radius:12px;font-weight:700;font-size:.95rem;cursor:pointer;transition:all .3s;width:100%;margin-top:1rem;box-shadow:0 8px 25px rgba(17,153,142,.3);letter-spacing:.3px}
        .btn-secondary-action:hover{transform:translateY(-2px);box-shadow:0 12px 35px rgba(17,153,142,.4)}
        .btn-secondary-action:active{transform:translateY(0)}
        .btn-secondary-action i{margin-right:.5rem}
        .form-options{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;font-size:.9rem}
        .form-check{display:flex;align-items:center}
        .form-check-input{width:18px;height:18px;margin-right:.5rem;cursor:pointer;border:1px solid #cbd5e1;border-radius:4px;accent-color:#667eea}
        .form-check-label{color:#475569;cursor:pointer;font-weight:500;margin:0}
        .forgot{color:#667eea;text-decoration:none;font-weight:600;transition:color .3s}
        .forgot:hover{color:#764ba2}
        .alert{border-radius:12px;padding:1rem 1.25rem;margin-bottom:1.5rem;border:none;font-size:.9rem;display:flex;align-items:center;gap:.75rem;animation:slideUp .3s ease-out}
        .alert-danger{background:linear-gradient(135deg,rgba(235,51,73,.1) 0%,rgba(244,92,67,.05) 100%);color:#dc2626;border-left:4px solid #ef4444}
        .alert-success{background:linear-gradient(135deg,rgba(17,153,142,.1) 0%,rgba(56,239,125,.05) 100%);color:#059669;border-left:4px solid #10b981}
        .alert i{font-size:1.2rem}
        @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
        .security-badge{display:inline-flex;align-items:center;background:#f1f5f9;padding:.5rem 1rem;border-radius:8px;color:#475569;margin-top:1rem;font-size:.85rem}
        .security-badge i{color:#10b981;margin-right:.5rem}
        .signup-link{color:#636e72;text-align:center;margin-top:1.5rem;font-size:.9rem}
        .signup-link a{color:#11998e;text-decoration:underline;font-weight:700;cursor:pointer;transition:all .3s}
        .signup-link a:hover{color:#38ef7d;text-decoration-thickness:2px}
        .password-eye{position:absolute;right:12px;top:50%;transform:translateY(-50%);cursor:pointer;color:#94a3b8;font-size:1.1rem;background:none;border:none;padding:6px;z-index:10;transition:all .3s}
        .password-eye:hover{color:#667eea;transform:translateY(-50%) scale(1.1)}
        .hidden{display:none !important}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem}
        .form-row.full{grid-column:1/-1}
        .radio-group{display:flex;gap:2rem;margin:1.5rem 0}
        .radio-option{flex:1;position:relative}
        .radio-option input{position:absolute;opacity:0;cursor:pointer}
        .radio-label{display:flex;align-items:center;justify-content:center;padding:1rem;border:2px solid #e6edf6;border-radius:12px;cursor:pointer;transition:all .3s;background:#f8fafc;font-weight:600;color:#475569}
        .radio-option input:checked+.radio-label{border-color:#667eea;background:linear-gradient(135deg,rgba(102,126,234,.1) 0%,rgba(118,75,162,.05) 100%);color:#667eea}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px);animation:fadeIn .3s ease-out;padding:20px;box-sizing:border-box}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .modal-content{background:#fff;border-radius:20px;padding:2rem;max-height:90vh;overflow-y:auto;overflow-x:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);animation:slideUp .3s ease-out;position:relative;max-width:500px;width:100%;box-sizing:border-box}
        .modal-content *{box-sizing:border-box;max-width:100%}
        @media(min-width:992px){.card-container{max-width:720px}.modal-content{max-width:1100px;padding:2.5rem}}
        @media(min-width:1200px){.card-container{max-width:850px}.modal-content{max-width:1150px;padding:2.5rem}}
        @media(min-width:1400px){.card-container{max-width:900px}.modal-content{max-width:1200px;padding:3rem}}
        .form-error{color:#dc2626;font-size:.85rem;margin-top:.5rem;margin-left:50px;display:none;animation:shake .3s ease-in-out}
        .form-error.show{display:block}
        @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
        .btn-login.spinning,.btn-register.spinning{pointer-events:none;opacity:.8}
        .btn-login.spinning::after,.btn-register.spinning::after{content:'';position:absolute;width:16px;height:16px;border:3px solid rgba(255,255,255,.3);border-top-color:white;border-radius:50%;animation:spin .6s linear infinite;top:50%;left:50%;margin:-8px 0 0 -8px}
        .radio-description{font-size:.8rem;color:#64748b;margin-top:.25rem;font-style:italic}
        .modal-close{position:absolute;top:1rem;right:1rem;background:none;border:none;font-size:1.5rem;color:#94a3b8;cursor:pointer;transition:color .3s}
        .modal-close:hover{color:#667eea}
        .modal-header{text-align:center;margin-bottom:1.5rem;border-bottom:1px solid #e6edf6;padding-bottom:1rem}
        .modal-header h2{font-size:1.5rem;margin:0;color:#0f172a;font-weight:800}
        
        /* Hide Scrollbars but Keep Functionality */
        .modal-content::-webkit-scrollbar{width:8px;height:8px}
        .modal-content::-webkit-scrollbar-track{background:transparent}
        .modal-content::-webkit-scrollbar-thumb{background:rgba(0,0,0,.1);border-radius:10px}
        .modal-content::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,.2)}
        body::-webkit-scrollbar{width:10px}
        body::-webkit-scrollbar-track{background:#f1f5f9}
        body::-webkit-scrollbar-thumb{background:rgba(102,126,234,.3);border-radius:10px}
        body::-webkit-scrollbar-thumb:hover{background:rgba(102,126,234,.5)}
        
        /* GitHub-Inspired Subscription Plan Styling with Enhanced Selection */
        input[name="subscription_tier"]{cursor:pointer !important}
        input[name="subscription_tier"]:checked+label{
            border-color:#667eea !important;
            border-width:3px !important;
            box-shadow:0 12px 32px rgba(102,126,234,.35),0 0 0 4px rgba(102,126,234,.15) !important;
            transform:translateY(-6px) scale(1.02) !important;
            background:#f8faff !important;
        }
        input[name="subscription_tier"]:checked+label > div:first-child{background:#f0f4ff !important}
        input[name="subscription_tier"]:checked+label h4{color:#667eea !important}
        input[name="subscription_tier"]:checked+label::after{
            content:'✓ Selected';
            position:absolute;
            top:1rem;
            right:1rem;
            background:#10b981;
            color:white;
            padding:.4rem .75rem;
            border-radius:20px;
            font-size:.75rem;
            font-weight:700;
            animation:scaleIn .3s ease-out;
        }
        @keyframes scaleIn{
            from{transform:scale(0);opacity:0}
            to{transform:scale(1);opacity:1}
        }
        input[name="subscription_tier"]+label:hover{
            border-color:#a5b4fc !important;
            transform:translateY(-2px) !important;
            box-shadow:0 6px 20px rgba(0,0,0,.12) !important;
        }
        input[name="subscription_tier"]:focus+label{outline:2px solid #667eea;outline-offset:2px}
        
        /* Enterprise Plan Preferred Badge Animation */
        input[name="subscription_tier"][value="enterprise"]:checked+label > div:first-child{
            animation:pulseGradient 2s ease-in-out infinite;
        }
        @keyframes pulseGradient{
            0%,100%{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
            50%{background:linear-gradient(135deg,#764ba2 0%,#667eea 100%)}
        }
        
        /* Desktop large screens */
        @media(min-width:1400px){
            .modal-overlay{padding:25px}
        }
        
        /* Tablet Responsiveness */
        @media(max-width:1200px){
            .modal-content{max-width:95vw !important;padding:2rem;overflow-x:hidden}
            .modal-overlay{padding:15px}
        }
        
        @media(max-width:992px){
            /* Stack plans vertically on tablets */
            .modal-content{max-width:90vw !important;padding:1.75rem;overflow-x:hidden}
            .modal-overlay{padding:10px}
            input[name="subscription_tier"]:checked+label::after{top:.75rem;right:.75rem;font-size:.7rem;padding:.35rem .6rem}
        }
        
        @media(max-width:768px){
            /* Tablet and small screens */
            .card-container{padding:1.5rem;max-width:95vw}
            .modal-content{padding:1.5rem;border-radius:16px;max-width:95vw !important;overflow-x:hidden}
            .modal-overlay{padding:8px}
            .modal-header h2{font-size:1.35rem}
        }
        
        @media(max-width:576px){
            .card-container{padding:1.75rem}
            .form-row{grid-template-columns:1fr}
            .radio-group{flex-direction:column}
            .modal-content{border-radius:16px;max-width:95vw;padding:1.5rem}
            .modal-header h2{font-size:1.25rem}
            .form-row-custom{grid-template-columns:1fr}
            .modal-overlay{padding:10px}
            .password-eye{right:8px;padding:4px}
            
            /* Adjust plan cards for mobile */
            input[name="subscription_tier"]+label > div{padding:1.25rem 1rem !important}
            input[name="subscription_tier"]+label h4{font-size:1.1rem !important}
            input[name="subscription_tier"]+label span[style*="font-size:2.25rem"]{font-size:1.75rem !important}
        }

        /* ROLE SELECTION MODAL STYLES */
        .role-selection-grid {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .role-option {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8fafc;
        }

        .role-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .role-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .role-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .role-details {
            flex: 1;
        }

        .role-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .role-name {
            color: #475569;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .role-company {
            color: #64748b;
            font-size: 0.8rem;
            font-style: italic;
        }

        .role-radio {
            margin-left: 1rem;
        }

        .radio-indicator {
            width: 20px;
            height: 20px;
            border: 2px solid #cbd5e1;
            border-radius: 50%;
            position: relative;
            transition: all 0.2s;
        }

        .role-option.selected .radio-indicator {
            border-color: #667eea;
            background: #667eea;
        }

        .role-option.selected .radio-indicator::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
        }

        #roleSelectBtn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
    </style>
</head>
<body>
    <div class="bg-shapes">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>

    <div class="main-container">
        <!-- LOGIN SECTION -->
        <div id="loginSection" class="card-container">
            <div class="logo-box"><i class="fas fa-shield-halved"></i></div>
            <h1>Lamba Login</h1>
            <p class="lead">Secure access for Company Admins, Clients & Marketers</p>

            {% if messages %}
                {% for message in messages %}
                    <div class="alert {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'success' %}alert-success{% else %}alert-info{% endif %}">
                        <i class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% elif message.tags == 'success' %}fa-check-circle{% else %}fa-info-circle{% endif %}"></i>
                        <span>{{ message }}</span>
                    </div>
                {% endfor %}
            {% endif %}

            {% if multiple_users %}
                <!-- ROLE SELECTION MODAL -->
                <div id="roleSelectionModal" class="modal-overlay" style="display: flex;">
                    <div class="modal-content">
                        <button class="modal-close" onclick="window.location.reload()"><i class="fas fa-times"></i></button>
                        <div class="modal-header">
                            <h2><i class="fas fa-users"></i> Select Your Account</h2>
                            <p style="color:#64748b;font-size:.9rem;margin-top:.5rem">Multiple accounts found for {{ user_email }}</p>
                        </div>

                        <form method="post" action="{% if login_slug %}{% url 'tenant-login' login_slug %}{% else %}{% url 'login' %}{% endif %}" id="roleSelectionForm">
                            {% csrf_token %}
                            <input type="hidden" name="user_email" value="{{ user_email }}">
                            <input type="hidden" name="selected_user_id" id="selectedUserId" value="">

                            <div style="margin-bottom: 1.5rem;">
                                <p style="color:#475569;font-size:.95rem;margin-bottom:1rem;text-align:center">
                                    <i class="fas fa-info-circle" style="color:#667eea;margin-right:.5rem"></i>
                                    You have multiple accounts with this email. Please select which account you'd like to access:
                                </p>

                                <div class="role-selection-grid">
                                    {% for user in multiple_users %}
                                        <div class="role-option" data-user-id="{{ user.id }}" onclick="selectRole(this, '{{ user.id }}')">
                                            <div class="role-icon">
                                                {% if user.role == 'admin' %}
                                                    <i class="fas fa-user-shield"></i>
                                                {% elif user.role == 'client' %}
                                                    <i class="fas fa-user"></i>
                                                {% elif user.role == 'marketer' %}
                                                    <i class="fas fa-handshake"></i>
                                                {% elif user.role == 'support' %}
                                                    <i class="fas fa-headset"></i>
                                                {% endif %}
                                            </div>
                                            <div class="role-details">
                                                <div class="role-title">{{ user.get_role_display|title }}</div>
                                                <div class="role-name">{{ user.full_name }}</div>
                                                {% if user.company_profile %}
                                                    <div class="role-company">{{ user.company_profile.company_name }}</div>
                                                {% endif %}
                                            </div>
                                            <div class="role-radio">
                                                <input type="radio" name="selected_role" value="{{ user.id }}" style="display: none;">
                                                <div class="radio-indicator"></div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <button type="submit" class="btn btn-login" id="roleSelectBtn" disabled>
                                <i class="fas fa-sign-in-alt"></i> Continue to Account
                            </button>
                        </form>
                    </div>
                </div>
            {% endif %}

            <form method="post" id="loginForm" action="{% if login_slug %}{% url 'tenant-login' login_slug %}{% else %}{% url 'login' %}{% endif %}" novalidate>
                {% csrf_token %}
                <input type="text" name="{{ honeypot_field|default:'honeypot' }}" value="" autocomplete="off" tabindex="-1" style="position:absolute;left:-9999px;opacity:0;pointer-events:none" aria-hidden="true">
                <input type="hidden" name="client_public_ip" id="client_public_ip" value="">

                <div class="mb-3" style="position:relative">
                    <label class="form-label" for="id_email">Email Address</label>
                    <i class="fa fa-envelope input-icon"></i>
                    <input id="id_email" name="username" type="email" class="form-control" placeholder="admin@example.com" required autofocus autocomplete="email">
                </div>

                <div class="mb-3" style="position:relative">
                    <label class="form-label" for="id_password">Password</label>
                    <i class="fa fa-lock input-icon"></i>
                    <input id="id_password" name="password" type="password" class="form-control" placeholder="Enter your password" required autocomplete="current-password">
                    <button type="button" class="password-eye" onclick="togglePasswordVisibility(this, 'id_password')">
                        <i class="fas fa-eye-slash"></i>
                    </button>
                </div>

                <div class="form-options">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="id_remember_me" name="remember_me">
                        <label class="form-check-label" for="id_remember_me">Remember me</label>
                    </div>
                    <a class="forgot" href="{% url 'password_reset' %}">Forgot password?</a>
                </div>

                <button class="btn btn-login" type="submit" id="loginBtn">Sign in <i class="fas fa-arrow-right" style="margin-left:.5rem"></i></button>
            </form>

            <div class="signup-link">
                Create Client or Affiliate Account? <a onclick="showAccountTypeModal()">Sign up</a>
            </div>

            <div style="text-align:center;margin-top:1.5rem">
                <button type="button" class="btn-secondary-action" onclick="showCompanyModal()">
                    <i class="fas fa-building"></i> Register Your Company
                </button>
            </div>

            <div style="text-align:center;margin-top:1.5rem">
                <div class="security-badge"><i class="fas fa-shield-check"></i>SSL 256-bit Encrypted</div>
                <p style="color:#94a3b8;font-size:.8rem;margin-top:.5rem">&copy; 2025 Lamba Real Estate Management</p>
            </div>
        </div>
    </div>

    <!-- COMPANY REGISTRATION MODAL -->
    <div id="companyModal" class="modal-overlay hidden" onclick="if(event.target.id==='companyModal') closeCompanyModal()">
        <div class="modal-content">
            <button class="modal-close" onclick="closeCompanyModal()"><i class="fas fa-times"></i></button>
            <div class="modal-header">
                <h2><i class="fas fa-building"></i> Register Company</h2>
            </div>

            <form method="post" action="{% url 'register' %}" id="companyForm" novalidate>
                {% csrf_token %}
                <input type="hidden" name="registration_type" value="company">

                <div class="mb-3" style="position:relative">
                    <label class="form-label">Company Name</label>
                    <i class="fas fa-building input-icon"></i>
                    <input type="text" class="form-control" name="company_name" placeholder="Your Company Ltd" required>
                    <div class="form-error"></div>
                </div>

                <div class="form-row">
                    <div class="mb-3" style="position:relative">
                        <label class="form-label">Registration Number</label>
                        <i class="fas fa-hashtag input-icon"></i>
                        <input type="text" class="form-control" name="registration_number" placeholder="RC123456" required>
                        <div class="form-error"></div>
                    </div>
                    <div class="mb-3" style="position:relative">
                        <label class="form-label">Registration Date</label>
                        <i class="fas fa-calendar input-icon"></i>
                        <input type="date" class="form-control" name="registration_date" required>
                        <div class="form-error"></div>
                    </div>
                </div>

                <div class="mb-3" style="position:relative">
                    <label class="form-label">Company Location</label>
                    <i class="fas fa-map-marker-alt input-icon"></i>
                    <input type="text" class="form-control" name="location" placeholder="Lagos, Nigeria" required>
                    <div class="form-error"></div>
                </div>

                <div class="form-row">
                    <div class="mb-3" style="position:relative">
                        <label class="form-label">CEO Full Name</label>
                        <i class="fas fa-user-tie input-icon"></i>
                        <input type="text" class="form-control" name="ceo_name" placeholder="Akor Victor" required>
                        <small style="color:#64748b;display:block;margin-top:.25rem;font-size:.8rem;font-style:italic">
                            <i class="fas fa-info-circle"></i> Register the CEO with highest company stake. Add others in company profile.
                        </small>
                        <div class="form-error"></div>
                    </div>
                    <div class="mb-3" style="position:relative">
                        <label class="form-label">CEO Date of Birth</label>
                        <i class="fas fa-birthday-cake input-icon"></i>
                        <input type="date" class="form-control" name="ceo_dob" required>
                        <small style="color:#64748b;display:block;margin-top:.25rem;font-size:.8rem;font-style:italic">
                            <i class="fas fa-info-circle"></i> Used for company verification and legal compliance.
                        </small>
                        <div class="form-error"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="mb-3" style="position:relative">
                        <label class="form-label">Company Email</label>
                        <i class="fas fa-envelope input-icon"></i>
                        <input type="email" class="form-control" name="email" placeholder="info@company.com" required>
                        <div class="form-error"></div>
                    </div>
                    <div class="mb-3" style="position:relative">
                        <label class="form-label">Company Phone</label>
                        <i class="fas fa-phone input-icon"></i>
                        <input type="tel" class="form-control" name="phone" placeholder="+234 xxx xxx xxxx" required>
                        <div class="form-error"></div>
                    </div>
                </div>

                <!-- SUBSCRIPTION PLAN SECTION - GitHub Inspired Design -->
                <div style="margin-bottom:2rem;overflow-x:hidden">
                    <div style="text-align:center;margin-bottom:2rem;padding:0 .5rem">
                        <h3 style="color:#0f172a;font-weight:800;font-size:clamp(1.25rem,4vw,2rem);margin-bottom:.75rem;line-height:1.2">Choose the plan that fits your business</h3>
                        <p style="color:#64748b;font-size:clamp(.85rem,2vw,1rem);margin-bottom:.5rem;line-height:1.5">Start with a 14-day free trial. No credit card required.</p>
                        <div style="display:inline-flex;align-items:center;gap:.75rem;background:#f1f5f9;padding:.5rem 1rem;border-radius:25px;margin-top:.5rem;max-width:100%">
                            <i class="fas fa-gift" style="color:#10b981;flex-shrink:0"></i>
                            <span style="color:#475569;font-size:clamp(.8rem,1.5vw,.9rem);font-weight:600">All plans include 14 days FREE TRIAL</span>
                        </div>
                    </div>

                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1.5rem;margin-bottom:1rem;width:100%;box-sizing:border-box;max-width:100%" class="subscription-plans-grid">
                        <style>
                            .subscription-plans-grid{max-width:100%;overflow:visible;margin:0 auto}
                            .subscription-plans-grid > div{min-width:0;box-sizing:border-box;max-width:100%}
                            @media(min-width:992px){
                                .subscription-plans-grid{max-width:1050px}
                            }
                            @media(max-width:992px){
                                .subscription-plans-grid{grid-template-columns:1fr !important;gap:1.25rem !important;padding:0 .5rem}
                            }
                            @media(max-width:576px){
                                .subscription-plans-grid{gap:1rem !important;padding:0}
                            }
                        </style>
                        <!-- Starter Plan -->
                        <div style="position:relative">
                            <input type="radio" name="subscription_tier" id="planStarter" value="starter" checked style="position:absolute;opacity:0;pointer-events:none">
                            <label for="planStarter" style="display:block;height:100%;border:2px solid #d1d5db;border-radius:12px;cursor:pointer;transition:all .2s ease;background:#ffffff;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.05)">
                                <div style="padding:1.75rem 1.5rem">
                                    <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
                                        <i class="fas fa-rocket" style="color:#667eea;font-size:1.1rem"></i>
                                        <h4 style="font-weight:700;color:#0f172a;margin:0;font-size:1.25rem">Starter</h4>
                                    </div>
                                    <p style="color:#64748b;font-size:.9rem;margin:0 0 1.5rem 0;line-height:1.4">Perfect for small real estate companies getting started</p>
                                    
                                    <div style="margin-bottom:1.5rem">
                                        <div style="display:flex;align-items:baseline;gap:.25rem;margin-bottom:.25rem">
                                            <span style="font-size:2.25rem;font-weight:800;color:#0f172a">₦70,000</span>
                                            <span style="color:#64748b;font-size:.9rem">/month</span>
                                        </div>
                                        <p style="color:#059669;font-size:.85rem;margin:0;font-weight:600">₦700,000/year (Save 2 months)</p>
                                    </div>

                                    <div style="border-top:1px solid #e5e7eb;padding-top:1.25rem">
                                        <p style="color:#0f172a;font-weight:600;font-size:.9rem;margin-bottom:1rem">What's included:</p>
                                        <ul style="list-style:none;padding:0;margin:0">
                                            <li style="display:flex;align-items:flex-start;gap:.75rem;margin-bottom:.75rem">
                                                <i class="fas fa-check" style="color:#10b981;font-size:.9rem;margin-top:.15rem;flex-shrink:0"></i>
                                                <span style="color:#475569;font-size:.9rem;line-height:1.5"><strong style="color:#0f172a">2</strong> Estate Properties</span>
                                            </li>
                                            <li style="display:flex;align-items:flex-start;gap:.75rem;margin-bottom:.75rem">
                                                <i class="fas fa-check" style="color:#10b981;font-size:.9rem;margin-top:.15rem;flex-shrink:0"></i>
                                                <span style="color:#475569;font-size:.9rem;line-height:1.5"><strong style="color:#0f172a">30</strong> Allocations per month</span>
                                            </li>
                                            <li style="display:flex;align-items:flex-start;gap:.75rem;margin-bottom:.75rem">
                                                <i class="fas fa-check" style="color:#10b981;font-size:.9rem;margin-top:.15rem;flex-shrink:0"></i>
                                                <span style="color:#475569;font-size:.9rem;line-height:1.5"><strong style="color:#0f172a">30</strong> Clients & <strong style="color:#0f172a">20</strong> Affiliates</span>
                                            </li>
                                            <li style="display:flex;align-items:flex-start;gap:.75rem">
                                                <i class="fas fa-check" style="color:#10b981;font-size:.9rem;margin-top:.15rem;flex-shrink:0"></i>
                                                <span style="color:#475569;font-size:.9rem;line-height:1.5">Email support</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </label>
                        </div>

                        <!-- Professional Plan -->
                        <div style="position:relative">
                            <input type="radio" name="subscription_tier" id="planProfessional" value="professional" style="position:absolute;opacity:0;pointer-events:none">
                            <label for="planProfessional" style="display:block;height:100%;border:2px solid #667eea;border-radius:12px;cursor:pointer;transition:all .2s ease;background:#ffffff;overflow:hidden;box-shadow:0 8px 20px rgba(102,126,234,.15);transform:scale(1.02)">
                                <div style="padding:1.75rem 1.5rem">
                                    <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
                                        <i class="fas fa-star" style="color:#667eea;font-size:1.1rem"></i>
                                        <h4 style="font-weight:700;color:#0f172a;margin:0;font-size:1.25rem">Professional</h4>
                                        <span style="background:#10b981;color:white;padding:.25rem .65rem;border-radius:12px;font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-left:auto">Most Popular</span>
                                    </div>
                                    <p style="color:#64748b;font-size:.9rem;margin:0 0 1.5rem 0;line-height:1.4">For growing companies scaling their operations</p>
                                    
                                    <div style="margin-bottom:1.5rem">
                                        <div style="display:flex;align-items:baseline;gap:.25rem;margin-bottom:.25rem">
                                            <span style="font-size:2.25rem;font-weight:800;color:#0f172a">₦100,000</span>
                                            <span style="color:#64748b;font-size:.9rem">/month</span>
                                        </div>
                                        <p style="color:#059669;font-size:.85rem;margin:0;font-weight:600">₦1,000,000/year (Save 2 months)</p>
                                    </div>

                                    <div style="border-top:1px solid #e5e7eb;padding-top:1.25rem">
                                        <p style="color:#0f172a;font-weight:600;font-size:.9rem;margin-bottom:1rem">What's included:</p>
                                        <ul style="list-style:none;padding:0;margin:0">
                                            <li style="display:flex;align-items:flex-start;gap:.75rem;margin-bottom:.75rem">
                                                <i class="fas fa-check" style="color:#10b981;font-size:.9rem;margin-top:.15rem;flex-shrink:0"></i>
                                                <span style="color:#475569;font-size:.9rem;line-height:1.5"><strong style="color:#0f172a">5</strong> Estate Properties</span>
                                            </li>
                                            <li style="display:flex;align-items:flex-start;gap:.75rem;margin-bottom:.75rem">
                                                <i class="fas fa-check" style="color:#10b981;font-size:.9rem;margin-top:.15rem;flex-shrink:0"></i>
                                                <span style="color:#475569;font-size:.9rem;line-height:1.5"><strong style="color:#0f172a">80</strong> Allocations per month</span>
                                            </li>
                                            <li style="display:flex;align-items:flex-start;gap:.75rem;margin-bottom:.75rem">
                                                <i class="fas fa-check" style="color:#10b981;font-size:.9rem;margin-top:.15rem;flex-shrink:0"></i>
                                                <span style="color:#475569;font-size:.9rem;line-height:1.5"><strong style="color:#0f172a">80</strong> Clients & <strong style="color:#0f172a">30</strong> Affiliates</span>
                                            </li>
                                            <li style="display:flex;align-items:flex-start;gap:.75rem">
                                                <i class="fas fa-check" style="color:#10b981;font-size:.9rem;margin-top:.15rem;flex-shrink:0"></i>
                                                <span style="color:#475569;font-size:.9rem;line-height:1.5">Priority email support</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </label>
                        </div>

                        <!-- Enterprise Plan -->
                        <div style="position:relative">
                            <input type="radio" name="subscription_tier" id="planEnterprise" value="enterprise" style="position:absolute;opacity:0;pointer-events:none">
                            <label for="planEnterprise" style="display:block;height:100%;border:2px solid #d1d5db;border-radius:12px;cursor:pointer;transition:all .2s ease;background:#ffffff;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.05);position:relative">
                                <div style="position:absolute;top:0;left:0;right:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;text-align:center;padding:.5rem;font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px">
                                    <i class="fas fa-crown" style="margin-right:.35rem"></i>Preferred Plan
                                </div>
                                <div style="padding:3.25rem 1.5rem 1.75rem">
                                    <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
                                        <i class="fas fa-building" style="color:#667eea;font-size:1.1rem"></i>
                                        <h4 style="font-weight:700;color:#0f172a;margin:0;font-size:1.25rem">Enterprise</h4>
                                    </div>
                                    <p style="color:#64748b;font-size:.9rem;margin:0 0 1.5rem 0;line-height:1.4">For large companies with unlimited needs</p>
                                    
                                    <div style="margin-bottom:1.5rem">
                                        <div style="display:flex;align-items:baseline;gap:.25rem;margin-bottom:.25rem">
                                            <span style="font-size:2.25rem;font-weight:800;color:#0f172a">₦150,000</span>
                                            <span style="color:#64748b;font-size:.9rem">/month</span>
                                        </div>
                                        <p style="color:#059669;font-size:.85rem;margin:0;font-weight:600">₦1,500,000/year (Save 2 months)</p>
                                    </div>

                                    <div style="border-top:1px solid #e5e7eb;padding-top:1.25rem">
                                        <p style="color:#0f172a;font-weight:600;font-size:.9rem;margin-bottom:1rem">Everything in Professional, plus:</p>
                                        <ul style="list-style:none;padding:0;margin:0">
                                            <li style="display:flex;align-items:flex-start;gap:.75rem;margin-bottom:.75rem">
                                                <i class="fas fa-infinity" style="color:#667eea;font-size:.9rem;margin-top:.15rem;flex-shrink:0"></i>
                                                <span style="color:#475569;font-size:.9rem;line-height:1.5"><strong style="color:#0f172a">Unlimited</strong> Estate Properties</span>
                                            </li>
                                            <li style="display:flex;align-items:flex-start;gap:.75rem;margin-bottom:.75rem">
                                                <i class="fas fa-infinity" style="color:#667eea;font-size:.9rem;margin-top:.15rem;flex-shrink:0"></i>
                                                <span style="color:#475569;font-size:.9rem;line-height:1.5"><strong style="color:#0f172a">Unlimited</strong> Allocations</span>
                                            </li>
                                            <li style="display:flex;align-items:flex-start;gap:.75rem;margin-bottom:.75rem">
                                                <i class="fas fa-infinity" style="color:#667eea;font-size:.9rem;margin-top:.15rem;flex-shrink:0"></i>
                                                <span style="color:#475569;font-size:.9rem;line-height:1.5"><strong style="color:#0f172a">Unlimited</strong> Clients & Affiliates</span>
                                            </li>
                                            <li style="display:flex;align-items:flex-start;gap:.75rem">
                                                <i class="fas fa-check" style="color:#10b981;font-size:.9rem;margin-top:.15rem;flex-shrink:0"></i>
                                                <span style="color:#475569;font-size:.9rem;line-height:1.5">Dedicated account manager</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- ADMINISTRATOR SECTION -->
                <div style="background:linear-gradient(135deg,rgba(102,126,234,.08) 0%,rgba(118,75,162,.03) 100%);padding:1.5rem;border-radius:12px;border:2px solid rgba(102,126,234,.15);margin-bottom:1.5rem">
                    <h4 style="color:#667eea;font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem">
                        <i class="fas fa-user-shield"></i> Administrator Details
                    </h4>
                    <p style="color:#64748b;font-size:.85rem;margin-bottom:1rem">
                        Designate an administrator to manage your company's system
                    </p>

                    <div class="form-row">
                        <div class="mb-3" style="position:relative">
                            <label class="form-label">Admin Email</label>
                            <i class="fas fa-envelope input-icon"></i>
                            <input type="email" class="form-control" name="secondary_admin_email" placeholder="admin@company.com" required>
                            <div class="form-error"></div>
                        </div>
                        <div class="mb-3" style="position:relative">
                            <label class="form-label">Admin Phone</label>
                            <i class="fas fa-phone input-icon"></i>
                            <input type="tel" class="form-control" name="secondary_admin_phone" placeholder="+234 xxx xxx xxxx" required>
                            <div class="form-error"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="mb-3" style="position:relative">
                            <label class="form-label">Admin Full Name</label>
                            <i class="fas fa-user input-icon"></i>
                            <input type="text" class="form-control" name="secondary_admin_name" placeholder="Akor Victor" required>
                            <div class="form-error"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="mb-3" style="position:relative">
                            <label class="form-label">Admin Password</label>
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" class="form-control" id="secondaryAdminPassword" name="secondary_admin_password" placeholder="Min. 8 characters" required>
                            <button type="button" class="password-eye" onclick="togglePasswordVisibility(this, 'secondaryAdminPassword')">
                                <i class="fas fa-eye-slash"></i>
                            </button>
                            <div class="form-error"></div>
                        </div>
                        <div class="mb-3" style="position:relative">
                            <label class="form-label">Confirm Password</label>
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" class="form-control" id="secondaryAdminConfirmPassword" name="secondary_admin_confirm_password" placeholder="Re-enter password" required>
                            <button type="button" class="password-eye" onclick="togglePasswordVisibility(this, 'secondaryAdminConfirmPassword')">
                                <i class="fas fa-eye-slash"></i>
                            </button>
                            <div class="form-error"></div>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-register" id="companyBtn">
                    <i class="fas fa-building"></i> Create Company Account
                </button>
            </form>
        </div>
    </div> 

    <!-- ACCOUNT TYPE SELECTION MODAL -->
    <div id="accountTypeModal" class="modal-overlay hidden" onclick="if(event.target.id==='accountTypeModal') closeAccountTypeModal()">
        <div class="modal-content">
            <button class="modal-close" onclick="closeAccountTypeModal()"><i class="fas fa-times"></i></button>
            <div class="modal-header">
                <h2>Create Your Account</h2>
                <p style="color:#64748b;font-size:.95rem;margin-top:.5rem">Choose your account type</p>
            </div>

            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" name="account_type" id="clientRadio" value="client" checked>
                    <label for="clientRadio" class="radio-label">
                        <div style="text-align:center">
                            <i class="fas fa-user" style="font-size:1.5rem;display:block;margin-bottom:.5rem;color:#667eea"></i>
                            <span>Client</span>
                            <div class="radio-description">Manage all your purchased properties from different companies</div>
                        </div>
                    </label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="account_type" id="marketerRadio" value="marketer">
                    <label for="marketerRadio" class="radio-label">
                        <div style="text-align:center">
                            <i class="fas fa-handshake" style="font-size:1.5rem;display:block;margin-bottom:.5rem;color:#667eea"></i>
                            <span>Affiliate/Marketer</span>
                            <div class="radio-description">Track all your companies affiliate records in your account</div>
                        </div>
                    </label>
                </div>
            </div>

            <button type="button" class="btn btn-register" onclick="proceedToRegistration()">
                Next <i class="fas fa-arrow-right" style="margin-left:.5rem"></i>
            </button>
        </div>
    </div>

    <!-- CLIENT REGISTRATION MODAL -->
    <div id="clientModal" class="modal-overlay hidden" onclick="if(event.target.id==='clientModal') closeClientModal()">
        <div class="modal-content">
            <button class="modal-close" onclick="closeClientModal()"><i class="fas fa-times"></i></button>
            <div class="modal-header">
                <h2><i class="fas fa-user"></i> Client Account</h2>
                <p style="color:#64748b;font-size:.9rem;margin-top:.5rem">Manage your properties across multiple companies</p>
            </div>

            <form method="post" action="{% url 'client_register' %}" id="clientForm" novalidate>
                {% csrf_token %}
                <input type="hidden" name="registration_type" value="client">

                <div class="form-row">
                    <div class="form-group">
                        <div class="mb-3" style="position:relative">
                            <label class="form-label">First Name</label>
                            <i class="fas fa-user input-icon"></i>
                            <input type="text" class="form-control" name="first_name" placeholder="Akor" required>
                            <div class="form-error"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="mb-3" style="position:relative">
                            <label class="form-label">Last Name</label>
                            <i class="fas fa-user input-icon"></i>
                            <input type="text" class="form-control" name="last_name" placeholder="Victor" required>
                            <div class="form-error"></div>
                        </div>
                    </div>
                </div>

                <div class="mb-3" style="position:relative">
                    <label class="form-label">Email Address</label>
                    <i class="fas fa-envelope input-icon"></i>
                    <input type="email" class="form-control" name="email" placeholder="your.email@example.com" required>
                </div>

                <div class="mb-3" style="position:relative">
                    <label class="form-label">Phone Number</label>
                    <i class="fas fa-phone input-icon"></i>
                    <input type="tel" class="form-control" name="phone" placeholder="+234 xxx xxx xxxx" required inputmode="numeric" pattern="[+0-9\s\-()]{7,20}" title="Enter phone number (digits, spaces, +, - allowed)">
                    <div class="form-error"></div>
                </div>

                <div class="mb-3" style="position:relative">
                    <label class="form-label">Address</label>
                    <i class="fas fa-map-marker-alt input-icon"></i>
                    <input type="text" class="form-control" name="address" placeholder="City, State (e.g. WUSE, FCT ABUJA)" required>
                    <div class="form-error"></div>
                </div>

                <div class="mb-3" style="position:relative">
                    <label class="form-label">Date of Birth</label>
                    <i class="fas fa-birthday-cake input-icon"></i>
                    <input type="date" class="form-control" name="date_of_birth" required>
                </div>

                <div class="form-row">
                    <div class="mb-3" style="position:relative">
                        <label class="form-label">Password</label>
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" class="form-control" id="clientPassword" name="password" placeholder="Min. 8 characters" required>
                        <button type="button" class="password-eye" onclick="togglePasswordVisibility(this, 'clientPassword')">
                            <i class="fas fa-eye-slash"></i>
                        </button>
                        <div class="form-error"></div>
                    </div>
                    <div class="mb-3" style="position:relative">
                        <label class="form-label">Confirm Password</label>
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" class="form-control" id="clientConfirmPassword" name="confirm_password" placeholder="Re-enter password" required>
                        <button type="button" class="password-eye" onclick="togglePasswordVisibility(this, 'clientConfirmPassword')">
                            <i class="fas fa-eye-slash"></i>
                        </button>
                        <div class="form-error"></div>
                    </div>
                </div>

                <button type="submit" class="btn btn-register" id="clientBtn">
                    <i class="fas fa-user-check"></i> Create Client Account
                </button>
            </form>
        </div>
    </div>

    <!-- MARKETER REGISTRATION MODAL -->
    <div id="marketerModal" class="modal-overlay hidden" onclick="if(event.target.id==='marketerModal') closeMarketerModal()">
        <div class="modal-content">
            <button class="modal-close" onclick="closeMarketerModal()"><i class="fas fa-times"></i></button>
            <div class="modal-header">
                <h2><i class="fas fa-handshake"></i> Affiliate/Marketer Account</h2>
                <p style="color:#64748b;font-size:.9rem;margin-top:.5rem">Earn commissions selling real estate</p>
            </div>

            <form method="post" action="{% url 'marketer_register' %}" id="marketerForm" novalidate>
                {% csrf_token %}
                <input type="hidden" name="registration_type" value="marketer">

                <div class="form-row">
                    <div class="mb-3" style="position:relative">
                        <label class="form-label">First Name</label>
                        <i class="fas fa-user-tie input-icon"></i>
                        <input type="text" class="form-control" name="first_name" placeholder="Akor" required>
                        <div class="form-error"></div>
                    </div>
                    <div class="mb-3" style="position:relative">
                        <label class="form-label">Last Name</label>
                        <i class="fas fa-user-tie input-icon"></i>
                        <input type="text" class="form-control" name="last_name" placeholder="Victor" required>
                        <div class="form-error"></div>
                    </div>
                </div>

                <div class="mb-3" style="position:relative">
                    <label class="form-label">Email Address</label>
                    <i class="fas fa-envelope input-icon"></i>
                    <input type="email" class="form-control" name="email" placeholder="your.email@example.com" required>
                    <div class="form-error"></div>
                </div>


                <div class="mb-3" style="position:relative">
                    <label class="form-label">Phone Number</label>
                    <i class="fas fa-phone input-icon"></i>
                    <input type="tel" class="form-control" name="phone" placeholder="+234 xxx xxx xxxx" required inputmode="numeric" pattern="[+0-9\s\-()]{7,20}" title="Enter phone number (digits, spaces, +, - allowed)">
                    <div class="form-error"></div>
                </div>

                <div class="mb-3" style="position:relative">
                    <label class="form-label">Address</label>
                    <i class="fas fa-map-marker-alt input-icon"></i>
                    <input type="text" class="form-control" name="address" placeholder="City, State (e.g. WUSE, FCT ABUJA)" required>
                    <div class="form-error"></div>
                </div>

                <div class="mb-3" style="position:relative">
                    <label class="form-label">Date of Birth</label>
                    <i class="fas fa-birthday-cake input-icon"></i>
                    <input type="date" class="form-control" name="date_of_birth" required>
                    <div class="form-error"></div>
                </div>

                <div class="form-row">
                    <div class="mb-3" style="position:relative">
                        <label class="form-label">Password</label>
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" class="form-control" id="marketerPassword" name="password" placeholder="Min. 8 characters" required>
                        <button type="button" class="password-eye" onclick="togglePasswordVisibility(this, 'marketerPassword')">
                            <i class="fas fa-eye-slash"></i>
                        </button>
                        <div class="form-error"></div>
                    </div>
                    <div class="mb-3" style="position:relative">
                        <label class="form-label">Confirm Password</label>
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" class="form-control" id="marketerConfirmPassword" name="confirm_password" placeholder="Re-enter password" required>
                        <button type="button" class="password-eye" onclick="togglePasswordVisibility(this, 'marketerConfirmPassword')">
                            <i class="fas fa-eye-slash"></i>
                        </button>
                        <div class="form-error"></div>
                    </div>
                </div>

                <button type="submit" class="btn btn-register" id="marketerBtn">
                    <i class="fas fa-handshake"></i> Create Marketer Account
                </button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Password Visibility Toggle
        function togglePasswordVisibility(button, inputId){
            const input = document.getElementById(inputId);
            const icon = button.querySelector('i');
            if(input.type==='password'){
                input.type='text';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
                button.style.color='#667eea';
            }else{
                input.type='password';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
                button.style.color='#94a3b8';
            }
        }

        // Modal Management Functions
        function showCompanyModal(){closeAccountTypeModal();document.getElementById('companyModal').classList.remove('hidden');}
        function closeCompanyModal(){document.getElementById('companyModal').classList.add('hidden');}
        function showAccountTypeModal(){document.getElementById('accountTypeModal').classList.remove('hidden');}
        function closeAccountTypeModal(){document.getElementById('accountTypeModal').classList.add('hidden');}
        function showClientModal(){closeAccountTypeModal();document.getElementById('clientModal').classList.remove('hidden');}
        function closeClientModal(){document.getElementById('clientModal').classList.add('hidden');}
        function showMarketerModal(){closeAccountTypeModal();document.getElementById('marketerModal').classList.remove('hidden');}
        function closeMarketerModal(){document.getElementById('marketerModal').classList.add('hidden');}
        function proceedToRegistration(){
            const accountType = document.querySelector('input[name="account_type"]:checked').value;
            if(accountType==='client'){showClientModal();}else{showMarketerModal();}
        }

        // Login Form Throttle & Remember Me
        (function(){
            const form=document.getElementById('loginForm');
            const btn=document.getElementById('loginBtn');
            let attempts=0;
            const MAX_ATTEMPTS=6;
            const LOCK_MS=2*60*1000;
            let submissionTimeout;
            
            // Load remembered email if exists
            const rememberMeCheckbox = form.querySelector('input[name="remember_me"]');
            const emailField = form.querySelector('input[name="username"]');
            const rememberKey = 'lamba_remember_email';
            
            if(localStorage.getItem(rememberKey)){
                emailField.value = localStorage.getItem(rememberKey);
                if(rememberMeCheckbox) rememberMeCheckbox.checked = true;
            }
            
            // Function to re-enable button
            function reEnableButton() {
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.classList.remove('spinning');
                btn.innerHTML='Sign in <i class="fas fa-arrow-right" style="margin-left:.5rem"></i>';
            }
            
            form.addEventListener('submit',function(e){
                attempts+=1;
                
                // Handle Remember Me
                if(rememberMeCheckbox && rememberMeCheckbox.checked){
                    localStorage.setItem(rememberKey, emailField.value);
                }else{
                    localStorage.removeItem(rememberKey);
                }
                
                if(attempts>=MAX_ATTEMPTS){
                    e.preventDefault();
                    btn.disabled=true;
                    btn.classList.add('spinning');
                    btn.innerHTML='Too many attempts. Try again later.';
                    setTimeout(()=>{
                        attempts=0;
                        reEnableButton();
                    },LOCK_MS);
                    return false;
                }
                // Start spinner and disable button
                console.debug('Login submit handler: attempts=', attempts);
                btn.classList.add('spinning');
                btn.disabled=true;
                
                // Set timeout to auto-re-enable button if page doesn't redirect in 15 seconds
                // This handles cases where server returns error or network is slow
                submissionTimeout = setTimeout(function() {
                    if(!btn.disabled) return; // Already re-enabled
                    reEnableButton();
                }, 15000);
            });
            
            // Re-enable button if there are errors shown on page load
            window.addEventListener('load', function() {
                clearTimeout(submissionTimeout);
                if(form.querySelector('.alert-danger') || form.querySelector('.form-error.show')) {
                    reEnableButton();
                }
            });
            
            // Also check on DOM ready
            if(document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    if(form.querySelector('.alert-danger') || form.querySelector('.form-error.show')) {
                        reEnableButton();
                    }
                });
            } else {
                // DOM is already ready
                if(form.querySelector('.alert-danger') || form.querySelector('.form-error.show')) {
                    reEnableButton();
                }
            }
        })();

        // Form Validation and Submission with Inline Error Display
        // NOTE: exclude the main login form from this generic validator to avoid conflicting
        // submit handlers. The login form has its own throttling/submit logic above.
        document.querySelectorAll('form:not(#loginForm)').forEach(form => {
            form.addEventListener('submit', function(e) {
                let isValid = true;
                const formInputs = this.querySelectorAll('input:not([type="hidden"]), select');

                // Clear all previous errors
                this.querySelectorAll('.form-error').forEach(err => {
                    err.classList.remove('show');
                    err.innerHTML = '';
                });

                // Validate each field
                formInputs.forEach(field => {
                    if (!field.value.trim() && field.name !== 'registration_type') {
                        isValid = false;
                        const errorDiv = field.parentElement.querySelector('.form-error');
                        if (errorDiv) {
                            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> This field is required`;
                            errorDiv.classList.add('show');
                        }
                    }
                });

                // Validate passwords
                const passwordField = this.querySelector('input[name="password"]');
                const confirmField = this.querySelector('input[name="confirm_password"]');
                const secondaryAdminPasswordField = this.querySelector('input[name="secondary_admin_password"]');
                const secondaryAdminConfirmField = this.querySelector('input[name="secondary_admin_confirm_password"]');

                // Check primary admin password if it exists (old field name)
                if (passwordField) {
                    if (passwordField.value.length > 0 && passwordField.value.length < 8) {
                        isValid = false;
                        const errorDiv = passwordField.parentElement.querySelector('.form-error');
                        if (errorDiv) {
                            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> Password must be at least 8 characters`;
                            errorDiv.classList.add('show');
                        }
                    }
                }

                if (confirmField && passwordField) {
                    if (confirmField.value && passwordField.value && passwordField.value !== confirmField.value) {
                        isValid = false;
                        const errorDiv = confirmField.parentElement.querySelector('.form-error');
                        if (errorDiv) {
                            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> Passwords do not match`;
                            errorDiv.classList.add('show');
                        }
                    }
                }

                // Check admin password if it exists (new field name in administrator section)
                if (secondaryAdminPasswordField) {
                    if (secondaryAdminPasswordField.value.length > 0 && secondaryAdminPasswordField.value.length < 8) {
                        isValid = false;
                        const errorDiv = secondaryAdminPasswordField.parentElement.querySelector('.form-error');
                        if (errorDiv) {
                            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> Password must be at least 8 characters`;
                            errorDiv.classList.add('show');
                        }
                    }
                }

                if (secondaryAdminConfirmField && secondaryAdminPasswordField) {
                    if (secondaryAdminConfirmField.value && secondaryAdminPasswordField.value && secondaryAdminPasswordField.value !== secondaryAdminConfirmField.value) {
                        isValid = false;
                        const errorDiv = secondaryAdminConfirmField.parentElement.querySelector('.form-error');
                        if (errorDiv) {
                            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> Passwords do not match`;
                            errorDiv.classList.add('show');
                        }
                    }
                }

                if (!isValid) {
                    e.preventDefault();
                    return false;
                }

                // Add spinning animation to submit button
                const btn = this.querySelector('[type="submit"]');
                if (btn) {
                    btn.classList.add('spinning');
                    btn.disabled = true;
                }

                // Store form reference for later message display
                window.lastSubmittedForm = this;
            });
        });

        // Auto-hide alerts
        document.addEventListener('DOMContentLoaded',function(){
            const alerts=document.querySelectorAll('.alert');
            alerts.forEach(alert=>{
                setTimeout(()=>{
                    alert.style.transition='opacity .3s,transform .3s';
                    alert.style.opacity='0';
                    alert.style.transform='translateY(-10px)';
                    setTimeout(()=>alert.remove(),300);
                },5000);
            });
        });

        // Role Selection Functionality
        function selectRole(optionElement, userId) {
            // Remove selected class from all options
            document.querySelectorAll('.role-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Add selected class to clicked option
            optionElement.classList.add('selected');

            // Set the selected user ID
            document.getElementById('selectedUserId').value = userId;

            // Enable the continue button
            document.getElementById('roleSelectBtn').disabled = false;
        }
        document.addEventListener('keydown',function(e){
            if(e.key==='Escape'){
                closeCompanyModal();
                closeAccountTypeModal();
                closeClientModal();
                closeMarketerModal();
            }
        });

        // Modal Success/Error Message Handler with 3-Second Delay
        // Only attach modal-specific handlers to forms inside modals to avoid intercepting the main login form
        document.querySelectorAll('.modal-overlay form').forEach(form => {
            form.addEventListener('submit', function(e) {
                // Get the parent modal
                let modal = this.closest('.modal-overlay');
                if (!modal) return; // Not a modal form, skip delay logic

                // Add intercept for form submission to show message in modal
                const originalAction = form.action;
                const originalMethod = form.method;

                // Prevent default form submission to handle it via fetch for better control
                if (modal && !form.hasAttribute('data-delay-handled')) {
                    form.setAttribute('data-delay-handled', 'true');

                    form.addEventListener('submit', function(submitEvent) {
                        // Only intercept if this is a modal form
                        if (!this.closest('.modal-overlay')) return;

                        // Collect form data
                        const formData = new FormData(this);

                        // Disable submit button
                        const btn = this.querySelector('[type="submit"]');
                        if (btn) {
                            btn.disabled = true;
                            btn.classList.add('spinning');
                        }

                        // Send request
                        fetch(originalAction, {
                            method: originalMethod || 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                        .then(response => {
                            // Check if response is JSON
                            const contentType = response.headers.get('content-type');
                            if (contentType && contentType.includes('application/json')) {
                                return response.json().then(data => {
                                    if (data.success) {
                                        // Show success message in modal
                                        const messageDiv = document.createElement('div');
                                        messageDiv.className = 'modal-message success';
                                        messageDiv.innerHTML = `
                                            <i class="fas fa-check-circle" style="color:#11998e;font-size:2rem;margin-bottom:.5rem;display:block"></i>
                                            <h4 style="color:#11998e;margin:.5rem 0">${data.message || 'Account Created Successfully!'}</h4>
                                            <p style="color:#64748b;font-size:.9rem">Redirecting you to login...</p>
                                        `;
                                        messageDiv.style.cssText = `
                                            text-align: center; 
                                            padding: 2rem; 
                                            animation: slideIn 0.3s ease-out;
                                            border-top: 3px solid #11998e;
                                        `;

                                        // Insert at top of modal content
                                        const modalContent = modal.querySelector('.modal-content');
                                        modalContent.insertBefore(messageDiv, modalContent.firstChild);

                                        // Hide form
                                        form.style.display = 'none';

                                        // Wait 3 seconds then redirect
                                        setTimeout(() => {
                                            window.location.href = data.redirect_url || '/login';
                                        }, 3000);
                                    } else {
                                        // Show error message in modal
                                        const messageDiv = document.createElement('div');
                                        messageDiv.className = 'modal-message error';
                                        messageDiv.innerHTML = `
                                            <i class="fas fa-times-circle" style="color:#ef4444;font-size:2rem;margin-bottom:.5rem;display:block"></i>
                                            <h4 style="color:#ef4444;margin:.5rem 0">Registration Failed</h4>
                                            <p style="color:#64748b;font-size:.9rem">${data.message || 'Please check your information and try again'}</p>
                                        `;
                                        messageDiv.style.cssText = `
                                            text-align: center; 
                                            padding: 2rem; 
                                            animation: slideIn 0.3s ease-out;
                                            border-top: 3px solid #ef4444;
                                            margin-bottom: 1rem;
                                        `;

                                        // Insert at top of modal content
                                        const modalContent = modal.querySelector('.modal-content');
                                        modalContent.insertBefore(messageDiv, modalContent.firstChild);

                                        // Re-enable submit button
                                        if (btn) {
                                            btn.disabled = false;
                                            btn.classList.remove('spinning');
                                        }

                                        // Auto-remove message after 5 seconds
                                        setTimeout(() => {
                                            messageDiv.style.animation = 'slideOut 0.3s ease-out';
                                            setTimeout(() => messageDiv.remove(), 300);
                                        }, 5000);
                                    }
                                });
                            } else {
                                // Handle non-JSON responses (like redirects)
                                if (response.ok || response.status === 302) {
                                    // Show success message in modal
                                    const messageDiv = document.createElement('div');
                                    messageDiv.className = 'modal-message success';
                                    messageDiv.innerHTML = `
                                        <i class="fas fa-check-circle" style="color:#11998e;font-size:2rem;margin-bottom:.5rem;display:block"></i>
                                        <h4 style="color:#11998e;margin:.5rem 0">Account Created Successfully!</h4>
                                        <p style="color:#64748b;font-size:.9rem">Redirecting you to login...</p>
                                    `;
                                    messageDiv.style.cssText = `
                                        text-align: center; 
                                        padding: 2rem; 
                                        animation: slideIn 0.3s ease-out;
                                        border-top: 3px solid #11998e;
                                    `;

                                    // Insert at top of modal content
                                    const modalContent = modal.querySelector('.modal-content');
                                    modalContent.insertBefore(messageDiv, modalContent.firstChild);

                                    // Hide form
                                    form.style.display = 'none';

                                    // Wait 3 seconds then redirect
                                    setTimeout(() => {
                                        window.location.href = '/login';
                                    }, 3000);
                                } else {
                                    // Show error message in modal
                                    const messageDiv = document.createElement('div');
                                    messageDiv.className = 'modal-message error';
                                    messageDiv.innerHTML = `
                                        <i class="fas fa-times-circle" style="color:#ef4444;font-size:2rem;margin-bottom:.5rem;display:block"></i>
                                        <h4 style="color:#ef4444;margin:.5rem 0">Registration Failed</h4>
                                        <p style="color:#64748b;font-size:.9rem">Please check your information and try again</p>
                                    `;
                                    messageDiv.style.cssText = `
                                        text-align: center; 
                                        padding: 2rem; 
                                        animation: slideIn 0.3s ease-out;
                                        border-top: 3px solid #ef4444;
                                        margin-bottom: 1rem;
                                    `;

                                    // Insert at top of modal content
                                    const modalContent = modal.querySelector('.modal-content');
                                    modalContent.insertBefore(messageDiv, modalContent.firstChild);

                                    // Re-enable submit button
                                    if (btn) {
                                        btn.disabled = false;
                                        btn.classList.remove('spinning');
                                    }

                                    // Auto-remove message after 5 seconds
                                    setTimeout(() => {
                                        messageDiv.style.animation = 'slideOut 0.3s ease-out';
                                        setTimeout(() => messageDiv.remove(), 300);
                                    }, 5000);
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Form submission error:', error);
                            // Allow default form submission on error
                            submitEvent.target.submit();
                        });

                        submitEvent.preventDefault();
                        return false;
                    }, { once: true });
                }
            });
        });

        // Slide animation for modal messages
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes slideIn {
                from { transform: translateY(-10px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateY(0); opacity: 1; }
                to { transform: translateY(-10px); opacity: 0; }
            }
            .modal-message { animation: slideIn 0.3s ease-out; }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
