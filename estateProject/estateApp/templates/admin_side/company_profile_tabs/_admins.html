{% load humanize %}

<!-- Admins Tab Content -->
<div class="card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <strong>Admin Users</strong>
        <span class="badge bg-primary">{{ admin_users|length }}</span>
    </div>
    <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Joined</th>
                    <th>Last Login</th>
                    <th>Login Location</th>
                    <th>Status</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for a in admin_users %}
                <tr>
                    <td>
                        {{ a.full_name }}
                        {% if master_admin_id and a.id == master_admin_id %}
                            <span class="badge bg-warning text-dark ms-2" title="Master admin">Master admin</span>
                        {% endif %}
                    </td>
                    <td>{{ a.email }}</td>
                    <td>{{ a.phone|default:'-' }}</td>
                    <td>{{ a.date_joined|date:'M d, Y' }}</td>
                    <td>{{ a.last_login|date:'M d, Y H:i'|default:'—' }}</td>
                    <td>
                        {% if a.last_login_location %}
                            {{ a.last_login_location }}
                        {% elif a.last_login_ip %}
                            {{ a.last_login_ip }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td>
                        {% if a.last_login %}
                            {% if a.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Muted</span>
                            {% endif %}
                        {% else %}
                            <span class="badge bg-warning">NOT ACTIVE</span>
                        {% endif %}
                    </td>
                    <td class="text-end">
                        {% if master_admin_id and a.id == master_admin_id %}
                            <span class="badge bg-success-subtle text-success px-3 py-2">
                                <i class="bi bi-shield-check me-1"></i>Master Admin (Full Control)
                            </span>
                        {% elif master_admin_id and request.user.id == master_admin_id %}
                            <div class="d-flex gap-2 justify-content-end flex-wrap">
                                <button class="btn btn-sm {% if a.has_full_control %}btn-success{% else %}btn-outline-secondary{% endif %}" 
                                        data-action="toggle-full-control" 
                                        data-user-id="{{ a.id }}" 
                                        data-has-control="{{ a.has_full_control|yesno:'true,false' }}"
                                        title="{% if a.has_full_control %}Revoke Full Control{% else %}Grant Full Control{% endif %}">
                                    <i class="bi {% if a.has_full_control %}bi-shield-fill-check{% else %}bi-shield{% endif %}"></i>
                                    {% if a.has_full_control %}Full Control{% else %}Grant Control{% endif %}
                                </button>
                                <button class="btn btn-sm btn-outline-primary" data-action="edit-user" data-user-id="{{ a.id }}" data-user-type="admin" data-user-name="{{ a.full_name }}" data-user-email="{{ a.email }}" data-user-phone="{{ a.phone|default:'' }}" data-user-address="{{ a.address|default:'' }}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" data-action="toggle-mute" data-user-id="{{ a.id }}" data-current="{{ a.is_active|yesno:'active,muted' }}">
                                    {% if a.is_active %}<i class="bi bi-volume-mute"></i>{% else %}<i class="bi bi-volume-up"></i>{% endif %}
                                </button>
                                <button class="btn btn-sm btn-outline-danger" data-action="delete-admin" data-user-id="{{ a.id }}" data-name="{{ a.full_name }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        {% else %}
                            {% if a.has_full_control %}
                                <span class="badge bg-success-subtle text-success px-3 py-2">
                                    <i class="bi bi-shield-fill-check me-1"></i>Full Control Granted
                                </span>
                            {% else %}
                                <span class="text-muted small">Only master admin can manage</span>
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="8" class="text-center text-muted">No admin users found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <strong>Support Users</strong>
        <span class="badge bg-secondary">{{ support_users|length }}</span>
    </div>
    <div class="table-responsive">
        <table class="table table-striped align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Joined</th>
                    <th>Last Login</th>
                    <th>Login Location</th>
                    <th>Status</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for s in support_users %}
                <tr>
                    <td>{{ s.full_name }}</td>
                    <td>{{ s.email }}</td>
                    <td>{{ s.phone|default:'-' }}</td>
                    <td>{{ s.date_joined|date:'M d, Y' }}</td>
                    <td>{{ s.last_login|date:'M d, Y H:i'|default:'—' }}</td>
                    <td>
                        {% if s.last_login_location %}
                            {{ s.last_login_location }}
                        {% elif s.last_login_ip %}
                            {{ s.last_login_ip }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td>
                        {% if s.status_display == "Active" %}
                            <span class="badge bg-success">Active</span>
                        {% elif s.status_display == "Not Active" %}
                            <span class="badge bg-secondary">Not Active</span>
                        {% else %}
                            <span class="badge bg-warning">{{ s.status_display }}</span>
                        {% endif %}
                    </td>
                    <td class="text-end">
                        {% if master_admin_id and request.user.id == master_admin_id %}
                            <button class="btn btn-sm btn-outline-primary me-2" data-action="edit-user" data-user-id="{{ s.id }}" data-user-type="support" data-user-name="{{ s.full_name }}" data-user-email="{{ s.email }}" data-user-phone="{{ s.phone|default:'' }}" data-user-address="{{ s.address|default:'' }}">
                                <i class="bi bi-pencil"></i> Update
                            </button>
                            <button class="btn btn-sm btn-outline-warning me-2" data-action="toggle-mute" data-user-id="{{ s.id }}" data-current="{{ s.is_active|yesno:'active,muted' }}">
                                {% if s.is_active %}<i class="bi bi-volume-mute"></i> Mute{% else %}<i class="bi bi-volume-up"></i> Unmute{% endif %}
                            </button>
                            <button class="btn btn-sm btn-outline-danger" data-action="delete-admin" data-user-id="{{ s.id }}" data-name="{{ s.full_name }}">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        {% else %}
                            <span class="text-muted">Only master admin can Update</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="8" class="text-center text-muted">No support users found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
