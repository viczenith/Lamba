{% extends 'admin_base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<main id="main" class="main">
    <div class="pagetitle">
        <h1>Company Console</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'tenant-dashboard' company_slug=request.user.company_profile.slug %}">Home</a></li>
                <li class="breadcrumb-item active">Console</li>
            </ol>
        </nav>
    </div>

    <!-- Password Verification Modal -->
    <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 16px; overflow: hidden;">
                <div class="modal-header" style="background: linear-gradient(135deg, #22c55e 0%, #0f7c3a 100%); color: white; border: none; position: relative;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%);"></div>
                    <div style="position: relative; z-index: 1;">
                        <h5 class="modal-title" id="passwordModalLabel" style="font-weight: 700; letter-spacing: -0.5px;">
                            <i class="bi bi-shield-lock-fill me-2" style="font-size: 1.2rem;"></i>Master Admin Verification
                        </h5>
                        <small style="opacity: 0.95; display: block; margin-top: 4px;">Secure access to company profile</small>
                    </div>
                </div>
                <div class="modal-body p-4">
                    <div class="text-center mb-4">
                        <div style="width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #22c55e 0%, #0f7c3a 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; box-shadow: 0 8px 24px rgba(34, 197, 94, 0.3);">
                            <i class="bi bi-shield-lock-fill" style="font-size: 28px; color: white;"></i>
                        </div>
                        <p class="mb-4" style="color: #374151; font-size: 1.1rem; line-height: 1.5;">Please enter the master admin password to access the company profile.</p>
                    </div>
                    <form id="passwordForm">
                        <div class="mb-3">
                            <label for="masterPassword" class="form-label fw-semibold" style="color: #1f2937;">Master Admin Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control form-control-lg border-end-0" id="masterPassword" name="password" required style="border-radius: 8px 0 0 8px; border: 2px solid #e5e7eb; border-right: none; padding: 12px 16px; font-size: 1rem;">
                                <button type="button" class="btn btn-outline-secondary border-start-0" id="togglePassword" style="border-radius: 0 8px 8px 0; border: 2px solid #e5e7eb; border-left: none; background: white;">
                                    <i class="bi bi-eye" id="passwordIcon"></i>
                                </button>
                            </div>
                        </div>
                        <div id="passwordError" class="alert alert-danger d-none border-0" role="alert" style="border-radius: 8px; background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); color: #dc2626;">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <span id="errorText"></span>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0 p-4" style="background: #f8fafc;">
                    <button type="button" class="btn btn-primary btn-lg px-4" id="verifyBtn" style="background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%); border: none; border-radius: 8px; font-weight: 600; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3); transition: all 0.3s ease;">
                        <i class="bi bi-check-circle-fill me-2"></i>Verify Access
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Blur overlay for modal background -->
    <style>
        #passwordModal.show {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        #passwordModal .modal-backdrop {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        #passwordModal .form-control:focus {
            border-color: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }

        #passwordModal .btn:hover {
            transform: translateY(-1px);
        }

        #passwordModal #togglePassword:hover {
            background: #f8fafc !important;
            border-color: #22c55e !important;
            color: #16a34a !important;
        }
    </style>

    <div class="container py-3" id="protectedContent">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="d-flex align-items-center">
                <div class="me-3" style="width:64px;height:64px;border-radius:12px;overflow:hidden;background:#f3f4f6;display:flex;align-items:center;justify-content:center">
                    {% if company and company.logo %}
                        <img src="{{ company.logo.url }}" alt="{{ company.company_name }} Logo" style="width:100%;height:100%;object-fit:cover">
                    {% else %}
                        <i class="bi bi-buildings" style="font-size:28px;color:#6b7280"></i>
                    {% endif %}
                </div>
                <div>
                    <h2 class="mb-0">{{ company.company_name|default:'Company Console' }}</h2>
                    <small class="text-muted">Manage company details, users and app metrics</small>
                </div>
            </div>
            <div>
                <button class="btn btn-primary" style="background: linear-gradient(135deg, #00d084 0%, #00b894 100%);" data-bs-toggle="modal" data-bs-target="#editCompanyModal">
                    <i class="bi bi-pencil-square me-1"></i> Update Company Details
                </button>
            </div>
        </div>

        <ul class="nav nav-tabs" id="companyTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="billing-tab" data-bs-toggle="tab" data-bs-target="#billing" type="button" role="tab">
                    <i class="bi bi-credit-card me-1"></i>Subscription & Billing
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="user-registration-tab" data-bs-toggle="tab" data-bs-target="#user-registration" type="button" role="tab">
                    <i class="bi bi-person-plus me-1"></i>Register Admins
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="admins-tab" data-bs-toggle="tab" data-bs-target="#admins" type="button" role="tab">Admins</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">Users</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="support-tab" data-bs-toggle="tab" data-bs-target="#support" type="button" role="tab">AdminSupport</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="apps-tab" data-bs-toggle="tab" data-bs-target="#apps" type="button" role="tab">App Metrics</button>
            </li>
        </ul>

        <div class="tab-content pt-3">
            <!-- Overview -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                <div class="row g-3">
                    <div class="col-lg-8">
                        <div class="card h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <strong>Company Details</strong>
                            </div>
                            <div class="card-body">
                                {% if company %}
                                    <div class="row mb-3">
                                        <div class="col-sm-6">
                                            <div class="text-muted small">Company Name</div>
                                            <div class="fw-semibold">{{ company.company_name }}</div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="text-muted small">Registration Number</div>
                                            <div class="fw-semibold">{{ company.registration_number }}</div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-sm-6">
                                            <div class="text-muted small">Registration Date</div>
                                            <div class="fw-semibold">{{ company.registration_date|date:'M d, Y' }}</div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="text-muted small">Email</div>
                                            <div class="fw-semibold">{{ company.email }}</div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-sm-6">
                                            <div class="text-muted small">Phone</div>
                                            <div class="fw-semibold">{{ company.phone }}</div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="text-muted small">Location / Address</div>
                                            <div class="fw-semibold">{{ company.location }}</div>
                                        </div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-12">
                                            <div class="text-muted small">Chief Executive Officers</div>
                                            <div class="mt-2">
                                                {% if company and company.ceos.all %}
                                                    {% for ceo in company.ceos.all %}
                                                            {% if ceo.is_primary %}
                                                                    <div class="d-inline-block me-2 mb-1">
                                                                        <span class="ceo-tag primary-ceo" title="Master CEO">
                                                                            <i class="bi bi-award-fill me-1" aria-hidden="true"></i>
                                                                            <span class="ceo-name">{{ ceo.name }}</span>
                                                                            <span class="ceo-role ms-2">Master CEO</span><br>
                                                                        </span>
                                                                    </div>
                                                            {% else %}
                                                                <div class="d-inline-block me-2 mb-1">
                                                                    <span class="ceo-tag other-ceo" title="Additional CEO">
                                                                        <i class="bi bi-person-fill me-1" aria-hidden="true"></i>
                                                                        <span class="ceo-name">{{ ceo.name }}</span>
                                                                    </span>
                                                                </div>
                                                            {% endif %}
                                                    {% endfor %}
                                                {% else %}
                                                    <div class="fw-semibold">{{ company.ceo_name }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Cashier / Receipts Section in Overview -->
                                    <div class="row mb-2">
                                        <div class="col-12">
                                            <div class="text-muted small">Cashier / Receipts</div>
                                            <div class="d-flex align-items-center gap-3 mt-2">
                                                <div>
                                                    <div class="fw-semibold">Name:</div>
                                                    <div>{{ company.cashier_name|default:'—' }}</div>
                                                </div>
                                                <div>
                                                    <div class="fw-semibold">Signature:</div>
                                                    {% if company.cashier_signature %}
                                                        <img src="{{ company.cashier_signature.url }}" alt="Cashier Signature" style="max-width: 120px; max-height: 60px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f9fafb; padding: 3px;">
                                                    {% else %}
                                                        <span class="text-muted">—</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="alert alert-info">No company linked yet. Use Edit to register details.</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card mb-3">
                            <div class="card-header bg-white"><strong>Key Stats</strong></div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="border rounded p-3 d-flex align-items-center gap-3">
                                            <div class="text-primary"><i class="bi bi-people" style="font-size:1.4rem"></i></div>
                                            <div>
                                                <div class="text-muted small">Clients</div>
                                                <div class="fs-5 fw-bold">{{ total_clients|default:0|intcomma }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="border rounded p-3 d-flex align-items-center gap-3">
                                            <div class="text-success"><i class="bi bi-person-badge" style="font-size:1.4rem"></i></div>
                                            <div>
                                                <div class="text-muted small">Marketers</div>
                                                <div class="fs-5 fw-bold">{{ total_marketers|default:0|intcomma }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="border rounded p-3 d-flex align-items-center gap-3">
                                            <div class="text-warning"><i class="bi bi-building" style="font-size:1.4rem"></i></div>
                                            <div>
                                                <div class="text-muted small">Estates</div>
                                                <div class="fs-5 fw-bold">{{ total_estates|default:0|intcomma }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="border rounded p-3 d-flex align-items-center gap-3">
                                            <div class="text-danger"><i class="bi bi-check2-square" style="font-size:1.4rem"></i></div>
                                            <div>
                                                <div class="text-muted small">Full Alloc.</div>
                                                <div class="fs-5 fw-bold">{{ total_full_allocations|default:0|intcomma }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="border rounded p-3 d-flex align-items-center gap-3">
                                            <div class="text-info"><i class="bi bi-file-earmark-text" style="font-size:1.4rem"></i></div>
                                            <div>
                                                <div class="text-muted small">Part Alloc.</div>
                                                <div class="fs-5 fw-bold">{{ total_part_allocations|default:0|intcomma }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header bg-white"><strong>Activity</strong></div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div><span class="badge bg-success">Active Users</span></div>
                                    <div class="fw-bold">{{ active_users_count|intcomma }}</div>
                                </div>
                                <div class="d-flex justify-content-between mt-2">
                                    <div><span class="badge bg-secondary">Inactive Users</span></div>
                                    <div class="fw-bold">{{ inactive_users_count|intcomma }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users -->
            <div class="tab-pane fade" id="users" role="tabpanel" aria-labelledby="users-tab">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <strong>Registered Users</strong>
                        <small class="text-muted">Latest 20</small>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Last Login</th>
                                    <th>Joined</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for u in registered_users %}
                                <tr>
                                    <td>{{ u.full_name }}</td>
                                    <td>{{ u.email }}</td>
                                    <td><span class="badge bg-outline-secondary" style="border:1px solid #ccc;color:#555">{{ u.role|default:'-' }}</span></td>
                                    <td>{{ u.last_login|date:'M d, Y H:i'|default:'—' }}</td>
                                    <td>{{ u.date_joined|date:'M d, Y' }}</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="5" class="text-center text-muted">No users yet.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admins -->
            <div class="tab-pane fade" id="admins" role="tabpanel" aria-labelledby="admins-tab">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <strong>Admin Users</strong>
                        <span class="badge bg-primary">{{ admin_users|length }}</span>
                    </div>
                                <div class="table-responsive">
                        <table class="table table-striped align-middle mb-0">
                            <thead class="table-light">
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Email</th>
                                                    <th>Phone</th>
                                                    <th>Joined</th>
                                                    <th>Last Login</th>
                                                    <th>Login Location</th>
                                                    <th>Status</th>
                                                    <th class="text-end">Actions</th>
                                                </tr>
                            </thead>
                            <tbody>
                                {% for a in admin_users %}
                                <tr>
                                    <td>
                                        {{ a.full_name }}
                                        {% if master_admin_id and a.id == master_admin_id %}
                                            <span class="badge bg-warning text-dark ms-2" title="Master admin">Master admin</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ a.email }}</td>
                                    <td>{{ a.phone|default:'-' }}</td>
                                                <td>{{ a.date_joined|date:'M d, Y' }}</td>
                                                    <td>{{ a.last_login|date:'M d, Y H:i'|default:'—' }}</td>
                                                    <td>
                                                        {% if a.last_login_location %}
                                                            {{ a.last_login_location }}
                                                        {% elif a.last_login_ip %}
                                                            {{ a.last_login_ip }}
                                                        {% else %}
                                                            —
                                                        {% endif %}
                                                    </td>
                                                <td>
                                                    {% if a.last_login %}
                                                        {% if a.is_active %}
                                                            <span class="badge bg-success">Active</span>
                                                        {% else %}
                                                            <span class="badge bg-secondary">Muted</span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="badge bg-warning">NOT ACTIVE</span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-end">
                                                    {% if master_admin_id and a.id == master_admin_id %}
                                                        <span class="text-muted">Master admin (protected)</span>
                                                    {% elif master_admin_id and request.user.id == master_admin_id %}
                                                        <button class="btn btn-sm btn-outline-primary me-2" data-action="edit-user" data-user-id="{{ a.id }}" data-user-type="admin" data-user-name="{{ a.full_name }}" data-user-email="{{ a.email }}" data-user-phone="{{ a.phone|default:'' }}" data-user-address="{{ a.address|default:'' }}">
                                                            <i class="bi bi-pencil"></i> Update
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-warning me-2" data-action="toggle-mute" data-user-id="{{ a.id }}" data-current="{{ a.is_active|yesno:'active,muted' }}">
                                                            {% if a.is_active %}<i class="bi bi-volume-mute"></i> Mute{% else %}<i class="bi bi-volume-up"></i> Unmute{% endif %}
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger" data-action="delete-admin" data-user-id="{{ a.id }}" data-name="{{ a.full_name }}">
                                                            <i class="bi bi-trash"></i> Delete
                                                        </button>
                                                    {% else %}
                                                        <span class="text-muted">Only master admin can Update</span>
                                                    {% endif %}
                                                </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="8" class="text-center text-muted">No admin users found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                        <div class="card mt-3">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <strong>Support Users</strong>
                        <span class="badge bg-secondary">{{ support_users|length }}</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped align-middle mb-0">
                            <thead class="table-light">
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Email</th>
                                                    <th>Phone</th>
                                                    <th>Joined</th>
                                                    <th>Last Login</th>
                                                    <th>Login Location</th>
                                                    <th>Status</th>
                                                    <th class="text-end">Actions</th>
                                                </tr>
                            </thead>
                            <tbody>
                                {% for s in support_users %}
                                <tr>
                                    <td>{{ s.full_name }}</td>
                                    <td>{{ s.email }}</td>
                                    <td>{{ s.phone|default:'-' }}</td>
                                            <td>{{ s.date_joined|date:'M d, Y' }}</td>
                                                    <td>{{ s.last_login|date:'M d, Y H:i'|default:'—' }}</td>
                                                    <td>
                                                        {% if s.last_login_location %}
                                                            {{ s.last_login_location }}
                                                        {% elif s.last_login_ip %}
                                                            {{ s.last_login_ip }}
                                                        {% else %}
                                                            —
                                                        {% endif %}
                                                    </td>
                                            <td>
                                                {% if s.status_display == "Active" %}
                                                    <span class="badge bg-success">Active</span>
                                                {% elif s.status_display == "Not Active" %}
                                                    <span class="badge bg-secondary">Not Active</span>
                                                {% else %}
                                                    <span class="badge bg-warning">{{ s.status_display }}</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-end">
                                                {% if master_admin_id and request.user.id == master_admin_id %}
                                                    <button class="btn btn-sm btn-outline-primary me-2" data-action="edit-user" data-user-id="{{ s.id }}" data-user-type="support" data-user-name="{{ s.full_name }}" data-user-email="{{ s.email }}" data-user-phone="{{ s.phone|default:'' }}" data-user-address="{{ s.address|default:'' }}">
                                                        <i class="bi bi-pencil"></i> Update
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-warning me-2" data-action="toggle-mute" data-user-id="{{ s.id }}" data-current="{{ s.is_active|yesno:'active,muted' }}">
                                                        {% if s.is_active %}<i class="bi bi-volume-mute"></i> Mute{% else %}<i class="bi bi-volume-up"></i> Unmute{% endif %}
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" data-action="delete-admin" data-user-id="{{ s.id }}" data-name="{{ s.full_name }}">
                                                        <i class="bi bi-trash"></i> Delete
                                                    </button>
                                                {% else %}
                                                    <span class="text-muted">Only master admin can Update</span>
                                                {% endif %}
                                            </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="8" class="text-center text-muted">No support users found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- AdminSupport -->
            <div class="tab-pane fade" id="support" role="tabpanel" aria-labelledby="support-tab">
                <div class="row g-3">
                    <div class="col-lg-6">
                        <div class="card h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <strong>Staff Roster (linked users)</strong>
                                <span class="badge bg-info">{{ staff_roster_count }}</span>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>User</th>
                                            <th>Email</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for r in staff_roster %}
                                        <tr>
                                            <td>{{ r.user.full_name }}</td>
                                            <td>{{ r.user.email }}</td>
                                            <td>{% if r.active %}<span class="badge bg-success">Active</span>{% else %}<span class="badge bg-secondary">Inactive</span>{% endif %}</td>
                                        </tr>
                                        {% empty %}
                                        <tr><td colspan="3" class="text-center text-muted">No roster entries.</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <strong>Staff Members (directory)</strong>
                                <span class="badge bg-info">{{ staff_members_count }}</span>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for m in staff_members %}
                                        <tr>
                                            <td>{{ m.full_name }}</td>
                                            <td>{{ m.email }}</td>
                                            <td>{{ m.role|default:'—' }}</td>
                                            <td>{% if m.active %}<span class="badge bg-success">Active</span>{% else %}<span class="badge bg-secondary">Inactive</span>{% endif %}</td>
                                        </tr>
                                        {% empty %}
                                        <tr><td colspan="4" class="text-center text-muted">No staff members yet.</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- App Metrics -->
            <div class="tab-pane fade" id="apps" role="tabpanel" aria-labelledby="apps-tab">
                <div class="row g-3">
                    <div class="col-lg-4">
                        <div class="card h-100">
                            <div class="card-header bg-white"><strong>Downloads</strong></div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2"><span>Android</span><span class="fw-bold">{{ app_metrics.android_downloads|default:0|intcomma }}</span></div>
                                <div class="d-flex justify-content-between mb-2"><span>iOS</span><span class="fw-bold">{{ app_metrics.ios_downloads|default:0|intcomma }}</span></div>
                                <div class="d-flex justify-content-between border-top pt-2"><span>Total</span><span class="fw-bold">{{ total_downloads|intcomma }}</span></div>
                                {% if app_metrics %}
                                <small class="text-muted d-block mt-2">Updated {{ app_metrics.last_updated|date:'M d, Y H:i' }}</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="card h-100">
                            <div class="card-header bg-white"><strong>Active vs Inactive Users</strong></div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-sm-6">
                                        <div class="p-3 border rounded text-center">
                                            <div class="display-6 text-success">{{ active_users_count|intcomma }}</div>
                                            <div class="text-muted">Active (30 days)</div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="p-3 border rounded text-center">
                                            <div class="display-6 text-secondary">{{ inactive_users_count|intcomma }}</div>
                                            <div class="text-muted">Inactive</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Subscription & Billing -->
            <div class="tab-pane fade" id="billing" role="tabpanel" aria-labelledby="billing-tab">
                <div class="row g-3">
                    <!-- Premium Subscription Status Card -->
                    <div class="col-lg-12">
                        <div class="card border-0 shadow-lg subscription-premium-card">
                            <!-- Header with Advanced Gradient Green -->
                            <div class="subscription-header-premium">
                                <div class="subscription-header-glow"></div>
                                <div class="d-flex justify-content-between align-items-center position-relative z-1">
                                    <div class="subscription-header-content">
                                        <h5 class="mb-0 subscription-title">
                                            <i class="bi bi-credit-card me-2"></i>Subscription Management
                                        </h5>
                                        <small class="subscription-subtitle">Manage your plan, billing & features</small>
                                    </div>
                                    <div class="subscription-status-badge">
                                        {% if subscription %}
                                            <div class="status-indicator active">
                                                <span class="status-pulse"></span>
                                                <span class="status-text">{{ subscription.get_current_status|upper }}</span>
                                            </div>
                                        {% else %}
                                            <div class="status-indicator inactive">
                                                <span class="status-pulse"></span>
                                                <span class="status-text">No Subscription</span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Card Body -->
                            <div class="card-body subscription-body-premium">
                                {% if subscription %}
                                    <!-- Current Plan Card - Premium Display -->
                                    <div class="current-plan-section mb-4">
                                        <div class="row g-3">
                                            <!-- Plan Information -->
                                            <div class="col-lg-4">
                                                <div class="plan-info-card">
                                                    <div class="plan-icon-wrapper">
                                                        <i class="bi bi-rocket-takeoff"></i>
                                                    </div>
                                                    <div class="plan-details">
                                                        <small class="plan-label">Current Plan</small>
                                                        <h4 class="plan-name">{{ subscription.subscription_plan.name }}</h4>
                                                        <div class="plan-pricing">
                                                            <span class="currency">₦</span><span class="amount">{{ subscription.amount|floatformat:0|intcomma }}</span>
                                                            <small class="period">/month</small>
                                                        </div>
                                                    </div>
                                                    <div class="plan-checkmark">
                                                        <i class="bi bi-check-circle-fill"></i>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Timeline & Dates -->
                                            <div class="col-lg-4">
                                                <div class="timeline-card">
                                                    <small class="timeline-label">Subscription Period</small>
                                                    <div class="timeline-dates">
                                                        <div class="date-row start">
                                                            <span class="date-icon"><i class="bi bi-calendar-check"></i></span>
                                                            <div>
                                                                <small>Started</small>
                                                                <div class="fw-bold">{{ subscription.subscription_starts_at|date:'M d, Y' }}</div>
                                                            </div>
                                                        </div>
                                                        <div class="timeline-connector"></div>
                                                        <div class="date-row end">
                                                            <span class="date-icon"><i class="bi bi-calendar-x"></i></span>
                                                            <div>
                                                                <small>Expires</small>
                                                                <div class="fw-bold">{{ subscription.subscription_ends_at|date:'M d, Y' }}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Days Remaining Counter -->
                                            <div class="col-lg-4">
                                                <div class="days-remaining-card">
                                                    <small class="remaining-label">Days Remaining</small>
                                                    <div class="days-counter">
                                                        <span class="counter-value">{{ subscription.days_remaining|default:0 }}</span>
                                                        <span class="counter-unit">days</span>
                                                    </div>
                                                    <div class="progress-bar-premium">
                                                        {% widthratio subscription.days_remaining 365 100 as days_percentage %}
                                                        <div class="progress-fill" data-width="{{ days_percentage }}"></div>
                                                    </div>
                                                    <small class="remaining-text">
                                                        {% if subscription.days_remaining > 30 %}
                                                            <span class="badge bg-success">Active & Valid</span>
                                                        {% elif subscription.days_remaining > 7 %}
                                                            <span class="badge bg-warning">Renew Soon</span>
                                                        {% else %}
                                                            <span class="badge bg-danger">Expiring Soon</span>
                                                        {% endif %}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Payment Method Section -->
                                    <div class="payment-section mb-4">
                                        <h6 class="section-title">Payment Details</h6>
                                        <div class="payment-info-grid">
                                            <div class="payment-info-item">
                                                <small class="info-label">Payment Method</small>
                                                <div class="info-value">
                                                    {% if subscription.payment_method == 'stripe' %}
                                                        <i class="bi bi-credit-card text-primary"></i> Stripe
                                                    {% elif subscription.payment_method == 'paystack' %}
                                                        <i class="bi bi-wallet2 text-info"></i> Paystack
                                                    {% else %}
                                                        {{ subscription.payment_method|upper }}
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% if subscription.transaction_id %}
                                            <div class="payment-info-item">
                                                <small class="info-label">Transaction ID</small>
                                                <div class="info-value mono">{{ subscription.transaction_id|truncatechars:20 }}</div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Status Alerts -->
                                    {% if subscription.is_in_grace_period %}
                                        <div class="alert alert-danger alert-premium mb-4">
                                            <div class="alert-icon"><i class="bi bi-exclamation-circle-fill"></i></div>
                                            <div class="alert-content">
                                                <strong>⚠️ Grace Period Active</strong><br>
                                                <small>Your subscription has expired. Limited access available for 7 days. Renew now to restore full features.</small>
                                            </div>
                                            <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#renewSubscriptionModal">
                                                Renew Now
                                            </button>
                                        </div>
                                    {% elif subscription.warning_level %}
                                        <div class="alert alert-warning alert-premium mb-4">
                                            <div class="alert-icon"><i class="bi bi-exclamation-triangle-fill"></i></div>
                                            <div class="alert-content">
                                                <strong>📢 Subscription Expiring Soon</strong><br>
                                                <small>Your subscription expires in {{ subscription.days_remaining }} days. Renew to maintain uninterrupted access.</small>
                                            </div>
                                            <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#renewSubscriptionModal">
                                                Renew
                                            </button>
                                        </div>
                                    {% else %}
                                        <div class="alert alert-success alert-premium mb-4">
                                            <div class="alert-icon"><i class="bi bi-check-circle-fill"></i></div>
                                            <div class="alert-content">
                                                <strong>✓ Subscription Active</strong><br>
                                                <small>Your subscription is active and all features are available.</small>
                                            </div>
                                        </div>
                                    {% endif %}

                                    <!-- Action Buttons -->
                                    <div class="action-buttons-section">
                                        <h6 class="section-title mb-3">Quick Actions</h6>
                                        <div class="d-flex gap-2 flex-wrap">
                                            <button class="btn btn-premium btn-upgrade" data-bs-toggle="modal" data-bs-target="#upgradePlanModal">
                                                <i class="bi bi-arrow-up-right me-2"></i>
                                                <span>Upgrade Plan</span>
                                            </button>
                                            <button class="btn btn-premium btn-renew" data-bs-toggle="modal" data-bs-target="#renewSubscriptionModal">
                                                <i class="bi bi-arrow-clockwise me-2"></i>
                                                <span>Renew Subscription</span>
                                            </button>
                                            <button class="btn btn-outline-premium" onclick="showBillingHistory()">
                                                <i class="bi bi-receipt me-2"></i>
                                                <span>Billing History</span>
                                            </button>
                                        </div>
                                    </div>

                                {% else %}
                                    <!-- No Subscription State -->
                                    <div class="no-subscription-state">
                                        <div class="no-subscription-icon">
                                            <i class="bi bi-inbox"></i>
                                        </div>
                                        <h5>No Active Subscription</h5>
                                        <p class="text-muted">Start your journey by selecting a plan that fits your business needs. Choose from our carefully crafted tiers with features tailored to your growth.</p>
                                        <button class="btn btn-premium btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#selectPlanModal">
                                            <i class="bi bi-sparkles me-2"></i>
                                            <span>Explore Plans & Get Started</span>
                                        </button>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Subscription CSS -->
                        <style>
                            /* Premium Subscription Card Styles */
                            .subscription-premium-card {
                                border-radius: 16px;
                                overflow: hidden;
                            }

                            .subscription-header-premium {
                                position: relative;
                                padding: 30px;
                                background: linear-gradient(135deg, #0f7c3a 0%, #15a34a 25%, #22c55e 50%, #84cc16 75%, #bfdbfe 100%);
                                color: white;
                                overflow: hidden;
                            }

                            .subscription-header-glow {
                                position: absolute;
                                top: 0;
                                left: 0;
                                right: 0;
                                bottom: 0;
                                background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 60%);
                                animation: glow-pulse 3s ease-in-out infinite;
                            }

                            @keyframes glow-pulse {
                                0%, 100% { opacity: 1; }
                                50% { opacity: 0.7; }
                            }

                            .subscription-header-content {
                                flex: 1;
                            }

                            .subscription-title {
                                font-size: 1.5rem;
                                font-weight: 700;
                                letter-spacing: -0.5px;
                            }

                            .subscription-subtitle {
                                opacity: 0.95;
                                display: block;
                                margin-top: 4px;
                            }

                            .subscription-status-badge {
                                text-align: right;
                            }

                            .status-indicator {
                                display: inline-flex;
                                align-items: center;
                                gap: 8px;
                                padding: 8px 16px;
                                background: rgba(255,255,255,0.2);
                                border-radius: 20px;
                                backdrop-filter: blur(10px);
                            }

                            .status-indicator.active .status-pulse {
                                background: #4ade80;
                                box-shadow: 0 0 12px rgba(74, 222, 128, 0.6);
                            }

                            .status-indicator.inactive .status-pulse {
                                background: #ef4444;
                                box-shadow: 0 0 12px rgba(239, 68, 68, 0.6);
                            }

                            .status-pulse {
                                width: 8px;
                                height: 8px;
                                border-radius: 50%;
                                animation: pulse-animation 2s ease-in-out infinite;
                            }

                            @keyframes pulse-animation {
                                0%, 100% { transform: scale(1); opacity: 1; }
                                50% { transform: scale(1.2); opacity: 0.8; }
                            }

                            .status-text {
                                font-size: 0.85rem;
                                font-weight: 600;
                            }

                            /* Body Styles */
                            .subscription-body-premium {
                                padding: 30px;
                                background: linear-gradient(to bottom, #ffffff 0%, #f0fdf4 100%);
                            }

                            .current-plan-section {
                                background: white;
                                border-radius: 12px;
                                padding: 20px;
                                border: 1px solid #dcfce7;
                            }

                            .plan-info-card {
                                background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
                                border: 2px solid #bbf7d0;
                                border-radius: 12px;
                                padding: 20px;
                                position: relative;
                                display: flex;
                                flex-direction: column;
                                gap: 16px;
                                transition: all 0.3s ease;
                            }

                            .plan-info-card:hover {
                                transform: translateY(-4px);
                                box-shadow: 0 12px 24px rgba(34, 197, 94, 0.15);
                            }

                            .plan-icon-wrapper {
                                font-size: 2.5rem;
                                color: #16a34a;
                                animation: icon-float 3s ease-in-out infinite;
                            }

                            @keyframes icon-float {
                                0%, 100% { transform: translateY(0); }
                                50% { transform: translateY(-8px); }
                            }

                            .plan-details {
                                flex: 1;
                            }

                            .plan-label {
                                display: block;
                                color: #65a30d;
                                font-weight: 600;
                                margin-bottom: 4px;
                            }

                            .plan-name {
                                color: #15a34a;
                                font-weight: 700;
                                margin: 0;
                            }

                            .plan-pricing {
                                display: flex;
                                align-items: baseline;
                                gap: 2px;
                                margin-top: 8px;
                            }

                            .plan-pricing .currency {
                                font-size: 1.2rem;
                                color: #059669;
                            }

                            .plan-pricing .amount {
                                font-size: 1.8rem;
                                font-weight: 700;
                                color: #0f7c3a;
                            }

                            .plan-pricing .period {
                                color: #6b7280;
                                margin-left: 4px;
                            }

                            .plan-checkmark {
                                position: absolute;
                                top: 12px;
                                right: 12px;
                                font-size: 1.8rem;
                                color: #22c55e;
                            }

                            /* Timeline Card */
                            .timeline-card {
                                background: white;
                                border: 1px solid #e5e7eb;
                                border-radius: 12px;
                                padding: 20px;
                            }

                            .timeline-label {
                                display: block;
                                color: #6b7280;
                                font-weight: 600;
                                margin-bottom: 16px;
                            }

                            .timeline-dates {
                                position: relative;
                            }

                            .date-row {
                                display: flex;
                                gap: 12px;
                                padding: 12px;
                                border-radius: 8px;
                            }

                            .date-row.start {
                                background: #f3f4f6;
                            }

                            .date-row.end {
                                background: #fef2f2;
                            }

                            .date-icon {
                                font-size: 1.2rem;
                                display: flex;
                                align-items: center;
                                min-width: 24px;
                            }

                            .date-row.start .date-icon {
                                color: #16a34a;
                            }

                            .date-row.end .date-icon {
                                color: #dc2626;
                            }

                            .date-row small {
                                display: block;
                                color: #6b7280;
                                font-size: 0.75rem;
                            }

                            .timeline-connector {
                                width: 2px;
                                height: 16px;
                                background: linear-gradient(to bottom, #16a34a, #dc2626);
                                margin: 4px auto;
                            }

                            /* Days Remaining Card */
                            .days-remaining-card {
                                background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
                                border: 2px solid #bbf7d0;
                                border-radius: 12px;
                                padding: 20px;
                                text-align: center;
                            }

                            .remaining-label {
                                display: block;
                                color: #65a30d;
                                font-weight: 600;
                                margin-bottom: 12px;
                            }

                            .days-counter {
                                margin-bottom: 16px;
                            }

                            .counter-value {
                                display: block;
                                font-size: 2.5rem;
                                font-weight: 700;
                                color: #15a34a;
                            }

                            .counter-unit {
                                display: block;
                                color: #6b7280;
                                font-size: 0.9rem;
                            }

                            .progress-bar-premium {
                                height: 6px;
                                background: #e5e7eb;
                                border-radius: 3px;
                                overflow: hidden;
                                margin-bottom: 12px;
                            }

                            .progress-fill {
                                height: 100%;
                                background: linear-gradient(90deg, #16a34a 0%, #22c55e 100%);
                                transition: width 0.3s ease;
                            }

                            /* Payment Section */
                            .payment-section {
                                background: white;
                                border-radius: 12px;
                                padding: 20px;
                                border: 1px solid #e5e7eb;
                            }

                            .section-title {
                                color: #1f2937;
                                font-weight: 600;
                                margin-bottom: 16px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                            }

                            .payment-info-grid {
                                display: grid;
                                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                                gap: 16px;
                            }

                            .payment-info-item {
                                background: #f9fafb;
                                border-radius: 8px;
                                padding: 12px;
                            }

                            .info-label {
                                display: block;
                                color: #6b7280;
                                font-weight: 500;
                                margin-bottom: 6px;
                            }

                            .info-value {
                                font-weight: 600;
                                color: #1f2937;
                            }

                            .info-value.mono {
                                font-family: 'Courier New', monospace;
                                font-size: 0.9rem;
                            }

                            /* Alert Styles */
                            .alert-premium {
                                background: white;
                                border-left: 4px solid;
                                border-radius: 8px;
                                padding: 16px;
                                display: flex;
                                align-items: center;
                                gap: 16px;
                            }

                            .alert-premium.alert-danger {
                                border-left-color: #dc2626;
                                background: #fef2f2;
                            }

                            .alert-premium.alert-warning {
                                border-left-color: #f59e0b;
                                background: #fffbeb;
                            }

                            .alert-premium.alert-success {
                                border-left-color: #16a34a;
                                background: #f0fdf4;
                            }

                            .alert-icon {
                                font-size: 1.5rem;
                                flex-shrink: 0;
                            }

                            .alert-premium.alert-danger .alert-icon { color: #dc2626; }
                            .alert-premium.alert-warning .alert-icon { color: #f59e0b; }
                            .alert-premium.alert-success .alert-icon { color: #16a34a; }

                            .alert-content {
                                flex: 1;
                            }

                            .alert-content strong {
                                display: block;
                                margin-bottom: 4px;
                            }

                            .alert-content small {
                                color: #6b7280;
                            }

                            /* Action Buttons */
                            .action-buttons-section {
                                background: white;
                                border-radius: 12px;
                                padding: 20px;
                                border: 1px solid #e5e7eb;
                            }

                            .btn-premium {
                                position: relative;
                                overflow: hidden;
                                border: none;
                                font-weight: 600;
                                border-radius: 8px;
                                padding: 10px 20px;
                                transition: all 0.3s ease;
                            }

                            .btn-premium::before {
                                content: '';
                                position: absolute;
                                top: 0;
                                left: -100%;
                                width: 100%;
                                height: 100%;
                                background: rgba(255,255,255,0.2);
                                transition: left 0.3s ease;
                            }

                            .btn-premium:hover::before {
                                left: 100%;
                            }

                            .btn-upgrade {
                                background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
                                color: white;
                            }

                            .btn-upgrade:hover {
                                transform: translateY(-2px);
                                box-shadow: 0 8px 16px rgba(34, 197, 94, 0.3);
                                color: white;
                            }

                            .btn-renew {
                                background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%);
                                color: white;
                            }

                            .btn-renew:hover {
                                transform: translateY(-2px);
                                box-shadow: 0 8px 16px rgba(6, 182, 212, 0.3);
                                color: white;
                            }

                            .btn-outline-premium {
                                border: 2px solid #22c55e;
                                color: #16a34a;
                                background: white;
                            }

                            .btn-outline-premium:hover {
                                background: #f0fdf4;
                                border-color: #16a34a;
                                color: #15a34a;
                            }

                            /* No Subscription State */
                            .no-subscription-state {
                                text-align: center;
                                padding: 40px 20px;
                            }

                            .no-subscription-icon {
                                font-size: 3rem;
                                color: #d1d5db;
                                margin-bottom: 16px;
                            }

                            .no-subscription-state h5 {
                                color: #1f2937;
                                margin-bottom: 12px;
                            }

                            .no-subscription-state p {
                                max-width: 400px;
                                margin: 0 auto 24px;
                            }

                            .btn-primary {
                                background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
                                border: none;
                            }

                            .btn-primary:hover {
                                background: linear-gradient(135deg, #15803d 0%, #16a34a 100%);
                            }

                            /* Responsive */
                            @media (max-width: 768px) {
                                .subscription-header-premium {
                                    padding: 20px;
                                }

                                .subscription-title {
                                    font-size: 1.2rem;
                                }

                                .plan-pricing .amount {
                                    font-size: 1.5rem;
                                }

                                .payment-info-grid {
                                    grid-template-columns: 1fr;
                                }

                                .d-flex.gap-2 {
                                    flex-direction: column;
                                }

                                .d-flex.gap-2 .btn {
                                    width: 100%;
                                }
                            }
                        </style>
                    </div>

                    <!-- Feature Access Matrix (if subscribed) -->
                    {% if subscription %}
                    <div class="col-lg-6">
                        <div class="card h-100 features-card">
                            <div class="card-header bg-white border-bottom">
                                <strong><i class="bi bi-star me-2" style="color: #f59e0b;"></i>Features Included</strong>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-column gap-3">
                                    <div class="feature-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span><i class="bi bi-house me-2" style="color: #3b82f6;"></i>Create Properties</span>
                                            <span class="badge bg-success"><i class="bi bi-check-lg"></i> Enabled</span>
                                        </div>
                                    </div>
                                    <div class="feature-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span><i class="bi bi-people me-2" style="color: #06b6d4;"></i>Manage Users</span>
                                            <span class="badge bg-success"><i class="bi bi-check-lg"></i> Enabled</span>
                                        </div>
                                    </div>
                                    <div class="feature-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span><i class="bi bi-bar-chart me-2" style="color: #f59e0b;"></i>View Analytics</span>
                                            {% if subscription.subscription_plan.name == 'Free' %}
                                                <span class="badge bg-secondary"><i class="bi bi-x-lg"></i> Disabled</span>
                                            {% else %}
                                                <span class="badge bg-success"><i class="bi bi-check-lg"></i> Enabled</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="feature-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span><i class="bi bi-person-badge me-2" style="color: #22c55e;"></i>Create Marketers</span>
                                            {% if subscription.subscription_plan.name in 'Starter,Free' %}
                                                <span class="badge bg-secondary"><i class="bi bi-x-lg"></i> Disabled</span>
                                            {% else %}
                                                <span class="badge bg-success"><i class="bi bi-check-lg"></i> Enabled</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Usage Metrics -->
                    <div class="col-lg-6">
                        <div class="card h-100 usage-metrics-card">
                            <div class="card-header bg-white border-bottom">
                                <strong><i class="bi bi-graph-up me-2" style="color: #16a34a;"></i>Usage Metrics</strong>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="metric-item properties-metric">
                                            <div class="metric-value">{{ total_properties|default:0 }}</div>
                                            <small class="metric-label">Properties</small>
                                            <i class="metric-icon bi bi-house"></i>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="metric-item clients-metric">
                                            <div class="metric-value">{{ total_clients|default:0 }}</div>
                                            <small class="metric-label">Clients</small>
                                            <i class="metric-icon bi bi-people"></i>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="metric-item marketers-metric">
                                            <div class="metric-value">{{ total_marketers|default:0 }}</div>
                                            <small class="metric-label">Marketers</small>
                                            <i class="metric-icon bi bi-person-badge"></i>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="metric-item allocations-metric">
                                            <div class="metric-value">{{ total_allocations|default:0 }}</div>
                                            <small class="metric-label">Allocations</small>
                                            <i class="metric-icon bi bi-check2-square"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <style>
                        .features-card .feature-item {
                            padding: 12px 0;
                            border-bottom: 1px solid #e5e7eb;
                            transition: all 0.3s ease;
                        }

                        .features-card .feature-item:last-child {
                            border-bottom: none;
                        }

                        .features-card .feature-item:hover {
                            padding-left: 8px;
                            background: linear-gradient(90deg, rgba(16, 185, 129, 0.05) 0%, transparent 100%);
                        }

                        .features-card .badge {
                            font-size: 0.8rem;
                            padding: 6px 12px;
                        }

                        .usage-metrics-card .metric-item {
                            position: relative;
                            border-radius: 12px;
                            padding: 16px 12px;
                            text-align: center;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            gap: 8px;
                            border: 2px solid #e5e7eb;
                            transition: all 0.3s ease;
                            overflow: hidden;
                        }

                        .usage-metrics-card .metric-item::before {
                            content: '';
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, transparent 100%);
                            opacity: 0;
                            transition: opacity 0.3s ease;
                            z-index: 0;
                        }

                        .usage-metrics-card .metric-item:hover {
                            transform: translateY(-4px);
                            border-color: #22c55e;
                            box-shadow: 0 8px 16px rgba(34, 197, 94, 0.15);
                        }

                        .usage-metrics-card .metric-item:hover::before {
                            opacity: 1;
                        }

                        .metric-value {
                            font-size: 2rem;
                            font-weight: 700;
                            position: relative;
                            z-index: 1;
                        }

                        .metric-label {
                            font-size: 0.85rem;
                            color: #6b7280;
                            position: relative;
                            z-index: 1;
                        }

                        .metric-icon {
                            font-size: 1.5rem;
                            position: absolute;
                            top: 8px;
                            right: 8px;
                            opacity: 0.2;
                        }

                        .properties-metric .metric-value { color: #3b82f6; }
                        .properties-metric .metric-icon { color: #3b82f6; }

                        .clients-metric .metric-value { color: #06b6d4; }
                        .clients-metric .metric-icon { color: #06b6d4; }

                        .marketers-metric .metric-value { color: #22c55e; }
                        .marketers-metric .metric-icon { color: #22c55e; }

                        .allocations-metric .metric-value { color: #f59e0b; }
                        .allocations-metric .metric-icon { color: #f59e0b; }
                    </style>
                    {% endif %}

                    <!-- Billing History -->
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <strong><i class="bi bi-receipt me-2"></i>Recent Transactions</strong>
                                <span class="badge bg-info">Latest 10</span>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Description</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for transaction in billing_history %}
                                        <tr>
                                            <td>{{ transaction.created_at|date:'M d, Y H:i' }}</td>
                                            <td>
                                                {% if transaction.transaction_type == 'charge' %}
                                                    <span class="badge bg-danger">Charge</span>
                                                {% elif transaction.transaction_type == 'refund' %}
                                                    <span class="badge bg-success">Refund</span>
                                                {% elif transaction.transaction_type == 'upgrade' %}
                                                    <span class="badge bg-primary">Upgrade</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ transaction.transaction_type|upper }}</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ transaction.description|default:'—' }}</td>
                                            <td class="fw-bold">₦{{ transaction.amount|floatformat:2|intcomma }}</td>
                                            <td>
                                                <span class="badge bg-success">Completed</span>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr><td colspan="5" class="text-center text-muted py-3">No transactions yet.</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% include 'admin_side/company_user_registration.html' %}
        </div>

        <div class="text-end mt-3">
            <a href="{% url 'admin-dashboard' %}" class="btn btn-outline-secondary">Back to Dashboard</a>
        </div>
    </div>

    <!-- ===== SUBSCRIPTION & BILLING MODALS ===== -->

    <!-- Select Plan Modal -->
    <div class="modal fade" id="selectPlanModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-star me-2"></i>Choose Your Plan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3" id="plansContainer">
                        <!-- Plans will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upgrade Plan Modal -->
    <div class="modal fade" id="upgradePlanModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-arrow-up-right me-2"></i>Upgrade Your Plan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Current Plan:</strong> <span id="currentPlanName">Loading...</span>
                    </div>
                    <div class="row g-3" id="upgradePlansContainer">
                        <!-- Upgrade plans will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Renew Subscription Modal -->
    <div class="modal fade" id="renewSubscriptionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-arrow-clockwise me-2"></i>Renew Your Subscription</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="renewSubscriptionForm">
                    <div class="modal-body">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">Current Plan</label>
                            <div class="p-3 bg-light border rounded">
                                <strong id="renewPlanName">Loading...</strong>
                                <div class="text-muted small">Monthly subscription</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Renewal Amount</label>
                            <div class="p-3 bg-light border rounded">
                                <h5 class="mb-0">₦<span id="renewAmount">0</span></h5>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment Method</label>
                            <select name="payment_method" class="form-select" required>
                                <option value="">Select payment method...</option>
                                <option value="stripe">Credit Card (Stripe)</option>
                                <option value="paystack">Paystack (Bank Transfer, Card, Mobile Money)</option>
                            </select>
                        </div>
                        <div class="alert d-none" id="renewFeedback"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-credit-card me-1"></i> Proceed to Payment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-credit-card me-2"></i>Complete Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="paymentForm">
                    <div class="modal-body">
                        {% csrf_token %}
                        <div class="mb-3 p-3 bg-light border rounded">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Plan:</span>
                                <strong id="paymentPlan">—</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Amount:</span>
                                <strong id="paymentAmount">₦0</strong>
                            </div>
                            <div class="d-flex justify-content-between border-top pt-2">
                                <span>Total:</span>
                                <h6 class="mb-0" id="paymentTotal">₦0</h6>
                            </div>
                        </div>
                        <div id="stripePaymentContainer" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Card Details</label>
                                <div id="cardElement" class="form-control p-3" style="height: 40px; padding-top: 10px !important;"></div>
                                <div id="cardErrors" class="text-danger small mt-2"></div>
                            </div>
                        </div>
                        <div id="paystackPaymentContainer" style="display: none;">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                You will be redirected to Paystack to complete your payment securely.
                            </div>
                        </div>
                        <div class="alert d-none" id="paymentFeedback"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success" id="paymentSubmitBtn">
                            <i class="bi bi-check-circle me-1"></i> Pay Now
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ===== END SUBSCRIPTION & BILLING MODALS ===== -->

    <div class="modal fade" id="editCompanyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Company Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="companyEditForm" enctype="multipart/form-data">
                    <div class="modal-body">
                        {% csrf_token %}
                        {% if company %}
                        <div class="row g-3">
                            <div class="col-12">
                                <small class="text-muted">Use this form to update company details. You can add additional CEOs below.</small>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Company Name</label>
                                <input type="text" name="company_name" class="form-control form-control-lg" value="{{ company.company_name }}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Registration Number</label>
                                <input type="text" name="registration_number" class="form-control" value="{{ company.registration_number }}" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Registration Date</label>
                                <input type="date" name="registration_date" class="form-control" value="{{ company.registration_date|date:'Y-m-d' }}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Location</label>
                                <input type="text" name="location" class="form-control" value="{{ company.location }}" required>
                            </div>

                            <div class="col-12">
                                <hr>
                                <h6 class="mb-2">Chief Executive Officers</h6>
                            </div>

                            <!-- Primary CEO (existing during signup) -->
                            <div class="col-md-6">
                                <label class="form-label">CEO Name <span class="ceo-tag ms-2" style="font-size: 10px;">Master CEO</span></label>
                                {% if company and company.ceos.all %}
                                    {% with primary=company.ceos.all.0 %}
                                        <input type="text" name="primary_ceo_name" class="form-control" value="{{ primary.name }}" required>
                                    {% endwith %}
                                {% else %}
                                    <input type="text" name="primary_ceo_name" class="form-control" value="{{ company.ceo_name }}">
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">CEO Date of Birth</label>
                                {% if company and company.ceos.all %}
                                    {% with primary=company.ceos.all.0 %}
                                        <input type="date" name="primary_ceo_dob" class="form-control" value="{{ primary.dob|date:'Y-m-d' }}">
                                    {% endwith %}
                                {% else %}
                                    <input type="date" name="primary_ceo_dob" class="form-control" value="{{ company.ceo_dob|date:'Y-m-d' }}">
                                {% endif %}
                            </div>

                            <!-- Dynamic additional CEOs container -->
                            <div class="col-12">
                                <div id="additionalCeoList">
                                    {% if company and company.ceos.all %}
                                        {% for ceo in company.ceos.all|slice:"1:" %}
                                            <div class="row g-2 mb-2 ceo-item" data-ceo-id="{{ ceo.id }}" data-ceo-name="{{ ceo.name }}">
                                                <div class="col-md-5">
                                                    <input type="text" name="other_ceo_name[]" class="form-control" value="{{ ceo.name }}" placeholder="Additional CEO name">
                                                </div>
                                                <div class="col-md-5">
                                                    <input type="date" name="other_ceo_dob[]" class="form-control" value="{{ ceo.dob|date:'Y-m-d' }}">
                                                </div>
                                                <div class="col-md-2 d-flex align-items-center">
                                                    <button type="button" class="btn btn-outline-danger btn-sm w-100 remove-ceo-btn">Remove</button>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                <div class="mt-2">
                                    <button type="button" id="addCeoBtn" class="btn btn-outline-success btn-sm"><i class="bi bi-plus-lg me-1"></i> Add More CEOs</button>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" name="email" class="form-control" value="{{ company.email }}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Phone</label>
                                <input type="text" name="phone" class="form-control" value="{{ company.phone }}" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Logo</label>
                                <div class="custom-file-upload mb-2" id="logoDropArea">
                                    <input type="file" name="logo" accept="image/*" id="logoInput" class="custom-file-input" style="display:none;">
                                    <div class="upload-box d-flex flex-column align-items-center justify-content-center p-3" id="logoUploadBox" style="cursor:pointer; border:2px dashed #a5b4fc; border-radius:12px; background:#f8fafc; min-height:110px; transition: border-color 0.2s;">
                                        <i class="bi bi-image" style="font-size:2rem; color:#6366f1;"></i>
                                        <span class="upload-text mt-2" style="color:#6366f1; font-weight:500;">Click or Drag & Drop Logo</span>
                                        <span class="upload-hint text-muted" style="font-size:0.9em;">PNG, JPG, JPEG, max 2MB</span>
                                    </div>
                                    <div class="preview-box mt-2 text-center">
                                        {% if company.logo %}
                                            <img id="logoPreviewImg" src="{{ company.logo.url }}" alt="Company Logo" style="max-width: 120px; max-height: 80px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f9fafb; padding: 4px;">
                                        {% else %}
                                            <img id="logoPreviewImg" src="#" alt="Logo Preview" style="display:none; max-width: 120px; max-height: 80px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f9fafb; padding: 4px;">
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Cashier / Receipts Section -->
                            <div class="col-12 mt-4">
                                <hr>
                                <h6 class="mb-2">Cashier / Receipts</h6>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Cashier Name</label>
                                <input type="text" name="cashier_name" class="form-control" value="{{ company.cashier_name }}" placeholder="Enter cashier name">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Cashier Signature <span class="text-muted" style="font-size: 0.9em;">(Image upload)</span></label>
                                <div class="custom-file-upload mb-2" id="signatureDropArea">
                                    <input type="file" name="cashier_signature" accept="image/*" id="cashierSignatureInput" class="custom-file-input" style="display:none;">
                                    <div class="upload-box d-flex flex-column align-items-center justify-content-center p-3" id="signatureUploadBox" style="cursor:pointer; border:2px dashed #a5b4fc; border-radius:12px; background:#f8fafc; min-height:110px; transition: border-color 0.2s;">
                                        <i class="bi bi-pencil-square" style="font-size:2rem; color:#6366f1;"></i>
                                        <span class="upload-text mt-2" style="color:#6366f1; font-weight:500;">Click or Drag & Drop Signature</span>
                                        <span class="upload-hint text-muted" style="font-size:0.9em;">PNG, JPG, JPEG, max 2MB</span>
                                    </div>
                                    <div class="preview-box mt-2 text-center">
                                        {% if company.cashier_signature %}
                                            <img id="cashierSignaturePreviewImg" src="{{ company.cashier_signature.url }}" alt="Cashier Signature" style="max-width: 180px; max-height: 80px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f9fafb; padding: 4px;">
                                        {% else %}
                                            <img id="cashierSignaturePreviewImg" src="#" alt="Signature Preview" style="display:none; max-width: 180px; max-height: 80px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f9fafb; padding: 4px;">
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                        </div>
                        {% else %}
                            <div class="alert alert-info">No company record to edit.</div>
                        {% endif %}
                        <div class="alert d-none mt-3" id="companyEditFeedback"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-success d-flex align-items-center" id="companySaveBtn">
                            <span id="companySaveSpinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                            <i class="bi bi-check2-circle me-1"></i>
                            <span id="companySaveText">Save changes</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>



    <!-- Modal: Confirm remove additional CEO -->
    <div class="modal fade" id="removeCeoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Remove Additional CEO</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="removeCeoText">Are you sure?</p>
                    <div class="alert d-none" id="removeCeoFeedback"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmRemoveCeoBtn">Remove</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .custom-file-upload .upload-box {
            border: 2px dashed #a5b4fc;
            border-radius: 12px;
            background: #f8fafc;
            min-height: 110px;
            transition: border-color 0.2s;
        }
        .custom-file-upload .upload-box.dragover {
            border-color: #6366f1;
            background: #eef2ff;
        }
        .custom-file-upload .upload-text {
            color: #6366f1;
            font-weight: 500;
        }
        .custom-file-upload .upload-hint {
            font-size: 0.9em;
        }
        .custom-file-upload .preview-box img {
            margin-top: 4px;
        }
    </style>
    <script>
        // Modern file upload UI for logo and cashier signature
        document.addEventListener('DOMContentLoaded', function() {
            // Logo
            const logoDropArea = document.getElementById('logoDropArea');
            const logoInput = document.getElementById('logoInput');
            const logoUploadBox = document.getElementById('logoUploadBox');
            const logoPreviewImg = document.getElementById('logoPreviewImg');
            if (logoDropArea && logoInput && logoUploadBox && logoPreviewImg) {
                logoUploadBox.addEventListener('click', () => logoInput.click());
                logoDropArea.addEventListener('dragover', e => {
                    e.preventDefault();
                    logoUploadBox.classList.add('dragover');
                });
                logoDropArea.addEventListener('dragleave', e => {
                    e.preventDefault();
                    logoUploadBox.classList.remove('dragover');
                });
                logoDropArea.addEventListener('drop', e => {
                    e.preventDefault();
                    logoUploadBox.classList.remove('dragover');
                    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                        logoInput.files = e.dataTransfer.files;
                        const file = e.dataTransfer.files[0];
                        const reader = new FileReader();
                        reader.onload = function(ev) {
                            logoPreviewImg.src = ev.target.result;
                            logoPreviewImg.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
                logoInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(ev) {
                            logoPreviewImg.src = ev.target.result;
                            logoPreviewImg.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            // Cashier Signature
            const signatureDropArea = document.getElementById('signatureDropArea');
            const cashierSignatureInput = document.getElementById('cashierSignatureInput');
            const signatureUploadBox = document.getElementById('signatureUploadBox');
            const cashierSignaturePreviewImg = document.getElementById('cashierSignaturePreviewImg');
            if (signatureDropArea && cashierSignatureInput && signatureUploadBox && cashierSignaturePreviewImg) {
                signatureUploadBox.addEventListener('click', () => cashierSignatureInput.click());
                signatureDropArea.addEventListener('dragover', e => {
                    e.preventDefault();
                    signatureUploadBox.classList.add('dragover');
                });
                signatureDropArea.addEventListener('dragleave', e => {
                    e.preventDefault();
                    signatureUploadBox.classList.remove('dragover');
                });
                signatureDropArea.addEventListener('drop', e => {
                    e.preventDefault();
                    signatureUploadBox.classList.remove('dragover');
                    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                        cashierSignatureInput.files = e.dataTransfer.files;
                        const file = e.dataTransfer.files[0];
                        const reader = new FileReader();
                        reader.onload = function(ev) {
                            cashierSignaturePreviewImg.src = ev.target.result;
                            cashierSignaturePreviewImg.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
                cashierSignatureInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(ev) {
                            cashierSignaturePreviewImg.src = ev.target.result;
                            cashierSignaturePreviewImg.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });
        // Initialize progress bar widths
        document.addEventListener('DOMContentLoaded', function() {
            const progressFills = document.querySelectorAll('.progress-fill');
            progressFills.forEach(fill => {
                const width = fill.getAttribute('data-width');
                if (width) {
                    fill.style.width = width + '%';
                }
            });
        });

        (function() {
            const form = document.getElementById('companyEditForm');
            if (!form) return;

            // Dynamic CEOs: add / remove additional CEO input rows
            const additionalCeoList = document.getElementById('additionalCeoList');
            const addCeoBtn = document.getElementById('addCeoBtn');

            function createCeoRow(name = '', dob = '') {
                const row = document.createElement('div');
                row.className = 'row g-2 mb-2 ceo-item';
                row.innerHTML = `
                    <div class="col-md-5">
                        <input type="text" name="other_ceo_name[]" class="form-control" value="${name}" placeholder="Additional CEO name">
                    </div>
                    <div class="col-md-5">
                        <input type="date" name="other_ceo_dob[]" class="form-control" value="${dob}">
                    </div>
                    <div class="col-md-2 d-flex align-items-center">
                        <button type="button" class="btn btn-outline-danger btn-sm w-100 remove-ceo-btn">Remove</button>
                    </div>
                `;
                return row;
            }

            if (addCeoBtn) {
                addCeoBtn.addEventListener('click', function() {
                    const row = createCeoRow();
                    additionalCeoList.appendChild(row);
                });
            }

            // Delegate remove: open a Bootstrap modal for confirmation and perform AJAX delete when needed
            if (additionalCeoList) {
                let pendingCeoItem = null;

                additionalCeoList.addEventListener('click', function(e) {
                    const btn = e.target.closest('.remove-ceo-btn');
                    if (!btn) return;
                    const item = btn.closest('.ceo-item');
                    if (!item) return;

                    pendingCeoItem = item;
                    const ceoName = item.getAttribute('data-ceo-name') || (item.querySelector('input[name="other_ceo_name[]"]')?.value || '').trim();
                    const modal = document.getElementById('removeCeoModal');
                    modal.querySelector('#removeCeoText').textContent = ceoName
                        ? `Remove additional CEO "${ceoName}"? This will remove the entry from the form.`
                        : 'Remove this additional CEO entry? This will remove the entry from the form.';
                    const bs = new bootstrap.Modal(modal);
                    bs.show();
                });

                // Confirm button handler
                document.addEventListener('click', async function(e) {
                    const btn = e.target.closest('#confirmRemoveCeoBtn');
                    if (!btn) return;
                    const modalEl = document.getElementById('removeCeoModal');
                    const bsModal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                    const feedback = modalEl.querySelector('#removeCeoFeedback');
                    feedback.classList.add('d-none');

                    if (!pendingCeoItem) {
                        bsModal.hide();
                        return;
                    }

                    const ceoId = pendingCeoItem.getAttribute('data-ceo-id');
                    // If saved (has id), call delete endpoint; otherwise just remove from DOM
                    if (!ceoId) {
                        pendingCeoItem.remove();
                        pendingCeoItem = null;
                        bsModal.hide();
                        return;
                    }

                    // Do AJAX POST to delete endpoint
                    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || '';
                    const url = `{% url 'company-ceo-delete' ceo_id=0 %}`.replace('/0/', `/${ceoId}/`);
                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    try {
                        const res = await fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }, body: formData });
                        const data = await res.json();
                        if (data.ok) {
                            pendingCeoItem.remove();
                            pendingCeoItem = null;
                            bsModal.hide();
                        } else {
                            feedback.classList.remove('d-none');
                            feedback.classList.add('alert-danger');
                            feedback.textContent = data.error || 'Failed to remove CEO';
                        }
                    } catch (err) {
                        feedback.classList.remove('d-none');
                        feedback.classList.add('alert-danger');
                        feedback.textContent = 'Network or server error. Please try again.';
                    }
                });
            }

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const url = '{% url "company-profile-update" %}';
                const feedback = document.getElementById('companyEditFeedback');
                const saveBtn = document.getElementById('companySaveBtn');
                const spinner = document.getElementById('companySaveSpinner');
                const saveText = document.getElementById('companySaveText');

                const formData = new FormData(form);

                // Show spinner and disable button
                if (spinner) spinner.classList.remove('d-none');
                if (saveBtn) saveBtn.disabled = true;
                if (saveText) saveText.textContent = 'Saving...';

                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    });
                    const data = await res.json();
                    feedback.classList.remove('d-none', 'alert-danger', 'alert-success');
                    if (data.ok) {
                        feedback.classList.add('alert-success');
                        feedback.textContent = data.message || 'Saved';
                        // Optimistic reload to reflect latest values
                        setTimeout(() => { window.location.reload(); }, 800);
                    } else {
                        feedback.classList.add('alert-danger');
                        if (data.errors) {
                            const msgs = Object.entries(data.errors).map(([k,v]) => `${k}: ${v}`).join(' | ');
                            feedback.textContent = msgs;
                        } else {
                            feedback.textContent = data.error || 'Update failed';
                        }
                        // Hide spinner and re-enable
                        if (spinner) spinner.classList.add('d-none');
                        if (saveBtn) saveBtn.disabled = false;
                        if (saveText) saveText.textContent = 'Save changes';
                    }
                } catch (err) {
                    feedback.classList.remove('d-none');
                    feedback.classList.add('alert-danger');
                    feedback.textContent = 'Network or server error. Please try again.';
                    if (spinner) spinner.classList.add('d-none');
                    if (saveBtn) saveBtn.disabled = false;
                    if (saveText) saveText.textContent = 'Save changes';
                }
            });
        })();

            // Admin actions: mute/unmute and delete with confirmation modals
                (function() {
                    const adminTab = document.getElementById('admins');
                    if (!adminTab) return;

                // Create reusable modal elements
                const confirmModal = document.createElement('div');
                confirmModal.className = 'modal fade';
                confirmModal.id = 'confirmActionModal';
                confirmModal.tabIndex = -1;
                confirmModal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="confirmActionTitle">Confirm Action</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="d-flex align-items-start">
                                    <div class="me-3 text-warning"><i class="bi bi-exclamation-triangle" style="font-size:2rem"></i></div>
                                    <div>
                                        <p class="mb-1" id="confirmActionText"></p>
                                        <small class="text-muted" id="confirmActionCaption"></small>
                                    </div>
                                </div>
                                <div class="mt-3" id="confirmExtra"></div>
                                <div class="alert d-none mt-3" id="confirmFeedback"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="confirmActionBtn">Proceed</button>
                            </div>
                        </div>
                    </div>`;
                document.body.appendChild(confirmModal);
                const bsConfirmModal = new bootstrap.Modal(confirmModal);

                let pending = null; // {type, userId, desired}
                    adminTab.addEventListener('click', function(e) {
                    const btn = e.target.closest('button[data-action]');
                    if (!btn) return;
                    const userId = btn.getAttribute('data-user-id');
                    const action = btn.getAttribute('data-action');
                    const feedback = confirmModal.querySelector('#confirmFeedback');
                    feedback.classList.add('d-none');
                    feedback.textContent = '';

                    if (action === 'toggle-mute') {
                        const current = btn.getAttribute('data-current'); // 'active' or 'muted'
                        const desired = current === 'active' ? 'mute' : 'unmute';
                        pending = { type: 'mute', userId, desired };
                        confirmModal.querySelector('#confirmActionTitle').textContent = desired === 'mute' ? 'Mute Admin' : 'Unmute Admin';
                        confirmModal.querySelector('#confirmActionText').textContent = desired === 'mute' ? 'Are you sure you want to mute this admin account?' : 'Unmute this admin account?';
                        confirmModal.querySelector('#confirmActionCaption').textContent = desired === 'mute' ? 'Muted admins cannot log in until unmuted.' : '';
                        confirmModal.querySelector('#confirmExtra').innerHTML = '';
                        bsConfirmModal.show();
                    }
                    if (action === 'delete-admin') {
                        const name = btn.getAttribute('data-name') || 'this admin';
                        pending = { type: 'delete', userId };
                        confirmModal.querySelector('#confirmActionTitle').textContent = 'Delete Admin Account';
                        confirmModal.querySelector('#confirmActionText').innerHTML = `You are about to <strong>delete</strong> ${name}.`;
                        confirmModal.querySelector('#confirmActionCaption').textContent = 'This is a soft delete: the user will be deactivated and cannot log in.';
                        confirmModal.querySelector('#confirmExtra').innerHTML = `
                            <label class="form-label mt-2">Reason (optional)</label>
                            <textarea class="form-control" id="deleteReason" rows="2" placeholder="Add a note..."></textarea>`;
                        bsConfirmModal.show();
                    }
                });

                    function getCookie(name) {
                        const value = `; ${document.cookie}`;
                        const parts = value.split(`; ${name}=`);
                        if (parts.length === 2) return parts.pop().split(';').shift();
                    }

                    confirmModal.querySelector('#confirmActionBtn').addEventListener('click', async function() {
                        if (!pending) return;
                        const feedback = confirmModal.querySelector('#confirmFeedback');
                        try {
                            let url = '';
                            const form = new FormData();
                            const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken') || '';
                            form.append('csrfmiddlewaretoken', csrfToken);
                            if (pending.type === 'mute') {
                                url = `/company-profile/admin/${pending.userId}/toggle-mute/`;
                                form.append('desired', pending.desired);
                            } else if (pending.type === 'delete') {
                                url = `/company-profile/admin/${pending.userId}/delete/`;
                                const reason = confirmModal.querySelector('#deleteReason')?.value || '';
                                form.append('reason', reason);
                            }

                            const res = await fetch(url, {
                                method: 'POST',
                                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                                body: form
                            });
                            const data = await res.json();
                            feedback.classList.remove('d-none', 'alert-danger', 'alert-success');
                            if (data.ok) {
                                feedback.classList.add('alert-success');
                                feedback.textContent = data.message || 'Success';
                                setTimeout(() => { window.location.reload(); }, 600);
                            } else {
                                feedback.classList.add('alert-danger');
                                feedback.textContent = data.error || 'Action failed';
                            }
                        } catch (err) {
                            feedback.classList.remove('d-none');
                            feedback.classList.add('alert-danger');
                            feedback.textContent = 'Network or server error. Please try again.';
                        }
                    });
            })();

            // Edit User functionality
            (function() {
                let editUserModal, editUserForm, editUserFeedback;

                function initEditUser() {
                    editUserModal = new bootstrap.Modal(document.getElementById('editUserModal'));
                    editUserForm = document.getElementById('editUserForm');
                    editUserFeedback = document.getElementById('editUserFeedback');

                    // Handle edit button clicks
                    document.addEventListener('click', function(e) {
                        const editBtn = e.target.closest('button[data-action="edit-user"]');
                        if (!editBtn) return;

                        const userId = editBtn.getAttribute('data-user-id');
                        const userType = editBtn.getAttribute('data-user-type');
                        const userName = editBtn.getAttribute('data-user-name');
                        const userEmail = editBtn.getAttribute('data-user-email');
                        const userPhone = editBtn.getAttribute('data-user-phone');
                        const userAddress = editBtn.getAttribute('data-user-address');

                        // Populate modal
                        document.getElementById('editUserId').value = userId;
                        document.getElementById('editUserType').value = userType;
                        document.getElementById('editFullName').value = userName;
                        document.getElementById('editEmail').value = userEmail;
                        document.getElementById('editPhone').value = userPhone;
                        document.getElementById('editAddress').value = userAddress;
                        document.getElementById('editNewPassword').value = '';
                        document.getElementById('editConfirmPassword').value = '';
                        
                        // Clear master admin password field if it exists
                        const masterPasswordField = document.getElementById('masterAdminPassword');
                        if (masterPasswordField) {
                            masterPasswordField.value = '';
                        }

                        editUserFeedback.classList.add('d-none');
                        editUserModal.show();
                    });

                    // Handle form submission
                    editUserForm.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        
                        const formData = new FormData(this);
                        const userId = formData.get('user_id');
                        const userType = formData.get('user_type');
                        
                        // Validate passwords if provided
                        const newPassword = formData.get('new_password');
                        const confirmPassword = formData.get('confirm_password');
                        
                        if (newPassword || confirmPassword) {
                            if (newPassword !== confirmPassword) {
                                editUserFeedback.classList.remove('d-none', 'alert-success');
                                editUserFeedback.classList.add('alert-danger');
                                editUserFeedback.textContent = 'Passwords do not match.';
                                return;
                            }
                            if (newPassword.length < 8) {
                                editUserFeedback.classList.remove('d-none', 'alert-success');
                                editUserFeedback.classList.add('alert-danger');
                                editUserFeedback.textContent = 'Password must be at least 8 characters long.';
                                return;
                            }
                        }

                        // Validate master admin password if field exists
                        const masterPasswordField = document.getElementById('masterAdminPassword');
                        if (masterPasswordField && !masterPasswordField.value.trim()) {
                            editUserFeedback.classList.remove('d-none', 'alert-success');
                            editUserFeedback.classList.add('alert-danger');
                            editUserFeedback.textContent = 'Master admin password is required to make changes.';
                            return;
                        }

                        try {
                            const url = userType === 'admin' 
                                ? `/company-profile/admin/${userId}/edit/` 
                                : `/company-profile/support/${userId}/edit/`;
                            const response = await fetch(url, {
                                method: 'POST',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                                },
                                body: formData
                            });

                            const data = await response.json();
                            
                            if (data.ok) {
                                editUserFeedback.classList.remove('d-none', 'alert-danger');
                                editUserFeedback.classList.add('alert-success');
                                editUserFeedback.textContent = data.message || 'User updated successfully.';
                                
                                setTimeout(() => {
                                    editUserModal.hide();
                                    window.location.reload();
                                }, 1000);
                            } else {
                                editUserFeedback.classList.remove('d-none', 'alert-success');
                                editUserFeedback.classList.add('alert-danger');
                                editUserFeedback.textContent = data.error || 'Failed to update user.';
                            }
                        } catch (error) {
                            editUserFeedback.classList.remove('d-none', 'alert-success');
                            editUserFeedback.classList.add('alert-danger');
                            editUserFeedback.textContent = 'Network error. Please try again.';
                        }
                    });
                }

                // Initialize when DOM is ready
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initEditUser);
                } else {
                    initEditUser();
                }
            })();
    </script>

    <style>
        /* CEO tag: visually distinct from badges */
        .ceo-tag {
            display: inline-block;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 700;
            box-shadow: 0 6px 18px rgba(16,185,129,0.18);
            font-size: 0.95rem;
        }

        .ceo-tag .ceo-role {
            background: rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.95);
            padding: 2px 8px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.7rem;
            vertical-align: middle;
        }

        .ceo-tag .bi-award-fill {
            font-size: 0.9rem;
            vertical-align: -2px;
        }

        .master-badge {
            background: #fbbf24;
            color: #1f2937;
            border-radius: 8px;
            padding: 4px 8px;
            font-weight: 700;
            font-size: 0.75rem;
        }
        /* Primary CEO variant (keeps green look) */
        .ceo-tag.primary-ceo {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            box-shadow: 0 6px 18px rgba(16,185,129,0.18);
        }

        /* Other CEO variant: pill with softer purple/blue gradient */
        .ceo-tag.other-ceo {
            background: linear-gradient(135deg, #6366f1 0%, #7c3aed 100%);
            color: #fff;
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 600;
            box-shadow: 0 6px 14px rgba(99,102,241,0.12);
            font-size: 0.9rem;
        }

        .ceo-tag.other-ceo .bi-person-fill {
            font-size: 0.9rem;
            vertical-align: -2px;
        }

        /* Slight spacing for CEO name inside pill */
        .ceo-tag .ceo-name { vertical-align: middle; }
    </style>

    <!-- Subscription & Billing JavaScript -->
    <script>
        async function loadPlans(targetContainer, isUpgrade = false) {
            try {
                const response = await fetch('/api/subscription/plans/');
                const data = await response.json();
                let html = '';
                
                const currentPlan = '{{ subscription.subscription_plan.name|default:"" }}';
                
                data.plans.forEach(plan => {
                    // Skip current plan in upgrade view
                    if (isUpgrade && plan.name === currentPlan) return;
                    
                    const isCurrentPlan = plan.name === currentPlan;
                    const badgeClass = isCurrentPlan ? 'bg-primary' : 'bg-outline-primary';
                    
                    html += `
                        <div class="col-md-6">
                            <div class="card h-100 border-2 plan-card" data-plan-id="${plan.id}" data-plan-name="${plan.name}" data-plan-price="${plan.price}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <h5 class="card-title">${plan.name}</h5>
                                        ${isCurrentPlan ? '<span class="badge bg-primary">Current</span>' : ''}
                                    </div>
                                    <div class="h4 text-primary mb-3">₦${plan.price.toLocaleString('en-NG')}/mo</div>
                                    <ul class="list-unstyled mb-3">
                                        <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i><strong>Properties:</strong> ${plan.properties_limit}</li>
                                        <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i><strong>Users:</strong> ${plan.users_limit}</li>
                                        <li class="mb-2"><i class="bi bi-check-circle text-success me-2"></i><strong>Marketers:</strong> ${plan.marketers_limit}</li>
                                        <li class="mb-2">
                                            <i class="bi ${plan.has_analytics ? 'bi-check-circle text-success' : 'bi-x-circle text-secondary'} me-2"></i>
                                            <strong>Analytics:</strong> ${plan.has_analytics ? 'Yes' : 'No'}
                                        </li>
                                    </ul>
                                    <button type="button" class="btn btn-${isCurrentPlan ? 'outline-secondary' : 'primary'} w-100 select-plan-btn" 
                                            data-plan-name="${plan.name}" data-plan-price="${plan.price}" 
                                            ${isCurrentPlan ? 'disabled' : ''}>
                                        ${isCurrentPlan ? 'Current Plan' : 'Select Plan'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                document.getElementById(targetContainer).innerHTML = html;
                
                // Attach event listeners to plan selection buttons
                document.querySelectorAll('.select-plan-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const planName = this.getAttribute('data-plan-name');
                        const planPrice = this.getAttribute('data-plan-price');
                        selectPlan(planName, planPrice);
                    });
                });
            } catch (error) {
                console.error('Error loading plans:', error);
                document.getElementById(targetContainer).innerHTML = '<div class="alert alert-danger">Failed to load plans.</div>';
            }
        }

        // Handle plan selection
        function selectPlan(planName, planPrice) {
            const currentPlan = '{{ subscription.subscription_plan.name|default:"" }}';
            
            if (currentPlan && currentPlan !== planName) {
                // Upgrade flow
                showUpgradeConfirmation(planName, planPrice);
            } else if (!currentPlan) {
                // New subscription flow
                showPaymentModal(planName, planPrice);
            }
        }

        // Show upgrade confirmation
        function showUpgradeConfirmation(newPlan, newPrice) {
            const currentPrice = '{{ subscription.amount|default:0 }}';
            const priceDifference = newPrice - currentPrice;
            
            const confirmContent = `
                <div class="card">
                    <div class="card-body">
                        <p><strong>Current Plan:</strong> {{ subscription.subscription_plan.name|default:"-" }} (₦${currentPrice}/mo)</p>
                        <p><strong>New Plan:</strong> ${newPlan} (₦${newPrice}/mo)</p>
                        <div class="alert alert-info">
                            <strong>Price Change:</strong> ${priceDifference > 0 ? '+' : ''}₦${Math.abs(priceDifference).toLocaleString('en-NG')}/mo
                        </div>
                    </div>
                </div>
            `;
            
            // Show in payment modal
            document.getElementById('paymentPlan').textContent = `${newPlan} (Upgrade)`;
            document.getElementById('paymentAmount').textContent = `₦${newPrice.toLocaleString('en-NG')}`;
            document.getElementById('paymentTotal').textContent = `₦${newPrice.toLocaleString('en-NG')}`;
            
            const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
            paymentModal.show();
        }

        // Show payment modal
        function showPaymentModal(planName, planPrice) {
            document.getElementById('paymentPlan').textContent = planName;
            document.getElementById('paymentAmount').textContent = `₦${planPrice.toLocaleString('en-NG')}`;
            document.getElementById('paymentTotal').textContent = `₦${planPrice.toLocaleString('en-NG')}`;
            
            const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
            paymentModal.show();
        }

        // Load plans when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadPlans('plansContainer', false);
            loadPlans('upgradePlansContainer', true);
            
            // Load current subscription data
            loadCurrentSubscription();
        });

        // Load current subscription data
        async function loadCurrentSubscription() {
            try {
                const response = await fetch('/api/subscription/status/');
                const data = await response.json();
                
                if (data.subscription) {
                    document.getElementById('currentPlanName').textContent = data.subscription.plan_name;
                    document.getElementById('renewPlanName').textContent = data.subscription.plan_name;
                    document.getElementById('renewAmount').textContent = data.subscription.amount.toLocaleString('en-NG');
                }
            } catch (error) {
                console.error('Error loading subscription:', error);
            }
        }

        // Handle renewal form submission
        document.getElementById('renewSubscriptionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const paymentMethod = this.querySelector('select[name="payment_method"]').value;
            const feedback = document.getElementById('renewFeedback');
            feedback.classList.add('d-none');
            
            if (!paymentMethod) {
                feedback.classList.remove('d-none', 'alert-success');
                feedback.classList.add('alert-warning');
                feedback.textContent = 'Please select a payment method.';
                return;
            }
            
            try {
                const response = await fetch('/api/subscription/renew/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ payment_method: paymentMethod })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    feedback.classList.remove('d-none', 'alert-danger');
                    feedback.classList.add('alert-success');
                    feedback.textContent = 'Proceeding to payment...';
                    
                    // Close modal and show payment modal
                    bootstrap.Modal.getInstance(document.getElementById('renewSubscriptionModal')).hide();
                    
                    // Show payment modal with Stripe/Paystack form
                    document.getElementById('paymentPlan').textContent = '{{ subscription.subscription_plan.name|default:"-" }}';
                    document.getElementById('paymentAmount').textContent = '₦{{ subscription.amount|default:0|intcomma }}';
                    document.getElementById('paymentTotal').textContent = '₦{{ subscription.amount|default:0|intcomma }}';
                    
                    // Show appropriate payment container
                    document.getElementById('stripePaymentContainer').style.display = paymentMethod === 'stripe' ? 'block' : 'none';
                    document.getElementById('paystackPaymentContainer').style.display = paymentMethod === 'paystack' ? 'block' : 'none';
                    
                    const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
                    paymentModal.show();
                } else {
                    feedback.classList.remove('d-none', 'alert-success');
                    feedback.classList.add('alert-danger');
                    feedback.textContent = data.error || 'Failed to initiate renewal.';
                }
            } catch (error) {
                feedback.classList.remove('d-none', 'alert-success');
                feedback.classList.add('alert-danger');
                feedback.textContent = 'Network error. Please try again.';
            }
        });

        // Handle payment form submission
        document.getElementById('paymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const paymentMethod = document.querySelector('.payment-method-active')?.value || 'stripe';
            const feedback = document.getElementById('paymentFeedback');
            feedback.classList.add('d-none');
            
            try {
                const response = await fetch('/api/subscription/payment/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        payment_method: paymentMethod,
                        plan_name: document.getElementById('paymentPlan').textContent
                    })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    feedback.classList.remove('d-none', 'alert-danger');
                    feedback.classList.add('alert-success');
                    feedback.textContent = 'Payment successful! Redirecting...';
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    feedback.classList.remove('d-none', 'alert-success');
                    feedback.classList.add('alert-danger');
                    feedback.textContent = data.error || 'Payment failed.';
                }
            } catch (error) {
                feedback.classList.remove('d-none', 'alert-success');
                feedback.classList.add('alert-danger');
                feedback.textContent = 'Network error. Please try again.';
            }
        });

        // Show billing history
        function showBillingHistory() {
            document.querySelector('a[data-bs-target="#billing"]').click();
        }

        // Password verification modal with session timeout
        document.addEventListener('DOMContentLoaded', function() {
            const passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'), {
                backdrop: 'static',
                keyboard: false
            });

            // Session timeout configuration
            const SESSION_TIMEOUT = 5 * 60 * 1000; // 5 minutes in milliseconds
            const WARNING_TIME = 1 * 60 * 1000; // Show warning 1 minute before timeout
            let sessionTimer;
            let warningTimer;
            let isModalShown = false;

            // Function to show password modal
            function showPasswordModal() {
                if (!isModalShown) {
                    document.getElementById('protectedContent').style.display = 'none';
                    passwordModal.show();
                    isModalShown = true;
                }
            }

            // Function to show session warning
            function showSessionWarning() {
                document.getElementById('sessionWarning').style.display = 'block';
            }

            // Function to hide session warning
            function hideSessionWarning() {
                document.getElementById('sessionWarning').style.display = 'none';
            }

            // Function to extend session (global function for onclick)
            window.extendSession = function() {
                hideSessionWarning();
                resetSessionTimer();
            };

            // Function to reset session timer
            function resetSessionTimer() {
                clearTimeout(sessionTimer);
                clearTimeout(warningTimer);
                hideSessionWarning();
                
                // Set warning timer (4 minutes from now)
                warningTimer = setTimeout(showSessionWarning, SESSION_TIMEOUT - WARNING_TIME);
                // Set session timeout (5 minutes from now)
                sessionTimer = setTimeout(showPasswordModal, SESSION_TIMEOUT);
            }

            // Function to handle user activity
            function handleUserActivity() {
                // If modal is already shown, don't reset timer
                if (isModalShown) return;

                hideSessionWarning();
                resetSessionTimer();
            }

            // Start session timer on page load
            resetSessionTimer();

            // Listen for user activity events
            const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            activityEvents.forEach(event => {
                document.addEventListener(event, handleUserActivity, true);
            });

            // Password visibility toggle
            const togglePassword = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('masterPassword');
            const passwordIcon = document.getElementById('passwordIcon');

            togglePassword.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);

                // Toggle icon
                if (type === 'password') {
                    passwordIcon.className = 'bi bi-eye';
                } else {
                    passwordIcon.className = 'bi bi-eye-slash';
                }
            });

            document.getElementById('verifyBtn').addEventListener('click', async function() {
                const password = document.getElementById('masterPassword').value;
                const errorDiv = document.getElementById('passwordError');
                const errorText = document.getElementById('errorText');

                errorDiv.classList.add('d-none');
                errorText.textContent = '';

                if (!password) {
                    errorText.textContent = 'Please enter the password.';
                    errorDiv.classList.remove('d-none');
                    return;
                }

                // Show loading state
                this.disabled = true;
                this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Verifying...';

                try {
                    const response = await fetch('{% url "verify-master-password" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: new URLSearchParams({ password: password })
                    });

                    const data = await response.json();

                    if (data.ok) {
                        // Success animation
                        this.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Access Granted!';
                        this.style.background = 'linear-gradient(135deg, #16a34a 0%, #22c55e 100%)';

                        setTimeout(() => {
                            passwordModal.hide();
                            document.getElementById('protectedContent').style.display = 'block';
                            isModalShown = false; // Reset modal state
                            hideSessionWarning(); // Hide any warning
                            resetSessionTimer(); // Restart session timer
                        }, 1000);
                    } else {
                        // Reset button
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Verify Access';

                        errorText.textContent = data.error || 'Invalid password.';
                        errorDiv.classList.remove('d-none');

                        // Shake animation for error
                        passwordInput.style.animation = 'shake 0.5s ease-in-out';
                        setTimeout(() => {
                            passwordInput.style.animation = '';
                        }, 500);
                    }
                } catch (error) {
                    // Reset button
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Verify Access';

                    errorText.textContent = 'Network error. Please try again.';
                    errorDiv.classList.remove('d-none');
                }
            });

            // Cleanup timers when page unloads
            window.addEventListener('beforeunload', function() {
                clearTimeout(sessionTimer);
                clearTimeout(warningTimer);
            });

        // Add shake animation CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(style);
    </script>

    </div> <!-- End of protectedContent -->

    <!-- Session Timeout Warning -->
    <div class="alert alert-warning alert-dismissible fade show position-fixed" id="sessionWarning" style="display: none; top: 20px; right: 20px; z-index: 1050; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <div class="d-flex align-items-center">
            <i class="bi bi-clock-history me-2" style="font-size: 1.2rem;"></i>
            <div>
                <strong>Session Expiring Soon</strong>
                <div class="small">Your session will expire in 1 minute due to inactivity.</div>
            </div>
        </div>
        <button type="button" class="btn-close" onclick="extendSession()" aria-label="Extend session"></button>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editUserForm">
                    <div class="modal-body">
                        {% csrf_token %}
                        <input type="hidden" id="editUserId" name="user_id">
                        <input type="hidden" id="editUserType" name="user_type">
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="editFullName" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="editFullName" name="full_name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editEmail" name="email" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editPhone" class="form-label">Phone</label>
                                <input type="text" class="form-control" id="editPhone" name="phone">
                            </div>
                            <div class="col-md-6">
                                <label for="editAddress" class="form-label">Address</label>
                                <input type="text" class="form-control" id="editAddress" name="address">
                            </div>
                            <div class="col-12">
                                <hr>
                                <h6>Change Password (Optional)</h6>
                                <small class="text-muted">Leave blank to keep current password</small>
                            </div>
                            <div class="col-md-6">
                                <label for="editNewPassword" class="form-label">New Password</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="editNewPassword" name="new_password">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                                        <i class="bi bi-eye" id="newPasswordIcon"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="editConfirmPassword" class="form-label">Confirm New Password</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="editConfirmPassword" name="confirm_password">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                        <i class="bi bi-eye" id="confirmPasswordIcon"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Master Admin Password Verification (only for master admin) -->
                        {% if master_admin_id and request.user.id == master_admin_id %}
                        <div class="col-12">
                            <hr>
                            <h6 class="text-danger mb-2"><i class="bi bi-shield-lock-fill me-2"></i>Master Admin Verification Required</h6>
                            <small class="text-muted">As the master admin, you must confirm your identity to make changes.</small>
                        </div>
                        <div class="col-12">
                            <label for="masterAdminPassword" class="form-label">Your Master Admin Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="masterAdminPassword" name="master_admin_password" required>
                                <button class="btn btn-outline-secondary" type="button" id="toggleMasterPassword">
                                    <i class="bi bi-eye" id="masterPasswordIcon"></i>
                                </button>
                            </div>
                            <small class="text-muted">Enter your current password to authorize this change.</small>
                        </div>
                        {% endif %}

                        <div class="alert d-none mt-3" id="editUserFeedback"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle for new password field
        const toggleNewPassword = document.getElementById('toggleNewPassword');
        const editNewPassword = document.getElementById('editNewPassword');
        const newPasswordIcon = document.getElementById('newPasswordIcon');
        
        if (toggleNewPassword && editNewPassword && newPasswordIcon) {
            toggleNewPassword.addEventListener('click', function() {
                const type = editNewPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                editNewPassword.setAttribute('type', type);
                newPasswordIcon.className = type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';
            });
        }
        
        // Toggle for confirm password field
        const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
        const editConfirmPassword = document.getElementById('editConfirmPassword');
        const confirmPasswordIcon = document.getElementById('confirmPasswordIcon');
        
        if (toggleConfirmPassword && editConfirmPassword && confirmPasswordIcon) {
            toggleConfirmPassword.addEventListener('click', function() {
                const type = editConfirmPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                editConfirmPassword.setAttribute('type', type);
                confirmPasswordIcon.className = type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';
            });
        }
        
        // Toggle for master admin password field
        const toggleMasterPassword = document.getElementById('toggleMasterPassword');
        const masterAdminPassword = document.getElementById('masterAdminPassword');
        const masterPasswordIcon = document.getElementById('masterPasswordIcon');
        
        if (toggleMasterPassword && masterAdminPassword && masterPasswordIcon) {
            toggleMasterPassword.addEventListener('click', function() {
                const type = masterAdminPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                masterAdminPassword.setAttribute('type', type);
                masterPasswordIcon.className = type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';
            });
        }
    });
</script>

{% endblock %}

