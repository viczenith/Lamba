{% extends 'admin_base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<main id="main" class="main">
    <div class="pagetitle">
        <h1>Company Console</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'tenant-dashboard' company_slug=request.user.company_profile.slug %}">Home</a></li>
                <li class="breadcrumb-item active">Console</li>
            </ol>
        </nav>
    </div>

    <style>
        /* Analytics Dashboard Gradients */
        .bg-gradient-primary {
            background: linear-gradient(135deg, #0d6efd 0%, #0857ca 100%) !important;
        }

        .bg-gradient-success {
            background: linear-gradient(135deg, #198754 0%, #157347 100%) !important;
        }

        .bg-gradient-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%) !important;
            color: #000 !important;
        }

        .bg-gradient-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c71c22 100%) !important;
        }

        /* Analytics Cards Hover Effect */
        .bg-gradient-primary, .bg-gradient-success, .bg-gradient-warning, .bg-gradient-danger {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .bg-gradient-primary:hover, .bg-gradient-success:hover, .bg-gradient-warning:hover, .bg-gradient-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
        }
    </style>

    <div class="container py-3" id="protectedContent">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="d-flex align-items-center">
                <div class="me-3" style="width:64px;height:64px;border-radius:12px;overflow:hidden;background:#f3f4f6;display:flex;align-items:center;justify-content:center">
                    {% if company and company.logo %}
                        <img src="{{ company.logo.url }}" alt="{{ company.company_name }} Logo" style="width:100%;height:100%;object-fit:cover">
                    {% else %}
                        <i class="bi bi-buildings" style="font-size:28px;color:#6b7280"></i>
                    {% endif %}
                </div>
                <div>
                    <h2 class="mb-0">{{ company.company_name|default:'Company Console' }}</h2>
                    <small class="text-muted">Manage company details, users and analytics</small>
                </div>
            </div>
            <div>
                <button class="btn btn-primary" style="background: linear-gradient(135deg, #00d084 0%, #00b894 100%);" data-bs-toggle="modal" data-bs-target="#editCompanyModal">
                    <i class="bi bi-pencil-square me-1"></i> Update Company Details
                </button>
            </div>
        </div>

        <ul class="nav nav-tabs" id="companyTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="billing-tab" data-bs-toggle="tab" data-bs-target="#billing" type="button" role="tab">
                    <i class="bi bi-credit-card me-1"></i>Subscription & Billing
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="user-registration-tab" data-bs-toggle="tab" data-bs-target="#user-registration" type="button" role="tab">
                    <i class="bi bi-person-plus me-1"></i>Register Admins
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="admins-tab" data-bs-toggle="tab" data-bs-target="#admins" type="button" role="tab">Admins</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">Users</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="support-tab" data-bs-toggle="tab" data-bs-target="#support" type="button" role="tab">AdminSupport</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
                    <i class="bi bi-graph-up-arrow me-1"></i>Analytics
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="historical-tab" data-bs-toggle="tab" data-bs-target="#historical" type="button" role="tab">
                    <i class="bi bi-archive me-1"></i>Historical Records
                </button>
            </li>
        </ul>

        <div class="tab-content pt-3">
            <!-- Overview -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                <div class="row g-3">
                    <div class="col-lg-8">
                        <div class="card h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <strong>Company Details</strong>
                            </div>
                            <div class="card-body">
                                {% if company %}
                                    <div class="row mb-3">
                                        <div class="col-sm-6">
                                            <div class="text-muted small">Company Name</div>
                                            <div class="fw-semibold">{{ company.company_name }}</div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="text-muted small">Registration Number</div>
                                            <div class="fw-semibold">{{ company.registration_number }}</div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-sm-6">
                                            <div class="text-muted small">Registration Date</div>
                                            <div class="fw-semibold">{{ company.registration_date|date:'M d, Y' }}</div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="text-muted small">Email</div>
                                            <div class="fw-semibold">{{ company.email }}</div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-sm-6">
                                            <div class="text-muted small">Phone</div>
                                            <div class="fw-semibold">{{ company.phone }}</div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="text-muted small">Location / Address</div>
                                            <div class="fw-semibold">{{ company.location }}</div>
                                        </div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-12">
                                            <div class="text-muted small">Chief Executive Officers</div>
                                            <div class="mt-2">
                                                {% if company and company.ceos.all %}
                                                    {% for ceo in company.ceos.all %}
                                                            {% if ceo.is_primary %}
                                                                    <div class="d-inline-block me-2 mb-1">
                                                                        <span class="ceo-tag primary-ceo" title="Master CEO">
                                                                            <i class="bi bi-award-fill me-1" aria-hidden="true"></i>
                                                                            <span class="ceo-name">{{ ceo.name }}</span>
                                                                            <span class="ceo-role ms-2">Master CEO</span><br>
                                                                        </span>
                                                                    </div>
                                                            {% else %}
                                                                <div class="d-inline-block me-2 mb-1">
                                                                    <span class="ceo-tag other-ceo" title="Additional CEO">
                                                                        <i class="bi bi-person-fill me-1" aria-hidden="true"></i>
                                                                        <span class="ceo-name">{{ ceo.name }}</span>
                                                                    </span>
                                                                </div>
                                                            {% endif %}
                                                    {% endfor %}
                                                {% else %}
                                                    <div class="fw-semibold">{{ company.ceo_name }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Cashier / Receipts Section in Overview -->
                                    <div class="row mb-2">
                                        <div class="col-12">
                                            <div class="text-muted small">Cashier / Receipts</div>
                                            <div class="d-flex align-items-center gap-3 mt-2">
                                                <div>
                                                    <div class="fw-semibold">Name:</div>
                                                    <div>{{ company.cashier_name|default:'—' }}</div>
                                                </div>
                                                <div>
                                                    <div class="fw-semibold">Signature:</div>
                                                    {% if company.cashier_signature %}
                                                        <img src="{{ company.cashier_signature.url }}" alt="Cashier Signature" style="max-width: 120px; max-height: 60px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f9fafb; padding: 3px;">
                                                    {% else %}
                                                        <span class="text-muted">—</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="alert alert-info">No company linked yet. Use Edit to register details.</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card mb-3">
                            <div class="card-header bg-white"><strong>Key Stats</strong></div>
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="border rounded p-3 d-flex align-items-center gap-3">
                                            <div class="text-primary"><i class="bi bi-people" style="font-size:1.4rem"></i></div>
                                            <div>
                                                <div class="text-muted small">Clients</div>
                                                <div class="fs-5 fw-bold">{{ total_clients|default:0|intcomma }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="border rounded p-3 d-flex align-items-center gap-3">
                                            <div class="text-success"><i class="bi bi-person-badge" style="font-size:1.4rem"></i></div>
                                            <div>
                                                <div class="text-muted small">Marketers</div>
                                                <div class="fs-5 fw-bold">{{ total_marketers|default:0|intcomma }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="border rounded p-3 d-flex align-items-center gap-3">
                                            <div class="text-warning"><i class="bi bi-building" style="font-size:1.4rem"></i></div>
                                            <div>
                                                <div class="text-muted small">Estates</div>
                                                <div class="fs-5 fw-bold">{{ total_estates|default:0|intcomma }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="border rounded p-3 d-flex align-items-center gap-3" title="Full payment transactions completed">
                                            <div class="text-danger"><i class="bi bi-check2-square" style="font-size:1.4rem"></i></div>
                                            <div>
                                                <div class="text-muted small">Full Payments</div>
                                                <div class="fs-5 fw-bold">{{ total_full_allocations|default:0|intcomma }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="border rounded p-3 d-flex align-items-center gap-3" title="Part payment transactions (installments)">
                                            <div class="text-info"><i class="bi bi-file-earmark-text" style="font-size:1.4rem"></i></div>
                                            <div>
                                                <div class="text-muted small">Part Payments</div>
                                                <div class="fs-5 fw-bold">{{ total_part_allocations|default:0|intcomma }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header bg-white"><strong>Activity</strong></div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div><span class="badge bg-success">Active Users</span></div>
                                    <div class="fw-bold">{{ active_users_count|intcomma }}</div>
                                </div>
                                <div class="d-flex justify-content-between mt-2">
                                    <div><span class="badge bg-secondary">Inactive Users</span></div>
                                    <div class="fw-bold">{{ inactive_users_count|intcomma }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users -->
            <div class="tab-pane fade" id="users" role="tabpanel" aria-labelledby="users-tab">
                <!-- ADVANCED USER MANAGEMENT DASHBOARD -->
                <style>
                    .users-tab-gradient-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
                    .users-tab-gradient-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
                    .users-tab-gradient-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
                    .users-tab-gradient-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
                    .users-tab-gradient-dark { background: linear-gradient(135deg, #434343 0%, #000000 100%); }
                    .users-tab-stat-card {
                        border-radius: 16px;
                        overflow: hidden;
                        transition: transform 0.3s ease, box-shadow 0.3s ease;
                    }
                    .users-tab-stat-card:hover {
                        transform: translateY(-5px);
                        box-shadow: 0 12px 40px rgba(0,0,0,0.15) !important;
                    }
                    .users-tab-icon-circle {
                        width: 56px;
                        height: 56px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 1.5rem;
                    }
                    .users-tab-progress-ring {
                        width: 120px;
                        height: 120px;
                    }
                    .users-tab-team-card {
                        border-radius: 12px;
                        border: none;
                        transition: all 0.3s ease;
                    }
                    .users-tab-team-card:hover {
                        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
                    }
                    .users-tab-role-badge {
                        padding: 6px 14px;
                        border-radius: 20px;
                        font-weight: 500;
                        font-size: 0.75rem;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    .users-tab-search-input {
                        border-radius: 25px;
                        padding-left: 45px;
                        border: 2px solid #e9ecef;
                        transition: border-color 0.3s ease;
                    }
                    .users-tab-search-input:focus {
                        border-color: #667eea;
                        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                    }
                    .users-tab-filter-btn {
                        border-radius: 20px;
                        padding: 8px 20px;
                        font-size: 0.85rem;
                        border: 2px solid #e9ecef;
                        background: white;
                        transition: all 0.3s ease;
                    }
                    .users-tab-filter-btn:hover, .users-tab-filter-btn.active {
                        border-color: #667eea;
                        background: #667eea;
                        color: white;
                    }
                    .users-tab-table-modern {
                        border-radius: 12px;
                        overflow: hidden;
                    }
                    .users-tab-table-modern thead th {
                        background: #f8f9fa;
                        border: none;
                        padding: 16px;
                        font-weight: 600;
                        color: #495057;
                        text-transform: uppercase;
                        font-size: 0.75rem;
                        letter-spacing: 0.5px;
                    }
                    .users-tab-table-modern tbody td {
                        padding: 16px;
                        vertical-align: middle;
                        border-bottom: 1px solid #f1f3f4;
                    }
                    .users-tab-table-modern tbody tr:hover {
                        background: #f8f9ff;
                    }
                    .users-tab-user-avatar {
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: 600;
                        font-size: 0.9rem;
                    }
                    .users-tab-pulse-dot {
                        width: 10px;
                        height: 10px;
                        border-radius: 50%;
                        display: inline-block;
                        margin-right: 6px;
                    }
                    .users-tab-pulse-dot.active { background: #10b981; animation: pulse 2s infinite; }
                    .users-tab-pulse-dot.idle { background: #f59e0b; }
                    .users-tab-pulse-dot.inactive { background: #ef4444; }
                    @keyframes pulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.5; }
                    }
                </style>

                <!-- Section Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="mb-1 fw-bold" style="color: #1a1a2e;">
                            <i class="bi bi-people-fill me-2" style="color: #667eea;"></i>Team Management
                        </h4>
                        <p class="text-muted mb-0">Comprehensive overview of your real estate team</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm rounded-pill px-3" onclick="window.location.reload();">
                            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Team Composition Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-lg-3">
                        <div class="card users-tab-stat-card border-0 shadow-sm h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="users-tab-icon-circle" style="background: rgba(16, 185, 129, 0.1);">
                                        <i class="bi bi-people" style="color: #10b981;"></i>
                                    </div>
                                    <div>
                                        <div class="text-muted small">Clients</div>
                                        <h3 class="mb-0 fw-bold">{{ total_clients|default:0|intcomma }}</h3>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <div class="progress" style="height: 4px; border-radius: 2px;">
                                        <div class="progress-bar" style="width: {% widthratio total_clients registered_users_total_count 100 %}%; background: #10b981;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="card users-tab-stat-card border-0 shadow-sm h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="users-tab-icon-circle" style="background: rgba(99, 102, 241, 0.1);">
                                        <i class="bi bi-person-badge" style="color: #6366f1;"></i>
                                    </div>
                                    <div>
                                        <div class="text-muted small">Marketers</div>
                                        <h3 class="mb-0 fw-bold">{{ total_marketers|default:0|intcomma }}</h3>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <div class="progress" style="height: 4px; border-radius: 2px;">
                                        <div class="progress-bar" style="width: {% widthratio total_marketers registered_users_total_count 100 %}%; background: #6366f1;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="card users-tab-stat-card border-0 shadow-sm h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="users-tab-icon-circle" style="background: rgba(249, 115, 22, 0.1);">
                                        <i class="bi bi-shield-check" style="color: #f97316;"></i>
                                    </div>
                                    <div>
                                        <div class="text-muted small">Admins</div>
                                        <h3 class="mb-0 fw-bold">{{ admin_users|length|intcomma }}</h3>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <div class="progress" style="height: 4px; border-radius: 2px;">
                                        <div class="progress-bar" style="width: {% widthratio admin_users|length registered_users_total_count 100 %}%; background: #f97316;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="card users-tab-stat-card border-0 shadow-sm h-100">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="users-tab-icon-circle" style="background: rgba(236, 72, 153, 0.1);">
                                        <i class="bi bi-headset" style="color: #ec4899;"></i>
                                    </div>
                                    <div>
                                        <div class="text-muted small">Support</div>
                                        <h3 class="mb-0 fw-bold">{{ support_users|length|intcomma }}</h3>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <div class="progress" style="height: 4px; border-radius: 2px;">
                                        <div class="progress-bar" style="width: {% widthratio support_users|length registered_users_total_count 100 %}%; background: #ec4899;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Engagement Metrics Row -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6 col-lg-3">
                        <div class="card users-tab-stat-card border-0 shadow users-tab-gradient-primary text-white">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <p class="mb-1 opacity-75" style="font-size: 0.85rem;">Active Users</p>
                                        <h2 class="mb-0 fw-bold">{{ active_users_30d|intcomma }}</h2>
                                        <small class="opacity-75">Last 30 days</small>
                                    </div>
                                    <div class="users-tab-icon-circle" style="background: rgba(255,255,255,0.2);">
                                        <i class="bi bi-activity text-white"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="card users-tab-stat-card border-0 shadow users-tab-gradient-success text-white">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <p class="mb-1 opacity-75" style="font-size: 0.85rem;">Recently Active</p>
                                        <h2 class="mb-0 fw-bold">{{ recently_active_7d|intcomma }}</h2>
                                        <small class="opacity-75">Last 7 days</small>
                                    </div>
                                    <div class="users-tab-icon-circle" style="background: rgba(255,255,255,0.2);">
                                        <i class="bi bi-lightning-charge text-white"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="card users-tab-stat-card border-0 shadow users-tab-gradient-warning text-white">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <p class="mb-1 opacity-75" style="font-size: 0.85rem;">Needs Attention</p>
                                        <h2 class="mb-0 fw-bold">{{ at_risk_users|intcomma }}</h2>
                                        <small class="opacity-75">At-risk users</small>
                                    </div>
                                    <div class="users-tab-icon-circle" style="background: rgba(255,255,255,0.2);">
                                        <i class="bi bi-exclamation-diamond text-white"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="card users-tab-stat-card border-0 shadow users-tab-gradient-info text-white">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <p class="mb-1 opacity-75" style="font-size: 0.85rem;">Engagement</p>
                                        <h2 class="mb-0 fw-bold">{{ engagement_score }}%</h2>
                                        <small class="opacity-75">Overall score</small>
                                    </div>
                                    <div class="users-tab-icon-circle" style="background: rgba(255,255,255,0.2);">
                                        <i class="bi bi-speedometer2 text-white"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row g-4 mb-4">
                    <!-- User Status Distribution -->
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-sm h-100" style="border-radius: 16px;">
                            <div class="card-header bg-white border-0 pt-4 pb-2 px-4">
                                <h6 class="fw-bold mb-0">
                                    <i class="bi bi-pie-chart me-2 text-primary"></i>User Status
                                </h6>
                            </div>
                            <div class="card-body p-4 pt-2">
                                <div style="height: 220px; position: relative;">
                                    <canvas id="statusChart"></canvas>
                                </div>
                                <div class="d-flex flex-wrap justify-content-center gap-3 mt-3">
                                    <small><span class="users-tab-pulse-dot active"></span>Active</small>
                                    <small><span class="users-tab-pulse-dot idle"></span>Idle</small>
                                    <small><span class="users-tab-pulse-dot inactive"></span>At-Risk</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Weekly Activity Pattern -->
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-sm h-100" style="border-radius: 16px;">
                            <div class="card-header bg-white border-0 pt-4 pb-2 px-4">
                                <h6 class="fw-bold mb-0">
                                    <i class="bi bi-bar-chart me-2 text-success"></i>Weekly Activity
                                </h6>
                            </div>
                            <div class="card-body p-4 pt-2">
                                <div style="height: 220px; position: relative;">
                                    <canvas id="frequencyChart"></canvas>
                                </div>
                                <p class="text-muted text-center small mt-3 mb-0">Login activity by day of week</p>
                            </div>
                        </div>
                    </div>

                    <!-- Team Ratio -->
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-sm h-100" style="border-radius: 16px;">
                            <div class="card-header bg-white border-0 pt-4 pb-2 px-4">
                                <h6 class="fw-bold mb-0">
                                    <i class="bi bi-diagram-3 me-2 text-info"></i>Team Ratio
                                </h6>
                            </div>
                            <div class="card-body p-4 pt-2">
                                <div style="height: 220px; position: relative;">
                                    <canvas id="teamRatioChart"></canvas>
                                </div>
                                <div class="text-center mt-3">
                                    <span class="badge rounded-pill px-3 py-2" style="background: rgba(99, 102, 241, 0.1); color: #6366f1;">
                                        {% if total_marketers > 0 %}
                                            1 Marketer : {% widthratio total_clients total_marketers 1 %} Clients
                                        {% else %}
                                            No marketers yet
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Smart Recommendations -->
                {% if at_risk_users > 0 or dormant_users > 0 or engagement_score < 50 %}
                <div class="card border-0 shadow-sm mb-4" style="border-radius: 16px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="users-tab-icon-circle me-3" style="background: rgba(245, 158, 11, 0.2);">
                                <i class="bi bi-lightbulb" style="color: #f59e0b;"></i>
                            </div>
                            <h6 class="fw-bold mb-0" style="color: #92400e;">Smart Recommendations</h6>
                        </div>
                        <div class="row g-3">
                            {% if at_risk_users > 0 %}
                            <div class="col-md-6">
                                <div class="bg-white rounded-3 p-3 d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong class="text-dark">{{ at_risk_users }} users</strong>
                                        <span class="text-muted"> haven't logged in for 30+ days</span>
                                    </div>
                                    <button class="btn btn-sm btn-warning rounded-pill send-engagement-btn" data-email-type="reengagement">
                                        <i class="bi bi-send me-1"></i>Re-engage
                                    </button>
                                </div>
                            </div>
                            {% endif %}
                            {% if dormant_users > 0 %}
                            <div class="col-md-6">
                                <div class="bg-white rounded-3 p-3 d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong class="text-dark">{{ dormant_users }} users</strong>
                                        <span class="text-muted"> have never logged in</span>
                                    </div>
                                    <button class="btn btn-sm btn-danger rounded-pill send-engagement-btn" data-email-type="onboarding">
                                        <i class="bi bi-envelope me-1"></i>Onboard
                                    </button>
                                </div>
                            </div>
                            {% endif %}
                            {% if engagement_score < 50 %}
                            <div class="col-12">
                                <div class="bg-white rounded-3 p-3">
                                    <i class="bi bi-info-circle text-primary me-2"></i>
                                    <span class="text-muted">Engagement score is at {{ engagement_score }}%. Consider adding new features or improving onboarding to boost user activity.</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Users Table with Search & Filter -->
                <div class="card border-0 shadow-sm" style="border-radius: 16px;">
                    <div class="card-header bg-white border-0 p-4">
                        <div class="row align-items-center g-3">
                            <div class="col-lg-6">
                                <h6 class="fw-bold mb-0">
                                    <i class="bi bi-list-ul me-2 text-primary"></i>All Team Members
                                    <span class="badge rounded-pill ms-2" style="background: rgba(99, 102, 241, 0.1); color: #6366f1;">{{ registered_users_total_count|intcomma }}</span>
                                </h6>
                            </div>
                            <div class="col-lg-6">
                                <div class="d-flex gap-2 justify-content-lg-end flex-wrap">
                                    <div class="position-relative">
                                        <i class="bi bi-search position-absolute" style="left: 15px; top: 50%; transform: translateY(-50%); color: #9ca3af;"></i>
                                        <input type="text" id="userSearchInput" class="form-control users-tab-search-input" placeholder="Search users..." style="width: 220px;">
                                    </div>
                                    <div class="btn-group" role="group">
                                        <button type="button" class="users-tab-filter-btn active" data-filter="all">All</button>
                                        <button type="button" class="users-tab-filter-btn" data-filter="client">Clients</button>
                                        <button type="button" class="users-tab-filter-btn" data-filter="marketer">Marketers</button>
                                        <button type="button" class="users-tab-filter-btn" data-filter="admin">Admins</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table users-tab-table-modern mb-0" id="usersTable">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Last Activity</th>
                                    <th>Joined</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for u in registered_users %}
                                <tr data-role="{{ u.role|default:'other'|lower }}" {% if u.status_info.at_risk %}style="background: rgba(239, 68, 68, 0.05);"{% endif %}>
                                    <td>
                                        <div class="d-flex align-items-center gap-3">
                                            <div class="users-tab-user-avatar" style="background: {% if u.role == 'client' %}rgba(16, 185, 129, 0.1); color: #10b981;{% elif u.role == 'marketer' %}rgba(99, 102, 241, 0.1); color: #6366f1;{% elif u.role == 'admin' %}rgba(249, 115, 22, 0.1); color: #f97316;{% else %}rgba(236, 72, 153, 0.1); color: #ec4899;{% endif %}">
                                                {{ u.full_name|slice:":1"|upper }}
                                            </div>
                                            <div>
                                                <div class="fw-semibold">{{ u.full_name }}</div>
                                                <small class="text-muted">{{ u.email }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="users-tab-role-badge" style="{% if u.role == 'client' %}background: rgba(16, 185, 129, 0.1); color: #10b981;{% elif u.role == 'marketer' %}background: rgba(99, 102, 241, 0.1); color: #6366f1;{% elif u.role == 'admin' %}background: rgba(249, 115, 22, 0.1); color: #f97316;{% else %}background: rgba(236, 72, 153, 0.1); color: #ec4899;{% endif %}">
                                            {{ u.role|default:'User' }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if u.status_info %}
                                            {% if u.status_info.status == 'Active' %}
                                                <span><span class="users-tab-pulse-dot active"></span>Active</span>
                                            {% elif u.status_info.status == 'Idle' %}
                                                <span><span class="users-tab-pulse-dot idle"></span>Idle</span>
                                            {% else %}
                                                <span><span class="users-tab-pulse-dot inactive"></span>{{ u.status_info.status }}</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">Unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if u.status_info.days_since %}
                                            <span class="text-muted">{{ u.status_info.days_since }}d ago</span>
                                        {% else %}
                                            <span class="text-muted"><i class="bi bi-dash"></i> Never</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="text-muted">{{ u.date_joined|date:'M d, Y' }}</span>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-5">
                                        <div class="text-muted">
                                            <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                                            <p class="mt-3 mb-0">No team members yet</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination -->
                    {% if registered_users_page.has_other_pages %}
                    <div class="card-footer bg-white border-0 d-flex justify-content-center py-4">
                        <nav>
                            <ul class="pagination mb-0">
                                {% if registered_users_page.has_previous %}
                                <li class="page-item">
                                    <a class="page-link rounded-circle me-1" href="?users_page=1" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">«</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link rounded-pill px-3" href="?users_page={{ registered_users_page.previous_page_number }}">Previous</a>
                                </li>
                                {% endif %}
                                <li class="page-item disabled mx-2">
                                    <span class="page-link border-0 bg-transparent">
                                        <span class="fw-bold text-primary">{{ registered_users_page.number }}</span>
                                        <span class="text-muted"> / {{ registered_users_page.paginator.num_pages }}</span>
                                    </span>
                                </li>
                                {% if registered_users_page.has_next %}
                                <li class="page-item">
                                    <a class="page-link rounded-pill px-3" href="?users_page={{ registered_users_page.next_page_number }}">Next</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link rounded-circle ms-1" href="?users_page={{ registered_users_page.paginator.num_pages }}" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">»</a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                    </div>
                    {% endif %}
                </div>

                <!-- Chart.js Scripts -->
                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <script>
                    // User Status Doughnut Chart
                    var statusCtx = document.getElementById('statusChart');
                    if (statusCtx) {
                        new Chart(statusCtx, {
                            type: 'doughnut',
                            data: {
                                labels: {{ chart_data.status_labels|safe }},
                                datasets: [{
                                    data: {{ chart_data.status_values|safe }},
                                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#6b7280'],
                                    borderWidth: 0,
                                    cutout: '70%'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } }
                            }
                        });
                    }

                    // Weekly Activity Bar Chart
                    var frequencyCtx = document.getElementById('frequencyChart');
                    if (frequencyCtx) {
                        new Chart(frequencyCtx, {
                            type: 'bar',
                            data: {
                                labels: {{ chart_data.login_days|safe }},
                                datasets: [{
                                    data: {{ chart_data.login_frequency|safe }},
                                    backgroundColor: '#10b981',
                                    borderRadius: 8,
                                    borderSkipped: false
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    y: { beginAtZero: true, grid: { display: false }, ticks: { display: false } },
                                    x: { grid: { display: false } }
                                }
                            }
                        });
                    }

                    // Team Ratio Doughnut
                    var ratioCtx = document.getElementById('teamRatioChart');
                    if (ratioCtx) {
                        new Chart(ratioCtx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Clients', 'Marketers', 'Admins', 'Support'],
                                datasets: [{
                                    data: [{{ total_clients|default:0 }}, {{ total_marketers|default:0 }}, {{ admin_users|length }}, {{ support_users|length }}],
                                    backgroundColor: ['#10b981', '#6366f1', '#f97316', '#ec4899'],
                                    borderWidth: 0,
                                    cutout: '65%'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } }
                            }
                        });
                    }

                    // Search & Filter Functionality
                    document.getElementById('userSearchInput')?.addEventListener('input', function(e) {
                        const search = e.target.value.toLowerCase();
                        document.querySelectorAll('#usersTable tbody tr').forEach(row => {
                            const text = row.textContent.toLowerCase();
                            row.style.display = text.includes(search) ? '' : 'none';
                        });
                    });

                    document.querySelectorAll('.users-tab-filter-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            document.querySelectorAll('.users-tab-filter-btn').forEach(b => b.classList.remove('active'));
                            this.classList.add('active');
                            const filter = this.dataset.filter;
                            document.querySelectorAll('#usersTable tbody tr').forEach(row => {
                                const role = row.dataset.role;
                                row.style.display = (filter === 'all' || role === filter) ? '' : 'none';
                            });
                        });
                    });
                </script>
            </div>

            <!-- Admins -->
            <div class="tab-pane fade" id="admins" role="tabpanel" aria-labelledby="admins-tab">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <strong>Admin Users</strong>
                        <span class="badge bg-primary">{{ admin_users|length }}</span>
                    </div>
                                <div class="table-responsive">
                        <table class="table table-striped align-middle mb-0">
                            <thead class="table-light">
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Email</th>
                                                    <th>Phone</th>
                                                    <th>Joined</th>
                                                    <th>Last Login</th>
                                                    <th>Login Location</th>
                                                    <th>Status</th>
                                                    <th class="text-end">Actions</th>
                                                </tr>
                            </thead>
                            <tbody>
                                {% for a in admin_users %}
                                <tr>
                                    <td>
                                        {{ a.full_name }}
                                        {% if master_admin_id and a.id == master_admin_id %}
                                            <span class="badge bg-warning text-dark ms-2" title="Master admin">Master admin</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ a.email }}</td>
                                    <td>{{ a.phone|default:'-' }}</td>
                                                <td>{{ a.date_joined|date:'M d, Y' }}</td>
                                                    <td>{{ a.last_login|date:'M d, Y H:i'|default:'—' }}</td>
                                                    <td>
                                                        {% if a.last_login_location %}
                                                            {{ a.last_login_location }}
                                                        {% elif a.last_login_ip %}
                                                            {{ a.last_login_ip }}
                                                        {% else %}
                                                            —
                                                        {% endif %}
                                                    </td>
                                                <td>
                                                    {% if a.last_login %}
                                                        {% if a.is_active %}
                                                            <span class="badge bg-success">Active</span>
                                                        {% else %}
                                                            <span class="badge bg-secondary">Muted</span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="badge bg-warning">NOT ACTIVE</span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-end">
                                                    {% if master_admin_id and a.id == master_admin_id %}
                                                        <span class="badge bg-success-subtle text-success px-3 py-2">
                                                            <i class="bi bi-shield-check me-1"></i>Master Admin (Full Control)
                                                        </span>
                                                    {% elif master_admin_id and request.user.id == master_admin_id %}
                                                        <div class="d-flex gap-2 justify-content-end flex-wrap">
                                                            <button class="btn btn-sm {% if a.has_full_control %}btn-success{% else %}btn-outline-secondary{% endif %}" 
                                                                    data-action="toggle-full-control" 
                                                                    data-user-id="{{ a.id }}" 
                                                                    data-has-control="{{ a.has_full_control|yesno:'true,false' }}"
                                                                    title="{% if a.has_full_control %}Revoke Full Control{% else %}Grant Full Control{% endif %}">
                                                                <i class="bi {% if a.has_full_control %}bi-shield-fill-check{% else %}bi-shield{% endif %}"></i>
                                                                {% if a.has_full_control %}Full Control{% else %}Grant Control{% endif %}
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-primary" data-action="edit-user" data-user-id="{{ a.id }}" data-user-type="admin" data-user-name="{{ a.full_name }}" data-user-email="{{ a.email }}" data-user-phone="{{ a.phone|default:'' }}" data-user-address="{{ a.address|default:'' }}">
                                                                <i class="bi bi-pencil"></i>
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-warning" data-action="toggle-mute" data-user-id="{{ a.id }}" data-current="{{ a.is_active|yesno:'active,muted' }}">
                                                                {% if a.is_active %}<i class="bi bi-volume-mute"></i>{% else %}<i class="bi bi-volume-up"></i>{% endif %}
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-danger" data-action="delete-admin" data-user-id="{{ a.id }}" data-name="{{ a.full_name }}">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    {% else %}
                                                        {% if a.has_full_control %}
                                                            <span class="badge bg-success-subtle text-success px-3 py-2">
                                                                <i class="bi bi-shield-fill-check me-1"></i>Full Control Granted
                                                            </span>
                                                        {% else %}
                                                            <span class="text-muted small">Only master admin can manage</span>
                                                        {% endif %}
                                                    {% endif %}
                                                </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="8" class="text-center text-muted">No admin users found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                        <div class="card mt-3">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <strong>Support Users</strong>
                        <span class="badge bg-secondary">{{ support_users|length }}</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped align-middle mb-0">
                            <thead class="table-light">
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Email</th>
                                                    <th>Phone</th>
                                                    <th>Joined</th>
                                                    <th>Last Login</th>
                                                    <th>Login Location</th>
                                                    <th>Status</th>
                                                    <th class="text-end">Actions</th>
                                                </tr>
                            </thead>
                            <tbody>
                                {% for s in support_users %}
                                <tr>
                                    <td>{{ s.full_name }}</td>
                                    <td>{{ s.email }}</td>
                                    <td>{{ s.phone|default:'-' }}</td>
                                            <td>{{ s.date_joined|date:'M d, Y' }}</td>
                                                    <td>{{ s.last_login|date:'M d, Y H:i'|default:'—' }}</td>
                                                    <td>
                                                        {% if s.last_login_location %}
                                                            {{ s.last_login_location }}
                                                        {% elif s.last_login_ip %}
                                                            {{ s.last_login_ip }}
                                                        {% else %}
                                                            —
                                                        {% endif %}
                                                    </td>
                                            <td>
                                                {% if s.status_display == "Active" %}
                                                    <span class="badge bg-success">Active</span>
                                                {% elif s.status_display == "Not Active" %}
                                                    <span class="badge bg-secondary">Not Active</span>
                                                {% else %}
                                                    <span class="badge bg-warning">{{ s.status_display }}</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-end">
                                                {% if master_admin_id and request.user.id == master_admin_id %}
                                                    <button class="btn btn-sm btn-outline-primary me-2" data-action="edit-user" data-user-id="{{ s.id }}" data-user-type="support" data-user-name="{{ s.full_name }}" data-user-email="{{ s.email }}" data-user-phone="{{ s.phone|default:'' }}" data-user-address="{{ s.address|default:'' }}">
                                                        <i class="bi bi-pencil"></i> Update
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-warning me-2" data-action="toggle-mute" data-user-id="{{ s.id }}" data-current="{{ s.is_active|yesno:'active,muted' }}">
                                                        {% if s.is_active %}<i class="bi bi-volume-mute"></i> Mute{% else %}<i class="bi bi-volume-up"></i> Unmute{% endif %}
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" data-action="delete-admin" data-user-id="{{ s.id }}" data-name="{{ s.full_name }}">
                                                        <i class="bi bi-trash"></i> Delete
                                                    </button>
                                                {% else %}
                                                    <span class="text-muted">Only master admin can Update</span>
                                                {% endif %}
                                            </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="8" class="text-center text-muted">No support users found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- AdminSupport -->
            <div class="tab-pane fade" id="support" role="tabpanel" aria-labelledby="support-tab">
                <div class="row g-3">
                    <div class="col-lg-6">
                        <div class="card h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <strong>Staff Roster (linked users)</strong>
                                <span class="badge bg-info">{{ staff_roster_count }}</span>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>User</th>
                                            <th>Email</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for r in staff_roster %}
                                        <tr>
                                            <td>{{ r.user.full_name }}</td>
                                            <td>{{ r.user.email }}</td>
                                            <td>{% if r.active %}<span class="badge bg-success">Active</span>{% else %}<span class="badge bg-secondary">Inactive</span>{% endif %}</td>
                                        </tr>
                                        {% empty %}
                                        <tr><td colspan="3" class="text-center text-muted">No roster entries.</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <strong>Staff Members (directory)</strong>
                                <span class="badge bg-info">{{ staff_members_count }}</span>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for m in staff_members %}
                                        <tr>
                                            <td>{{ m.full_name }}</td>
                                            <td>{{ m.email }}</td>
                                            <td>{{ m.role|default:'—' }}</td>
                                            <td>{% if m.active %}<span class="badge bg-success">Active</span>{% else %}<span class="badge bg-secondary">Inactive</span>{% endif %}</td>
                                        </tr>
                                        {% empty %}
                                        <tr><td colspan="4" class="text-center text-muted">No staff members yet.</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Register Admins Tab -->
            <div class="tab-pane fade" id="user-registration" role="tabpanel" aria-labelledby="user-registration-tab">
                <style>
                    .admin-reg-card {
                        border-radius: 16px;
                        border: none;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
                    }
                    .admin-reg-header {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border-radius: 16px 16px 0 0;
                        padding: 1.5rem;
                    }
                    .admin-reg-form .form-label {
                        font-weight: 600;
                        color: #495057;
                        margin-bottom: 0.5rem;
                    }
                    .admin-reg-form .form-control {
                        border-radius: 10px;
                        padding: 0.75rem 1rem;
                        border: 2px solid #e9ecef;
                        transition: all 0.3s ease;
                    }
                    .admin-reg-form .form-control:focus {
                        border-color: #667eea;
                        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                    }
                    .admin-reg-role-card {
                        border: 2px solid #e9ecef;
                        border-radius: 12px;
                        padding: 1.25rem;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        text-align: center;
                    }
                    .admin-reg-role-card:hover {
                        border-color: #667eea;
                        background: rgba(102, 126, 234, 0.05);
                    }
                    .admin-reg-role-card.selected {
                        border-color: #667eea;
                        background: rgba(102, 126, 234, 0.1);
                    }
                    .admin-reg-role-card i {
                        font-size: 2rem;
                        margin-bottom: 0.5rem;
                    }
                    .admin-reg-role-card.admin-type i { color: #f97316; }
                    .admin-reg-role-card.support-type i { color: #ec4899; }
                    .admin-reg-submit-btn {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border: none;
                        border-radius: 10px;
                        padding: 0.875rem 2rem;
                        font-weight: 600;
                        transition: all 0.3s ease;
                    }
                    .admin-reg-submit-btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
                    }
                </style>

                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card admin-reg-card">
                            <div class="admin-reg-header">
                                <h5 class="mb-1"><i class="bi bi-person-plus-fill me-2"></i>Register Company Admin / Support</h5>
                                <p class="mb-0 opacity-75 small">Add new administrators or support staff to your company</p>
                            </div>
                            <div class="card-body p-4">
                                <!-- Success/Error Messages -->
                                <div id="adminRegMessages"></div>

                                <form id="adminRegistrationForm" class="admin-reg-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="source" value="company_profile">

                                    <!-- Role Selection -->
                                    <div class="mb-4">
                                        <label class="form-label"><i class="bi bi-person-badge me-1"></i>Select Role</label>
                                        <div class="row g-3">
                                            <div class="col-6">
                                                <div class="admin-reg-role-card admin-type" data-role="admin" onclick="selectAdminRole(this, 'admin')">
                                                    <i class="bi bi-shield-check"></i>
                                                    <div class="fw-bold">Company Admin</div>
                                                    <small class="text-muted">Full management access</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="admin-reg-role-card support-type" data-role="support" onclick="selectAdminRole(this, 'support')">
                                                    <i class="bi bi-headset"></i>
                                                    <div class="fw-bold">Support Staff</div>
                                                    <small class="text-muted">Customer support access</small>
                                                </div>
                                            </div>
                                        </div>
                                        <input type="hidden" name="role" id="adminRoleInput" required>
                                    </div>

                                    <!-- Full Name -->
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label"><i class="bi bi-person me-1"></i>Full Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" name="name" id="adminFullName" placeholder="Enter full name" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label"><i class="bi bi-envelope me-1"></i>Email Address <span class="text-danger">*</span></label>
                                            <input type="email" class="form-control" name="email" id="adminEmail" placeholder="Enter email address" required>
                                        </div>
                                    </div>

                                    <!-- Phone & Country -->
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label"><i class="bi bi-telephone me-1"></i>Phone Number</label>
                                            <input type="tel" class="form-control" name="phone" id="adminPhone" placeholder="Enter phone number">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label"><i class="bi bi-globe me-1"></i>Country</label>
                                            <input type="text" class="form-control" name="country" id="adminCountry" placeholder="Enter country">
                                        </div>
                                    </div>

                                    <!-- Address -->
                                    <div class="mb-3">
                                        <label class="form-label"><i class="bi bi-geo-alt me-1"></i>Address</label>
                                        <input type="text" class="form-control" name="address" id="adminAddress" placeholder="Enter address">
                                    </div>

                                    <!-- Date of Birth -->
                                    <div class="row g-3 mb-4">
                                        <div class="col-md-6">
                                            <label class="form-label"><i class="bi bi-calendar me-1"></i>Date of Birth</label>
                                            <input type="date" class="form-control" name="date_of_birth" id="adminDOB">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label"><i class="bi bi-key me-1"></i>Password <small class="text-muted">(auto-generated if empty)</small></label>
                                            <div class="input-group">
                                                <input type="password" class="form-control" name="password" id="adminPassword" placeholder="Leave empty to auto-generate">
                                                <button class="btn btn-outline-secondary" type="button" onclick="toggleAdminPassword()">
                                                    <i class="bi bi-eye" id="adminPasswordToggleIcon"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Submit Button -->
                                    <div class="d-flex justify-content-between align-items-center">
                                        <button type="button" class="btn btn-outline-secondary" onclick="resetAdminForm()">
                                            <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
                                        </button>
                                        <button type="submit" class="btn btn-primary admin-reg-submit-btn" id="adminSubmitBtn">
                                            <i class="bi bi-person-plus me-1"></i>Register User
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Info Card -->
                        <div class="card border-0 mt-4" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px;">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-start gap-3">
                                    <i class="bi bi-info-circle-fill" style="color: #f59e0b; font-size: 1.25rem;"></i>
                                    <div>
                                        <strong style="color: #92400e;">Registration Notes:</strong>
                                        <ul class="mb-0 mt-2 small" style="color: #78350f;">
                                            <li><strong>Company Admins</strong> can manage all aspects of the company including users, estates, and settings.</li>
                                            <li><strong>Support Staff</strong> can assist with customer queries and view limited data.</li>
                                            <li>If no password is provided, a temporary password will be auto-generated.</li>
                                            <li>New users will receive an email notification with login credentials.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                    function selectAdminRole(element, role) {
                        document.querySelectorAll('.admin-reg-role-card').forEach(card => card.classList.remove('selected'));
                        element.classList.add('selected');
                        document.getElementById('adminRoleInput').value = role;
                    }

                    function toggleAdminPassword() {
                        const input = document.getElementById('adminPassword');
                        const icon = document.getElementById('adminPasswordToggleIcon');
                        if (input.type === 'password') {
                            input.type = 'text';
                            icon.classList.remove('bi-eye');
                            icon.classList.add('bi-eye-slash');
                        } else {
                            input.type = 'password';
                            icon.classList.remove('bi-eye-slash');
                            icon.classList.add('bi-eye');
                        }
                    }

                    function resetAdminForm() {
                        document.getElementById('adminRegistrationForm').reset();
                        document.querySelectorAll('.admin-reg-role-card').forEach(card => card.classList.remove('selected'));
                        document.getElementById('adminRoleInput').value = '';
                        document.getElementById('adminRegMessages').innerHTML = '';
                    }

                    document.getElementById('adminRegistrationForm').addEventListener('submit', async function(e) {
                        e.preventDefault();
                        const form = this;
                        const submitBtn = document.getElementById('adminSubmitBtn');
                        const messagesDiv = document.getElementById('adminRegMessages');
                        
                        // Validate role selection
                        const role = document.getElementById('adminRoleInput').value;
                        if (!role) {
                            messagesDiv.innerHTML = '<div class="alert alert-danger alert-dismissible fade show" role="alert"><i class="bi bi-exclamation-circle me-2"></i>Please select a role (Admin or Support).<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
                            return;
                        }

                        // Validate required fields
                        const fullName = document.getElementById('adminFullName').value.trim();
                        const email = document.getElementById('adminEmail').value.trim();
                        if (!fullName || !email) {
                            messagesDiv.innerHTML = '<div class="alert alert-danger alert-dismissible fade show" role="alert"><i class="bi bi-exclamation-circle me-2"></i>Full name and email are required.<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
                            return;
                        }

                        // Disable button and show loading
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Registering...';
                        messagesDiv.innerHTML = '';

                        try {
                            const formData = new FormData(form);
                            const response = await fetch('{% url "user-registration" %}', {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            });

                            const data = await response.json();
                            
                            if (data.success) {
                                let successMsg = data.message || 'User registered successfully!';
                                if (data.temporary_password) {
                                    successMsg += '<br><strong>Temporary Password:</strong> <code class="user-select-all">' + data.temporary_password + '</code>';
                                }
                                messagesDiv.innerHTML = '<div class="alert alert-success alert-dismissible fade show" role="alert"><i class="bi bi-check-circle me-2"></i>' + successMsg + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
                                resetAdminForm();
                                // Optionally reload page after 2 seconds to show new user in tables
                                setTimeout(() => { window.location.reload(); }, 2500);
                            } else {
                                messagesDiv.innerHTML = '<div class="alert alert-danger alert-dismissible fade show" role="alert"><i class="bi bi-exclamation-circle me-2"></i>' + (data.message || 'Registration failed. Please try again.') + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
                            }
                        } catch (error) {
                            messagesDiv.innerHTML = '<div class="alert alert-danger alert-dismissible fade show" role="alert"><i class="bi bi-exclamation-circle me-2"></i>An error occurred. Please try again.<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
                        } finally {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="bi bi-person-plus me-1"></i>Register User';
                        }
                    });
                </script>
            </div>

            <!-- ==================== ANALYTICS DASHBOARD ==================== -->
            <div class="tab-pane fade" id="analytics" role="tabpanel" aria-labelledby="analytics-tab">
                <!-- Analytics Header with Gradient -->
                <div class="analytics-header mb-4 p-4 rounded-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h3 class="text-white mb-2 fw-bold">
                                <i class="bi bi-graph-up-arrow me-2"></i>Business Analytics Dashboard
                            </h3>
                            <p class="text-white-50 mb-0">Gain insights into your company's performance with descriptive, predictive, and prescriptive analytics</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group">
                                <button class="btn btn-light btn-sm" id="analyticsRefreshBtn">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                                </button>
                                <button class="btn btn-light btn-sm" id="analyticsExportBtn">
                                    <i class="bi bi-download me-1"></i>Export Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Period Selector -->
                <div class="card border-0 shadow-sm mb-4 analytics-filter-card">
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold text-muted small">ANALYSIS PERIOD</label>
                                <select class="form-select" id="analyticsPeriodType">
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="annual" selected>Annual</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold text-muted small">SELECT YEAR</label>
                                <select class="form-select" id="analyticsYear">
                                    <!-- Populated by JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold text-muted small">COMPARE WITH</label>
                                <select class="form-select" id="analyticsCompareYear">
                                    <option value="">No Comparison</option>
                                    <!-- Populated by JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button class="btn w-100" id="analyticsApplyBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <i class="bi bi-funnel me-1"></i>Apply Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KPI Cards with Animation -->
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="analytics-kpi-card" style="--delay: 0.1s;">
                            <div class="kpi-icon bg-primary">
                                <i class="bi bi-currency-exchange"></i>
                            </div>
                            <div class="kpi-content">
                                <span class="kpi-label">Total Revenue</span>
                                <h3 class="kpi-value" id="totalRevenueKPI">₦0</h3>
                                <span class="kpi-change positive" id="revenueChange">
                                    <i class="bi bi-arrow-up"></i> +0%
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="analytics-kpi-card" style="--delay: 0.2s;">
                            <div class="kpi-icon bg-success">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <div class="kpi-content">
                                <span class="kpi-label">Closed Deals</span>
                                <h3 class="kpi-value" id="closedDealsKPI">0</h3>
                                <span class="kpi-change positive" id="dealsChange">
                                    <i class="bi bi-arrow-up"></i> +0%
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="analytics-kpi-card" style="--delay: 0.3s;">
                            <div class="kpi-icon bg-warning">
                                <i class="bi bi-people"></i>
                            </div>
                            <div class="kpi-content">
                                <span class="kpi-label">Active Marketers</span>
                                <h3 class="kpi-value" id="activeMarketersKPI">0</h3>
                                <span class="kpi-change neutral" id="marketersChange">
                                    <i class="bi bi-dash"></i> 0%
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="analytics-kpi-card" style="--delay: 0.4s;">
                            <div class="kpi-icon bg-info">
                                <i class="bi bi-bullseye"></i>
                            </div>
                            <div class="kpi-content">
                                <span class="kpi-label">Target Achievement</span>
                                <h3 class="kpi-value" id="targetAchievementKPI">0%</h3>
                                <span class="kpi-change" id="targetChange">
                                    <i class="bi bi-dash"></i> --
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row g-4 mb-4">
                    <!-- Revenue Trend Chart -->
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm h-100 analytics-chart-card">
                            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                                <h5 class="mb-0 fw-bold">
                                    <i class="bi bi-graph-up text-primary me-2"></i>Revenue Trend
                                </h5>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary active" data-chart-view="line">Line</button>
                                    <button class="btn btn-outline-primary" data-chart-view="bar">Bar</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                                    <canvas id="revenueTrendChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Performance Distribution -->
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-sm h-100 analytics-chart-card">
                            <div class="card-header bg-white border-0">
                                <h5 class="mb-0 fw-bold">
                                    <i class="bi bi-pie-chart text-success me-2"></i>Performance Distribution
                                </h5>
                            </div>
                            <div class="card-body d-flex align-items-center justify-content-center">
                                <div class="chart-container" style="position: relative; height: 250px; width: 100%;">
                                    <canvas id="performanceDistChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Descriptive Analytics Section -->
                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm analytics-section-card">
                            <div class="card-header bg-white border-0">
                                <h5 class="mb-0 fw-bold">
                                    <i class="bi bi-bar-chart-line text-primary me-2"></i>Descriptive Analytics
                                    <span class="badge bg-primary ms-2">What Happened?</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-4">
                                    <!-- Monthly Breakdown -->
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3"><i class="bi bi-calendar3 me-2"></i>Monthly Breakdown</h6>
                                        <div class="chart-container" style="position: relative; height: 200px; width: 100%;">
                                            <canvas id="monthlyBreakdownChart"></canvas>
                                        </div>
                                    </div>
                                    <!-- Top Performers -->
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3"><i class="bi bi-trophy me-2"></i>Top Performers</h6>
                                        <div id="topPerformersContainer">
                                            <!-- Populated by JavaScript -->
                                            <div class="text-center py-4 text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                                <p class="mt-2 mb-0">Loading top performers...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Predictive Analytics Section -->
                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm analytics-section-card predictive-card">
                            <div class="card-header bg-white border-0">
                                <h5 class="mb-0 fw-bold">
                                    <i class="bi bi-lightning-charge text-warning me-2"></i>Predictive Analytics
                                    <span class="badge bg-warning text-dark ms-2">What Will Happen?</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-4">
                                    <!-- Forecast Chart -->
                                    <div class="col-md-8">
                                        <h6 class="text-muted mb-3"><i class="bi bi-graph-up-arrow me-2"></i>Sales Forecast (Next 6 Months)</h6>
                                        <div class="chart-container" style="position: relative; height: 200px; width: 100%;">
                                            <canvas id="forecastChart"></canvas>
                                        </div>
                                    </div>
                                    <!-- Forecast Cards -->
                                    <div class="col-md-4">
                                        <div class="forecast-scenario-card optimistic mb-3">
                                            <div class="scenario-header">
                                                <i class="bi bi-emoji-smile"></i>
                                                <span>Optimistic</span>
                                            </div>
                                            <h4 class="scenario-value" id="forecastOptimistic">₦0</h4>
                                            <span class="scenario-growth">+25% growth</span>
                                        </div>
                                        <div class="forecast-scenario-card realistic mb-3">
                                            <div class="scenario-header">
                                                <i class="bi bi-emoji-neutral"></i>
                                                <span>Realistic</span>
                                            </div>
                                            <h4 class="scenario-value" id="forecastRealistic">₦0</h4>
                                            <span class="scenario-growth">+15% growth</span>
                                        </div>
                                        <div class="forecast-scenario-card conservative">
                                            <div class="scenario-header">
                                                <i class="bi bi-shield-check"></i>
                                                <span>Conservative</span>
                                            </div>
                                            <h4 class="scenario-value" id="forecastConservative">₦0</h4>
                                            <span class="scenario-growth">+5% growth</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Prescriptive Analytics Section -->
                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm analytics-section-card prescriptive-card">
                            <div class="card-header bg-white border-0">
                                <h5 class="mb-0 fw-bold">
                                    <i class="bi bi-lightbulb text-success me-2"></i>Prescriptive Analytics
                                    <span class="badge bg-success ms-2">What Should We Do?</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-4" id="recommendationsContainer">
                                    <!-- AI Recommendations will be loaded here -->
                                    <div class="col-12 text-center py-4 text-muted">
                                        <div class="spinner-border spinner-border-sm" role="status"></div>
                                        <p class="mt-2 mb-0">Generating recommendations...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Growth Insights -->
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white border-0">
                                <h5 class="mb-0 fw-bold">
                                    <i class="bi bi-speedometer2 text-info me-2"></i>Growth Velocity
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height: 200px; width: 100%;">
                                    <canvas id="growthVelocityChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white border-0">
                                <h5 class="mb-0 fw-bold">
                                    <i class="bi bi-calendar-week text-danger me-2"></i>Seasonal Patterns
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height: 200px; width: 100%;">
                                    <canvas id="seasonalPatternChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== COLLECTIONS & PAYMENT HEALTH ==================== -->
                <div class="row g-4 mt-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm analytics-section-card">
                            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                                <h5 class="mb-0 fw-bold">
                                    <i class="bi bi-cash-coin text-success me-2"></i>Collections & Payment Health
                                    <span class="badge bg-success ms-2">Financial Insights</span>
                                </h5>
                                <div class="d-flex gap-2">
                                    <a href="{% url 'marketer_export_api' %}?format=excel" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-file-earmark-excel me-1"></i>Download All Marketers
                                    </a>
                                    <a href="{% url 'client_export_api' %}?format=excel" class="btn btn-sm btn-outline-info">
                                        <i class="bi bi-file-earmark-excel me-1"></i>Download All Clients
                                    </a>
                                    <button class="btn btn-sm btn-outline-success" id="refreshPaymentHealthBtn">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Payment Health KPIs -->
                                <div class="row g-3 mb-4">
                                    <div class="col-md-3">
                                        <div class="payment-health-card bg-gradient-primary text-white rounded-4 p-3">
                                            <div class="d-flex align-items-center">
                                                <div class="icon-circle bg-white bg-opacity-25 rounded-circle p-2 me-3">
                                                    <i class="bi bi-currency-exchange fs-5"></i>
                                                </div>
                                                <div>
                                                    <div class="small opacity-75">Total Sales Value</div>
                                                    <div class="fs-5 fw-bold" id="phTotalSales">₦0</div>
                                                    <div class="small" id="phTotalCount">0 transactions</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="payment-health-card bg-gradient-success text-white rounded-4 p-3">
                                            <div class="d-flex align-items-center">
                                                <div class="icon-circle bg-white bg-opacity-25 rounded-circle p-2 me-3">
                                                    <i class="bi bi-check-circle fs-5"></i>
                                                </div>
                                                <div>
                                                    <div class="small opacity-75">Collected Amount</div>
                                                    <div class="fs-5 fw-bold" id="phCollected">₦0</div>
                                                    <div class="small" id="phCollectionRate">0% collection rate</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="payment-health-card bg-gradient-warning text-white rounded-4 p-3">
                                            <div class="d-flex align-items-center">
                                                <div class="icon-circle bg-white bg-opacity-25 rounded-circle p-2 me-3">
                                                    <i class="bi bi-hourglass-split fs-5"></i>
                                                </div>
                                                <div>
                                                    <div class="small opacity-75">Outstanding Balance</div>
                                                    <div class="fs-5 fw-bold" id="phOutstanding">₦0</div>
                                                    <div class="small" id="phPendingCount">0 pending payments</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="payment-health-card bg-gradient-danger text-white rounded-4 p-3">
                                            <div class="d-flex align-items-center">
                                                <div class="icon-circle bg-white bg-opacity-25 rounded-circle p-2 me-3">
                                                    <i class="bi bi-exclamation-triangle fs-5"></i>
                                                </div>
                                                <div>
                                                    <div class="small opacity-75">Overdue Amount</div>
                                                    <div class="fs-5 fw-bold" id="phOverdue">₦0</div>
                                                    <div class="small" id="phOverdueCount">0 overdue</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row g-4">
                                    <!-- Payment Status Distribution -->
                                    <div class="col-md-4">
                                        <h6 class="text-muted mb-3"><i class="bi bi-pie-chart me-2"></i>Payment Status Distribution</h6>
                                        <div class="chart-container" style="position: relative; height: 200px; width: 100%;">
                                            <canvas id="paymentStatusChart"></canvas>
                                        </div>
                                    </div>
                                    <!-- Collection Trend -->
                                    <div class="col-md-4">
                                        <h6 class="text-muted mb-3"><i class="bi bi-graph-up me-2"></i>Monthly Collection Trend</h6>
                                        <div class="chart-container" style="position: relative; height: 200px; width: 100%;">
                                            <canvas id="collectionTrendChart"></canvas>
                                        </div>
                                    </div>
                                    <!-- Estate Performance -->
                                    <div class="col-md-4">
                                        <h6 class="text-muted mb-3"><i class="bi bi-building me-2"></i>Sales by Estate</h6>
                                        <div class="chart-container" style="position: relative; height: 200px; width: 100%;">
                                            <canvas id="estatePerformanceChart"></canvas>
                                        </div>
                                    </div>
                                </div>

                                <!-- Payment Health Insights -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="alert alert-light border-0 shadow-sm" id="paymentHealthInsights">
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-lightbulb text-warning fs-4 me-3"></i>
                                                <div>
                                                    <strong>Collection Insights:</strong>
                                                    <span id="phInsightText">Loading payment health analysis...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Overdue Clients List (Collapsible) -->
                                <div class="accordion mt-3" id="overdueAccordion">
                                    <div class="accordion-item border-0 shadow-sm">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#overdueClientsList">
                                                <i class="bi bi-people text-danger me-2"></i>
                                                <span>Overdue Clients Requiring Attention</span>
                                                <span class="badge bg-danger ms-2" id="overdueClientsBadge">0</span>
                                            </button>
                                        </h2>
                                        <div id="overdueClientsList" class="accordion-collapse collapse" data-bs-parent="#overdueAccordion">
                                            <div class="accordion-body p-0">
                                                <div class="table-responsive">
                                                    <table class="table table-hover mb-0">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>Client</th>
                                                                <th>Estate</th>
                                                                <th>Outstanding</th>
                                                                <th>Days Overdue</th>
                                                                <th>Action</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="overdueClientsTableBody">
                                                            <tr>
                                                                <td colspan="5" class="text-center text-muted py-3">Loading...</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Transaction Export Section -->
                                <div class="accordion mt-3" id="transactionExportAccordion">
                                    <div class="accordion-item border-0 shadow-sm">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#transactionExportPanel">
                                                <i class="bi bi-file-earmark-spreadsheet text-success me-2"></i>
                                                <span>Export All Transactions</span>
                                                <span class="badge bg-success ms-2">Since Inception</span>
                                            </button>
                                        </h2>
                                        <div id="transactionExportPanel" class="accordion-collapse collapse" data-bs-parent="#transactionExportAccordion">
                                            <div class="accordion-body">
                                                <!-- Export Filters -->
                                                <div class="row g-3 mb-4 align-items-end">
                                                    <div class="col-md-2">
                                                        <label class="form-label small text-muted fw-semibold mb-2 d-block">FROM DATE</label>
                                                        <input type="date" class="form-control form-control-sm txn-filter-input w-100" id="txnExportFromDate" placeholder="Start date">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label small text-muted fw-semibold mb-2 d-block">TO DATE</label>
                                                        <input type="date" class="form-control form-control-sm txn-filter-input w-100" id="txnExportToDate" placeholder="End date">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label small text-muted fw-semibold mb-2 d-block">ESTATE</label>
                                                        <select class="form-control form-control-sm txn-filter-input w-100" id="txnExportEstate">
                                                            <option value="">All Estates</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label small text-muted fw-semibold mb-2 d-block">STATUS</label>
                                                        <select class="form-control form-control-sm txn-filter-input w-100" id="txnExportStatus">
                                                            <option value="">All Statuses</option>
                                                            <option value="Fully Paid">Fully Paid</option>
                                                            <option value="Paid Complete">Paid Complete</option>
                                                            <option value="Part Payment">Part Payment</option>
                                                            <option value="Pending">Pending</option>
                                                            <option value="Overdue">Overdue</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label small text-muted fw-semibold mb-2 d-block">MARKETER</label>
                                                        <select class="form-control form-control-sm txn-filter-input w-100" id="txnExportMarketer">
                                                            <option value="">All Marketers</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label small text-muted fw-semibold mb-2 d-block">FORMAT</label>
                                                        <select class="form-control form-control-sm txn-filter-input w-100" id="txnExportFormat">
                                                            <option value="excel">Excel (.xlsx)</option>
                                                            <option value="csv">CSV</option>
                                                            <option value="pdf">PDF</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <style>
                                                    .txn-filter-input {
                                                        border: 1px solid #dee2e6;
                                                        border-radius: 6px;
                                                        padding: 0.5rem 0.75rem;
                                                        font-size: 0.875rem;
                                                        background-color: #fff;
                                                        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
                                                        height: 38px;
                                                        display: flex;
                                                        align-items: center;
                                                    }
                                                    .txn-filter-input:focus {
                                                        border-color: #667eea;
                                                        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
                                                        outline: none;
                                                    }
                                                    .txn-filter-input:hover {
                                                        border-color: #adb5bd;
                                                    }
                                                    select.txn-filter-input {
                                                        cursor: pointer;
                                                        appearance: none;
                                                        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
                                                        background-repeat: no-repeat;
                                                        background-position: right 0.75rem center;
                                                        background-size: 12px;
                                                        padding-right: 2.25rem;
                                                    }
                                                </style>

                                                <!-- Export Summary & Actions -->
                                                <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded-3">
                                                    <div>
                                                        <span class="text-muted">Transactions matching filters:</span>
                                                        <strong class="ms-2" id="txnExportCount">Loading...</strong>
                                                        <span class="text-muted ms-3">|</span>
                                                        <span class="text-muted ms-3">Total Value:</span>
                                                        <strong class="text-success ms-2" id="txnExportValue">₦0</strong>
                                                    </div>
                                                    <div class="btn-group">
                                                        <button class="btn btn-outline-secondary btn-sm" id="txnPreviewBtn">
                                                            <i class="bi bi-eye me-1"></i>Preview
                                                        </button>
                                                        <button class="btn btn-success btn-sm" id="txnExportBtn">
                                                            <i class="bi bi-download me-1"></i>Export
                                                        </button>
                                                    </div>
                                                </div>

                                                <!-- Preview Table (hidden by default) -->
                                                <div id="txnPreviewContainer" class="mt-3" style="display: none;">
                                                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                                        <table class="table table-sm table-hover mb-0">
                                                            <thead class="table-light sticky-top">
                                                                <tr>
                                                                    <th>Date</th>
                                                                    <th>Client</th>
                                                                    <th>Estate</th>
                                                                    <th>Plot Size</th>
                                                                    <th>Marketer</th>
                                                                    <th>Total Amount</th>
                                                                    <th>Paid</th>
                                                                    <th>Balance</th>
                                                                    <th>Status</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="txnPreviewTableBody">
                                                                <tr>
                                                                    <td colspan="9" class="text-center text-muted py-3">Click Preview to load data...</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <div class="text-muted small mt-2">
                                                        <i class="bi bi-info-circle me-1"></i>Showing first 50 records. Export to see all records.
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==================== HISTORICAL RECORDS ==================== -->
            <div class="tab-pane fade" id="historical" role="tabpanel" aria-labelledby="historical-tab">
                <!-- Historical Records Header -->
                <div class="historical-header mb-4 p-4 rounded-4" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h3 class="text-white mb-2 fw-bold">
                                <i class="bi bi-archive me-2"></i>Historical Records & Data Export
                            </h3>
                            <p class="text-white-50 mb-0">Access, filter, and download your company's complete historical performance data</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group">
                                <button class="btn btn-light btn-sm" id="bulkExportBtn">
                                    <i class="bi bi-file-earmark-arrow-down me-1"></i>Bulk Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Filters -->
                <div class="card border-0 shadow-sm mb-4 historical-filter-card">
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-2">
                                <label class="form-label fw-semibold text-muted small">FROM YEAR</label>
                                <select class="form-select" id="historyFromYear">
                                    <!-- Populated by JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-semibold text-muted small">TO YEAR</label>
                                <select class="form-select" id="historyToYear">
                                    <!-- Populated by JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-semibold text-muted small">PERIOD TYPE</label>
                                <select class="form-select" id="historyPeriodType">
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="annual">Annual</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-semibold text-muted small">MARKETER</label>
                                <select class="form-select" id="historyMarketer">
                                    <option value="all">All Marketers</option>
                                    <!-- Populated by JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-semibold text-muted small">STATUS</label>
                                <select class="form-select" id="historyStatus">
                                    <option value="all">All Records</option>
                                    <option value="above_target">Above Target</option>
                                    <option value="on_track">On Track</option>
                                    <option value="below_target">Below Target</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn w-100" id="historyApplyBtn" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
                                    <i class="bi bi-search me-1"></i>Search
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="historical-summary-card" style="--accent: #667eea;">
                            <div class="summary-icon"><i class="bi bi-folder2-open"></i></div>
                            <div class="summary-content">
                                <span class="summary-label">Total Records</span>
                                <h3 class="summary-value" id="totalRecordsCount">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="historical-summary-card" style="--accent: #28a745;">
                            <div class="summary-icon"><i class="bi bi-calendar-range"></i></div>
                            <div class="summary-content">
                                <span class="summary-label">Date Range</span>
                                <h3 class="summary-value" id="dateRangeDisplay">--</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="historical-summary-card" style="--accent: #ffc107;">
                            <div class="summary-icon"><i class="bi bi-cash-stack"></i></div>
                            <div class="summary-content">
                                <span class="summary-label">Period Revenue</span>
                                <h3 class="summary-value" id="periodRevenueDisplay">₦0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="historical-summary-card" style="--accent: #dc3545;">
                            <div class="summary-icon"><i class="bi bi-percent"></i></div>
                            <div class="summary-content">
                                <span class="summary-label">Avg Commission</span>
                                <h3 class="summary-value" id="avgCommissionDisplay">0%</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Year-over-Year Comparison Toggle -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold">
                            <i class="bi bi-bar-chart-steps text-primary me-2"></i>Year-over-Year Comparison
                        </h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="yoyComparisonToggle" checked>
                            <label class="form-check-label" for="yoyComparisonToggle">Show Comparison</label>
                        </div>
                    </div>
                    <div class="card-body" id="yoyComparisonContainer">
                        <div class="chart-container" style="position: relative; height: 250px; width: 100%;">
                            <canvas id="yoyComparisonChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Historical Records Table -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 fw-bold">
                            <i class="bi bi-table text-success me-2"></i>Performance Records
                        </h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" id="exportCsvBtn">
                                <i class="bi bi-filetype-csv me-1"></i>CSV
                            </button>
                            <button class="btn btn-sm btn-outline-success" id="exportExcelBtn">
                                <i class="bi bi-file-earmark-excel me-1"></i>Excel
                            </button>
                            <button class="btn btn-sm btn-outline-danger" id="exportPdfBtn">
                                <i class="bi bi-filetype-pdf me-1"></i>PDF
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0" id="historicalRecordsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th class="sortable" data-sort="period">Period <i class="bi bi-arrow-down-up ms-1"></i></th>
                                        <th class="sortable" data-sort="marketer">Marketer <i class="bi bi-arrow-down-up ms-1"></i></th>
                                        <th class="sortable" data-sort="deals">Closed Deals <i class="bi bi-arrow-down-up ms-1"></i></th>
                                        <th class="sortable" data-sort="sales">Total Sales <i class="bi bi-arrow-down-up ms-1"></i></th>
                                        <th class="sortable" data-sort="commission_rate">Commission % <i class="bi bi-arrow-down-up ms-1"></i></th>
                                        <th class="sortable" data-sort="commission">Commission Earned <i class="bi bi-arrow-down-up ms-1"></i></th>
                                        <th>Target Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="historicalRecordsBody">
                                    <tr>
                                        <td colspan="8" class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status"></div>
                                            <p class="mt-2 text-muted mb-0">Loading historical records...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Pagination -->
                    <div class="card-footer bg-white border-0 d-flex justify-content-between align-items-center">
                        <span class="text-muted" id="recordsPagination">Showing 0-0 of 0 records</span>
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="paginationControls">
                                <!-- Populated by JavaScript -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- Subscription & Billing - Advanced ChatGPT Style with Monthly/Annual Toggle -->
            <div class="tab-pane fade" id="billing" role="tabpanel" aria-labelledby="billing-tab">
                <div class="billing-container">
                    
                    <!-- My Plan Section -->
                    <div class="billing-section">
                        <h2 class="billing-section-title">My plan</h2>
                        
                        {% if subscription %}
                        <div class="plan-card-main">
                            <div class="plan-header">
                                <div class="plan-badge-row">
                                    <span class="plan-badge plan-badge-{{ subscription.tier|default:'starter' }}">
                                        <i class="bi {% if subscription.tier == 'enterprise' %}bi-rocket-takeoff{% elif subscription.tier == 'professional' %}bi-star-fill{% else %}bi-lightning-charge{% endif %}"></i>
                                        {{ subscription.plan_name }}
                                    </span>
                                    {% if subscription.is_trial %}
                                    <span class="plan-badge plan-badge-trial">Free Trial</span>
                                    {% endif %}
                                    {% if subscription.billing_period == 'annual' %}
                                    <span class="plan-badge plan-badge-annual">Annual (Save 2 months)</span>
                                    {% endif %}
                                </div>
                                <div class="plan-price-display">
                                    <span class="price-amount">₦{{ subscription.amount|floatformat:0|intcomma }}</span>
                                    <span class="price-period">/{% if subscription.billing_period == 'annual' %}year{% else %}month{% endif %}</span>
                                </div>
                            </div>
                            
                            <div class="plan-features-grid">
                                <div class="feature-box">
                                    <div class="feature-icon"><i class="bi bi-building"></i></div>
                                    <div class="feature-info">
                                        <span class="feature-value">
                                            <span class="feature-current">{{ total_estates }}</span>/<span class="feature-max">{% if subscription.max_estates >= 999999 %}∞{% else %}{{ subscription.max_estates|default:"2" }}{% endif %}</span>
                                        </span>
                                        <span class="feature-label">Estates</span>
                                        <div class="feature-progress">
                                            <div class="feature-progress-bar" style="width: {% widthratio total_estates subscription.max_estates 100 %}%;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="feature-box">
                                    <div class="feature-icon"><i class="bi bi-check2-square"></i></div>
                                    <div class="feature-info">
                                        <span class="feature-value">
                                            <span class="feature-current">{{ total_allocations }}</span>/<span class="feature-max">{% if subscription.max_allocations >= 999999 %}∞{% else %}{{ subscription.max_allocations|default:"30" }}{% endif %}</span>
                                        </span>
                                        <span class="feature-label">Allocations</span>
                                        <div class="feature-progress">
                                            <div class="feature-progress-bar" style="width: {% widthratio total_allocations subscription.max_allocations 100 %}%;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="feature-box">
                                    <div class="feature-icon"><i class="bi bi-people"></i></div>
                                    <div class="feature-info">
                                        <span class="feature-value">
                                            <span class="feature-current">{{ total_clients }}</span>/<span class="feature-max">{% if subscription.max_clients >= 999999 %}∞{% else %}{{ subscription.max_clients|default:"30" }}{% endif %}</span>
                                        </span>
                                        <span class="feature-label">Clients</span>
                                        <div class="feature-progress">
                                            <div class="feature-progress-bar" style="width: {% widthratio total_clients subscription.max_clients 100 %}%;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="feature-box">
                                    <div class="feature-icon"><i class="bi bi-person-lines-fill"></i></div>
                                    <div class="feature-info">
                                        <span class="feature-value">
                                            <span class="feature-current">{{ total_marketers }}</span>/<span class="feature-max">{% if subscription.max_affiliates >= 999999 %}∞{% else %}{{ subscription.max_affiliates|default:"20" }}{% endif %}</span>
                                        </span>
                                        <span class="feature-label">Affiliates</span>
                                        <div class="feature-progress">
                                            <div class="feature-progress-bar" style="width: {% widthratio total_marketers subscription.max_affiliates 100 %}%;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="plan-renewal">
                                {% if subscription.is_trial %}
                                <i class="bi bi-clock text-warning"></i>
                                Your free trial ends on <strong>{{ subscription.subscription_ends_at|date:'F d, Y' }}</strong>
                                {% else %}
                                <i class="bi bi-arrow-repeat text-success"></i>
                                Your plan renews on <strong>{{ subscription.subscription_ends_at|date:'F d, Y' }}</strong>
                                {% endif %}
                            </div>
                            
                            <div class="plan-actions">
                                <button class="btn-action btn-action-primary" data-bs-toggle="modal" data-bs-target="#manageSubscriptionModal">
                                    <i class="bi bi-gear me-2"></i>Manage my subscription
                                </button>
                                {% if subscription.tier != 'enterprise' %}
                                <button class="btn-action btn-action-outline" data-bs-toggle="modal" data-bs-target="#upgradePlanModal">
                                    <i class="bi bi-arrow-up-circle me-2"></i>Upgrade plan
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% else %}
                        <!-- No Plan State -->
                        <div class="no-plan-card">
                            <div class="no-plan-icon">
                                <i class="bi bi-gift"></i>
                            </div>
                            <div class="no-plan-info">
                                <h4>Free Plan</h4>
                                <p>You're currently on the free plan with limited features. Upgrade to unlock more capabilities.</p>
                            </div>
                            <button class="btn-action btn-action-primary" data-bs-toggle="modal" data-bs-target="#selectPlanModal">
                                <i class="bi bi-rocket-takeoff me-2"></i>Choose a plan
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Available Plans with Monthly/Annual Toggle -->
                    <div class="billing-section">
                        <div class="plans-header">
                            <h2 class="billing-section-title">Available plans</h2>
                            
                            <!-- Billing Period Toggle -->
                            <div class="billing-toggle">
                                <span class="toggle-label" id="monthlyLabel">Monthly</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="billingToggle" onchange="toggleBillingPeriod()">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="toggle-label" id="annualLabel">
                                    Annual <span class="save-badge">Save 2 months</span>
                                </span>
                            </div>
                        </div>
                        
                        <div class="plans-grid" id="availablePlansGrid">
                            <!-- Plans loaded dynamically -->
                            <div class="loading-plans">
                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                <span>Loading plans...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Billing History Section -->
                    <div class="billing-section">
                        <h2 class="billing-section-title">Billing history</h2>
                        
                        {% if billing_history %}
                        <div class="billing-table">
                            <div class="billing-table-header">
                                <span>Date</span>
                                <span>Description</span>
                                <span>Amount</span>
                                <span>Receipt</span>
                            </div>
                            {% for transaction in billing_history %}
                            <div class="billing-row">
                                <span class="billing-date">{{ transaction.created_at|date:'M d, Y' }}</span>
                                <span class="billing-desc">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    {{ transaction.description|default:'Subscription payment' }}
                                </span>
                                <span class="billing-amount">₦{{ transaction.amount|floatformat:0|intcomma }}</span>
                                <a href="{% url 'subscription-receipt' transaction.id %}" class="btn-download" title="Download Receipt">
                                    <i class="bi bi-download"></i>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <i class="bi bi-receipt-cutoff"></i>
                            <span>No billing history available</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Cancel Subscription -->
                    {% if subscription and not subscription.is_trial %}
                    <div class="billing-section billing-section-cancel">
                        <a href="#" class="cancel-link" onclick="confirmCancelSubscription(); return false;">
                            <i class="bi bi-x-circle me-2"></i>Cancel subscription
                        </a>
                    </div>
                    {% endif %}
                    
                </div>
                
                <!-- Advanced Billing Styles -->
                <style>
                    .billing-container {
                        max-width: 900px;
                        padding: 0;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
                    }
                    
                    .billing-section {
                        padding: 28px 0;
                        border-bottom: 1px solid #e5e7eb;
                    }
                    
                    .billing-section:last-child {
                        border-bottom: none;
                    }
                    
                    .billing-section-title {
                        font-size: 18px;
                        font-weight: 600;
                        color: #111827;
                        margin: 0 0 20px 0;
                    }
                    
                    /* Main Plan Card */
                    .plan-card-main {
                        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                        border: 1px solid #e2e8f0;
                        border-radius: 16px;
                        padding: 24px;
                    }
                    
                    .plan-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        flex-wrap: wrap;
                        gap: 16px;
                        margin-bottom: 20px;
                    }
                    
                    .plan-badge-row {
                        display: flex;
                        gap: 10px;
                        flex-wrap: wrap;
                    }
                    
                    .plan-badge {
                        display: inline-flex;
                        align-items: center;
                        gap: 6px;
                        padding: 6px 14px;
                        border-radius: 20px;
                        font-size: 13px;
                        font-weight: 600;
                    }
                    
                    .plan-badge-starter {
                        background: linear-gradient(135deg, #fef3c7, #fde68a);
                        color: #92400e;
                    }
                    
                    .plan-badge-professional {
                        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
                        color: #1d4ed8;
                    }
                    
                    .plan-badge-enterprise {
                        background: linear-gradient(135deg, #fee2e2, #fecaca);
                        color: #dc2626;
                    }
                    
                    .plan-badge-trial {
                        background: #e0e7ff;
                        color: #4338ca;
                    }
                    
                    .plan-badge-annual {
                        background: #dcfce7;
                        color: #16a34a;
                    }
                    
                    .plan-price-display {
                        text-align: right;
                    }
                    
                    .price-amount {
                        font-size: 28px;
                        font-weight: 700;
                        color: #111827;
                    }
                    
                    .price-period {
                        font-size: 14px;
                        color: #6b7280;
                    }
                    
                    /* Features Grid */
                    .plan-features-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                        gap: 12px;
                        margin-bottom: 20px;
                    }
                    
                    .feature-box {
                        display: flex;
                        align-items: flex-start;
                        gap: 12px;
                        background: white;
                        padding: 14px 16px;
                        border-radius: 12px;
                        border: 1px solid #e5e7eb;
                    }
                    
                    .feature-icon {
                        width: 40px;
                        height: 40px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        background: #10a37f15;
                        color: #10a37f;
                        border-radius: 10px;
                        font-size: 18px;
                        flex-shrink: 0;
                    }
                    
                    .feature-info {
                        display: flex;
                        flex-direction: column;
                        flex: 1;
                        min-width: 0;
                    }
                    
                    .feature-value {
                        font-size: 16px;
                        font-weight: 700;
                        color: #111827;
                        display: flex;
                        align-items: baseline;
                        gap: 2px;
                    }
                    
                    .feature-current {
                        color: #10a37f;
                    }
                    
                    .feature-max {
                        color: #6b7280;
                        font-weight: 500;
                    }
                    
                    .feature-label {
                        font-size: 12px;
                        color: #6b7280;
                        margin-bottom: 6px;
                    }
                    
                    .feature-progress {
                        width: 100%;
                        height: 4px;
                        background: #e5e7eb;
                        border-radius: 2px;
                        overflow: hidden;
                    }
                    
                    .feature-progress-bar {
                        height: 100%;
                        background: linear-gradient(90deg, #10a37f, #34d399);
                        border-radius: 2px;
                        min-width: 2px;
                        max-width: 100%;
                        transition: width 0.3s ease;
                    }
                    
                    .plan-renewal {
                        padding: 12px 16px;
                        background: white;
                        border-radius: 8px;
                        border: 1px solid #e5e7eb;
                        font-size: 14px;
                        color: #4b5563;
                        margin-bottom: 20px;
                    }
                    
                    .plan-renewal i {
                        margin-right: 8px;
                    }
                    
                    .plan-actions {
                        display: flex;
                        gap: 12px;
                        flex-wrap: wrap;
                    }
                    
                    /* Action Buttons */
                    .btn-action {
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        padding: 12px 24px;
                        font-size: 14px;
                        font-weight: 600;
                        border-radius: 10px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        border: none;
                    }
                    
                    .btn-action-primary {
                        background: #10a37f;
                        color: white;
                    }
                    
                    .btn-action-primary:hover {
                        background: #0d8a6b;
                        transform: translateY(-1px);
                        box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);
                    }
                    
                    .btn-action-outline {
                        background: white;
                        color: #10a37f;
                        border: 2px solid #10a37f;
                    }
                    
                    .btn-action-outline:hover {
                        background: #10a37f10;
                    }
                    
                    /* No Plan Card */
                    .no-plan-card {
                        display: flex;
                        align-items: center;
                        gap: 20px;
                        padding: 24px;
                        background: #f8fafc;
                        border: 2px dashed #d1d5db;
                        border-radius: 16px;
                    }
                    
                    .no-plan-icon {
                        width: 60px;
                        height: 60px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        background: #e0e7ff;
                        color: #4f46e5;
                        border-radius: 50%;
                        font-size: 28px;
                    }
                    
                    .no-plan-info {
                        flex: 1;
                    }
                    
                    .no-plan-info h4 {
                        margin: 0 0 4px 0;
                        font-size: 18px;
                        color: #111827;
                    }
                    
                    .no-plan-info p {
                        margin: 0;
                        font-size: 14px;
                        color: #6b7280;
                    }
                    
                    /* Plans Header with Toggle */
                    .plans-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-wrap: wrap;
                        gap: 16px;
                        margin-bottom: 20px;
                    }
                    
                    .plans-header .billing-section-title {
                        margin-bottom: 0;
                    }
                    
                    /* Billing Toggle */
                    .billing-toggle {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        background: #f3f4f6;
                        padding: 8px 16px;
                        border-radius: 30px;
                    }
                    
                    .toggle-label {
                        font-size: 14px;
                        color: #6b7280;
                        font-weight: 500;
                        transition: color 0.2s;
                    }
                    
                    .toggle-label.active {
                        color: #111827;
                        font-weight: 600;
                    }
                    
                    .save-badge {
                        display: inline-block;
                        padding: 2px 8px;
                        background: #10a37f;
                        color: white;
                        font-size: 11px;
                        font-weight: 600;
                        border-radius: 10px;
                        margin-left: 4px;
                    }
                    
                    .toggle-switch {
                        position: relative;
                        width: 48px;
                        height: 26px;
                    }
                    
                    .toggle-switch input {
                        opacity: 0;
                        width: 0;
                        height: 0;
                    }
                    
                    .toggle-slider {
                        position: absolute;
                        cursor: pointer;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: #d1d5db;
                        border-radius: 26px;
                        transition: 0.3s;
                    }
                    
                    .toggle-slider:before {
                        content: "";
                        position: absolute;
                        height: 20px;
                        width: 20px;
                        left: 3px;
                        bottom: 3px;
                        background: white;
                        border-radius: 50%;
                        transition: 0.3s;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    }
                    
                    .toggle-switch input:checked + .toggle-slider {
                        background: #10a37f;
                    }
                    
                    .toggle-switch input:checked + .toggle-slider:before {
                        transform: translateX(22px);
                    }
                    
                    /* Plans Grid */
                    .plans-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                        gap: 20px;
                    }
                    
                    .loading-plans {
                        grid-column: 1 / -1;
                        text-align: center;
                        padding: 40px;
                        color: #6b7280;
                    }
                    
                    .loading-plans .spinner-border {
                        margin-right: 10px;
                    }
                    
                    /* Plan Card */
                    .plan-card {
                        position: relative;
                        background: white;
                        border: 2px solid #e5e7eb;
                        border-radius: 16px;
                        padding: 24px;
                        transition: all 0.3s ease;
                    }
                    
                    .plan-card:hover {
                        border-color: #10a37f;
                        box-shadow: 0 8px 25px rgba(16, 163, 127, 0.15);
                        transform: translateY(-4px);
                    }
                    
                    .plan-card.current-plan {
                        border-color: #10a37f;
                        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
                    }
                    
                    .plan-card.popular {
                        border-color: #3b82f6;
                    }
                    
                    .plan-card.preferred {
                        border-color: #ef4444;
                    }
                    
                    .plan-ribbon {
                        position: absolute;
                        top: -1px;
                        right: 20px;
                        padding: 6px 14px;
                        font-size: 11px;
                        font-weight: 700;
                        text-transform: uppercase;
                        border-radius: 0 0 8px 8px;
                    }
                    
                    .plan-ribbon.popular {
                        background: #3b82f6;
                        color: white;
                    }
                    
                    .plan-ribbon.preferred {
                        background: #ef4444;
                        color: white;
                    }
                    
                    .plan-ribbon.current {
                        background: #10a37f;
                        color: white;
                    }
                    
                    .plan-card-icon {
                        width: 56px;
                        height: 56px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 14px;
                        font-size: 26px;
                        margin-bottom: 16px;
                    }
                    
                    .plan-card-icon.starter {
                        background: linear-gradient(135deg, #fef3c7, #fde68a);
                        color: #d97706;
                    }
                    
                    .plan-card-icon.professional {
                        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
                        color: #2563eb;
                    }
                    
                    .plan-card-icon.enterprise {
                        background: linear-gradient(135deg, #fee2e2, #fecaca);
                        color: #dc2626;
                    }
                    
                    .plan-card-name {
                        font-size: 20px;
                        font-weight: 700;
                        color: #111827;
                        margin-bottom: 4px;
                    }
                    
                    .plan-card-desc {
                        font-size: 13px;
                        color: #6b7280;
                        margin-bottom: 16px;
                    }
                    
                    .plan-card-price {
                        margin-bottom: 20px;
                    }
                    
                    .plan-card-price .price-main {
                        font-size: 32px;
                        font-weight: 800;
                        color: #111827;
                    }
                    
                    .plan-card-price .price-period {
                        font-size: 14px;
                        color: #6b7280;
                    }
                    
                    .plan-card-price .price-annual {
                        display: block;
                        font-size: 13px;
                        color: #10a37f;
                        margin-top: 4px;
                    }
                    
                    .plan-card-features {
                        list-style: none;
                        padding: 0;
                        margin: 0 0 20px 0;
                    }
                    
                    .plan-card-features li {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        padding: 10px 0;
                        border-bottom: 1px solid #f3f4f6;
                        font-size: 14px;
                        color: #374151;
                    }
                    
                    .plan-card-features li:last-child {
                        border-bottom: none;
                    }
                    
                    .plan-card-features li i {
                        width: 20px;
                        text-align: center;
                    }
                    
                    .plan-card-features li i.bi-check-circle-fill {
                        color: #10a37f;
                    }
                    
                    .plan-card-features li i.bi-x-circle {
                        color: #d1d5db;
                    }
                    
                    .plan-card-features li strong {
                        color: #111827;
                    }
                    
                    .plan-card-btn {
                        width: 100%;
                        padding: 14px;
                        font-size: 14px;
                        font-weight: 600;
                        border-radius: 10px;
                        border: none;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    
                    .plan-card-btn.primary {
                        background: #10a37f;
                        color: white;
                    }
                    
                    .plan-card-btn.primary:hover {
                        background: #0d8a6b;
                    }
                    
                    .plan-card-btn.outline {
                        background: white;
                        color: #10a37f;
                        border: 2px solid #10a37f;
                    }
                    
                    .plan-card-btn.outline:hover {
                        background: #10a37f10;
                    }
                    
                    .plan-card-btn.current {
                        background: #e5e7eb;
                        color: #6b7280;
                        cursor: default;
                    }
                    
                    .plan-card-btn.downgrade {
                        background: #fef3c7;
                        color: #b45309;
                        border: 2px solid #f59e0b;
                    }
                    
                    /* Billing Table */
                    .billing-table {
                        border: 1px solid #e5e7eb;
                        border-radius: 12px;
                        overflow: hidden;
                    }
                    
                    .billing-table-header {
                        display: grid;
                        grid-template-columns: 120px 1fr 120px 60px;
                        gap: 16px;
                        padding: 14px 20px;
                        background: #f9fafb;
                        font-size: 12px;
                        font-weight: 600;
                        text-transform: uppercase;
                        color: #6b7280;
                        border-bottom: 1px solid #e5e7eb;
                    }
                    
                    .billing-row {
                        display: grid;
                        grid-template-columns: 120px 1fr 120px 60px;
                        gap: 16px;
                        align-items: center;
                        padding: 16px 20px;
                        border-bottom: 1px solid #f3f4f6;
                        transition: background 0.15s;
                    }
                    
                    .billing-row:last-child {
                        border-bottom: none;
                    }
                    
                    .billing-row:hover {
                        background: #f9fafb;
                    }
                    
                    .billing-date {
                        font-size: 14px;
                        color: #6b7280;
                    }
                    
                    .billing-desc {
                        font-size: 14px;
                        color: #111827;
                    }
                    
                    .billing-amount {
                        font-size: 14px;
                        font-weight: 600;
                        color: #111827;
                        text-align: right;
                    }
                    
                    .btn-download {
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 36px;
                        height: 36px;
                        background: #f3f4f6;
                        color: #6b7280;
                        border-radius: 8px;
                        transition: all 0.15s;
                    }
                    
                    .btn-download:hover {
                        background: #10a37f;
                        color: white;
                    }
                    
                    /* Empty State */
                    .empty-state {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 12px;
                        padding: 48px;
                        background: #f9fafb;
                        border-radius: 12px;
                        text-align: center;
                    }
                    
                    .empty-state i {
                        font-size: 40px;
                        color: #d1d5db;
                    }
                    
                    .empty-state span {
                        font-size: 14px;
                        color: #6b7280;
                    }
                    
                    /* Cancel Section */
                    .billing-section-cancel {
                        padding: 20px 0;
                        border-bottom: none;
                    }
                    
                    .cancel-link {
                        display: inline-flex;
                        align-items: center;
                        font-size: 14px;
                        color: #6b7280;
                        text-decoration: none;
                        transition: color 0.15s;
                    }
                    
                    .cancel-link:hover {
                        color: #ef4444;
                    }
                    
                    /* Responsive */
                    @media (max-width: 768px) {
                        .plan-header {
                            flex-direction: column;
                        }
                        
                        .plan-price-display {
                            text-align: left;
                        }
                        
                        .plan-features-grid {
                            grid-template-columns: repeat(2, 1fr);
                        }
                        
                        .plans-header {
                            flex-direction: column;
                            align-items: flex-start;
                        }
                        
                        .billing-toggle {
                            width: 100%;
                            justify-content: center;
                        }
                        
                        .plans-grid {
                            grid-template-columns: 1fr;
                        }
                        
                        .billing-table-header {
                            display: none;
                        }
                        
                        .billing-row {
                            grid-template-columns: 1fr auto;
                            gap: 8px;
                        }
                        
                        .billing-date {
                            grid-column: 1 / -1;
                            font-size: 12px;
                        }
                        
                        .no-plan-card {
                            flex-direction: column;
                            text-align: center;
                        }
                    }
                </style>
            </div>

            {% include 'admin_side/company_user_registration.html' %}
        </div>

        <div class="text-end mt-3">
            <a href="{% url 'admin-dashboard' %}" class="btn btn-outline-secondary">Back to Dashboard</a>
        </div>
    </div>

    <!-- ===== SUBSCRIPTION & BILLING MODALS ===== -->

    <!-- Manage Subscription Modal - Advanced ChatGPT Style -->
    <div class="modal fade" id="manageSubscriptionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content" style="border-radius: 16px; overflow: hidden;">
                <div class="modal-header" style="border-bottom: 1px solid #e5e7eb; padding: 20px 24px;">
                    <h5 class="modal-title" style="font-size: 18px; font-weight: 600; color: #111827;">
                        <i class="bi bi-gear me-2 text-primary"></i>Manage Subscription
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- Current Plan Summary -->
                    <div class="p-4" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-bottom: 1px solid #e5e7eb;">
                        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                            <div>
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <span class="badge rounded-pill" id="manageCurrentPlanBadge" style="background: #10a37f; padding: 6px 14px; font-size: 12px;">
                                        Current Plan
                                    </span>
                                    <span class="badge rounded-pill" id="manageBillingPeriodBadge" style="background: #e0e7ff; color: #4338ca; padding: 6px 14px; font-size: 12px;">
                                        Monthly
                                    </span>
                                </div>
                                <h4 id="manageCurrentPlanName" style="font-size: 24px; font-weight: 700; margin: 0; color: #111827;">Loading...</h4>
                                <p id="manageCurrentPlanDesc" style="font-size: 14px; color: #6b7280; margin: 4px 0 0 0;">Loading plan details...</p>
                            </div>
                            <div class="text-end">
                                <div style="font-size: 28px; font-weight: 700; color: #111827;">
                                    ₦<span id="manageCurrentPrice">0</span>
                                </div>
                                <div style="font-size: 13px; color: #6b7280;" id="manageCurrentPeriod">/month</div>
                            </div>
                        </div>
                        
                        <!-- Current Plan Features -->
                        <div class="row g-2 mt-3" id="manageCurrentFeatures">
                            <div class="col-6 col-md-3">
                                <div class="p-3 bg-white rounded-3 text-center" style="border: 1px solid #e5e7eb;">
                                    <div style="font-size: 20px; font-weight: 700; color: #10a37f;" id="manageEstates">-</div>
                                    <div style="font-size: 11px; color: #6b7280;">Estates</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="p-3 bg-white rounded-3 text-center" style="border: 1px solid #e5e7eb;">
                                    <div style="font-size: 20px; font-weight: 700; color: #3b82f6;" id="manageAllocations">-</div>
                                    <div style="font-size: 11px; color: #6b7280;">Allocations</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="p-3 bg-white rounded-3 text-center" style="border: 1px solid #e5e7eb;">
                                    <div style="font-size: 20px; font-weight: 700; color: #8b5cf6;" id="manageClients">-</div>
                                    <div style="font-size: 11px; color: #6b7280;">Clients</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="p-3 bg-white rounded-3 text-center" style="border: 1px solid #e5e7eb;">
                                    <div style="font-size: 20px; font-weight: 700; color: #f59e0b;" id="manageAffiliates">-</div>
                                    <div style="font-size: 11px; color: #6b7280;">Affiliates</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Billing Period Selection -->
                    <div class="p-4" style="border-bottom: 1px solid #e5e7eb;">
                        <h6 style="font-size: 14px; font-weight: 600; color: #111827; margin-bottom: 12px;">
                            <i class="bi bi-calendar3 me-2"></i>Billing Period
                        </h6>
                        <div class="d-flex gap-3 flex-wrap">
                            <label class="billing-period-option" id="monthlyOption">
                                <input type="radio" name="manageBillingPeriod" value="monthly" checked>
                                <div class="option-content">
                                    <div class="option-title">Monthly</div>
                                    <div class="option-desc">Pay month to month</div>
                                </div>
                            </label>
                            <label class="billing-period-option" id="annualOption">
                                <input type="radio" name="manageBillingPeriod" value="annual">
                                <div class="option-content">
                                    <div class="option-title">Annual <span class="save-tag">Save 2 months</span></div>
                                    <div class="option-desc">Pay yearly, get 2 months free</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Available Plans -->
                    <div class="p-4">
                        <h6 style="font-size: 14px; font-weight: 600; color: #111827; margin-bottom: 16px;">
                            <i class="bi bi-grid-3x3-gap me-2"></i>Available Plans
                        </h6>
                        <div class="row g-3" id="managePlansContainer">
                            <!-- Plans loaded dynamically -->
                            <div class="col-12 text-center py-4">
                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                <span class="ms-2 text-muted">Loading plans...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #e5e7eb; padding: 16px 24px;">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal" style="padding: 10px 20px;">Cancel</button>
                    <button type="button" class="btn" id="manageActionBtn" style="background: #10a37f; color: white; padding: 10px 24px;" onclick="processSubscriptionChange()">
                        <i class="bi bi-check-circle me-2"></i>Confirm Changes
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        /* Manage Subscription Modal Styles */
        .billing-period-option {
            flex: 1;
            min-width: 200px;
            cursor: pointer;
        }
        
        .billing-period-option input {
            display: none;
        }
        
        .billing-period-option .option-content {
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            transition: all 0.2s;
        }
        
        .billing-period-option input:checked + .option-content {
            border-color: #10a37f;
            background: #f0fdf4;
        }
        
        .billing-period-option .option-title {
            font-size: 15px;
            font-weight: 600;
            color: #111827;
        }
        
        .billing-period-option .option-desc {
            font-size: 13px;
            color: #6b7280;
            margin-top: 2px;
        }
        
        .billing-period-option .save-tag {
            display: inline-block;
            padding: 2px 8px;
            background: #10a37f;
            color: white;
            font-size: 11px;
            font-weight: 600;
            border-radius: 10px;
            margin-left: 6px;
        }
        
        /* Mini Plan Cards in Manage Modal */
        .manage-plan-card {
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            transition: all 0.2s;
            cursor: pointer;
            height: 100%;
        }
        
        .manage-plan-card:hover {
            border-color: #10a37f;
            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.15);
        }
        
        .manage-plan-card.selected {
            border-color: #10a37f;
            background: #f0fdf4;
        }
        
        .manage-plan-card.current {
            border-color: #10a37f;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        }
        
        .manage-plan-card .plan-icon {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-size: 20px;
            margin-bottom: 12px;
        }
        
        .manage-plan-card .plan-icon.starter {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #d97706;
        }
        
        .manage-plan-card .plan-icon.professional {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #2563eb;
        }
        
        .manage-plan-card .plan-icon.enterprise {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #dc2626;
        }
        
        .manage-plan-card h5 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
            color: #111827;
        }
        
        .manage-plan-card .plan-price {
            font-size: 22px;
            font-weight: 700;
            color: #111827;
        }
        
        .manage-plan-card .plan-period {
            font-size: 12px;
            color: #6b7280;
        }
        
        .manage-plan-card .plan-annual-price {
            font-size: 12px;
            color: #10a37f;
            margin-top: 4px;
        }
        
        .manage-plan-card ul {
            list-style: none;
            padding: 0;
            margin: 12px 0 0 0;
            font-size: 13px;
        }
        
        .manage-plan-card ul li {
            padding: 6px 0;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .manage-plan-card ul li i {
            color: #10a37f;
        }
        
        .manage-plan-card .current-badge {
            display: inline-block;
            padding: 3px 10px;
            background: #10a37f;
            color: white;
            font-size: 11px;
            font-weight: 600;
            border-radius: 10px;
            margin-bottom: 8px;
        }
        
        .manage-plan-card .popular-badge {
            display: inline-block;
            padding: 3px 10px;
            background: #3b82f6;
            color: white;
            font-size: 11px;
            font-weight: 600;
            border-radius: 10px;
            margin-bottom: 8px;
        }
        
        .manage-plan-card .preferred-badge {
            display: inline-block;
            padding: 3px 10px;
            background: #ef4444;
            color: white;
            font-size: 11px;
            font-weight: 600;
            border-radius: 10px;
            margin-bottom: 8px;
        }
    </style>

    <!-- Select Plan Modal -->
    <div class="modal fade" id="selectPlanModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-star me-2"></i>Choose Your Plan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3" id="plansContainer">
                        <!-- Plans will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upgrade Plan Modal -->
    <div class="modal fade" id="upgradePlanModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-arrow-up-right me-2"></i>Upgrade Your Plan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>Current Plan:</strong> <span id="currentPlanName">Loading...</span>
                    </div>
                    <div class="row g-3" id="upgradePlansContainer">
                        <!-- Upgrade plans will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Downgrade Plan Modal (for Enterprise users) -->
    <div class="modal fade" id="downgradePlanModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning bg-opacity-10">
                    <h5 class="modal-title"><i class="bi bi-arrow-down-left me-2 text-warning"></i>Downgrade Your Plan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning mb-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Current Plan:</strong> Enterprise (Unlimited)
                    </div>
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Important:</strong> Downgrading will limit your usage. Please ensure your current usage is within the limits of your chosen plan.
                    </div>
                    <div class="row g-3" id="downgradePlansContainer">
                        <!-- Downgrade plans will be loaded here -->
                    </div>
                    <div id="downgradeWarning" class="alert alert-danger mt-3 d-none">
                        <i class="bi bi-exclamation-octagon me-2"></i>
                        <strong>Warning:</strong> <span id="downgradeWarningText">Your current usage exceeds the limits of this plan.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Renew Subscription Modal -->
    <div class="modal fade" id="renewSubscriptionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-arrow-clockwise me-2"></i>Renew Your Subscription</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="renewSubscriptionForm">
                    <div class="modal-body">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label">Current Plan</label>
                            <div class="p-3 bg-light border rounded">
                                <strong id="renewPlanName">Loading...</strong>
                                <div class="text-muted small">Monthly subscription</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Renewal Amount</label>
                            <div class="p-3 bg-light border rounded">
                                <h5 class="mb-0">₦<span id="renewAmount">0</span></h5>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment Method</label>
                            <select name="payment_method" class="form-select" required>
                                <option value="">Select payment method...</option>
                                <option value="stripe">Credit Card (Stripe)</option>
                                <option value="paystack">Paystack (Bank Transfer, Card, Mobile Money)</option>
                            </select>
                        </div>
                        <div class="alert d-none" id="renewFeedback"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-credit-card me-1"></i> Proceed to Payment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-credit-card me-2"></i>Complete Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="paymentForm">
                    <div class="modal-body">
                        {% csrf_token %}
                        <div class="mb-3 p-3 bg-light border rounded">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Plan:</span>
                                <strong id="paymentPlan">—</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Amount:</span>
                                <strong id="paymentAmount">₦0</strong>
                            </div>
                            <div class="d-flex justify-content-between border-top pt-2">
                                <span>Total:</span>
                                <h6 class="mb-0" id="paymentTotal">₦0</h6>
                            </div>
                        </div>
                        <div id="stripePaymentContainer" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Card Details</label>
                                <div id="cardElement" class="form-control p-3" style="height: 40px; padding-top: 10px !important;"></div>
                                <div id="cardErrors" class="text-danger small mt-2"></div>
                            </div>
                        </div>
                        <div id="paystackPaymentContainer" style="display: none;">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                You will be redirected to Paystack to complete your payment securely.
                            </div>
                        </div>
                        <div class="alert d-none" id="paymentFeedback"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success" id="paymentSubmitBtn">
                            <i class="bi bi-check-circle me-1"></i> Pay Now
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ===== END SUBSCRIPTION & BILLING MODALS ===== -->

    <div class="modal fade" id="editCompanyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Company Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="companyEditForm" enctype="multipart/form-data">
                    <div class="modal-body">
                        {% csrf_token %}
                        {% if company %}
                        <div class="row g-3">
                            <div class="col-12">
                                <small class="text-muted">Use this form to update company details. You can add additional CEOs below.</small>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Company Name</label>
                                <input type="text" name="company_name" class="form-control form-control-lg" value="{{ company.company_name }}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Registration Number</label>
                                <input type="text" name="registration_number" class="form-control" value="{{ company.registration_number }}" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Registration Date</label>
                                <input type="date" name="registration_date" class="form-control" value="{{ company.registration_date|date:'Y-m-d' }}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Location</label>
                                <input type="text" name="location" class="form-control" value="{{ company.location }}" required>
                            </div>

                            <div class="col-12">
                                <hr>
                                <h6 class="mb-2">Chief Executive Officers</h6>
                            </div>

                            <!-- Primary CEO (existing during signup) -->
                            <div class="col-md-6">
                                <label class="form-label">CEO Name <span class="ceo-tag ms-2" style="font-size: 10px;">Master CEO</span></label>
                                {% if company and company.ceos.all %}
                                    {% with primary=company.ceos.all.0 %}
                                        <input type="text" name="primary_ceo_name" class="form-control" value="{{ primary.name }}" required>
                                    {% endwith %}
                                {% else %}
                                    <input type="text" name="primary_ceo_name" class="form-control" value="{{ company.ceo_name }}">
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">CEO Date of Birth</label>
                                {% if company and company.ceos.all %}
                                    {% with primary=company.ceos.all.0 %}
                                        <input type="date" name="primary_ceo_dob" class="form-control" value="{{ primary.dob|date:'Y-m-d' }}">
                                    {% endwith %}
                                {% else %}
                                    <input type="date" name="primary_ceo_dob" class="form-control" value="{{ company.ceo_dob|date:'Y-m-d' }}">
                                {% endif %}
                            </div>

                            <!-- Dynamic additional CEOs container -->
                            <div class="col-12">
                                <div id="additionalCeoList">
                                    {% if company and company.ceos.all %}
                                        {% for ceo in company.ceos.all|slice:"1:" %}
                                            <div class="row g-2 mb-2 ceo-item" data-ceo-id="{{ ceo.id }}" data-ceo-name="{{ ceo.name }}">
                                                <div class="col-md-5">
                                                    <input type="text" name="other_ceo_name[]" class="form-control" value="{{ ceo.name }}" placeholder="Additional CEO name">
                                                </div>
                                                <div class="col-md-5">
                                                    <input type="date" name="other_ceo_dob[]" class="form-control" value="{{ ceo.dob|date:'Y-m-d' }}">
                                                </div>
                                                <div class="col-md-2 d-flex align-items-center">
                                                    <button type="button" class="btn btn-outline-danger btn-sm w-100 remove-ceo-btn">Remove</button>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                <div class="mt-2">
                                    <button type="button" id="addCeoBtn" class="btn btn-outline-success btn-sm"><i class="bi bi-plus-lg me-1"></i> Add More CEOs</button>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" name="email" class="form-control" value="{{ company.email }}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Phone</label>
                                <input type="text" name="phone" class="form-control" value="{{ company.phone }}" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Logo</label>
                                <div class="custom-file-upload mb-2" id="logoDropArea">
                                    <input type="file" name="logo" accept="image/*" id="logoInput" class="custom-file-input" style="display:none;">
                                    <div class="upload-box d-flex flex-column align-items-center justify-content-center p-3" id="logoUploadBox" style="cursor:pointer; border:2px dashed #a5b4fc; border-radius:12px; background:#f8fafc; min-height:110px; transition: border-color 0.2s;">
                                        <i class="bi bi-image" style="font-size:2rem; color:#6366f1;"></i>
                                        <span class="upload-text mt-2" style="color:#6366f1; font-weight:500;">Click or Drag & Drop Logo</span>
                                        <span class="upload-hint text-muted" style="font-size:0.9em;">PNG, JPG, JPEG, max 2MB</span>
                                    </div>
                                    <div class="preview-box mt-2 text-center">
                                        {% if company.logo %}
                                            <img id="logoPreviewImg" src="{{ company.logo.url }}" alt="Company Logo" style="max-width: 120px; max-height: 80px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f9fafb; padding: 4px;">
                                        {% else %}
                                            <img id="logoPreviewImg" src="#" alt="Logo Preview" style="display:none; max-width: 120px; max-height: 80px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f9fafb; padding: 4px;">
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- Cashier / Receipts Section -->
                            <div class="col-12 mt-4">
                                <hr>
                                <h6 class="mb-2">Cashier / Receipts</h6>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Cashier Name</label>
                                <input type="text" name="cashier_name" class="form-control" value="{{ company.cashier_name }}" placeholder="Enter cashier name">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Cashier Signature <span class="text-muted" style="font-size: 0.9em;">(Image upload)</span></label>
                                <div class="custom-file-upload mb-2" id="signatureDropArea">
                                    <input type="file" name="cashier_signature" accept="image/*" id="cashierSignatureInput" class="custom-file-input" style="display:none;">
                                    <div class="upload-box d-flex flex-column align-items-center justify-content-center p-3" id="signatureUploadBox" style="cursor:pointer; border:2px dashed #a5b4fc; border-radius:12px; background:#f8fafc; min-height:110px; transition: border-color 0.2s;">
                                        <i class="bi bi-pencil-square" style="font-size:2rem; color:#6366f1;"></i>
                                        <span class="upload-text mt-2" style="color:#6366f1; font-weight:500;">Click or Drag & Drop Signature</span>
                                        <span class="upload-hint text-muted" style="font-size:0.9em;">PNG, JPG, JPEG, max 2MB</span>
                                    </div>
                                    <div class="preview-box mt-2 text-center">
                                        {% if company.cashier_signature %}
                                            <img id="cashierSignaturePreviewImg" src="{{ company.cashier_signature.url }}" alt="Cashier Signature" style="max-width: 180px; max-height: 80px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f9fafb; padding: 4px;">
                                        {% else %}
                                            <img id="cashierSignaturePreviewImg" src="#" alt="Signature Preview" style="display:none; max-width: 180px; max-height: 80px; border: 1px solid #e5e7eb; border-radius: 6px; background: #f9fafb; padding: 4px;">
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                        </div>
                        {% else %}
                            <div class="alert alert-info">No company record to edit.</div>
                        {% endif %}
                        <div class="alert d-none mt-3" id="companyEditFeedback"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-success d-flex align-items-center" id="companySaveBtn">
                            <span id="companySaveSpinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                            <i class="bi bi-check2-circle me-1"></i>
                            <span id="companySaveText">Save changes</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>



    <!-- Modal: Confirm remove additional CEO -->
    <div class="modal fade" id="removeCeoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Remove Additional CEO</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="removeCeoText">Are you sure?</p>
                    <div class="alert d-none" id="removeCeoFeedback"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmRemoveCeoBtn">Remove</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .custom-file-upload .upload-box {
            border: 2px dashed #a5b4fc;
            border-radius: 12px;
            background: #f8fafc;
            min-height: 110px;
            transition: border-color 0.2s;
        }
        .custom-file-upload .upload-box.dragover {
            border-color: #6366f1;
            background: #eef2ff;
        }
        .custom-file-upload .upload-text {
            color: #6366f1;
            font-weight: 500;
        }
        .custom-file-upload .upload-hint {
            font-size: 0.9em;
        }
        .custom-file-upload .preview-box img {
            margin-top: 4px;
        }
    </style>

    <script>
        // Modern file upload UI for logo and cashier signature
        document.addEventListener('DOMContentLoaded', function() {
            // Logo
            const logoDropArea = document.getElementById('logoDropArea');
            const logoInput = document.getElementById('logoInput');
            const logoUploadBox = document.getElementById('logoUploadBox');
            const logoPreviewImg = document.getElementById('logoPreviewImg');
            if (logoDropArea && logoInput && logoUploadBox && logoPreviewImg) {
                logoUploadBox.addEventListener('click', () => logoInput.click());
                logoDropArea.addEventListener('dragover', e => {
                    e.preventDefault();
                    logoUploadBox.classList.add('dragover');
                });
                logoDropArea.addEventListener('dragleave', e => {
                    e.preventDefault();
                    logoUploadBox.classList.remove('dragover');
                });
                logoDropArea.addEventListener('drop', e => {
                    e.preventDefault();
                    logoUploadBox.classList.remove('dragover');
                    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                        logoInput.files = e.dataTransfer.files;
                        const file = e.dataTransfer.files[0];
                        const reader = new FileReader();
                        reader.onload = function(ev) {
                            logoPreviewImg.src = ev.target.result;
                            logoPreviewImg.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
                logoInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(ev) {
                            logoPreviewImg.src = ev.target.result;
                            logoPreviewImg.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            // Cashier Signature
            const signatureDropArea = document.getElementById('signatureDropArea');
            const cashierSignatureInput = document.getElementById('cashierSignatureInput');
            const signatureUploadBox = document.getElementById('signatureUploadBox');
            const cashierSignaturePreviewImg = document.getElementById('cashierSignaturePreviewImg');
            if (signatureDropArea && cashierSignatureInput && signatureUploadBox && cashierSignaturePreviewImg) {
                signatureUploadBox.addEventListener('click', () => cashierSignatureInput.click());
                signatureDropArea.addEventListener('dragover', e => {
                    e.preventDefault();
                    signatureUploadBox.classList.add('dragover');
                });
                signatureDropArea.addEventListener('dragleave', e => {
                    e.preventDefault();
                    signatureUploadBox.classList.remove('dragover');
                });
                signatureDropArea.addEventListener('drop', e => {
                    e.preventDefault();
                    signatureUploadBox.classList.remove('dragover');
                    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                        cashierSignatureInput.files = e.dataTransfer.files;
                        const file = e.dataTransfer.files[0];
                        const reader = new FileReader();
                        reader.onload = function(ev) {
                            cashierSignaturePreviewImg.src = ev.target.result;
                            cashierSignaturePreviewImg.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
                cashierSignatureInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(ev) {
                            cashierSignaturePreviewImg.src = ev.target.result;
                            cashierSignaturePreviewImg.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });
        // Initialize progress bar widths
        document.addEventListener('DOMContentLoaded', function() {
            const progressFills = document.querySelectorAll('.progress-fill');
            progressFills.forEach(fill => {
                const width = fill.getAttribute('data-width');
                if (width) {
                    fill.style.width = width + '%';
                }
            });
        });

        (function() {
            const form = document.getElementById('companyEditForm');
            if (!form) return;

            // Dynamic CEOs: add / remove additional CEO input rows
            const additionalCeoList = document.getElementById('additionalCeoList');
            const addCeoBtn = document.getElementById('addCeoBtn');

            function createCeoRow(name = '', dob = '') {
                const row = document.createElement('div');
                row.className = 'row g-2 mb-2 ceo-item';
                row.innerHTML = `
                    <div class="col-md-5">
                        <input type="text" name="other_ceo_name[]" class="form-control" value="${name}" placeholder="Additional CEO name">
                    </div>
                    <div class="col-md-5">
                        <input type="date" name="other_ceo_dob[]" class="form-control" value="${dob}">
                    </div>
                    <div class="col-md-2 d-flex align-items-center">
                        <button type="button" class="btn btn-outline-danger btn-sm w-100 remove-ceo-btn">Remove</button>
                    </div>
                `;
                return row;
            }

            if (addCeoBtn) {
                addCeoBtn.addEventListener('click', function() {
                    const row = createCeoRow();
                    additionalCeoList.appendChild(row);
                });
            }

            // Delegate remove: open a Bootstrap modal for confirmation and perform AJAX delete when needed
            if (additionalCeoList) {
                let pendingCeoItem = null;

                additionalCeoList.addEventListener('click', function(e) {
                    const btn = e.target.closest('.remove-ceo-btn');
                    if (!btn) return;
                    const item = btn.closest('.ceo-item');
                    if (!item) return;

                    pendingCeoItem = item;
                    const ceoName = item.getAttribute('data-ceo-name') || (item.querySelector('input[name="other_ceo_name[]"]')?.value || '').trim();
                    const modal = document.getElementById('removeCeoModal');
                    modal.querySelector('#removeCeoText').textContent = ceoName
                        ? `Remove additional CEO "${ceoName}"? This will remove the entry from the form.`
                        : 'Remove this additional CEO entry? This will remove the entry from the form.';
                    const bs = new bootstrap.Modal(modal);
                    bs.show();
                });

                // Confirm button handler
                document.addEventListener('click', async function(e) {
                    const btn = e.target.closest('#confirmRemoveCeoBtn');
                    if (!btn) return;
                    const modalEl = document.getElementById('removeCeoModal');
                    const bsModal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                    const feedback = modalEl.querySelector('#removeCeoFeedback');
                    feedback.classList.add('d-none');

                    if (!pendingCeoItem) {
                        bsModal.hide();
                        return;
                    }

                    const ceoId = pendingCeoItem.getAttribute('data-ceo-id');
                    // If saved (has id), call delete endpoint; otherwise just remove from DOM
                    if (!ceoId) {
                        pendingCeoItem.remove();
                        pendingCeoItem = null;
                        bsModal.hide();
                        return;
                    }

                    // Do AJAX POST to delete endpoint
                    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || '';
                    const url = `{% url 'company-ceo-delete' ceo_id=0 %}`.replace('/0/', `/${ceoId}/`);
                    const formData = new FormData();
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    try {
                        const res = await fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest' }, body: formData });
                        const data = await res.json();
                        if (data.ok) {
                            pendingCeoItem.remove();
                            pendingCeoItem = null;
                            bsModal.hide();
                        } else {
                            feedback.classList.remove('d-none');
                            feedback.classList.add('alert-danger');
                            feedback.textContent = data.error || 'Failed to remove CEO';
                        }
                    } catch (err) {
                        feedback.classList.remove('d-none');
                        feedback.classList.add('alert-danger');
                        feedback.textContent = 'Network or server error. Please try again.';
                    }
                });
            }

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const url = '{% url "company-profile-update" %}?company={{ company.slug }}';
                const feedback = document.getElementById('companyEditFeedback');
                const saveBtn = document.getElementById('companySaveBtn');
                const spinner = document.getElementById('companySaveSpinner');
                const saveText = document.getElementById('companySaveText');

                const formData = new FormData(form);

                // Show spinner and disable button
                if (spinner) spinner.classList.remove('d-none');
                if (saveBtn) saveBtn.disabled = true;
                if (saveText) saveText.textContent = 'Saving...';

                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    });
                    const data = await res.json();
                    feedback.classList.remove('d-none', 'alert-danger', 'alert-success');
                    if (data.ok) {
                        feedback.classList.add('alert-success');
                        feedback.textContent = data.message || 'Saved';
                        // Optimistic reload to reflect latest values
                        setTimeout(() => { window.location.reload(); }, 800);
                    } else {
                        feedback.classList.add('alert-danger');
                        if (data.errors) {
                            const msgs = Object.entries(data.errors).map(([k,v]) => `${k}: ${v}`).join(' | ');
                            feedback.textContent = msgs;
                        } else {
                            feedback.textContent = data.error || 'Update failed';
                        }
                        // Hide spinner and re-enable
                        if (spinner) spinner.classList.add('d-none');
                        if (saveBtn) saveBtn.disabled = false;
                        if (saveText) saveText.textContent = 'Save changes';
                    }
                } catch (err) {
                    feedback.classList.remove('d-none');
                    feedback.classList.add('alert-danger');
                    feedback.textContent = 'Network or server error. Please try again.';
                    if (spinner) spinner.classList.add('d-none');
                    if (saveBtn) saveBtn.disabled = false;
                    if (saveText) saveText.textContent = 'Save changes';
                }
            });
        })();

            // Admin actions: mute/unmute and delete with confirmation modals
            (function() {
                // Use document-level event delegation for reliability

                    // Helper function to get cookie
                    function getCookie(name) {
                        const value = `; ${document.cookie}`;
                        const parts = value.split(`; ${name}=`);
                        if (parts.length === 2) return parts.pop().split(';').shift();
                    }

                    // Helper function to show toast notification
                    function showToast(message, type = 'info') {
                        const toast = document.createElement('div');
                        toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
                        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; animation: fadeIn 0.3s ease;';
                        toast.innerHTML = `
                            ${message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 4000);
                    }

                // Create beautiful confirmation modal
                const confirmModal = document.createElement('div');
                confirmModal.className = 'modal fade';
                confirmModal.id = 'confirmActionModal';
                confirmModal.tabIndex = -1;
                confirmModal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px; overflow: hidden;">
                            <div class="modal-header border-0 text-white" style="padding: 20px 24px;">
                                <div class="d-flex align-items-center">
                                    <div class="me-3" style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                        <i class="bi bi-shield-check" style="font-size: 24px;"></i>
                                    </div>
                                    <div>
                                        <h5 class="modal-title mb-0" id="confirmActionTitle" style="font-weight: 600;">Confirm Action</h5>
                                    </div>
                                </div>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-4">
                                <div class="text-center mb-3">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <div class="me-3 text-warning" style="width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(255,193,7,0.1);">
                                            <i class="bi bi-exclamation-triangle" style="font-size:2rem"></i>
                                        </div>
                                        <div class="text-start">
                                            <p class="mb-1 fs-5 fw-semibold" id="confirmActionText" style="color: #1f2937;"></p>
                                            <small class="text-muted" id="confirmActionCaption"></small>
                                        </div>
                                    </div>
                                </div>
                                <div id="confirmExtra"></div>
                                <div class="alert d-none mt-3" id="confirmFeedback" style="border-radius: 10px;"></div>
                            </div>
                            <div class="modal-footer border-0 pt-0 px-4 pb-4">
                                <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal" style="border-radius: 10px;">Cancel</button>
                                <button type="button" class="btn btn-primary px-4" id="confirmActionBtn" style="border-radius: 10px; min-width: 140px;">Confirm</button>
                            </div>
                        </div>
                    </div>`;
                document.body.appendChild(confirmModal);
                const bsConfirmModal = new bootstrap.Modal(confirmModal);

                let pending = null; // {type, userId, desired, btn}
                
                // Use document for event delegation to ensure it works
                document.addEventListener('click', async function(e) {
                    // Only handle clicks on admin action buttons within the admins tab
                    const btn = e.target.closest('#admins button[data-action]');
                    if (!btn) return;
                    
                    const userId = btn.getAttribute('data-user-id');
                    const action = btn.getAttribute('data-action');
                    const feedback = confirmModal.querySelector('#confirmFeedback');
                    feedback.classList.add('d-none');
                    feedback.textContent = '';

                    // Handle toggle full control with beautiful modal
                    if (action === 'toggle-full-control') {
                        const hasControl = btn.getAttribute('data-has-control') === 'true';
                        
                        // Configure modal for full control action
                        const header = confirmModal.querySelector('.modal-header');
                        const headerIcon = header.querySelector('.me-3 i');
                        const bodyIcon = confirmModal.querySelector('.modal-body .me-3');
                        const confirmBtn = confirmModal.querySelector('#confirmActionBtn');
                        
                        if (hasControl) {
                            header.style.background = 'linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%)';
                            if (headerIcon) headerIcon.className = 'bi bi-shield-x';
                            bodyIcon.style.background = 'rgba(220, 53, 69, 0.1)';
                            bodyIcon.innerHTML = '<i class="bi bi-shield-x text-danger" style="font-size:2rem"></i>';
                            confirmBtn.className = 'btn btn-danger px-4';
                            confirmBtn.style.borderRadius = '10px';
                            confirmBtn.textContent = 'Revoke Access';
                        } else {
                            header.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
                            if (headerIcon) headerIcon.className = 'bi bi-shield-fill-check';
                            bodyIcon.style.background = 'rgba(25, 135, 84, 0.1)';
                            bodyIcon.innerHTML = '<i class="bi bi-shield-fill-check text-success" style="font-size:2rem"></i>';
                            confirmBtn.className = 'btn btn-success px-4';
                            confirmBtn.style.borderRadius = '10px';
                            confirmBtn.textContent = 'Grant Access';
                        }
                        
                        confirmModal.querySelector('#confirmActionTitle').textContent = hasControl ? 'Revoke Full Control' : 'Grant Full Control';
                        confirmModal.querySelector('#confirmActionText').textContent = hasControl 
                            ? 'Are you sure you want to revoke full control for this admin?' 
                            : 'Are you sure you want to grant full control to this admin?';
                        confirmModal.querySelector('#confirmActionCaption').textContent = hasControl 
                            ? 'This admin will need to enter the master admin password to access company profile.'
                            : 'This admin will have the same access as the master admin without password verification.';
                        confirmModal.querySelector('#confirmExtra').innerHTML = '';
                        
                        pending = { type: 'full-control', userId, hasControl, btn };
                        bsConfirmModal.show();
                        return;
                    }

                    if (action === 'toggle-mute') {
                        const current = btn.getAttribute('data-current'); // 'active' or 'muted'
                        const desired = current === 'active' ? 'mute' : 'unmute';
                        
                        // Configure modal for mute action
                        const header = confirmModal.querySelector('.modal-header');
                        const headerIcon = header.querySelector('.me-3 i');
                        const bodyIcon = confirmModal.querySelector('.modal-body .me-3');
                        const confirmBtn = confirmModal.querySelector('#confirmActionBtn');
                        
                        if (desired === 'mute') {
                            header.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                            if (headerIcon) headerIcon.className = 'bi bi-volume-mute-fill';
                            bodyIcon.style.background = 'rgba(255, 193, 7, 0.1)';
                            bodyIcon.innerHTML = '<i class="bi bi-volume-mute-fill text-warning" style="font-size:2rem"></i>';
                            confirmBtn.className = 'btn btn-warning px-4';
                            confirmBtn.style.borderRadius = '10px';
                            confirmBtn.textContent = 'Mute Admin';
                        } else {
                            header.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                            if (headerIcon) headerIcon.className = 'bi bi-volume-up-fill';
                            bodyIcon.style.background = 'rgba(13, 110, 253, 0.1)';
                            bodyIcon.innerHTML = '<i class="bi bi-volume-up-fill text-primary" style="font-size:2rem"></i>';
                            confirmBtn.className = 'btn btn-primary px-4';
                            confirmBtn.style.borderRadius = '10px';
                            confirmBtn.textContent = 'Unmute Admin';
                        }
                        
                        pending = { type: 'mute', userId, desired };
                        confirmModal.querySelector('#confirmActionTitle').textContent = desired === 'mute' ? 'Mute Admin Account' : 'Unmute Admin Account';
                        confirmModal.querySelector('#confirmActionText').textContent = desired === 'mute' ? 'Are you sure you want to mute this admin account?' : 'Unmute this admin account?';
                        confirmModal.querySelector('#confirmActionCaption').textContent = desired === 'mute' ? 'Muted admins cannot log in until unmuted.' : 'This admin will be able to log in again.';
                        confirmModal.querySelector('#confirmExtra').innerHTML = '';
                        bsConfirmModal.show();
                        return;
                    }
                    
                    if (action === 'delete-admin') {
                        const name = btn.getAttribute('data-name') || 'this admin';
                        
                        // Configure modal for delete action
                        const header = confirmModal.querySelector('.modal-header');
                        const headerIcon = header.querySelector('.me-3 i');
                        const bodyIcon = confirmModal.querySelector('.modal-body .me-3');
                        const confirmBtn = confirmModal.querySelector('#confirmActionBtn');
                        
                        header.style.background = 'linear-gradient(135deg, #e53935 0%, #b71c1c 100%)';
                        if (headerIcon) headerIcon.className = 'bi bi-trash3-fill';
                        bodyIcon.style.background = 'rgba(220, 53, 69, 0.1)';
                        bodyIcon.innerHTML = '<i class="bi bi-trash3-fill text-danger" style="font-size:2rem"></i>';
                        confirmBtn.className = 'btn btn-danger px-4';
                        confirmBtn.style.borderRadius = '10px';
                        confirmBtn.textContent = 'Delete Permanently';
                        
                        pending = { type: 'delete', userId };
                        confirmModal.querySelector('#confirmActionTitle').textContent = 'Delete Admin Account';
                        confirmModal.querySelector('#confirmActionText').innerHTML = `You are about to <strong>permanently delete</strong> <span class="fw-bold">${name}</span>.`;
                        confirmModal.querySelector('#confirmActionCaption').textContent = 'This action cannot be undone. The admin will be permanently removed from the system.';
                        confirmModal.querySelector('#confirmExtra').innerHTML = `
                            <div class="mt-3 p-3 bg-light rounded-3">
                                <label class="form-label fw-semibold mb-2">Reason for deletion (optional)</label>
                                <textarea class="form-control" id="deleteReason" rows="2" placeholder="Enter reason for documentation..."></textarea>
                                
                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" id="permanentDelete" checked>
                                    <label class="form-check-label text-danger fw-semibold" for="permanentDelete">
                                        <i class="bi bi-exclamation-triangle me-1"></i>Permanently remove from database
                                    </label>
                                    <small class="d-block text-muted">If unchecked, admin will be deactivated but can be restored later.</small>
                                </div>
                            </div>`;
                        bsConfirmModal.show();
                        return;
                    }
                });

                // Confirm Action Button handler
                confirmModal.querySelector('#confirmActionBtn').addEventListener('click', async function() {
                    if (!pending) return;
                    const feedback = confirmModal.querySelector('#confirmFeedback');
                    const confirmBtn = this;
                    confirmBtn.disabled = true;
                    const originalText = confirmBtn.textContent;
                    confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
                    
                    try {
                        let url = '';
                        const form = new FormData();
                        const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken') || '';
                        const companySlug = '{{ company.slug }}';
                        form.append('csrfmiddlewaretoken', csrfToken);
                        
                        if (pending.type === 'full-control') {
                            // Handle full control toggle
                            url = '{% url "toggle-full-control" %}';
                            form.append('user_id', pending.userId);
                            
                            const res = await fetch(url, {
                            const res = await fetch(url, {
                                method: 'POST',
                                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                                body: form
                            });
                            const data = await res.json();
                                
                                feedback.classList.remove('d-none', 'alert-danger', 'alert-success');
                                if (data.ok) {
                                    feedback.classList.add('alert-success');
                                    feedback.innerHTML = `<i class="bi bi-check-circle me-2"></i>${data.message || 'Permission updated successfully'}`;
                                    
                                    // Update the button in the table
                                    if (pending.btn) {
                                        if (data.has_full_control) {
                                            pending.btn.className = 'btn btn-sm btn-success';
                                            pending.btn.innerHTML = '<i class="bi bi-shield-fill-check"></i> Full Control';
                                            pending.btn.setAttribute('data-has-control', 'true');
                                            pending.btn.title = 'Revoke Full Control';
                                        } else {
                                            pending.btn.className = 'btn btn-sm btn-outline-secondary';
                                            pending.btn.innerHTML = '<i class="bi bi-shield"></i> Grant Control';
                                            pending.btn.setAttribute('data-has-control', 'false');
                                            pending.btn.title = 'Grant Full Control';
                                        }
                                    }
                                    
                                    setTimeout(() => { 
                                        bsConfirmModal.hide(); 
                                        pending = null;
                                    }, 1500);
                                } else {
                                    feedback.classList.add('alert-danger');
                                    feedback.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${data.error || 'Failed to update permission'}`;
                                }
                                
                                confirmBtn.disabled = false;
                                confirmBtn.textContent = originalText;
                                return;
                            }
                            
                            if (pending.type === 'mute') {
                                url = `/company-profile/admin/${pending.userId}/toggle-mute/?company=${companySlug}`;
                                form.append('desired', pending.desired);
                            } else if (pending.type === 'delete') {
                                url = `/company-profile/admin/${pending.userId}/delete/?company=${companySlug}`;
                                const reason = confirmModal.querySelector('#deleteReason')?.value || '';
                                const permanent = confirmModal.querySelector('#permanentDelete')?.checked ? 'true' : 'false';
                                form.append('reason', reason);
                                form.append('permanent', permanent);
                            }

                            const res = await fetch(url, {
                                method: 'POST',
                                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                                body: form
                            });
                            const data = await res.json();
                            feedback.classList.remove('d-none', 'alert-danger', 'alert-success');
                            if (data.ok) {
                                feedback.classList.add('alert-success');
                                feedback.innerHTML = `<i class="bi bi-check-circle me-2"></i>${data.message || 'Success'}`;
                                setTimeout(() => { window.location.reload(); }, 1000);
                            } else {
                                feedback.classList.add('alert-danger');
                                // Check if access denied due to session expiration
                                if (data.error && data.error.includes('verification required')) {
                                    feedback.innerHTML = `<i class="bi bi-shield-lock me-2"></i>Session expired. Reloading page...`;
                                    setTimeout(() => { window.location.reload(); }, 1500);
                                } else {
                                    feedback.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${data.error || 'Action failed'}`;
                                    confirmBtn.disabled = false;
                                    confirmBtn.textContent = originalText;
                                }
                            }
                        } catch (err) {
                            feedback.classList.remove('d-none');
                            feedback.classList.add('alert-danger');
                            feedback.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Network or server error. Please try again.';
                            confirmBtn.disabled = false;
                            confirmBtn.textContent = originalText;
                        }
                    });
            })();

            // Edit User functionality
            (function() {
                let editUserModal, editUserForm, editUserFeedback;

                function initEditUser() {
                    editUserModal = new bootstrap.Modal(document.getElementById('editUserModal'));
                    editUserForm = document.getElementById('editUserForm');
                    editUserFeedback = document.getElementById('editUserFeedback');

                    // Handle edit button clicks
                    document.addEventListener('click', function(e) {
                        const editBtn = e.target.closest('button[data-action="edit-user"]');
                        if (!editBtn) return;

                        const userId = editBtn.getAttribute('data-user-id');
                        const userType = editBtn.getAttribute('data-user-type');
                        const userName = editBtn.getAttribute('data-user-name');
                        const userEmail = editBtn.getAttribute('data-user-email');
                        const userPhone = editBtn.getAttribute('data-user-phone');
                        const userAddress = editBtn.getAttribute('data-user-address');

                        // Populate modal
                        document.getElementById('editUserId').value = userId;
                        document.getElementById('editUserType').value = userType;
                        document.getElementById('editFullName').value = userName;
                        document.getElementById('editEmail').value = userEmail;
                        document.getElementById('editPhone').value = userPhone;
                        document.getElementById('editAddress').value = userAddress;
                        document.getElementById('editNewPassword').value = '';
                        document.getElementById('editConfirmPassword').value = '';
                        
                        // Clear master admin password field if it exists
                        const masterPasswordField = document.getElementById('masterAdminPassword');
                        if (masterPasswordField) {
                            masterPasswordField.value = '';
                        }

                        editUserFeedback.classList.add('d-none');
                        editUserModal.show();
                    });

                    // Handle form submission
                    editUserForm.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        
                        const formData = new FormData(this);
                        const userId = formData.get('user_id');
                        const userType = formData.get('user_type');
                        
                        // Validate passwords if provided
                        const newPassword = formData.get('new_password');
                        const confirmPassword = formData.get('confirm_password');
                        
                        if (newPassword || confirmPassword) {
                            if (newPassword !== confirmPassword) {
                                editUserFeedback.classList.remove('d-none', 'alert-success');
                                editUserFeedback.classList.add('alert-danger');
                                editUserFeedback.textContent = 'Passwords do not match.';
                                return;
                            }
                            if (newPassword.length < 8) {
                                editUserFeedback.classList.remove('d-none', 'alert-success');
                                editUserFeedback.classList.add('alert-danger');
                                editUserFeedback.textContent = 'Password must be at least 8 characters long.';
                                return;
                            }
                        }

                        // Validate master admin password if field exists
                        const masterPasswordField = document.getElementById('masterAdminPassword');
                        if (masterPasswordField && !masterPasswordField.value.trim()) {
                            editUserFeedback.classList.remove('d-none', 'alert-success');
                            editUserFeedback.classList.add('alert-danger');
                            editUserFeedback.textContent = 'Master admin password is required to make changes.';
                            return;
                        }

                        try {
                            const companySlug = '{{ company.slug }}';
                            const url = userType === 'admin' 
                                ? `/company-profile/admin/${userId}/edit/?company=${companySlug}` 
                                : `/company-profile/support/${userId}/edit/?company=${companySlug}`;
                            const response = await fetch(url, {
                                method: 'POST',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                                },
                                body: formData
                            });

                            const data = await response.json();
                            
                            if (data.ok) {
                                editUserFeedback.classList.remove('d-none', 'alert-danger');
                                editUserFeedback.classList.add('alert-success');
                                editUserFeedback.textContent = data.message || 'User updated successfully.';
                                
                                setTimeout(() => {
                                    editUserModal.hide();
                                    window.location.reload();
                                }, 1000);
                            } else {
                                editUserFeedback.classList.remove('d-none', 'alert-success');
                                editUserFeedback.classList.add('alert-danger');
                                editUserFeedback.textContent = data.error || 'Failed to update user.';
                            }
                        } catch (error) {
                            editUserFeedback.classList.remove('d-none', 'alert-success');
                            editUserFeedback.classList.add('alert-danger');
                            editUserFeedback.textContent = 'Network error. Please try again.';
                        }
                    });
                }

                // Initialize when DOM is ready
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initEditUser);
                } else {
                    initEditUser();
                }
            })();
    </script>

    <style>
        /* CEO tag: visually distinct from badges */
        .ceo-tag {
            display: inline-block;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 700;
            box-shadow: 0 6px 18px rgba(16,185,129,0.18);
            font-size: 0.95rem;
        }

        .ceo-tag .ceo-role {
            background: rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.95);
            padding: 2px 8px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 0.7rem;
            vertical-align: middle;
        }

        .ceo-tag .bi-award-fill {
            font-size: 0.9rem;
            vertical-align: -2px;
        }

        .master-badge {
            background: #fbbf24;
            color: #1f2937;
            border-radius: 8px;
            padding: 4px 8px;
            font-weight: 700;
            font-size: 0.75rem;
        }
        /* Primary CEO variant (keeps green look) */
        .ceo-tag.primary-ceo {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            box-shadow: 0 6px 18px rgba(16,185,129,0.18);
        }

        /* Other CEO variant: pill with softer purple/blue gradient */
        .ceo-tag.other-ceo {
            background: linear-gradient(135deg, #6366f1 0%, #7c3aed 100%);
            color: #fff;
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 600;
            box-shadow: 0 6px 14px rgba(99,102,241,0.12);
            font-size: 0.9rem;
        }

        .ceo-tag.other-ceo .bi-person-fill {
            font-size: 0.9rem;
            vertical-align: -2px;
        }

        /* Slight spacing for CEO name inside pill */
        .ceo-tag .ceo-name { vertical-align: middle; }
    </style>

    <!-- Subscription & Billing JavaScript -->
    <script>
        // Subscription plans data from Django context (pre-serialized JSON)
        // Use let to allow modification if needed
        let subscriptionPlans = {{ subscription_plans_json|safe }};
        
        // Fallback plans if no data from server
        const fallbackPlans = [
            { id: 1, name: 'Starter', tier: 'starter', description: 'For Small Companies', monthly_price: 70000, annual_price: 700000, max_plots: 2, max_agents: 50, features: {estate_properties: 2, allocations: 30, clients: 30, affiliates: 20}, is_popular: false },
            { id: 2, name: 'Professional', tier: 'professional', description: 'For Growing Companies', monthly_price: 100000, annual_price: 1000000, max_plots: 5, max_agents: 110, features: {estate_properties: 5, allocations: 80, clients: 80, affiliates: 30}, is_popular: true },
            { id: 3, name: 'Enterprise', tier: 'enterprise', description: 'Preferred Package Plan', monthly_price: 150000, annual_price: 1500000, max_plots: 999999, max_agents: 999999, features: {estate_properties: 'unlimited', allocations: 'unlimited', clients: 'unlimited', affiliates: 'unlimited'}, is_popular: false }
        ];
        
        // Ensure subscriptionPlans is always an array with data
        if (!subscriptionPlans || !Array.isArray(subscriptionPlans) || subscriptionPlans.length === 0) {
            subscriptionPlans = fallbackPlans;
            console.log('[Billing] Using fallback plans');
        } else {
            console.log('[Billing] Loaded', subscriptionPlans.length, 'plans from server');
        }
        
        // Current subscription and company usage data from Django context
        const currentSubscription = {
            tier: '{{ subscription.tier|default:"starter" }}',
            plan_name: '{{ subscription.plan_name|default:"Starter" }}',
            status: '{{ subscription.status|default:"trial" }}',
            amount: {{ subscription.monthly_price|default:0 }},
            days_remaining: {{ subscription.days_remaining|default:0 }},
            is_trial: {{ subscription.is_trial|yesno:"true,false" }},
            is_active: {{ subscription.is_active|yesno:"true,false" }},
            max_plots: {{ subscription.max_plots|default:50 }},
            max_agents: {{ subscription.max_agents|default:1 }}
        };
        
        // Current company usage for downgrade checks
        const companyUsage = {
            estates: {{ total_estates|default:0 }},
            allocations: {{ total_allocations|default:0 }},
            clients: {{ total_clients|default:0 }},
            marketers: {{ total_marketers|default:0 }}
        };

        // Format number with thousand separators
        function formatPrice(amount) {
            return new Intl.NumberFormat('en-NG').format(amount);
        }
        
        // Format limit (show 'Unlimited' for large numbers or 'unlimited' string)
        function formatLimit(limit) {
            // Handle string 'unlimited' from database
            if (typeof limit === 'string' && limit.toLowerCase() === 'unlimited') {
                return 'Unlimited';
            }
            // Handle numeric values
            const numLimit = parseInt(limit) || 0;
            return numLimit >= 999999 ? 'Unlimited' : formatPrice(numLimit);
        }
        
        // Get plan features display
        function getPlanFeatures(plan) {
            const f = plan.features || {};
            return {
                estates: f.estate_properties || plan.max_plots,
                allocations: f.allocations || 'Based on plan',
                clients: f.clients || 'Based on plan',
                affiliates: f.affiliates || 'Based on plan'
            };
        }

        // Load plans into container
        function loadPlans(targetContainer, isUpgrade = false) {
            const container = document.getElementById(targetContainer);
            if (!container) return;
            
            let html = '';
            const isEnterprise = currentSubscription.tier === 'enterprise';
            
            // Sort plans: Starter, Professional, Enterprise
            const sortedPlans = [...subscriptionPlans].sort((a, b) => {
                const order = {'starter': 1, 'professional': 2, 'enterprise': 3};
                return order[a.tier] - order[b.tier];
            });
            
            sortedPlans.forEach(plan => {
                const isCurrentPlan = plan.tier === currentSubscription.tier;
                if (isUpgrade && isCurrentPlan) return;
                
                const tierLevel = {'starter': 1, 'professional': 2, 'enterprise': 3}[plan.tier] || 0;
                const currentTierLevel = {'starter': 1, 'professional': 2, 'enterprise': 3}[currentSubscription.tier] || 0;
                const isDowngrade = tierLevel < currentTierLevel;
                const features = getPlanFeatures(plan);
                
                // For Enterprise users in upgrade modal, skip showing plans
                if (isUpgrade && isEnterprise) return;
                
                // Get save amount for annual
                const annualSavings = (plan.monthly_price * 12) - plan.annual_price;
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100 border-2 plan-card ${isCurrentPlan ? 'border-success bg-light' : ''} ${plan.is_popular ? 'border-primary' : ''}" 
                             data-plan-id="${plan.id}" data-plan-tier="${plan.tier}" data-plan-name="${plan.name}" data-plan-price="${plan.monthly_price}">
                            <div class="card-body text-center position-relative">
                                ${plan.is_popular ? '<div class="badge bg-primary position-absolute top-0 end-0 m-2">Popular</div>' : ''}
                                ${plan.tier === 'enterprise' ? '<div class="badge bg-danger position-absolute top-0 start-0 m-2">Preferred</div>' : ''}
                                <div class="plan-icon mb-2">
                                    <i class="bi ${plan.tier === 'enterprise' ? 'bi-rocket-takeoff' : plan.tier === 'professional' ? 'bi-star-fill' : 'bi-lightning-charge-fill'} fs-1 ${plan.tier === 'enterprise' ? 'text-danger' : plan.tier === 'professional' ? 'text-primary' : 'text-warning'}"></i>
                                </div>
                                <h5 class="card-title fw-bold mb-0">${plan.name}</h5>
                                <small class="text-muted">${plan.description || ''}</small>
                                ${isCurrentPlan ? '<div class="badge bg-success mt-2">Current Plan</div>' : ''}
                                <div class="my-3">
                                    <div class="display-6 text-primary">
                                        <span class="fs-5">₦</span>${formatPrice(plan.monthly_price)}
                                        <small class="fs-6 text-muted">/mo</small>
                                    </div>
                                    <small class="text-success">₦${formatPrice(plan.annual_price)}/year (Save ₦${formatPrice(annualSavings)}!)</small>
                                </div>
                                <ul class="list-unstyled text-start small mb-3">
                                    <li class="mb-2 py-1 border-bottom"><i class="bi bi-building text-primary me-2"></i><strong>${formatLimit(features.estates)}</strong> Estate Properties</li>
                                    <li class="mb-2 py-1 border-bottom"><i class="bi bi-check2-square text-warning me-2"></i><strong>${formatLimit(features.allocations)}</strong> Allocations</li>
                                    <li class="mb-2 py-1 border-bottom"><i class="bi bi-people text-success me-2"></i><strong>${formatLimit(features.clients)}</strong> Clients & <strong>${formatLimit(features.affiliates)}</strong> Affiliates</li>
                                    <li class="mb-2"><i class="bi ${plan.tier !== 'starter' ? 'bi-check-circle-fill text-success' : 'bi-x-circle text-muted'} me-2"></i>${plan.tier === 'enterprise' ? 'Priority Support' : plan.tier === 'professional' ? 'Email Support' : 'Basic Support'}</li>
                                </ul>
                                <button type="button" class="btn btn-${isCurrentPlan ? 'outline-secondary' : isDowngrade ? 'outline-warning' : 'primary'} w-100 select-plan-btn" 
                                        data-plan-tier="${plan.tier}" data-plan-name="${plan.name}" data-plan-price="${plan.monthly_price}"
                                        data-max-plots="${plan.max_plots}" data-max-agents="${plan.max_agents}"
                                        ${isCurrentPlan ? 'disabled' : ''}>
                                    <i class="bi ${isCurrentPlan ? 'bi-check-circle' : isDowngrade ? 'bi-arrow-down' : 'bi-arrow-up'} me-1"></i>
                                    ${isCurrentPlan ? 'Current Plan' : isDowngrade ? 'Downgrade' : 'Select Plan'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // If Enterprise user viewing upgrade modal
            if (isUpgrade && isEnterprise) {
                html = `
                    <div class="col-12">
                        <div class="alert alert-success text-center">
                            <i class="bi bi-rocket-takeoff fs-1 d-block mb-2"></i>
                            <h5>You're on the Enterprise Plan!</h5>
                            <p class="mb-0">You already have access to all unlimited features. No upgrade available.</p>
                        </div>
                    </div>
                `;
            }
            
            if (html === '') {
                html = '<div class="col-12"><div class="alert alert-info">No available plans.</div></div>';
            }
            
            container.innerHTML = html;
            
            // Attach event listeners to plan selection buttons
            container.querySelectorAll('.select-plan-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const planTier = this.getAttribute('data-plan-tier');
                    const planName = this.getAttribute('data-plan-name');
                    const planPrice = parseFloat(this.getAttribute('data-plan-price'));
                    const maxPlots = parseInt(this.getAttribute('data-max-plots'));
                    const maxAgents = parseInt(this.getAttribute('data-max-agents'));
                    selectPlan(planTier, planName, planPrice, maxPlots, maxAgents);
                });
            });
        }

        // Handle plan selection
        function selectPlan(planTier, planName, planPrice, maxPlots, maxAgents) {
            const tierLevel = {'starter': 1, 'professional': 2, 'enterprise': 3}[planTier] || 0;
            const currentTierLevel = {'starter': 1, 'professional': 2, 'enterprise': 3}[currentSubscription.tier] || 0;
            
            if (tierLevel > currentTierLevel) {
                // Upgrade flow
                showUpgradeConfirmation(planTier, planName, planPrice);
            } else if (tierLevel < currentTierLevel) {
                // Downgrade flow - check requirements
                checkDowngradeRequirements(planTier, planName, planPrice, maxPlots, maxAgents);
            } else if (!currentSubscription.is_active && !currentSubscription.is_trial) {
                // New subscription flow
                showPaymentModal(planName, planPrice, 'new');
            }
        }

        // Show upgrade confirmation
        function showUpgradeConfirmation(newTier, newPlan, newPrice) {
            document.getElementById('paymentPlan').textContent = `${newPlan} (Upgrade)`;
            document.getElementById('paymentAmount').textContent = `₦${formatPrice(newPrice)}`;
            document.getElementById('paymentTotal').textContent = `₦${formatPrice(newPrice)}`;
            
            // Store upgrade tier for processing
            document.getElementById('paymentForm').dataset.tier = newTier;
            document.getElementById('paymentForm').dataset.action = 'upgrade';
            
            // Show payment container
            document.getElementById('stripePaymentContainer').style.display = 'none';
            document.getElementById('paystackPaymentContainer').style.display = 'block';
            
            const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
            bootstrap.Modal.getInstance(document.getElementById('upgradePlanModal'))?.hide();
            bootstrap.Modal.getInstance(document.getElementById('selectPlanModal'))?.hide();
            paymentModal.show();
        }
        
        // Check downgrade requirements
        function checkDowngradeRequirements(newTier, newPlan, newPrice, maxPlots, maxAgents) {
            const plan = subscriptionPlans.find(p => p.tier === newTier);
            const features = getPlanFeatures(plan);
            
            // Get limits from features
            const estateLimit = typeof features.estates === 'number' ? features.estates : maxPlots;
            const allocationLimit = typeof features.allocations === 'number' ? features.allocations : 999999;
            const clientLimit = typeof features.clients === 'number' ? features.clients : maxAgents;
            
            // Check if current usage exceeds new plan limits
            const issues = [];
            const warnings = [];
            
            // Check estates
            if (companyUsage.estates > estateLimit) {
                issues.push(`You have ${companyUsage.estates} estates but ${newPlan} only allows ${estateLimit}.`);
            } else if (companyUsage.estates >= estateLimit * 0.7) {
                warnings.push(`You're using ${companyUsage.estates}/${estateLimit} estate slots (${Math.round(companyUsage.estates/estateLimit*100)}%).`);
            }
            
            // Check allocations  
            if (companyUsage.allocations > allocationLimit) {
                issues.push(`You have ${companyUsage.allocations} transactions but ${newPlan} only allows ${allocationLimit}.`);
            } else if (companyUsage.allocations >= allocationLimit * 0.7) {
                warnings.push(`You're using ${companyUsage.allocations}/${allocationLimit} allocations (${Math.round(companyUsage.allocations/allocationLimit*100)}%).`);
            }
            
            // Check clients
            if (companyUsage.clients > clientLimit) {
                issues.push(`You have ${companyUsage.clients} clients but ${newPlan} only allows ${clientLimit}.`);
            } else if (companyUsage.clients >= clientLimit * 0.7) {
                warnings.push(`You're using ${companyUsage.clients}/${clientLimit} client slots (${Math.round(companyUsage.clients/clientLimit*100)}%).`);
            }
            
            // Show downgrade modal with issues/warnings
            showDowngradeConfirmation(newTier, newPlan, newPrice, issues, warnings);
        }
        
        // Show downgrade confirmation with requirements check
        function showDowngradeConfirmation(newTier, newPlan, newPrice, issues, warnings) {
            let modalContent = '';
            
            if (issues.length > 0) {
                // Cannot downgrade
                modalContent = `
                    <div class="modal fade" id="downgradeBlockedModal" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header bg-danger text-white">
                                    <h5 class="modal-title"><i class="bi bi-exclamation-octagon me-2"></i>Cannot Downgrade</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="alert alert-danger">
                                        <strong>You cannot downgrade to ${newPlan}</strong> because your current usage exceeds the plan limits:
                                    </div>
                                    <ul class="list-group">
                                        ${issues.map(i => `<li class="list-group-item list-group-item-danger"><i class="bi bi-x-circle me-2"></i>${i}</li>`).join('')}
                                    </ul>
                                    <p class="mt-3 text-muted small">To downgrade, you must first reduce your usage to meet the new plan's limits.</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Understood</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Can downgrade but may have warnings
                modalContent = `
                    <div class="modal fade" id="downgradeConfirmModal" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header bg-warning">
                                    <h5 class="modal-title"><i class="bi bi-arrow-down-circle me-2"></i>Confirm Downgrade</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>You are about to downgrade from <strong>${currentSubscription.plan_name}</strong> to <strong>${newPlan}</strong>.</p>
                                    <p>New monthly price: <strong class="text-success">₦${formatPrice(newPrice)}</strong></p>
                                    
                                    ${warnings.length > 0 ? `
                                        <div class="alert alert-warning">
                                            <strong><i class="bi bi-exclamation-triangle me-2"></i>Warning:</strong> You're approaching the limits of the ${newPlan} plan:
                                            <ul class="mb-0 mt-2">
                                                ${warnings.map(w => `<li>${w}</li>`).join('')}
                                            </ul>
                                            <hr>
                                            <small>Consider staying on your current plan to avoid restrictions.</small>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        The downgrade will take effect at the end of your current billing period.
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-warning" onclick="processDowngrade('${newTier}')">
                                        <i class="bi bi-arrow-down me-1"></i>Confirm Downgrade
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Remove existing modals and add new one
            document.getElementById('downgradeBlockedModal')?.remove();
            document.getElementById('downgradeConfirmModal')?.remove();
            document.body.insertAdjacentHTML('beforeend', modalContent);
            
            const modalId = issues.length > 0 ? 'downgradeBlockedModal' : 'downgradeConfirmModal';
            const modal = new bootstrap.Modal(document.getElementById(modalId));
            bootstrap.Modal.getInstance(document.getElementById('upgradePlanModal'))?.hide();
            bootstrap.Modal.getInstance(document.getElementById('selectPlanModal'))?.hide();
            modal.show();
        }
        
        // Process downgrade via API
        async function processDowngrade(newTier) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('downgradeConfirmModal'));
            
            try {
                const response = await fetch('/api/subscriptions/downgrade/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ tier: newTier })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    modal?.hide();
                    showSuccessToast('Subscription downgrade scheduled successfully! Changes will take effect at the end of your billing period.');
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    alert(data.error || 'Failed to downgrade subscription.');
                }
            } catch (error) {
                console.error('Downgrade error:', error);
                alert('Network error. Please try again.');
            }
        }

        // Show payment modal
        function showPaymentModal(planName, planPrice, action = 'new') {
            document.getElementById('paymentPlan').textContent = planName;
            document.getElementById('paymentAmount').textContent = `₦${formatPrice(planPrice)}`;
            document.getElementById('paymentTotal').textContent = `₦${formatPrice(planPrice)}`;
            
            document.getElementById('paymentForm').dataset.action = action;
            
            // Show Paystack by default (more common in Nigeria)
            document.getElementById('stripePaymentContainer').style.display = 'none';
            document.getElementById('paystackPaymentContainer').style.display = 'block';
            
            const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
            paymentModal.show();
        }
        
        // Success toast helper
        function showSuccessToast(message) {
            const toast = document.createElement('div');
            toast.className = 'position-fixed bottom-0 end-0 p-3';
            toast.style.zIndex = '11111';
            toast.innerHTML = `
                <div class="toast show align-items-center text-white bg-success border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body"><i class="bi bi-check-circle me-2"></i>${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // Load plans when modal opens
        document.getElementById('selectPlanModal')?.addEventListener('show.bs.modal', function() {
            loadPlans('plansContainer', false);
        });
        
        document.getElementById('upgradePlanModal')?.addEventListener('show.bs.modal', function() {
            loadPlans('upgradePlansContainer', true);
            document.getElementById('currentPlanName').textContent = currentSubscription.plan_name;
        });
        
        document.getElementById('renewSubscriptionModal')?.addEventListener('show.bs.modal', function() {
            document.getElementById('renewPlanName').textContent = currentSubscription.plan_name;
            document.getElementById('renewAmount').textContent = formatPrice(currentSubscription.amount);
        });

        // Load downgrade plans when modal opens
        document.getElementById('downgradePlanModal')?.addEventListener('show.bs.modal', function() {
            loadDowngradePlans();
        });

        // Load downgrade plans (only Starter and Professional for Enterprise users)
        async function loadDowngradePlans() {
            const container = document.getElementById('downgradePlansContainer');
            container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
            
            const downgradePlans = [
                {
                    tier: 'starter',
                    name: 'Starter',
                    monthly_price: 70000,
                    annual_price: 700000,
                    max_plots: 2,
                    max_agents: 50,
                    max_allocations: 30,
                    color: 'primary'
                },
                {
                    tier: 'professional',
                    name: 'Professional',
                    monthly_price: 100000,
                    annual_price: 1000000,
                    max_plots: 5,
                    max_agents: 110,
                    max_allocations: 80,
                    color: 'success'
                }
            ];
            
            container.innerHTML = '';
            
            downgradePlans.forEach(plan => {
                const col = document.createElement('div');
                col.className = 'col-md-6';
                
                // Check if current usage exceeds plan limits
                const currentEstates = {{ total_estates|default:0 }};
                const currentClients = {{ total_clients|default:0 }};
                const currentAllocations = {{ total_allocations|default:0 }};
                
                const exceedsLimits = currentEstates > plan.max_plots || 
                                      currentClients > plan.max_agents || 
                                      currentAllocations > plan.max_allocations;
                
                col.innerHTML = `
                    <div class="card h-100 ${exceedsLimits ? 'border-danger' : 'border-'+plan.color} hover-shadow">
                        <div class="card-header bg-${plan.color} bg-opacity-10">
                            <h6 class="mb-0">${plan.name}</h6>
                        </div>
                        <div class="card-body">
                            <div class="h4 mb-3 text-${plan.color}">₦${plan.monthly_price.toLocaleString('en-NG')}<span class="fs-6 text-muted">/month</span></div>
                            <ul class="list-unstyled small mb-3">
                                <li class="mb-2"><i class="bi bi-${currentEstates <= plan.max_plots ? 'check-circle text-success' : 'x-circle text-danger'} me-2"></i>Up to ${plan.max_plots} Estates ${currentEstates > plan.max_plots ? '<span class="text-danger">(You have '+currentEstates+')</span>' : ''}</li>
                                <li class="mb-2"><i class="bi bi-${currentClients <= plan.max_agents ? 'check-circle text-success' : 'x-circle text-danger'} me-2"></i>Up to ${plan.max_agents} Clients & Affiliates ${currentClients > plan.max_agents ? '<span class="text-danger">(You have '+currentClients+')</span>' : ''}</li>
                                <li class="mb-2"><i class="bi bi-${currentAllocations <= plan.max_allocations ? 'check-circle text-success' : 'x-circle text-danger'} me-2"></i>Up to ${plan.max_allocations} Allocations ${currentAllocations > plan.max_allocations ? '<span class="text-danger">(You have '+currentAllocations+')</span>' : ''}</li>
                            </ul>
                            ${exceedsLimits ? `
                                <div class="alert alert-danger small py-2 mb-3">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    Your current usage exceeds this plan's limits. You must reduce usage before downgrading.
                                </div>
                                <button class="btn btn-outline-secondary btn-sm w-100" disabled>
                                    <i class="bi bi-lock me-1"></i>Cannot Downgrade
                                </button>
                            ` : `
                                <button class="btn btn-outline-${plan.color} btn-sm w-100" onclick="confirmDowngrade('${plan.tier}', '${plan.name}', ${plan.monthly_price})">
                                    <i class="bi bi-arrow-down-left me-1"></i>Downgrade to ${plan.name}
                                </button>
                            `}
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }

        // Confirm downgrade
        async function confirmDowngrade(planTier, planName, planPrice) {
            if (!confirm(`Are you sure you want to downgrade to the ${planName} plan? This change will take effect at the end of your current billing cycle.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/subscription/downgrade/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({ plan_tier: planTier })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('downgradePlanModal'))?.hide();
                    showToast('Your plan downgrade has been scheduled.', 'success');
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    showToast(data.error || 'Failed to process downgrade.', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.', 'error');
            }
        }

        // Show payment modal
        function showPaymentModal(planName, planPrice) {
            document.getElementById('paymentPlan').textContent = planName;
            document.getElementById('paymentAmount').textContent = `₦${planPrice.toLocaleString('en-NG')}`;
            document.getElementById('paymentTotal').textContent = `₦${planPrice.toLocaleString('en-NG')}`;
            
            const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
            paymentModal.show();
        }

        // ========== NEW BILLING TOGGLE & MANAGE SUBSCRIPTION FUNCTIONS ==========
        
        // Current billing period state
        let currentBillingPeriod = 'monthly';
        let selectedPlanTier = currentSubscription.tier;
        
        // Toggle billing period (Monthly/Annual)
        function toggleBillingPeriod() {
            const toggle = document.getElementById('billingToggle');
            currentBillingPeriod = toggle.checked ? 'annual' : 'monthly';
            
            // Update toggle labels
            document.getElementById('monthlyLabel').classList.toggle('active', !toggle.checked);
            document.getElementById('annualLabel').classList.toggle('active', toggle.checked);
            
            // Re-render available plans
            renderAvailablePlans();
        }
        
        // Render available plans in the billing tab
        function renderAvailablePlans() {
            const container = document.getElementById('availablePlansGrid');
            if (!container) return;
            
            const isAnnual = currentBillingPeriod === 'annual';
            
            // Fallback plans if subscriptionPlans is empty
            let plansToRender = subscriptionPlans;
            if (!plansToRender || plansToRender.length === 0) {
                plansToRender = [
                    { id: 1, name: 'Starter', tier: 'starter', description: 'For Small Companies', monthly_price: 70000, annual_price: 700000, max_plots: 2, max_agents: 50, features: {estate_properties: 2, allocations: 30, clients: 30, affiliates: 20}, is_popular: false },
                    { id: 2, name: 'Professional', tier: 'professional', description: 'For Growing Companies', monthly_price: 100000, annual_price: 1000000, max_plots: 5, max_agents: 110, features: {estate_properties: 5, allocations: 80, clients: 80, affiliates: 30}, is_popular: true },
                    { id: 3, name: 'Enterprise', tier: 'enterprise', description: 'Preferred Package Plan', monthly_price: 150000, annual_price: 1500000, max_plots: 999999, max_agents: 999999, features: {estate_properties: 'unlimited', allocations: 'unlimited', clients: 'unlimited', affiliates: 'unlimited'}, is_popular: false }
                ];
            }
            
            // Sort plans
            const sortedPlans = [...plansToRender].sort((a, b) => {
                const order = {'starter': 1, 'professional': 2, 'enterprise': 3};
                return order[a.tier] - order[b.tier];
            });
            
            let html = '';
            
            sortedPlans.forEach(plan => {
                const isCurrentPlan = plan.tier === currentSubscription.tier;
                const features = getPlanFeatures(plan);
                const displayPrice = isAnnual ? plan.annual_price : plan.monthly_price;
                const annualSavings = (plan.monthly_price * 12) - plan.annual_price;
                
                // Determine tier icon and colors
                const iconClass = plan.tier === 'enterprise' ? 'bi-rocket-takeoff' : 
                                  plan.tier === 'professional' ? 'bi-star-fill' : 'bi-lightning-charge';
                
                html += `
                    <div class="plan-card ${isCurrentPlan ? 'current-plan' : ''} ${plan.is_popular ? 'popular' : ''} ${plan.tier === 'enterprise' ? 'preferred' : ''}"
                         data-tier="${plan.tier}" onclick="selectPlanCard('${plan.tier}')">
                        
                        ${isCurrentPlan ? '<div class="plan-ribbon current">Current Plan</div>' : ''}
                        ${plan.is_popular && !isCurrentPlan ? '<div class="plan-ribbon popular">Most Popular</div>' : ''}
                        ${plan.tier === 'enterprise' && !isCurrentPlan ? '<div class="plan-ribbon preferred">Preferred</div>' : ''}
                        
                        <div class="plan-card-icon ${plan.tier}">
                            <i class="bi ${iconClass}"></i>
                        </div>
                        
                        <div class="plan-card-name">${plan.name}</div>
                        <div class="plan-card-desc">${plan.description}</div>
                        
                        <div class="plan-card-price">
                            <span class="price-main">₦${formatPrice(displayPrice)}</span>
                            <span class="price-period">/${isAnnual ? 'year' : 'month'}</span>
                            ${isAnnual ? `<span class="price-annual">Save ₦${formatPrice(annualSavings)} (2 months free!)</span>` : 
                                         `<span class="price-annual">₦${formatPrice(plan.annual_price)}/year saves ₦${formatPrice(annualSavings)}</span>`}
                        </div>
                        
                        <ul class="plan-card-features">
                            <li><i class="bi bi-check-circle-fill"></i><strong>${formatLimit(features.estates)}</strong> Estates</li>
                            <li><i class="bi bi-check-circle-fill"></i><strong>${formatLimit(features.allocations)}</strong> Allocations</li>
                            <li><i class="bi bi-check-circle-fill"></i><strong>${formatLimit(features.clients)}</strong> Clients</li>
                            <li><i class="bi bi-check-circle-fill"></i><strong>${formatLimit(features.affiliates)}</strong> Affiliates</li>
                            <li><i class="bi ${plan.tier !== 'starter' ? 'bi-check-circle-fill' : 'bi-x-circle'}"></i>
                                ${plan.tier === 'enterprise' ? 'Dedicated Support' : plan.tier === 'professional' ? 'Priority Support' : 'Basic Support'}
                            </li>
                        </ul>
                        
                        <button class="plan-card-btn ${isCurrentPlan ? 'current' : 'primary'}" 
                                onclick="event.stopPropagation(); handlePlanSelection('${plan.tier}', '${plan.name}', ${displayPrice}, ${plan.max_plots}, ${plan.max_agents})"
                                ${isCurrentPlan ? 'disabled' : ''}>
                            ${isCurrentPlan ? '<i class="bi bi-check-circle me-1"></i>Current Plan' : '<i class="bi bi-arrow-right me-1"></i>Select Plan'}
                        </button>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<div class="col-12 text-center py-4 text-muted">No plans available</div>';
            }
            
            container.innerHTML = html;
        }
        
        // Select plan card visually
        function selectPlanCard(tier) {
            document.querySelectorAll('.plan-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.plan-card[data-tier="${tier}"]`)?.classList.add('selected');
            selectedPlanTier = tier;
        }
        
        // Handle plan selection from available plans grid
        function handlePlanSelection(tier, name, price, maxPlots, maxAgents) {
            const tierLevel = {'starter': 1, 'professional': 2, 'enterprise': 3}[tier] || 0;
            const currentTierLevel = {'starter': 1, 'professional': 2, 'enterprise': 3}[currentSubscription.tier] || 0;
            
            if (tierLevel > currentTierLevel) {
                // Upgrade
                showUpgradeConfirmation(tier, name, price);
            } else if (tierLevel < currentTierLevel) {
                // Downgrade
                checkDowngradeRequirements(tier, name, price, maxPlots, maxAgents);
            }
        }
        
        // Variable to track selected plan in manage modal (must be declared before event listeners)
        let managePlanSelection = null;
        
        // Populate Manage Subscription Modal
        function populateManageModal() {
            console.log('[Billing] populateManageModal called - subscriptionPlans:', subscriptionPlans?.length);
            
            // Fallback plans
            let plansToUse = subscriptionPlans;
            if (!plansToUse || plansToUse.length === 0) {
                plansToUse = [
                    { id: 1, name: 'Starter', tier: 'starter', description: 'For Small Companies', monthly_price: 70000, annual_price: 700000, max_plots: 2, max_agents: 50, features: {estate_properties: 2, allocations: 30, clients: 30, affiliates: 20}, is_popular: false },
                    { id: 2, name: 'Professional', tier: 'professional', description: 'For Growing Companies', monthly_price: 100000, annual_price: 1000000, max_plots: 5, max_agents: 110, features: {estate_properties: 5, allocations: 80, clients: 80, affiliates: 30}, is_popular: true },
                    { id: 3, name: 'Enterprise', tier: 'enterprise', description: 'Preferred Package Plan', monthly_price: 150000, annual_price: 1500000, max_plots: 999999, max_agents: 999999, features: {estate_properties: 'unlimited', allocations: 'unlimited', clients: 'unlimited', affiliates: 'unlimited'}, is_popular: false }
                ];
            }
            
            const currentPlan = plansToUse.find(p => p.tier === currentSubscription.tier) || plansToUse[0];
            if (!currentPlan) return;
            
            const features = getPlanFeatures(currentPlan);
            
            // Update current plan info
            document.getElementById('manageCurrentPlanName').textContent = currentPlan.name;
            document.getElementById('manageCurrentPlanDesc').textContent = currentPlan.description;
            document.getElementById('manageCurrentPrice').textContent = formatPrice(currentSubscription.amount || currentPlan.monthly_price);
            
            // Update features with usage format
            document.getElementById('manageEstates').textContent = `${companyUsage.estates}/${formatLimit(features.estates)}`;
            document.getElementById('manageAllocations').textContent = `${companyUsage.allocations}/${formatLimit(features.allocations)}`;
            document.getElementById('manageClients').textContent = `${companyUsage.clients}/${formatLimit(features.clients)}`;
            document.getElementById('manageAffiliates').textContent = `${companyUsage.marketers}/${formatLimit(features.affiliates)}`;
            
            console.log('[Billing] populateManageModal complete - calling renderManagePlans');
            // Render plans in manage modal
            renderManagePlans();
        }
        
        // Render plans in manage subscription modal
        function renderManagePlans() {
            console.log('[Billing] renderManagePlans called');
            const container = document.getElementById('managePlansContainer');
            if (!container) {
                console.error('[Billing] managePlansContainer not found!');
                return;
            }
            
            const billingPeriod = document.querySelector('input[name="manageBillingPeriod"]:checked')?.value || 'monthly';
            const isAnnual = billingPeriod === 'annual';
            console.log('[Billing] Billing period:', billingPeriod, 'isAnnual:', isAnnual);
            
            // Fallback plans
            let plansToUse = subscriptionPlans;
            if (!plansToUse || plansToUse.length === 0) {
                console.log('[Billing] Using fallback plans in renderManagePlans');
                plansToUse = [
                    { id: 1, name: 'Starter', tier: 'starter', description: 'For Small Companies', monthly_price: 70000, annual_price: 700000, max_plots: 2, max_agents: 50, features: {estate_properties: 2, allocations: 30, clients: 30, affiliates: 20}, is_popular: false },
                    { id: 2, name: 'Professional', tier: 'professional', description: 'For Growing Companies', monthly_price: 100000, annual_price: 1000000, max_plots: 5, max_agents: 110, features: {estate_properties: 5, allocations: 80, clients: 80, affiliates: 30}, is_popular: true },
                    { id: 3, name: 'Enterprise', tier: 'enterprise', description: 'Preferred Package Plan', monthly_price: 150000, annual_price: 1500000, max_plots: 999999, max_agents: 999999, features: {estate_properties: 'unlimited', allocations: 'unlimited', clients: 'unlimited', affiliates: 'unlimited'}, is_popular: false }
                ];
            }
            
            const sortedPlans = [...plansToUse].sort((a, b) => {
                const order = {'starter': 1, 'professional': 2, 'enterprise': 3};
                return order[a.tier] - order[b.tier];
            });
            
            let html = '';
            
            sortedPlans.forEach(plan => {
                const isCurrentPlan = plan.tier === currentSubscription.tier;
                const features = getPlanFeatures(plan);
                const displayPrice = isAnnual ? plan.annual_price : plan.monthly_price;
                const annualSavings = (plan.monthly_price * 12) - plan.annual_price;
                
                const tierLevel = {'starter': 1, 'professional': 2, 'enterprise': 3}[plan.tier] || 0;
                const currentTierLevel = {'starter': 1, 'professional': 2, 'enterprise': 3}[currentSubscription.tier] || 0;
                const isUpgrade = tierLevel > currentTierLevel;
                const isDowngrade = tierLevel < currentTierLevel;
                
                html += `
                    <div class="col-md-4">
                        <div class="manage-plan-card ${isCurrentPlan ? 'current' : ''}" data-tier="${plan.tier}">
                            ${isCurrentPlan ? '<div class="current-badge">Current Plan</div>' : ''}
                            ${plan.is_popular && !isCurrentPlan ? '<div class="popular-badge">Popular</div>' : ''}
                            ${plan.tier === 'enterprise' && !isCurrentPlan ? '<div class="preferred-badge">Preferred</div>' : ''}
                            
                            <div class="plan-icon ${plan.tier}">
                                <i class="bi ${plan.tier === 'enterprise' ? 'bi-rocket-takeoff' : plan.tier === 'professional' ? 'bi-star-fill' : 'bi-lightning-charge'}"></i>
                            </div>
                            
                            <h5>${plan.name}</h5>
                            
                            <div class="plan-price">₦${formatPrice(displayPrice)}</div>
                            <div class="plan-period">/${isAnnual ? 'year' : 'month'}</div>
                            ${isAnnual ? `<div class="plan-annual-price">Save ₦${formatPrice(annualSavings)}</div>` : ''}
                            
                            <ul>
                                <li><i class="bi bi-building"></i><strong>${formatLimit(features.estates)}</strong> Estates</li>
                                <li><i class="bi bi-check2-square"></i><strong>${formatLimit(features.allocations)}</strong> Allocations</li>
                                <li><i class="bi bi-people"></i><strong>${formatLimit(features.clients)}</strong> Clients</li>
                                <li><i class="bi bi-person-lines-fill"></i><strong>${formatLimit(features.affiliates)}</strong> Affiliates</li>
                            </ul>
                            
                            ${!isCurrentPlan ? `
                                <button class="btn btn-sm w-100 mt-2 ${isUpgrade ? 'btn-success' : 'btn-warning'}" 
                                        onclick="selectManagePlan('${plan.tier}', '${plan.name}', ${displayPrice})">
                                    ${isUpgrade ? '<i class="bi bi-arrow-up me-1"></i>Upgrade' : '<i class="bi bi-arrow-down me-1"></i>Downgrade'}
                                </button>
                            ` : `
                                <button class="btn btn-sm btn-outline-secondary w-100 mt-2" disabled>
                                    <i class="bi bi-check me-1"></i>Current
                                </button>
                            `}
                        </div>
                    </div>
                `;
            });
            
            console.log('[Billing] renderManagePlans complete - plans rendered:', sortedPlans.length);
            container.innerHTML = html;
        }
        
        // Select plan in manage modal
        function selectManagePlan(tier, name, price) {
            managePlanSelection = { tier, name, price };
            
            // Highlight selected
            document.querySelectorAll('.manage-plan-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.manage-plan-card[data-tier="${tier}"]`)?.classList.add('selected');
            
            // Update button text
            const tierLevel = {'starter': 1, 'professional': 2, 'enterprise': 3}[tier] || 0;
            const currentTierLevel = {'starter': 1, 'professional': 2, 'enterprise': 3}[currentSubscription.tier] || 0;
            const actionBtn = document.getElementById('manageActionBtn');
            
            if (tierLevel > currentTierLevel) {
                actionBtn.innerHTML = '<i class="bi bi-arrow-up-circle me-2"></i>Upgrade to ' + name;
                actionBtn.className = 'btn';
                actionBtn.style.background = '#10a37f';
            } else {
                actionBtn.innerHTML = '<i class="bi bi-arrow-down-circle me-2"></i>Downgrade to ' + name;
                actionBtn.className = 'btn btn-warning';
                actionBtn.style.background = '';
            }
        }
        
        // Process subscription change from manage modal
        function processSubscriptionChange() {
            if (!managePlanSelection) {
                showToast('Please select a plan first', 'warning');
                return;
            }
            
            const billingPeriod = document.querySelector('input[name="manageBillingPeriod"]:checked')?.value || 'monthly';
            const { tier, name, price } = managePlanSelection;
            
            const tierLevel = {'starter': 1, 'professional': 2, 'enterprise': 3}[tier] || 0;
            const currentTierLevel = {'starter': 1, 'professional': 2, 'enterprise': 3}[currentSubscription.tier] || 0;
            
            // Close manage modal
            bootstrap.Modal.getInstance(document.getElementById('manageSubscriptionModal'))?.hide();
            
            // Get plan details
            const plan = subscriptionPlans.find(p => p.tier === tier);
            
            if (tierLevel > currentTierLevel) {
                // Upgrade flow
                showUpgradeConfirmation(tier, name, price);
            } else {
                // Downgrade flow
                checkDowngradeRequirements(tier, name, price, plan?.max_plots || 2, plan?.max_agents || 30);
            }
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'position-fixed bottom-0 end-0 p-3';
            toast.style.zIndex = '11111';
            toast.innerHTML = `
                <div class="toast show align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body"><i class="bi bi-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'x-circle'} me-2"></i>${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="this.closest('.position-fixed').remove()"></button>
                    </div>
                </div>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
        
        // ========== END NEW BILLING FUNCTIONS ==========

        // Load plans when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[Billing] DOMContentLoaded - Plans count:', subscriptionPlans.length);
            
            // Load plans into various containers
            loadPlans('plansContainer', false);
            loadPlans('upgradePlansContainer', true);
            
            // Initialize billing toggle
            document.getElementById('monthlyLabel')?.classList.add('active');
            
            // Render available plans in billing tab
            console.log('[Billing] Calling renderAvailablePlans...');
            renderAvailablePlans();
            
            // Load current subscription data
            loadCurrentSubscription();
            
            console.log('[Billing] Initialization complete');
        });
        
        // Upgrade Plan modal event - reload plans when modal opens
        document.getElementById('upgradePlanModal')?.addEventListener('show.bs.modal', function() {
            console.log('[Billing] Upgrade modal opening - loading plans');
            loadPlans('upgradePlansContainer', true);
            document.getElementById('currentPlanName').textContent = currentSubscription.plan_name;
        });
        
        // Manage subscription modal event
        document.getElementById('manageSubscriptionModal')?.addEventListener('show.bs.modal', function() {
            console.log('[Billing] Manage modal opening');
            managePlanSelection = null;
            populateManageModal();
        });
        
        // Billing period change in manage modal
        document.querySelectorAll('input[name="manageBillingPeriod"]').forEach(radio => {
            radio.addEventListener('change', function() {
                console.log('[Billing] Billing period changed to:', this.value);
                renderManagePlans();
            });
        });

        // Load current subscription data
        async function loadCurrentSubscription() {
            try {
                const response = await fetch('/api/subscription/status/');
                const data = await response.json();
                
                if (data.subscription) {
                    document.getElementById('currentPlanName').textContent = data.subscription.plan_name;
                    document.getElementById('renewPlanName').textContent = data.subscription.plan_name;
                    document.getElementById('renewAmount').textContent = data.subscription.amount.toLocaleString('en-NG');
                }
            } catch (error) {
                console.error('Error loading subscription:', error);
            }
        }

        // Handle renewal form submission
        document.getElementById('renewSubscriptionForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const paymentMethod = this.querySelector('select[name="payment_method"]').value;
            const feedback = document.getElementById('renewFeedback');
            feedback.classList.add('d-none');
            
            if (!paymentMethod) {
                feedback.classList.remove('d-none', 'alert-success');
                feedback.classList.add('alert-warning');
                feedback.textContent = 'Please select a payment method.';
                return;
            }
            
            // Close renewal modal and show payment modal
            bootstrap.Modal.getInstance(document.getElementById('renewSubscriptionModal'))?.hide();
            
            // Configure payment modal
            document.getElementById('paymentPlan').textContent = currentSubscription.plan_name + ' (Renewal)';
            document.getElementById('paymentAmount').textContent = `₦${formatPrice(currentSubscription.amount)}`;
            document.getElementById('paymentTotal').textContent = `₦${formatPrice(currentSubscription.amount)}`;
            
            // Show appropriate payment container
            document.getElementById('stripePaymentContainer').style.display = paymentMethod === 'stripe' ? 'block' : 'none';
            document.getElementById('paystackPaymentContainer').style.display = paymentMethod === 'paystack' ? 'block' : 'none';
            
            const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
            paymentModal.show();
        });

        // Handle payment form submission
        document.getElementById('paymentForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const feedback = document.getElementById('paymentFeedback');
            const isPaystack = document.getElementById('paystackPaymentContainer').style.display !== 'none';
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
            feedback.classList.add('d-none');
            
            if (isPaystack) {
                // Redirect to Paystack payment (simulated for now)
                feedback.classList.remove('d-none', 'alert-danger');
                feedback.classList.add('alert-info');
                feedback.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Redirecting to Paystack...';
                
                // In production, this would redirect to Paystack
                setTimeout(() => {
                    // Simulate successful payment for demo
                    feedback.classList.remove('alert-info');
                    feedback.classList.add('alert-success');
                    feedback.innerHTML = '<i class="bi bi-check-circle me-2"></i>Payment successful! Refreshing...';
                    
                    setTimeout(() => window.location.reload(), 1500);
                }, 2000);
            } else {
                // Handle Stripe payment
                try {
                    const response = await fetch('/api/subscriptions/upgrade/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({
                            tier: document.getElementById('paymentPlan').textContent.includes('Enterprise') ? 'enterprise' :
                                  document.getElementById('paymentPlan').textContent.includes('Professional') ? 'professional' : 'starter'
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        feedback.classList.remove('d-none', 'alert-danger');
                        feedback.classList.add('alert-success');
                        feedback.innerHTML = '<i class="bi bi-check-circle me-2"></i>Payment successful! Refreshing...';
                        
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        throw new Error(data.error || 'Payment failed');
                    }
                } catch (error) {
                    feedback.classList.remove('d-none', 'alert-success');
                    feedback.classList.add('alert-danger');
                    feedback.innerHTML = `<i class="bi bi-exclamation-triangle me-2"></i>${error.message}`;
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i> Pay Now';
                }
            }
        });

        // Show billing history modal
        async function showBillingHistory() {
            // Create billing history modal if not exists
            let modal = document.getElementById('billingHistoryModal');
            if (!modal) {
                const modalHTML = `
                    <div class="modal fade" id="billingHistoryModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header bg-success text-white">
                                    <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>Billing History</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body" id="billingHistoryContent">
                                    <div class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-3 text-muted">Loading billing history...</p>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-primary" onclick="exportBillingHistory()">
                                        <i class="bi bi-download me-1"></i> Export
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                modal = document.getElementById('billingHistoryModal');
            }
            
            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Load billing history
            try {
                const response = await fetch('/api/billing/history/');
                const data = await response.json();
                
                let html = '';
                
                if (data.ok && data.history && data.history.length > 0) {
                    // Calculate totals
                    const totalPayments = data.history.filter(h => h.type === 'charge').length;
                    const totalAmount = data.history.filter(h => h.type === 'charge').reduce((sum, h) => sum + h.amount, 0);
                    
                    html = `
                        <div class="mb-4">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="text-muted mb-1">Total Transactions</h6>
                                            <h4 class="text-primary mb-0">${data.history.length}</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="text-muted mb-1">Total Charges</h6>
                                            <h4 class="text-success mb-0">₦${totalAmount.toLocaleString('en-NG')}</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Invoice</th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Receipt</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.history.map(h => `
                                        <tr>
                                            <td>${h.date ? new Date(h.date).toLocaleDateString() : '-'}</td>
                                            <td><code class="small">${h.invoice_number || '-'}</code></td>
                                            <td>${h.description || 'Payment'}</td>
                                            <td class="fw-bold ${h.type === 'refund' ? 'text-success' : ''}">
                                                ${h.type === 'refund' ? '+' : ''}₦${h.amount.toLocaleString('en-NG')}
                                            </td>
                                            <td>
                                                <span class="badge ${h.state === 'completed' ? 'bg-success' : h.state === 'pending' ? 'bg-warning text-dark' : 'bg-danger'}">
                                                    ${h.state ? h.state.charAt(0).toUpperCase() + h.state.slice(1) : 'Unknown'}
                                                </span>
                                            </td>
                                            <td>
                                                <a href="/admin/subscription/receipt/${h.id}/" target="_blank" class="btn btn-sm btn-outline-primary" title="Download Receipt">
                                                    <i class="bi bi-file-earmark-pdf"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="text-center py-5">
                            <i class="bi bi-inbox fs-1 text-muted"></i>
                            <h5 class="mt-3">No Billing History</h5>
                            <p class="text-muted">You haven't made any payments yet.</p>
                        </div>
                    `;
                }
                
                document.getElementById('billingHistoryContent').innerHTML = html;
                
            } catch (error) {
                console.error('Error loading billing history:', error);
                document.getElementById('billingHistoryContent').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Unable to load billing history. Please try again later.
                    </div>
                `;
            }
        }
        
        // Export billing history
        function exportBillingHistory() {
            // Create a simple CSV export
            const table = document.querySelector('#billingHistoryContent table');
            if (!table) {
                alert('No billing data to export.');
                return;
            }
            
            let csv = [];
            const rows = table.querySelectorAll('tr');
            
            rows.forEach(row => {
                const cols = row.querySelectorAll('th, td');
                let rowData = [];
                cols.forEach(col => {
                    rowData.push('"' + col.textContent.trim().replace(/"/g, '""') + '"');
                });
                csv.push(rowData.join(','));
            });
            
            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'billing_history_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Password verification modal with session timeout
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('[CompanyProfile] DOMContentLoaded - Initializing...');
            
            const passwordModalElement = document.getElementById('passwordModal');
            const protectedContentElement = document.getElementById('protectedContent');
            const blurOverlay = document.getElementById('blurOverlay');
            
            if (!passwordModalElement || !protectedContentElement || !blurOverlay) {
                console.error('[CompanyProfile] ERROR: Required elements not found!');
                return;
            }
            
            // Server-side values (rendered by Django template)
            const serverSideHasFullControl = {{ user_has_full_control|yesno:"true,false" }};
            const serverSideIsMaster = {{ is_master_admin|yesno:"true,false" }};
            
            console.log('[CompanyProfile] Server-side userHasFullControl:', serverSideHasFullControl);
            console.log('[CompanyProfile] Server-side isMasterAdmin:', serverSideIsMaster);
            
            // If server says user has full control, content is already visible - just return
            if (serverSideHasFullControl) {
                console.log('[CompanyProfile] User has full control - content already visible');
                protectedContentElement.style.display = 'block';
                blurOverlay.style.display = 'none';
                passwordModalElement.style.display = 'none';
                passwordModalElement.classList.remove('show');
                return;
            }
            
            // User does NOT have full control - modal is already shown by server-side template
            // Just initialize Bootstrap Modal instance for later use (hide on successful verification)
            console.log('[CompanyProfile] User does NOT have full control - modal already shown by server');
            
            let passwordModal = null;
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                // Get existing modal instance or create new one
                passwordModal = bootstrap.Modal.getInstance(passwordModalElement);
                if (!passwordModal) {
                    passwordModal = new bootstrap.Modal(passwordModalElement, {
                        backdrop: false,
                        keyboard: false
                    });
                }
            }
            
            // Ensure modal is visible (should already be set by server)
            passwordModalElement.classList.add('show');
            passwordModalElement.style.display = 'block';
            blurOverlay.style.display = 'block';
            protectedContentElement.style.display = 'none';

            // Session timeout configuration
            const SESSION_TIMEOUT = 5 * 60 * 1000; // 5 minutes in milliseconds
            const WARNING_TIME = 1 * 60 * 1000; // Show warning 1 minute before timeout
            let sessionTimer;
            let warningTimer;
            let isModalShown = true; // Modal is already shown

            // Function to show password modal (for session timeout)
            function showPasswordModal() {
                if (!isModalShown) {
                    document.getElementById('protectedContent').style.display = 'none';
                    blurOverlay.style.display = 'block';
                    // Try to use Bootstrap modal, fallback to CSS
                    if (passwordModal && typeof passwordModal.show === 'function') {
                        passwordModal.show();
                    } else {
                        passwordModalElement.classList.add('show');
                        passwordModalElement.style.display = 'block';
                        passwordModalElement.setAttribute('aria-hidden', 'false');
                    }
                    isModalShown = true;
                }
            }

            // Function to show session warning
            function showSessionWarning() {
                document.getElementById('sessionWarning').style.display = 'block';
            }

            // Function to hide session warning
            function hideSessionWarning() {
                document.getElementById('sessionWarning').style.display = 'none';
            }

            // Function to extend session (global function for onclick)
            window.extendSession = function() {
                hideSessionWarning();
                resetSessionTimer();
            };

            // Function to reset session timer
            function resetSessionTimer() {
                clearTimeout(sessionTimer);
                clearTimeout(warningTimer);
                hideSessionWarning();
                
                // Set warning timer (4 minutes from now)
                warningTimer = setTimeout(showSessionWarning, SESSION_TIMEOUT - WARNING_TIME);
                // Set session timeout (5 minutes from now)
                sessionTimer = setTimeout(showPasswordModal, SESSION_TIMEOUT);
            }

            // Function to handle user activity
            function handleUserActivity() {
                // If modal is already shown, don't reset timer
                if (isModalShown) return;

                hideSessionWarning();
                resetSessionTimer();
            }

            // Start session timer on page load
            resetSessionTimer();

            // Listen for user activity events
            const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            activityEvents.forEach(event => {
                document.addEventListener(event, handleUserActivity, true);
            });

            // Password visibility toggle
            const togglePassword = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('masterPassword');
            const passwordIcon = document.getElementById('passwordIcon');

            togglePassword.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);

                // Toggle icon
                if (type === 'password') {
                    passwordIcon.className = 'bi bi-eye';
                } else {
                    passwordIcon.className = 'bi bi-eye-slash';
                }
            });

            document.getElementById('verifyBtn').addEventListener('click', async function() {
                const password = document.getElementById('masterPassword').value;
                const errorDiv = document.getElementById('passwordError');
                const errorText = document.getElementById('errorText');

                errorDiv.classList.add('d-none');
                errorText.textContent = '';

                if (!password) {
                    errorText.textContent = 'Please enter the password.';
                    errorDiv.classList.remove('d-none');
                    return;
                }

                // Show loading state
                this.disabled = true;
                this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Verifying...';

                try {
                    const response = await fetch('{% url "verify-master-password" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: new URLSearchParams({ password: password })
                    });

                    const data = await response.json();

                    if (data.ok) {
                        // Success animation
                        this.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Access Granted!';
                        this.style.background = 'linear-gradient(135deg, #16a34a 0%, #22c55e 100%)';

                        setTimeout(() => {
                            // Hide modal - try Bootstrap first, then fallback to CSS
                            if (passwordModal && typeof passwordModal.hide === 'function') {
                                passwordModal.hide();
                            } else {
                                passwordModalElement.classList.remove('show');
                                passwordModalElement.style.display = 'none';
                            }
                            blurOverlay.style.display = 'none'; // Hide blur overlay
                            document.getElementById('protectedContent').style.display = 'block';
                            isModalShown = false; // Reset modal state
                            hideSessionWarning(); // Hide any warning
                            resetSessionTimer(); // Restart session timer
                        }, 1000);
                    } else {
                        // Reset button
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Verify Access';

                        // Check if account is locked
                        if (data.locked) {
                            errorDiv.style.background = 'linear-gradient(135deg, #fef2f2 0%, #fecaca 100%)';
                            errorText.innerHTML = `<strong>Account Locked</strong><br>${data.error}`;
                            passwordInput.disabled = true;
                            this.disabled = true;
                        } else {
                            errorText.textContent = data.error || 'Invalid password.';
                        }
                        errorDiv.classList.remove('d-none');

                        // Shake animation for error
                        passwordInput.style.animation = 'shake 0.5s ease-in-out';
                        setTimeout(() => {
                            passwordInput.style.animation = '';
                        }, 500);
                    }
                } catch (error) {
                    // Reset button
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Verify Access';

                    errorText.textContent = 'Network error. Please try again.';
                    errorDiv.classList.remove('d-none');
                }
            });

            // Cleanup timers when page unloads
            window.addEventListener('beforeunload', function() {
                clearTimeout(sessionTimer);
                clearTimeout(warningTimer);
            });

        // Add shake animation CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(style);
    </script>

    </div> <!-- End of protectedContent -->

    <!-- Session Timeout Warning -->
    <div class="alert alert-warning alert-dismissible fade show position-fixed" id="sessionWarning" style="display: none; top: 20px; right: 20px; z-index: 1050; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <div class="d-flex align-items-center">
            <i class="bi bi-clock-history me-2" style="font-size: 1.2rem;"></i>
            <div>
                <strong>Session Expiring Soon</strong>
                <div class="small">Your session will expire in 1 minute due to inactivity.</div>
            </div>
        </div>
        <button type="button" class="btn-close" onclick="extendSession()" aria-label="Extend session"></button>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editUserForm">
                    <div class="modal-body">
                        {% csrf_token %}
                        <input type="hidden" id="editUserId" name="user_id">
                        <input type="hidden" id="editUserType" name="user_type">
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="editFullName" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="editFullName" name="full_name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editEmail" name="email" required>
                            </div>
                            <div class="col-md-6">
                                <label for="editPhone" class="form-label">Phone</label>
                                <input type="text" class="form-control" id="editPhone" name="phone">
                            </div>
                            <div class="col-md-6">
                                <label for="editAddress" class="form-label">Address</label>
                                <input type="text" class="form-control" id="editAddress" name="address">
                            </div>
                            <div class="col-12">
                                <hr>
                                <h6>Change Password (Optional)</h6>
                                <small class="text-muted">Leave blank to keep current password</small>
                            </div>
                            <div class="col-md-6">
                                <label for="editNewPassword" class="form-label">New Password</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="editNewPassword" name="new_password">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                                        <i class="bi bi-eye" id="newPasswordIcon"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="editConfirmPassword" class="form-label">Confirm New Password</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="editConfirmPassword" name="confirm_password">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                        <i class="bi bi-eye" id="confirmPasswordIcon"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Master Admin Password Verification (only for master admin) -->
                        {% if master_admin_id and request.user.id == master_admin_id %}
                        <div class="col-12">
                            <hr>
                            <h6 class="text-danger mb-2"><i class="bi bi-shield-lock-fill me-2"></i>Master Admin Verification Required</h6>
                            <small class="text-muted">As the master admin, you must confirm your identity to make changes.</small>
                        </div>
                        <div class="col-12">
                            <label for="masterAdminPassword" class="form-label">Your Master Admin Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="masterAdminPassword" name="master_admin_password" required>
                                <button class="btn btn-outline-secondary" type="button" id="toggleMasterPassword">
                                    <i class="bi bi-eye" id="masterPasswordIcon"></i>
                                </button>
                            </div>
                            <small class="text-muted">Enter your current password to authorize this change.</small>
                        </div>
                        {% endif %}

                        <div class="alert d-none mt-3" id="editUserFeedback"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-1"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</main>
{% endblock content %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle for new password field
        const toggleNewPassword = document.getElementById('toggleNewPassword');
        const editNewPassword = document.getElementById('editNewPassword');
        const newPasswordIcon = document.getElementById('newPasswordIcon');
        
        if (toggleNewPassword && editNewPassword && newPasswordIcon) {
            toggleNewPassword.addEventListener('click', function() {
                const type = editNewPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                editNewPassword.setAttribute('type', type);
                newPasswordIcon.className = type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';
            });
        }
        
        // Toggle for confirm password field
        const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
        const editConfirmPassword = document.getElementById('editConfirmPassword');
        const confirmPasswordIcon = document.getElementById('confirmPasswordIcon');
        
        if (toggleConfirmPassword && editConfirmPassword && confirmPasswordIcon) {
            toggleConfirmPassword.addEventListener('click', function() {
                const type = editConfirmPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                editConfirmPassword.setAttribute('type', type);
                confirmPasswordIcon.className = type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';
            });
        }
        
        // Toggle for master admin password field
        const toggleMasterPassword = document.getElementById('toggleMasterPassword');
        const masterAdminPassword = document.getElementById('masterAdminPassword');
        const masterPasswordIcon = document.getElementById('masterPasswordIcon');
        
        if (toggleMasterPassword && masterAdminPassword && masterPasswordIcon) {
            toggleMasterPassword.addEventListener('click', function() {
                const type = masterAdminPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                masterAdminPassword.setAttribute('type', type);
                masterPasswordIcon.className = type === 'password' ? 'bi bi-eye' : 'bi bi-eye-slash';
            });
        }

        // Handle engagement email button clicks
        document.querySelectorAll('.send-engagement-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const emailType = this.dataset.emailType;
                const originalText = this.innerHTML;
                const isReengagement = emailType === 'reengagement';
                const emailTypeLabel = isReengagement ? 're-engagement' : 'onboarding';
                
                // Show loading state
                this.disabled = true;
                this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Sending...';
                
                try {
                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
                    
                    // Prepare form data
                    const formData = new FormData();
                    formData.append('email_type', emailType);
                    
                    // Send POST request
                    const response = await fetch("{% url 'send-engagement-emails' %}", {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken
                        },
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // Success - show toast notification
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-success alert-dismissible fade show';
                        alertDiv.role = 'alert';
                        alertDiv.innerHTML = `
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Success!</strong> Sent ${data.sent_count} ${emailTypeLabel} email${data.sent_count !== 1 ? 's' : ''}.
                            ${data.failed_count > 0 ? `<br><small>${data.failed_count} email${data.failed_count !== 1 ? 's' : ''} failed to send.</small>` : ''}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        `;
                        
                        // Insert alert above the first section or at top of main
                        const main = document.querySelector('main');
                        const firstSection = main.querySelector('section');
                        if (firstSection) {
                            firstSection.parentNode.insertBefore(alertDiv, firstSection);
                        } else {
                            main.insertBefore(alertDiv, main.firstChild);
                        }
                        
                        // Auto-dismiss after 6 seconds
                        setTimeout(() => {
                            const bsAlert = new bootstrap.Alert(alertDiv);
                            bsAlert.close();
                        }, 6000);
                    } else {
                        // Error response
                        const errorMsg = data.error || `Failed to send ${emailTypeLabel} emails`;
                        throw new Error(errorMsg);
                    }
                } catch (error) {
                    // Error - show error alert
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                    alertDiv.role = 'alert';
                    alertDiv.innerHTML = `
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Error!</strong> ${error.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    
                    // Insert alert above the first section or at top of main
                    const main = document.querySelector('main');
                    const firstSection = main.querySelector('section');
                    if (firstSection) {
                        firstSection.parentNode.insertBefore(alertDiv, firstSection);
                    } else {
                        main.insertBefore(alertDiv, main.firstChild);
                    }
                    
                    // Auto-dismiss after 6 seconds
                    setTimeout(() => {
                        const bsAlert = new bootstrap.Alert(alertDiv);
                        bsAlert.close();
                    }, 6000);
                } finally {
                    // Restore button state
                    this.disabled = false;
                    this.innerHTML = originalText;
                }
            });
        });
    });
</script>

<!-- ==================== ANALYTICS & HISTORICAL RECORDS STYLES ==================== -->
<style>
    /* Analytics KPI Cards */
    .analytics-kpi-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        display: flex;
        align-items: center;
        gap: 16px;
        transition: all 0.3s ease;
        animation: fadeInUp 0.5s ease forwards;
        animation-delay: var(--delay, 0s);
        opacity: 0;
    }

    .analytics-kpi-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }

    .kpi-icon {
        width: 60px;
        height: 60px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
    }

    .kpi-icon.bg-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .kpi-icon.bg-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .kpi-icon.bg-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .kpi-icon.bg-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }

    .kpi-content {
        flex: 1;
    }

    .kpi-label {
        font-size: 12px;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .kpi-value {
        font-size: 28px;
        font-weight: 700;
        color: #1f2937;
        margin: 4px 0;
    }

    .kpi-change {
        font-size: 13px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 12px;
    }

    .kpi-change.positive { background: #d1fae5; color: #059669; }
    .kpi-change.negative { background: #fee2e2; color: #dc2626; }
    .kpi-change.neutral { background: #f3f4f6; color: #6b7280; }

    /* Analytics Chart Cards */
    .analytics-chart-card {
        border-radius: 16px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .analytics-chart-card:hover {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }

    /* Forecast Scenario Cards */
    .forecast-scenario-card {
        padding: 16px;
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .forecast-scenario-card:hover {
        transform: translateX(4px);
    }

    .forecast-scenario-card.optimistic {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        border-left: 4px solid #10b981;
    }

    .forecast-scenario-card.realistic {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        border-left: 4px solid #3b82f6;
    }

    .forecast-scenario-card.conservative {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border-left: 4px solid #f59e0b;
    }

    .scenario-header {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
    }

    .scenario-value {
        font-size: 22px;
        font-weight: 700;
        color: #1f2937;
        margin: 0;
    }

    .scenario-growth {
        font-size: 12px;
        color: #6b7280;
    }

    /* Historical Summary Cards */
.historical-summary-card {
                background: white;
                border-radius: 16px;
                padding: 20px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
                display: flex;
                align-items: center;
                gap: 16px;
                transition: all 0.3s ease;
            }
            
            /* Hide horizontal scrollbar for Historical Records table */
            #historicalRecordsTab .table-responsive {
                scrollbar-width: none; /* Firefox */
                -ms-overflow-style: none; /* IE/Edge */
            }
            #historicalRecordsTab .table-responsive::-webkit-scrollbar {
                display: none; /* Chrome, Safari, Opera */
            }    .historical-summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }

    .summary-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        background: var(--accent);
        color: white;
    }

    .summary-label {
        font-size: 12px;
        color: #6c757d;
        text-transform: uppercase;
        font-weight: 600;
    }

    .summary-value {
        font-size: 20px;
        font-weight: 700;
        color: #1f2937;
        margin: 4px 0 0 0;
    }

    /* Table Sorting */
    .sortable {
        cursor: pointer;
        user-select: none;
        transition: background 0.2s;
    }

    .sortable:hover {
        background: #f3f4f6;
    }

    .sortable.asc i::before { content: "\F128"; }
    .sortable.desc i::before { content: "\F127"; }

    /* Animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .loading-pulse {
        animation: pulse 1.5s infinite;
    }

    /* Analytics Section Cards */
    .analytics-section-card {
        border-radius: 16px;
        overflow: hidden;
    }

    .analytics-section-card .card-header {
        padding: 20px 24px;
    }

    .analytics-section-card .card-body {
        padding: 24px;
    }

    /* Top Performers List */
    .top-performer-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 8px;
        background: #f8fafc;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .top-performer-item:hover {
        background: #e0e7ff;
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }

    .performer-rank {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
        margin-right: 12px;
    }

    .performer-rank.gold { background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%); color: #000; }
    .performer-rank.silver { background: linear-gradient(135deg, #c0c0c0 0%, #a8a8a8 100%); color: #000; }
    .performer-rank.bronze { background: linear-gradient(135deg, #cd7f32 0%, #b5651d 100%); color: #fff; }
    .performer-rank.default { background: #e5e7eb; color: #374151; }

    .performer-info {
        flex: 1;
    }

    .performer-name {
        font-weight: 600;
        color: #1f2937;
    }

    .performer-deals {
        font-size: 12px;
        color: #6b7280;
    }

    .performer-target {
        margin-top: 4px;
    }

    .performer-target .badge {
        font-size: 10px;
        padding: 3px 8px;
    }

    .performer-commission {
        font-size: 12px;
    }

    .performer-sales {
        font-weight: 700;
        color: #059669;
    }

    /* Recommendation Cards */
    .recommendation-card {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        border-left: 4px solid;
        transition: all 0.3s ease;
    }

    .recommendation-card:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .recommendation-card.high-priority {
        border-color: #ef4444;
        background: #fef2f2;
    }

    .recommendation-card.medium-priority {
        border-color: #f59e0b;
        background: #fffbeb;
    }

    .recommendation-card.low-priority {
        border-color: #10b981;
        background: #ecfdf5;
    }

    .recommendation-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }

    .recommendation-card.high-priority .recommendation-icon {
        background: #fee2e2;
        color: #dc2626;
    }

    .recommendation-card.medium-priority .recommendation-icon {
        background: #fef3c7;
        color: #d97706;
    }

    .recommendation-card.low-priority .recommendation-icon {
        background: #d1fae5;
        color: #059669;
    }

    /* Recommendation Action Button */
    .recommendation-action-btn {
        transition: all 0.3s ease;
        border-radius: 20px;
        padding: 6px 16px;
        font-weight: 500;
    }

    .recommendation-action-btn:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .recommendation-card.high-priority .recommendation-action-btn {
        border-color: #dc2626;
        color: #dc2626;
    }

    .recommendation-card.high-priority .recommendation-action-btn:hover {
        background: #dc2626;
        color: white;
    }

    .recommendation-card.medium-priority .recommendation-action-btn {
        border-color: #d97706;
        color: #d97706;
    }

    .recommendation-card.medium-priority .recommendation-action-btn:hover {
        background: #d97706;
        color: white;
    }

    .recommendation-card.low-priority .recommendation-action-btn {
        border-color: #059669;
        color: #059669;
    }

    .recommendation-card.low-priority .recommendation-action-btn:hover {
        background: #059669;
        color: white;
    }

    /* Historical Table Row Hover */
    #historicalRecordsTable tbody tr {
        transition: all 0.2s ease;
    }

    #historicalRecordsTable tbody tr:hover {
        background: #f8fafc;
        transform: scale(1.002);
    }

    /* Filter Cards */
    .analytics-filter-card,
    .historical-filter-card {
        border-radius: 16px;
        overflow: hidden;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .analytics-kpi-card {
            padding: 16px;
        }

        .kpi-value {
            font-size: 22px;
        }

        .forecast-scenario-card {
            padding: 12px;
        }

        .scenario-value {
            font-size: 18px;
        }
    }

    /* Target Status Badge Colors - Matching section3_marketers_performance.html */
    .badge.bg-teal { background-color: #20c997 !important; }
    .badge.bg-indigo { background-color: #6610f2 !important; }
    .badge.bg-purple { background-color: #6f42c1 !important; }
    .badge.bg-orange { background-color: #fd7e14 !important; }
    .badge.bg-coral { background-color: #ff6b6b !important; }

    /* Payment Health Cards */
    .payment-health-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .payment-health-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    .payment-health-card .icon-circle {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Overdue Table Row */
    #overdueClientsTableBody tr {
        transition: background-color 0.2s ease;
    }
    #overdueClientsTableBody tr:hover {
        background-color: rgba(220, 53, 69, 0.05);
    }
    
    /* Collection Rate Progress */
    .collection-rate-progress {
        height: 8px;
        border-radius: 4px;
        background: #e9ecef;
        overflow: hidden;
    }
    .collection-rate-bar {
        height: 100%;
        border-radius: 4px;
        transition: width 1s ease;
    }
</style>

<!-- ==================== ANALYTICS & HISTORICAL RECORDS SCRIPTS ==================== -->
<script>
(function() {
    // State variables
    let analyticsData = {
        currentPeriod: [],
        previousPeriod: [],
        allRecords: []
    };
    let historicalRecords = [];
    let currentPage = 1;
    const recordsPerPage = 15;
    let sortColumn = 'period';
    let sortDirection = 'desc';

    // Initialization flags to prevent duplicate loading
    let analyticsInitialized = false;
    let historicalInitialized = false;
    let isLoadingAnalytics = false;
    let isLoadingHistorical = false;

    // Chart instances
    let revenueTrendChart = null;
    let performanceDistChart = null;
    let monthlyBreakdownChart = null;
    let forecastChart = null;
    let growthVelocityChart = null;
    let seasonalPatternChart = null;
    let yoyComparisonChart = null;
    
    // Payment Health Chart instances
    let paymentStatusChart = null;
    let collectionTrendChart = null;
    let estatePerformanceChart = null;
    
    // Payment Health Data
    let paymentHealthData = {
        transactions: [],
        totalSales: 0,
        collected: 0,
        outstanding: 0,
        overdue: 0,
        overdueClients: []
    };

    // Destroy a chart safely
    function destroyChart(chartInstance) {
        if (chartInstance && typeof chartInstance.destroy === 'function') {
            chartInstance.destroy();
        }
        return null;
    }

    // Initialize when Analytics tab is shown
    document.addEventListener('DOMContentLoaded', function() {
        // Populate year dropdowns
        populateYearDropdowns();
        
        // Initialize Payment Health refresh button
        const refreshPaymentHealthBtn = document.getElementById('refreshPaymentHealthBtn');
        if (refreshPaymentHealthBtn) {
            refreshPaymentHealthBtn.addEventListener('click', function() {
                this.disabled = true;
                this.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Loading...';
                loadPaymentHealthData().finally(() => {
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Refresh';
                });
            });
        }

        // Check for tab query parameter and auto-switch to that tab
        const urlParams = new URLSearchParams(window.location.search);
        const tabParam = urlParams.get('tab');
        if (tabParam) {
            const tabElement = document.getElementById(`${tabParam}-tab`);
            if (tabElement) {
                const tab = new bootstrap.Tab(tabElement);
                tab.show();
            }
        }

        // Tab switch handlers - only init once
        document.getElementById('analytics-tab')?.addEventListener('shown.bs.tab', function() {
            if (!analyticsInitialized) {
                initAnalytics();
                loadPaymentHealthData(); // Load payment health when analytics tab opens
                analyticsInitialized = true;
            }
        });

        document.getElementById('historical-tab')?.addEventListener('shown.bs.tab', function() {
            if (!historicalInitialized) {
                initHistoricalRecords();
                historicalInitialized = true;
            }
        });

        // Event listeners for analytics
        document.getElementById('analyticsApplyBtn')?.addEventListener('click', function() {
            if (!isLoadingAnalytics) loadAnalyticsData();
        });
        document.getElementById('analyticsRefreshBtn')?.addEventListener('click', function() {
            if (!isLoadingAnalytics) loadAnalyticsData();
        });
        
        // Auto-reload when period type or year changes (optional quick filters)
        document.getElementById('analyticsPeriodType')?.addEventListener('change', function() {
            // Reset the analyticsInitialized flag to force reload with new period type
            analyticsInitialized = false;
            if (!isLoadingAnalytics) loadAnalyticsData();
        });
        
        document.getElementById('analyticsYear')?.addEventListener('change', function() {
            // Auto-apply when year changes
            if (!isLoadingAnalytics) loadAnalyticsData();
        });

        // Event listeners for historical records
        document.getElementById('historyApplyBtn')?.addEventListener('click', function() {
            if (!isLoadingHistorical) loadHistoricalRecords();
        });
        document.getElementById('yoyComparisonToggle')?.addEventListener('change', toggleYoYComparison);
        
        // Dynamic filter listeners for Historical Records - auto-reload on change
        document.getElementById('historyStatus')?.addEventListener('change', function() {
            if (!isLoadingHistorical && allHistoricalRecords.length > 0) {
                // Re-apply status filter without reloading from API
                applyStatusFilter();
            } else if (!isLoadingHistorical) {
                // No data loaded yet, show notification
                showNotification('Please load records first using the Search button', 'warning');
            }
        });
        
        document.getElementById('historyPeriodType')?.addEventListener('change', function() {
            // Period type change requires new API fetch
            if (!isLoadingHistorical) loadHistoricalRecords();
        });
        
        document.getElementById('historyMarketer')?.addEventListener('change', function() {
            // Marketer change requires new API fetch
            if (!isLoadingHistorical) loadHistoricalRecords();
        });
        
        // Year dropdowns also trigger reload
        document.getElementById('historyFromYear')?.addEventListener('change', function() {
            if (!isLoadingHistorical) loadHistoricalRecords();
        });
        
        document.getElementById('historyToYear')?.addEventListener('change', function() {
            if (!isLoadingHistorical) loadHistoricalRecords();
        });

        // Export buttons
        document.getElementById('exportCsvBtn')?.addEventListener('click', () => exportHistoricalData('csv'));
        document.getElementById('exportExcelBtn')?.addEventListener('click', () => exportHistoricalData('excel'));
        document.getElementById('exportPdfBtn')?.addEventListener('click', () => exportHistoricalData('pdf'));
        document.getElementById('bulkExportBtn')?.addEventListener('click', bulkExportHistoricalData);
        document.getElementById('analyticsExportBtn')?.addEventListener('click', exportAnalyticsReport);

        // Chart view toggle
        document.querySelectorAll('[data-chart-view]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-chart-view]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                updateRevenueTrendChart(this.dataset.chartView);
            });
        });

        // Table sorting
        document.querySelectorAll('.sortable').forEach(th => {
            th.addEventListener('click', function() {
                const column = this.dataset.sort;
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'desc';
                }
                
                document.querySelectorAll('.sortable').forEach(h => h.classList.remove('asc', 'desc'));
                this.classList.add(sortDirection);
                
                renderHistoricalTable();
            });
        });
        
        // Event delegation for recommendation action buttons (use document for dynamic content)
        document.addEventListener('click', function(e) {
            // Check if click is on a recommendation button
            const btn = e.target.closest('#recommendationsContainer button');
            if (btn) {
                e.preventDefault();
                const actionText = btn.textContent.trim();
                handleRecommendationAction(actionText);
                return;
            }
            
            // Check if click is on a top performer item
            const performerItem = e.target.closest('#topPerformersContainer .top-performer-item');
            if (performerItem) {
                const marketerName = performerItem.querySelector('.performer-name')?.textContent;
                if (marketerName) {
                    showNotification(`Viewing details for ${marketerName}`, 'info');
                }
            }
        });
    });

    // Populate year dropdowns
    // Populate year dropdowns dynamically from API
    async function populateYearDropdowns() {
        try {
            // Fetch available years from API
            const response = await fetch('/api/available-years/');
            let years = [];
            
            if (response.ok) {
                const data = await response.json();
                years = data.years || [];
            }
            
            // Fallback: If API fails or returns empty, generate from current year
            if (years.length === 0) {
                const currentYear = new Date().getFullYear();
                // Default range: 10 years back to 1 year forward
                for (let y = currentYear + 1; y >= currentYear - 10; y--) {
                    years.push(y);
                }
            }

            const analyticsYear = document.getElementById('analyticsYear');
            const compareYear = document.getElementById('analyticsCompareYear');
            const fromYear = document.getElementById('historyFromYear');
            const toYear = document.getElementById('historyToYear');

            // Clear existing options first
            if (analyticsYear) analyticsYear.innerHTML = '';
            if (compareYear) compareYear.innerHTML = '<option value="">No Comparison</option>';
            if (fromYear) fromYear.innerHTML = '';
            if (toYear) toYear.innerHTML = '';

            const currentYear = new Date().getFullYear();
            
            years.forEach((year, idx) => {
                if (analyticsYear) {
                    const opt = document.createElement('option');
                    opt.value = year;
                    opt.textContent = year;
                    if (year === currentYear) opt.selected = true;
                    analyticsYear.appendChild(opt);
                }
                if (compareYear) {
                    const opt = document.createElement('option');
                    opt.value = year;
                    opt.textContent = year;
                    compareYear.appendChild(opt);
                }
                if (fromYear) {
                    const opt = document.createElement('option');
                    opt.value = year;
                    opt.textContent = year;
                    // Select the earliest year for "from"
                    if (idx === years.length - 1) opt.selected = true;
                    fromYear.appendChild(opt);
                }
                if (toYear) {
                    const opt = document.createElement('option');
                    opt.value = year;
                    opt.textContent = year;
                    // Select current year for "to"
                    if (year === currentYear) opt.selected = true;
                    toYear.appendChild(opt);
                }
            });

            // Populate marketer dropdown
            await populateMarketerDropdown();
            
        } catch (err) {
            console.error('Failed to populate year dropdowns:', err);
            // Fallback to static generation
            const currentYear = new Date().getFullYear();
            const years = [];
            for (let y = currentYear + 1; y >= currentYear - 10; y--) {
                years.push(y);
            }
            
            const analyticsYear = document.getElementById('analyticsYear');
            if (analyticsYear) {
                years.forEach(year => {
                    const opt = document.createElement('option');
                    opt.value = year;
                    opt.textContent = year;
                    if (year === currentYear) opt.selected = true;
                    analyticsYear.appendChild(opt);
                });
            }
        }
    }

    // Populate marketer dropdown from API
    async function populateMarketerDropdown() {
        try {
            const response = await fetch('/api/marketers/');
            if (!response.ok) return;
            const data = await response.json();
            const marketers = data.marketers || [];
            
            const dropdown = document.getElementById('historyMarketer');
            if (dropdown) {
                marketers.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = m.full_name;
                    dropdown.appendChild(opt);
                });
            }
        } catch (err) {
            console.error('Failed to load marketers:', err);
        }
    }

    // Initialize Analytics
    function initAnalytics() {
        if (!isLoadingAnalytics) {
            loadAnalyticsData();
        }
    }

    // Load Analytics Data
    async function loadAnalyticsData() {
        if (isLoadingAnalytics) return;
        isLoadingAnalytics = true;
        
        const periodType = document.getElementById('analyticsPeriodType')?.value || 'annual';
        const year = document.getElementById('analyticsYear')?.value || new Date().getFullYear();
        const compareYear = document.getElementById('analyticsCompareYear')?.value || '';
        
        // Show loading state on Apply button
        const applyBtn = document.getElementById('analyticsApplyBtn');
        const refreshBtn = document.getElementById('analyticsRefreshBtn');
        const originalApplyText = applyBtn?.innerHTML || '';
        const originalRefreshText = refreshBtn?.innerHTML || '';
        
        if (applyBtn) {
            applyBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Loading...';
            applyBtn.disabled = true;
        }
        if (refreshBtn) {
            refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            refreshBtn.disabled = true;
        }

        try {
            // Destroy all existing charts first
            revenueTrendChart = destroyChart(revenueTrendChart);
            performanceDistChart = destroyChart(performanceDistChart);
            monthlyBreakdownChart = destroyChart(monthlyBreakdownChart);
            forecastChart = destroyChart(forecastChart);
            growthVelocityChart = destroyChart(growthVelocityChart);
            seasonalPatternChart = destroyChart(seasonalPatternChart);
            
            // Fetch current period data
            const periods = generatePeriods(periodType, year);
            let allData = [];

            for (const period of periods) {
                const response = await fetch(`/api/performance-data/?period_type=${periodType}&specific_period=${period}`);
                if (response.ok) {
                    const result = await response.json();
                    const perfData = result.performance_data || result || [];
                    perfData.forEach(item => {
                        item.period = period;
                        item.period_type = periodType;
                    });
                    allData = allData.concat(perfData);
                }
            }

            analyticsData.currentPeriod = allData;

            // Fetch comparison period data if selected
            if (compareYear) {
                const comparePeriods = generatePeriods(periodType, compareYear);
                let compareData = [];

                for (const period of comparePeriods) {
                    const response = await fetch(`/api/performance-data/?period_type=${periodType}&specific_period=${period}`);
                    if (response.ok) {
                        const result = await response.json();
                        const perfData = result.performance_data || result || [];
                        perfData.forEach(item => {
                            item.period = period;
                            item.period_type = periodType;
                        });
                        compareData = compareData.concat(perfData);
                    }
                }
                analyticsData.previousPeriod = compareData;
            }

            // Update all analytics displays
            updateKPIs();
            renderCharts();
            renderTopPerformers();
            generateRecommendations();
            
            showNotification(`Analytics loaded for ${year} (${periodType})`, 'success');

        } catch (err) {
            console.error('Failed to load analytics data:', err);
            showNotification('Failed to load analytics data. Please try again.', 'warning');
        } finally {
            isLoadingAnalytics = false;
            // Restore button states
            if (applyBtn) {
                applyBtn.innerHTML = originalApplyText;
                applyBtn.disabled = false;
            }
            if (refreshBtn) {
                refreshBtn.innerHTML = originalRefreshText;
                refreshBtn.disabled = false;
            }
        }
    }

    // Generate periods based on type and year
    function generatePeriods(periodType, year) {
        const periods = [];
        if (periodType === 'monthly') {
            for (let m = 1; m <= 12; m++) {
                periods.push(`${year}-${String(m).padStart(2, '0')}`);
            }
        } else if (periodType === 'quarterly') {
            for (let q = 1; q <= 4; q++) {
                periods.push(`${year}-Q${q}`);
            }
        } else {
            periods.push(String(year));
        }
        return periods;
    }

    // Update KPI cards
    function updateKPIs() {
        const data = analyticsData.currentPeriod;
        const prevData = analyticsData.previousPeriod;

        // Calculate totals
        const totalRevenue = data.reduce((sum, item) => sum + (item.total_sales || 0), 0);
        const totalDeals = data.reduce((sum, item) => sum + (item.closed_deals || 0), 0);
        const uniqueMarketers = [...new Set(data.filter(d => d.total_sales > 0).map(d => d.marketer_id))].length;
        
        // Calculate target achievement
        const totalTarget = data.reduce((sum, item) => sum + (item.target_amount || 0), 0);
        const targetAchievement = totalTarget > 0 ? Math.round((totalRevenue / totalTarget) * 100) : 0;

        // Update KPI elements
        document.getElementById('totalRevenueKPI').textContent = `₦${formatNumber(totalRevenue)}`;
        document.getElementById('closedDealsKPI').textContent = totalDeals.toLocaleString();
        document.getElementById('activeMarketersKPI').textContent = uniqueMarketers;
        document.getElementById('targetAchievementKPI').textContent = `${targetAchievement}%`;

        // Calculate and display changes
        if (prevData.length > 0) {
            const prevRevenue = prevData.reduce((sum, item) => sum + (item.total_sales || 0), 0);
            const prevDeals = prevData.reduce((sum, item) => sum + (item.closed_deals || 0), 0);
            const prevMarketers = [...new Set(prevData.filter(d => d.total_sales > 0).map(d => d.marketer_id))].length;

            updateChangeIndicator('revenueChange', totalRevenue, prevRevenue);
            updateChangeIndicator('dealsChange', totalDeals, prevDeals);
            updateChangeIndicator('marketersChange', uniqueMarketers, prevMarketers);
        }

        // Update forecasts
        updateForecasts(totalRevenue);
    }

    // Update change indicator
    function updateChangeIndicator(elementId, current, previous) {
        const element = document.getElementById(elementId);
        if (!element) return;

        const change = previous > 0 ? Math.round(((current - previous) / previous) * 100) : 0;
        const isPositive = change >= 0;

        element.className = `kpi-change ${isPositive ? 'positive' : 'negative'}`;
        element.innerHTML = `<i class="bi bi-arrow-${isPositive ? 'up' : 'down'}"></i> ${isPositive ? '+' : ''}${change}%`;
    }

    // Update forecast values
    function updateForecasts(currentRevenue) {
        const optimistic = currentRevenue * 1.25;
        const realistic = currentRevenue * 1.15;
        const conservative = currentRevenue * 1.05;

        document.getElementById('forecastOptimistic').textContent = `₦${formatNumber(optimistic)}`;
        document.getElementById('forecastRealistic').textContent = `₦${formatNumber(realistic)}`;
        document.getElementById('forecastConservative').textContent = `₦${formatNumber(conservative)}`;
    }

    // Render all charts
    function renderCharts() {
        renderRevenueTrendChart();
        renderPerformanceDistChart();
        renderMonthlyBreakdownChart();
        renderForecastChart();
        renderGrowthVelocityChart();
        renderSeasonalPatternChart();
    }

    // Revenue Trend Chart
    function renderRevenueTrendChart() {
        const ctx = document.getElementById('revenueTrendChart');
        if (!ctx) return;

        const data = analyticsData.currentPeriod;
        const periodData = aggregateByPeriod(data);

        revenueTrendChart = destroyChart(revenueTrendChart);

        revenueTrendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: periodData.labels,
                datasets: [{
                    label: 'Revenue',
                    data: periodData.values,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `₦${formatNumber(ctx.raw)}`
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: (value) => `₦${formatNumber(value)}`
                        }
                    }
                }
            }
        });
    }

    // Update Revenue Trend Chart type
    function updateRevenueTrendChart(chartType) {
        if (!revenueTrendChart) return;
        revenueTrendChart.config.type = chartType === 'bar' ? 'bar' : 'line';
        revenueTrendChart.update();
    }

    // Performance Distribution Chart
    function renderPerformanceDistChart() {
        const ctx = document.getElementById('performanceDistChart');
        if (!ctx) return;

        const data = analyticsData.currentPeriod;
        
        const aboveTarget = data.filter(d => d.target_percent >= 100).length;
        const onTrack = data.filter(d => d.target_percent >= 70 && d.target_percent < 100).length;
        const belowTarget = data.filter(d => d.target_percent < 70 && d.total_sales > 0).length;
        const noSales = data.filter(d => !d.total_sales || d.total_sales === 0).length;

        performanceDistChart = destroyChart(performanceDistChart);

        performanceDistChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Above Target', 'On Track', 'Below Target', 'No Sales'],
                datasets: [{
                    data: [aboveTarget, onTrack, belowTarget, noSales],
                    backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 16 }
                    }
                }
            }
        });
    }

    // Monthly Breakdown Chart
    function renderMonthlyBreakdownChart() {
        const ctx = document.getElementById('monthlyBreakdownChart');
        if (!ctx) return;

        const data = analyticsData.currentPeriod;
        const periodData = aggregateByPeriod(data);

        monthlyBreakdownChart = destroyChart(monthlyBreakdownChart);

        monthlyBreakdownChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: periodData.labels,
                datasets: [{
                    label: 'Revenue',
                    data: periodData.values,
                    backgroundColor: 'rgba(102, 126, 234, 0.8)',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { callback: (v) => `₦${formatNumber(v)}` }
                    }
                }
            }
        });
    }

    // Forecast Chart
    function renderForecastChart() {
        const ctx = document.getElementById('forecastChart');
        if (!ctx) return;

        const currentData = aggregateByPeriod(analyticsData.currentPeriod);
        const avgGrowth = calculateAverageGrowth(currentData.values);

        // Generate forecast for next 6 periods
        const lastValue = currentData.values[currentData.values.length - 1] || 0;
        const forecastLabels = [];
        const forecastValues = [];
        const lowerBound = [];
        const upperBound = [];

        for (let i = 1; i <= 6; i++) {
            forecastLabels.push(`+${i} Month`);
            const forecast = lastValue * Math.pow(1 + avgGrowth, i);
            forecastValues.push(forecast);
            lowerBound.push(forecast * 0.85);
            upperBound.push(forecast * 1.15);
        }

        forecastChart = destroyChart(forecastChart);

        forecastChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: forecastLabels,
                datasets: [
                    {
                        label: 'Forecast',
                        data: forecastValues,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        fill: false,
                        borderDash: [5, 5],
                        tension: 0.4
                    },
                    {
                        label: 'Upper Bound',
                        data: upperBound,
                        borderColor: 'rgba(16, 185, 129, 0.5)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: '+1',
                        tension: 0.4,
                        pointRadius: 0
                    },
                    {
                        label: 'Lower Bound',
                        data: lowerBound,
                        borderColor: 'rgba(239, 68, 68, 0.5)',
                        fill: false,
                        tension: 0.4,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { callback: (v) => `₦${formatNumber(v)}` }
                    }
                }
            }
        });
    }

    // Growth Velocity Chart
    function renderGrowthVelocityChart() {
        const ctx = document.getElementById('growthVelocityChart');
        if (!ctx) return;

        const data = aggregateByPeriod(analyticsData.currentPeriod);
        const growthRates = [];
        
        for (let i = 1; i < data.values.length; i++) {
            const prev = data.values[i - 1];
            const curr = data.values[i];
            const rate = prev > 0 ? ((curr - prev) / prev) * 100 : 0;
            growthRates.push(Math.round(rate));
        }

        growthVelocityChart = destroyChart(growthVelocityChart);

        growthVelocityChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels.slice(1),
                datasets: [{
                    label: 'Growth Rate (%)',
                    data: growthRates,
                    backgroundColor: growthRates.map(r => r >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        ticks: { callback: (v) => `${v}%` }
                    }
                }
            }
        });
    }

    // Seasonal Pattern Chart
    function renderSeasonalPatternChart() {
        const ctx = document.getElementById('seasonalPatternChart');
        if (!ctx) return;

        // Aggregate data by month across all years
        const monthlyTotals = {};
        analyticsData.currentPeriod.forEach(item => {
            if (item.period && item.period.includes('-')) {
                const month = item.period.split('-')[1];
                if (!monthlyTotals[month]) monthlyTotals[month] = 0;
                monthlyTotals[month] += item.total_sales || 0;
            }
        });

        const months = ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'];
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const values = months.map(m => monthlyTotals[m] || 0);

        seasonalPatternChart = destroyChart(seasonalPatternChart);

        seasonalPatternChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: monthNames,
                datasets: [{
                    label: 'Seasonal Revenue',
                    data: values,
                    backgroundColor: 'rgba(220, 53, 69, 0.2)',
                    borderColor: '#dc3545',
                    pointBackgroundColor: '#dc3545'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        ticks: { display: false }
                    }
                }
            }
        });
    }

    // Aggregate data by period
    function aggregateByPeriod(data) {
        const periodTotals = {};
        data.forEach(item => {
            const period = item.period || 'Unknown';
            if (!periodTotals[period]) periodTotals[period] = 0;
            periodTotals[period] += item.total_sales || 0;
        });

        const sorted = Object.entries(periodTotals).sort((a, b) => a[0].localeCompare(b[0]));
        return {
            labels: sorted.map(([period]) => formatPeriodLabel(period)),
            values: sorted.map(([, total]) => total)
        };
    }

    // Format period label
    function formatPeriodLabel(period) {
        if (period.includes('-Q')) {
            return period.replace('-', ' ');
        } else if (period.includes('-')) {
            const [year, month] = period.split('-');
            const date = new Date(year, parseInt(month) - 1, 1);
            return date.toLocaleString('default', { month: 'short', year: '2-digit' });
        }
        return period;
    }

    // Calculate average growth
    function calculateAverageGrowth(values) {
        if (values.length < 2) return 0.05;
        let totalGrowth = 0;
        let count = 0;
        for (let i = 1; i < values.length; i++) {
            if (values[i - 1] > 0) {
                totalGrowth += (values[i] - values[i - 1]) / values[i - 1];
                count++;
            }
        }
        return count > 0 ? totalGrowth / count : 0.05;
    }

    // Render Top Performers
    function renderTopPerformers() {
        const container = document.getElementById('topPerformersContainer');
        if (!container) return;

        const data = analyticsData.currentPeriod;
        
        // Aggregate by marketer - include commission and target data
        const marketerTotals = {};
        data.forEach(item => {
            const id = item.marketer_id;
            if (!marketerTotals[id]) {
                marketerTotals[id] = {
                    name: item.marketer_name,
                    profile_image: item.profile_image,
                    totalSales: 0,
                    totalDeals: 0,
                    commissionRate: item.commission_rate || 0,
                    commissionEarned: 0,
                    targetAmount: 0
                };
            }
            marketerTotals[id].totalSales += item.total_sales || 0;
            marketerTotals[id].totalDeals += item.closed_deals || 0;
            marketerTotals[id].commissionEarned += item.commission_earned || 0;
            marketerTotals[id].targetAmount += item.target_amount || 0;
            // Keep the latest commission rate
            if (item.commission_rate) {
                marketerTotals[id].commissionRate = item.commission_rate;
            }
        });

        const sorted = Object.values(marketerTotals)
            .filter(m => m.totalSales > 0)
            .sort((a, b) => b.totalSales - a.totalSales)
            .slice(0, 5);

        if (sorted.length === 0) {
            container.innerHTML = '<div class="text-center py-4 text-muted">No performance data available</div>';
            return;
        }

        container.innerHTML = sorted.map((m, idx) => {
            const rankClass = idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : 'default';
            // Only show profile image if available, otherwise show initial
            const avatarHtml = m.profile_image 
                ? `<img src="${m.profile_image}" alt="${m.name}" class="performer-avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px;">`
                : `<div class="performer-avatar-initial" style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; margin-right: 10px;"><span class="text-white fw-bold">${m.name?.charAt(0) || 'M'}</span></div>`;
            
            // Commission % styling - matching section3_marketers_performance.html
            const commClass = m.commissionRate >= 10 ? 'text-success fw-bold' : (m.commissionRate > 0 ? 'text-primary' : 'text-muted');
            const commDisplay = m.commissionRate > 0 ? `${m.commissionRate}%` : '<span class="fst-italic">Not Set</span>';
            
            // Target Status calculation - matching section3_marketers_performance.html and Historical Records
            let statusBadge = '';
            const hasData = m.totalSales > 0 || m.totalDeals > 0;
            
            if (m.targetAmount > 0 && hasData) {
                const targetPercent = Math.round((m.totalSales / m.targetAmount) * 100) || 0;
                
                // Target Logic: 0-49% = Below Target, 50-100% = On Target, 101%+ = Above Target
                if (targetPercent > 100) {
                    // Above Target: 101%+
                    const above = targetPercent - 100;
                    if (above <= 10) {
                        statusBadge = `<span class="badge bg-success">${above}% Above Target</span>`;
                    } else if (above <= 25) {
                        statusBadge = `<span class="badge bg-teal">${above}% Above Target</span>`;
                    } else if (above <= 50) {
                        statusBadge = `<span class="badge bg-indigo">${above}% Above Target</span>`;
                    } else {
                        statusBadge = `<span class="badge bg-purple">${above}% Above Target</span>`;
                    }
                } else if (targetPercent >= 50) {
                    // On Target: 50-100%
                    statusBadge = `<span class="badge bg-primary">On Target (${targetPercent}%)</span>`;
                } else {
                    // Below Target: 0-49%
                    if (targetPercent >= 40) {
                        statusBadge = `<span class="badge bg-warning text-dark">Below Target (${targetPercent}%)</span>`;
                    } else if (targetPercent >= 25) {
                        statusBadge = `<span class="badge bg-orange">Below Target (${targetPercent}%)</span>`;
                    } else if (targetPercent >= 10) {
                        statusBadge = `<span class="badge bg-coral">Below Target (${targetPercent}%)</span>`;
                    } else {
                        statusBadge = `<span class="badge bg-danger">Below Target (${targetPercent}%)</span>`;
                    }
                }
            } else if (m.targetAmount > 0 && !hasData) {
                statusBadge = '<span class="badge bg-secondary">No Sales Yet</span>';
            } else {
                statusBadge = '<span class="badge bg-secondary">No Target Set</span>';
            }
            
            return `
                <div class="top-performer-item d-flex align-items-center">
                    <div class="performer-rank ${rankClass}">${idx + 1}</div>
                    ${avatarHtml}
                    <div class="performer-info flex-grow-1">
                        <div class="performer-name">${m.name}</div>
                        <div class="performer-deals">${m.totalDeals} deals closed</div>
                        <div class="performer-target mt-1">${statusBadge}</div>
                    </div>
                    <div class="text-end">
                        <div class="performer-sales fw-bold">₦${formatNumber(m.totalSales)}</div>
                        <div class="performer-commission ${commClass}" style="font-size: 12px;">${commDisplay}</div>
                        <div class="text-success" style="font-size: 11px;">₦${formatNumber(m.commissionEarned)} earned</div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Generate AI Recommendations
    function generateRecommendations() {
        const container = document.getElementById('recommendationsContainer');
        if (!container) return;

        const data = analyticsData.currentPeriod;
        const recommendations = [];

        // Analyze data and generate recommendations
        const marketerTotals = {};
        data.forEach(item => {
            const id = item.marketer_id;
            if (!marketerTotals[id]) {
                marketerTotals[id] = { name: item.marketer_name, sales: 0, target: 0 };
            }
            marketerTotals[id].sales += item.total_sales || 0;
            marketerTotals[id].target += item.target_amount || 0;
        });

        const underperformers = Object.values(marketerTotals).filter(m => m.target > 0 && (m.sales / m.target) < 0.5);
        const topPerformers = Object.values(marketerTotals).filter(m => m.target > 0 && (m.sales / m.target) >= 1);

        // High priority: Underperforming marketers
        if (underperformers.length > 0) {
            recommendations.push({
                priority: 'high',
                icon: 'bi-exclamation-triangle',
                title: `${underperformers.length} Marketer${underperformers.length > 1 ? 's' : ''} Below 50% Target`,
                description: `Schedule performance review meetings with ${underperformers.slice(0, 3).map(m => m.name).join(', ')}${underperformers.length > 3 ? ' and others' : ''} to identify blockers and provide support.`,
                action: 'Schedule Review'
            });
        }

        // Medium priority: Target adjustment
        const avgAchievement = data.reduce((sum, d) => sum + (d.target_percent || 0), 0) / (data.length || 1);
        if (avgAchievement > 90) {
            recommendations.push({
                priority: 'medium',
                icon: 'bi-graph-up-arrow',
                title: 'Consider Increasing Targets',
                description: `Average target achievement is ${Math.round(avgAchievement)}%. Consider raising targets by 15-20% for the next period to drive growth.`,
                action: 'Adjust Targets'
            });
        }

        // Low priority: Recognize top performers
        if (topPerformers.length > 0) {
            recommendations.push({
                priority: 'low',
                icon: 'bi-trophy',
                title: 'Recognize Top Performers',
                description: `${topPerformers.length} marketer${topPerformers.length > 1 ? 's have' : ' has'} exceeded targets. Consider public recognition or bonus incentives to maintain motivation.`,
                action: 'Send Recognition'
            });
        }

        // Growth opportunity
        recommendations.push({
            priority: 'medium',
            icon: 'bi-lightbulb',
            title: 'Seasonal Opportunity Detected',
            description: 'Historical data shows Q4 typically has 25% higher sales. Consider increasing marketing spend and inventory for the upcoming quarter.',
            action: 'View Analysis'
        });

        container.innerHTML = recommendations.map(rec => `
            <div class="col-md-6">
                <div class="recommendation-card ${rec.priority}-priority">
                    <div class="d-flex align-items-start gap-3">
                        <div class="recommendation-icon">
                            <i class="bi ${rec.icon}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="fw-bold mb-1">${rec.title}</h6>
                            <p class="text-muted small mb-2">${rec.description}</p>
                            <button class="btn btn-sm btn-outline-primary recommendation-action-btn" data-action="${rec.action}">
                                <i class="bi bi-arrow-right-circle me-1"></i>${rec.action}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // ==================== HISTORICAL RECORDS ====================

    function initHistoricalRecords() {
        if (!isLoadingHistorical) {
            loadHistoricalRecords();
        }
    }

    async function loadHistoricalRecords() {
        if (isLoadingHistorical) return;
        isLoadingHistorical = true;
        
        const fromYear = document.getElementById('historyFromYear')?.value || new Date().getFullYear() - 2;
        const toYear = document.getElementById('historyToYear')?.value || new Date().getFullYear();
        const periodType = document.getElementById('historyPeriodType')?.value || 'monthly';
        const marketerId = document.getElementById('historyMarketer')?.value || 'all';
        const status = document.getElementById('historyStatus')?.value || 'all';
        
        // Show loading state
        const applyBtn = document.getElementById('historyApplyBtn');
        const originalBtnText = applyBtn?.innerHTML || '';
        if (applyBtn) {
            applyBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Loading...';
            applyBtn.disabled = true;
        }

        try {
            // Destroy the YoY chart before loading new data
            yoyComparisonChart = destroyChart(yoyComparisonChart);
            
            historicalRecords = [];
            
            // Calculate total periods for progress
            const totalYears = parseInt(toYear) - parseInt(fromYear) + 1;
            let processedYears = 0;
            
            // Fetch data for each year in range
            for (let year = parseInt(fromYear); year <= parseInt(toYear); year++) {
                const periods = generatePeriods(periodType, year);
                
                for (const period of periods) {
                    const response = await fetch(`/api/performance-data/?period_type=${periodType}&specific_period=${period}`);
                    if (response.ok) {
                        const result = await response.json();
                        let perfData = result.performance_data || result || [];
                        
                        // Filter by marketer if specified
                        if (marketerId !== 'all') {
                            perfData = perfData.filter(d => String(d.marketer_id) === String(marketerId));
                        }
                        
                        perfData.forEach(item => {
                            item.period = period;
                            item.period_type = periodType;
                        });
                        
                        historicalRecords = historicalRecords.concat(perfData);
                    }
                }
                
                processedYears++;
                // Update progress
                if (applyBtn) {
                    const progress = Math.round((processedYears / totalYears) * 100);
                    applyBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-1"></span>${progress}%`;
                }
            }

            // Store all records before status filtering (for dynamic re-filtering)
            allHistoricalRecords = [...historicalRecords];

            // Filter by status if specified
            if (status !== 'all') {
                historicalRecords = historicalRecords.filter(record => {
                    const achievement = record.target_amount > 0 ? (record.total_sales / record.target_amount) * 100 : 0;
                    if (status === 'above_target') return achievement >= 100;
                    if (status === 'on_track') return achievement >= 70 && achievement < 100;
                    if (status === 'below_target') return achievement < 70;
                    return true;
                });
            }

            // Update summary cards
            updateHistoricalSummary();
            
            // Render table
            currentPage = 1;
            renderHistoricalTable();
            
            // Render YoY comparison chart
            renderYoYComparisonChart();
            
            showNotification(`Loaded ${historicalRecords.length} records from ${fromYear} to ${toYear}`, 'success');

        } catch (err) {
            console.error('Failed to load historical records:', err);
            showNotification('Failed to load historical records. Please try again.', 'warning');
        } finally {
            isLoadingHistorical = false;
            // Restore button state
            if (applyBtn) {
                applyBtn.innerHTML = originalBtnText;
                applyBtn.disabled = false;
            }
        }
    }

    function updateHistoricalSummary() {
        document.getElementById('totalRecordsCount').textContent = historicalRecords.length.toLocaleString();
        
        const fromYear = document.getElementById('historyFromYear')?.value || '';
        const toYear = document.getElementById('historyToYear')?.value || '';
        document.getElementById('dateRangeDisplay').textContent = fromYear === toYear ? fromYear : `${fromYear}-${toYear}`;
        
        const totalRevenue = historicalRecords.reduce((sum, r) => sum + (r.total_sales || 0), 0);
        document.getElementById('periodRevenueDisplay').textContent = `₦${formatNumber(totalRevenue)}`;
        
        const avgCommission = historicalRecords.length > 0
            ? historicalRecords.reduce((sum, r) => sum + (r.commission_rate || 0), 0) / historicalRecords.length
            : 0;
        document.getElementById('avgCommissionDisplay').textContent = `${avgCommission.toFixed(1)}%`;
    }

    // Store all records before status filtering (for dynamic re-filtering)
    let allHistoricalRecords = [];
    
    // Apply status filter dynamically without API call
    function applyStatusFilter() {
        const status = document.getElementById('historyStatus')?.value || 'all';
        
        if (status === 'all') {
            historicalRecords = [...allHistoricalRecords];
        } else {
            historicalRecords = allHistoricalRecords.filter(record => {
                const achievement = record.target_amount > 0 ? (record.total_sales / record.target_amount) * 100 : 0;
                if (status === 'above_target') return achievement >= 100;
                if (status === 'on_track') return achievement >= 70 && achievement < 100;
                if (status === 'below_target') return achievement < 70;
                return true;
            });
        }
        
        // Update summary cards
        updateHistoricalSummary();
        
        // Re-render table with filtered data
        currentPage = 1;
        renderHistoricalTable();
        
        // Update YoY chart with filtered data
        renderYoYComparisonChart();
        
        // Show status label
        const statusLabels = {
            'all': 'All Records',
            'above_target': 'Above Target',
            'on_track': 'On Track',
            'below_target': 'Below Target'
        };
        showNotification(`Showing ${historicalRecords.length} of ${allHistoricalRecords.length} records - ${statusLabels[status] || status}`, 'info');
    }

    function renderHistoricalTable() {
        const tbody = document.getElementById('historicalRecordsBody');
        if (!tbody) return;

        // Sort records
        const sorted = [...historicalRecords].sort((a, b) => {
            let aVal = a[sortColumn];
            let bVal = b[sortColumn];
            
            if (sortColumn === 'sales') { aVal = a.total_sales; bVal = b.total_sales; }
            if (sortColumn === 'deals') { aVal = a.closed_deals; bVal = b.closed_deals; }
            if (sortColumn === 'commission') { aVal = a.commission_earned; bVal = b.commission_earned; }
            if (sortColumn === 'marketer') { aVal = a.marketer_name; bVal = b.marketer_name; }
            
            if (typeof aVal === 'string') {
                return sortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            }
            return sortDirection === 'asc' ? (aVal || 0) - (bVal || 0) : (bVal || 0) - (aVal || 0);
        });

        // Paginate
        const start = (currentPage - 1) * recordsPerPage;
        const end = start + recordsPerPage;
        const pageRecords = sorted.slice(start, end);

        if (pageRecords.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-5 text-muted">No records found for the selected criteria</td></tr>';
            document.getElementById('recordsPagination').textContent = 'Showing 0 records';
            document.getElementById('paginationControls').innerHTML = '';
            return;
        }

        tbody.innerHTML = pageRecords.map(record => {
            const hasData = record.total_sales > 0 || record.closed_deals > 0;
            
            // Calculate target status - same logic as section3_marketers_performance.html
            let statusBadge = '';
            
            if (record.target_amount > 0 && hasData) {
                const targetPercent = Math.round((record.total_sales / record.target_amount) * 100) || 0;
                
                // Target Logic: 0-49% = Below Target, 50-100% = On Target, 101%+ = Above Target
                if (targetPercent > 100) {
                    // Above Target: 101%+
                    const above = targetPercent - 100;
                    if (above <= 10) {
                        statusBadge = `<span class="badge bg-success">${above}% Above Target</span>`;
                    } else if (above <= 25) {
                        statusBadge = `<span class="badge bg-teal">${above}% Above Target</span>`;
                    } else if (above <= 50) {
                        statusBadge = `<span class="badge bg-indigo">${above}% Above Target</span>`;
                    } else {
                        statusBadge = `<span class="badge bg-purple">${above}% Above Target</span>`;
                    }
                } else if (targetPercent >= 50) {
                    // On Target: 50-100%
                    statusBadge = `<span class="badge bg-primary">On Target (${targetPercent}%)</span>`;
                } else {
                    // Below Target: 0-49%
                    if (targetPercent >= 40) {
                        statusBadge = `<span class="badge bg-warning text-dark">Below Target (${targetPercent}%)</span>`;
                    } else if (targetPercent >= 25) {
                        statusBadge = `<span class="badge bg-orange">Below Target (${targetPercent}%)</span>`;
                    } else if (targetPercent >= 10) {
                        statusBadge = `<span class="badge bg-coral">Below Target (${targetPercent}%)</span>`;
                    } else {
                        statusBadge = `<span class="badge bg-danger">Below Target (${targetPercent}%)</span>`;
                    }
                }
            } else if (record.target_amount > 0 && !hasData) {
                statusBadge = '<span class="badge bg-secondary">No Sales Yet</span>';
            } else {
                statusBadge = '<span class="badge bg-secondary">No Target Set</span>';
            }
            
            // Marketer cell with optional profile image
            const marketerCell = record.profile_image 
                ? `<div class="d-flex align-items-center"><img src="${record.profile_image}" alt="${record.marketer_name}" style="width: 28px; height: 28px; border-radius: 50%; object-fit: cover; margin-right: 8px;">${record.marketer_name}</div>`
                : record.marketer_name;

            return `
                <tr>
                    <td><strong>${formatPeriodLabel(record.period)}</strong></td>
                    <td>${marketerCell}</td>
                    <td>${record.closed_deals || 0}</td>
                    <td class="fw-bold">₦${formatNumber(record.total_sales || 0)}</td>
                    <td>${record.commission_rate || 0}%</td>
                    <td class="text-success">₦${formatNumber(record.commission_earned || 0)}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewRecordDetails(${record.marketer_id}, '${record.period}')">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        // Update pagination
        document.getElementById('recordsPagination').textContent = 
            `Showing ${start + 1}-${Math.min(end, sorted.length)} of ${sorted.length} records`;

        // Render pagination controls
        const totalPages = Math.ceil(sorted.length / recordsPerPage);
        const paginationHtml = [];
        
        paginationHtml.push(`<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">«</a>
        </li>`);
        
        for (let p = 1; p <= totalPages; p++) {
            if (p === 1 || p === totalPages || (p >= currentPage - 2 && p <= currentPage + 2)) {
                paginationHtml.push(`<li class="page-item ${p === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${p}); return false;">${p}</a>
                </li>`);
            } else if (p === currentPage - 3 || p === currentPage + 3) {
                paginationHtml.push('<li class="page-item disabled"><span class="page-link">...</span></li>');
            }
        }
        
        paginationHtml.push(`<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">»</a>
        </li>`);
        
        document.getElementById('paginationControls').innerHTML = paginationHtml.join('');
    }

    // Global function for pagination
    window.changePage = function(page) {
        const totalPages = Math.ceil(historicalRecords.length / recordsPerPage);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            renderHistoricalTable();
        }
    };

    // YoY Comparison Chart
    function renderYoYComparisonChart() {
        const ctx = document.getElementById('yoyComparisonChart');
        if (!ctx) return;

        // Group by year
        const yearTotals = {};
        historicalRecords.forEach(record => {
            const year = record.period?.split('-')[0] || 'Unknown';
            if (!yearTotals[year]) yearTotals[year] = 0;
            yearTotals[year] += record.total_sales || 0;
        });

        const sorted = Object.entries(yearTotals).sort((a, b) => a[0].localeCompare(b[0]));

        yoyComparisonChart = destroyChart(yoyComparisonChart);

        yoyComparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sorted.map(([year]) => year),
                datasets: [{
                    label: 'Annual Revenue',
                    data: sorted.map(([, total]) => total),
                    backgroundColor: sorted.map((_, i) => 
                        `rgba(17, 153, 142, ${0.5 + (i * 0.1)})`
                    ),
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { callback: (v) => `₦${formatNumber(v)}` }
                    }
                }
            }
        });
    }

    function toggleYoYComparison() {
        const container = document.getElementById('yoyComparisonContainer');
        const toggle = document.getElementById('yoyComparisonToggle');
        if (container) {
            container.style.display = toggle?.checked ? 'block' : 'none';
        }
    }

    // Export functions
    function exportHistoricalData(format) {
        if (!historicalRecords.length) {
            alert('No data to export');
            return;
        }

        const fromYear = document.getElementById('historyFromYear')?.value || '';
        const toYear = document.getElementById('historyToYear')?.value || '';
        const filename = `historical_records_${fromYear}_${toYear}`;

        if (format === 'csv') {
            let csv = 'Period,Marketer,Closed Deals,Total Sales,Commission %,Commission Earned,Target Status\n';
            historicalRecords.forEach(r => {
                const status = getTargetStatus(r);
                csv += `"${r.period}","${r.marketer_name}",${r.closed_deals || 0},${r.total_sales || 0},${r.commission_rate || 0},${r.commission_earned || 0},"${status}"\n`;
            });
            downloadFile(csv, `${filename}.csv`, 'text/csv');
        } else if (format === 'excel' && typeof XLSX !== 'undefined') {
            const wsData = [['Period', 'Marketer', 'Closed Deals', 'Total Sales', 'Commission %', 'Commission Earned', 'Target Status']];
            historicalRecords.forEach(r => {
                wsData.push([r.period, r.marketer_name, r.closed_deals || 0, r.total_sales || 0, r.commission_rate || 0, r.commission_earned || 0, getTargetStatus(r)]);
            });
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Records');
            XLSX.writeFile(wb, `${filename}.xlsx`);
        } else if (format === 'pdf' && typeof jspdf !== 'undefined') {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`Historical Records (${fromYear}-${toYear})`, 14, 15);
            doc.autoTable({
                head: [['Period', 'Marketer', 'Deals', 'Sales', 'Comm %', 'Earned', 'Status']],
                body: historicalRecords.slice(0, 50).map(r => [
                    r.period, r.marketer_name, r.closed_deals || 0, 
                    `₦${formatNumber(r.total_sales || 0)}`, `${r.commission_rate || 0}%`,
                    `₦${formatNumber(r.commission_earned || 0)}`, getTargetStatus(r)
                ]),
                startY: 25,
                styles: { fontSize: 8 }
            });
            doc.save(`${filename}.pdf`);
        }
    }

    function getTargetStatus(record) {
        // Target Logic: 0-49% = Below Target, 50-100% = On Target, 101%+ = Above Target
        const hasData = record.total_sales > 0 || record.closed_deals > 0;
        
        if (record.target_amount > 0 && hasData) {
            const targetPercent = Math.round((record.total_sales / record.target_amount) * 100) || 0;
            
            if (targetPercent > 100) {
                const above = targetPercent - 100;
                return `${above}% Above Target`;
            } else if (targetPercent >= 50) {
                return `On Target (${targetPercent}%)`;
            } else {
                return `Below Target (${targetPercent}%)`;
            }
        } else if (record.target_amount > 0 && !hasData) {
            return 'No Sales Yet';
        }
        return 'No Target Set';
    }

    function downloadFile(content, filename, type) {
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // View record details - shows a modal or navigates to details page
    window.viewRecordDetails = function(marketerId, period) {
        // Find the record
        const record = historicalRecords.find(r => r.marketer_id === marketerId && r.period === period);
        if (!record) {
            showNotification('Record not found', 'warning');
            return;
        }
        
        // Create and show a details modal
        const hasData = record.total_sales > 0 || record.closed_deals > 0;
        const achievement = record.target_amount > 0 
            ? Math.round((record.total_sales / record.target_amount) * 100) 
            : 0;
        
        // Calculate status class and text - matching section3_marketers_performance.html
        let statusClass = 'secondary';
        let statusText = 'No Target Set';
        
        if (record.target_amount > 0 && hasData) {
            const targetPercent = achievement;
            
            // Target Logic: 0-49% = Below Target, 50-100% = On Target, 101%+ = Above Target
            if (targetPercent > 100) {
                // Above Target: 101%+
                const above = targetPercent - 100;
                if (above <= 10) {
                    statusText = `${above}% Above Target`;
                    statusClass = 'success';
                } else if (above <= 25) {
                    statusText = `${above}% Above Target`;
                    statusClass = 'teal';
                } else if (above <= 50) {
                    statusText = `${above}% Above Target`;
                    statusClass = 'indigo';
                } else {
                    statusText = `${above}% Above Target`;
                    statusClass = 'purple';
                }
            } else if (targetPercent >= 50) {
                // On Target: 50-100%
                statusText = `On Target (${targetPercent}%)`;
                statusClass = 'primary';
            } else {
                // Below Target: 0-49%
                statusText = `Below Target (${targetPercent}%)`;
                if (targetPercent >= 40) {
                    statusClass = 'warning';
                } else if (targetPercent >= 25) {
                    statusClass = 'orange';
                } else if (targetPercent >= 10) {
                    statusClass = 'coral';
                } else {
                    statusClass = 'danger';
                }
            }
        } else if (record.target_amount > 0 && !hasData) {
            statusText = 'No Sales Yet';
            statusClass = 'secondary';
        }
        
        // Progress bar color
        const progressColor = statusClass === 'warning' ? '#ffc107' : 
                              statusClass === 'orange' ? '#fd7e14' : 
                              statusClass === 'coral' ? '#ff6b6b' : 
                              statusClass === 'danger' ? '#dc3545' : 
                              statusClass === 'teal' ? '#20c997' : 
                              statusClass === 'indigo' ? '#6610f2' : 
                              statusClass === 'purple' ? '#6f42c1' : 
                              statusClass === 'success' ? '#28a745' : 
                              statusClass === 'primary' ? '#0d6efd' : '#6c757d';
        
        // Avatar HTML - show profile image if available, otherwise show initial
        const avatarHtml = record.profile_image 
            ? `<img src="${record.profile_image}" alt="${record.marketer_name}" class="mx-auto mb-2" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">`
            : `<div class="avatar-circle mx-auto mb-2" style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;"><span class="text-white fw-bold fs-4">${record.marketer_name?.charAt(0) || 'M'}</span></div>`;
        
        const modalHtml = `
            <div class="modal fade" id="recordDetailsModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header border-0" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                            <h5 class="modal-title text-white">
                                <i class="bi bi-file-earmark-bar-graph me-2"></i>Record Details
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="text-center mb-4">
                                ${avatarHtml}
                                <h5 class="fw-bold mb-1">${record.marketer_name}</h5>
                                <span class="badge bg-secondary">${formatPeriodLabel(record.period)}</span>
                            </div>
                            
                            <div class="row g-3">
                                <div class="col-6">
                                    <div class="p-3 rounded-3 bg-light text-center">
                                        <small class="text-muted d-block">Closed Deals</small>
                                        <h4 class="mb-0 fw-bold text-primary">${record.closed_deals || 0}</h4>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 rounded-3 bg-light text-center">
                                        <small class="text-muted d-block">Total Sales</small>
                                        <h4 class="mb-0 fw-bold text-success">₦${formatNumber(record.total_sales || 0)}</h4>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 rounded-3 bg-light text-center">
                                        <small class="text-muted d-block">Commission Rate</small>
                                        <h4 class="mb-0 fw-bold">${record.commission_rate || 0}%</h4>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 rounded-3 bg-light text-center">
                                        <small class="text-muted d-block">Commission Earned</small>
                                        <h4 class="mb-0 fw-bold text-info">₦${formatNumber(record.commission_earned || 0)}</h4>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="p-3 rounded-3 bg-light">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small class="text-muted">Target Achievement</small>
                                            <span class="badge bg-${statusClass}">${statusText}</span>
                                        </div>
                                        <div class="progress" style="height: 10px;">
                                            <div class="progress-bar" style="width: ${Math.min(achievement, 100)}%; background-color: ${progressColor};"></div>
                                        </div>
                                        <div class="d-flex justify-content-between mt-1">
                                            <small class="text-muted">₦${formatNumber(record.total_sales || 0)}</small>
                                            <small class="text-muted fw-bold">${achievement}%</small>
                                            <small class="text-muted">₦${formatNumber(record.target_amount || 0)}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-0">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="document.getElementById('analytics-tab')?.click(); bootstrap.Modal.getInstance(document.getElementById('recordDetailsModal')).hide();">
                                <i class="bi bi-graph-up me-1"></i>View Analytics
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        document.getElementById('recordDetailsModal')?.remove();
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('recordDetailsModal'));
        modal.show();
        
        // Cleanup when hidden
        document.getElementById('recordDetailsModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    };

    // Bulk export function
    function bulkExportHistoricalData() {
        if (!historicalRecords.length) {
            showNotification('No data to export. Please load records first.', 'warning');
            return;
        }
        
        // Show export format selection
        const formatHtml = `
            <div class="modal fade" id="bulkExportModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered modal-sm">
                    <div class="modal-content border-0 shadow-lg">
                        <div class="modal-header border-0" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                            <h5 class="modal-title text-white">
                                <i class="bi bi-download me-2"></i>Export Data
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p class="text-muted mb-3">Choose export format:</p>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="exportHistoricalData('csv'); bootstrap.Modal.getInstance(document.getElementById('bulkExportModal')).hide();">
                                    <i class="bi bi-filetype-csv me-2"></i>CSV Format
                                </button>
                                <button class="btn btn-outline-success" onclick="exportHistoricalData('excel'); bootstrap.Modal.getInstance(document.getElementById('bulkExportModal')).hide();">
                                    <i class="bi bi-file-earmark-excel me-2"></i>Excel Format
                                </button>
                                <button class="btn btn-outline-danger" onclick="exportHistoricalData('pdf'); bootstrap.Modal.getInstance(document.getElementById('bulkExportModal')).hide();">
                                    <i class="bi bi-filetype-pdf me-2"></i>PDF Format
                                </button>
                            </div>
                            <div class="mt-3 text-center text-muted small">
                                <i class="bi bi-info-circle me-1"></i>${historicalRecords.length} records will be exported
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        document.getElementById('bulkExportModal')?.remove();
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', formatHtml);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('bulkExportModal'));
        modal.show();
    }

    function exportAnalyticsReport() {
        // Export full analytics as PDF or CSV
        const year = document.getElementById('analyticsYear')?.value || new Date().getFullYear();
        const periodType = document.getElementById('analyticsPeriodType')?.value || 'annual';
        
        if (!analyticsData.currentPeriod || analyticsData.currentPeriod.length === 0) {
            showNotification('No analytics data to export. Please apply filters first.', 'warning');
            return;
        }
        
        // Calculate summary metrics
        const totalRevenue = analyticsData.currentPeriod.reduce((sum, item) => sum + (item.total_sales || 0), 0);
        const totalDeals = analyticsData.currentPeriod.reduce((sum, item) => sum + (item.closed_deals || 0), 0);
        const totalCommission = analyticsData.currentPeriod.reduce((sum, item) => sum + (item.commission_earned || 0), 0);
        const uniqueMarketers = [...new Set(analyticsData.currentPeriod.map(d => d.marketer_id))].length;
        
        // Create CSV export
        let csv = `Analytics Report - ${year} (${periodType})\n\n`;
        csv += `Summary Metrics\n`;
        csv += `Total Revenue,₦${formatNumber(totalRevenue)}\n`;
        csv += `Total Deals,${totalDeals}\n`;
        csv += `Total Commission,₦${formatNumber(totalCommission)}\n`;
        csv += `Active Marketers,${uniqueMarketers}\n\n`;
        csv += `Detailed Data\n`;
        csv += `Period,Marketer,Closed Deals,Total Sales,Commission Rate,Commission Earned,Target Amount,Target %\n`;
        
        analyticsData.currentPeriod.forEach(r => {
            csv += `"${r.period || ''}","${r.marketer_name || ''}",${r.closed_deals || 0},${r.total_sales || 0},${r.commission_rate || 0},${r.commission_earned || 0},${r.target_amount || 0},${r.target_percent || 0}\n`;
        });
        
        downloadFile(csv, `analytics_report_${year}_${periodType}.csv`, 'text/csv');
        showNotification('Analytics report exported successfully!', 'success');
    }

    // Handle recommendation action buttons
    function handleRecommendationAction(actionText) {
        switch(actionText) {
            case 'Schedule Review':
                // Navigate to scheduling or show modal
                showNotification('Opening performance review scheduler...', 'info');
                // Could redirect to a scheduling page or open a modal
                // window.location.href = '/admin/schedule-review/';
                break;
            case 'Adjust Targets':
                // Navigate to targets page
                showNotification('Redirecting to target settings...', 'info');
                // Switch to management tab or open marketer settings
                document.getElementById('analytics-tab')?.click();
                break;
            case 'Send Recognition':
                // Open messaging modal or page
                showNotification('Opening recognition message composer...', 'info');
                // Could trigger messaging functionality
                break;
            case 'View Analysis':
                // Scroll to seasonal patterns chart with highlight effect
                const seasonalChart = document.getElementById('seasonalPatternChart');
                if (seasonalChart) {
                    // Find the parent card
                    const parentCard = seasonalChart.closest('.card');
                    
                    // Scroll to the chart
                    seasonalChart.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // Add highlight effect to the card
                    if (parentCard) {
                        parentCard.style.transition = 'all 0.3s ease';
                        parentCard.style.boxShadow = '0 0 20px 5px rgba(102, 126, 234, 0.5)';
                        parentCard.style.transform = 'scale(1.02)';
                        
                        // Remove highlight after 2 seconds
                        setTimeout(() => {
                            parentCard.style.boxShadow = '';
                            parentCard.style.transform = '';
                        }, 2000);
                    }
                    
                    showNotification('Viewing seasonal patterns analysis', 'success');
                } else {
                    showNotification('Seasonal chart not available. Please load analytics data first.', 'warning');
                }
                break;
            default:
                showNotification(`Action: ${actionText}`, 'info');
        }
    }

    // Notification helper
    function showNotification(message, type = 'info') {
        // Create a toast notification
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'info'} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; animation: fadeIn 0.3s ease;';
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                <span>${message}</span>
                <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        document.body.appendChild(toast);
        
        // Auto-remove after 4 seconds
        setTimeout(() => toast.remove(), 4000);
    }

    // Utility function
    function formatNumber(num) {
        return new Intl.NumberFormat('en-NG', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(num);
    }

    function showAnalyticsError(message) {
        console.error(message);
    }

    // ==================== PAYMENT HEALTH FUNCTIONS ====================
    
    async function loadPaymentHealthData() {
        try {
            const response = await fetch('/api/payment-health/');
            if (!response.ok) throw new Error('Failed to load payment health data');
            
            const data = await response.json();
            paymentHealthData = data;
            
            updatePaymentHealthKPIs(data);
            renderPaymentStatusChart(data);
            renderCollectionTrendChart(data);
            renderEstatePerformanceChart(data);
            updatePaymentHealthInsights(data);
            renderOverdueClientsTable(data.overdue_clients || []);
            
        } catch (error) {
            console.error('Error loading payment health:', error);
            // Show fallback message
            document.getElementById('phInsightText').textContent = 
                'Unable to load payment health data. Please refresh to try again.';
        }
    }
    
    function updatePaymentHealthKPIs(data) {
        const totalSales = data.total_sales || 0;
        const collected = data.collected || 0;
        const outstanding = data.outstanding || 0;
        const overdue = data.overdue || 0;
        const collectionRate = totalSales > 0 ? Math.round((collected / totalSales) * 100) : 0;
        
        document.getElementById('phTotalSales').textContent = `₦${formatNumber(totalSales)}`;
        document.getElementById('phTotalCount').textContent = `${data.total_count || 0} transactions`;
        
        document.getElementById('phCollected').textContent = `₦${formatNumber(collected)}`;
        document.getElementById('phCollectionRate').textContent = `${collectionRate}% collection rate`;
        
        document.getElementById('phOutstanding').textContent = `₦${formatNumber(outstanding)}`;
        document.getElementById('phPendingCount').textContent = `${data.pending_count || 0} pending payments`;
        
        document.getElementById('phOverdue').textContent = `₦${formatNumber(overdue)}`;
        document.getElementById('phOverdueCount').textContent = `${data.overdue_count || 0} overdue`;
        
        document.getElementById('overdueClientsBadge').textContent = data.overdue_count || 0;
    }
    
    function renderPaymentStatusChart(data) {
        const ctx = document.getElementById('paymentStatusChart');
        if (!ctx) return;
        
        paymentStatusChart = destroyChart(paymentStatusChart);
        
        const statusData = data.status_distribution || {
            'Fully Paid': 0,
            'Part Payment': 0,
            'Pending': 0,
            'Overdue': 0
        };
        
        paymentStatusChart = new Chart(ctx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(statusData),
                datasets: [{
                    data: Object.values(statusData),
                    backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { boxWidth: 12, padding: 8, font: { size: 11 } }
                    }
                },
                cutout: '60%'
            }
        });
    }
    
    function renderCollectionTrendChart(data) {
        const ctx = document.getElementById('collectionTrendChart');
        if (!ctx) return;
        
        collectionTrendChart = destroyChart(collectionTrendChart);
        
        const trendData = data.monthly_collection || [];
        const labels = trendData.map(item => item.month);
        const values = trendData.map(item => item.amount);
        
        collectionTrendChart = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Collections',
                    data: values,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₦' + formatNumber(value);
                            }
                        }
                    }
                }
            }
        });
    }
    
    function renderEstatePerformanceChart(data) {
        const ctx = document.getElementById('estatePerformanceChart');
        if (!ctx) return;
        
        estatePerformanceChart = destroyChart(estatePerformanceChart);
        
        const estateData = data.estate_sales || [];
        const labels = estateData.map(item => item.estate);
        const values = estateData.map(item => item.sales);
        
        estatePerformanceChart = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Sales',
                    data: values,
                    backgroundColor: [
                        '#667eea', '#764ba2', '#11998e', '#38ef7d', 
                        '#f093fb', '#f5576c', '#4facfe', '#00f2fe'
                    ],
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₦' + formatNumber(value);
                            }
                        }
                    }
                }
            }
        });
    }
    
    function updatePaymentHealthInsights(data) {
        const collectionRate = data.total_sales > 0 
            ? Math.round((data.collected / data.total_sales) * 100) 
            : 0;
        
        let insight = '';
        
        if (collectionRate >= 90) {
            insight = `Excellent! Your collection rate is ${collectionRate}%. Keep up the great work!`;
        } else if (collectionRate >= 70) {
            insight = `Good collection rate of ${collectionRate}%. Consider following up on ${data.pending_count || 0} pending payments to improve further.`;
        } else if (collectionRate >= 50) {
            insight = `Collection rate is ${collectionRate}%. Focus on reducing the ₦${formatNumber(data.outstanding)} outstanding balance. ${data.overdue_count || 0} clients are overdue.`;
        } else {
            insight = `⚠️ Collection rate is low at ${collectionRate}%. Urgent attention needed for ₦${formatNumber(data.overdue)} in overdue payments from ${data.overdue_count || 0} clients.`;
        }
        
        document.getElementById('phInsightText').textContent = insight;
    }
    
    function renderOverdueClientsTable(clients) {
        const tbody = document.getElementById('overdueClientsTableBody');
        if (!tbody) return;
        
        if (!clients || clients.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted py-3">
                        <i class="bi bi-check-circle text-success fs-4 d-block mb-2"></i>
                        No overdue payments. Great job!
                    </td>
                </tr>`;
            return;
        }
        
        tbody.innerHTML = clients.slice(0, 10).map(client => `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="avatar-sm bg-light rounded-circle me-2 d-flex align-items-center justify-content-center">
                            ${client.profile_picture 
                                ? `<img src="${client.profile_picture}" class="rounded-circle" width="32" height="32" alt="">` 
                                : `<span class="text-primary fw-bold">${(client.client_name || 'U').charAt(0)}</span>`
                            }
                        </div>
                        <span>${client.client_name || 'Unknown'}</span>
                    </div>
                </td>
                <td>${client.estate || '-'}</td>
                <td class="text-danger fw-bold">₦${formatNumber(client.outstanding || 0)}</td>
                <td>
                    <span class="badge ${client.days_overdue > 30 ? 'bg-danger' : 'bg-warning text-dark'}">
                        ${client.days_overdue || 0} days
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-warning" 
                            onclick="sendPaymentReminder(${client.transaction_id})"
                            title="Send Reminder">
                        <i class="bi bi-envelope"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    // Send payment reminder (placeholder - connect to actual reminder system)
    window.sendPaymentReminder = function(transactionId) {
        showNotification('Opening reminder dialog for transaction #' + transactionId, 'info');
        // This could open a modal or trigger the existing reminder functionality
    };

    // ==================== TRANSACTION EXPORT FUNCTIONS ====================
    
    let transactionExportData = [];
    
    // Initialize transaction export when panel is opened
    document.getElementById('transactionExportPanel')?.addEventListener('shown.bs.collapse', function() {
        loadTransactionExportFilters();
        updateTransactionExportCount();
    });
    
    // Load filter dropdowns
    async function loadTransactionExportFilters() {
        try {
            const response = await fetch('/api/transaction-export-filters/');
            if (!response.ok) throw new Error('Failed to load filters');
            
            const data = await response.json();
            
            // Populate estates dropdown
            const estateSelect = document.getElementById('txnExportEstate');
            if (estateSelect && data.estates) {
                estateSelect.innerHTML = '<option value="">All Estates</option>';
                data.estates.forEach(estate => {
                    estateSelect.innerHTML += `<option value="${estate}">${estate}</option>`;
                });
            }
            
            // Populate marketers dropdown
            const marketerSelect = document.getElementById('txnExportMarketer');
            if (marketerSelect && data.marketers) {
                marketerSelect.innerHTML = '<option value="">All Marketers</option>';
                data.marketers.forEach(marketer => {
                    marketerSelect.innerHTML += `<option value="${marketer.id}">${marketer.name}</option>`;
                });
            }
            
            // Set default dates (last year to today)
            const today = new Date();
            const lastYear = new Date();
            lastYear.setFullYear(lastYear.getFullYear() - 1);
            
            document.getElementById('txnExportToDate').value = today.toISOString().split('T')[0];
            // Leave from date empty to get all transactions since inception
            
        } catch (error) {
            console.error('Error loading export filters:', error);
        }
    }
    
    // Update transaction count when filters change
    ['txnExportFromDate', 'txnExportToDate', 'txnExportEstate', 'txnExportStatus', 'txnExportMarketer'].forEach(id => {
        document.getElementById(id)?.addEventListener('change', updateTransactionExportCount);
    });
    
    async function updateTransactionExportCount() {
        const countEl = document.getElementById('txnExportCount');
        const valueEl = document.getElementById('txnExportValue');
        
        countEl.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        
        try {
            const params = getExportFilterParams();
            const response = await fetch(`/api/transaction-export-count/?${params}`);
            if (!response.ok) throw new Error('Failed to get count');
            
            const data = await response.json();
            countEl.textContent = `${data.count} transactions`;
            valueEl.textContent = `₦${formatNumber(data.total_value)}`;
            
        } catch (error) {
            countEl.textContent = 'Error loading';
            console.error('Error:', error);
        }
    }
    
    function getExportFilterParams() {
        const params = new URLSearchParams();
        
        const fromDate = document.getElementById('txnExportFromDate').value;
        const toDate = document.getElementById('txnExportToDate').value;
        const estate = document.getElementById('txnExportEstate').value;
        const status = document.getElementById('txnExportStatus').value;
        const marketer = document.getElementById('txnExportMarketer').value;
        
        if (fromDate) params.append('from_date', fromDate);
        if (toDate) params.append('to_date', toDate);
        if (estate) params.append('estate', estate);
        if (status) params.append('status', status);
        if (marketer) params.append('marketer', marketer);
        
        return params.toString();
    }
    
    // Preview button
    document.getElementById('txnPreviewBtn')?.addEventListener('click', async function() {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Loading...';
        
        try {
            const params = getExportFilterParams();
            const response = await fetch(`/api/transaction-export-preview/?${params}`);
            if (!response.ok) throw new Error('Failed to load preview');
            
            const data = await response.json();
            transactionExportData = data.transactions;
            
            renderTransactionPreview(data.transactions);
            document.getElementById('txnPreviewContainer').style.display = 'block';
            
        } catch (error) {
            console.error('Error:', error);
            showNotification('Failed to load preview', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-eye me-1"></i>Preview';
        }
    });
    
    function renderTransactionPreview(transactions) {
        const tbody = document.getElementById('txnPreviewTableBody');
        
        if (!transactions || transactions.length === 0) {
            tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-3">No transactions found matching filters</td></tr>`;
            return;
        }
        
        tbody.innerHTML = transactions.slice(0, 50).map(txn => `
            <tr>
                <td>${txn.date}</td>
                <td>${txn.client}</td>
                <td>${txn.estate}</td>
                <td>${txn.plot_size}</td>
                <td>${txn.marketer}</td>
                <td>₦${formatNumber(txn.total_amount)}</td>
                <td class="text-success">₦${formatNumber(txn.paid)}</td>
                <td class="text-danger">₦${formatNumber(txn.balance)}</td>
                <td>
                    <span class="badge ${getStatusBadgeClass(txn.status)}">${txn.status}</span>
                </td>
            </tr>
        `).join('');
    }
    
    function getStatusBadgeClass(status) {
        switch(status) {
            case 'Fully Paid':
            case 'Paid Complete': return 'bg-success';
            case 'Part Payment': return 'bg-info';
            case 'Pending': return 'bg-warning text-dark';
            case 'Overdue': return 'bg-danger';
            default: return 'bg-secondary';
        }
    }
    
    // Export button
    document.getElementById('txnExportBtn')?.addEventListener('click', async function() {
        const btn = this;
        const format = document.getElementById('txnExportFormat').value;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Exporting...';
        
        try {
            let params = getExportFilterParams();
            // Add format parameter
            params = params ? `${params}&format=${format}` : `format=${format}`;
            
            const response = await fetch(`/api/transaction-export/?${params}`);
            if (!response.ok) throw new Error('Export failed');
            
            // Get filename from response headers or generate one
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = `transactions_export_${new Date().toISOString().split('T')[0]}`;
            
            if (format === 'excel') filename += '.xlsx';
            else if (format === 'csv') filename += '.csv';
            else if (format === 'pdf') filename += '.pdf';
            
            // Download file
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            
            showNotification('Export downloaded successfully!', 'success');
            
        } catch (error) {
            console.error('Error:', error);
            showNotification('Export failed. Please try again.', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-download me-1"></i>Export';
        }
    });

})();
</script>

{% endblock extra_js %}

