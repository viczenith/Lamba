<!-- Marketers Performance Tab -->
<style>
    /* Hide horizontal scrollbar for Performance Records table */
    #ranking .table-responsive {
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE/Edge */
    }
    #ranking .table-responsive::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
    }
</style>
<div class="tab-pane fade show active" id="ranking" role="tabpanel" aria-labelledby="ranking-tab">
    <!-- CSRF Token for AJAX requests -->
    <meta name="csrf-token" content="{{ csrf_token }}">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="card-title mb-0 text-primary">
            <i class="bi bi-trophy-fill me-2"></i>Performance Rankings
        </h3>
        <div>
            <button class="btn btn-info me-2" data-bs-toggle="modal" data-bs-target="#setTargetModal">
                <i class="bi bi-bullseye me-2"></i>Set Targets
            </button>
            <button class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#setCommissionModal">
                <i class="bi bi-percent me-2"></i>Set Commission
            </button>
            <!-- <button class="btn btn-primary" id="exportRankingsBtn">
                <i class="bi bi-download me-2"></i>Export Report
            </button> -->
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="row mb-4 g-3">
        <div class="col-md-4">
            <label for="filterPeriodType" class="form-label">Period Type</label>
            <select class="form-select" id="filterPeriodType">
                <option value="monthly">Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="annual">Annual</option>
            </select>
        </div>
        <div class="col-md-5">
            <label for="filterSpecificPeriod" class="form-label">Select Period</label>
            <select class="form-select" id="filterSpecificPeriod">
                <!-- Options will be populated by JavaScript -->
            </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-outline-secondary w-100" id="resetFilterBtn">
                <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
            </button>
        </div>
    </div>

    <!-- Top 5 Leaderboard -->
    <div class="card mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="bi bi-stars text-warning me-2"></i> Top 5 Performers
            </h5>
            <span class="badge bg-primary" id="leaderboardPeriodLabel">Current Period</span>
        </div>
        <div class="card-body p-0">
            <div class="leaderboard-list" id="leaderboardList">
                <div class="text-center py-5" id="loadingLeaderboard">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading performance data...</p>
                </div>
            </div>
        </div>
        <div class="card-footer bg-light text-center">
            <button class="btn btn-sm btn-outline-primary" id="showAllMarketersBtn">
                <i class="bi bi-arrow-down-circle me-1"></i>Show All Marketers
            </button>
        </div>
    </div>

    <!-- Full Marketers Table -->
    <div class="card mb-4" id="allMarketersTable" style="display: none;">
        <!-- Beautiful Target Overview Section -->
        <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="card-title mb-0 text-white">
                        <i class="bi bi-table me-2"></i>All Marketers Performance - 
                        <span id="tablePeriodLabel">Current Period</span>
                    </h5>
                    <div class="target-overview mt-2">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="target-card bg-white rounded p-3 shadow-sm">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <div class="text-muted small" id="targetTypeLabel">Monthly Target</div>
                                            <div class="h5 mb-0 fw-bold text-primary" id="companyTarget">â‚¦0.00</div>
                                        </div>
                                        <div class="bg-primary rounded-circle p-2">
                                            <i class="bi bi-bullseye text-white"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="target-card bg-white rounded p-3 shadow-sm">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <div class="text-muted small">Total Sales</div>
                                            <div class="h5 mb-0 fw-bold text-success" id="totalSales">â‚¦0.00</div>
                                        </div>
                                        <div class="bg-success rounded-circle p-2">
                                            <i class="bi bi-currency-naira text-white"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="target-card bg-white rounded p-3 shadow-sm">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div>
                                            <div class="text-muted small">Total Marketers</div>
                                            <div class="h5 mb-0 fw-bold text-info" id="totalMarketers">0</div>
                                        </div>
                                        <div class="bg-info rounded-circle p-2">
                                            <i class="bi bi-people text-white"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="progress-overview bg-white rounded p-3 shadow-sm">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">Progress to Target</span>
                            <span class="badge bg-light text-dark" id="progressPercentage">0%</span>
                        </div>
                        <div class="progress" style="height: 20px; background-color: #e9ecef; border-radius: 10px;">
                            <div class="progress-bar" id="targetProgress" role="progressbar" style="width: 0%; border-radius: 10px;">
                            </div>
                        </div>
                        <div class="text-center mt-1">
                            <span class="fw-bold text-dark" id="progressText" style="font-size: 14px;">0%</span>
                        </div>
                        <div class="row mt-2 text-center">
                            <div class="col-4">
                                <div class="text-muted small">Below Target</div>
                                <div class="text-danger fw-bold" id="belowTarget">0</div>
                            </div>
                            <div class="col-4">
                                <div class="text-muted small">On Track</div>
                                <div class="text-warning fw-bold" id="onTrack">0</div>
                            </div>
                            <div class="col-4">
                                <div class="text-muted small">Above Target</div>
                                <div class="text-success fw-bold" id="aboveTarget">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="performanceTable">
                    <thead class="table-light">
                        <tr>
                            <th>Rank</th>
                            <th>Marketer</th>
                            <th>Closed Deals</th>
                            <th>Total Sales (â‚¦)</th>
                            <th>Commission %</th>
                            <th>Commission Earned (â‚¦)</th>
                            <th id="targetStatusHeader">Target Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="loadingTable">
                            <td colspan="8" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading performance data...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="setTargetModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-bullseye me-2"></i>Set Performance Targets</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="targetForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Period Type</label>
                                <select class="form-select" id="periodType" name="period_type" required>
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="annual">Annual</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Select Period</label>
                                <select class="form-select" id="specificPeriod" name="specific_period" required>
                                    <!-- Options injected by JS -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Select Marketer</label>
                            <select class="form-select" id="targetMarketer" name="marketer" disabled required>
                                <option value="all">All Marketers</option>
                                <!-- Marketers injected by JS -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Sales Target (â‚¦)</label>
                            <input type="number" class="form-control" name="target_amount" placeholder="Enter target amount" min="0" step="1000" required>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="notifyMarketer" name="notify">
                            <label class="form-check-label" for="notifyMarketer">
                                Notify marketer about this target
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveTargetBtn">Save Target</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="setCommissionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="bi bi-percent me-2"></i>Set Commission Rate</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="commissionForm">
                        <div class="mb-3">
                            <label class="form-label">Select Marketer</label>
                            <select class="form-select" id="commissionMarketer" name="marketer" required>
                                <!-- <option value="all">All Marketers</option> -->
                                <!-- Marketers injected by JS -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Commission Rate (%)</label>
                            <input type="number" class="form-control" name="commission_rate" 
                                   placeholder="Enter commission percentage" min="0" max="100" step="0.1" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Effective Date</label>
                            <input type="date" class="form-control" name="effective_date" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" id="saveCommissionBtn">Save Commission</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Beautiful Send Message Modal -->
    <div class="modal fade" id="sendMessageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header text-white py-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-send-fill me-2"></i>Send Message to Marketers
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="messageForm">
                        <input type="hidden" id="marketerId" name="marketer_id">
                        <input type="hidden" id="selectedPeriodType" name="period_type">
                        <input type="hidden" id="selectedSpecificPeriod" name="specific_period">
                        
                        <!-- Recipient Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold text-muted small">SEND TO</label>
                            <div class="row g-2 mb-3">
                                <div class="col-md-4">
                                    <div class="form-check recipient-option">
                                        <input class="form-check-input" type="radio" name="recipientType" id="recipientSingle" value="single" checked>
                                        <label class="form-check-label recipient-card p-3 rounded border w-100" for="recipientSingle">
                                            <div class="d-flex align-items-center">
                                                <div class="recipient-icon rounded-circle me-2" id="singleMarketerAvatar" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); overflow: hidden;">
                                                    <span class="text-white fw-bold" id="singleMarketerInitial" style="font-size: 16px;">M</span>
                                                </div>
                                                <div>
                                                    <div class="fw-semibold" id="singleMarketerName">Single Marketer</div>
                                                    <small class="text-muted" id="singleMarketerLabel">Selected marketer only</small>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check recipient-option">
                                        <input class="form-check-input" type="radio" name="recipientType" id="recipientNoSales" value="no_sales">
                                        <label class="form-check-label recipient-card p-3 rounded border w-100" for="recipientNoSales">
                                            <div class="d-flex align-items-center">
                                                <div class="recipient-icon bg-warning bg-opacity-10 rounded-circle p-2 me-2">
                                                    <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-semibold">No Sales</div>
                                                    <small class="text-muted" id="noSalesPeriodLabel">This period</small>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check recipient-option">
                                        <input class="form-check-input" type="radio" name="recipientType" id="recipientAll" value="all">
                                        <label class="form-check-label recipient-card p-3 rounded border w-100" for="recipientAll">
                                            <div class="d-flex align-items-center">
                                                <div class="recipient-icon bg-success bg-opacity-10 rounded-circle p-2 me-2">
                                                    <i class="bi bi-people-fill text-success"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-semibold">All Marketers</div>
                                                    <small class="text-muted" id="allMarketersCount">0 marketers</small>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Single Marketer Display (shown when single is selected) -->
                            <div id="singleRecipientDisplay" class="d-flex align-items-center p-3 bg-light rounded-3 border">
                                <div class="avatar-circle bg-primary text-white me-3" id="recipientAvatar">
                                    <span id="recipientInitial">M</span>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-bold" id="messageRecipientName">Marketer Name</div>
                                    <small class="text-muted" id="messageRecipientEmail">email@example.com</small>
                                </div>
                                <span class="badge bg-primary">Selected</span>
                            </div>
                            
                            <!-- No Sales Recipients Info (shown when no_sales is selected) -->
                            <div id="noSalesRecipientDisplay" class="p-3 rounded-3 d-none" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                <div class="d-flex align-items-center">
                                    <div class="rounded-circle p-2 me-3" style="background: rgba(255,255,255,0.2);">
                                        <i class="bi bi-exclamation-triangle-fill text-white fs-4"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold text-white">Marketers with No Sales</div>
                                        <small class="text-white" style="opacity: 0.9;">
                                            <span id="noSalesCount">0</span> marketers with no sales in 
                                            <strong id="noSalesPeriodDisplay">current period</strong>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- All Marketers Info (shown when all is selected) -->
                            <div id="allRecipientDisplay" class="p-3 rounded-3 d-none" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                <div class="d-flex align-items-center">
                                    <div class="rounded-circle p-2 me-3" style="background: rgba(255,255,255,0.2);">
                                        <i class="bi bi-people-fill text-white fs-4"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold text-white">All Marketers</div>
                                        <small class="text-white" style="opacity: 0.9;">
                                            Message will be sent to all <span id="allMarketersTotal">0</span> marketers
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <input type="hidden" id="messageRecipient" name="recipient">
                        </div>
                        
                        <!-- Quick Message Templates -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold text-muted small">QUICK TEMPLATES</label>
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button" class="btn btn-sm btn-outline-success template-btn" data-template="congratulations">
                                    <i class="bi bi-trophy me-1"></i>Congratulations
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-warning template-btn" data-template="reminder">
                                    <i class="bi bi-alarm me-1"></i>Reminder
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-info template-btn" data-template="motivation">
                                    <i class="bi bi-lightning me-1"></i>Motivation
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary template-btn" data-template="meeting">
                                    <i class="bi bi-calendar-event me-1"></i>Meeting
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger template-btn" data-template="urgent">
                                    <i class="bi bi-bell me-1"></i>Urgent
                                </button>
                            </div>
                        </div>
                        
                        <!-- Subject (for Email) -->
                        <div class="mb-3" id="subjectField">
                            <label class="form-label fw-semibold text-muted small">SUBJECT</label>
                            <input type="text" class="form-control" id="messageSubject" name="subject" placeholder="Enter subject..." value="Performance Update">
                        </div>
                        
                        <!-- Message Content -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold text-muted small">MESSAGE</label>
                            <textarea class="form-control" rows="5" id="messageContent" name="message" placeholder="Type your message here..." required></textarea>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-muted">Use {firstName} for personalization</small>
                                <small class="text-muted"><span id="charCount">0</span>/500</small>
                            </div>
                        </div>
                        
                        <!-- Send Via Options -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold text-muted small">SEND VIA</label>
                            <div class="row g-2">
                                <div class="col-4">
                                    <div class="form-check channel-option">
                                        <input class="form-check-input" type="checkbox" id="sendEmail" name="email" checked>
                                        <label class="form-check-label d-flex flex-column align-items-center p-2 rounded border w-100" for="sendEmail">
                                            <i class="bi bi-envelope-fill text-primary fs-4"></i>
                                            <small class="mt-1">Email</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check channel-option">
                                        <input class="form-check-input" type="checkbox" id="sendSMS" name="sms">
                                        <label class="form-check-label d-flex flex-column align-items-center p-2 rounded border w-100" for="sendSMS">
                                            <i class="bi bi-phone-fill text-success fs-4"></i>
                                            <small class="mt-1">SMS</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="form-check channel-option">
                                        <input class="form-check-input" type="checkbox" id="sendApp" name="app" checked>
                                        <label class="form-check-label d-flex flex-column align-items-center p-2 rounded border w-100" for="sendApp">
                                            <i class="bi bi-bell-fill text-warning fs-4"></i>
                                            <small class="mt-1">In-App</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0 px-4 pb-4">
                    <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn px-4 text-white" id="sendMessageBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="bi bi-send-fill me-2"></i><span id="sendBtnText">Send Message</span>
                        <span class="spinner-border spinner-border-sm ms-2 d-none" id="sendSpinner"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Global state
    let currentPerformanceData = [];
    let marketersList = [];
    let debounceTimer;
    let currentPeriods = [];
    let currentCompanyTarget = 0; // Store company-wide target
    let selectedMarketerData = null; // Store the currently selected marketer from action button

    // Get human-readable period label
    function getPeriodLabel(periodType, specificPeriod) {
        if (periodType === 'monthly') {
            const [year, month] = specificPeriod.split('-');
            const date = new Date(year, month - 1, 1);
            return date.toLocaleString('default', { month: 'long', year: 'numeric' });
        } else if (periodType === 'quarterly') {
            const [year, quarter] = specificPeriod.split('-');
            return `${quarter} ${year}`;
        } else if (periodType === 'annual') {
            return specificPeriod;
        }
        return specificPeriod;
    }

    // Get CSRF token for POST requests
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Populate periods for target modal
    function populateTargetPeriods(periodType, specificPeriodElement) {
        specificPeriodElement.innerHTML = '';
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;
        const currentQuarter = Math.floor((currentMonth - 1) / 3) + 1;

        let periods = [];

        if (periodType === 'monthly') {
            for (let year = currentYear; year >= currentYear - 1; year--) {
                const startMonth = year === currentYear ? 1 : 1;
                const endMonth = year === currentYear ? currentMonth : 12;
                
                for (let month = startMonth; month <= endMonth; month++) {
                    const period = `${year}-${String(month).padStart(2, '0')}`;
                    const label = new Date(year, month - 1, 1).toLocaleString('default', { month: 'long', year: 'numeric' });
                    periods.push({ value: period, label: label });
                }
            }
        } else if (periodType === 'quarterly') {
            for (let year = currentYear; year >= currentYear - 1; year--) {
                const startQuarter = year === currentYear ? 1 : 1;
                const endQuarter = year === currentYear ? currentQuarter : 4;
                
                for (let quarter = startQuarter; quarter <= endQuarter; quarter++) {
                    const period = `${year}-Q${quarter}`;
                    periods.push({ value: period, label: `Q${quarter} ${year}` });
                }
            }
        } else { // annual
            for (let year = currentYear; year >= currentYear - 4; year--) {
                periods.push({ value: String(year), label: String(year) });
            }
        }

        periods.forEach(period => {
            const option = document.createElement('option');
            option.value = period.value;
            option.textContent = period.label;
            specificPeriodElement.appendChild(option);
        });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      try {
          // Load marketers from backend
          const marketersResponse = await fetch('/api/marketers/');
          if (!marketersResponse.ok) throw new Error('Failed to load marketers');
          const response = await marketersResponse.json();
          marketersList = response.marketers || [];
          
          populateMarketerDropdowns();
          populateSpecificPeriods();

          // Initialize date inputs
          const effectiveDateInput = document.querySelector('#setCommissionModal input[name="effective_date"]');
          if (effectiveDateInput) {
              effectiveDateInput.valueAsDate = new Date();
          }

          // Wire up listeners
          setupEventListeners();

          // First load
          updatePerformance();
      } catch (err) {
          console.error(err);
          showToast('Initialization failed: ' + err.message, 'danger');
      }
    });

    // Populate marketer dropdowns
    function populateMarketerDropdowns() {
        const targetDropdown = document.getElementById('targetMarketer');
        targetDropdown.innerHTML = '<option value="all">All Marketers</option>';
        
        marketersList.forEach(m => {
            const option = document.createElement('option');
            option.value = m.id;
            option.textContent = m.full_name;
            targetDropdown.appendChild(option);
        });

        const commissionDropdown = document.getElementById('commissionMarketer');
        commissionDropdown.innerHTML = '';
        
        marketersList.forEach(m => {
            const option = document.createElement('option');
            option.value = m.id;
            option.textContent = m.full_name;
            commissionDropdown.appendChild(option);
        });
    }

    // when the commission select changes, fetch last commission
    document.getElementById('commissionMarketer')
            .addEventListener('change', async function() {
        const marketerId = this.value;
        const rateInput = document.querySelector('#commissionForm input[name="commission_rate"]');
        const dateInput = document.querySelector('#commissionForm input[name="effective_date"]');

        // clear while loading
        rateInput.value = '';
        dateInput.value = '';

        try {
            const res = await fetch(`/api/get-commission/?marketer=${marketerId}`);
            const json = await res.json();
            if (res.ok && json.commission_rate != null) {
                rateInput.value = json.commission_rate;
                dateInput.value = json.effective_date;
            }
        } catch(err) {
            console.error('Could not load commission:', err);
        }
    });

    function populateSpecificPeriods() {
        const type = document.getElementById("filterPeriodType").value;
        const sel  = document.getElementById("filterSpecificPeriod");
        if (!sel) return;
        
        sel.innerHTML = '';

        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;
        const currentQuarter = Math.floor((currentMonth - 1) / 3) + 1;
        
        let opts = [];
        currentPeriods = [];

        if (type === 'monthly') {
            for (let year = currentYear; year >= currentYear - 1; year--) {
                const startMonth = year === currentYear ? 1 : 1;
                const endMonth = year === currentYear ? currentMonth : 12;
                
                for (let month = startMonth; month <= endMonth; month++) {
                    const period = `${year}-${String(month).padStart(2, '0')}`;
                    const d = new Date(year, month - 1, 1);
                    opts.push({ 
                        val: period, 
                        lbl: `${d.toLocaleString('default', {month: 'long'})} ${year}`, 
                        sel: year === currentYear && month === currentMonth
                    });
                    currentPeriods.push(period);
                }
            }
        } else if (type === 'quarterly') {
            for (let year = currentYear; year >= currentYear - 1; year--) {
                const startQuarter = year === currentYear ? 1 : 1;
                const endQuarter = year === currentYear ? currentQuarter : 4;
                
                for (let quarter = startQuarter; quarter <= endQuarter; quarter++) {
                    const period = `${year}-Q${quarter}`;
                    opts.push({ 
                        val: period, 
                        lbl: `Q${quarter} ${year}`, 
                        sel: year === currentYear && quarter === currentQuarter
                    });
                    currentPeriods.push(period);
                }
            }
        } else { // annual
            for (let year = currentYear; year >= currentYear - 4; year--) {
                const period = `${year}`;
                opts.push({ 
                    val: period, 
                    lbl: `${year}`, 
                    sel: year === currentYear
                });
                currentPeriods.push(period);
            }
        }

        opts.forEach(o => {
            const el = document.createElement('option');
            el.value = o.val; 
            el.textContent = o.lbl;
            if (o.sel) el.selected = true;
            sel.append(el);
        });
    }

    // Set up event listeners
    function setupEventListeners(){
        document.getElementById("filterPeriodType").addEventListener('change', () => {
            populateSpecificPeriods();
            updatePerformance();
        });
        
        document.getElementById("filterSpecificPeriod").addEventListener('change', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(updatePerformance, 300);
        });
        
        document.getElementById('resetFilterBtn').addEventListener('click', () => {
            document.getElementById("filterPeriodType").value = 'monthly';
            populateSpecificPeriods();
            updatePerformance();
        });
        
        document.getElementById('showAllMarketersBtn').addEventListener('click', () => {
            const tbl = document.getElementById('allMarketersTable');
            if (tbl) {
                const show = tbl.style.display !== 'block';
                tbl.style.display = show ? 'block' : 'none';
                document.getElementById('showAllMarketersBtn').innerHTML = show
                    ? '<i class="bi bi-arrow-up-circle me-1"></i>Hide Marketers'
                    : '<i class="bi bi-arrow-down-circle me-1"></i>Show All Marketers';
            }
        });
        
        // document.getElementById("exportRankingsBtn")?.addEventListener("click", exportCSV);
        document.getElementById("downloadPdfBtn")?.addEventListener("click", exportPDF);
        document.getElementById("downloadExcelBtn")?.addEventListener("click", exportExcel);
        document.getElementById("saveTargetBtn")?.addEventListener("click", saveTarget);
        document.getElementById("saveCommissionBtn")?.addEventListener("click", saveCommission);
        document.getElementById("sendMessageBtn")?.addEventListener("click", sendMessage);
        
        // Message Modal - Enhanced with recipient selection options
        const messageModal = document.getElementById('sendMessageModal');
        if (messageModal) {
            messageModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const marketerId = button.getAttribute('data-marketer-id');
                const marketerName = button.getAttribute('data-marketer-name');
                const marketerEmail = button.getAttribute('data-marketer-email');
                const profileImage = button.getAttribute('data-profile-image');
                
                // Store selected marketer data globally
                selectedMarketerData = {
                    id: marketerId,
                    name: marketerName,
                    email: marketerEmail,
                    profileImage: profileImage
                };
                
                // Set hidden fields
                document.getElementById('marketerId').value = marketerId;
                document.getElementById('messageRecipient').value = marketerName;
                
                // Store current period info
                const pt = document.getElementById("filterPeriodType").value;
                const sp = document.getElementById("filterSpecificPeriod").value;
                document.getElementById('selectedPeriodType').value = pt;
                document.getElementById('selectedSpecificPeriod').value = sp;
                
                // Update recipient display for single marketer
                document.getElementById('messageRecipientName').textContent = marketerName;
                document.getElementById('messageRecipientEmail').textContent = marketerEmail || 'No email on file';
                
                // Get profile image from currentPerformanceData (more reliable)
                const marketerData = currentPerformanceData.find(m => String(m.marketer_id) === String(marketerId));
                const actualProfileImage = marketerData?.profile_image || profileImage;
                const initial = marketerName.charAt(0).toUpperCase();
                
                // Update the Single Marketer option card with actual marketer info
                const singleMarketerAvatar = document.getElementById('singleMarketerAvatar');
                const singleMarketerName = document.getElementById('singleMarketerName');
                const singleMarketerLabel = document.getElementById('singleMarketerLabel');
                
                singleMarketerName.textContent = marketerName;
                singleMarketerLabel.textContent = marketerEmail || 'Selected marketer';
                
                if (actualProfileImage && actualProfileImage !== 'null' && actualProfileImage.trim() !== '') {
                    singleMarketerAvatar.innerHTML = `<img src="${actualProfileImage}" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">`;
                } else {
                    singleMarketerAvatar.innerHTML = `<span class="text-white fw-bold" style="font-size: 16px;">${initial}</span>`;
                }
                
                // Also update the display section below
                const avatarCircle = document.getElementById('recipientAvatar');
                if (actualProfileImage && actualProfileImage !== 'null' && actualProfileImage.trim() !== '') {
                    avatarCircle.innerHTML = `<img src="${actualProfileImage}" class="rounded-circle" style="width: 45px; height: 45px; object-fit: cover;">`;
                } else {
                    avatarCircle.innerHTML = `<span style="font-size: 18px; font-weight: 600;">${initial}</span>`;
                }
                
                // Calculate counts for recipient options
                const totalMarketers = currentPerformanceData.length;
                const noSalesMarketers = currentPerformanceData.filter(m => !(m.total_sales > 0 || m.closed_deals > 0));
                const noSalesCount = noSalesMarketers.length;
                
                // Update labels
                const periodLabel = getPeriodLabel(pt, sp);
                document.getElementById('noSalesPeriodLabel').textContent = periodLabel;
                document.getElementById('noSalesPeriodDisplay').textContent = periodLabel;
                document.getElementById('noSalesCount').textContent = noSalesCount;
                document.getElementById('allMarketersCount').textContent = `${totalMarketers} marketers`;
                document.getElementById('allMarketersTotal').textContent = totalMarketers;
                
                // Reset to single marketer option
                document.getElementById('recipientSingle').checked = true;
                updateRecipientDisplay('single');
                
                // Clear previous message
                document.getElementById('messageContent').value = '';
                document.getElementById('messageSubject').value = 'Performance Update';
                document.getElementById('charCount').textContent = '0';
                
                // Reset template buttons
                document.querySelectorAll('.template-btn').forEach(b => b.classList.remove('active'));
            });
            
            // Recipient type change handler
            document.querySelectorAll('input[name="recipientType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateRecipientDisplay(this.value);
                });
            });
            
            // Template buttons
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const template = this.dataset.template;
                    const messageContent = document.getElementById('messageContent');
                    const subjectField = document.getElementById('messageSubject');
                    
                    const templates = {
                        congratulations: {
                            subject: 'ðŸŽ‰ Congratulations on Your Achievement!',
                            message: `Dear {firstName},\n\nCongratulations! We are thrilled to recognize your outstanding performance this period.\n\nYour dedication and hard work have truly paid off. Keep up the excellent work!\n\nBest regards,\nManagement Team`
                        },
                        reminder: {
                            subject: 'â° Friendly Reminder - Target Update',
                            message: `Dear {firstName},\n\nThis is a friendly reminder about your current sales targets.\n\nPlease review your progress and let us know if you need any support to achieve your goals.\n\nBest regards,\nManagement Team`
                        },
                        motivation: {
                            subject: 'ðŸ’ª You Can Do It!',
                            message: `Dear {firstName},\n\nWe believe in your potential! Every great achievement starts with the decision to try.\n\nKeep pushing forward - success is just around the corner. We're here to support you every step of the way.\n\nLet's make this period your best yet!\n\nBest regards,\nManagement Team`
                        },
                        meeting: {
                            subject: 'ðŸ“… Meeting Request',
                            message: `Dear {firstName},\n\nWe would like to schedule a brief meeting to discuss your progress and explore ways we can support your success.\n\nPlease let us know your availability this week.\n\nBest regards,\nManagement Team`
                        },
                        urgent: {
                            subject: 'ðŸš¨ Important: Action Required',
                            message: `Dear {firstName},\n\nThis is an important notice requiring your immediate attention.\n\nPlease contact the management team as soon as possible to discuss urgent matters regarding your sales performance.\n\nWe look forward to hearing from you today.\n\nBest regards,\nManagement Team`
                        }
                    };
                    
                    if (templates[template]) {
                        messageContent.value = templates[template].message;
                        subjectField.value = templates[template].subject;
                        document.getElementById('charCount').textContent = templates[template].message.length;
                    }
                    
                    // Highlight active template
                    document.querySelectorAll('.template-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Character counter
            document.getElementById('messageContent').addEventListener('input', function() {
                document.getElementById('charCount').textContent = this.value.length;
            });
        }
        
        // Update target periods when period type changes in modal
        const periodTypeElem = document.getElementById('periodType');
        if (periodTypeElem) {
            periodTypeElem.addEventListener('change', function() {
                const specificPeriodElement = document.getElementById('specificPeriod');
                if (specificPeriodElement) {
                    populateTargetPeriods(this.value, specificPeriodElement);
                }
            });
        }
        
        // Initialize target periods when modal opens
        const targetModal = document.getElementById('setTargetModal');
        if (targetModal) {
            targetModal.addEventListener('show.bs.modal', function() {
                const periodType = document.getElementById('periodType').value;
                const specificPeriodElement = document.getElementById('specificPeriod');
                if (specificPeriodElement) {
                    populateTargetPeriods(periodType, specificPeriodElement);
                }
            });
        }
    }

    // Update recipient display based on selection
    function updateRecipientDisplay(type) {
        const singleDisplay = document.getElementById('singleRecipientDisplay');
        const noSalesDisplay = document.getElementById('noSalesRecipientDisplay');
        const allDisplay = document.getElementById('allRecipientDisplay');
        const sendBtnText = document.getElementById('sendBtnText');
        
        // Hide all displays first
        singleDisplay.classList.add('d-none');
        noSalesDisplay.classList.add('d-none');
        allDisplay.classList.add('d-none');
        
        // Remove active class from all recipient cards
        document.querySelectorAll('.recipient-card').forEach(card => {
            card.classList.remove('active');
        });
        
        // Show the appropriate display and update button text
        switch(type) {
            case 'single':
                singleDisplay.classList.remove('d-none');
                sendBtnText.textContent = 'Send Message';
                document.querySelector('label[for="recipientSingle"]').classList.add('active');
                break;
            case 'no_sales':
                noSalesDisplay.classList.remove('d-none');
                const noSalesCount = document.getElementById('noSalesCount').textContent;
                sendBtnText.textContent = `Send to ${noSalesCount} Marketers`;
                document.querySelector('label[for="recipientNoSales"]').classList.add('active');
                break;
            case 'all':
                allDisplay.classList.remove('d-none');
                const allCount = document.getElementById('allMarketersTotal').textContent;
                sendBtnText.textContent = `Send to All ${allCount} Marketers`;
                document.querySelector('label[for="recipientAll"]').classList.add('active');
                break;
        }
    }

    async function updatePerformance() {
        try {
            // Show loaders
            const leaderboardLoading = document.getElementById("loadingLeaderboard");
            const tableLoading = document.getElementById("loadingTable");
            
            if (leaderboardLoading) leaderboardLoading.style.display = 'block';
            if (tableLoading) tableLoading.style.display = 'table-row';

            const pt = document.getElementById("filterPeriodType").value;
            const sp = document.getElementById("filterSpecificPeriod").value;
            
            // Fetch from backend
            const response = await fetch(`/api/performance-data/?period_type=${pt}&specific_period=${sp}`);
            if (!response.ok) throw new Error('Network response was not ok');
            const apiResponse = await response.json();
            
            // Handle new response format
            if (apiResponse.performance_data) {
                currentPerformanceData = apiResponse.performance_data;
                currentCompanyTarget = apiResponse.company_target || 0;
            } else {
                // Backward compatibility: old format returned array directly
                currentPerformanceData = apiResponse;
                currentCompanyTarget = 0;
            }
            
            // Get period label
            const periodLabel = getPeriodLabel(pt, sp);
            document.getElementById("leaderboardPeriodLabel").textContent = periodLabel;
            document.getElementById("tablePeriodLabel").textContent = periodLabel;
            
            // Update target type label based on period type
            const targetTypeLabel = document.getElementById("targetTypeLabel");
            if (targetTypeLabel) {
                if (pt === 'monthly') {
                    targetTypeLabel.textContent = 'Monthly Target';
                } else if (pt === 'quarterly') {
                    targetTypeLabel.textContent = 'Quarterly Target';
                } else if (pt === 'annual') {
                    targetTypeLabel.textContent = 'Annual Target';
                }
            }
            
            // Update target label
            updateTargetLabel(currentPerformanceData);
            
            // Render both sections
            renderLeaderboard(currentPerformanceData);
            renderFullTable(currentPerformanceData, pt, sp);

        } catch(err) {
            console.error("Performance data error:", err);
            showToast('Failed to load performance data: ' + err.message, 'danger');
            
            // Clear any existing data
            const leaderboardList = document.getElementById("leaderboardList");
            if (leaderboardList) {
                leaderboardList.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-exclamation-circle display-6"></i>
                        <p class="mt-3">Failed to load performance data</p>
                    </div>`;
            }
            
            const tableBody = document.querySelector("#performanceTable tbody");
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr><td colspan="8" class="text-center py-5 text-muted">
                        <i class="bi bi-exclamation-circle display-6"></i>
                        <p class="mt-3">Failed to load performance data</p>
                    </td></tr>`;
            }
        } finally {
            // Hide loaders
            const leaderboardLoading = document.getElementById("loadingLeaderboard");
            const tableLoading = document.getElementById("loadingTable");
            
            if (leaderboardLoading) leaderboardLoading.style.display = 'none';
            if (tableLoading) tableLoading.style.display = 'none';
        }
    }

  

  // Calculate target label
    function updateTargetLabel(data) {
        const targetLabel = document.getElementById("tableTargetLabel");
        if (!targetLabel) return;

        // Extract only marketers with targets
        const targets = data
            .map(item => item.target_amount || 0)
            .filter(amount => amount > 0);

        if (targets.length) {
            // Calculate average target
            const sum = targets.reduce((sum, amt) => sum + amt, 0);
            const avgTarget = sum / targets.length;
            targetLabel.textContent = `Target: â‚¦${formatNumber(avgTarget)}`;
            targetLabel.className = "ms-2 text-success fw-bold";
        } else {
            targetLabel.textContent = 'No Target Set';
            targetLabel.className = "ms-2 text-muted";
        }
    }

    // Update target overview section
    function updateTargetOverview(data) {
        // Calculate totals and statistics
        const totalSales = data.reduce((sum, item) => sum + (item.total_sales || 0), 0);
        
        // Use company-wide target for the selected period
        const companyTarget = currentCompanyTarget;
        
        // Calculate progress percentage based on company target (total sales vs company target)
        const progressPercent = companyTarget > 0 ? Math.min(100, (totalSales / companyTarget) * 100) : 0;
        
        // Count marketers by their performance against the FULL COMPANY TARGET
        // Each marketer is working towards achieving the same company target
        const activeMarketers = data.filter(item => item.total_sales > 0 || item.closed_deals > 0);
        
        let belowTarget = 0;
        let onTrack = 0;
        let aboveTarget = 0;
        
        if (companyTarget > 0 && activeMarketers.length > 0) {
            activeMarketers.forEach(item => {
                // Each marketer is measured against the FULL company target
                const percentAchieved = (item.total_sales / companyTarget) * 100;
                if (percentAchieved < 90) {
                    belowTarget++;
                } else if (percentAchieved >= 90 && percentAchieved < 100) {
                    onTrack++;
                } else {
                    aboveTarget++;
                }
            });
        }
        
        // Total marketers count
        const totalMarketers = data.length;

        // Update DOM elements
        const companyTargetEl = document.getElementById('companyTarget');
        const totalSalesEl = document.getElementById('totalSales');
        const totalMarketersEl = document.getElementById('totalMarketers');
        const progressPercentageEl = document.getElementById('progressPercentage');
        const targetProgressEl = document.getElementById('targetProgress');
        const progressTextEl = document.getElementById('progressText');
        const belowTargetEl = document.getElementById('belowTarget');
        const onTrackEl = document.getElementById('onTrack');
        const aboveTargetEl = document.getElementById('aboveTarget');

        // Update company target display
        if (companyTargetEl) {
            if (companyTarget > 0) {
                companyTargetEl.textContent = `â‚¦${formatNumber(companyTarget)}`;
            } else {
                companyTargetEl.textContent = 'Not Set';
            }
        }
        
        if (totalSalesEl) totalSalesEl.textContent = `â‚¦${formatNumber(totalSales)}`;
        if (totalMarketersEl) totalMarketersEl.textContent = totalMarketers;
        if (progressPercentageEl) progressPercentageEl.textContent = `${Math.round(progressPercent)}%`;
        
        // Update progress bar with vibrant colors
        if (targetProgressEl) {
            targetProgressEl.style.width = `${progressPercent}%`;
            // Update progress bar color based on achievement
            if (progressPercent < 30) {
                targetProgressEl.style.background = '#dc3545'; // Red
            } else if (progressPercent < 50) {
                targetProgressEl.style.background = '#fd7e14'; // Orange
            } else if (progressPercent < 70) {
                targetProgressEl.style.background = '#ffc107'; // Yellow
            } else if (progressPercent < 90) {
                targetProgressEl.style.background = '#20c997'; // Teal
            } else {
                targetProgressEl.style.background = '#28a745'; // Green
            }
        }
        
        if (progressTextEl) {
            progressTextEl.textContent = `${Math.round(progressPercent)}%`;
            // Color the text based on performance
            if (progressPercent < 50) {
                progressTextEl.style.color = '#dc3545';
            } else if (progressPercent < 80) {
                progressTextEl.style.color = '#fd7e14';
            } else {
                progressTextEl.style.color = '#28a745';
            }
        }
        
        if (belowTargetEl) belowTargetEl.textContent = belowTarget;
        if (onTrackEl) onTrackEl.textContent = onTrack;
        if (aboveTargetEl) aboveTargetEl.textContent = aboveTarget;
    }


    // Render leaderboard
    function renderLeaderboard(data) {
        const container = document.getElementById("leaderboardList");
        if (!container) return;
        
        container.innerHTML = '';
        
        if (!data || data.length === 0) {
            return container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-exclamation-circle display-6"></i>
                    <p class="mt-3">No performance records for the selected period</p>
                </div>`;
        }
        
        // Filter marketers with actual performance
        const performers = data.filter(item => item.total_sales > 0 || item.closed_deals > 0);
        
        if (performers.length === 0) {
            return container.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-exclamation-circle display-6"></i>
                    <p class="mt-3">No performers for the selected period</p>
                </div>`;
        }
        
        // Sort by total sales (descending) and take top 5
        performers.sort((a, b) => b.total_sales - a.total_sales).slice(0, 5)
            .forEach((item, index) => {
                const rank = index + 1;
                const div = document.createElement('div');
                div.className = 'leaderboard-item p-3 border-bottom';
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="rank-badge bg-${getRankColor(rank)} text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width:36px;height:36px;">
                                <span class="fw-bold">${rank}</span>
                            </div>
                            <div>
                                <h6 class="mb-0">${item.marketer_name}</h6>
                                <small class="text-muted">${item.closed_deals} deals</small>
                            </div>
                        </div>
                        <div class="text-end">
                            <h5 class="mb-0 text-primary">â‚¦${formatNumber(item.total_sales)}</h5>
                            <small class="text-success">
                                <i class="bi bi-arrow-up"></i> ${formatNumber(item.commission_earned)} earned
                            </small>
                        </div>
                    </div>`;
                container.append(div);
            });
    }

    // Render full table with all marketers
    function renderFullTable(data, periodType, specificPeriod) {
        const tbody = document.querySelector("#performanceTable tbody");
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        // Dynamically update the Target Status column header based on period type
        const targetStatusHeader = document.getElementById('targetStatusHeader');
        if (targetStatusHeader) {
            if (periodType === 'monthly') {
                targetStatusHeader.textContent = 'Monthly Target Status';
            } else if (periodType === 'quarterly') {
                targetStatusHeader.textContent = 'Quarterly Target Status';
            } else if (periodType === 'annual') {
                targetStatusHeader.textContent = 'Annual Target Status';
            } else {
                targetStatusHeader.textContent = 'Target Status';
            }
        }
        
        if (!data || data.length === 0) {
            return tbody.innerHTML = `
                <tr><td colspan="8" class="text-center py-5 text-muted">
                    <i class="bi bi-exclamation-circle display-6"></i>
                    <p class="mt-3">No performance records for the selected period</p>
                </td></tr>`;
        }
        
        // Update target overview section
        updateTargetOverview(data);
        
        // Separate marketers with data and without
        const marketersWithData = data.filter(item => item.total_sales > 0 || item.closed_deals > 0);
        const marketersWithoutData = data.filter(item => !(item.total_sales > 0 || item.closed_deals > 0));
        
        // Sort marketers with data by total sales (descending)
        marketersWithData.sort((a, b) => b.total_sales - a.total_sales);
        
        // Combine both lists
        const sortedData = [...marketersWithData, ...marketersWithoutData];
        
        let rank = 1;
        
        sortedData.forEach((item) => {
            const hasData = item.total_sales > 0 || item.closed_deals > 0;
            const commClass = item.commission_rate >= 10 ? 'text-success fw-bold' : 'text-primary';
            
            // Calculate target status for this marketer against the FULL COMPANY TARGET
            // Every marketer is working towards achieving the same company target
            // Target Logic: Below Target (<50%), On Target (50-100%), Above Target (>100%)
            let targetStatus = '';
            let targetClass = '';
            
            if (currentCompanyTarget > 0 && hasData) {
                const targetPercent = Math.round((item.total_sales / currentCompanyTarget) * 100) || 0;
                
                if (targetPercent > 100) {
                    const above = targetPercent - 100;
                    if (above <= 10) {
                        targetStatus = `${above}% Above`;
                        targetClass = 'bg-success';
                    } else if (above <= 25) {
                        targetStatus = `${above}% Above`;
                        targetClass = 'bg-teal';
                    } else if (above <= 50) {
                        targetStatus = `${above}% Above`;
                        targetClass = 'bg-indigo';
                    } else {
                        targetStatus = `${above}% Above`;
                        targetClass = 'bg-purple';
                    }
                } else if (targetPercent >= 50) {
                    // On Target: 50% - 100%
                    targetStatus = `On Target (${targetPercent}%)`;
                    targetClass = 'bg-primary';
                } else {
                    // Below Target: 0% - 49%
                    const below = 100 - targetPercent;
                    if (below <= 25) {
                        targetStatus = `${below}% Below`;
                        targetClass = 'bg-warning';
                    } else if (below <= 50) {
                        targetStatus = `${below}% Below`;
                        targetClass = 'bg-orange';
                    } else if (below <= 75) {
                        targetStatus = `${below}% Below`;
                        targetClass = 'bg-coral';
                    } else {
                        targetStatus = `${below}% Below`;
                        targetClass = 'bg-danger';
                    }
                }
            } else if (currentCompanyTarget > 0 && !hasData) {
                targetStatus = 'No Sales Yet';
                targetClass = 'bg-secondary';
            } else {
                targetStatus = 'No Target Set';
                targetClass = 'bg-secondary';
            }

            const rowClass = hasData ? '' : 'no-data-row';
            
            // Generate avatar - use profile image if available, else show initial
            let avatarHtml = '';
            const initial = item.marketer_name.charAt(0).toUpperCase();
            if (item.profile_image && item.profile_image !== 'null' && item.profile_image.trim() !== '') {
                avatarHtml = `<img src="${item.profile_image}" alt="${item.marketer_name}" class="avatar-img rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover; border: 2px solid #e2e8f0;">`;
            } else {
                avatarHtml = `<div class="avatar-placeholder rounded-circle me-2" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <span class="text-white fw-bold" style="font-size: 14px;">${initial}</span>
                </div>`;
            }
            
            // Get marketer email from marketersList
            const marketerInfo = marketersList.find(m => m.id === item.marketer_id) || {};
            const marketerEmail = marketerInfo.email || '';
            
            tbody.insertAdjacentHTML('beforeend', `
                <tr class="${rowClass}">
                    <td>${hasData ? rank++ : '-'}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            ${avatarHtml}
                            ${item.marketer_name}
                        </div>
                    </td>
                    <td>${hasData ? item.closed_deals : '-'}</td>
                    <td class="fw-bold">${hasData ? `â‚¦${formatNumber(item.total_sales)}` : '-'}</td>
                    <td class="${commClass}">${hasData ? `${item.commission_rate}%` : '-'}</td>
                    <td class="text-success fw-bold">${hasData ? `â‚¦${formatNumber(item.commission_earned)}` : '-'}</td>
                    <td>
                        <span class="badge ${targetClass}">${targetStatus}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary message-btn" 
                            data-bs-toggle="modal" 
                            data-bs-target="#sendMessageModal" 
                            data-marketer-id="${item.marketer_id}"
                            data-marketer-name="${item.marketer_name}" 
                            data-marketer-email="${marketerEmail}"
                            data-profile-image="${item.profile_image || ''}"
                            ${!hasData ? 'disabled' : ''}>
                            <i class="bi bi-send"></i>
                        </button>
                    </td>
                </tr>`);
        });
    }

    // Get rank color
    function getRankColor(rank) {
        if (rank === 1) return 'gold';
        if (rank === 2) return 'silver';
        if (rank === 3) return 'bronze';
        return 'primary';
    }

    // Format numbers with commas
    function formatNumber(num) {
        return new Intl.NumberFormat('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(num);
    }

    // target prefill
    async function fetchAndPrefillTarget() {
        const form = document.getElementById('targetForm');
        const marketerSelect = document.getElementById('targetMarketer');
        const amountInput = form.querySelector('input[name="target_amount"]');
        const periodType = form.period_type.value;
        const specificPeriod = form.specific_period.value;
        
        if (!periodType || !specificPeriod) return;
        
        amountInput.value = '';
        const marketerId = marketerSelect.value;

        try {
            const url = `/api/get-target/?period_type=${periodType}&specific_period=${encodeURIComponent(specificPeriod)}&marketer=${marketerId}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch target');
            
            const data = await response.json();
            if (data.target_amount) {
                amountInput.value = data.target_amount;
            }
        } catch (error) {
            console.error('Error fetching target:', error);
        }
    }


    // â€” Event wiring â€”

    // 1) When the modal opens
    document.getElementById('setTargetModal')
      .addEventListener('show.bs.modal', () => {
        // First populate the specificPeriod options
        const ptElem = document.getElementById('periodType');
        const spElem = document.getElementById('specificPeriod');
        populateTargetPeriods(ptElem.value, spElem);

        // Then prefill the Sales Target field
        fetchAndPrefillTarget();
      });

    // 2) When marketer changes
    document.getElementById('targetMarketer')
      .addEventListener('change', fetchAndPrefillTarget);

    // 3) When period type changes
    document.getElementById('periodType')
      .addEventListener('change', () => {
        const spElem = document.getElementById('specificPeriod');
        populateTargetPeriods(document.getElementById('periodType').value, spElem);
        fetchAndPrefillTarget();
      });

    // 4) When specific period changes
    document.getElementById('specificPeriod')
      .addEventListener('change', fetchAndPrefillTarget);
      

    async function saveTarget() {
      const form = document.getElementById("targetForm");
      const payload = {
        period_type: form.period_type.value,
        specific_period: form.specific_period.value,
        marketer: form.marketer.value,
        target_amount: Number(form.target_amount.value)
      };

      try {
        // Try to get CSRF token from cookie first
        let csrftoken = getCookie('csrftoken');
        
        // If not found in cookie, try to get from meta tag (Django's standard approach)
        if (!csrftoken) {
          const csrfTokenMeta = document.querySelector('meta[name=csrf-token]');
          if (csrfTokenMeta) {
            csrftoken = csrfTokenMeta.getAttribute('content');
          }
        }
        
        // If still not found, try to get from window.csrf_token (alternative approach)
        if (!csrftoken && window.csrf_token) {
          csrftoken = window.csrf_token;
        }
        
        // Debug: Check if CSRF token exists
        if (!csrftoken) {
          throw new Error('CSRF token not found. Please refresh the page and try again.');
        }
        
        // Debug: Check CSRF token length
        if (csrftoken.length < 10) {
          throw new Error('CSRF token appears to be invalid. Please refresh the page and try again.');
        }
        
        const res = await fetch('/api/set-target/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        if (!res.ok || result.status !== 'success') {
          throw new Error(result.message || 'Failed to set target');
        }
        showToast('Target set successfully!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('setTargetModal')).hide();
        form.reset();
        updatePerformance();
      } catch (err) {
        console.error('Save target error:', err);
        showToast('Failed to set target: ' + err.message, 'danger');
      }
    }

    async function saveCommission() {
        const form = document.getElementById("commissionForm");
        const payload = {
            marketer: form.marketer.value,
            commission_rate: Number(form.commission_rate.value),
            effective_date: form.effective_date.value
        };

        try {
            const csrftoken = getCookie('csrftoken');
            const response = await fetch('/api/set-commission/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(payload)
            });
            
            const result = await response.json();
            
            if (!response.ok || result.status !== 'success') {
                throw new Error(result.message || 'Failed to set commission');
            }
            
            showToast('Commission updated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('setCommissionModal')).hide();
            form.reset();
            updatePerformance();
        } catch (error) {
            console.error('Commission error:', error);
            showToast(`Failed to set commission: ${error.message}`, 'danger');
        }
    }

    async function sendMessage() {
        const form = document.getElementById("messageForm");
        const sendBtn = document.getElementById('sendMessageBtn');
        const spinner = document.getElementById('sendSpinner');
        
        // Validate at least one channel is selected
        const sendEmail = document.getElementById('sendEmail').checked;
        const sendSMS = document.getElementById('sendSMS').checked;
        const sendApp = document.getElementById('sendApp').checked;
        
        if (!sendEmail && !sendSMS && !sendApp) {
            showToast('Please select at least one channel to send the message', 'warning');
            return;
        }
        
        const message = document.getElementById('messageContent').value.trim();
        if (!message) {
            showToast('Please enter a message', 'warning');
            return;
        }
        
        // Get recipient type
        const recipientType = document.querySelector('input[name="recipientType"]:checked').value;
        
        // Build payload based on recipient type
        const payload = {
            subject: document.getElementById('messageSubject').value,
            message: message,
            channels: {
                email: sendEmail,
                sms: sendSMS,
                app: sendApp
            },
            recipient_type: recipientType,
            period_type: document.getElementById('selectedPeriodType').value,
            specific_period: document.getElementById('selectedSpecificPeriod').value
        };
        
        // Add marketer_id only for single recipient
        if (recipientType === 'single') {
            payload.marketer_id = document.getElementById('marketerId').value;
        } else if (recipientType === 'no_sales') {
            // Get IDs of marketers with no sales in the current period
            const noSalesMarketers = currentPerformanceData.filter(m => !(m.total_sales > 0 || m.closed_deals > 0));
            payload.marketer_ids = noSalesMarketers.map(m => m.marketer_id);
        } else if (recipientType === 'all') {
            // Get all marketer IDs
            payload.marketer_ids = currentPerformanceData.map(m => m.marketer_id);
        }
        
        try {
            // Show loading state
            sendBtn.disabled = true;
            spinner.classList.remove('d-none');
            
            // Get CSRF token
            let csrftoken = getCookie('csrftoken');
            if (!csrftoken) {
                const csrfTokenMeta = document.querySelector('meta[name=csrf-token]');
                if (csrfTokenMeta) csrftoken = csrfTokenMeta.getAttribute('content');
            }
            
            const response = await fetch('/api/send-marketer-message/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(payload)
            });
            
            const result = await response.json();
            
            if (!response.ok || result.status !== 'success') {
                throw new Error(result.message || 'Failed to send message');
            }
            
            // Show success with details
            let successMsg = '';
            if (recipientType === 'single') {
                successMsg = 'Message sent successfully';
            } else {
                const sentCount = result.sent_count || 0;
                const totalCount = result.total_count || 0;
                successMsg = `Message sent to ${sentCount}/${totalCount} marketers`;
            }
            
            // Add channel info
            const channels = [];
            if (result.email_sent || result.emails_sent > 0) channels.push('Email');
            if (result.sms_sent || result.sms_count > 0) channels.push('SMS');
            if (result.app_sent || result.app_count > 0) channels.push('In-App');
            if (channels.length) {
                successMsg += ` via ${channels.join(', ')}`;
            }
            
            showToast(successMsg, 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('sendMessageModal'));
            if (modal) modal.hide();
            
            form.reset();
            document.getElementById('charCount').textContent = '0';
            document.getElementById('recipientSingle').checked = true;
            
        } catch (error) {
            console.error('Message error:', error);
            showToast('Failed to send message: ' + error.message, 'danger');
        } finally {
            // Reset button state
            sendBtn.disabled = false;
            spinner.classList.add('d-none');
        }
    }

    // Export functions
    function exportCSV() {
        if (!currentPerformanceData.length) {
            showToast('No data to export', 'warning');
            return;
        }
        
        const pt = document.getElementById("filterPeriodType").value;
        const sp = document.getElementById("filterSpecificPeriod").value;
        const periodLabel = getPeriodLabel(pt, sp).replace(/ /g, '_');
        
        // Create CSV header
        let csvContent = "Rank,Marketer,Closed Deals,Total Sales (â‚¦),Commission %,Commission Earned (â‚¦),Target Status\n";
        
        // Sort data by total sales
        const sortedData = [...currentPerformanceData].sort((a, b) => b.total_sales - a.total_sales);
        
        // Add rows
        sortedData.forEach((item, index) => {
            const hasData = item.total_sales > 0 || item.closed_deals > 0;
            const row = [
                hasData ? index + 1 : '-',
                `"${item.marketer_name}"`,
                hasData ? item.closed_deals : '-',
                hasData ? `â‚¦${formatNumber(item.total_sales)}` : '-',
                hasData ? `${item.commission_rate}%` : '-',
                hasData ? `â‚¦${formatNumber(item.commission_earned)}` : '-',
                `"${getTargetStatusText(item)}"`
            ];
            csvContent += row.join(',') + '\n';
        });
        
        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', `marketer_performance_${periodLabel}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function getTargetStatusText(item) {
        // Use company target for consistent measurement
        // Each marketer is measured against the FULL company target
        // Target Logic: Below Target (<50%), On Target (50-100%), Above Target (>100%)
        if (currentCompanyTarget > 0 && (item.total_sales > 0 || item.closed_deals > 0)) {
            const targetPercent = Math.round((item.total_sales / currentCompanyTarget) * 100) || 0;
            
            if (targetPercent > 100) {
                const above = targetPercent - 100;
                return `${above}% Above Target`;
            } else if (targetPercent >= 50) {
                return `On Target (${targetPercent}%)`;
            } else {
                const below = 100 - targetPercent;
                return `${below}% Below Target`;
            }
        } else if (currentCompanyTarget > 0) {
            return 'No Sales Yet';
        }
        return 'No Target Set';
    }
    
    function exportExcel() {
        if (!currentPerformanceData.length) {
            showToast('No data to export', 'warning');
            return;
        }
        
        const pt = document.getElementById("filterPeriodType").value;
        const sp = document.getElementById("filterSpecificPeriod").value;
        const periodLabel = getPeriodLabel(pt, sp).replace(/ /g, '_');
        
        // Prepare worksheet data
        const wsData = [
            ['Rank', 'Marketer', 'Closed Deals', 'Total Sales (â‚¦)', 'Commission %', 'Commission Earned (â‚¦)', 'Target Status']
        ];
        
        // Sort data by total sales
        const sortedData = [...currentPerformanceData].sort((a, b) => b.total_sales - a.total_sales);
        
        // Add rows
        sortedData.forEach((item, index) => {
            const hasData = item.total_sales > 0 || item.closed_deals > 0;
            wsData.push([
                hasData ? index + 1 : '-',
                item.marketer_name,
                hasData ? item.closed_deals : '-',
                hasData ? `â‚¦${formatNumber(item.total_sales)}` : '-',
                hasData ? `${item.commission_rate}%` : '-',
                hasData ? `â‚¦${formatNumber(item.commission_earned)}` : '-',
                getTargetStatusText(item)
            ]);
        });
        
        // Create workbook and worksheet
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Performance');
        
        // Export to file
        XLSX.writeFile(wb, `marketer_performance_${periodLabel}.xlsx`);
    }
    
    function exportPDF() {
        if (!currentPerformanceData.length) {
            showToast('No data to export', 'warning');
            return;
        }
        
        const pt = document.getElementById("filterPeriodType").value;
        const sp = document.getElementById("filterSpecificPeriod").value;
        const periodLabel = getPeriodLabel(pt, sp);
        
        // Create PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Add title
        doc.setFontSize(16);
        doc.text(`Marketers Performance Report - ${periodLabel}`, 105, 15, null, null, 'center');
        
        // Add table
        const headers = ['Rank', 'Marketer', 'Closed Deals', 'Total Sales (â‚¦)', 'Commission %', 'Commission Earned (â‚¦)', 'Target Status'];
        const data = [];
        
        // Sort data by total sales
        const sortedData = [...currentPerformanceData].sort((a, b) => b.total_sales - a.total_sales);
        
        // Prepare data rows
        sortedData.forEach((item, index) => {
            const hasData = item.total_sales > 0 || item.closed_deals > 0;
            data.push([
                hasData ? (index + 1).toString() : '-',
                item.marketer_name,
                hasData ? item.closed_deals.toString() : '-',
                hasData ? `â‚¦${formatNumber(item.total_sales)}` : '-',
                hasData ? `${item.commission_rate}%` : '-',
                hasData ? `â‚¦${formatNumber(item.commission_earned)}` : '-',
                getTargetStatusText(item)
            ]);
        });
        
        // Generate table
        doc.autoTable({
            head: [headers],
            body: data,
            startY: 25,
            theme: 'grid',
            styles: { fontSize: 9, cellPadding: 2 },
            headStyles: { fillColor: [41, 128, 185] }
        });
        
        // Save PDF
        doc.save(`marketer_performance_${periodLabel.replace(/ /g, '_')}.pdf`);
    }

    // Show toast notification
    function showToast(message, type) {
        let toastContainer = document.getElementById("toastContainer");
        if (!toastContainer) {
            toastContainer = document.createElement("div");
            toastContainer.id = "toastContainer";
            toastContainer.className = "toast-container position-fixed bottom-0 end-0 p-3";
            toastContainer.style.zIndex = "11";
            document.body.appendChild(toastContainer);
        }
        
        const toast = document.createElement("div");
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute("role", "alert");
        toast.setAttribute("aria-live", "assertive");
        toast.setAttribute("aria-atomic", "true");
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        // Initialize and show the toast
        const bsToast = new bootstrap.Toast(toast, { autohide: true, delay: 5000 });
        bsToast.show();
        
        // Remove toast after it's hidden
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
    }
</script>

<style>
  #ranking .card-title {
    font-weight: 600;
  }
  
  .leaderboard-item {
    transition: background-color 0.2s;
  }
  
  .leaderboard-item:hover {
    background-color: rgba(41, 128, 185, 0.05);
  }
  
  .rank-badge {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    border-radius: 50%;
  }
  
  .rank-badge.bg-gold { background-color: #FFD700; color: #000; }
  .rank-badge.bg-silver { background-color: #C0C0C0; color: #000; }
  .rank-badge.bg-bronze { background-color: #CD7F32; color: #fff; }
  .rank-badge.bg-primary { background-color: #297fb8; color: #fff; }

  .avatar-sm {
      width: 32px;
      height: 32px;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f0f4f8;
      border-radius: 50%;
  }

  .no-data-row {
      background-color: #f8f9fa;
      color: #6c757d;
  }

  /* Target Status Badge Colors */
  .bg-primary { background-color: #297fb8 !important; }
  .bg-success { background-color: #28a745 !important; }
  .bg-teal { background-color: #20c997 !important; }
  .bg-indigo { background-color: #6610f2 !important; }
  .bg-purple { background-color: #6f42c1 !important; }
  .bg-warning { background-color: #ffc107 !important; color: #000 !important; }
  .bg-orange { background-color: #fd7e14 !important; }
  .bg-coral { background-color: #ff6b6b !important; }
  .bg-danger { background-color: #dc3545 !important; }
  .bg-secondary { background-color: #6c757d !important; }

  .toast {
      max-width: 350px;
      overflow: hidden;
      font-size: 0.875rem;
      background-clip: padding-box;
      border: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  }

  /* Target Overview Styling */
  .bg-gradient {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  .target-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: none;
  }

  .target-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
  }

  .progress-overview {
      border: none;
      transition: box-shadow 0.3s ease;
  }

  .progress-overview:hover {
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
  }

  .progress-bar.bg-gradient {
      transition: width 1s ease, background 0.5s ease;
      position: relative;
      overflow: visible;
  }

  .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
      pointer-events: none;
  }

  @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
  }

  .target-card .bg-primary,
  .target-card .bg-success,
  .target-card .bg-warning {
      transition: transform 0.3s ease;
  }

  .target-card:hover .bg-primary,
  .target-card:hover .bg-success,
  .target-card:hover .bg-warning {
      transform: scale(1.1);
  }

  .badge.bg-light {
      color: #495057 !important;
      border: 1px solid #e9ecef;
  }

  /* Enhanced table header styling */
  .card-header.bg-gradient {
      position: relative;
      overflow: hidden;
  }

  .card-header.bg-gradient::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: float 6s ease-in-out infinite;
      pointer-events: none;
  }

  @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-10px) rotate(180deg); }
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
      .target-overview .row {
          gap: 1rem;
      }
      
      .progress-overview {
          margin-top: 1rem;
      }
  }

  /* Avatar Image Styling */
  .avatar-img {
      border: 2px solid #e9ecef;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  /* Progress Bar Enhancements */
  #targetProgress {
      transition: width 0.8s ease, background 0.5s ease;
  }

  .progress {
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
  }

  /* Send Message Modal Styles */
  .avatar-circle {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: bold;
  }

  .channel-option .form-check-input {
      display: none;
  }

  .channel-option .form-check-label {
      cursor: pointer;
      transition: all 0.2s ease;
      background: #f8f9fa;
  }

  .channel-option .form-check-input:checked + .form-check-label {
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border-color: #667eea !important;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
  }

  .channel-option .form-check-label:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  /* Recipient Option Styles */
  .recipient-option .form-check-input {
      display: none;
  }

  .recipient-card {
      cursor: pointer;
      transition: all 0.2s ease;
      background: #fff;
  }

  .recipient-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .recipient-option .form-check-input:checked + .recipient-card,
  .recipient-card.active {
      background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%);
      border-color: #667eea !important;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
  }

  .recipient-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
  }

  #singleRecipientDisplay,
  #noSalesRecipientDisplay,
  #allRecipientDisplay {
      transition: all 0.3s ease;
  }

  .template-btn {
      transition: all 0.2s ease;
  }

  .template-btn:hover {
      transform: translateY(-1px);
  }

  .template-btn.active {
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.5);
  }

  #messageContent {
      resize: none;
      border-radius: 10px;
  }

  #messageContent:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
  }

  #sendMessageModal .modal-content {
      border-radius: 16px;
      overflow: hidden;
  }

  #sendMessageModal .form-control {
      border-radius: 8px;
  }

  .message-btn {
      transition: all 0.2s ease;
  }

  .message-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
</style>