{% load static humanize %}
{% now "Y-m-d" as today %}

<style>
    .card-prm {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
        transition: .2s;
        border: none;
        padding: 0 !important;
    }

    .card-prm:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    .promo-banner-prm {
        background: linear-gradient(135deg, #f39c12, #e67e22);
        color: #fff;
        padding: .75rem;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 1.5rem;
        font-weight: 500;
    }
    .promo-banner-prm i { margin-right: .5rem; }
    .badge-notified-prm { background: rgba(40,167,69,.15); color: #28a745; }
    .badge-pending-prm   { background: rgba(255,193,7,.15); color: #ffc107; }
    .badge-promo-prm     { background: rgba(243,156,18,.15); color: #e67e22; }
    .badge-noprize-prm   { background: rgba(108,117,125,.15); color: #6c757d; }
    .increase-prm { color: #28a745; font-weight:600; }
    .decrease-prm { color: #dc3545; font-weight:600; }
    .trend-indicator-prm { margin-left:4px; }
    .modal-prm { z-index:1070!important; }
    .modal-backdrop-prm { z-index:1060!important; }
    
    /* Modern Presale Modal Styling */
    #prmValueModal .modal-content {
        border: none;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    #prmValueModal .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 1.5rem 2rem;
        position: relative;
    }
    #prmValueModal .modal-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #00c853, #64dd17, #00c853);
        background-size: 200% 100%;
        animation: shimmerGreen 2s linear infinite;
    }
    @keyframes shimmerGreen {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    #prmValueModal .modal-title {
        font-weight: 700;
        font-size: 1.4rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    #prmValueModal .modal-title::before {
        content: '\F4BA';
        font-family: 'bootstrap-icons';
        font-size: 1.2rem;
    }
    #prmValueModal .modal-body {
        padding: 2rem;
        background: linear-gradient(180deg, #f8f9ff 0%, #ffffff 100%);
    }
    #prmValueModal .form-label-modern {
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    #prmValueModal .form-label-modern i {
        color: #0d6efd;
        font-size: 1rem;
    }
    #prmValueModal .form-control-modern,
    #prmValueModal .form-select-modern {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background-color: #fff;
    }
    #prmValueModal .form-control-modern:focus,
    #prmValueModal .form-select-modern:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.15);
        outline: none;
    }
    #prmValueModal .form-control-modern:hover,
    #prmValueModal .form-select-modern:hover {
        border-color: #0d6efd;
    }
    /* Error state for form fields */
    #prmValueModal .form-control-modern.is-invalid,
    #prmValueModal .form-select-modern.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 4px rgba(220, 53, 69, 0.15);
    }
    #prmValueModal .field-error {
        color: #dc3545;
        font-size: 0.8rem;
        margin-top: 0.35rem;
        display: none;
        align-items: center;
        gap: 4px;
        animation: shakeError 0.4s ease;
    }
    #prmValueModal .field-error.show {
        display: flex;
    }
    @keyframes shakeError {
        0%, 100% { transform: translateX(0); }
        20%, 60% { transform: translateX(-5px); }
        40%, 80% { transform: translateX(5px); }
    }
    /* Error banner styling */
    #prmValueModal .error-banner {
        background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        border: 1px solid #fc8181;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1.25rem;
        display: none;
        align-items: center;
        gap: 10px;
        animation: fadeInDown 0.3s ease;
    }
    #prmValueModal .error-banner i {
        color: #e53e3e;
        font-size: 1.25rem;
    }
    #prmValueModal .error-banner span {
        color: #c53030;
        font-weight: 500;
    }
    #prmValueModal .form-error-banner {
        background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        border: 1px solid #fc8181;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1.25rem;
        display: none;
        align-items: center;
        gap: 10px;
        animation: fadeInDown 0.3s ease;
    }
    #prmValueModal .form-error-banner.show {
        display: flex;
    }
    #prmValueModal .form-error-banner i {
        color: #e53e3e;
        font-size: 1.25rem;
    }
    #prmValueModal .form-error-banner span {
        color: #c53030;
        font-weight: 500;
    }
    /* Edit Modal error banner */
    #prmEditModal .error-banner {
        background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        border: 1px solid #fc8181;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1.25rem;
        display: none;
        align-items: center;
        gap: 10px;
        animation: fadeInDown 0.3s ease;
    }
    #prmEditModal .error-banner i {
        color: #e53e3e;
        font-size: 1.25rem;
    }
    #prmEditModal .error-banner span {
        color: #c53030;
        font-weight: 500;
    }
    #prmEditModal .field-error {
        border-color: #e53e3e !important;
        box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.15) !important;
    }
    #prmEditModal .error-message {
        color: #e53e3e;
        font-size: 0.85rem;
        margin-top: 0.35rem;
        display: none;
    }
    @keyframes fadeInDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    #prmValueModal .input-group-modern {
        position: relative;
    }
    #prmValueModal .input-group-modern .currency-prefix {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        font-weight: 700;
        color: #28a745;
        font-size: 1.1rem;
        z-index: 5;
    }
    #prmValueModal .input-group-modern .form-control-modern {
        padding-left: 2.5rem;
    }
    #prmValueModal .price-input-wrapper {
        background: linear-gradient(135deg, #f0fff4 0%, #e8f5e9 100%);
        border-radius: 16px;
        padding: 1.25rem;
        border: 2px dashed #81c784;
        transition: all 0.3s ease;
    }
    #prmValueModal .price-input-wrapper:focus-within {
        border-color: #28a745;
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        transform: scale(1.01);
    }
    #prmValueModal .price-display {
        font-size: 1.5rem;
        font-weight: 700;
        color: #28a745;
        text-align: center;
        margin-top: 0.5rem;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s ease;
    }
    #prmValueModal .price-display.show {
        opacity: 1;
        transform: translateY(0);
    }
    #prmValueModal .form-row-animated {
        animation: fadeInUp 0.4s ease forwards;
        opacity: 0;
    }
    #prmValueModal .form-row-animated:nth-child(1) { animation-delay: 0.1s; }
    #prmValueModal .form-row-animated:nth-child(2) { animation-delay: 0.2s; }
    #prmValueModal .form-row-animated:nth-child(3) { animation-delay: 0.3s; }
    #prmValueModal .form-row-animated:nth-child(4) { animation-delay: 0.4s; }
    #prmValueModal .form-row-animated:nth-child(5) { animation-delay: 0.5s; }
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    #prmValueModal .modal-footer {
        border: none;
        padding: 1.25rem 2rem 1.5rem;
        background: #fff;
        gap: 0.75rem;
    }
    #prmValueModal .btn-cancel-modern {
        background: #f1f3f4;
        border: none;
        color: #5f6368;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.2s ease;
    }
    #prmValueModal .btn-cancel-modern:hover {
        background: #e8eaed;
        transform: translateY(-2px);
    }
    #prmValueModal .btn-save-modern {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: #fff;
        padding: 0.75rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    #prmValueModal .btn-save-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }
    #prmValueModal .btn-save-modern:active {
        transform: translateY(0);
    }
    #prmValueModal .notify-toggle {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-radius: 12px;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    #prmValueModal .notify-toggle:hover {
        background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%);
    }
    #prmValueModal .notify-toggle .form-check-input {
        width: 3rem;
        height: 1.5rem;
        cursor: pointer;
    }
    #prmValueModal .notify-toggle-text {
        font-weight: 500;
        color: #1976d2;
    }
    #prmValueModal .notify-toggle-text i {
        margin-right: 8px;
    }
    .btn-promo-prm {
        background-color: #f39c12; color:#fff; border:none;
    }
    .btn-promo-prm:hover { background-color:#e67e22; }
    .action-btn-prm {
        width:30px; height:30px;
        display:inline-flex; align-items:center; justify-content:center;
        border-radius:50%; margin:0 2px;
    }
    .status-badge-prm {
        padding:.4em .8em; border-radius:20px;
        font-weight:500; font-size:.85rem;
    }
    .history-container {
        max-height: 300px;
        overflow-y: auto;
    }
    .history-item {
        border-left: 3px solid #0d6efd;
        padding-left: 10px;
        margin-bottom: 15px;
    }
    .history-price { font-weight: 600; }
    .history-date  { font-size: 0.85rem; color: #6c757d; }
    .nav-tabs .nav-link { color: #495057; font-weight: 500; }
    .nav-tabs .nav-link.active { color: #0d6efd; font-weight: 600; }
    .chart-container { 
        height: 400px; 
        margin-top: 20px; 
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        position: relative;
    }
    .price-change { font-weight: 600; }
    .no-presale { color: #6c757d; font-style: italic; }
    .table th { font-weight: 600; background-color: #f8f9fa; }
    .table-hover tbody tr:hover { background-color: rgba(13, 110, 253, 0.05); }
    .value-change-badge {
        padding: 0.25em 0.6em; border-radius: 10px;
        font-size: 0.75rem; font-weight: 500;
    }
    .promo-badge-prm {
        display: inline-block;
        border-radius: 9999px;
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
        font-weight: 600;
        background: linear-gradient(135deg, #FFC107 0%, #FF8C00 100%);
        color: #212529;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        transition: transform 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .promo-badge-prm:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .history-item.promo-event {
        border-left: 3px solid #e67e22;
        background-color: rgba(230, 126, 34, 0.05);
    }

    .history-item.promo-event .history-price {
        font-weight: 700;
        color: #e67e22;
    }

    /* ============================================
       ENHANCED ANALYSIS TAB STYLES
       ============================================ */
    .analysis-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .analysis-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12) !important;
    }
    
    .bg-gradient-primary {
        background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 100%);
    }
    
    .bg-gradient-success {
        background: linear-gradient(135deg, #198754 0%, #157347 100%);
    }
    
    .bg-gradient-info {
        background: linear-gradient(135deg, #0dcaf0 0%, #0aa2c0 100%);
    }
    
    .bg-gradient-warning {
        background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
    }
    
    .bg-gradient-purple {
        background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
    }
    
    .bg-gradient-dark {
        background: linear-gradient(135deg, #343a40 0%, #212529 100%);
    }
    
    .analysis-metric-box {
        transition: background-color 0.2s ease;
    }
    
    .analysis-metric-box:hover {
        background-color: #e9ecef !important;
    }
    
    .comparison-box {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .comparison-box:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .projection-item {
        transition: background-color 0.2s ease;
    }
    
    .projection-item:hover {
        background-color: #e9ecef !important;
    }
    
    .intelligence-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .rating-stars i {
        font-size: 1rem;
        margin-right: 2px;
    }
    
    .recommendation-box {
        border-left: 4px solid #0d6efd;
    }
    
    .bg-success-subtle {
        background-color: rgba(25, 135, 84, 0.1) !important;
    }
    
    .bg-primary-subtle {
        background-color: rgba(13, 110, 253, 0.1) !important;
    }
    
    .bg-warning-subtle {
        background-color: rgba(255, 193, 7, 0.15) !important;
    }
    
    .bg-info-subtle {
        background-color: rgba(13, 202, 240, 0.1) !important;
    }
    
    .bg-danger-subtle {
        background-color: rgba(220, 53, 69, 0.1) !important;
    }
    
    .text-success { color: #198754 !important; }
    .text-primary { color: #0d6efd !important; }
    .text-warning { color: #ffc107 !important; }
    .text-danger { color: #dc3545 !important; }
    .text-info { color: #0dcaf0 !important; }
    
    #analysis-tab-pane .card-header h6 {
        font-size: 0.9rem;
        margin: 0;
    }
    
    #analysis-tab-pane .card-body {
        font-size: 0.875rem;
    }
    
    .projection-chart-container canvas,
    .chart-container canvas {
        max-height: 100%;
    }
    
    /* ============================================
       MODERN WAVE CHART STYLES
       ============================================ */
    .chart-wrapper {
        background: linear-gradient(145deg, #ffffff 0%, #f8fafc 50%, #f1f5f9 100%);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 
            0 4px 20px rgba(0, 0, 0, 0.08),
            inset 0 1px 0 rgba(255, 255, 255, 0.9);
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .chart-wrapper::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.3), transparent);
    }
    
    .chart-wrapper::after {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, rgba(99, 102, 241, 0.03) 0%, transparent 50%);
        pointer-events: none;
    }
    
    .chart-controls {
        padding: 0 5px;
        position: relative;
        z-index: 1;
    }
    
    .chart-title-badge .badge {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
        border-radius: 30px;
        font-size: 0.9rem;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        border: none;
    }
    
    .stat-pill {
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 20px !important;
    }
    
    .stat-pill:hover {
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    
    .chart-insights {
        background: linear-gradient(145deg, #f8fafc 0%, #ffffff 100%);
        border: 1px solid rgba(99, 102, 241, 0.15);
        border-radius: 16px;
        transition: all 0.3s ease;
        color: #1e293b;
    }
    
    .chart-insights:hover {
        box-shadow: 0 8px 30px rgba(99, 102, 241, 0.1);
        border-color: rgba(99, 102, 241, 0.3);
    }
    
    .growth-badge .badge {
        padding: 10px 20px;
        font-weight: 700;
        font-size: 1.1rem;
        border-radius: 12px;
    }
    
    .trend-indicator i {
        transition: transform 0.3s ease;
    }
    
    .chart-insights:hover .trend-indicator i {
        transform: scale(1.1);
    }
    
    /* Modern Chart Canvas Glow */
    #priceHistoryChart {
        filter: drop-shadow(0 0 30px rgba(99, 102, 241, 0.1));
    }
    
    /* Stat Pills for Light Theme */
    .chart-stats .stat-pill {
        background: rgba(255, 255, 255, 0.9) !important;
        border: 1px solid rgba(0, 0, 0, 0.08);
        color: #374151 !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }
    
    .chart-stats .stat-pill.bg-success-subtle {
        border-color: rgba(34, 197, 94, 0.25);
        background: rgba(34, 197, 94, 0.1) !important;
        color: #166534 !important;
    }
    
    .chart-stats .stat-pill.bg-danger-subtle {
        border-color: rgba(239, 68, 68, 0.25);
        background: rgba(239, 68, 68, 0.1) !important;
        color: #991b1b !important;
    }
    
    .chart-stats .stat-pill.bg-primary-subtle {
        border-color: rgba(99, 102, 241, 0.25);
        background: rgba(99, 102, 241, 0.1) !important;
        color: #4338ca !important;
    }
    
    /* Animated Gradient Border */
    @keyframes gradientBorder {
        0%, 100% { border-color: rgba(99, 102, 241, 0.3); }
        25% { border-color: rgba(139, 92, 246, 0.3); }
        50% { border-color: rgba(168, 85, 247, 0.3); }
        75% { border-color: rgba(236, 72, 153, 0.3); }
    }
    
    .chart-wrapper:hover {
        animation: gradientBorder 3s ease infinite;
        box-shadow: 0 8px 30px rgba(99, 102, 241, 0.12);
    }
    
    /* Pulse effect on data points hover */
    @keyframes pulseGlow {
        0%, 100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4); }
        50% { box-shadow: 0 0 20px 10px rgba(139, 92, 246, 0); }
    }
    
    /* Responsive adjustments for analysis tab */
    @media (max-width: 768px) {
        #analysis-tab-pane .row.g-3 > div {
            margin-bottom: 1rem;
        }
        
        .comparison-box {
            margin-bottom: 0.5rem;
        }
        
        .intelligence-item {
            margin-bottom: 1rem;
        }
        
        .chart-controls {
            flex-direction: column;
            gap: 10px;
        }
        
        .chart-stats {
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .chart-wrapper {
            padding: 15px;
            border-radius: 14px;
        }
    }
    
    /* Animation for loading */
    @keyframes analysisShimmer {
        0% { opacity: 0.5; }
        50% { opacity: 1; }
        100% { opacity: 0.5; }
    }
    
    #analysisLoading {
        animation: analysisShimmer 1.5s ease-in-out infinite;
    }

    .badge-gradient-prm {
        display: inline-block;
        padding: .6rem .8rem;
        font-size: 0.78rem;
        background: linear-gradient(135deg, #00c853, #64dd17);
        color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 200, 83, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        min-width: 150px;
        max-width: 220px;
        line-height: 1.3;
        transition: transform 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .badge-gradient-prm:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .badge-gradient-prm .text-light-emphasis {
        color: rgba(255, 255, 255, 0.85) !important;
    }
    .badge-gradient-prm .text-white {
        color: #fff !important;
    }
    .badge-gradient-prm .fw-semibold {
        font-weight: 600;
    }

    /* ============================================
       PROMOTIONAL OFFER MODAL STYLES
       ============================================ */
    #prmPromoModal .modal-content {
        border: none;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    #prmPromoModal .modal-header {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        border: none;
        padding: 1.5rem 2rem;
        position: relative;
    }
    #prmPromoModal .modal-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #fff3cd, #ffc107, #fff3cd);
        background-size: 200% 100%;
        animation: shimmerGold 2s linear infinite;
    }
    @keyframes shimmerGold {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    #prmPromoModal .modal-title {
        font-weight: 700;
        font-size: 1.4rem;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    #prmPromoModal .modal-title i {
        font-size: 1.5rem;
    }
    #prmPromoModal .modal-body {
        padding: 2rem;
        background: linear-gradient(180deg, #fffaf0 0%, #ffffff 100%);
    }
    #prmPromoModal .form-label-promo {
        font-weight: 600;
        color: #4a4a4a;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }
    #prmPromoModal .form-label-promo i {
        color: #e67e22;
        font-size: 1rem;
    }
    #prmPromoModal .form-control-promo {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        background: #fff;
    }
    #prmPromoModal .form-control-promo:focus {
        border-color: #f39c12;
        box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.15);
        outline: none;
    }
    #prmPromoModal .form-control-promo.field-error {
        border-color: #dc3545;
        background-color: #fff8f8;
    }
    #prmPromoModal .form-select-promo {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        transition: all 0.2s ease;
        background: #fff;
        min-height: 120px;
    }
    #prmPromoModal .form-select-promo:focus {
        border-color: #f39c12;
        box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.15);
        outline: none;
    }
    #prmPromoModal .form-select-promo.field-error {
        border-color: #dc3545;
    }
    #prmPromoModal .discount-input-wrapper {
        position: relative;
    }
    #prmPromoModal .discount-suffix {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-weight: 700;
        font-size: 1.1rem;
        color: #e67e22;
    }
    #prmPromoModal .discount-preview {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
        border-radius: 12px;
        padding: 1rem;
        margin-top: 1rem;
        text-align: center;
        border: 1px solid #ffc107;
    }
    #prmPromoModal .discount-preview .preview-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #856404;
        margin-bottom: 0.5rem;
    }
    #prmPromoModal .discount-preview .preview-value {
        font-size: 2rem;
        font-weight: 800;
        color: #e67e22;
    }
    #prmPromoModal .date-range-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
        border-radius: 12px;
        padding: 1rem;
        border: 1px solid #e9ecef;
    }
    #prmPromoModal .date-range-card .date-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }
    #prmPromoModal .date-range-card .date-icon.start {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: #fff;
    }
    #prmPromoModal .date-range-card .date-icon.end {
        background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        color: #fff;
    }
    #prmPromoModal .modal-footer {
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
        padding: 1.25rem 2rem;
        gap: 12px;
    }
    #prmPromoModal .btn-cancel-promo {
        background: #fff;
        border: 2px solid #dee2e6;
        color: #6c757d;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.2s ease;
    }
    #prmPromoModal .btn-cancel-promo:hover {
        background: #e8eaed;
        transform: translateY(-2px);
    }
    #prmPromoModal .btn-save-promo {
        background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        border: none;
        color: #fff;
        padding: 0.75rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
    }
    #prmPromoModal .btn-save-promo:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(243, 156, 18, 0.5);
    }
    #prmPromoModal .btn-save-promo:disabled {
        background: #ccc;
        box-shadow: none;
        cursor: not-allowed;
        transform: none;
    }
    #prmPromoModal .error-banner-promo {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        border: 1px solid #f5c6cb;
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        color: #721c24;
        font-weight: 500;
    }
    #prmPromoModal .error-banner-promo i {
        font-size: 1.25rem;
        margin-right: 10px;
    }
    #prmPromoModal .error-message-promo {
        color: #dc3545;
        font-size: 0.8rem;
        margin-top: 0.25rem;
        display: none;
    }
    #prmPromoModal .estates-help {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.5rem;
    }
    #prmPromoModal .section-divider {
        height: 1px;
        background: linear-gradient(90deg, transparent, #e9ecef, transparent);
        margin: 1.5rem 0;
    }

    /* ============================================
       PRESALE MODAL TABLE STYLES (Bulk Entry)
       ============================================ */
    #prmValueModal .modal-dialog {
        max-width: 900px;
    }
    
    /* Estate Info Card for Presale Modal */
    .estate-info-card-presale {
        background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
        border-radius: 16px;
        padding: 1.25rem 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid rgba(118, 75, 162, 0.2);
    }
    .estate-info-card-presale .estate-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: #4a148c;
        margin-bottom: 0.25rem;
    }
    .estate-info-card-presale .estate-location {
        color: #7b1fa2;
        font-size: 0.9rem;
    }
    .plot-count-presale {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.9rem;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    /* Table Container for Presale */
    .table-container-presale {
        background: #fff;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(102, 126, 234, 0.15);
        margin-bottom: 1.5rem;
    }
    .table-container-presale table {
        margin: 0;
    }
    .table-container-presale thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .table-container-presale thead th {
        color: #fff !important;
        font-weight: 600;
        padding: 1rem 0.75rem;
        border: none;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .table-container-presale tbody tr {
        transition: all 0.2s ease;
        border-bottom: 1px solid #f1f3f5;
    }
    .table-container-presale tbody tr:hover {
        background-color: rgba(102, 126, 234, 0.05);
    }
    .table-container-presale tbody td {
        padding: 1rem 0.75rem;
        vertical-align: middle;
    }
    
    /* Presale Price Input */
    .presale-price-input {
        width: 100%;
        padding: 0.6rem 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 0.95rem;
        font-weight: 600;
        transition: all 0.2s ease;
        text-align: right;
    }
    .presale-price-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        outline: none;
    }
    .presale-price-input:disabled {
        background-color: #f8f9fa;
        cursor: not-allowed;
    }
    .presale-price-input.has-change {
        border-color: #667eea;
        background-color: #f3e5f5;
    }
    
    /* Status Badge for Presale */
    .status-badge-presale {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .status-badge-presale.available {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
    }
    .status-badge-presale.sold-out {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        color: #721c24;
    }
    .status-badge-presale.has-presale {
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        color: #2e7d32;
    }
    .status-badge-presale.no-presale {
        background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        color: #e65100;
    }
    
    /* Summary Section for Presale */
    .summary-section-presale {
        background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
        border-radius: 16px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e0e0e0;
    }
    .section-title-presale {
        font-weight: 700;
        color: #4a148c;
        margin-bottom: 1rem;
        font-size: 1rem;
    }
    .section-title-presale i {
        margin-right: 8px;
        color: #667eea;
    }
    .summary-card-presale {
        background: #fff;
        border-radius: 12px;
        padding: 1rem;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        transition: all 0.2s ease;
    }
    .summary-card-presale:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .summary-card-presale .label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }
    .summary-card-presale .value {
        font-size: 1.5rem;
        font-weight: 700;
    }
    .summary-card-presale.primary .value {
        color: #667eea;
    }
    .summary-card-presale.success .value {
        color: #28a745;
    }
    .summary-card-presale.info .value {
        color: #17a2b8;
    }
    
    /* Notes Section for Presale */
    .notes-section-presale {
        margin-bottom: 1.25rem;
    }
    .notes-textarea-presale {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        resize: none;
        transition: all 0.2s ease;
    }
    .notes-textarea-presale:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        outline: none;
    }
    
    /* Notify Toggle for Presale */
    .notify-toggle-presale {
        background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
        border-radius: 12px;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 0.5rem;
    }
    .notify-toggle-presale:hover {
        background: linear-gradient(135deg, #e1bee7 0%, #ce93d8 100%);
    }
    .notify-toggle-presale .form-check-input {
        width: 3rem;
        height: 1.5rem;
        cursor: pointer;
    }
    .notify-toggle-presale .notify-toggle-text {
        font-weight: 500;
        color: #7b1fa2;
    }
    .notify-toggle-presale .notify-toggle-text i {
        margin-right: 8px;
    }
    
    /* Loading State */
    .table-container-presale .loading-row td {
        padding: 2rem;
    }
    .table-container-presale .loading-spinner {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        color: #667eea;
    }
    
    /* Presale button disabled state */
    #prmValueModal .btn-save-modern:disabled {
        background: #ccc;
        box-shadow: none;
        cursor: not-allowed;
        transform: none;
    }

    /* ============================================
       MODERN BULK UPDATE MODAL STYLES
       ============================================ */
    #prmBulkUpdateModal .modal-content {
        border: none;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    #prmBulkUpdateModal .modal-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        padding: 1.5rem 2rem;
        position: relative;
    }
    #prmBulkUpdateModal .modal-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
        background-size: 200% 100%;
        animation: shimmerPurple 2s linear infinite;
    }
    @keyframes shimmerPurple {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    #prmBulkUpdateModal .modal-title {
        font-weight: 700;
        font-size: 1.4rem;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #fff;
    }
    #prmBulkUpdateModal .modal-title::before {
        content: '\F4CB';
        font-family: 'bootstrap-icons';
        font-size: 1.5rem;
        background: rgba(255,255,255,0.2);
        padding: 8px;
        border-radius: 10px;
    }
    #prmBulkUpdateModal .modal-body {
        padding: 2rem;
        background: linear-gradient(180deg, #f8fff8 0%, #ffffff 100%);
    }
    #prmBulkUpdateModal .modal-footer {
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
        padding: 1.25rem 2rem;
    }
    
    /* Error Banner */
    #prmBulkUpdateModal .error-banner {
        background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        border: 1px solid #fc8181;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1.25rem;
        display: none;
        align-items: center;
        gap: 10px;
        animation: fadeInDown 0.3s ease;
    }
    #prmBulkUpdateModal .error-banner i {
        color: #e53e3e;
        font-size: 1.25rem;
    }
    #prmBulkUpdateModal .error-banner span {
        color: #c53030;
        font-weight: 500;
    }
    
    /* Form Controls */
    #prmBulkUpdateModal .form-label-modern {
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    #prmBulkUpdateModal .form-label-modern i {
        color: #28a745;
    }
    #prmBulkUpdateModal .form-select-modern,
    #prmBulkUpdateModal .form-control-modern {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #fff;
    }
    #prmBulkUpdateModal .form-select-modern:focus,
    #prmBulkUpdateModal .form-control-modern:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 4px rgba(40, 167, 69, 0.15);
        outline: none;
    }
    #prmBulkUpdateModal .field-error {
        border-color: #e53e3e !important;
        box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.15) !important;
    }
    #prmBulkUpdateModal .error-message {
        color: #e53e3e;
        font-size: 0.85rem;
        margin-top: 0.35rem;
        display: none;
    }
    
    /* Estate Info Card */
    #prmBulkUpdateModal .estate-info-card {
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        border: none;
        border-radius: 16px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.15);
    }
    #prmBulkUpdateModal .estate-info-card .estate-name {
        font-size: 1.2rem;
        font-weight: 700;
        color: #1b5e20;
    }
    #prmBulkUpdateModal .estate-info-card .estate-location {
        color: #2e7d32;
        font-size: 0.9rem;
    }
    #prmBulkUpdateModal .estate-info-card .plot-count {
        background: #fff;
        border-radius: 10px;
        padding: 0.5rem 1rem;
        font-weight: 600;
        color: #28a745;
    }
    
    /* Modern Table Styling */
    #prmBulkUpdateModal .table-container {
        border: 1px solid #e0e0e0;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }
    #prmBulkUpdateModal .table-responsive {
        max-height: 400px;
        overflow-y: auto;
        border: none;
    }
    #prmBulkUpdateModal .table {
        margin-bottom: 0;
    }
    #prmBulkUpdateModal .table thead {
        position: sticky;
        top: 0;
        z-index: 10;
    }
    #prmBulkUpdateModal .table thead th {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: #fff;
        font-weight: 600;
        font-size: 0.85rem;
        padding: 1rem 0.75rem;
        border: none;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    #prmBulkUpdateModal .table thead th:first-child {
        border-radius: 0;
    }
    #prmBulkUpdateModal .table thead th:last-child {
        border-radius: 0;
    }
    #prmBulkUpdateModal .table tbody tr {
        transition: all 0.2s ease;
    }
    #prmBulkUpdateModal .table tbody tr:hover {
        background: #f8fff8;
    }
    #prmBulkUpdateModal .table tbody td {
        padding: 1rem 0.75rem;
        vertical-align: middle;
        border-bottom: 1px solid #e9ecef;
    }
    
    /* Checkbox Styling */
    #prmBulkUpdateModal .bulk-plot-checkbox,
    #prmBulkUpdateModal #bulkSelectAll {
        cursor: pointer;
        width: 20px;
        height: 20px;
        accent-color: #28a745;
    }
    
    /* Price Input */
    #prmBulkUpdateModal .bulk-new-price {
        font-weight: 600;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 0.5rem 0.75rem;
        transition: all 0.3s ease;
        width: 100%;
    }
    #prmBulkUpdateModal .bulk-new-price:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
        outline: none;
    }
    #prmBulkUpdateModal .bulk-new-price:disabled {
        background: #f8f9fa;
        cursor: not-allowed;
    }
    
    /* Percentage Badges */
    #prmBulkUpdateModal td span[class*="change-percent"],
    #prmBulkUpdateModal td span[class*="total-percent"] {
        display: inline-block;
        padding: 0.35rem 0.6rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        min-width: 65px;
        text-align: center;
        background: #e9ecef;
        color: #6c757d;
    }
    #prmBulkUpdateModal .increase-prm {
        color: #fff !important;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        animation: pulseGreen 0.5s ease;
    }
    #prmBulkUpdateModal .decrease-prm {
        color: #fff !important;
        background: linear-gradient(135deg, #dc3545 0%, #e63757 100%) !important;
        animation: pulseRed 0.5s ease;
    }
    
    @keyframes pulseGreen {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    @keyframes pulseRed {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    /* Summary Cards */
    #prmBulkUpdateModal .summary-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 16px;
        padding: 1.5rem;
        margin-top: 1.5rem;
    }
    #prmBulkUpdateModal .summary-section .section-title {
        font-weight: 700;
        color: #28a745;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    #prmBulkUpdateModal .summary-card {
        background: #fff;
        border-radius: 12px;
        padding: 1rem;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
    }
    #prmBulkUpdateModal .summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
    }
    #prmBulkUpdateModal .summary-card .label {
        font-size: 0.8rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
    }
    #prmBulkUpdateModal .summary-card .value {
        font-size: 1.4rem;
        font-weight: 700;
    }
    #prmBulkUpdateModal .summary-card.primary .value { color: #667eea; }
    #prmBulkUpdateModal .summary-card.success .value { color: #28a745; }
    #prmBulkUpdateModal .summary-card.danger .value { color: #dc3545; }
    #prmBulkUpdateModal .summary-card.info .value { color: #17a2b8; }
    
    /* Notes Section */
    #prmBulkUpdateModal .notes-section {
        margin-top: 1.5rem;
    }
    #prmBulkUpdateModal .notes-textarea {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 1rem;
        resize: vertical;
        min-height: 80px;
        transition: all 0.3s ease;
    }
    #prmBulkUpdateModal .notes-textarea:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.15);
        outline: none;
    }
    
    /* Notify Toggle */
    #prmBulkUpdateModal .notify-toggle {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-radius: 12px;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        margin-top: 1rem;
        transition: all 0.3s ease;
    }
    #prmBulkUpdateModal .notify-toggle:hover {
        transform: translateX(5px);
    }
    #prmBulkUpdateModal .notify-toggle-text {
        font-weight: 500;
        color: #1565c0;
    }
    #prmBulkUpdateModal .notify-toggle-text i {
        margin-right: 6px;
    }
    
    /* Footer Buttons */
    #prmBulkUpdateModal .btn-cancel-modern {
        background: #e8eaed;
        border: none;
        color: #5f6368;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    #prmBulkUpdateModal .btn-cancel-modern:hover {
        background: #dadce0;
        transform: translateY(-2px);
    }
    #prmBulkUpdateModal .btn-save-modern {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        color: #fff;
        padding: 0.75rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }
    #prmBulkUpdateModal .btn-save-modern:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.5);
    }
    #prmBulkUpdateModal .btn-save-modern:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    /* Status Badges */
    #prmBulkUpdateModal .status-badge {
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    #prmBulkUpdateModal .status-badge.available {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
    }
    #prmBulkUpdateModal .status-badge.sold-out {
        background: linear-gradient(135deg, #e2e3e5 0%, #d6d8db 100%);
        color: #6c757d;
    }
    
    /* Loading State */
    #prmBulkUpdateModal .loading-row td {
        text-align: center;
        padding: 3rem !important;
    }
    #prmBulkUpdateModal .loading-spinner {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        color: #28a745;
    }
    
    /* Warning Text */
    #prmBulkUpdateModal .warning-text {
        color: #856404;
        background: #fff3cd;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.75rem;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        margin-top: 0.35rem;
    }


</style>

<div class="container py-4">
    <div class="promo-banner-prm mb-4">
        <i class="bi bi-megaphone"></i>
        {% if current_promos %}
            {% for promo in current_promos %}
            <div class="mb-2" style="text-align: start;">
                <strong><i class="bi bi-megaphone-fill"></i> {{ promo.name }}</strong> – {{ promo.discount }}% off on
                {% for estate in promo.estates.all %}
                <strong>{{ estate.name }}</strong>{% if not forloop.last %}, {% endif %}
                {% endfor %}
                until {{ promo.end|date:"M d, Y" }}.
            </div>
            {% endfor %}
        {% else %}
            No active promo.
        {% endif %}
    </div>


    <div class="card-prm">
        <div class="card-header d-flex justify-content-between align-items-center bg-light">
            <h5 class="mb-0">Property Value Management</h5>
            <div>
                <button id="prmAddRegBtn" class="btn btn-primary btn-sm me-1">
                    <i class="bi bi-plus-circle"></i> Set Presale Prize Only
                </button>
                <button id="prmBulkUpdateBtn" class="btn btn-success btn-sm me-1">
                    <i class="bi bi-pencil-square"></i> Price Update
                </button>
                <button id="prmCreatePromoBtn" class="btn btn-promo-prm btn-sm me-1">
                    <i class="bi bi-tag"></i> Create Promo
                </button>
                <button id="prmNotifyClientsBtn" class="btn btn-info btn-sm">
                    <i class="bi bi-megaphone"></i> Send Notification
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <!-- Search Box (Property Value Table) -->
            <div class="p-3 border-bottom">
                <div class="row g-2 align-items-center">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="prmPropertySearchInput" placeholder="Search property values...">
                            <button class="btn btn-outline-secondary" type="button" id="prmPropertyClearSearch" style="display:none;">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <small class="text-muted" id="prmPropertySearchResultsInfo" style="display:none;">
                            <span id="prmPropertySearchResultsCount">0</span> results found
                        </small>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width: 50px;">S/N</th>
                            <th>Estate</th>
                            <th>Plot</th>
                            <th>Location</th>
                            <th class="text-end">Presale (₦)</th>
                            <th class="text-end">Previous (₦)</th>
                            <th class="text-end">Currrent (₦)</th>
                            <th>% Change</th>
                            <th>Over Time %</th>
                            <th>Effective Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="prmPropertyTable">
                        {% for row in rows %}
                            <tr id="row-{{ row.estate.id }}-{{ row.plot_unit.id }}" data-id="{{ row.id }}">
                            <!-- Row Number -->
                            <td class="text-center fw-semibold text-muted">{{ forloop.counter }}</td>
                            <!-- Estate + Badge -->
                            <td>
                                <div class="d-flex align-items-center">
                                {{ row.estate.name }}

                                {% if row.presale and row.effective|stringformat:"s" > today %}
                                    <span class="badge-gradient-prm ms-2">
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="bi bi-clock-history me-1 text-light-emphasis fs-6"></i>
                                        <strong class="text-light">Price Update</strong>
                                    </div>
                                    <div class="small text-light-emphasis">
                                        New: <span class="text-white fw-semibold">₦{{ row.display_current|intcomma }}</span><br>
                                        % Change: <span class="text-white fw-semibold badge-locked">+{{ row.percent_change|floatformat:1 }}%</span><br>
                                        Effective: <span class="text-white fw-semibold">{{ row.effective }}</span><br>
                                    </div>
                                    </span>

                                {% elif row.active_promo %}
                                    <span class="promo-badge-prm ms-2">
                                    <!-- <i class="bi bi-tag-fill me-1"></i> -->
                                    {{ row.active_promo.discount }}% OFF
                                    </span>
                                {% endif %}
                                </div>
                            </td>

                            <!-- Plot Size -->
                            <td>{{ row.plot_unit.plot_size.size }}</td>

                            <!-- Location -->
                            <td>{{ row.estate.location }}</td>

                            <!-- Presale -->
                            <td class="text-end">
                                {% if row.presale %}{{ row.presale|intcomma }}{% endif %}
                            </td>

                            <!-- Previous -->
                            <td class="text-end">
                                {% if row.effective|stringformat:"s" > today %}
                                    {{ row.presale|intcomma }}
                                {% elif row.previous %}
                                    {{ row.previous|intcomma }}
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>

                            <!-- Current (shows previous until effective date) -->
                            <td class="text-end fw-bold">
                                {% if row.effective|stringformat:"s" > today %}
                                {{ row.previous|intcomma }}
                                {% else %}
                                {{ row.display_current|intcomma }}
                                {% endif %}
                            </td>

                            <!-- % Change -->
                            <td>
                                {% if row.percent_change is not None %}
                                {% if row.percent_change > 0 %}
                                    <span class="increase-prm">
                                    +{{ row.percent_change|floatformat:1 }}%
                                    <i class="bi bi-arrow-up-right trend-indicator-prm"></i>
                                    </span>
                                {% elif row.percent_change < 0 %}
                                    <span class="decrease-prm">
                                    {{ row.percent_change|floatformat:1 }}%
                                    <i class="bi bi-arrow-down-left trend-indicator-prm"></i>
                                    </span>
                                {% else %}
                                    <span class="price-change">0.0%</span>
                                {% endif %}
                                {% else %}
                                <span class="no-presale">-</span>
                                {% endif %}
                            </td>

                            <!-- Over Time % -->
                            <td class="text-end">
                                {% if row.overtime is not None %}
                                {{ row.overtime|floatformat:1 }}%
                                {% else %}
                                <span class="price-change">0.0%</span>
                                {% endif %}
                            </td>

                            <!-- Effective Date -->
                            <td>{{ row.effective|default:"" }}</td>

                            <!-- Status Badge -->
                            <td>
                                {% if row.id %}
                                <span class="badge-notified-prm status-badge-prm">Active</span>
                                {% else %}
                                <span class="badge-pending-prm status-badge-prm">NoPrice</span>
                                {% endif %}
                            </td>

                            <!-- Actions -->
                            <td>
                                {% if row.id %}
                                <button class="btn btn-sm btn-outline-secondary action-btn-prm"
                                        data-action="history" data-id="{{ row.id }}">
                                    <i class="bi bi-clock-history"></i>
                                </button>
                                {% else %}
                                <button class="btn btn-sm btn-outline-primary action-btn-prm"
                                        data-action="add"
                                        data-estate="{{ row.estate.id }}"
                                        data-unit="{{ row.plot_unit.id }}">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" disabled>
                                    <i class="bi bi-clock-history"></i>
                                </button>
                                {% endif %}
                            </td>
                            </tr>
                        {% empty %}
                            <tr>
                            <td colspan="12" class="text-center text-muted">
                                No properties to display.
                            </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls (Property Value Table) -->
            <div class="p-3 border-top d-flex flex-wrap justify-content-between align-items-center gap-2" id="prmPropertyPaginationContainer" style="display:none;">
                <div class="small text-muted">
                    Showing <span id="prmPropertyShowingStart">0</span>-<span id="prmPropertyShowingEnd">0</span> of <span id="prmPropertyTotalItems">0</span>
                </div>

                <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-sm btn-outline-secondary" id="prmPropertyPrevPage" type="button" disabled>
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <div class="d-flex align-items-center gap-1" id="prmPropertyPaginationPages"></div>
                    <button class="btn btn-sm btn-outline-secondary" id="prmPropertyNextPage" type="button">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>

                <div class="d-flex align-items-center gap-2">
                    <span class="small text-muted">Per page:</span>
                    <select id="prmPropertyPageSize" class="form-select form-select-sm" style="width:auto;">
                        <option value="5" selected>5</option>
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PRESALE MODAL (Redesigned - Bulk Style) -->
<div class="modal fade modal-prm" id="prmValueModal" tabindex="-1" aria-labelledby="prmValueModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-light" id="prmValueModalLabel">Set Presale Prices</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Error Banner -->
                <div id="prmErrorBanner" class="error-banner" style="display: none;">
                    <i class="bi bi-exclamation-circle me-2"></i>
                    <span id="prmErrorMessage">Please fill all required fields</span>
                </div>
                
                <form id="prmRegForm">
                    <input type="hidden" id="prmPropertyId">
                    
                    <!-- Row 1: Estate & Effective Date Selection -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label-modern">
                                <i class="bi bi-building"></i> Select Estate
                            </label>
                            <select id="prmEstateSelect" class="form-select-modern w-100" required>
                                <option value="">Choose Estate...</option>
                                {% for e in estates %}
                                <option value="{{ e.id }}">{{ e.name }} - {{ e.location }}</option>
                                {% endfor %}
                            </select>
                            <div class="error-message" id="prmEstateError"></div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-modern">
                                <i class="bi bi-calendar-event"></i> Effective Date
                            </label>
                            <input id="prmEffectiveDate" type="date" class="form-control-modern" required>
                            <div class="error-message" id="prmDateError"></div>
                        </div>
                    </div>

                    <!-- Estate Info Card -->
                    <div id="presaleEstateInfo" class="estate-info-card-presale d-none">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="estate-name" id="presaleEstateNameDisplay"></div>
                                <div class="estate-location" id="presaleEstateLocationDisplay">
                                    <i class="bi bi-geo-alt-fill me-1"></i>
                                    <span id="presaleEstateLocationText"></span>
                                </div>
                            </div>
                            <div class="plot-count-presale">
                                <i class="bi bi-grid-3x3-gap me-1"></i>
                                <span id="presaleTotalPlots">0</span> Plot Sizes
                            </div>
                        </div>
                    </div>

                    <!-- Plot Sizes Presale Table -->
                    <div id="presalePriceContainer" class="d-none">
                        <div class="table-container-presale">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width: 6%;">
                                                <input type="checkbox" id="presaleSelectAll" class="form-check-input">
                                            </th>
                                            <th style="width: 30%; color: black !important;">Plot Size</th>
                                            <th style="width: 15%; color: black !important;">Status</th>
                                            <th style="width: 22%; color: black !important;">Current Presale (₦)</th>
                                            <th style="width: 27%; color: black !important;">New Presale Price (₦)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="presalePlotTableBody">
                                        <!-- Plot rows will be inserted here dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Presale Summary Section -->
                        <div class="summary-section-presale">
                            <div class="section-title-presale">
                                <i class="bi bi-calculator-fill"></i> Presale Summary
                            </div>
                            <div class="row g-3">
                                <div class="col-md-4 col-6">
                                    <div class="summary-card-presale primary">
                                        <div class="label">Selected Plots</div>
                                        <div class="value" id="presaleSelectedCount">0</div>
                                    </div>
                                </div>
                                <div class="col-md-4 col-6">
                                    <div class="summary-card-presale success">
                                        <div class="label">New Presales</div>
                                        <div class="value" id="presaleNewCount">0</div>
                                    </div>
                                </div>
                                <div class="col-md-4 col-6">
                                    <div class="summary-card-presale info">
                                        <div class="label">Updates</div>
                                        <div class="value" id="presaleUpdateCount">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notes Section -->
                        <div class="notes-section-presale">
                            <label class="form-label-modern">
                                <i class="bi bi-journal-text"></i> Notes <span class="text-muted fw-normal">(optional)</span>
                            </label>
                            <textarea id="prmNotes" class="notes-textarea-presale w-100" rows="2" 
                                      placeholder="Add any relevant notes about these presale prices..."></textarea>
                        </div>

                        <!-- Notify Toggle -->
                        <label class="notify-toggle-presale">
                            <input id="prmNotifyChk" class="form-check-input" type="checkbox" role="switch" checked>
                            <span class="notify-toggle-text">
                                <i class="bi bi-bell-fill"></i> Notify clients about these presale prices
                            </span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel-modern" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-1"></i> Cancel
                </button>
                <button id="prmSaveRegBtn" class="btn-save-modern" disabled>
                    <i class="bi bi-check2-circle me-1"></i> Save Selected Presales
                </button>
            </div>
        </div>
    </div>
</div>

<!-- EDIT MODAL -->
<div class="modal fade modal-prm" id="prmEditModal" tabindex="-1" aria-labelledby="prmEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="prmEditModalLabel">Update Property Price</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Error Banner -->
                <div id="prmEditErrorBanner" class="error-banner" style="display: none;">
                    <i class="bi bi-exclamation-circle me-2"></i>
                    <span id="prmEditErrorMessage">Please fill all required fields</span>
                </div>
                
                <form id="prmEditForm">
                    <input type="hidden" id="prmEditPropertyId">
                    <div class="row mb-3">
                        <div class="col">
                            <label>Estate</label>
                            <input id="prmEditEstate" type="text" class="form-control" readonly>
                        </div>
                        <div class="col">
                            <label>Plot Size</label>
                            <input id="prmEditPlotSize" type="text" class="form-control" readonly>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label>Location</label>
                            <input id="prmEditLocation" type="text" class="form-control" readonly>
                        </div>
                        <div class="col">
                            <label>Effective Date</label>
                            <input id="prmEditEffectiveDate" type="date" class="form-control" required>
                            <div class="error-message" id="prmEditDateError"></div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label>Presale Price (₦)</label>
                            <input id="prmEditPresalePrice" type="text" class="form-control" readonly>
                        </div>
                        <div class="col">
                            <label>Previous Price (₦)</label>
                            <input id="prmEditPrevPrice" type="text" class="form-control" readonly>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>New Current Price (₦)</label>
                        <input id="prmEditCurrentPrice" type="number" class="form-control" min="0" required>
                        <div class="error-message" id="prmEditCurrentError"></div>
                    </div>
                    <div class="mb-3">
                        <label>Price Change Calculation</label>
                        <div class="card p-3 bg-light">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Previous Price:</span>
                                <span id="prevPriceCalc" class="fw-bold">₦0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>New Price:</span>
                                <span id="newPriceCalc" class="fw-bold">₦0</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Change:</span>
                                <span id="changeCalc" class="price-change">0.00%</span>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <span>Cumulative Change:</span>
                                <span id="cumulativeCalc" class="price-change">0.00%</span>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label>Notes</label>
                        <textarea id="prmEditNotes" class="form-control" rows="3" placeholder="Add notes about this price change..."></textarea>
                    </div>
                    <div class="form-check">
                        <input id="prmEditNotifyChk" class="form-check-input" type="checkbox" checked>
                        <label class="form-check-label" for="prmEditNotifyChk">Notify clients & marketer about this change</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button id="prmSaveEditBtn" class="btn btn-success">Update Price</button>
            </div>
        </div>
    </div>
</div>

<!-- HISTORY MODAL -->
<div class="modal fade modal-prm" id="prmHistoryModal" tabindex="-1" aria-labelledby="prmHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <!-- <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="prmHistoryModalLabel">Price History</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div> -->

            <!-- Add promo indicator to modal header -->
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="prmHistoryModalLabel">Price History</h5>
                <span id="historyPromoBadge" class="badge bg-warning ms-2 d-none">Includes Promos</span>
            </div>

            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 id="historyEstateName" class="mb-0">Estate</h4>
                        <div class="text-muted" id="historyPlotSize">PlotSize - Location</div>
                    </div>
                    <div class="text-end">
                        <div>Presale Price: <span class="fw-bold" id="historyPresale">₦0</span></div>
                        <div>Current Price: <span class="fw-bold" id="historyCurrent">₦0</span></div>
                    </div>
                </div>

                <ul class="nav nav-tabs mb-3" id="historyTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-tab-pane" type="button" role="tab">History List</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart-tab-pane" type="button" role="tab">Price Chart</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis-tab-pane" type="button" role="tab">Analysis</button>
                    </li>
                </ul>

                <div class="tab-content" id="historyTabContent">
                    <div class="tab-pane fade show active" id="list-tab-pane" role="tabpanel" tabindex="0">
                        <div class="history-container" id="historyList">
                            <!-- populated dynamically -->
                        </div>
                    </div>
                    <div class="tab-pane fade" id="chart-tab-pane" role="tabpanel" tabindex="0">
                        <!-- Chart Controls -->
                        <div class="chart-controls d-flex justify-content-between align-items-center mb-3">
                            <div class="chart-title-badge">
                                <span class="badge bg-gradient-primary px-3 py-2 d-flex align-items-center gap-2">
                                    <i class="bi bi-activity"></i>
                                    <span>Price Wave Trend</span>
                                </span>
                            </div>
                            <div class="chart-stats d-flex gap-3">
                                <div class="stat-pill bg-success-subtle text-success rounded-pill px-3 py-1">
                                    <small><i class="bi bi-arrow-up-right me-1"></i>Highest: <span id="chartHighest">₦0</span></small>
                                </div>
                                <div class="stat-pill bg-danger-subtle text-danger rounded-pill px-3 py-1">
                                    <small><i class="bi bi-arrow-down-right me-1"></i>Lowest: <span id="chartLowest">₦0</span></small>
                                </div>
                                <div class="stat-pill bg-primary-subtle text-primary rounded-pill px-3 py-1">
                                    <small><i class="bi bi-graph-up me-1"></i>Avg: <span id="chartAverage">₦0</span></small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Main Chart Container -->
                        <div class="chart-wrapper position-relative" style="height: 350px;">
                            <div id="chartLoading" class="position-absolute top-50 start-50 translate-middle d-none">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading chart...</span>
                                </div>
                            </div>
                            <canvas id="priceHistoryChart"></canvas>
                        </div>
                        
                        <!-- Chart Insights Footer -->
                        <div class="chart-insights mt-3 p-3 rounded-4">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-center gap-3">
                                        <span class="trend-indicator" id="chartTrendIndicator">
                                            <i class="bi bi-graph-up-arrow text-success fs-3"></i>
                                        </span>
                                        <div>
                                            <span class="fw-bold text-dark" id="chartTrendText">Upward Trend</span>
                                            <small class="text-muted d-block" id="chartTrendDesc">Consistent price appreciation over time</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="growth-badge">
                                        <span class="badge bg-gradient fs-5" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;" id="chartGrowthBadge">+0.00%</span>
                                        <small class="text-muted d-block mt-1">Total Growth</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="analysis-tab-pane" role="tabpanel" tabindex="0">
                        <!-- Analysis Loading Overlay -->
                        <div id="analysisLoading" class="text-center py-4 d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading analysis...</span>
                            </div>
                            <p class="mt-2 text-muted">Generating market analysis...</p>
                        </div>
                        
                        <div id="analysisContent">
                            <!-- Row 1: Price Performance & Investment Summary -->
                            <div class="row g-3 mb-3">
                                <!-- Price Performance Card -->
                                <div class="col-lg-6">
                                    <div class="card h-100 analysis-card border-0 shadow-sm">
                                        <div class="card-header bg-transparent border-bottom py-2">
                                            <h6 class="card-title mb-0 text-dark">
                                                <i class="bi bi-graph-up-arrow me-2 text-primary"></i>Price Performance
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row text-center mb-3">
                                                <div class="col-6">
                                                    <div class="analysis-metric-box bg-light rounded p-2">
                                                        <small class="text-muted d-block">Presale Price</small>
                                                        <span class="fw-bold text-dark" id="analysisPresale">₦0</span>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="analysis-metric-box bg-light rounded p-2">
                                                        <small class="text-muted d-block">Current Price</small>
                                                        <span class="fw-bold text-primary" id="analysisCurrent">₦0</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2 py-1 border-bottom">
                                                <span class="text-muted small">Latest Change:</span>
                                                <span class="badge bg-success-subtle text-success" id="analysisCurrentChange">+0.00%</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2 py-1 border-bottom">
                                                <span class="text-muted small">Total Appreciation:</span>
                                                <span class="badge bg-primary-subtle text-primary" id="analysisTotalChange">+0.00%</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2 py-1 border-bottom">
                                                <span class="text-muted small">CAGR (Compound Annual):</span>
                                                <span class="fw-bold text-success" id="analysisCAGR">0.00%</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center py-1">
                                                <span class="text-muted small">Price per SQM:</span>
                                                <span class="fw-bold" id="analysisPricePerSqm">₦0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Investment Summary Card -->
                                <div class="col-lg-6">
                                    <div class="card h-100 analysis-card border-0 shadow-sm">
                                        <div class="card-header bg-transparent border-bottom py-2">
                                            <h6 class="card-title mb-0 text-dark">
                                                <i class="bi bi-cash-coin me-2 text-success"></i>Investment Summary
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="investment-highlight text-center mb-3 p-3 bg-success-subtle rounded">
                                                <small class="text-muted d-block">Total Value Gained</small>
                                                <h4 class="text-success mb-0" id="analysisValueGained">₦0</h4>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2 py-1 border-bottom">
                                                <span class="text-muted small">Investment Duration:</span>
                                                <span class="fw-bold" id="analysisInvestDuration">0 months</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2 py-1 border-bottom">
                                                <span class="text-muted small">Monthly Avg Growth:</span>
                                                <span class="fw-bold text-success" id="analysisMonthlyGrowth">+0.00%</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center py-1">
                                                <span class="text-muted small">Annualized Return:</span>
                                                <span class="fw-bold text-primary" id="analysisAnnualReturn">0.00%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Row 2: Location-Based Market Comparison -->
                            <div class="row g-3 mb-3">
                                <div class="col-12">
                                    <div class="card analysis-card border-0 shadow-sm">
                                        <div class="card-header bg-transparent border-bottom py-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="card-title mb-0 text-dark">
                                                    <i class="bi bi-geo-alt-fill me-2 text-info"></i>Location Market Comparison
                                                </h6>
                                                <span class="badge bg-info-subtle text-info" id="analysisLocation">Loading...</span>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <!-- Your Property -->
                                                <div class="col-md-3">
                                                    <div class="comparison-box text-center p-3 rounded bg-primary-subtle border border-primary">
                                                        <i class="bi bi-house-fill fs-4 text-primary mb-2 d-block"></i>
                                                        <small class="text-muted d-block">This Property</small>
                                                        <h5 class="text-primary mb-1" id="compareYourGrowth">+0.0%</h5>
                                                        <small class="text-muted">Growth Rate</small>
                                                    </div>
                                                </div>
                                                <!-- LGA Average -->
                                                <div class="col-md-3">
                                                    <div class="comparison-box text-center p-3 rounded bg-light">
                                                        <i class="bi bi-buildings fs-4 text-secondary mb-2 d-block"></i>
                                                        <small class="text-muted d-block" id="compareLGAName">LGA Average</small>
                                                        <h5 class="mb-1" id="compareLGAGrowth">+0.0%</h5>
                                                        <small id="compareLGADiff" class="text-success">+0% vs LGA</small>
                                                    </div>
                                                </div>
                                                <!-- State Average -->
                                                <div class="col-md-3">
                                                    <div class="comparison-box text-center p-3 rounded bg-light">
                                                        <i class="bi bi-map fs-4 text-secondary mb-2 d-block"></i>
                                                        <small class="text-muted d-block" id="compareStateName">State Average</small>
                                                        <h5 class="mb-1" id="compareStateGrowth">+0.0%</h5>
                                                        <small id="compareStateDiff" class="text-success">+0% vs State</small>
                                                    </div>
                                                </div>
                                                <!-- National Average -->
                                                <div class="col-md-3">
                                                    <div class="comparison-box text-center p-3 rounded bg-light">
                                                        <i class="bi bi-globe-africa fs-4 text-secondary mb-2 d-block"></i>
                                                        <small class="text-muted d-block">National Average</small>
                                                        <h5 class="mb-1" id="compareNationalGrowth">+0.0%</h5>
                                                        <small id="compareNationalDiff" class="text-success">+0% vs National</small>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Market Position Indicator -->
                                            <div class="mt-3 pt-3 border-top">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <span class="text-muted small">Market Position Percentile:</span>
                                                    <span class="fw-bold" id="marketPercentile">Top 50%</span>
                                                </div>
                                                <div class="progress" style="height: 8px;">
                                                    <div class="progress-bar bg-success" role="progressbar" id="marketPositionBar" style="width: 50%"></div>
                                                </div>
                                                <div class="d-flex justify-content-between mt-1">
                                                    <small class="text-muted">Bottom Performer</small>
                                                    <small class="text-muted">Top Performer</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Row 3: Price Projections & Market Intelligence -->
                            <div class="row g-3 mb-3">
                                <!-- Price Projections -->
                                <div class="col-lg-6">
                                    <div class="card h-100 analysis-card border-0 shadow-sm">
                                        <div class="card-header bg-transparent border-bottom py-2">
                                            <h6 class="card-title mb-0 text-dark">
                                                <i class="bi bi-rocket-takeoff me-2 text-warning"></i>Price Projections
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <p class="text-muted small mb-3">
                                                <i class="bi bi-info-circle me-1"></i>
                                                Based on historical growth patterns and market trends
                                            </p>
                                            
                                            <!-- Projection Timeline -->
                                            <div class="projection-item d-flex justify-content-between align-items-center p-2 mb-2 bg-light rounded">
                                                <div>
                                                    <i class="bi bi-calendar-event text-warning me-2"></i>
                                                    <span>1 Year Projection</span>
                                                </div>
                                                <div class="text-end">
                                                    <span class="fw-bold text-success" id="projection1Y">₦0</span>
                                                    <small class="text-muted d-block" id="projection1YPct">(+0%)</small>
                                                </div>
                                            </div>
                                            
                                            <div class="projection-item d-flex justify-content-between align-items-center p-2 mb-2 bg-light rounded">
                                                <div>
                                                    <i class="bi bi-calendar-range text-warning me-2"></i>
                                                    <span>3 Year Projection</span>
                                                </div>
                                                <div class="text-end">
                                                    <span class="fw-bold text-success" id="projection3Y">₦0</span>
                                                    <small class="text-muted d-block" id="projection3YPct">(+0%)</small>
                                                </div>
                                            </div>
                                            
                                            <div class="projection-item d-flex justify-content-between align-items-center p-2 mb-2 bg-light rounded">
                                                <div>
                                                    <i class="bi bi-calendar3 text-warning me-2"></i>
                                                    <span>5 Year Projection</span>
                                                </div>
                                                <div class="text-end">
                                                    <span class="fw-bold text-success" id="projection5Y">₦0</span>
                                                    <small class="text-muted d-block" id="projection5YPct">(+0%)</small>
                                                </div>
                                            </div>
                                            
                                            <!-- Projection Chart Mini -->
                                            <div class="projection-chart-container mt-3" style="height: 100px;">
                                                <canvas id="projectionMiniChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Market Intelligence -->
                                <div class="col-lg-6">
                                    <div class="card h-100 analysis-card border-0 shadow-sm">
                                        <div class="card-header bg-transparent border-bottom py-2">
                                            <h6 class="card-title mb-0 text-dark">
                                                <i class="bi bi-lightbulb me-2 text-purple"></i>Market Intelligence
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <!-- Market Trend -->
                                            <div class="intelligence-item d-flex align-items-start mb-3">
                                                <div class="intelligence-icon bg-success-subtle text-success rounded-circle p-2 me-3">
                                                    <i class="bi bi-arrow-up-right"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-1" id="marketTrendTitle">Upward Trend</h6>
                                                    <p class="text-muted small mb-0" id="marketTrendDesc">
                                                        This property is showing consistent appreciation.
                                                    </p>
                                                </div>
                                            </div>
                                            
                                            <!-- Investment Rating -->
                                            <div class="intelligence-item d-flex align-items-start mb-3">
                                                <div class="intelligence-icon bg-warning-subtle text-warning rounded-circle p-2 me-3">
                                                    <i class="bi bi-star-fill"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-1">Investment Rating</h6>
                                                    <div class="d-flex align-items-center">
                                                        <div class="rating-stars me-2" id="investmentRating">
                                                            <i class="bi bi-star-fill text-warning"></i>
                                                            <i class="bi bi-star-fill text-warning"></i>
                                                            <i class="bi bi-star-fill text-warning"></i>
                                                            <i class="bi bi-star text-muted"></i>
                                                            <i class="bi bi-star text-muted"></i>
                                                        </div>
                                                        <span class="text-muted small" id="ratingLabel">Good</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Key Insights -->
                                            <div class="intelligence-item">
                                                <h6 class="mb-2"><i class="bi bi-clipboard-data me-2 text-info"></i>Key Insights</h6>
                                                <ul class="list-unstyled mb-0" id="keyInsightsList">
                                                    <li class="mb-1">
                                                        <i class="bi bi-check-circle text-success me-1"></i>
                                                        <small>Outperforming local market average</small>
                                                    </li>
                                                    <li class="mb-1">
                                                        <i class="bi bi-check-circle text-success me-1"></i>
                                                        <small>Strong appreciation potential</small>
                                                    </li>
                                                    <li class="mb-1">
                                                        <i class="bi bi-exclamation-circle text-warning me-1"></i>
                                                        <small>Monitor for market volatility</small>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Row 4: Comparative Analysis & Recommendations -->
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="card analysis-card border-0 shadow-sm">
                                        <div class="card-header bg-transparent border-bottom py-2">
                                            <h6 class="card-title mb-0 text-dark">
                                                <i class="bi bi-bar-chart-line me-2 text-secondary"></i>Comparative Growth Analysis
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-lg-8">
                                                    <div class="chart-container" style="height: 200px;">
                                                        <canvas id="comparativeGrowthChart"></canvas>
                                                    </div>
                                                </div>
                                                <div class="col-lg-4">
                                                    <h6 class="text-muted mb-3">Analysis Summary</h6>
                                                    <div class="summary-badge mb-2">
                                                        <span class="badge rounded-pill bg-success-subtle text-success" id="marketBadge">
                                                            <i class="bi bi-trophy me-1"></i>Outperforming Market
                                                        </span>
                                                    </div>
                                                    <div class="recommendation-box p-3 bg-light rounded">
                                                        <h6 class="text-dark mb-2">
                                                            <i class="bi bi-chat-left-quote text-primary me-2"></i>Recommendation
                                                        </h6>
                                                        <p class="text-muted small mb-0" id="analysisRecommendation">
                                                            This property shows strong growth potential. 
                                                            Continue monitoring market trends for optimal selling/holding decisions.
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- ERROR MODAL (For displaying errors instead of alerts) -->
<div class="modal fade" id="prmErrorModal" tabindex="-1" aria-labelledby="prmErrorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white py-3">
                <h5 class="modal-title" id="prmErrorModalLabel">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Error
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="error-icon mb-3">
                    <i class="bi bi-x-circle-fill text-danger" style="font-size: 3rem;"></i>
                </div>
                <h5 class="mb-2" id="errorModalTitle">Something went wrong</h5>
                <p class="text-muted mb-0" id="errorModalMessage">An unexpected error occurred. Please try again.</p>
            </div>
            <div class="modal-footer border-0 justify-content-center pb-4">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger px-4" id="errorModalRetryBtn" style="display: none;">
                    <i class="bi bi-arrow-clockwise me-1"></i>Retry
                </button>
            </div>
        </div>
    </div>
</div>

<!-- PROMO MODAL (Redesigned) -->
<div class="modal fade modal-prm" id="prmPromoModal" tabindex="-1" aria-labelledby="prmPromoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="prmPromoModalLabel">
                    <i class="bi bi-tag-fill"></i>
                    <span id="promoModalTitleText">Create Promotional Offer</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Error Banner -->
                <div id="promoErrorBanner" class="error-banner-promo" style="display: none;">
                    <i class="bi bi-exclamation-circle"></i>
                    <span id="promoErrorMessage">Please fill all required fields</span>
                </div>
                
                <form id="prmPromoForm">
                    <input type="hidden" id="prmPromoId" value="">
                    
                    <!-- Row 1: Promo Name & Discount -->
                    <div class="row mb-4">
                        <div class="col-md-7">
                            <label class="form-label-promo">
                                <i class="bi bi-megaphone-fill"></i> Promo Name
                            </label>
                            <input id="prmPromoName" class="form-control-promo w-100" 
                                   placeholder="e.g., End of Year Sale" required>
                            <div class="error-message-promo" id="promoNameError"></div>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label-promo">
                                <i class="bi bi-percent"></i> Discount
                            </label>
                            <div class="discount-input-wrapper">
                                <input id="prmPromoDiscount" type="number" class="form-control-promo w-100" 
                                       min="1" max="100" placeholder="10" required>
                                <span class="discount-suffix">%</span>
                            </div>
                            <div class="error-message-promo" id="promoDiscountError"></div>
                        </div>
                    </div>
                    
                    <!-- Discount Preview -->
                    <div class="discount-preview" id="discountPreview" style="display: none;">
                        <div class="preview-label">Customers will save</div>
                        <div class="preview-value"><span id="discountPreviewValue">0</span>% OFF</div>
                    </div>
                    
                    <div class="section-divider"></div>
                    
                    <!-- Row 2: Date Range -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label-promo">
                                <i class="bi bi-calendar-check"></i> Start Date
                            </label>
                            <div class="date-range-card">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="date-icon start">
                                        <i class="bi bi-play-fill"></i>
                                    </div>
                                    <input id="prmPromoStart" type="date" class="form-control-promo flex-grow-1" required>
                                </div>
                            </div>
                            <div class="error-message-promo" id="promoStartError"></div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-promo">
                                <i class="bi bi-calendar-x"></i> End Date
                            </label>
                            <div class="date-range-card">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="date-icon end">
                                        <i class="bi bi-stop-fill"></i>
                                    </div>
                                    <input id="prmPromoEnd" type="date" class="form-control-promo flex-grow-1" required>
                                </div>
                            </div>
                            <div class="error-message-promo" id="promoEndError"></div>
                        </div>
                    </div>
                    
                    <div class="section-divider"></div>
                    
                    <!-- Row 3: Applicable Estates -->
                    <div class="mb-4">
                        <label class="form-label-promo">
                            <i class="bi bi-buildings"></i> Applicable Estates
                        </label>
                        <select id="prmPromoEstates" class="form-select-promo w-100" multiple required>
                            {% for estate in estates %}
                            <option value="{{ estate.id }}">{{ estate.name }} - {{ estate.location }}</option>
                            {% endfor %}
                        </select>
                        <div class="estates-help">
                            <i class="bi bi-info-circle me-1"></i>Hold Ctrl (Cmd on Mac) to select multiple estates
                        </div>
                        <div class="error-message-promo" id="promoEstatesError"></div>
                    </div>
                    
                    <!-- Row 4: Description -->
                    <div class="mb-3">
                        <label class="form-label-promo">
                            <i class="bi bi-card-text"></i> Description <span class="text-muted fw-normal">(optional but necessary)</span>
                        </label>
                        <textarea id="prmPromoDesc" class="form-control-promo w-100" rows="3" 
                                  placeholder="Describe the promotional offer..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel-promo" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-1"></i> Cancel
                </button>
                <button id="prmSavePromoBtn" class="btn-save-promo">
                    <i class="bi bi-check2-circle me-1"></i> <span id="promoSaveBtnText">Create Promo</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- PRICE UPDATE MODAL -->
<div class="modal fade modal-prm" id="prmBulkUpdateModal" tabindex="-1" aria-labelledby="prmBulkUpdateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="prmBulkUpdateModalLabel">Price Update</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Error Banner -->
                <div id="bulkErrorBanner" class="error-banner" style="display: none;">
                    <i class="bi bi-exclamation-circle me-2"></i>
                    <span id="bulkErrorMessage">Please fill all required fields</span>
                </div>
                
                <form id="prmBulkUpdateForm">
                    <!-- Row 1: Estate & Effective Date Selection -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label-modern">
                                <i class="bi bi-building"></i> Select Estate
                            </label>
                            <select id="prmBulkEstateSelect" class="form-select-modern w-100" required>
                                <option value="">Choose Estate...</option>
                                {% for estate in estates %}
                                <option value="{{ estate.id }}">{{ estate.name }} - {{ estate.location }}</option>
                                {% endfor %}
                            </select>
                            <div class="error-message" id="bulkEstateError"></div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-modern">
                                <i class="bi bi-calendar-event"></i> Effective Date
                            </label>
                            <input id="prmBulkEffectiveDate" type="date" class="form-control-modern" required>
                            <div class="error-message" id="bulkDateError"></div>
                        </div>
                    </div>

                    <!-- Estate Info Card -->
                    <div id="bulkEstateInfo" class="estate-info-card d-none">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="estate-name" id="bulkEstateNameDisplay"></div>
                                <div class="estate-location" id="bulkEstateLocationDisplay">
                                    <i class="bi bi-geo-alt-fill me-1"></i>
                                    <span id="bulkEstateLocationText"></span>
                                </div>
                            </div>
                            <div class="plot-count">
                                <i class="bi bi-grid-3x3-gap me-1"></i>
                                <span id="bulkTotalPlots">0</span> Plot Sizes
                            </div>
                        </div>
                    </div>

                    <!-- Plot Sizes Price Update Table -->
                    <div id="bulkPriceContainer" class="d-none">
                        <div class="table-container">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width: 5%;">
                                                <input type="checkbox" id="bulkSelectAll" class="form-check-input">
                                            </th>
                                            <th style="width: 18%;">Plot Size</th>
                                            <th style="width: 10%;">Status</th>
                                            <th style="width: 14%;">Presale (₦)</th>
                                            <th style="width: 14%;">Previous (₦)</th>
                                            <th style="width: 17%;">New Price (₦)</th>
                                            <th style="width: 11%;">% Change</th>
                                            <th style="width: 11%;">Total %</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bulkPlotTableBody">
                                        <!-- Plot rows will be inserted here dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Price Change Summary Section -->
                        <div class="summary-section">
                            <div class="section-title">
                                <i class="bi bi-calculator-fill"></i> Price Change Summary
                            </div>
                            <div class="row g-3">
                                <div class="col-md-3 col-6">
                                    <div class="summary-card primary">
                                        <div class="label">Selected Plots</div>
                                        <div class="value" id="bulkSelectedCount">0</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="summary-card info">
                                        <div class="label">Avg % Change</div>
                                        <div class="value" id="bulkAvgChange">0%</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="summary-card success">
                                        <div class="label">Total Increase</div>
                                        <div class="value" id="bulkTotalIncrease">₦0</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="summary-card danger">
                                        <div class="label">Total Decrease</div>
                                        <div class="value" id="bulkTotalDecrease">₦0</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notes Section -->
                        <div class="notes-section">
                            <label class="form-label-modern">
                                <i class="bi bi-journal-text"></i> Notes <span class="text-muted fw-normal">(optional)</span>
                            </label>
                            <textarea id="prmBulkNotes" class="notes-textarea w-100" rows="2" 
                                      placeholder="Add any relevant notes about these price changes..."></textarea>
                        </div>

                        <!-- Notify Toggle -->
                        <label class="notify-toggle">
                            <input id="prmBulkNotifyChk" class="form-check-input" type="checkbox" role="switch" checked>
                            <span class="notify-toggle-text">
                                <i class="bi bi-bell-fill"></i> Notify clients & marketers about these changes
                            </span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel-modern" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-1"></i> Cancel
                </button>
                <button id="prmSaveBulkBtn" class="btn-save-modern" disabled>
                    <i class="bi bi-check2-circle me-1"></i> Update Selected Prices
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Notification Modal -->
<div class="modal fade" id="prmNotifyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Send Notification</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="prmNotifyForm">
          <div class="mb-3">
            <label for="prmNotifyType" class="form-label">Notification Type</label>
            <select id="prmNotifyType" class="form-select" required>
              <option value="price_update">Value Update</option>
              <option value="promotion">Promo Offer</option>
              <option value="new_launch">New Launch</option>
              <option value="client_update">Clients</option>
              <option value="marketer_update">Marketers</option>
              <option value="general_notification">General</option>
            </select>
            <small class="text-muted">Selecting a type will auto-fill a demo message</small>
          </div>
          <div class="mb-3">
            <label for="prmNotifySubject" class="form-label">Subject</label>
            <input type="text" id="prmNotifySubject" class="form-control" placeholder="Enter subject" required>
          </div>
          <div class="mb-3">
            <label for="prmNotifyMessage" class="form-label">Message</label>
            <textarea id="prmNotifyMessage" class="form-control" rows="5" placeholder="Enter your message" required></textarea>
          </div>
          <div class="mb-3" id="notifyEstatesField">
            <label for="prmNotifyEstates" class="form-label">Select Estates</label>
            <select id="prmNotifyEstates" class="form-select" multiple>
              {% for e in estates %}
                <option value="{{ e.id }}">{{ e.name }}</option>
              {% endfor %}
            </select>
            <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Delivery Channels</label>
            <div class="d-flex gap-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="prmNotifyEmail" checked>
                <label class="form-check-label" for="prmNotifyEmail">Email</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="prmNotifyInApp" checked>
                <label class="form-check-label" for="prmNotifyInApp">In-App</label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="prmSendNotifyBtn">Send Notification</button>
      </div>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered text-center">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Success</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="successModalMessage" class="fw-bold text-success"></p>
        <p id="successModalDetail" class="text-muted mb-0"></p>
      </div>
    </div>
  </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered text-center">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Error</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p id="errorModalMessage" class="fw-bold text-danger"></p>
      </div>
    </div>
  </div>
</div>

<script>
    let dispatchPollTimer = null;

    function clearDispatchPolling() {
        if (dispatchPollTimer) {
            clearInterval(dispatchPollTimer);
            dispatchPollTimer = null;
        }
    }
    
    // Global formatNumber function (used by both DOMContentLoaded scope and global helpers)
    function formatNumber(n) {
        return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            document.cookie.split(';').forEach(c => {
                const [k,v] = c.trim().split('=');
                if (k === name) cookieValue = decodeURIComponent(v);
            });
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    document.addEventListener('DOMContentLoaded', () => {
        const requiredIds = ['prmValueModal', 'prmBulkUpdateModal'];
        const missingCoreIds = requiredIds.filter(id => !document.getElementById(id));
        if (missingCoreIds.length) {
            return;
        }

        const getEl = (id) => document.getElementById(id);
        const addListener = (id, event, handler) => {
            const el = getEl(id);
            if (el) {
                el.addEventListener(event, handler);
            }
            return el;
        };

        let currentPresaleEstateId = null;
        let presaleFetchController = null;
        let presaleLoading = false;

        let currentBulkEstateId = null;
        let bulkFetchController = null;
        let bulkLoading = false;

        // Property table pagination state
        const prmPropertyPagination = {
            currentPage: 1,
            pageSize: 5,
        };

        function getPrmPropertyRows() {
            const tbody = document.getElementById('prmPropertyTable');
            if (!tbody) return [];
            return Array.from(tbody.querySelectorAll('tr'));
        }

        function renderPrmPropertyPaginationPages(totalPages) {
            const container = document.getElementById('prmPropertyPaginationPages');
            if (!container) return;
            container.innerHTML = '';

            if (totalPages <= 1) return;

            const current = prmPropertyPagination.currentPage;
            const addPageBtn = (page, active) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = `btn btn-sm ${active ? 'btn-primary' : 'btn-outline-secondary'}`;
                btn.textContent = String(page);
                btn.addEventListener('click', () => {
                    prmPropertyPagination.currentPage = page;
                    applyPrmPropertyPagination();
                });
                container.appendChild(btn);
            };
            const addEllipsis = () => {
                const span = document.createElement('span');
                span.className = 'px-1 text-muted';
                span.textContent = '…';
                container.appendChild(span);
            };

            const maxVisible = 5;
            if (totalPages <= maxVisible + 2) {
                for (let i = 1; i <= totalPages; i++) addPageBtn(i, i === current);
                return;
            }

            addPageBtn(1, current === 1);
            const windowStart = Math.max(2, current - 1);
            const windowEnd = Math.min(totalPages - 1, current + 1);
            if (windowStart > 2) addEllipsis();
            for (let i = windowStart; i <= windowEnd; i++) addPageBtn(i, i === current);
            if (windowEnd < totalPages - 1) addEllipsis();
            addPageBtn(totalPages, current === totalPages);
        }

        function applyPrmPropertyPagination() {
            const tbody = document.getElementById('prmPropertyTable');
            if (!tbody) return;

            const searchInput = document.getElementById('prmPropertySearchInput');
            const query = (searchInput?.value || '').trim().toLowerCase();

            const clearBtn = document.getElementById('prmPropertyClearSearch');
            if (clearBtn) clearBtn.style.display = query ? 'inline-flex' : 'none';

            const allRows = getPrmPropertyRows();
            const filteredRows = query
                ? allRows.filter(r => (r.textContent || '').toLowerCase().includes(query))
                : allRows;

            const resultsInfo = document.getElementById('prmPropertySearchResultsInfo');
            const resultsCount = document.getElementById('prmPropertySearchResultsCount');
            if (resultsInfo && resultsCount) {
                resultsCount.textContent = String(filteredRows.length);
                resultsInfo.style.display = query ? 'inline' : 'none';
            }

            prmPropertyPagination.pageSize = parseInt(document.getElementById('prmPropertyPageSize')?.value || '5', 10) || 5;

            const totalItems = filteredRows.length;
            const totalPages = Math.max(1, Math.ceil(totalItems / prmPropertyPagination.pageSize));
            prmPropertyPagination.currentPage = Math.min(prmPropertyPagination.currentPage, totalPages);

            const startIndex = (prmPropertyPagination.currentPage - 1) * prmPropertyPagination.pageSize;
            const endIndex = startIndex + prmPropertyPagination.pageSize;
            const pageRows = filteredRows.slice(startIndex, endIndex);

            // Hide all rows, then show current page
            allRows.forEach(r => { r.style.display = 'none'; });
            pageRows.forEach(r => { r.style.display = ''; });

            // Update summary + controls
            const paginationContainer = document.getElementById('prmPropertyPaginationContainer');
            const showingStart = document.getElementById('prmPropertyShowingStart');
            const showingEnd = document.getElementById('prmPropertyShowingEnd');
            const totalItemsEl = document.getElementById('prmPropertyTotalItems');
            const prevBtn = document.getElementById('prmPropertyPrevPage');
            const nextBtn = document.getElementById('prmPropertyNextPage');

            if (totalItemsEl) totalItemsEl.textContent = String(totalItems);
            if (showingStart) showingStart.textContent = totalItems === 0 ? '0' : String(startIndex + 1);
            if (showingEnd) showingEnd.textContent = totalItems === 0 ? '0' : String(Math.min(endIndex, totalItems));

            if (prevBtn) prevBtn.disabled = prmPropertyPagination.currentPage <= 1;
            if (nextBtn) nextBtn.disabled = prmPropertyPagination.currentPage >= totalPages;
            renderPrmPropertyPaginationPages(totalPages);

            if (paginationContainer) {
                paginationContainer.style.display = totalItems > 0 ? 'flex' : 'none';
            }
        }

        // Expose for internal helpers that may refresh/append rows
        window.applyPrmPropertyPagination = applyPrmPropertyPagination;

        // Wire up property table pagination controls
        addListener('prmPropertySearchInput', 'input', () => {
            prmPropertyPagination.currentPage = 1;
            applyPrmPropertyPagination();
        });
        addListener('prmPropertyClearSearch', 'click', () => {
            const input = document.getElementById('prmPropertySearchInput');
            if (input) input.value = '';
            prmPropertyPagination.currentPage = 1;
            applyPrmPropertyPagination();
        });
        addListener('prmPropertyPageSize', 'change', () => {
            prmPropertyPagination.currentPage = 1;
            applyPrmPropertyPagination();
        });
        addListener('prmPropertyPrevPage', 'click', () => {
            if (prmPropertyPagination.currentPage > 1) {
                prmPropertyPagination.currentPage -= 1;
                applyPrmPropertyPagination();
            }
        });
        addListener('prmPropertyNextPage', 'click', () => {
            prmPropertyPagination.currentPage += 1;
            applyPrmPropertyPagination();
        });

        // Bootstrap modal instances (guard optional ones to avoid interference)
        const prmValueModal   = new bootstrap.Modal(document.getElementById('prmValueModal'));
        const prmEditModalEl  = getEl('prmEditModal');
        const prmHistoryModalEl = getEl('prmHistoryModal');
        const prmNotifyModalEl  = getEl('prmNotifyModal');
        const prmBulkUpdateModal = new bootstrap.Modal(document.getElementById('prmBulkUpdateModal'));
        const prmEditModal    = prmEditModalEl ? new bootstrap.Modal(prmEditModalEl) : null;
        const prmHistoryModal = prmHistoryModalEl ? new bootstrap.Modal(prmHistoryModalEl) : null;
        const prmNotifyModal  = prmNotifyModalEl ? new bootstrap.Modal(prmNotifyModalEl) : null;
        const successModalEl  = getEl('successModal');
        const successModal    = successModalEl ? new bootstrap.Modal(successModalEl) : null;
        const successMessageEl = getEl('successModalMessage');
        const successDetailEl  = getEl('successModalDetail');

        if (successModalEl) {
            successModalEl.addEventListener('hidden.bs.modal', clearDispatchPolling);
        }
        
        // Fix aria-hidden focus issue - blur focused elements before modal hides
        const modalElements = document.querySelectorAll('.modal');
        modalElements.forEach(modal => {
            modal.addEventListener('hide.bs.modal', function() {
                const focusedElement = this.querySelector(':focus');
                if (focusedElement) {
                    focusedElement.blur();
                }
            });
        });

        // cache promo modal elements and guard optional modal
        const promoModalEl     = document.getElementById('prmPromoModal');
        const promoModal       = promoModalEl ? new bootstrap.Modal(promoModalEl) : null;
        const promoIdInput     = document.getElementById('prmPromoId');
        const promoNameInput   = document.getElementById('prmPromoName');
        const promoDiscount    = document.getElementById('prmPromoDiscount');
        const promoStart       = document.getElementById('prmPromoStart');
        const promoEnd         = document.getElementById('prmPromoEnd');
        const promoDesc        = document.getElementById('prmPromoDesc');
        const promoEstates     = document.getElementById('prmPromoEstates');
        const promoTitle       = document.getElementById('prmPromoModalLabel');
        

        // Set Presale Price
        const setPresaleBtn = addListener('prmAddRegBtn', 'click', () => {
            resetValueModal();
            prmValueModal.show();
        });

        // Price Update Button
        const bulkBtn = addListener('prmBulkUpdateBtn', 'click', () => {
            openBulkUpdateModal();
        });

        // Open “Create Promotional Offer” modal only when promo modal exists
        if (promoModal) {
            const createPromoBtn = addListener('prmCreatePromoBtn', 'click', () => {
                resetPromoModal();
                promoModal.show();
            });
        }


        if (promoModal && promoEstates) {
            // Prefill fields if a single estate is selected AND it has an active promo
            promoEstates.addEventListener('change', () => {
                const selected = Array.from(promoEstates.selectedOptions).map(opt => opt.value);
                if (selected.length === 1) {
                    fetch(`/api/promo/estate/${selected[0]}/active/`, {
                        headers: { 'X-CSRFToken': csrftoken }
                    })
                    .then(r => r.json())
                    .then(res => {
                        // Only prefill if there's an active promo for this estate
                        if (res.status === 'ok' && res.data) {
                            const p = res.data;
                            promoIdInput.value   = p.id || '';
                            promoNameInput.value = p.name;
                            promoDiscount.value  = p.discount;
                            promoStart.value     = p.start.slice(0,10);
                            promoEnd.value       = p.end.slice(0,10);
                            promoDesc.value      = p.description || '';
                            document.getElementById('promoModalTitleText').textContent = 'Edit Promotional Offer';
                            document.getElementById('promoSaveBtnText').textContent = 'Update Promo';
                            
                            // Show discount preview
                            const preview = document.getElementById('discountPreview');
                            const previewValue = document.getElementById('discountPreviewValue');
                            if (preview && previewValue && p.discount > 0) {
                                previewValue.textContent = p.discount;
                                preview.style.display = 'block';
                            }
                        } else {
                            // No active promo - clear prefilled fields and reset to Create mode
                            promoIdInput.value   = '';
                            promoNameInput.value = '';
                            promoDiscount.value  = '';
                            promoDesc.value      = '';
                            const today = new Date().toISOString().slice(0,10);
                            promoStart.value     = today;
                            promoEnd.value       = today;
                            document.getElementById('promoModalTitleText').textContent = 'Create Promotional Offer';
                            document.getElementById('promoSaveBtnText').textContent = 'Create Promo';
                            
                            const preview = document.getElementById('discountPreview');
                            if (preview) preview.style.display = 'none';
                        }
                    })
                    .catch(() => {
                        // On error - reset to Create mode
                        promoIdInput.value   = '';
                        promoNameInput.value = '';
                        promoDiscount.value  = '';
                        promoDesc.value      = '';
                        const today = new Date().toISOString().slice(0,10);
                        promoStart.value     = today;
                        promoEnd.value       = today;
                        document.getElementById('promoModalTitleText').textContent = 'Create Promotional Offer';
                        document.getElementById('promoSaveBtnText').textContent = 'Create Promo';
                        const preview = document.getElementById('discountPreview');
                        if (preview) preview.style.display = 'none';
                    });
                }
            });
        }
                
        const notifyBtn = getEl('prmNotifyClientsBtn');
        if (notifyBtn && prmNotifyModal) {
            notifyBtn.addEventListener('click', () => prmNotifyModal.show());
        }
        addListener('prmSendNotifyBtn', 'click', sendNotification);

        // Demo messages for notification types (must be defined before initNotificationTypeHandling)
        const notifyDemoMessages = {
            price_update: {
                subject: 'Property Value Update Notice',
                message: 'Dear Valued Customer,\n\nWe are pleased to inform you that property values in your estate have been updated. This reflects the current market appreciation and infrastructure developments.\n\nPlease log in to your dashboard to view the updated prices.\n\nBest regards,\nThe Management Team'
            },
            promotion: {
                subject: 'Exclusive Promotional Offer!',
                message: 'Dear Customer,\n\nGreat news! We have an exciting promotional offer just for you.\n\nFor a limited time, enjoy special discounts on selected properties. Don\'t miss this opportunity to expand your investment portfolio at reduced rates.\n\nTerms and conditions apply.\n\nWarm regards,\nThe Sales Team'
            },
            new_launch: {
                subject: 'New Estate Launch Announcement',
                message: 'Dear Esteemed Customer,\n\nWe are thrilled to announce the launch of our newest estate development!\n\nThis premium project features:\n- Strategic location with excellent accessibility\n- Modern infrastructure and amenities\n- Flexible payment plans\n- Attractive early-bird discounts\n\nBe among the first to secure your plot.\n\nBest regards,\nThe Development Team'
            },
            client_update: {
                subject: 'Important Update for Clients',
                message: 'Dear Client,\n\nWe hope this message finds you well. We have an important update regarding your account/property.\n\nPlease review the details in your dashboard and contact our support team if you have any questions.\n\nThank you for your continued trust in us.\n\nSincerely,\nCustomer Relations Team'
            },
            marketer_update: {
                subject: 'Marketer Update & Commission Notice',
                message: 'Dear Marketing Partner,\n\nThank you for your continued efforts in promoting our properties.\n\nThis is to inform you of important updates regarding:\n- Commission structures\n- New properties available for marketing\n- Upcoming training sessions\n- Performance incentives\n\nPlease check your dashboard for full details.\n\nBest regards,\nThe Marketing Department'
            },
            general_notification: {
                subject: 'Important Announcement',
                message: 'Dear Customer,\n\nWe hope this message finds you well.\n\nWe have an important announcement to share with you. Please take a moment to read through this notification carefully.\n\nFor any questions, please reach out to our support team.\n\nThank you.\n\nBest regards,\nThe Management'
            }
        };

        // Initialize notification type handling
        initNotificationTypeHandling();

        // Initialize price chart
        initPriceChart();

        // Event handlers
        addListener('prmEstateSelect', 'change', handleEstateChange);
        addListener('prmEditCurrentPrice', 'input', calculatePriceChange);
        addListener('prmSaveRegBtn', 'click', savePresalePrice);
        addListener('prmSaveEditBtn', 'click', saveEditPrice);
        // prmSavePromoBtn listener will be added after savePromo function is defined
        
        // Clear errors on input - Presale modal
        addListener('prmEffectiveDate', 'change', function() {
            clearFieldError(this, 'prmDateError');
            hideErrorBanner();
        });
        
        // Clear errors on input - Edit modal
        addListener('prmEditCurrentPrice', 'input', function() {
            clearFieldError(this, 'prmEditCurrentError');
            hideEditErrorBanner();
        });
        addListener('prmEditEffectiveDate', 'change', function() {
            clearFieldError(this, 'prmEditDateError');
            hideEditErrorBanner();
        });
        
        // Action button handlers
        const propertyTable = document.querySelector('#prmPropertyTable');
        if (propertyTable) {
            propertyTable.addEventListener('click', (e) => {
                try {
                    const btn = e.target.closest('button');
                    if (!btn) return;
                    
                    const action = btn.getAttribute('data-action');
                    const id = btn.getAttribute('data-id');
                    const estateId = btn.getAttribute('data-estate');
                    const unitId = btn.getAttribute('data-unit');
                    
                    if (action === 'edit') {
                        openEditModal(id);
                    } 
                    else if (action === 'history') {
                        openHistoryModal(id);
                    }
                    else if (action === 'add') {
                        openAddModal(estateId, unitId);
                    }
                } catch (error) {
                    console.error('Error in action handler:', error);
                }
            });
        }

        // Initialize with today's date
        const today = new Date().toISOString().slice(0,10);
        const presaleDateInput = getEl('prmEffectiveDate');
        if (presaleDateInput) presaleDateInput.value = today;
        const editDateInput = getEl('prmEditEffectiveDate');
        if (editDateInput) editDateInput.value = today;

        // Helper functions
        function initNotificationTypeHandling() {
            const notifyTypeSelect = document.getElementById('prmNotifyType');
            const estatesField = document.getElementById('notifyEstatesField');
            const subjectInput = document.getElementById('prmNotifySubject');
            const messageInput = document.getElementById('prmNotifyMessage');
            
            if (!notifyTypeSelect || !estatesField || !subjectInput || !messageInput) {
                return;
            }
            
            // Prefill demo message function
            function prefillDemoMessage(type) {
                if (notifyDemoMessages[type]) {
                    subjectInput.value = notifyDemoMessages[type].subject;
                    messageInput.value = notifyDemoMessages[type].message;
                }
            }
            
            // Initial state
            toggleEstatesVisibility(notifyTypeSelect.value, estatesField);
            prefillDemoMessage(notifyTypeSelect.value);
            
            // Type change listener
            notifyTypeSelect.addEventListener('change', () => {
                toggleEstatesVisibility(notifyTypeSelect.value, estatesField);
                prefillDemoMessage(notifyTypeSelect.value);
            });
        }
        
        function toggleEstatesVisibility(type, element) {
            const hideTypes = ['client_update', 'marketer_update', 'general_notification'];
            if (hideTypes.includes(type)) {
                element.classList.add('d-none');
            } else {
                element.classList.remove('d-none');
            }
        }

        // Helper functions
        function resetValueModal() {
            document.getElementById('prmPropertyId').value = '';
            document.getElementById('prmEstateSelect').value = '';
            document.getElementById('prmEffectiveDate').value = new Date().toISOString().slice(0,10);
            document.getElementById('prmNotes').value = '';
            document.getElementById('prmNotifyChk').checked = true;
            document.getElementById('prmValueModalLabel').textContent = "Set Presale Prices";
            document.getElementById('presaleEstateInfo').classList.add('d-none');
            document.getElementById('presalePriceContainer').classList.add('d-none');
            document.getElementById('prmSaveRegBtn').disabled = true;
            // Reset summary
            document.getElementById('presaleSelectedCount').textContent = '0';
            document.getElementById('presaleNewCount').textContent = '0';
            document.getElementById('presaleUpdateCount').textContent = '0';
            // Clear error state
            clearPresaleErrors();
        }

        function resetEditModal() {
            document.getElementById('prmEditPropertyId').value = '';
            document.getElementById('prmEditEstate').value = '';
            document.getElementById('prmEditPlotSize').value = '';
            document.getElementById('prmEditLocation').value = '';
            document.getElementById('prmEditPresalePrice').value = '';
            document.getElementById('prmEditPrevPrice').value = '';
            document.getElementById('prmEditCurrentPrice').value = '';
            document.getElementById('prmEditNotes').value = '';
            document.getElementById('prmEditNotifyChk').checked = true;
            document.getElementById('prmEditModalLabel').textContent = "Update Property Price";
        }

        function parseFormattedNumber(str) {
            return parseFloat(str.replace(/,/g, '')) || 0;
        }

        function calculatePriceChange() {
            const prev = parseFormattedNumber(document.getElementById('prmEditPrevPrice').value);
            const current = parseFloat(document.getElementById('prmEditCurrentPrice').value) || 0;
            const presale = parseFormattedNumber(document.getElementById('prmEditPresalePrice').value);
            
            if (!prev || !presale) return;
            
            const change = ((current - prev) / prev) * 100;
            const cumulative = ((current - presale) / presale) * 100;
            
            document.getElementById('newPriceCalc').textContent = '₦' + formatNumber(current);
            document.getElementById('changeCalc').textContent = (change > 0 ? '+' : '') + change.toFixed(2) + '%';
            document.getElementById('cumulativeCalc').textContent = (cumulative > 0 ? '+' : '') + cumulative.toFixed(2) + '%';
            
            document.getElementById('changeCalc').className = 'price-change ' + 
                (change > 0 ? 'increase-prm' : change < 0 ? 'decrease-prm' : '');
                
            document.getElementById('cumulativeCalc').className = 'price-change ' + 
                (cumulative > 0 ? 'increase-prm' : cumulative < 0 ? 'decrease-prm' : '');
        }

        function handleEstateChange(e) {
            const selectEl = e && e.target ? e.target : getEl('prmEstateSelect');
            if (!selectEl) {
                return;
            }
            const estateId = selectEl.value;
            
            // Clear error when user selects
            clearFieldError(selectEl, 'prmEstateError');
            hideErrorBanner();
            
            if (!estateId) {
                document.getElementById('presaleEstateInfo').classList.add('d-none');
                document.getElementById('presalePriceContainer').classList.add('d-none');
                document.getElementById('prmSaveRegBtn').disabled = true;
                return;
            }

            // Show loading state
            const tbody = document.getElementById('presalePlotTableBody');
            tbody.innerHTML = `
                <tr class="loading-row">
                    <td colspan="5">
                        <div class="loading-spinner">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <span>Loading plot sizes...</span>
                        </div>
                    </td>
                </tr>`;
            document.getElementById('presalePriceContainer').classList.remove('d-none');

            // Fetch estate data with all plot sizes and current presale prices
            fetch(`/api/estate/${estateId}/bulk-price-data/`, {
                headers: { 'X-CSRFToken': csrftoken }
            })
            .then(r => r.json())
            .then(data => {
                // Display estate info
                document.getElementById('presaleEstateNameDisplay').textContent = data.estate.name;
                const locationTextEl = document.getElementById('presaleEstateLocationText');
                if (locationTextEl) {
                    locationTextEl.textContent = data.estate.location;
                }
                document.getElementById('presaleTotalPlots').textContent = data.plot_units.length;
                document.getElementById('presaleEstateInfo').classList.remove('d-none');

                // Populate table with plot sizes
                tbody.innerHTML = '';
                
                if (data.plot_units.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <i class="bi bi-info-circle text-muted me-2"></i>
                                No plot sizes found for this estate. Add plot sizes first.
                            </td>
                        </tr>`;
                    return;
                }
                
                data.plot_units.forEach((unit, index) => {
                    const presale = unit.presale || 0;
                    const isAvailable = unit.available > 0;
                    const hasPresale = presale > 0;
                    const isSoldOut = unit.available === 0;
                    
                    // Determine status
                    let statusClass = 'available';
                    let statusText = 'Available';
                    if (isSoldOut) {
                        statusClass = 'sold-out';
                        statusText = 'Sold Out';
                    } else if (hasPresale) {
                        statusClass = 'has-presale';
                        statusText = 'Has Presale';
                    } else {
                        statusClass = 'no-presale';
                        statusText = 'No Presale';
                    }
                    
                    const row = `
                        <tr data-unit-id="${unit.id}" data-current-presale="${presale}">
                            <td>
                                <input type="checkbox" class="form-check-input presale-plot-checkbox" 
                                       data-unit-id="${unit.id}" ${!isSoldOut ? 'checked' : ''} 
                                       ${isSoldOut ? 'disabled' : ''}>
                            </td>
                            <td>
                                <strong>${unit.size}</strong>
                                <div class="text-muted" style="font-size: 0.8rem;">${unit.available} of ${unit.total} available</div>
                            </td>
                            <td>
                                <span class="status-badge-presale ${statusClass}">
                                    ${statusText}
                                </span>
                            </td>
                            <td>
                                <span class="fw-semibold ${presale > 0 ? 'text-success' : 'text-muted'}">
                                    ${presale > 0 ? '₦' + formatNumber(presale) : '—'}
                                </span>
                            </td>
                            <td>
                                <input type="text" class="presale-price-input" 
                                       data-unit-id="${unit.id}" data-raw-value="${presale}" 
                                       value="${presale > 0 ? formatNumber(presale) : ''}" 
                                       placeholder="Enter presale" ${isSoldOut ? 'disabled' : ''}>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });

                // Update summary
                updatePresaleSummary();

                // Add event listeners to new presale price inputs with formatting
                document.querySelectorAll('.presale-price-input').forEach(input => {
                    input.addEventListener('input', function(e) {
                        const cursorPos = this.selectionStart;
                        const oldLength = this.value.length;
                        
                        let rawValue = this.value.replace(/[^0-9]/g, '');
                        this.setAttribute('data-raw-value', rawValue);
                        
                        if (rawValue) {
                            this.value = formatNumber(parseInt(rawValue, 10));
                        }
                        
                        const newLength = this.value.length;
                        const diff = newLength - oldLength;
                        this.setSelectionRange(cursorPos + diff, cursorPos + diff);
                        
                        // Check if value changed from original
                        const row = this.closest('tr');
                        const originalPresale = row.getAttribute('data-current-presale') || '0';
                        if (rawValue && rawValue !== originalPresale) {
                            this.classList.add('has-change');
                        } else {
                            this.classList.remove('has-change');
                        }
                        
                        updatePresaleSummary();
                    });
                    
                    input.addEventListener('blur', function() {
                        const rawValue = this.getAttribute('data-raw-value') || this.value.replace(/[^0-9]/g, '');
                        if (rawValue) {
                            this.value = formatNumber(parseInt(rawValue, 10));
                        }
                    });
                });

                // Add event listeners to checkboxes
                document.querySelectorAll('.presale-plot-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        updatePresaleSummary();
                        updatePresaleSelectAllState();
                    });
                });

                // Select All checkbox handler
                const selectAllEl = document.getElementById('presaleSelectAll');
                // Remove existing listener to prevent duplicates
                const newSelectAll = selectAllEl.cloneNode(true);
                selectAllEl.parentNode.replaceChild(newSelectAll, selectAllEl);
                newSelectAll.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('.presale-plot-checkbox:not(:disabled)');
                    checkboxes.forEach(cb => cb.checked = this.checked);
                    updatePresaleSummary();
                });
            })
            .catch(error => {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading data. Please try again.</td></tr>';
            });
        }
        
        function updatePresaleSummary() {
            const checkboxes = document.querySelectorAll('.presale-plot-checkbox:checked');
            let selectedCount = 0;
            let newCount = 0;
            let updateCount = 0;
            
            checkboxes.forEach(cb => {
                const unitId = cb.getAttribute('data-unit-id');
                const row = cb.closest('tr');
                const currentPresale = parseFloat(row.getAttribute('data-current-presale')) || 0;
                const input = row.querySelector('.presale-price-input');
                const rawValue = input.getAttribute('data-raw-value') || input.value.replace(/[^0-9]/g, '');
                const newPresale = parseFloat(rawValue) || 0;
                
                if (newPresale > 0) {
                    selectedCount++;
                    if (currentPresale === 0) {
                        newCount++;
                    } else if (newPresale !== currentPresale) {
                        updateCount++;
                    }
                }
            });
            
            document.getElementById('presaleSelectedCount').textContent = selectedCount;
            document.getElementById('presaleNewCount').textContent = newCount;
            document.getElementById('presaleUpdateCount').textContent = updateCount;
            
            // Enable/disable save button based on whether there are valid entries
            const saveBtn = document.getElementById('prmSaveRegBtn');
            saveBtn.disabled = selectedCount === 0;
        }
        
        function updatePresaleSelectAllState() {
            const allCheckboxes = document.querySelectorAll('.presale-plot-checkbox:not(:disabled)');
            const checkedBoxes = document.querySelectorAll('.presale-plot-checkbox:checked');
            const selectAll = document.getElementById('presaleSelectAll');
            
            if (checkedBoxes.length === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            } else if (checkedBoxes.length === allCheckboxes.length) {
                selectAll.checked = true;
                selectAll.indeterminate = false;
            } else {
                selectAll.checked = false;
                selectAll.indeterminate = true;
            }
        }

        // Legacy function - kept for table action buttons
        function openAddModal(estateId, unitId) {
            resetValueModal();
            const selectEl = document.getElementById('prmEstateSelect');
            if (!selectEl) {
                return;
            }
            selectEl.value = estateId;
            // Call handler directly with mock event
            handleEstateChange({ target: selectEl });
            
            prmValueModal.show();
        }

        function openEditModal(id) {
            if (!prmEditModal) {
                return;
            }
            
            resetEditModal();
            document.getElementById('prmEditPropertyId').value = id;
            
            // Set skeleton data immediately
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (row) {
                const cells = row.cells;
                document.getElementById('prmEditEstate').value = cells[0].textContent.trim();
                document.getElementById('prmEditPlotSize').value = cells[1].textContent;
                document.getElementById('prmEditLocation').value = cells[2].textContent;
                document.getElementById('prmEditPresalePrice').value = cells[3].textContent.trim() || '0';
                document.getElementById('prmEditPrevPrice').value = cells[4].textContent.trim() || '0';
                document.getElementById('prmEditCurrentPrice').value = cells[5].textContent.trim().replace(/,/g, '') || '0';
                
                // Calculate immediately with current values
                calculatePriceChange();
            }
            
            // Show the modal
            prmEditModal.show();

            // Then fetch updated data from server
            fetch(`/api/property-price/${id}/`, {
                headers: {'X-CSRFToken': csrftoken}
            })
            .then(r => r.json())
            .then(pp => {
                document.getElementById('prmEditEstate').value = pp.estate.name;
                document.getElementById('prmEditPlotSize').value = pp.plot_unit.plot_size.size;
                document.getElementById('prmEditLocation').value = pp.estate.location;
                document.getElementById('prmEditPresalePrice').value = formatNumber(pp.presale);
                document.getElementById('prmEditPrevPrice').value = formatNumber(pp.previous);
                document.getElementById('prmEditCurrentPrice').value = pp.current;
                document.getElementById('prmEditEffectiveDate').value = pp.effective.split('T')[0];
                document.getElementById('prmEditNotes').value = pp.notes || '';
                
                // Update calculations with fresh data
                document.getElementById('prevPriceCalc').textContent = '₦' + formatNumber(pp.previous);
                document.getElementById('newPriceCalc').textContent = '₦' + formatNumber(pp.current);
                calculatePriceChange();
            })
            .catch(error => {
                console.error('Error loading property data:', error);
                // Keep showing the modal with skeleton data
            });
        }

        function openHistoryModal(id) {
            if (!prmHistoryModal) {
                return;
            }
            
            // Show loading state for analysis
            const analysisLoading = document.getElementById('analysisLoading');
            const analysisContent = document.getElementById('analysisContent');
            if (analysisLoading) analysisLoading.classList.remove('d-none');
            if (analysisContent) analysisContent.style.opacity = '0.5';
            
            fetch(`/api/property-price/${id}/history/`, {
                headers: { 'X-CSRFToken': csrftoken }
            })
            .then(r => r.json())
            .then(json => {
                const list = document.getElementById('historyList');
                list.innerHTML = '';
                const labels = [];
                const values = [];

                // Reverse the history array to show latest first
                [...json.history].reverse().forEach(h => {
                    // Highlight promo events
                    const isPromo = h.is_promo || h.notes.includes('PROMO');
                    const promoClass = isPromo ? 'promo-event' : '';
                    const icon = isPromo ? '<i class="bi bi-tag-fill me-1"></i>' : '';
                    
                    list.insertAdjacentHTML('beforeend', `
                        <div class="history-item ${promoClass}">
                            <div class="d-flex justify-content-between">
                                <div class="history-price">${icon}₦${formatNumber(h.current)}</div>
                                <div class="history-date">${new Date(h.effective).toLocaleDateString()}</div>
                            </div>
                            <div class="${h.current > h.previous ? 'text-success' : 'text-danger'}">
                                ${((h.current - h.previous) / h.previous * 100).toFixed(1)}%
                                ${h.current > h.previous ? ' increase' : ' decrease'}
                            </div>
                            <div class="text-muted mt-1">${h.notes}</div>
                        </div>
                    `);
                });

                // For chart - use all points in original order
                json.history.forEach(h => {
                    labels.push(new Date(h.effective).toLocaleDateString('en-US', { month:'short', year:'numeric' }));
                    values.push(h.current);
                });

                // 2) Header info
                const row = document.querySelector(`tr[data-id="${id}"]`);
                document.getElementById('historyEstateName').textContent =
                row.cells[0].innerText.trim();
                document.getElementById('historyPlotSize').textContent =
                `${row.cells[1].innerText} - ${row.cells[2].innerText}`;

                // 3) Presale & Current
                const presaleVal = values[0] || 0;
                const latestVal  = values[values.length - 1] || 0;
                document.getElementById('historyPresale').textContent =
                '₦' + formatNumber(presaleVal);
                document.getElementById('historyCurrent').textContent =
                '₦' + formatNumber(latestVal);

                // 4) Chart update with wave animation
                const chartData = [...values].reverse();
                window.historyChart.data.labels = [...labels].reverse();
                window.historyChart.data.datasets[0].data = chartData;
                window.historyChart.update('active');
                
                // Update chart statistics
                updateChartStats(chartData);

                // 5) Enhanced Analysis Population
                populateEnhancedAnalysis(json, presaleVal, latestVal, values, labels);

                // 6) Promo badge (guarded)
                const badge = document.getElementById('promoBadge');
                if (badge) {
                if (json.promo_applied) {
                    badge.textContent = `${json.promo_discount}% OFF until ${
                    new Date(json.promo_expires).toLocaleDateString()
                    }`;
                    badge.classList.remove('d-none');
                } else {
                    badge.classList.add('d-none');
                }
                }
                
                // Hide loading state
                if (analysisLoading) analysisLoading.classList.add('d-none');
                if (analysisContent) analysisContent.style.opacity = '1';

                // 7) Finally show it
                prmHistoryModal.show();
            })
            .catch(err => {
                console.error('Error loading history:', err);
                if (analysisLoading) analysisLoading.classList.add('d-none');
                if (analysisContent) analysisContent.style.opacity = '1';
                showHistoryErrorModal('Failed to load price history. Please try again.');
            });
        }
        
        // Enhanced Analysis Population Function
        function populateEnhancedAnalysis(json, presaleVal, latestVal, values, labels) {
            const analysis = json.analysis || {};
            
            // Price Performance
            document.getElementById('analysisPresale').textContent = '₦' + formatNumber(presaleVal);
            document.getElementById('analysisCurrent').textContent = '₦' + formatNumber(latestVal);
            
            const currentChange = json.current_change || 0;
            const totalChange = json.total_change || 0;
            
            // Current Change with color
            const currentChangeEl = document.getElementById('analysisCurrentChange');
            currentChangeEl.textContent = (currentChange >= 0 ? '+' : '') + currentChange.toFixed(2) + '%';
            currentChangeEl.className = currentChange >= 0 ? 'badge bg-success-subtle text-success' : 'badge bg-danger-subtle text-danger';
            
            // Total Change with color
            const totalChangeEl = document.getElementById('analysisTotalChange');
            totalChangeEl.textContent = (totalChange >= 0 ? '+' : '') + totalChange.toFixed(2) + '%';
            totalChangeEl.className = totalChange >= 0 ? 'badge bg-primary-subtle text-primary' : 'badge bg-danger-subtle text-danger';
            
            // CAGR & Price per SQM
            const cagr = analysis.cagr || 0;
            document.getElementById('analysisCAGR').textContent = cagr.toFixed(2) + '%';
            document.getElementById('analysisCAGR').className = cagr >= 0 ? 'fw-bold text-success' : 'fw-bold text-danger';
            
            document.getElementById('analysisPricePerSqm').textContent = '₦' + formatNumber(analysis.price_per_sqm || 0);
            
            // Investment Summary
            const valueGained = analysis.value_gained || (latestVal - presaleVal);
            document.getElementById('analysisValueGained').textContent = (valueGained >= 0 ? '+' : '') + '₦' + formatNumber(Math.abs(valueGained));
            document.getElementById('analysisValueGained').className = valueGained >= 0 ? 'text-success mb-0' : 'text-danger mb-0';
            
            const durationMonths = analysis.duration_months || 1;
            const years = Math.floor(durationMonths / 12);
            const months = durationMonths % 12;
            let durationText = '';
            if (years > 0) durationText += years + ' year' + (years > 1 ? 's' : '');
            if (months > 0) durationText += (years > 0 ? ' ' : '') + months + ' month' + (months > 1 ? 's' : '');
            document.getElementById('analysisInvestDuration').textContent = durationText || '< 1 month';
            
            const monthlyGrowth = analysis.monthly_growth || 0;
            document.getElementById('analysisMonthlyGrowth').textContent = (monthlyGrowth >= 0 ? '+' : '') + monthlyGrowth.toFixed(2) + '%';
            document.getElementById('analysisMonthlyGrowth').className = monthlyGrowth >= 0 ? 'fw-bold text-success' : 'fw-bold text-danger';
            
            document.getElementById('analysisAnnualReturn').textContent = (analysis.annual_return || 0).toFixed(2) + '%';
            
            // Location Comparison
            document.getElementById('analysisLocation').textContent = analysis.location || 'N/A';
            
            const yourGrowth = analysis.your_growth || totalChange;
            document.getElementById('compareYourGrowth').textContent = (yourGrowth >= 0 ? '+' : '') + yourGrowth.toFixed(1) + '%';
            
            // Area (LGA) Comparison
            const lgaAvg = analysis.lga_avg_growth || 8.5;
            document.getElementById('compareLGAName').textContent = (analysis.area || 'Area') + ' Avg';
            document.getElementById('compareLGAGrowth').textContent = '+' + lgaAvg.toFixed(1) + '%';
            const lgaDiff = yourGrowth - lgaAvg;
            const lgaDiffEl = document.getElementById('compareLGADiff');
            lgaDiffEl.textContent = (lgaDiff >= 0 ? '+' : '') + lgaDiff.toFixed(1) + '% vs Area';
            lgaDiffEl.className = lgaDiff >= 0 ? 'text-success' : 'text-danger';
            
            // Region (State) Comparison
            const stateAvg = analysis.state_avg_growth || 10;
            document.getElementById('compareStateName').textContent = (analysis.region || 'Region') + ' Avg';
            document.getElementById('compareStateGrowth').textContent = '+' + stateAvg.toFixed(1) + '%';
            const stateDiff = yourGrowth - stateAvg;
            const stateDiffEl = document.getElementById('compareStateDiff');
            stateDiffEl.textContent = (stateDiff >= 0 ? '+' : '') + stateDiff.toFixed(1) + '% vs Region';
            stateDiffEl.className = stateDiff >= 0 ? 'text-success' : 'text-danger';
            
            // National Comparison
            const nationalAvg = analysis.national_avg_growth || 12.5;
            document.getElementById('compareNationalGrowth').textContent = '+' + nationalAvg.toFixed(1) + '%';
            const nationalDiff = yourGrowth - nationalAvg;
            const nationalDiffEl = document.getElementById('compareNationalDiff');
            nationalDiffEl.textContent = (nationalDiff >= 0 ? '+' : '') + nationalDiff.toFixed(1) + '% vs National';
            nationalDiffEl.className = nationalDiff >= 0 ? 'text-success' : 'text-danger';
            
            // Market Position Percentile
            const percentile = analysis.market_percentile || 50;
            document.getElementById('marketPercentile').textContent = 'Top ' + Math.round(100 - percentile) + '%';
            document.getElementById('marketPositionBar').style.width = percentile + '%';
            document.getElementById('marketPositionBar').className = 
                percentile >= 70 ? 'progress-bar bg-success' : 
                percentile >= 40 ? 'progress-bar bg-warning' : 'progress-bar bg-danger';
            
            // Price Projections
            document.getElementById('projection1Y').textContent = '₦' + formatNumber(analysis.projection_1y || 0);
            document.getElementById('projection1YPct').textContent = '(+' + (analysis.projection_1y_pct || 0).toFixed(1) + '%)';
            
            document.getElementById('projection3Y').textContent = '₦' + formatNumber(analysis.projection_3y || 0);
            document.getElementById('projection3YPct').textContent = '(+' + (analysis.projection_3y_pct || 0).toFixed(1) + '%)';
            
            document.getElementById('projection5Y').textContent = '₦' + formatNumber(analysis.projection_5y || 0);
            document.getElementById('projection5YPct').textContent = '(+' + (analysis.projection_5y_pct || 0).toFixed(1) + '%)';
            
            // Update projection mini chart
            updateProjectionChart(latestVal, analysis);
            
            // Market Intelligence
            const trendIcon = document.querySelector('.intelligence-icon');
            if (trendIcon) {
                const trend = analysis.trend || 'stable';
                if (trend === 'strong_upward' || trend === 'upward') {
                    trendIcon.className = 'intelligence-icon bg-success-subtle text-success rounded-circle p-2 me-3';
                    trendIcon.innerHTML = '<i class="bi bi-arrow-up-right"></i>';
                } else if (trend === 'stable' || trend === 'flat') {
                    trendIcon.className = 'intelligence-icon bg-warning-subtle text-warning rounded-circle p-2 me-3';
                    trendIcon.innerHTML = '<i class="bi bi-arrow-right"></i>';
                } else {
                    trendIcon.className = 'intelligence-icon bg-danger-subtle text-danger rounded-circle p-2 me-3';
                    trendIcon.innerHTML = '<i class="bi bi-arrow-down-right"></i>';
                }
            }
            
            document.getElementById('marketTrendTitle').textContent = analysis.trend_title || 'Stable Growth';
            document.getElementById('marketTrendDesc').textContent = analysis.trend_desc || 'Monitoring market conditions.';
            
            // Investment Rating Stars
            const rating = analysis.rating || 3;
            const ratingHtml = Array(5).fill(0).map((_, i) => 
                i < rating ? '<i class="bi bi-star-fill text-warning"></i>' : '<i class="bi bi-star text-muted"></i>'
            ).join('');
            document.getElementById('investmentRating').innerHTML = ratingHtml;
            
            const ratingLabels = ['Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
            document.getElementById('ratingLabel').textContent = ratingLabels[rating - 1] || 'Good';
            
            // Key Insights
            const insightsList = document.getElementById('keyInsightsList');
            if (insightsList && analysis.insights) {
                insightsList.innerHTML = analysis.insights.map(insight => `
                    <li class="mb-1">
                        <i class="bi bi-${insight.type === 'success' ? 'check-circle text-success' : 'exclamation-circle text-warning'} me-1"></i>
                        <small>${insight.text}</small>
                    </li>
                `).join('');
            }
            
            // Recommendation
            document.getElementById('analysisRecommendation').textContent = analysis.recommendation || 
                'Continue monitoring market trends for optimal investment decisions.';
            
            // Market Badge
            const marketBadge = document.getElementById('marketBadge');
            if (marketBadge) {
                const badge = analysis.market_badge || 'Tracking Market';
                marketBadge.textContent = badge;
                if (badge.includes('Outperforming')) {
                    marketBadge.className = 'badge rounded-pill bg-success-subtle text-success';
                    marketBadge.innerHTML = '<i class="bi bi-trophy me-1"></i>' + badge;
                } else if (badge.includes('Tracking')) {
                    marketBadge.className = 'badge rounded-pill bg-info-subtle text-info';
                    marketBadge.innerHTML = '<i class="bi bi-graph-up me-1"></i>' + badge;
                } else {
                    marketBadge.className = 'badge rounded-pill bg-warning-subtle text-warning';
                    marketBadge.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>' + badge;
                }
            }
            
            // Update comparative growth chart
            updateComparativeChart(yourGrowth, lgaAvg, stateAvg, nationalAvg);
        }
        
        // Projection Mini Chart
        let projectionMiniChart = null;
        function updateProjectionChart(currentPrice, analysis) {
            const ctx = document.getElementById('projectionMiniChart');
            if (!ctx) return;
            
            if (projectionMiniChart) {
                projectionMiniChart.destroy();
            }
            
            projectionMiniChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Now', '1Y', '3Y', '5Y'],
                    datasets: [{
                        data: [
                            currentPrice,
                            analysis.projection_1y || currentPrice,
                            analysis.projection_3y || currentPrice,
                            analysis.projection_5y || currentPrice
                        ],
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#ffc107',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: true, grid: { display: false } },
                        y: { display: false }
                    }
                }
            });
        }
        
        // Comparative Growth Chart
        let comparativeGrowthChart = null;
        function updateComparativeChart(yourGrowth, lgaAvg, stateAvg, nationalAvg) {
            const ctx = document.getElementById('comparativeGrowthChart');
            if (!ctx) return;
            
            if (comparativeGrowthChart) {
                comparativeGrowthChart.destroy();
            }
            
            comparativeGrowthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['This Property', 'LGA Average', 'State Average', 'National Average'],
                    datasets: [{
                        label: 'Growth %',
                        data: [yourGrowth, lgaAvg, stateAvg, nationalAvg],
                        backgroundColor: [
                            'rgba(13, 110, 253, 0.8)',
                            'rgba(108, 117, 125, 0.6)',
                            'rgba(108, 117, 125, 0.6)',
                            'rgba(108, 117, 125, 0.6)'
                        ],
                        borderColor: [
                            'rgb(13, 110, 253)',
                            'rgb(108, 117, 125)',
                            'rgb(108, 117, 125)',
                            'rgb(108, 117, 125)'
                        ],
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false } },
                        y: { 
                            beginAtZero: true,
                            ticks: { callback: v => v + '%' }
                        }
                    }
                }
            });
        }

        function savePresalePrice() {
            // Clear previous errors
            clearPresaleErrors();
            
            const estateSelect = document.getElementById('prmEstateSelect');
            const effectiveInput = document.getElementById('prmEffectiveDate');
            
            const estateId = estateSelect.value;
            const effective = effectiveInput.value;
            const notes = document.getElementById('prmNotes').value;
            const notify = document.getElementById('prmNotifyChk').checked;
            
            // Inline validation
            let hasError = false;
            
            if (!estateId) {
                showFieldError(estateSelect, 'prmEstateError', 'Please select an estate');
                hasError = true;
            }
            
            if (!effective) {
                showFieldError(effectiveInput, 'prmDateError', 'Please select an effective date');
                hasError = true;
            }
            
            // Collect selected plots with presale prices
            const presaleData = [];
            const checkboxes = document.querySelectorAll('.presale-plot-checkbox:checked');
            
            checkboxes.forEach(cb => {
                const unitId = cb.getAttribute('data-unit-id');
                const row = cb.closest('tr');
                const input = row.querySelector('.presale-price-input');
                const rawValue = input.getAttribute('data-raw-value') || input.value.replace(/[^0-9]/g, '');
                const presale = parseFloat(rawValue) || 0;
                
                if (presale > 0) {
                    presaleData.push({
                        plot_unit_id: unitId,
                        presale: presale
                    });
                }
            });
            
            if (presaleData.length === 0) {
                showErrorBanner('Please enter at least one presale price');
                hasError = true;
            }
            
            if (hasError) {
                return;
            }

            // Disable save button while saving
            const saveBtn = document.getElementById('prmSaveRegBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
            saveBtn.disabled = true;

            const body = {
                estate_id: estateId,
                effective: effective,
                notes: notes,
                notify: notify,
                presales: presaleData
            };

            fetch('/api/property-price/bulk-presale/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(body)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    prmValueModal.hide();
                    
                    // Reload the page to show updated prices
                    location.reload();
                    
                    // Show success message
                    document.getElementById('successModalMessage').textContent = 
                        `Successfully saved ${data.saved_count || presaleData.length} presale price(s)!`;
                    successModal.show();
                } else {
                    showErrorBanner('Failed to save: ' + (data.message || 'Unknown error'));
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showErrorBanner('Error saving presale prices. Please try again.');
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
        }
        
        // Helper functions for inline error handling
        function showFieldError(element, errorDivId, message) {
            element.classList.add('field-error');
            const errorDiv = document.getElementById(errorDivId);
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }
        
        function clearFieldError(element, errorDivId) {
            element.classList.remove('field-error');
            const errorDiv = document.getElementById(errorDivId);
            if (errorDiv) {
                errorDiv.textContent = '';
                errorDiv.style.display = 'none';
            }
        }
        
        function showErrorBanner(message) {
            const banner = document.getElementById('prmErrorBanner');
            const messageSpan = document.getElementById('prmErrorMessage');
            if (banner && messageSpan) {
                messageSpan.textContent = message;
                banner.style.display = 'flex';
                // Scroll to top of modal body
                const modalBody = banner.closest('.modal-body');
                if (modalBody) modalBody.scrollTop = 0;
            }
        }
        
        function hideErrorBanner() {
            const banner = document.getElementById('prmErrorBanner');
            if (banner) {
                banner.style.display = 'none';
            }
        }
        
        function clearPresaleErrors() {
            hideErrorBanner();
            const estateSelect = document.getElementById('prmEstateSelect');
            const effectiveInput = document.getElementById('prmEffectiveDate');
            
            if (estateSelect) clearFieldError(estateSelect, 'prmEstateError');
            if (effectiveInput) clearFieldError(effectiveInput, 'prmDateError');
        }

        function saveEditPrice() {
            // Clear previous errors
            clearEditErrors();
            
            const id = document.getElementById('prmEditPropertyId').value;
            const currentInput = document.getElementById('prmEditCurrentPrice');
            const effectiveInput = document.getElementById('prmEditEffectiveDate');
            const current = currentInput.value;
            const effective = effectiveInput.value;
            const notes = document.getElementById('prmEditNotes').value;
            const notify = document.getElementById('prmEditNotifyChk').checked;
            
            // Inline validation
            let hasError = false;
            
            if (!current) {
                showFieldError(currentInput, 'prmEditCurrentError', 'Please enter a current price');
                hasError = true;
            }
            
            if (!effective) {
                showFieldError(effectiveInput, 'prmEditDateError', 'Please select an effective date');
                hasError = true;
            }
            
            if (hasError) {
                showEditErrorBanner('Please fill all required fields');
                return;
            }

            const body = {
                current: current,
                effective: effective,
                notes: notes,
                notify: notify
            };

            fetch(`/api/property-price/${id}/edit/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(body)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    const rowKey = data.row_key;
                    refreshRow(rowKey);
                    prmEditModal.hide();
                    
                    // Show success message with notification status
                    let message = 'Property price updated successfully!';
                    if (data.notification_sent) {
                        message += '\n✅ Notifications sent to clients and marketers.';
                    }
                    
                    document.getElementById('successModalMessage').textContent = message;
                    successModal.show();
                } else {
                    showEditErrorBanner('Failed to update: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showEditErrorBanner('Error updating property price. Please try again.');
            });
        }
        
        function showEditErrorBanner(message) {
            const banner = document.getElementById('prmEditErrorBanner');
            const messageSpan = document.getElementById('prmEditErrorMessage');
            if (banner && messageSpan) {
                messageSpan.textContent = message;
                banner.style.display = 'flex';
                const modalBody = banner.closest('.modal-body');
                if (modalBody) modalBody.scrollTop = 0;
            }
        }
        
        function hideEditErrorBanner() {
            const banner = document.getElementById('prmEditErrorBanner');
            if (banner) {
                banner.style.display = 'none';
            }
        }
        
        function clearEditErrors() {
            hideEditErrorBanner();
            const currentInput = document.getElementById('prmEditCurrentPrice');
            const effectiveInput = document.getElementById('prmEditEffectiveDate');
            
            if (currentInput) clearFieldError(currentInput, 'prmEditCurrentError');
            if (effectiveInput) clearFieldError(effectiveInput, 'prmEditDateError');
        }

     
        // ============================================
        // PROMO MODAL FUNCTIONS
        // ============================================
        
        function showPromoErrorBanner(message) {
            const banner = document.getElementById('promoErrorBanner');
            const messageSpan = document.getElementById('promoErrorMessage');
            if (banner && messageSpan) {
                messageSpan.textContent = message;
                banner.style.display = 'flex';
                const modalBody = banner.closest('.modal-body');
                if (modalBody) modalBody.scrollTop = 0;
            }
        }
        
        function hidePromoErrorBanner() {
            const banner = document.getElementById('promoErrorBanner');
            if (banner) {
                banner.style.display = 'none';
            }
        }
        
        function showPromoFieldError(element, errorDivId, message) {
            element.classList.add('field-error');
            const errorDiv = document.getElementById(errorDivId);
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }
        
        function clearPromoFieldError(element, errorDivId) {
            element.classList.remove('field-error');
            const errorDiv = document.getElementById(errorDivId);
            if (errorDiv) {
                errorDiv.textContent = '';
                errorDiv.style.display = 'none';
            }
        }
        
        function clearAllPromoErrors() {
            hidePromoErrorBanner();
            clearPromoFieldError(promoNameInput, 'promoNameError');
            clearPromoFieldError(promoDiscount, 'promoDiscountError');
            clearPromoFieldError(promoStart, 'promoStartError');
            clearPromoFieldError(promoEnd, 'promoEndError');
            clearPromoFieldError(promoEstates, 'promoEstatesError');
        }
        
        function resetPromoModal() {
            promoIdInput.value = '';
            promoNameInput.value = '';
            promoDiscount.value = '';
            promoStart.value = new Date().toISOString().slice(0, 10);
            promoEnd.value = new Date().toISOString().slice(0, 10);
            promoDesc.value = '';
            Array.from(promoEstates.options).forEach(opt => opt.selected = false);
            
            document.getElementById('promoModalTitleText').textContent = 'Create Promotional Offer';
            document.getElementById('promoSaveBtnText').textContent = 'Create Promo';
            
            // Hide discount preview
            document.getElementById('discountPreview').style.display = 'none';
            
            clearAllPromoErrors();
        }
        
        // Discount preview handler
        promoDiscount.addEventListener('input', function() {
            const value = parseInt(this.value) || 0;
            const preview = document.getElementById('discountPreview');
            const previewValue = document.getElementById('discountPreviewValue');
            
            if (value > 0 && value <= 100) {
                previewValue.textContent = value;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
            
            clearPromoFieldError(this, 'promoDiscountError');
            hidePromoErrorBanner();
        });
        
        // Clear errors on input
        promoNameInput.addEventListener('input', function() {
            clearPromoFieldError(this, 'promoNameError');
            hidePromoErrorBanner();
        });
        
        promoStart.addEventListener('change', function() {
            clearPromoFieldError(this, 'promoStartError');
            hidePromoErrorBanner();
        });
        
        promoEnd.addEventListener('change', function() {
            clearPromoFieldError(this, 'promoEndError');
            hidePromoErrorBanner();
        });
        
        promoEstates.addEventListener('change', function() {
            clearPromoFieldError(this, 'promoEstatesError');
            hidePromoErrorBanner();
        });
        
        function savePromo() {
            // Clear previous errors
            clearAllPromoErrors();
            
            // Get form values
            const name = promoNameInput.value.trim();
            const discount = Number(promoDiscount.value);
            const start = promoStart.value;
            const end = promoEnd.value;
            const selectedEstates = Array.from(promoEstates.selectedOptions)
                .map(o => Number(o.value));

            // Inline validation
            let hasError = false;
            
            if (!name) {
                showPromoFieldError(promoNameInput, 'promoNameError', 'Please enter a promo name');
                hasError = true;
            }
            
            if (!discount || discount < 1 || discount > 100) {
                showPromoFieldError(promoDiscount, 'promoDiscountError', 'Enter a valid discount (1-100%)');
                hasError = true;
            }
            
            if (!start) {
                showPromoFieldError(promoStart, 'promoStartError', 'Please select a start date');
                hasError = true;
            }
            
            if (!end) {
                showPromoFieldError(promoEnd, 'promoEndError', 'Please select an end date');
                hasError = true;
            }
            
            if (start && end && new Date(start) > new Date(end)) {
                showPromoFieldError(promoEnd, 'promoEndError', 'End date must be after start date');
                hasError = true;
            }
            
            if (!selectedEstates.length) {
                showPromoFieldError(promoEstates, 'promoEstatesError', 'Select at least one estate');
                hasError = true;
            }
            
            if (hasError) {
                showPromoErrorBanner('Please correct the errors below');
                return;
            }

            // Build request body
            const body = {
                name: name,
                discount: discount,
                start: start,
                end: end,
                estates: selectedEstates,
                description: promoDesc.value.trim(),
            };

            const method = promoIdInput.value ? 'PUT' : 'POST';
            const url = promoIdInput.value
                ? `/api/promo/${promoIdInput.value}/update/`
                : '/api/promo/create/';

            // Disable button during request
            const saveBtn = document.getElementById('prmSavePromoBtn');
            const saveBtnText = document.getElementById('promoSaveBtnText');
            const originalText = saveBtnText.textContent;
            saveBtn.disabled = true;
            saveBtnText.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(body)
            })
            .then(async r => {
                const data = await r.json();
                if (!r.ok) {
                    throw new Error(data.message || `Server error: ${r.status}`);
                }
                return data;
            })
            .then(data => {
                promoModal.hide();
                
                // Show success message
                document.getElementById('successModalMessage').textContent = 
                    promoIdInput.value ? 'Promo updated successfully!' : 'Promo created successfully!';
                successModal.show();
                
                // Reload page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .catch(e => {
                console.error('❌ Promo error:', e);
                showPromoErrorBanner('Error saving promo: ' + e.message);
            })
            .finally(() => {
                saveBtn.disabled = false;
                saveBtnText.textContent = originalText;
            });
        }

        if (promoModal) {
            addListener('prmSavePromoBtn', 'click', savePromo);
        }

        function refreshRow(rowKey) {
            fetch(`/api/property-row/${rowKey}/`, {
                headers: {'X-CSRFToken': csrftoken}
            })
            .then(r => r.json())
            .then(data => {
                const newRow = document.createElement('tr');
                newRow.innerHTML = data.html;
                newRow.id = `row-${rowKey}`;
                
                const existingRow = document.getElementById(`row-${rowKey}`);
                if (existingRow) {
                    existingRow.replaceWith(newRow);
                } else {
                    document.getElementById('prmPropertyTable').appendChild(newRow);
                }

                // Re-apply pagination/search after DOM changes
                applyPrmPropertyPagination();
            });
        }

        function initPriceChart() {
            const ctx = document.getElementById('priceHistoryChart').getContext('2d');
            
            // Create stunning multi-layer gradients for ultra-modern wave effect
            const primaryGradient = ctx.createLinearGradient(0, 0, 0, 350);
            primaryGradient.addColorStop(0, 'rgba(99, 102, 241, 0.8)');
            primaryGradient.addColorStop(0.2, 'rgba(139, 92, 246, 0.6)');
            primaryGradient.addColorStop(0.4, 'rgba(168, 85, 247, 0.4)');
            primaryGradient.addColorStop(0.6, 'rgba(217, 70, 239, 0.2)');
            primaryGradient.addColorStop(0.8, 'rgba(236, 72, 153, 0.1)');
            primaryGradient.addColorStop(1, 'rgba(251, 146, 60, 0.02)');
            
            // Glowing line gradient (horizontal)
            const lineGradient = ctx.createLinearGradient(0, 0, ctx.canvas.width, 0);
            lineGradient.addColorStop(0, '#6366f1');
            lineGradient.addColorStop(0.25, '#8b5cf6');
            lineGradient.addColorStop(0.5, '#a855f7');
            lineGradient.addColorStop(0.75, '#d946ef');
            lineGradient.addColorStop(1, '#ec4899');
            
            // Store chart type state
            window.currentChartType = 'wave';
            
            window.historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Property Value',
                        data: [],
                        borderColor: lineGradient,
                        backgroundColor: primaryGradient,
                        borderWidth: 4,
                        pointRadius: 0,
                        pointHoverRadius: 12,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#8b5cf6',
                        pointBorderWidth: 4,
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#8b5cf6',
                        pointHoverBorderWidth: 5,
                        tension: 0.5,  // Ultra-smooth wave curve
                        fill: true,
                        cubicInterpolationMode: 'monotone',
                        // Add shadow effect
                        shadowOffsetX: 0,
                        shadowOffsetY: 10,
                        shadowBlur: 30,
                        shadowColor: 'rgba(139, 92, 246, 0.4)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'end',
                            labels: {
                                boxWidth: 16,
                                boxHeight: 16,
                                padding: 25,
                                font: {
                                    size: 14,
                                    weight: '700',
                                    family: "'Inter', 'Segoe UI', sans-serif"
                                },
                                color: '#374151',
                                usePointStyle: true,
                                pointStyle: 'circle',
                                generateLabels: function(chart) {
                                    return [{
                                        text: '💎 Property Value Trend',
                                        fillStyle: 'linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%)',
                                        strokeStyle: '#8b5cf6',
                                        lineWidth: 3,
                                        hidden: false,
                                        index: 0
                                    }];
                                }
                            }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(255, 255, 255, 0.98)',
                            titleColor: '#1e293b',
                            bodyColor: '#475569',
                            borderColor: 'rgba(99, 102, 241, 0.4)',
                            borderWidth: 2,
                            padding: 18,
                            cornerRadius: 16,
                            displayColors: false,
                            boxPadding: 8,
                            boxShadow: '0 10px 40px rgba(0, 0, 0, 0.15)',
                            titleFont: {
                                size: 15,
                                weight: '700',
                                family: "'Inter', sans-serif"
                            },
                            bodyFont: {
                                size: 14,
                                weight: '500',
                                family: "'Inter', sans-serif"
                            },
                            caretSize: 8,
                            caretPadding: 10,
                            callbacks: {
                                title: function(context) {
                                    return '📅 ' + context[0].label;
                                },
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const formattedValue = '₦' + value.toLocaleString('en-US', {
                                        minimumFractionDigits: 0,
                                        maximumFractionDigits: 0
                                    });
                                    return '💰 Value: ' + formattedValue;
                                },
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    if (index > 0) {
                                        const current = context.parsed.y;
                                        const previous = context.chart.data.datasets[0].data[index - 1];
                                        const change = ((current - previous) / previous * 100).toFixed(1);
                                        const emoji = change >= 0 ? '📈' : '📉';
                                        const sign = change >= 0 ? '+' : '';
                                        return `${emoji} ${sign}${change}% change`;
                                    }
                                    return '🚀 Initial price point';
                                },
                                footer: function(context) {
                                    const index = context[0].dataIndex;
                                    const data = context[0].chart.data.datasets[0].data;
                                    if (data.length > 1 && index > 0) {
                                        const total = ((data[index] - data[0]) / data[0] * 100).toFixed(1);
                                        return '━━━━━━━━━━━━━━━\n📊 Total Growth: ' + (total >= 0 ? '+' : '') + total + '%';
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grace: '15%',
                            grid: {
                                color: 'rgba(139, 92, 246, 0.06)',
                                drawBorder: false,
                                lineWidth: 1,
                                tickLength: 0
                            },
                            border: {
                                display: false
                            },
                            ticks: {
                                padding: 15,
                                font: {
                                    size: 11,
                                    weight: '600',
                                    family: "'Inter', 'Segoe UI', sans-serif"
                                },
                                color: '#64748b',
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return '₦' + (value / 1000000).toFixed(1) + 'M';
                                    } else if (value >= 1000) {
                                        return '₦' + (value / 1000).toFixed(0) + 'K';
                                    }
                                    return '₦' + value.toLocaleString();
                                }
                            },
                            title: {
                                display: false
                            }
                        },
                        x: {
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            border: {
                                display: false
                            },
                            ticks: {
                                padding: 10,
                                font: {
                                    size: 11,
                                    weight: '500',
                                    family: "'Inter', 'Segoe UI', sans-serif"
                                },
                                color: '#94a3b8',
                                maxRotation: 0,
                                minRotation: 0,
                                maxTicksLimit: 8
                            },
                            title: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart',
                        delay: function(context) {
                            let delay = 0;
                            if (context.type === 'data' && context.mode === 'default') {
                                delay = context.dataIndex * 100 + context.datasetIndex * 100;
                            }
                            return delay;
                        }
                    },
                    elements: {
                        line: {
                            capBezierPoints: true
                        },
                        point: {
                            hoverRadius: 12,
                            hoverBorderWidth: 4
                        }
                    },
                    hover: {
                        mode: 'nearest',
                        intersect: false,
                        animationDuration: 200
                    }
                }
            });
            
            // Setup chart type toggle buttons
        }
        
        // Update chart stats (called when data is loaded)
        function updateChartStats(values) {
            if (!values || values.length === 0) return;
            
            const highest = Math.max(...values);
            const lowest = Math.min(...values);
            const average = values.reduce((a, b) => a + b, 0) / values.length;
            const totalGrowth = values.length > 1 ? 
                ((values[values.length - 1] - values[0]) / values[0] * 100) : 0;
            
            document.getElementById('chartHighest').textContent = '₦' + formatNumber(highest);
            document.getElementById('chartLowest').textContent = '₦' + formatNumber(lowest);
            document.getElementById('chartAverage').textContent = '₦' + formatNumber(average);
            
            // Growth badge
            const growthBadge = document.getElementById('chartGrowthBadge');
            if (growthBadge) {
                growthBadge.textContent = (totalGrowth >= 0 ? '+' : '') + totalGrowth.toFixed(2) + '%';
                growthBadge.className = totalGrowth >= 0 ? 'badge bg-success fs-6' : 'badge bg-danger fs-6';
            }
            
            // Trend indicator
            const trendIndicator = document.getElementById('chartTrendIndicator');
            const trendText = document.getElementById('chartTrendText');
            const trendDesc = document.getElementById('chartTrendDesc');
            
            if (totalGrowth > 10) {
                trendIndicator.innerHTML = '<i class="bi bi-arrow-up-circle-fill text-success fs-4"></i>';
                trendText.textContent = 'Strong Upward Trend';
                trendDesc.textContent = 'Excellent price appreciation over time';
            } else if (totalGrowth > 0) {
                trendIndicator.innerHTML = '<i class="bi bi-arrow-up-right-circle-fill text-success fs-4"></i>';
                trendText.textContent = 'Upward Trend';
                trendDesc.textContent = 'Consistent positive price movement';
            } else if (totalGrowth > -5) {
                trendIndicator.innerHTML = '<i class="bi bi-arrow-right-circle-fill text-warning fs-4"></i>';
                trendText.textContent = 'Stable';
                trendDesc.textContent = 'Price holding steady with minimal change';
            } else {
                trendIndicator.innerHTML = '<i class="bi bi-arrow-down-circle-fill text-danger fs-4"></i>';
                trendText.textContent = 'Downward Trend';
                trendDesc.textContent = 'Price decline - review market conditions';
            }
        }
        
        // Error Modal Helper Function
        function showHistoryErrorModal(message, title = 'Error Loading Data') {
            const errorModal = document.getElementById('prmErrorModal');
            if (!errorModal) {
                console.error('Error modal not found:', message);
                return;
            }
            
            document.getElementById('errorModalTitle').textContent = title;
            document.getElementById('errorModalMessage').textContent = message;
            
            const modal = new bootstrap.Modal(errorModal);
            modal.show();
        }

        // ============================================================
        // PRICE UPDATE FUNCTIONS
        // ============================================================
        
        function openBulkUpdateModal() {
            // Reset form and clear errors
            clearBulkErrors();
            document.getElementById('prmBulkEstateSelect').value = '';
            document.getElementById('prmBulkEffectiveDate').value = new Date().toISOString().slice(0, 10);
            document.getElementById('prmBulkNotes').value = '';
            document.getElementById('prmBulkNotifyChk').checked = true;
            document.getElementById('bulkEstateInfo').classList.add('d-none');
            document.getElementById('bulkPriceContainer').classList.add('d-none');
            document.getElementById('prmSaveBulkBtn').disabled = true;
            
            prmBulkUpdateModal.show();
        }
        
        // Bulk error handling functions
        function showBulkErrorBanner(message) {
            const banner = document.getElementById('bulkErrorBanner');
            const messageSpan = document.getElementById('bulkErrorMessage');
            if (banner && messageSpan) {
                messageSpan.textContent = message;
                banner.style.display = 'flex';
                const modalBody = banner.closest('.modal-body');
                if (modalBody) modalBody.scrollTop = 0;
            }
        }
        
        function hideBulkErrorBanner() {
            const banner = document.getElementById('bulkErrorBanner');
            if (banner) {
                banner.style.display = 'none';
            }
        }
        
        function showBulkFieldError(element, errorDivId, message) {
            element.classList.add('field-error');
            const errorDiv = document.getElementById(errorDivId);
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }
        
        function clearBulkFieldError(element, errorDivId) {
            element.classList.remove('field-error');
            const errorDiv = document.getElementById(errorDivId);
            if (errorDiv) {
                errorDiv.textContent = '';
                errorDiv.style.display = 'none';
            }
        }
        
        function clearBulkErrors() {
            hideBulkErrorBanner();
            const estateSelect = document.getElementById('prmBulkEstateSelect');
            const dateInput = document.getElementById('prmBulkEffectiveDate');
            if (estateSelect) clearBulkFieldError(estateSelect, 'bulkEstateError');
            if (dateInput) clearBulkFieldError(dateInput, 'bulkDateError');
        }

        // Estate selection handler
        const bulkEstateSelect = addListener('prmBulkEstateSelect', 'change', function() {
            const estateId = this.value;
            
            // Clear error when user selects
            clearBulkFieldError(this, 'bulkEstateError');
            hideBulkErrorBanner();
            
            if (!estateId) {
                document.getElementById('bulkEstateInfo').classList.add('d-none');
                document.getElementById('bulkPriceContainer').classList.add('d-none');
                return;
            }

            // Show loading state
            const tbody = document.getElementById('bulkPlotTableBody');
            tbody.innerHTML = `
                <tr class="loading-row">
                    <td colspan="8">
                        <div class="loading-spinner">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            <span>Loading plot sizes...</span>
                        </div>
                    </td>
                </tr>`;
            document.getElementById('bulkPriceContainer').classList.remove('d-none');

            // Fetch estate data with all plot sizes and current prices
            fetch(`/api/estate/${estateId}/bulk-price-data/`, {
                headers: { 'X-CSRFToken': csrftoken }
            })
            .then(r => r.json())
            .then(data => {
                // Display estate info with updated element IDs
                document.getElementById('bulkEstateNameDisplay').textContent = data.estate.name;
                const locationTextEl = document.getElementById('bulkEstateLocationText');
                if (locationTextEl) {
                    locationTextEl.textContent = data.estate.location;
                }
                document.getElementById('bulkTotalPlots').textContent = data.plot_units.length;
                document.getElementById('bulkEstateInfo').classList.remove('d-none');

                // Populate table with plot sizes
                tbody.innerHTML = '';
                
                if (data.plot_units.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <i class="bi bi-info-circle text-muted me-2"></i>
                                No plot sizes found for this estate. Add plot sizes first.
                            </td>
                        </tr>`;
                    return;
                }
                
                data.plot_units.forEach((unit, index) => {
                    const presale = unit.presale || 0;
                    const previous = unit.previous || 0;
                    const current = unit.current || previous;
                    const isAvailable = unit.available > 0;
                    const hasPresale = presale > 0;
                    const isSoldOut = unit.available === 0;
                    
                    // Determine if price input should be disabled
                    const isPriceDisabled = !hasPresale || isSoldOut;
                    
                    // Create warning message
                    let warningHtml = '';
                    if (!hasPresale) {
                        warningHtml = '<div class="warning-text"><i class="bi bi-exclamation-triangle-fill"></i> Set presale first</div>';
                    } else if (isSoldOut) {
                        warningHtml = '<div class="warning-text"><i class="bi bi-lock-fill"></i> Sold out</div>';
                    }
                    
                    const row = `
                        <tr data-unit-id="${unit.id}" data-presale="${presale}" data-previous="${previous}">
                            <td>
                                <input type="checkbox" class="form-check-input bulk-plot-checkbox" 
                                       data-unit-id="${unit.id}" ${isAvailable && hasPresale ? 'checked' : ''} 
                                       ${isPriceDisabled ? 'disabled' : ''}>
                            </td>
                            <td>
                                <strong>${unit.size}</strong>
                                <div class="text-muted" style="font-size: 0.8rem;">${unit.available} of ${unit.total} available</div>
                                ${warningHtml}
                            </td>
                            <td>
                                <span class="status-badge ${isAvailable ? 'available' : 'sold-out'}">
                                    ${isAvailable ? 'Available' : 'Sold Out'}
                                </span>
                            </td>
                            <td>
                                <span class="fw-semibold ${presale > 0 ? 'text-success' : 'text-muted'}">
                                    ${presale > 0 ? '₦' + formatNumber(presale) : '—'}
                                </span>
                            </td>
                            <td>
                                <span class="fw-semibold ${previous > 0 ? '' : 'text-muted'}">
                                    ${previous > 0 ? '₦' + formatNumber(previous) : '—'}
                                </span>
                            </td>
                            <td>
                                <input type="text" class="bulk-new-price" 
                                       data-unit-id="${unit.id}" data-raw-value="${current}" 
                                       value="${current > 0 ? formatNumber(current) : ''}" 
                                       placeholder="Enter price" ${isPriceDisabled ? 'disabled' : ''}>
                            </td>
                            <td>
                                <span class="change-percent-${unit.id}">0%</span>
                            </td>
                            <td>
                                <span class="total-percent-${unit.id}">0%</span>
                            </td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });

                // Initialize calculations
                calculateAllChanges();
                updateBulkSummary();

                // Add event listeners to new price inputs with formatting
                document.querySelectorAll('.bulk-new-price').forEach(input => {
                    // Format price on input
                    input.addEventListener('input', function(e) {
                        // Get cursor position
                        const cursorPos = this.selectionStart;
                        const oldLength = this.value.length;
                        
                        // Remove non-numeric characters except for positioning
                        let rawValue = this.value.replace(/[^0-9]/g, '');
                        
                        // Store raw value
                        this.setAttribute('data-raw-value', rawValue);
                        
                        // Format with commas
                        if (rawValue) {
                            this.value = formatNumber(parseInt(rawValue, 10));
                        }
                        
                        // Adjust cursor position
                        const newLength = this.value.length;
                        const diff = newLength - oldLength;
                        this.setSelectionRange(cursorPos + diff, cursorPos + diff);
                        
                        // Calculate changes
                        const unitId = this.getAttribute('data-unit-id');
                        calculateRowChange(unitId);
                        updateBulkSummary();
                    });
                    
                    // Also handle change and blur events
                    input.addEventListener('change', function() {
                        const unitId = this.getAttribute('data-unit-id');
                        calculateRowChange(unitId);
                        updateBulkSummary();
                    });
                    
                    input.addEventListener('blur', function() {
                        // Ensure proper formatting on blur
                        const rawValue = this.getAttribute('data-raw-value') || this.value.replace(/[^0-9]/g, '');
                        if (rawValue) {
                            this.value = formatNumber(parseInt(rawValue, 10));
                        }
                    });
                });

                // Add event listeners to checkboxes
                document.querySelectorAll('.bulk-plot-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        updateBulkSummary();
                        updateSelectAllState();
                    });
                });

                // Select All checkbox handler (reset listener each time to avoid duplicates)
                const bulkSelectAll = getEl('bulkSelectAll');
                if (bulkSelectAll) {
                    const freshSelectAll = bulkSelectAll.cloneNode(true);
                    bulkSelectAll.parentNode.replaceChild(freshSelectAll, bulkSelectAll);
                    freshSelectAll.addEventListener('change', function() {
                        const checkboxes = document.querySelectorAll('.bulk-plot-checkbox');
                        checkboxes.forEach(cb => cb.checked = this.checked);
                        updateBulkSummary();
                    });
                }
            })
            .catch(error => {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading data. Please try again.</td></tr>';
            });
        });

        function calculateRowChange(unitId) {
            const row = document.querySelector(`tr[data-unit-id="${unitId}"]`);
            if (!row) {
                return;
            }
            
            const presale = parseFloat(row.getAttribute('data-presale')) || 0;
            const previous = parseFloat(row.getAttribute('data-previous')) || 0;
            const newPriceInput = document.querySelector(`.bulk-new-price[data-unit-id="${unitId}"]`);
            
            // Get raw value (remove commas for calculation)
            const rawValue = newPriceInput.getAttribute('data-raw-value') || newPriceInput.value.replace(/[^0-9]/g, '');
            const newPrice = parseFloat(rawValue) || 0;

            // Calculate % change from previous
            let changePercent = 0;
            if (previous > 0) {
                changePercent = ((newPrice - previous) / previous * 100);
            }
            
            const changeSpan = document.querySelector(`.change-percent-${unitId}`);
            if (changeSpan) {
                changeSpan.textContent = (changePercent > 0 ? '+' : '') + changePercent.toFixed(1) + '%';
                // Remove existing color classes
                changeSpan.classList.remove('increase-prm', 'decrease-prm');
                // Add appropriate color class
                if (changePercent > 0) {
                    changeSpan.classList.add('increase-prm');
                } else if (changePercent < 0) {
                    changeSpan.classList.add('decrease-prm');
                }
            }

            // Calculate total % change from presale
            let totalPercent = 0;
            if (presale > 0) {
                totalPercent = ((newPrice - presale) / presale * 100);
            }
            
            const totalSpan = document.querySelector(`.total-percent-${unitId}`);
            if (totalSpan) {
                totalSpan.textContent = (totalPercent > 0 ? '+' : '') + totalPercent.toFixed(1) + '%';
                // Remove existing color classes
                totalSpan.classList.remove('increase-prm', 'decrease-prm');
                // Add appropriate color class
                if (totalPercent > 0) {
                    totalSpan.classList.add('increase-prm');
                } else if (totalPercent < 0) {
                    totalSpan.classList.add('decrease-prm');
                }
            }

            // Add visual feedback to the input
            if (newPrice !== previous) {
                newPriceInput.style.borderColor = changePercent > 0 ? '#28a745' : '#dc3545';
                newPriceInput.style.borderWidth = '2px';
            } else {
                newPriceInput.style.borderColor = '';
                newPriceInput.style.borderWidth = '';
            }
        }

        function calculateAllChanges() {
            document.querySelectorAll('.bulk-new-price').forEach(input => {
                const unitId = input.getAttribute('data-unit-id');
                calculateRowChange(unitId);
            });
        }

        function updateBulkSummary() {
            const selectedCheckboxes = document.querySelectorAll('.bulk-plot-checkbox:checked');
            const selectedCount = selectedCheckboxes.length;
            
            let totalChange = 0;
            let totalIncrease = 0;
            let totalDecrease = 0;
            let validChanges = 0;

            selectedCheckboxes.forEach(checkbox => {
                const unitId = checkbox.getAttribute('data-unit-id');
                const row = document.querySelector(`tr[data-unit-id="${unitId}"]`);
                const previous = parseFloat(row.getAttribute('data-previous')) || 0;
                
                // Get raw value (remove commas for calculation)
                const priceInput = document.querySelector(`.bulk-new-price[data-unit-id="${unitId}"]`);
                const rawValue = priceInput.getAttribute('data-raw-value') || priceInput.value.replace(/[^0-9]/g, '');
                const newPrice = parseFloat(rawValue) || 0;

                if (previous > 0) {
                    const change = ((newPrice - previous) / previous * 100);
                    totalChange += change;
                    validChanges++;

                    const diff = newPrice - previous;
                    if (diff > 0) {
                        totalIncrease += diff;
                    } else if (diff < 0) {
                        totalDecrease += Math.abs(diff);
                    }
                }
            });

            // Update summary display
            document.getElementById('bulkSelectedCount').textContent = selectedCount;
            
            const avgChange = validChanges > 0 ? (totalChange / validChanges) : 0;
            const avgSpan = document.getElementById('bulkAvgChange');
            avgSpan.textContent = (avgChange > 0 ? '+' : '') + avgChange.toFixed(1) + '%';
            avgSpan.className = 'value ' + (avgChange > 0 ? 'text-success' : avgChange < 0 ? 'text-danger' : '');

            document.getElementById('bulkTotalIncrease').textContent = '₦' + formatNumber(totalIncrease);
            document.getElementById('bulkTotalDecrease').textContent = '₦' + formatNumber(totalDecrease);

            // Enable/disable save button
            document.getElementById('prmSaveBulkBtn').disabled = selectedCount === 0;
        }

        function updateSelectAllState() {
            const allCheckboxes = document.querySelectorAll('.bulk-plot-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.bulk-plot-checkbox:checked');
            const selectAllCheckbox = document.getElementById('bulkSelectAll');
            
            if (allCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCheckboxes.length === allCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        // Save price updates
        addListener('prmSaveBulkBtn', 'click', function() {
            // Clear previous errors
            clearBulkErrors();
            
            const estateSelect = document.getElementById('prmBulkEstateSelect');
            const dateInput = document.getElementById('prmBulkEffectiveDate');
            const estateId = estateSelect.value;
            const effectiveDate = dateInput.value;
            const notes = document.getElementById('prmBulkNotes').value;
            const notify = document.getElementById('prmBulkNotifyChk').checked;

            // Inline validation
            let hasError = false;
            
            if (!estateId) {
                showBulkFieldError(estateSelect, 'bulkEstateError', 'Please select an estate');
                hasError = true;
            }
            
            if (!effectiveDate) {
                showBulkFieldError(dateInput, 'bulkDateError', 'Please select an effective date');
                hasError = true;
            }
            
            if (hasError) {
                showBulkErrorBanner('Please fill all required fields');
                return;
            }

            // Collect selected plots with new prices that have actually changed
            const updates = [];
            let unchangedCount = 0;
            
            document.querySelectorAll('.bulk-plot-checkbox:checked').forEach(checkbox => {
                const unitId = checkbox.getAttribute('data-unit-id');
                const row = document.querySelector(`tr[data-unit-id="${unitId}"]`);
                const previousPrice = parseFloat(row.getAttribute('data-previous')) || 0;
                
                // Get raw value (remove commas for calculation)
                const priceInput = document.querySelector(`.bulk-new-price[data-unit-id="${unitId}"]`);
                const rawValue = priceInput.getAttribute('data-raw-value') || priceInput.value.replace(/[^0-9]/g, '');
                const newPrice = parseFloat(rawValue) || 0;
                
                if (newPrice > 0) {
                    // Only add to updates if price has actually changed
                    if (newPrice !== previousPrice) {
                        updates.push({
                            plot_unit_id: unitId,
                            new_price: newPrice
                        });
                    } else {
                        unchangedCount++;
                    }
                }
            });

            // Check if no plots are selected
            const selectedCount = document.querySelectorAll('.bulk-plot-checkbox:checked').length;
            if (selectedCount === 0) {
                showBulkErrorBanner('Please select at least one plot to update');
                return;
            }

            // Check if all selected plots have no price changes
            if (updates.length === 0) {
                if (unchangedCount > 0) {
                    showBulkErrorBanner('No price changes detected. Please modify at least one price before saving.');
                } else {
                    showBulkErrorBanner('Please enter valid prices for the selected plots');
                }
                return;
            }

            // Disable button and show loading
            const saveBtn = document.getElementById('prmSaveBulkBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';

            // Send bulk update request
            fetch('/api/property-price/bulk-update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    estate_id: estateId,
                    effective: effectiveDate,
                    notes: notes,
                    notify: notify,
                    updates: updates
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    prmBulkUpdateModal.hide();
                    
                    // Refresh affected rows
                    data.updated_rows.forEach(rowKey => {
                        refreshRow(rowKey);
                    });

                    // Show success message with notification info
                    let successMsg = `Successfully updated ${data.updated_count} plot price(s)!`;
                    if (data.notification_sent && notify) {
                        successMsg += '\n\n✅ Notifications sent to clients and marketers.';
                    }
                    
                    document.getElementById('successModalMessage').textContent = successMsg;
                    successModal.show();
                } else {
                    showBulkErrorBanner('Failed to update: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showBulkErrorBanner('Error updating prices. Please try again.');
            })
            .finally(() => {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            });
        });
        
        // Clear bulk errors on date input change
        addListener('prmBulkEffectiveDate', 'change', function() {
            clearBulkFieldError(this, 'bulkDateError');
            hideBulkErrorBanner();
        });

        // ============================================
        // SEND NOTIFICATION FUNCTION
        // ============================================
        function sendNotification() {
            const subjectEl = document.getElementById('prmNotifySubject');
            const messageEl = document.getElementById('prmNotifyMessage');
            const estatesEl = document.getElementById('prmNotifyEstates');
            
            const subject = subjectEl.value.trim();
            const message = messageEl.value.trim();
            const notifyType = document.getElementById('prmNotifyType').value;
            const estateIds = Array.from(estatesEl.selectedOptions).map(o => o.value);
            const sendEmail = document.getElementById('prmNotifyEmail').checked;
            const sendInApp = document.getElementById('prmNotifyInApp').checked;

            // Validation
            let hasError = false;
            
            if (!subject) {
                showError('Subject is required');
                return;
            }
            
            if (!message) {
                showError('Message is required');
                return;
            }
            
            const hideTypes = ['client_update', 'marketer_update', 'general_notification'];
            if (!hideTypes.includes(notifyType) && estateIds.length === 0) {
                showError('Please select at least one estate');
                return;
            }
            
            if (!sendEmail && !sendInApp) {
                showError('Select at least one delivery channel');
                return;
            }

            const payload = { 
                subject, 
                message, 
                type: notifyType, 
                send_email: sendEmail, 
                send_sms: false,
                send_inapp: sendInApp 
            };
            if (!hideTypes.includes(notifyType)) payload.estate_ids = estateIds;

            const notifyBtn = document.getElementById('prmSendNotifyBtn');
            const originalBtnHtml = notifyBtn.innerHTML;
            notifyBtn.disabled = true;
            notifyBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';

            fetch("{% url 'notify_clients_marketer' %}", {
                method: 'POST',
                headers: {'Content-Type':'application/json','X-CSRFToken':csrftoken},
                body: JSON.stringify(payload)
            })
            .then(async response => {
                const contentType = response.headers.get('content-type') || '';
                const isJson = contentType.includes('application/json');
                const data = isJson ? await response.json() : await response.text();

                if (!response.ok) {
                    const detail = isJson
                        ? data.message || data.detail || data.error || JSON.stringify(data)
                        : data;
                    throw new Error(detail || `Request failed (${response.status})`);
                }

                if (!isJson) {
                    throw new Error('Unexpected response from server.');
                }

                return data;
            })
            .then(data => {
                if (data.status === 'success' || data.status === 'queued') {
                    prmNotifyModal.hide();

                    successMessageEl.textContent = '';
                    successDetailEl.innerHTML = '';
                    clearDispatchPolling();

                    if (data.status === 'queued' && data.dispatch) {
                        const totalRecipients = data.dispatch.total_recipients || data.recipients;
                        successMessageEl.innerHTML = renderHeadline(
                            `🚀 Queue started for <strong>${formatNumber(totalRecipients)}</strong> users.`,
                            'In progress',
                            'bg-primary text-white'
                        );
                        successDetailEl.innerHTML = renderDispatchDetail(data.dispatch);
                        startDispatchPolling(data.dispatch.id);
                    } else {
                        const deliveredText = data.recipients ? `${formatNumber(data.recipients)} users.` : 'No queue';
                        successMessageEl.innerHTML = data.recipients
                            ? renderHeadline(
                                `✅ Notifications sent to <strong>${deliveredText.replace('.', '')}</strong>`,
                                'Queue cleared',
                                'bg-success text-white'
                            )
                            : renderHeadline(
                                '✅ Notifications sent <strong>— No queue</strong>',
                                'Queue empty',
                                'bg-secondary text-white'
                            );
                        successDetailEl.innerHTML = data.recipients ? '' : '<span>No queue</span>';
                    }

                    successModal.show();
                } else {
                    showError(data.message || 'Something went wrong.');
                }
            })
            .catch(err => {
                console.error('Notification request failed:', err);
                showError(err?.message || 'Unable to send notifications. Please try again.');
            })
            .finally(() => {
                notifyBtn.disabled = false;
                notifyBtn.innerHTML = originalBtnHtml;
            });
        }

    }); // End of DOMContentLoaded

    // ============================================
    // GLOBAL HELPER FUNCTIONS (outside DOMContentLoaded)
    // ============================================

    function renderHeadline(message, badgeLabel = null, badgeClass = 'bg-primary text-white') {
        const badge = badgeLabel
            ? `<span class="badge rounded-pill ${badgeClass}">${badgeLabel}</span>`
            : '';

        return `
            <div class="d-flex flex-column flex-md-row align-items-center justify-content-center gap-2 text-center">
                <span>${message}</span>
                ${badge}
            </div>
        `;
    }

    function renderDispatchDetail(dispatch) {
        if (!dispatch) {
            return '<span>No queue</span>';
        }

        const totalRecipients = dispatch.total_recipients || 0;
        const processedRecipients = dispatch.processed_recipients || 0;
        const remainingRecipients = dispatch.remaining_recipients ?? Math.max(totalRecipients - processedRecipients, 0);

        const totalBatches = dispatch.total_batches || 0;
        const processedBatches = dispatch.processed_batches || 0;
        const remainingBatches = dispatch.remaining_batches ?? Math.max(totalBatches - processedBatches, 0);

        const progressPercent = dispatch.progress_percent ?? (
            totalRecipients > 0
                ? Math.round((processedRecipients / totalRecipients) * 10000) / 100
                : (processedRecipients > 0 ? 100 : 0)
        );

        const formattedProcessed = `${formatNumber(processedRecipients)} / ${formatNumber(totalRecipients)}`;
        const formattedBatches = `${formatNumber(processedBatches)} / ${formatNumber(totalBatches)}`;

        return `
            <div class="text-start">
                <div class="small text-muted mb-1">Recipients processed</div>
                <div class="fw-semibold">${formattedProcessed}</div>
                <div class="progress my-2" style="height: 6px;">
                    <div class="progress-bar" role="progressbar" style="width: ${Math.min(progressPercent, 100)}%;" aria-valuenow="${progressPercent}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="d-flex justify-content-between small">
                    <span>${formatNumber(processedRecipients)} processed</span>
                    <span>${formatNumber(remainingRecipients)} remaining</span>
                </div>
                <hr class="my-2">
                <div class="small text-muted mb-1">Batches processed</div>
                <div>${formattedBatches}</div>
                <div class="d-flex justify-content-between small">
                    <span>${formatNumber(processedBatches)} processed</span>
                    <span>${formatNumber(remainingBatches)} remaining</span>
                </div>
                <div class="small mt-2"><strong>Status:</strong> ${dispatch.status || 'queued'}</div>
            </div>
        `;
    }

    function startDispatchPolling(dispatchId) {
        clearDispatchPolling();

        const successMessageEl = document.getElementById('successModalMessage');
        const successDetailEl = document.getElementById('successModalDetail');

        const poll = () => {
            fetch(`/api/notification-dispatch/${dispatchId}/status/`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(r => r.json())
            .then(payload => {
                if (!payload.ok) {
                    return;
                }

                const dispatch = payload.dispatch;
                successDetailEl.innerHTML = renderDispatchDetail(dispatch);

                if (dispatch.status === 'completed' || dispatch.status === 'failed') {
                    if (dispatch.status === 'completed') {
                        successMessageEl.innerHTML = renderHeadline(
                            '✅ Queue completed',
                            'All recipients processed',
                            'bg-success text-white'
                        );
                    } else {
                        successMessageEl.innerHTML = renderHeadline(
                            '❌ Queue failed',
                            dispatch.last_error ? 'Check error details below' : 'Encountered an error',
                            'bg-danger text-white'
                        );
                        if (dispatch.last_error) {
                            successDetailEl.innerHTML += `<div class="alert alert-danger mt-3" role="alert">${dispatch.last_error}</div>`;
                        }
                    }
                    clearDispatchPolling();
                }
            })
            .catch(() => {
                clearDispatchPolling();
            });
        };

        poll();
        dispatchPollTimer = setInterval(poll, 3000);
    }

    function showError(msg) {
        document.getElementById('errorModalMessage').textContent = `❌ ${msg}`;
        new bootstrap.Modal(document.getElementById('errorModal')).show();
    }

</script>
