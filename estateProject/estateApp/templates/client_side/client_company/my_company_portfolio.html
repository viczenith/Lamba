{% extends 'client_base.html' %}
{% load humanize %}

{% block title %}{{ company.company_name }} — My Portfolio{% endblock %}

{% block content %}
<main id="main" class="main">
  <style>
    .portfolio-logo {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
    }

    .portfolio-initials {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      font-size: 2rem;
    }

    /* Appreciation Tab Styling */
    .appreciation-card {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease;
      height: 100%;
    }
    
    .appreciation-card:hover {
      transform: translateY(-5px);
    }
    
    .appreciation-details {
      background-color: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
    }
    
    .appreciation-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .appreciation-item:last-child {
      margin-bottom: 0;
    }
    
    .timeline {
      position: relative;
      padding-left: 30px;
      margin-top: 20px;
    }
    
    .timeline::before {
      content: '';
      position: absolute;
      left: 10px;
      top: 5px;
      height: calc(100% - 10px);
      width: 2px;
      background-color: #dee2e6;
    }
    
    .timeline-item {
      position: relative;
      margin-bottom: 20px;
    }
    
    .timeline-item:last-child {
      margin-bottom: 0;
    }
    
    .timeline-point {
      position: absolute;
      left: -30px;
      top: 5px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      z-index: 2;
    }
    
    .timeline-content {
      padding: 8px 0;
    }
    
    .timeline-date {
      font-size: 0.85rem;
      color: #6c757d;
    }
    
    .timeline-value {
      font-weight: 600;
    }

    .summary-box {
      border-radius: 10px;
      padding: 15px;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .summary-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      flex-shrink: 0;
    }
    
    .summary-icon i {
      font-size: 1.5rem;
    }
    
    .summary-content span {
      display: block;
      font-size: 0.9rem;
      color: #6c757d;
    }
    
    .summary-content strong {
      font-size: 1.1rem;
    }

    .bg-light-success {
      background-color: rgba(40, 167, 69, 0.1) !important;
    }
    
    .bg-light-primary {
      background-color: rgba(16, 185, 129, 0.1) !important;
    }
    
    .bg-light-info {
      background-color: rgba(23, 162, 184, 0.1) !important;
    }

    /* Tab styling */
    .nav-tabs {
      border-bottom: 2px solid #e9ecef;
    }

    .nav-tabs .nav-link {
      color: #6c757d;
      border: none;
      border-bottom: 3px solid transparent;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .nav-tabs .nav-link:hover {
      border-bottom-color: #10b981;
      color: #10b981;
    }

    .nav-tabs .nav-link.active {
      color: #10b981;
      border-bottom-color: #10b981;
      background-color: transparent;
    }

    @media (max-width: 576px) {
      .appreciation-details {
        padding: 12px;
      }
      
      .timeline {
        padding-left: 20px;
      }
      
      .timeline::before {
        left: 5px;
      }
      
      .timeline-point {
        left: -25px;
      }
    }
  </style>
  <div class="pagetitle">
    <h1>My Portfolio</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'client-dashboard' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'my-companies' %}">My Companies</a></li>
        <li class="breadcrumb-item active">{{ company.company_name }}</li>
      </ol>
    </nav>
  </div>

  <section class="section">
    <div class="container">
      <!-- Company header -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="company-hero d-flex align-items-center justify-content-between p-3 rounded shadow-sm">
            <div class="d-flex align-items-center">
              <div class="me-3">
                {% if company.logo %}
                  <img src="{{ company.logo.url }}" alt="{{ company.company_name }}" class="portfolio-logo">
                {% else %}
                  <div class="portfolio-initials">{{ company.company_name|default:"?"|slice:":1"|upper }}</div>
                {% endif %}
              </div>
              <div>
                <h2 class="mb-0">{{ company.company_name }}</h2>
                <div class="text-muted small">{{ company.office_address|default:company.location|default:'Address not available' }}</div>
                <div class="text-muted small">Contact: {% if company.phone %}<a href="tel:{{ company.phone }}">{{ company.phone }}</a>{% else %}-{% endif %} • {% if company.email %}<a href="mailto:{{ company.email }}">{{ company.email }}</a>{% else %}-{% endif %}</div>
              </div>
            </div>

            <div class="d-flex gap-2 align-items-center">
              <!-- Action buttons removed per UI request -->
            </div>
          </div>
        </div>
      </div>

      <!-- Stats & Charts -->
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="stat-card p-3 rounded shadow-sm h-100">
            <div class="small text-muted">Total Invested</div>
            <div class="h4 fw-bold">₦{{ total_invested|default:0|intcomma }}</div>
            <div class="small text-muted">Across all purchases</div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="stat-card p-3 rounded shadow-sm h-100 bg-light-success">
            <div class="small text-muted">Total Appreciation</div>
            <div class="h4 fw-bold text-success">₦{{ total_value_increased|default:0|intcomma }}</div>
            <div class="small text-muted">Total Current Value minus Total Invested</div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="stat-card p-3 rounded shadow-sm h-100">
            <div class="small text-muted">Total Current Value</div>
            <div class="h4 fw-bold">₦{{ total_current_value|default:0|intcomma }}</div>
            <div class="small text-muted">Current market value of all properties</div>
          </div>
        </div>

        <!-- Marketer Details Card -->
        <div class="col-md-3">
          <div class="stat-card p-3 rounded shadow-sm h-100 bg-light-info">
            <div class="small text-muted">Your Marketer is</div>
            {% if marketer %}
              <div class="h5 fw-bold mb-1">{{ marketer.full_name }}</div>
              <div class="small text-muted">{{ marketer.email }}</div>
              <div class="small">Phone: {% if marketer.phone %}<a href="tel:{{ marketer.phone }}">{{ marketer.phone }}</a>{% else %}-{% endif %}</div>
            {% else %}
              <div class="text-muted">No marketer assigned</div>
            {% endif %}
          </div>
        </div>
        <!-- End Marketer Details Card -->
      </div>

      <div class="row g-4">
        <!-- Left column: allocations list -->
        <div class="col-lg-8">
          <!-- Tabs for Properties & Appreciation -->
          <ul class="nav nav-tabs mb-3" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="properties-tab" data-bs-toggle="tab" data-bs-target="#properties-pane" type="button" role="tab">Properties</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="appreciation-tab" data-bs-toggle="tab" data-bs-target="#appreciation-pane" type="button" role="tab">Value Appreciation</button>
            </li>
          </ul>

          <div class="tab-content">
            <!-- Properties Tab -->
            <div class="tab-pane fade show active" id="properties-pane" role="tabpanel" aria-labelledby="properties-tab">
              <div class="card mb-3">
                <div class="card-body">
                  <h5 class="card-title">Your Properties</h5>
              {% if allocations and allocations.count %}
                <div class="table-responsive">
                  <table class="table table-hover align-middle">
                    <thead>
                      <tr>
                        <th>Estate</th>
                        <th>Plotsize</th>
                        <th>Plot Number</th>
                        <th>Payment</th>
                        <th>Amount Paid</th>
                        <th>Current Value</th>
                        <th>Date</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for alloc in allocations %}
                        <tr>
                          <td class="fw-semibold">{{ alloc.estate.name }}</td>
                          <td>{{ alloc.plot_size.size }}</td>
                          <td>{% if alloc.plot_number %}{{ alloc.plot_number.number }}{% else %}<span class="text-muted">Reserved</span>{% endif %}</td>
                          <td>{{ alloc.get_payment_type_display }}</td>
                          <td>₦{{ alloc.total_paid|default:0|intcomma }}</td>
                          <td class="fw-bold">
                            {% if alloc.latest_price_current %}
                              ₦{{ alloc.latest_price_current|floatformat:"2g" }}
                            {% elif alloc.latest_transaction and alloc.latest_transaction.current_value %}
                              ₦{{ alloc.latest_transaction.current_value|floatformat:"2g" }}
                            {% else %}
                              <span class="text-muted">-</span>
                            {% endif %}
                          </td>
                          <td>{{ alloc.date_allocated|date:"d M Y" }}</td>
                          <td class="text-end">
                            <!-- View Receipts: will trigger transaction modal when allocation has a transaction id -->

                            {% if alloc.latest_tx_id %}
                              <button
                                type="button"
                                class="btn btn-sm btn-outline-success alloc-receipts-btn"
                                data-bs-toggle="modal"
                                data-bs-target="#transactionDetailsModal"
                                data-id="{{ alloc.latest_tx_id }}"
                                data-alloc-id="{{ alloc.id }}"
                              >
                                <i class="bi bi-receipt"></i> View Receipts
                              </button>
                            {% else %}
                              <button type="button" class="btn btn-sm btn-outline-secondary" disabled title="No transaction available">
                                <i class="bi bi-receipt"></i> View Receipts
                              </button>
                            {% endif %}

                            <!-- View Plot Details: reuse the same route used elsewhere -->
                            {% if alloc.estate and alloc.plot_size %}
                              <a href="{% url 'view-client-estate' alloc.estate.id alloc.plot_size.id %}" class="btn btn-sm btn-outline-primary ms-2">
                                <i class="bi bi-book"></i> View Plot Details
                              </a>
                            {% else %}
                              <span class="text-muted ms-2">N/A</span>
                            {% endif %}
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <p class="text-muted">No allocations found for this company.</p>
              {% endif %}
            </div>
          </div>
            </div><!-- End Properties Tab -->

            <!-- Value Appreciation Tab -->
            <div class="tab-pane fade" id="appreciation-pane" role="tabpanel" aria-labelledby="appreciation-tab">
              <h5 class="card-title">Property Value Appreciation</h5>
              <p class="text-muted">Detailed view of property value growth over time in {{ company.company_name }}</p>
              
              <div class="row row-cols-1 row-cols-md-2 g-4">
                {% for transaction in transactions %}
                <div class="col">
                  <div class="card appreciation-card h-100">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-title mb-0">
                          <i class="bi bi-building me-1 text-primary"></i>
                          {{ transaction.allocation.estate.name }}
                        </h6>
                        <span class="badge bg-light text-dark">{{ transaction.allocation.plot_size.size }}</span>
                      </div>
                      
                      <div class="appreciation-details mb-3">
                        <div class="appreciation-item d-flex justify-content-between">
                          <span>Purchase Price:</span>
                          <strong>₦{{ transaction.total_amount|floatformat:"2g" }}</strong>
                        </div>
                        <div class="appreciation-item d-flex justify-content-between">
                          <span>Current Value:</span>
                          <strong>₦{{ transaction.current_value|floatformat:"2g" }}</strong>
                        </div>
                        <div class="appreciation-item d-flex justify-content-between">
                          <span>Value Increase:</span>
                          <strong class="{% if transaction.appreciation >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if transaction.appreciation >= 0 %}+{% else %}-{% endif %}₦{{ transaction.abs_appreciation|floatformat:"2g" }}
                          </strong>
                        </div>
                        <div class="appreciation-item d-flex justify-content-between">
                          <span>Growth Rate:</span>
                          <strong class="{% if transaction.growth_rate >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if transaction.growth_rate >= 0 %}+{% endif %}{{ transaction.growth_rate|floatformat:"2" }}%
                          </strong>
                        </div>
                      </div>
                      
                      <div class="progress mb-1" style="height: 8px;">
                        <div class="progress-bar {% if transaction.growth_rate >= 0 %}bg-success{% else %}bg-danger{% endif %}" 
                             role="progressbar" 
                             style="width: {{ transaction.abs_growth_rate|default:0 }}%;" 
                             aria-valuenow="{{ transaction.abs_growth_rate|default:0 }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100"></div>
                      </div>
                      <div class="d-flex justify-content-between small text-muted mb-3">
                        <span>Purchase</span>
                        <span>Current</span>
                      </div>
                      
                      <div class="timeline">
                        <div class="timeline-item mb-3">
                          <div class="timeline-point bg-success"></div>
                          <div class="timeline-content">
                            <span class="timeline-date">{{ transaction.transaction_date|date:"M Y" }}</span>
                            <div class="timeline-value">₦{{ transaction.total_amount|floatformat:"2g" }}</div>
                          </div>
                        </div>
                        <div class="timeline-item">
                          <div class="timeline-point bg-primary"></div>
                          <div class="timeline-content">
                            <span class="timeline-date">Now</span>
                            <div class="timeline-value">₦{{ transaction.current_value|floatformat:"2g" }}</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                {% empty %}
                <div class="col-12">
                  <div class="text-center py-5 text-muted">
                    <i class="bi bi-graph-up display-6"></i>
                    <p class="mt-3">No appreciation data available</p>
                  </div>
                </div>
                {% endfor %}
              </div>
              
              <div class="card mt-4">
                <div class="card-body">
                  <h5 class="card-title text-center">{{ company.company_name }} — Portfolio Summary</h5>
                  <div class="row row-cols-1 row-cols-md-3 g-3 text-center">
                    <div class="col">
                      <div class="summary-box bg-light-success d-flex align-items-center justify-content-center p-3 rounded h-100">
                        <div>
                          <i class="bi bi-arrow-up-right-circle fs-3 text-success mb-1"></i>
                          <div>Total Appreciation</div>
                          <strong class="text-success">+₦{{ appreciation_total|floatformat:"2g" }}</strong>
                        </div>
                      </div>
                    </div>
                    <div class="col">
                      <div class="summary-box bg-light-primary d-flex align-items-center justify-content-center p-3 rounded h-100">
                        <div>
                          <i class="bi bi-percent fs-3 text-primary mb-1"></i>
                          <div>Average Growth</div>
                          <strong class="text-success">+{{ average_growth|floatformat:"2" }}%</strong>
                        </div>
                      </div>
                    </div>
                    <div class="col">
                      <div class="summary-box bg-light-info d-flex align-items-center justify-content-center p-3 rounded h-100">
                        <div>
                          <i class="bi bi-building fs-3 text-info mb-1"></i>
                          <div>Highest Growth</div>
                          <strong>{{ highest_growth_property }} <strong class="text-success">(+{{ highest_growth_rate|floatformat:"2" }}%)</strong></strong>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div><!-- End Value Appreciation Tab -->
          </div><!-- End tab content -->

        </div><!-- End Left Column (with tabs) -->


        <!-- Right column: company summary, contact, downloads -->
        <div class="col-lg-4">
          <div class="card mb-3 p-3 text-center">
            <div class="company-side-stats">
              <div class="small text-muted">Company Summary</div>
              <div class="h5 fw-bold">{{ company.company_name }}</div>
              <div class="small text-muted">Owned Estates: {{ estates_count }}</div>
            </div>
          </div>

          <div class="card mb-3 p-3">
            <h6 class="mb-2">Quick Facts</h6>
            <ul class="list-unstyled small text-muted mb-0">
              <li><strong>{{ allocations|length }}</strong> properties</li>
              <li><strong>{{ transactions|length }}</strong> transactions</li>
              <li>Last transaction: {% if transactions|length %}{{ transactions.0.transaction_date|date:"d M Y" }}{% else %}-{% endif %}</li>
            </ul>
          </div>

          <div class="card p-3">
            <h6 class="mb-2">Recent Transactions</h6>
            {% if transactions and transactions.count %}
              <ul class="list-group list-group-flush">
                {% for tx in transactions|slice:":5" %}
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div>
                      <div class="fw-semibold">{{ tx.reference_code }}</div>
                      <div class="small text-muted">{{ tx.transaction_date|date:"d M Y" }}</div>
                    </div>
                    <div class="text-end">
                      <div class="fw-bold">₦{{ tx.total_amount|intcomma }}</div>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="small text-muted mb-0">No recent transactions.</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Transaction Details Modal (reused from client profile) -->
<div class="modal fade" id="transactionDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Transaction Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="txn-modal-loading" class="text-center my-4" style="display:none;">
          <div class="spinner-border text-success" role="status"><span class="visually-hidden">Loading...</span></div>
          <div>Loading transaction details...</div>
        </div>
        <div id="txn-modal-error" class="alert alert-danger d-none" role="alert">
          Error loading transaction details. Please try again.
        </div>
        <div class="row">
          <div class="col-md-6">
            <table class="table table-sm">
              <tr><th>Estate</th><td id="td_estate"></td></tr>
              <tr><th>Plot Size</th><td id="td_plot_size"></td></tr>
              <tr><th>Date</th><td id="td_date"></td></tr>
              <tr><th>Amount</th><td id="td_amount"></td></tr>
              <tr><th>Type</th><td id="td_payment_type"></td></tr>
            </table>
          </div>
          <div class="col-md-6">
            <table class="table table-sm">
              <tr><th>Status</th><td id="td_status"></td></tr>
              <tr id="row_duration" style="display:none;"><th>Duration</th><td id="td_duration"></td></tr>
              <tr id="row_plan" style="display:none;"><th>Plan</th><td id="td_plan"></td></tr>
              <tr id="row_first" style="display:none;"><th>1st</th><td id="td_first"></td></tr>
              <tr id="row_second" style="display:none;"><th>2nd</th><td id="td_second"></td></tr>
              <tr id="row_third" style="display:none;"><th>3rd</th><td id="td_third"></td></tr>
            </table>
          </div>
        </div>
        <div id="td_payment_history" class="mt-3">
          <h6>Payment Receipts</h6>
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Method</th>
                  <th>Installment</th>
                  <th>Reference</th>
                  <th class="text-end">Action</th>
                </tr>
              </thead>
              <tbody id="payment_history_body">
                <!-- Payment records will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
  <!-- Chart.js (optional) and page scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Build simple allocation trend from server-rendered data
    document.addEventListener('DOMContentLoaded', function() {
      var ctx = document.getElementById('allocTrendChart');
      if (ctx) {
        try {
          var labels = JSON.parse('{{ allocations|json_script:"allocLabels" }}');
          var data = JSON.parse('{{ allocations|length|json_script:"allocData" }}');
          // Collapse counts by label
          var counts = {};
          for(var i=0;i<labels.length;i++){ counts[labels[i]] = (counts[labels[i]]||0) + 1; }
          var groupedLabels = Object.keys(counts);
          var groupedData = groupedLabels.map(function(k){ return counts[k]; });
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: groupedLabels,
              datasets: [{ label: 'Allocations', data: groupedData, backgroundColor: 'rgba(108,92,231,0.9)' }]
            },
            options: { responsive:true, maintainAspectRatio:true, scales:{ y:{ beginAtZero:true } } }
          });
        } catch(e) { console.error(e); }
      }
      // Allocation Details button (fetch JSON and show simple modal)
      document.addEventListener('click', function(evt){
        var btn = evt.target.closest && evt.target.closest('.alloc-details-btn');
        if(!btn) return;
        evt.preventDefault();
        var url = btn.dataset.url;
        if(!url) return alert('Details URL not available');
        fetch(url, { credentials: 'same-origin' })
          .then(function(res){ if(!res.ok) throw new Error('Failed to fetch'); return res.json(); })
          .then(function(data){
            var parts = [];
            parts.push('Client: ' + (data.client || 'N/A'));
            parts.push('Payment type: ' + (data.payment_type || 'N/A'));
            parts.push('Plot number id: ' + (data.plot_number || 'N/A'));
            parts.push('Allocation id: ' + (data.id || 'N/A'));
            alert(parts.join('\n'));
          }).catch(function(err){
            console.error(err);
            alert('Unable to load allocation details.');
          });
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script>
    $(document).ready(function(){
      function formatCurrency(v) {
        return '₦' + parseFloat(v || 0).toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
      }





      $('#transactionDetailsModal').on('show.bs.modal', function(e) {
        var id = $(e.relatedTarget).data('id');
        
        // Clear previous data
        $('#td_estate, #td_plot_size, #td_date, #td_amount, #td_payment_type, #td_status').text('');
        $('#payment_history_body').empty();
        $('[id^="row_"]').hide();
        
        if(!id) {
          console.error('No transaction ID provided');
          alert('No transaction ID provided');
          return;
        }
        
        // Fetch transaction details
        $.ajax({
          url: `/transaction/${id}/details/`,
          type: 'GET',
          dataType: 'json',
          success: function(d) {
            console.log('Transaction details received:', d);
            
            // Populate from allocation object (guaranteed structure from backend)
            $('#td_estate').text(d.allocation.estate.name || 'N/A');
            $('#td_plot_size').text(d.allocation.plot_size || 'N/A');
            $('#td_date').text(d.transaction_date || 'N/A');
            $('#td_amount').text(formatCurrency(d.total_amount || 0));
            
            // Payment Type badge
            var paymentType = d.allocation.payment_type;
            var ptHtml = paymentType === 'part'
              ? '<span class="badge bg-info text-dark">Part Payment</span>'
              : '<span class="badge bg-primary">Full Payment</span>';
            $('#td_payment_type').html(ptHtml);
            
            // Status badge
            var statusHtml = '';
            var status = d.status;
            switch(status) {
              case 'Paid Complete':
              case 'Fully Paid':
                statusHtml = '<span class="badge bg-success">' + status + '</span>';
                break;
              case 'Part Payment':
                statusHtml = '<span class="badge bg-warning text-dark">' + status + '</span>';
                break;
              case 'Overdue':
                statusHtml = '<span class="badge bg-danger">' + status + '</span>';
                break;
              default:
                statusHtml = '<span class="badge bg-secondary">' + status + '</span>';
            }
            $('#td_status').html(statusHtml);
            
            // Part-payment details
            if(paymentType === 'part') {
              // Duration
              var durText = '';
              if(d.payment_duration) {
                durText = d.payment_duration + ' month' + (d.payment_duration > 1 ? 's' : '');
              } else if(d.custom_duration) {
                durText = d.custom_duration + ' month' + (d.custom_duration > 1 ? 's' : '');
              }
              if(durText) {
                $('#td_duration').text(durText);
                $('#row_duration').show();
              }
              
              // Installment plan
              if(d.installment_plan) {
                var planText = d.installment_plan === 'custom'
                  ? (d.first_percent + '%, ' + d.second_percent + '%, ' + d.third_percent + '%')
                  : d.installment_plan.replace(/-/g, '%, ') + '%';
                $('#td_plan').text(planText);
                $('#row_plan').show();
              }
              
              // Installment amounts
              if(d.first_installment) {
                $('#td_first').text(formatCurrency(d.first_installment));
                $('#row_first').show();
              }
              if(d.second_installment) {
                $('#td_second').text(formatCurrency(d.second_installment));
                $('#row_second').show();
              }
              if(d.third_installment) {
                $('#td_third').text(formatCurrency(d.third_installment));
                $('#row_third').show();
              }
            }
          },
          error: function(xhr, status, error) {
            console.error('Transaction fetch failed:', status, error, xhr.responseText);
            alert('Error loading transaction details: ' + error);
          }
        });
        
        // Fetch payment history
        $.ajax({
          url: "{% url 'ajax_payment_history' %}",
          type: 'GET',
          data: { transaction_id: id },
          dataType: 'json',
          success: function(d) {
            console.log('Payment history received:', d);
            var html = '';
            
            if(d.payments && d.payments.length) {
              d.payments.forEach(function(p) {
                html += '<tr>' +
                  '<td>' + (p.date || '') + '</td>' +
                  '<td>' + formatCurrency(p.amount || 0) + '</td>' +
                  '<td>' + (p.method || '') + '</td>' +
                  '<td>' + (p.installment || '') + '</td>' +
                  '<td>' + (p.reference || '') + '</td>' +
                  '<td class="text-end">' +
                    '<button class="btn btn-sm btn-outline-success view-receipt-btn" data-reference="' + (p.reference || '') + '">' +
                      '<i class="bi bi-download"></i> Download' +
                    '</button>' +
                  '</td>' +
                '</tr>';
              });
            } else {
              html = '<tr><td colspan="6" class="text-center">No payment history</td></tr>';
            }
            
            $('#payment_history_body').html(html);
          },
          error: function(xhr, status, error) {
            console.error('Payment history fetch failed:', status, error, xhr.responseText);
            $('#payment_history_body').html('<tr><td colspan="6" class="text-center">Error loading payment history</td></tr>');
          }
        });
      });

      // Handle receipt download
      $(document).on('click', '.view-receipt-btn', function() {
        const reference = $(this).attr('data-reference') || $(this).data('reference');
        if(reference) window.open(`/payment/receipt/${reference}/`, '_blank');
      });
    });
  </script>
{% endblock %}
