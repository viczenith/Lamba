{% extends 'client_base.html' %}
{% load humanize %}
{% block content %}
<main class="main">
  <div class="pagetitle"><h1>{{ company.company_name }} — My Portfolio</h1></div>

  <section class="section">
    <div class="container">
      <div class="row g-4">
        <div class="col-12 col-lg-4">
          <div class="card summary-card h-100 shadow-sm">
            <div class="card-body">
              <h6 class="text-muted">Total Invested</h6>
              <div class="h3 fw-bold">₦{{ total_invested|default:0|intcomma }}</div>

              <hr>
              <div class="small text-muted">Allocations</div>
              <div class="mt-2">
                <span class="badge bg-primary">{{ allocations|length }}</span>
                <span class="ms-2 small text-muted">Estates</span>
                <span class="badge bg-secondary ms-1">{{ estates_count }}</span>
              </div>

              <div class="mt-4">
                <a class="btn btn-outline-primary btn-sm" href="{% url 'client-dashboard' %}?company={{ company.slug|default:'' }}">Back to Dashboard</a>
                <a class="btn btn-primary btn-sm ms-2" href="{% url 'my-companies' %}">My Companies</a>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-8">
          <div class="card h-100 shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Allocations</h5>
              {% if allocations %}
                <div class="row g-3">
                  {% for alloc in allocations %}
                    <div class="col-12">
                      <div class="allocation-row d-flex justify-content-between align-items-start p-3 border rounded">
                        <div>
                          <div class="fw-bold">{{ alloc.estate.name }}</div>
                          <div class="small text-muted">Allocated on: {{ alloc.date_allocated|date:'M d, Y' }}</div>
                          <div class="small text-muted">Plot size: {{ alloc.plot_size }}</div>
                        </div>
                        <div class="text-end">
                          <div class="small text-muted">Payment</div>
                          <div class="fw-semibold">{{ alloc.payment_type|capfirst }}</div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="text-muted">No allocations with this company.</div>
              {% endif %}

              <hr class="my-4">

              <h5 class="card-title">Transactions</h5>
              {% if transactions %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                      <thead class="table-light">
                        <tr>
                          <th>Date</th>
                          <th>Amount</th>
                          <th>Allocation</th>
                          <th>Current Value</th>
                          <th>Status</th>
                          <th>Receipts</th>
                          <th class="text-end">Plot Details</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for tx in transactions %}
                          <tr>
                            <td>{{ tx.transaction_date|date:'M d, Y' }}</td>
                            <td>₦{{ tx.total_amount|intcomma }}</td>
                            <td>{% if tx.allocation %}{{ tx.allocation.estate.name }}{% else %}-{% endif %}</td>
                            <td>
                              {% if tx.appreciation is not None %}
                                {% if tx.appreciation >= 0 %}
                                  <strong class="text-success">+₦{{ tx.appreciation|floatformat:"2g"|intcomma }}</strong>
                                {% else %}
                                  <strong class="text-danger">-₦{{ tx.abs_appreciation|floatformat:"2g"|intcomma }}</strong>
                                {% endif %}
                              {% else %}
                                -
                              {% endif %}
                            </td>
                            <td><span class="badge bg-secondary">{{ tx.status|default:'completed' }}</span></td>
                            <td>
                              <button
                                class="btn btn-sm btn-outline-success"
                                data-bs-toggle="modal"
                                data-bs-target="#transactionDetailsModal"
                                data-id="{{ tx.id }}"
                              >
                                <i class="bi bi-receipt"></i> View Receipts
                              </button>
                            </td>
                            <td class="text-end">
                              {% if tx.allocation and tx.allocation.estate and tx.allocation.plot_size %}
                                <a
                                  href="{% url 'view-client-estate' tx.allocation.estate.id tx.allocation.plot_size.id %}"
                                  class="btn btn-sm btn-outline-primary"
                                >
                                  <i class="bi bi-book"></i> View Plot Details
                                </a>
                              {% else %}
                                <span class="text-muted">N/A</span>
                              {% endif %}
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                </div>
              {% else %}
                <div class="text-muted">No transactions for this company.</div>
              {% endif %}

            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>
{% endblock %}

<!-- Transaction Details Modal (copied from client_profile for consistent UX) -->
<div class="modal fade" id="transactionDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Transaction Details</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <table class="table table-sm">
              <tr><th>Estate</th><td id="td_estate"></td></tr>
              <tr><th>Plot Size</th><td id="td_plot_size"></td></tr>
              <tr><th>Date</th><td id="td_date"></td></tr>
              <tr><th>Amount</th><td id="td_amount"></td></tr>
              <tr><th>Type</th><td id="td_payment_type"></td></tr>
            </table>
          </div>
          <div class="col-md-6">
            <table class="table table-sm">
              <tr><th>Status</th><td id="td_status"></td></tr>
              <tr id="row_duration" style="display:none;"><th>Duration</th><td id="td_duration"></td></tr>
              <tr id="row_plan" style="display:none;"><th>Plan</th><td id="td_plan"></td></tr>
              <tr id="row_first" style="display:none;"><th>1st</th><td id="td_first"></td></tr>
              <tr id="row_second" style="display:none;"><th>2nd</th><td id="td_second"></td></tr>
              <tr id="row_third" style="display:none;"><th>3rd</th><td id="td_third"></td></tr>
            </table>
          </div>
        </div>
        <div id="td_payment_history" class="mt-3">
          <h6>Payment Receipts</h6>
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Method</th>
                  <th>Installment</th>
                  <th>Reference</th>
                  <th class="text-end">Action</th>
                </tr>
              </thead>
              <tbody id="payment_history_body">
                <!-- Payment records will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script>
  $(document).ready(function(){
    function formatCurrency(v) {
      return '₦' + parseFloat(v || 0).toLocaleString(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    $('#transactionDetailsModal').on('show.bs.modal', function(e) {
      let id = $(e.relatedTarget).data('id');
      const allocIdFallback = $(e.relatedTarget).data('alloc-id') || $(e.relatedTarget).closest('tr').data('id');
      if(!id && allocIdFallback) {
        // Try to resolve a transaction id from the allocation if button only provided alloc-id
        console.debug('Modal trigger had alloc-id, attempting to resolve tx id for alloc:', allocIdFallback);
        // Look up a button in the page that references this allocation and carries a tx id
        const btn = $(`[data-alloc-id="${allocIdFallback}"][data-id]`).first();
        if(btn && btn.data('id')) {
          id = btn.data('id');
          console.debug('Resolved tx id from page element:', id);
        }
      }
      console.debug('Opening transaction modal, resolved id:', id, 'allocFallback:', allocIdFallback);
      // Clear previous data
      $('#td_estate, #td_plot_size, #td_date, #td_amount, #td_payment_type, #td_status').text('');
      $('#payment_history_body').empty();
      $('[id^="row_"]').hide();

      // Fetch transaction details
      if(!id) {
        console.error('No transaction id available to load details');
        $('#payment_history_body').html('<tr><td colspan="6" class="text-center">Transaction id missing</td></tr>');
        return;
      }

      $.get(`/transaction/${id}/details/`)
        .done(d => {
          console.debug('ajax_transaction_details response:', d);
          $('#td_estate').text(d.allocation.estate.name);
          $('#td_plot_size').text(d.allocation.plot_size);
          $('#td_date').text(d.transaction_date);
          $('#td_amount').text(formatCurrency(d.total_amount));

          const ptHtml = d.allocation.payment_type === 'part'
            ? '<span class="badge bg-info text-dark">Part Payment</span>'
            : '<span class="badge bg-primary">Full Payment</span>';
          $('#td_payment_type').html(ptHtml);

          let statusHtml = '';
          switch(d.status) {
            case 'Paid Complete':
            case 'Fully Paid':
              statusHtml = '<span class="badge bg-success">' + d.status + '</span>';
              break;
            case 'Part Payment':
              statusHtml = '<span class="badge bg-warning text-dark">' + d.status + '</span>';
              break;
            case 'Overdue':
              statusHtml = '<span class="badge bg-danger">' + d.status + '</span>';
              break;
            default:
              statusHtml = '<span class="badge bg-secondary">' + d.status + '</span>';
          }
          $('#td_status').html(statusHtml);

          if(d.allocation.payment_type === 'part') {
            let durText = '';
            if(d.payment_duration) {
              durText = d.payment_duration + ' month' + (d.payment_duration > 1 ? 's' : '');
            } else if(d.custom_duration) {
              durText = d.custom_duration + ' month' + (d.custom_duration > 1 ? 's' : '');
            }
            if(durText) {
              $('#td_duration').text(durText);
              $('#row_duration').show();
            }

            const planText = d.installment_plan === 'custom'
              ? `${d.first_percent}%, ${d.second_percent}%, ${d.third_percent}%`
              : d.installment_plan.split('-').join('%, ') + '%';
            $('#td_plan').text(planText);
            $('#row_plan').show();

            $('#td_first').text(formatCurrency(d.first_installment));
            $('#row_first').show();
            $('#td_second').text(formatCurrency(d.second_installment));
            $('#row_second').show();
            $('#td_third').text(formatCurrency(d.third_installment));
            $('#row_third').show();
          }
        })
        .fail((xhr, status, err) => {
          console.error('Error loading transaction details', status, err, xhr.responseText);
          alert('Error loading transaction details');
        });

      // Fetch payment history
      $.get("{% url 'ajax_payment_history' %}", { transaction_id: id })
        .done(d => {
          console.debug('ajax_payment_history response:', d);
          let html = '';
          if(d.payments?.length) {
            d.payments.forEach(p => {
              html += `<tr>
                <td>${p.date}</td>
                <td>${formatCurrency(p.amount)}</td>
                <td>${p.method}</td>
                <td>${p.installment}</td>
                <td>${p.reference || ''}</td>
                <td class="text-end">
                  <button class="btn btn-sm btn-outline-success view-receipt-btn receipt-btn" 
                          data-reference="${p.reference}">
                    <i class="bi bi-download"></i> Download
                  </button>
                </td>
              </tr>`;
            });
          } else {
            html = '<tr><td colspan="6" class="text-center">No payment history</td></tr>';
          }
          $('#payment_history_body').html(html);
        })
        .fail(() => {
          $('#payment_history_body').html('<tr><td colspan="6" class="text-center">Error loading payment history</td></tr>');
        });
    });

    // Handle receipt download
    $(document).on('click', '.view-receipt-btn', function() {
      const reference = $(this).data('reference');
      window.open(`/payment/receipt/${reference}/`, '_blank');
    });
  });
</script>
