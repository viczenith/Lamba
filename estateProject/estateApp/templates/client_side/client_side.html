{% extends 'client_base.html' %}
{% load static %}
{% load humanize %}

{% block head %}
  {{ block.super }}
  <!-- Animate.css for entry animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
{% endblock %}

{% block content %}
<main id="main" class="main">

  <div class="pagetitle">
    <h1>{% if request.user.is_authenticated and request.user.full_name %}{{ request.user.full_name }}'s Dashboard{% else %}Client Dashboard{% endif %}</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ home_url }}">Home</a></li>
      </ol>
    </nav>
  </div>

  <section class="section dashboard">
    <div class="row">
      <div class="col-lg-12">
        <div class="row">
          <!-- My Properties Purchased -->
          <div class="col-xxl-4 col-md-6">
            <div class="card info-card sales-card">
              <div class="card-body">
                <h5 class="card-title"><span>My Properties Purchased</span></h5>
                <div class="d-flex align-items-center">
                  <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                    <i class="bi bi-cart"></i>
                  </div>
                  <div class="ps-3">
                    <h6>{{ total_properties }}</h6>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Properties Fully Paid & Allocated -->
          <div class="col-xxl-4 col-md-6">
            <div class="card info-card revenue-card">
              <div class="card-body">
                <h5 class="card-title"><span>Properties Fully Paid & Allocated</span></h5>
                <div class="d-flex align-items-center">
                  <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                    <i class="bi bi-currency-dollar"></i>
                  </div>
                  <div class="ps-3">
                    <h6>{{ fully_paid_allocations }}</h6>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Properties Not Fully Paid -->
          <div class="col-xxl-4 col-md-6">
            <div class="card info-card revenue-card">
              <div class="card-body">
                <h5 class="card-title"><span>Properties Not Fully Paid</span></h5>
                <div class="d-flex align-items-center">
                  <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                    <i class="bi bi-currency-dollar"></i>
                  </div>
                  <div class="ps-3">
                    <h6>{{ not_fully_paid_allocations }}</h6>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <!-- Active Promotional Offers -->
  {% now "Y-m-d" as today_local %}
  <section class="mb-5" aria-labelledby="active-promos-heading">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h4 id="active-promos-heading" class="mb-0">Active Promotional Offers</h4>
        <small class="text-muted">Running promotions — limited time</small>
      </div>

      <div class="d-flex align-items-center gap-2">
        <a href="{% url 'promotions-list' %}" class="btn btn-sm btn-outline-primary" role="button">View All</a>
      </div>
    </div>

    {% if active_promotions and active_promotions|length > 0 %}
      <div id="promoCarousel"
           class="carousel slide"
           data-bs-ride="carousel"
           data-bs-interval="2000"
           role="region"
           aria-roledescription="carousel"
           aria-label="Active promotional offers">

        {% if active_promotions|length > 1 %}
          <div class="carousel-indicators">
            {% for promo in active_promotions %}
              <button type="button"
                      data-bs-target="#promoCarousel"
                      data-bs-slide-to="{{ forloop.counter0 }}"
                      class="{% if forloop.first %}active{% endif %}"
                      aria-current="{% if forloop.first %}true{% endif %}"
                      aria-label="Slide {{ forloop.counter }}"></button>
            {% endfor %}
          </div>
        {% endif %}

        <div class="carousel-inner">
          {% for promo in active_promotions %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
              <div class="card shadow-sm rounded-3 p-3 promo-card-wrapper">
                <!-- Company Header -->
                {% with first_estate=promo.estates.first %}
                {% if first_estate and first_estate.company %}
                <div class="promo-company-header d-flex align-items-center gap-2 mb-3 pb-2 border-bottom">
                  {% if first_estate.company.logo %}
                  <img src="{{ first_estate.company.logo.url }}" alt="{{ first_estate.company.company_name }}" class="promo-company-logo">
                  {% else %}
                  <div class="promo-company-logo-placeholder d-flex align-items-center justify-content-center">
                    <i class="bi bi-building"></i>
                  </div>
                  {% endif %}
                  <div>
                    <span class="promo-company-name">{{ first_estate.company.company_name }}</span>
                    <span class="badge bg-success-subtle text-success ms-2">Active Promo</span>
                  </div>
                </div>
                {% endif %}
                {% endwith %}
                
                <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center">
                  <div class="promo-icon d-flex align-items-center justify-content-center me-3 mb-3 mb-md-0" style="min-width:84px;">
                    <i class="bi bi-tag display-4 text-secondary" aria-hidden="true"></i>
                  </div>

                  <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <h5 class="mb-1">{{ promo.name|default:"Promotion" }} <span class="badge bg-danger ms-2">–{{ promo.discount }}%</span></h5>
                        <p class="mb-1 text-muted small">{{ promo.description|default:"No additional description provided." }}</p>
                        <p class="mb-0 small text-muted">Valid: <strong>{{ promo.start|date:"M d, Y" }}</strong> → <strong>{{ promo.end|date:"M d, Y" }}</strong></p>
                      </div>

                      <div class="text-end ms-3">
                        <p class="mb-1 small text-muted">Ends</p>
                        <p class="mb-0 fw-semibold">
                          {% if promo.end %}
                            {{ promo.end|timeuntil }}
                          {% else %}
                            —
                          {% endif %}
                        </p>
                      </div>
                    </div>

                    <div class="mt-3">
                      {% with estates=promo.estates.all %}
                        {% if estates %}
                          <p class="mb-1 small text-muted">Applies to:</p>
                          <ul class="list-inline mb-0">
                            {% for estate in estates|slice:":3" %}
                              <li class="list-inline-item badge bg-light text-dark border me-1 py-1 px-2">{{ estate.name }}</li>
                            {% endfor %}
                            {% if estates|length > 3 %}
                              <li class="list-inline-item small text-muted align-middle">+{{ estates|length|add:"-3" }} more</li>
                            {% endif %}
                          </ul>
                        {% else %}
                          <p class="mb-0 small text-muted">Applies to all estates.</p>
                      {% endif %}
                    {% endwith %}
                  </div>

                  <div class="mt-3">
                    <button type="button" class="btn btn-sm btn-outline-primary me-2 view-promo-btn" data-promo-id="{{ promo.id }}">
                      <i class="bi bi-info-circle me-1"></i>Details
                    </button>
                    <a href="{% url 'promotion-detail' promo.id %}" class="btn btn-sm btn-primary view-estates-link" role="button">
                      <i class="bi bi-building me-1"></i>View Estates
                    </a>
                  </div>
                </div>
              </div>
              </div>
            </div>

            {% with first_estate=promo.estates.first %}
            <script type="application/json" id="promo-data-{{ promo.id }}">
              {
                "id": {{ promo.id }},
                "name": "{{ promo.name|escapejs }}",
                "discount": {{ promo.discount }},
                "start": "{{ promo.start|date:'Y-m-d' }}",
                "end": "{{ promo.end|date:'Y-m-d' }}",
                "company_name": "{% if first_estate and first_estate.company %}{{ first_estate.company.company_name|escapejs }}{% else %}{% endif %}",
                "company_logo": "{% if first_estate and first_estate.company and first_estate.company.logo %}{{ first_estate.company.logo.url }}{% else %}{% endif %}",
                "estates": [
                  {% for estate in promo.estates.all %}
                    {
                      "id": {{ estate.id }},
                      "name": "{{ estate.name|escapejs }}",
                      "sizes": [
                        {% for pp in estate.property_prices.all %}
                          {
                            "plot_unit_id": {{ pp.plot_unit.id }},
                            "size": "{{ pp.plot_unit.plot_size.size|escapejs }}",
                            "current": {% if pp.current is not None %}{{ pp.current|floatformat:2 }}{% else %}null{% endif %}
                          }{% if not forloop.last %},{% endif %}
                        {% endfor %}
                      ]
                    }{% if not forloop.last %},{% endif %}
                  {% endfor %}
                ]
              }
            </script>
            {% endwith %}
          {% endfor %}
        </div>

        {% if active_promotions|length > 1 %}
          <button class="carousel-control-prev" type="button" data-bs-target="#promoCarousel" data-bs-slide="prev" aria-label="Previous slide">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#promoCarousel" data-bs-slide="next" aria-label="Next slide">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
          </button>
        {% endif %}
      </div>

    {% else %}
      <div class="card shadow-sm rounded-3 p-4 text-center">
        <i class="bi bi-tag display-3 text-muted mb-3"></i>
        <h5 class="mb-1">No active promotions right now</h5>
        <p class="text-muted mb-3">We don't have any running promotions at the moment. Check back later or explore all estates.</p>
        <a href="{% url 'estates-list' %}" class="btn btn-primary btn-sm">Browse estates</a>
        <a href="{% url 'promotions-list' %}" class="btn btn-outline-secondary btn-sm ms-2">See past/promos</a>
      </div>
    {% endif %}
  </section>

  <!-- Promo Modal -->
  <div class="modal fade" id="promoModal" tabindex="-1" aria-labelledby="promoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="promoModalLabel">Promotion details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="promoModalSpinner" class="text-center py-4 d-none">
            <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
          </div>

          <div id="promoModalContent" class="d-none">
            <div class="mb-3">
              <h5 id="promoName" class="mb-1"></h5>
              <div class="small text-muted" id="promoDates"></div>
            </div>

            <div id="promoEstatesContainer"></div>
          </div>

          <div id="promoModalEmpty" class="text-center py-4 d-none">
            <p class="text-muted">No promo details available.</p>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
          <a id="promoViewAllLink" href="{% url 'promotions-list' %}" class="btn btn-primary btn-sm">View all promotions</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Latest Price Increments -->
  <section class="mt-5">
    <div class="card p-3 border-0 shadow-sm small-header">
      <div class="d-flex justify-content-between align-items-start mb-3 gap-3">
        <div>
          <h3 class="m-0 fw-bold">Latest Price Increments</h3>
          <p class="mb-0 text-muted small">Recent price changes organized by company — expand to see details.</p>
        </div>

        <div class="d-flex gap-2 align-items-center flex-wrap">
          <div class="input-group input-group-sm me-1" style="min-width:200px;">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input id="priceSearch" class="form-control form-control-sm" placeholder="Search company or estate" aria-label="Search price updates">
          </div>

          <button id="expandAllBtn" class="btn btn-sm btn-outline-secondary" type="button" title="Expand all">
            <i class="bi bi-arrows-expand"></i> Expand All
          </button>

          <button id="collapseAllBtn" class="btn btn-sm btn-outline-secondary" type="button" title="Collapse all">
            <i class="bi bi-arrows-collapse"></i> Collapse All
          </button>

          <div class="ms-2 text-muted small align-self-end" id="priceCount">
            {% if latest_value_by_company %}{{ latest_value_by_company|length }} companies{% endif %}
          </div>
        </div>
      </div>

      {% if latest_value_by_company %}
      <div class="accordion accordion-flush price-accordion" id="priceAccordion">
        {% for company_group in latest_value_by_company %}
        <div class="accordion-item company-accordion-item" data-company-name="{{ company_group.company_name|lower }}">
          <h2 class="accordion-header" id="heading-{{ forloop.counter }}">
            <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#collapse-{{ forloop.counter }}" 
                    aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" 
                    aria-controls="collapse-{{ forloop.counter }}">
              <div class="d-flex align-items-center justify-content-between w-100 me-3">
                <div class="d-flex align-items-center gap-2">
                  {% if company_group.company_logo %}
                  <img src="{{ company_group.company_logo }}" alt="{{ company_group.company_name }}" class="accordion-company-logo">
                  {% else %}
                  <div class="accordion-company-logo-placeholder d-flex align-items-center justify-content-center">
                    <i class="bi bi-building"></i>
                  </div>
                  {% endif %}
                  <span class="company-name fw-semibold">{{ company_group.company_name }}</span>
                  {% if company_group.has_new %}
                  <span class="badge new-badge pulse-badge">NEW</span>
                  {% endif %}
                </div>
                <span class="badge bg-light text-dark update-count-badge">{{ company_group.updates|length }} update{{ company_group.updates|length|pluralize }}</span>
              </div>
            </button>
          </h2>
          <div id="collapse-{{ forloop.counter }}" 
               class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
               aria-labelledby="heading-{{ forloop.counter }}" 
               data-bs-parent="#priceAccordion">
            <div class="accordion-body p-0">
              <div class="price-updates-list">
                {% for update in company_group.updates %}
                <div class="price-update-row {% if update.is_new %}is-new{% endif %}" 
                     data-estate-name="{{ update.price.estate.name|lower }}"
                     data-update-id="{{ update.id }}">
                  <div class="row align-items-center g-2 py-2 px-3">
                    <div class="col-md-4 col-6">
                      <div class="d-flex align-items-start gap-2">
                        {% if update.is_new %}
                        <span class="new-dot" title="New price update"></span>
                        {% endif %}
                        <div>
                          <div class="fw-semibold text-truncate estate-name" title="{{ update.price.estate.name }}">
                            {{ update.price.estate.name }}
                          </div>
                          <div class="small text-muted">{{ update.price.plot_unit.plot_size.size }}</div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3 col-6">
                      <div class="price-info">
                        {% if update.promo and update.promo_price %}
                        <div class="small text-muted text-decoration-line-through">₦{{ update.current|intcomma }}</div>
                        <div class="fw-bold text-success promo-price">₦{{ update.promo_price|floatformat:2|intcomma }}</div>
                        <span class="badge promo-badge-sm ms-1">-{{ update.promo.discount }}%</span>
                        {% else %}
                        <div class="fw-bold text-success">₦{{ update.current|intcomma }}</div>
                        <div class="small text-muted">Prev: ₦{{ update.previous|intcomma }}</div>
                        {% endif %}
                      </div>
                    </div>
                    <div class="col-md-2 col-6">
                      {% if update.percent_change is not None %}
                      <span class="change-pill {% if update.percent_change|floatformat:2 < 0 %}down{% else %}up{% endif %}">
                        {% if update.percent_change >= 0 %}+{% endif %}{{ update.percent_change|floatformat:1 }}%
                      </span>
                      {% endif %}
                    </div>
                    <div class="col-md-2 col-4">
                      {% if update.effective and update.effective|date:'Y-m-d' > today_local %}
                      <span class="badge effective-badge-sm effective-on-sm">
                        <i class="bi bi-calendar-event me-1"></i>{{ update.effective|date:"M d" }}
                      </span>
                      {% else %}
                      <span class="badge effective-badge-sm effective-since-sm">
                        <i class="bi bi-check-circle me-1"></i>{{ update.effective|date:"M d" }}
                      </span>
                      {% endif %}
                    </div>
                    <div class="col-md-1 col-2 text-end">
                      <button class="btn btn-sm btn-outline-primary view-update-btn" data-update-id="{{ update.id }}" title="View details">
                        <i class="bi bi-eye"></i>
                      </button>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      {% else %}
      <div class="text-center py-4 text-muted">
        <i class="bi bi-graph-down mb-2" style="font-size:22px;"></i>
        <div>No Recent Price Changes</div>
        <div class="small">Check back for updates or active promotions.</div>
      </div>
      {% endif %}
    </div>

    <!-- Price Update Modal -->
    <div class="modal fade" id="priceUpdateModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h6 class="modal-title">Price update</h6>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="priceModalSpinner" class="text-center py-3">
              <div class="spinner-border spinner-border-sm" role="status"></div>
            </div>

            <div id="priceModalContent" class="d-none">
              <div class="fw-semibold" id="priceModalEstate"></div>
              <div class="small text-muted mb-2" id="priceModalMeta"></div>
              <dl class="row mb-0">
                <dt class="col-6 small text-muted">Previous</dt>
                <dd class="col-6 small" id="pricePrev">—</dd>

                <dt class="col-6 small text-muted">Current</dt>
                <dd class="col-6 small fw-semibold" id="priceCurr">—</dd>

                <dt class="col-6 small text-muted">Change</dt>
                <dd class="col-6 small" id="priceChange">—</dd>

                <dt class="col-6 small text-muted">Effective</dt>
                <dd class="col-6 small" id="priceEffective">—</dd>

                <dt class="col-6 small text-muted">Notes</dt>
                <dd class="col-6 small text-muted" id="priceNotes">—</dd>
              </dl>
            </div>

            <div id="priceModalEmpty" class="d-none text-center text-muted py-3">
              Could not load details
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Consolidated styles -->
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      --card-shadow: 0 12px 30px rgba(0,0,0,0.12);
      --hover-shadow: 0 20px 40px rgba(0,0,0,0.18);
      --new-color: #10b981;
      --new-bg: rgba(16, 185, 129, 0.1);
    }

    /* Promo Card Company Header Styles */
    .promo-card-wrapper {
      border-left: 4px solid #6366f1;
    }

    .promo-company-header {
      margin-left: -0.5rem;
      margin-right: -0.5rem;
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }

    .promo-company-logo {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid rgba(0,0,0,0.08);
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }

    .promo-company-logo-placeholder {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: #fff;
      font-size: 1rem;
    }

    .promo-company-name {
      font-weight: 600;
      font-size: 0.88rem;
      color: #1e293b;
      letter-spacing: -0.01em;
    }

    .bg-success-subtle {
      background-color: rgba(16, 185, 129, 0.12) !important;
    }

    /* Accordion Company Logo Styles */
    .accordion-company-logo {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      object-fit: cover;
      border: 1px solid rgba(0,0,0,0.08);
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      flex-shrink: 0;
    }

    .accordion-company-logo-placeholder {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: #fff;
      font-size: 0.85rem;
      flex-shrink: 0;
    }

    /* Company Accordion Styles */
    .price-accordion {
      border-radius: 12px;
      overflow: hidden;
    }

    .price-accordion .accordion-item {
      border: none;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      background: transparent;
    }

    .price-accordion .accordion-item:last-child {
      border-bottom: none;
    }

    .price-accordion .accordion-button {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: none;
      padding: 1rem 1.25rem;
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    .price-accordion .accordion-button:not(.collapsed) {
      background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
      color: #1e40af;
      box-shadow: none;
    }

    .price-accordion .accordion-button:focus {
      box-shadow: none;
      border-color: transparent;
    }

    .price-accordion .accordion-button::after {
      background-size: 1rem;
      transition: transform 0.25s ease;
    }

    .company-icon {
      font-size: 1.1rem;
      color: #6366f1;
    }

    .company-name {
      font-size: 0.95rem;
      letter-spacing: -0.01em;
    }

    /* NEW Badge with pulse animation */
    .new-badge {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
      font-size: 0.65rem;
      font-weight: 700;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .pulse-badge {
      animation: pulse-glow 2s ease-in-out infinite;
    }

    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
      50% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
    }

    .update-count-badge {
      font-size: 0.75rem;
      font-weight: 600;
      background: #f1f5f9 !important;
      color: #64748b !important;
    }

    /* Price Updates List */
    .price-updates-list {
      background: #fff;
    }

    .price-update-row {
      border-bottom: 1px solid rgba(0,0,0,0.04);
      transition: background 0.15s ease;
    }

    .price-update-row:last-child {
      border-bottom: none;
    }

    .price-update-row:hover {
      background: #f8fafc;
    }

    .price-update-row.is-new {
      background: linear-gradient(90deg, rgba(16,185,129,0.06) 0%, transparent 40%);
      border-left: 3px solid #10b981;
    }

    .price-update-row.is-new:hover {
      background: linear-gradient(90deg, rgba(16,185,129,0.1) 0%, #f8fafc 40%);
    }

    .new-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      margin-top: 6px;
      flex-shrink: 0;
      animation: dot-pulse 1.5s ease-in-out infinite;
    }

    @keyframes dot-pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.6; transform: scale(0.9); }
    }

    .estate-name {
      max-width: 180px;
      font-size: 0.9rem;
    }

    .price-info {
      line-height: 1.3;
    }

    .promo-price {
      font-size: 0.95rem;
    }

    /* Smaller effective badges for accordion rows */
    .effective-badge-sm {
      font-size: 0.72rem;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      font-weight: 500;
    }

    .effective-on-sm {
      background: linear-gradient(90deg, #ecffd9, #d3f7ce);
      color: #0b6b2e;
    }

    .effective-since-sm {
      background: #f1f5f9;
      color: #64748b;
    }

    /* Change pills */
    .change-pill {
      display: inline-flex;
      align-items: center;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.8rem;
    }

    .change-pill.up {
      background: rgba(16, 185, 129, 0.12);
      color: #059669;
    }

    .change-pill.down {
      background: rgba(239, 68, 68, 0.12);
      color: #dc2626;
    }

    /* Promo badge */
    .promo-badge-sm {
      background: linear-gradient(90deg, #f97316, #ea580c);
      color: #fff;
      font-weight: 700;
      border-radius: 4px;
      padding: 0.15rem 0.4rem;
      font-size: 0.7rem;
    }

    .text-decoration-line-through {
      text-decoration: line-through !important;
      opacity: 0.7;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .estate-name { max-width: 140px; }
      .price-accordion .accordion-button { padding: 0.85rem 1rem; }
      .price-update-row .row { font-size: 0.85rem; }
      .view-update-btn { padding: 0.2rem 0.4rem; }
    }

    @media (max-width: 576px) {
      .company-name { font-size: 0.88rem; }
      .estate-name { max-width: 120px; font-size: 0.85rem; }
      .effective-badge-sm { font-size: 0.68rem; padding: 0.2rem 0.35rem; }
    }

    /* Search highlight */
    .company-accordion-item.hidden-by-search {
      display: none;
    }
  </style>

  <!-- Consolidated scripts: promo modal + price explorer + price modal -->
  <script>
    // Utility: NGN formatter
    function formatNGN(v) {
      if (v === null || v === undefined) return '—';
      try {
        const opts = { style: 'currency', currency: 'NGN', minimumFractionDigits: 0, maximumFractionDigits: 2 };
        return new Intl.NumberFormat('en-NG', opts).format(Number(v));
      } catch (e) {
        return '₦' + Number(v).toLocaleString();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      /* =========================
         Price Accordion: search, expand/collapse
         ========================= */
      (function () {
        const accordion = document.getElementById('priceAccordion');
        if (!accordion) return;

        const searchInput = document.getElementById('priceSearch');
        const expandAllBtn = document.getElementById('expandAllBtn');
        const collapseAllBtn = document.getElementById('collapseAllBtn');
        const countEl = document.getElementById('priceCount');

        const accordionItems = Array.from(accordion.querySelectorAll('.company-accordion-item'));

        function updateCount(visible) {
          if (countEl) {
            countEl.textContent = visible + ' compan' + (visible === 1 ? 'y' : 'ies');
          }
        }

        function applySearch() {
          const q = (searchInput ? searchInput.value : '').trim().toLowerCase();
          let visibleCount = 0;

          accordionItems.forEach(item => {
            const companyName = (item.dataset.companyName || '').toLowerCase();
            const updateRows = item.querySelectorAll('.price-update-row');
            let hasMatch = false;

            if (!q) {
              // No search - show all
              item.classList.remove('hidden-by-search');
              updateRows.forEach(row => row.style.display = '');
              visibleCount++;
              return;
            }

            // Check company name match
            if (companyName.includes(q)) {
              hasMatch = true;
              updateRows.forEach(row => row.style.display = '');
            } else {
              // Check individual estate names within the company
              updateRows.forEach(row => {
                const estateName = (row.dataset.estateName || '').toLowerCase();
                if (estateName.includes(q)) {
                  row.style.display = '';
                  hasMatch = true;
                } else {
                  row.style.display = 'none';
                }
              });
            }

            if (hasMatch) {
              item.classList.remove('hidden-by-search');
              visibleCount++;
              // Auto-expand matching accordion items
              const collapseEl = item.querySelector('.accordion-collapse');
              if (collapseEl && !collapseEl.classList.contains('show')) {
                const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });
                bsCollapse.show();
              }
            } else {
              item.classList.add('hidden-by-search');
            }
          });

          updateCount(visibleCount);
        }

        // Search input handler
        if (searchInput) {
          searchInput.addEventListener('input', applySearch);
        }

        // Expand All button
        if (expandAllBtn) {
          expandAllBtn.addEventListener('click', function () {
            accordionItems.forEach(item => {
              if (item.classList.contains('hidden-by-search')) return;
              const collapseEl = item.querySelector('.accordion-collapse');
              if (collapseEl) {
                const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });
                bsCollapse.show();
              }
            });
          });
        }

        // Collapse All button
        if (collapseAllBtn) {
          collapseAllBtn.addEventListener('click', function () {
            accordionItems.forEach(item => {
              const collapseEl = item.querySelector('.accordion-collapse');
              if (collapseEl) {
                const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseEl, { toggle: false });
                bsCollapse.hide();
              }
            });
          });
        }

        // Initial count
        updateCount(accordionItems.length);
      })();

      /* =========================
         Price update modal (delegated)
         ========================= */
      (function () {
        const apiUrlBase = "{% url 'api-price-update' 0 %}".replace(/0\/?$/, '');
        const priceModalEl = document.getElementById('priceUpdateModal');
        const priceModal = priceModalEl ? new bootstrap.Modal(priceModalEl, {}) : null;
        const priceSpinner = document.getElementById('priceModalSpinner');
        const priceContent = document.getElementById('priceModalContent');
        const priceEmpty = document.getElementById('priceModalEmpty');

        document.addEventListener('click', function (ev) {
          const btn = ev.target.closest('.view-update-btn');
          if (!btn) return;
          ev.preventDefault();

          const updateId = btn.dataset.updateId;
          if (!updateId || !priceModal) return;

          priceSpinner.classList.remove('d-none');
          priceContent.classList.add('d-none');
          priceEmpty.classList.add('d-none');

          ['priceModalEstate','priceModalMeta','pricePrev','priceCurr','priceChange','priceEffective','priceNotes'].forEach(id => {
            const el = document.getElementById(id); if (el) el.textContent = '';
          });

          priceModal.show();

          const url = `${apiUrlBase}${encodeURIComponent(updateId)}/`;
          fetch(url, { credentials: 'same-origin' })
            .then(async resp => {
              if (!resp.ok) {
                let errText = `HTTP ${resp.status} ${resp.statusText}`;
                try {
                  const errJson = await resp.json().catch(() => null);
                  if (errJson && errJson.error) errText += ` — ${errJson.error}`;
                } catch (e) {}
                throw new Error(errText);
              }
              return resp.json();
            })
            .then(json => {
              priceSpinner.classList.add('d-none');
              if (!json || typeof json !== 'object') { priceEmpty.classList.remove('d-none'); return; }

              document.getElementById('priceModalEstate').textContent = json.estate_name || '';
              document.getElementById('priceModalMeta').textContent = json.recorded_at ? new Date(json.recorded_at).toLocaleString() : '';
              document.getElementById('pricePrev').textContent = json.previous ? formatNGN(json.previous) : '—';
              document.getElementById('priceCurr').textContent = json.current ? formatNGN(json.current) : '—';
              document.getElementById('priceChange').textContent = (json.percent_change !== null && json.percent_change !== undefined) ? `${Number(json.percent_change).toFixed(1)}%` : '—';
              document.getElementById('priceEffective').textContent = json.effective ? new Date(json.effective).toLocaleDateString() : '—';
              document.getElementById('priceNotes').textContent = json.notes || '—';
              priceContent.classList.remove('d-none');
            })
            .catch(err => {
              console.error('Price update fetch error:', err);
              priceSpinner.classList.add('d-none');
              priceEmpty.classList.remove('d-none');
            });
        });
      })();

      /* =========================
         Promo modal logic (reads embedded JSON, pauses carousel while modal open)
         ========================= */
      (function () {
        const promoModalEl = document.getElementById('promoModal');
        const promoModal = promoModalEl ? new bootstrap.Modal(promoModalEl, {}) : null;
        const promoSpinner = document.getElementById('promoModalSpinner');
        const promoContent = document.getElementById('promoModalContent');
        const promoEmpty = document.getElementById('promoModalEmpty');
        const promoEstatesContainer = document.getElementById('promoEstatesContainer');
        const promoNameEl = document.getElementById('promoName');
        const promoDatesEl = document.getElementById('promoDates');
        const carouselEl = document.getElementById('promoCarousel');

        if (!promoModalEl || !promoModal) {
          console.warn('Promo modal elements not found - promo modal JS disabled.');
          return;
        }

        function renderCurrency(n) {
          if (n === null || n === undefined) return '—';
          try {
            return formatNGN(Number(n));
          } catch (e) { return '₦' + String(n); }
        }

        function clearPromoModalUI() {
          promoSpinner.classList.add('d-none');
          promoContent.classList.add('d-none');
          promoEmpty.classList.add('d-none');
          if (promoEstatesContainer) promoEstatesContainer.innerHTML = '';
          if (promoNameEl) promoNameEl.textContent = '';
          if (promoDatesEl) promoDatesEl.textContent = '';
        }

        function populatePromoModal(payload) {
          promoSpinner.classList.add('d-none');

          if (!payload || !Array.isArray(payload.estates)) {
            promoEmpty.classList.remove('d-none');
            return;
          }

          promoNameEl.textContent = `${payload.name} — ${payload.discount}% off`;
          promoDatesEl.textContent = `Valid: ${payload.start} → ${payload.end}`;

          const container = promoEstatesContainer;
          container.innerHTML = '';

          payload.estates.forEach(est => {
            const estateCard = document.createElement('div');
            estateCard.className = 'mb-3';

            let sizesHtml = '';
            if (est.sizes && est.sizes.length) {
              sizesHtml = '<div class="table-responsive"><table class="table table-sm mb-0"><thead class="table-light"><tr><th>Size</th><th>Current</th><th>Promo Price</th></tr></thead><tbody>';
              est.sizes.forEach(s => {
                const curr = (s.current !== null) ? Number(s.current) : null;
                let promoPrice = null;
                if (curr !== null) {
                  promoPrice = (curr * (100 - Number(payload.discount)) / 100);
                }
                sizesHtml += `<tr>
                  <td>${s.size}</td>
                  <td>${ curr !== null ? '<span class="text-decoration-line-through">'+ renderCurrency(curr) +'</span>' : '—' }</td>
                  <td>${ promoPrice !== null ? '<strong class="text-success">'+ renderCurrency(promoPrice.toFixed(2)) +'</strong>' : '&mdash;' }</td>
                </tr>`;
              });
              sizesHtml += `</tbody></table></div>`;
            } else {
              sizesHtml = '<div class="small text-muted">No size/price data for this estate.</div>';
            }

            estateCard.innerHTML = `<div class="fw-semibold">${est.name}</div>${sizesHtml}`;
            container.appendChild(estateCard);
          });

          promoContent.classList.remove('d-none');
        }

        // obtain or create a carousel instance to pause/resume while modal is open
        let bsCarouselInstance = null;
        if (carouselEl) {
          bsCarouselInstance = bootstrap.Carousel.getInstance(carouselEl) || null;
          if (!bsCarouselInstance) {
            try {
              bsCarouselInstance = new bootstrap.Carousel(carouselEl, { ride: 'carousel', interval: 2000 });
            } catch (e) { bsCarouselInstance = null; }
          }
        }

        // attach handlers to view buttons
        document.querySelectorAll('.view-promo-btn').forEach(btn => {
          try { btn.setAttribute('type', 'button'); } catch (e) {}

          btn.addEventListener('click', function (ev) {
            ev.preventDefault();
            ev.stopPropagation();

            const promoId = this.dataset.promoId;
            if (!promoId) {
              console.warn('view-promo-btn clicked but data-promo-id missing');
              return;
            }

            if (bsCarouselInstance) {
              try { bsCarouselInstance.pause(); } catch (e) {}
            }

            clearPromoModalUI();
            promoSpinner.classList.remove('d-none');
            promoModal.show();

            try {
              const script = document.getElementById(`promo-data-${promoId}`);
              if (!script) throw new Error('Promo data missing from page.');
              const payload = JSON.parse(script.textContent.trim());
              populatePromoModal(payload);
            } catch (err) {
              console.error('Promo modal error:', err);
              promoSpinner.classList.add('d-none');
              promoEmpty.classList.remove('d-none');
            }

            // when modal closes, resume carousel if we paused it
            const restoreCarousel = () => {
              if (bsCarouselInstance) {
                try { bsCarouselInstance.cycle(); } catch (e) {}
              }
            };
            promoModalEl.addEventListener('hidden.bs.modal', function handler() {
              restoreCarousel();
              promoModalEl.removeEventListener('hidden.bs.modal', handler);
            }, { once: true });
          }, { passive: false });
        });
      })();

    }); // DOMContentLoaded
  </script>

</main>
{% endblock %}
