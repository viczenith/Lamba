{% load custom_filters %}
{% load static %}
<!-- WhatsApp-style message bubble - styles in chat_interface.html -->

<div class="wa-message-row {% if msg.sender == request.user %}outgoing{% else %}incoming{% endif %}"
     data-msg-timestamp="{{ msg.date_sent|date:'U' }}">
    
    {% if msg.sender == request.user %}
        <!-- Outgoing: Bubble first, then avatar -->
        <div class="wa-bubble outgoing" data-msg-id="{{ msg.id }}">
            {% if msg.file and not msg.deleted_for_everyone %}
                {% with file_url=msg.file.url|lower file_name=msg.file.name %}
                    {% if ".jpg" in file_url or ".jpeg" in file_url or ".png" in file_url or ".gif" in file_url or ".webp" in file_url %}
                        <img src="{{ msg.file.url }}" class="wa-attachment-img" alt="Image" onclick="window.open('{{ msg.file.url }}', '_blank')" loading="lazy">
                    {% else %}
                        <div class="wa-doc" onclick="window.open('{{ msg.file.url }}', '_blank')">
                            <div class="wa-doc-icon {% if '.pdf' in file_url %}pdf{% elif '.doc' in file_url %}doc{% elif '.xls' in file_url %}xls{% elif '.zip' in file_url or '.rar' in file_url %}zip{% else %}default{% endif %}">
                                <i class="bi bi-file-earmark-fill"></i>
                            </div>
                            <div class="wa-doc-info">
                                <div class="wa-doc-name">{{ file_name|filename|truncatechars:30 }}</div>
                                <div class="wa-doc-size">{% if msg.file.size %}{{ msg.file.size|filesizeformat }}{% else %}Document{% endif %}</div>
                            </div>
                        </div>
                    {% endif %}
                {% endwith %}
            {% endif %}
            
            <div class="wa-text">
                {% if msg.deleted_for_everyone %}
                    <span class="wa-deleted">ðŸš« This message was deleted</span>
                {% else %}
                    {{ msg.get_content|linebreaks }}
                {% endif %}
                <span class="wa-meta">
                    <span class="wa-time">{{ msg.date_sent|date:"g:i A" }}</span>
                    {% if msg.status == 'read' %}
                        <i class="bi bi-check-all wa-status read"></i>
                    {% elif msg.status == 'delivered' %}
                        <i class="bi bi-check-all wa-status"></i>
                    {% else %}
                        <i class="bi bi-check wa-status"></i>
                    {% endif %}
                </span>
            </div>
            
            {% if not msg.deleted_for_everyone and msg.date_sent|within_minutes %}
                <button class="wa-delete-btn" data-msg-id="{{ msg.id }}" title="Delete">
                    <i class="bi bi-trash3"></i>
                </button>
            {% endif %}
        </div>
        <div class="wa-avatar">
            {% if request.user.profile_image %}
                <img src="{{ request.user.profile_image.url }}" alt="{{ request.user.full_name }}">
            {% else %}
                {{ request.user.full_name|first|upper }}
            {% endif %}
        </div>
    {% else %}
        <!-- Incoming: Avatar first, then bubble -->
        <div class="wa-avatar">
            {% if msg.company and msg.company.logo %}
                <img src="{{ msg.company.logo.url }}" alt="{{ msg.company.company_name }}">
            {% elif msg.company and msg.company.company_name %}
                {{ msg.company.company_name|first|upper }}
            {% else %}
                A
            {% endif %}
        </div>
        <div class="wa-bubble incoming" data-msg-id="{{ msg.id }}">
            <div class="wa-sender-name">
                {% if msg.company %}{{ msg.company.company_name }}{% else %}Admin Support{% endif %}
            </div>
            
            {% if msg.file and not msg.deleted_for_everyone %}
                {% with file_url=msg.file.url|lower file_name=msg.file.name %}
                    {% if ".jpg" in file_url or ".jpeg" in file_url or ".png" in file_url or ".gif" in file_url or ".webp" in file_url %}
                        <img src="{{ msg.file.url }}" class="wa-attachment-img" alt="Image" onclick="window.open('{{ msg.file.url }}', '_blank')" loading="lazy">
                    {% else %}
                        <div class="wa-doc" onclick="window.open('{{ msg.file.url }}', '_blank')">
                            <div class="wa-doc-icon {% if '.pdf' in file_url %}pdf{% elif '.doc' in file_url %}doc{% elif '.xls' in file_url %}xls{% elif '.zip' in file_url or '.rar' in file_url %}zip{% else %}default{% endif %}">
                                <i class="bi bi-file-earmark-fill"></i>
                            </div>
                            <div class="wa-doc-info">
                                <div class="wa-doc-name">{{ file_name|filename|truncatechars:30 }}</div>
                                <div class="wa-doc-size">{% if msg.file.size %}{{ msg.file.size|filesizeformat }}{% else %}Document{% endif %}</div>
                            </div>
                        </div>
                    {% endif %}
                {% endwith %}
            {% endif %}
            
            <div class="wa-text">
                {% if msg.deleted_for_everyone %}
                    <span class="wa-deleted">ðŸš« This message was deleted</span>
                {% else %}
                    {{ msg.get_content|linebreaks }}
                {% endif %}
                <span class="wa-meta">
                    <span class="wa-time">{{ msg.date_sent|date:"g:i A" }}</span>
                </span>
            </div>
        </div>
    {% endif %}
</div>
